(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,84705,69620,e=>{"use strict";e.s(["default",()=>U,"formatMessagePreview",()=>H],84705);var t=e.i(43476),r=e.i(71645),s=e.i(74715),n=e.i(57688),i=e.i(37963),a=e.i(14674);function l({item:e,isGroup:l,selectedChat:o,onSelectChat:c,onChatAction:d,currentUserId:m,categoryTags:u=[],userTags:h=[],onOpenTagManager:x}){let g=o?._id===e._id,[p,f]=(0,r.useState)(!1),[b,y]=(0,r.useState)(null),v=(0,r.useRef)(null),w=(0,r.useRef)(null),j=(0,r.useRef)(!1),[N,S]=(0,r.useState)(!1);(0,r.useEffect)(()=>{S(!1)},[e.avatar]);let k=e.unreadCount||0,C=!!e.isPinned,_=!!e.isHidden,[T,M]=(0,r.useState)([]),A=`chatCategories:${String(m)}:${String(e._id)}`;(0,r.useEffect)(()=>{try{let t=e.categories||e.categoriesBy?.[String(m)]||[];if(Array.isArray(t)&&t.length>0)M(t.filter(e=>"string"==typeof e));else{let e=localStorage.getItem(A);if(e){let t=JSON.parse(e);Array.isArray(t)&&M(t.filter(e=>"string"==typeof e))}}}catch{}},[m,e,A]),(0,r.useEffect)(()=>{let t=t=>{try{let r=t.detail||{};if(String(r.userId)!==String(m)||String(r.roomId)!==String(e._id))return;let s=Array.isArray(r.categories)?r.categories.filter(e=>"string"==typeof e):[];M(s);try{localStorage.setItem(A,JSON.stringify(s))}catch{}}catch{}};return window.addEventListener("chatCategoriesUpdated",t),()=>{window.removeEventListener("chatCategoriesUpdated",t)}},[m,e._id,A]);let[E,$]=(0,r.useState)([]),I=`chatTags:${String(m)}:${String(e._id)}`;(0,r.useEffect)(()=>{try{let t=e.tags||e.tagsBy?.[String(m)]||[];if(Array.isArray(t)&&t.length>0)$(t.filter(e=>"string"==typeof e));else{let e=localStorage.getItem(I);if(e){let t=JSON.parse(e);Array.isArray(t)&&$(t.filter(e=>"string"==typeof e))}}}catch{}},[m,e,I]),(0,r.useEffect)(()=>{let t=t=>{try{let r=t.detail||{};if(String(r.userId)!==String(m)||String(r.roomId)!==String(e._id))return;let s=Array.isArray(r.tags)?r.tags.filter(e=>"string"==typeof e):[];$(s);try{localStorage.setItem(I,JSON.stringify(s))}catch{}}catch{}};return window.addEventListener("chatTagsUpdated",t),()=>{window.removeEventListener("chatTagsUpdated",t)}},[m,e._id,I]);let L=t=>{$(r=>{let s=r.includes(t)?r.filter(e=>e!==t):[...r,t];try{localStorage.setItem(I,JSON.stringify(s))}catch{}let n=l?"/api/groups":"/api/users",i=l?{action:"updateTags",_id:String(m),conversationId:String(e._id),data:{tags:s}}:{action:"updateTags",currentUserId:String(m),roomId:String(e._id),data:{tags:s}};try{fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(()=>{})}catch{}return s})},[P,U]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!l)return void U(!1);try{let t=localStorage.getItem("ACTIVE_GROUP_CALL_ROOMS"),r=t?JSON.parse(t):[],s=Array.isArray(r)&&r.map(String).includes(String(e._id));U(!!s)}catch{U(!1)}let t=t=>{let r=t.detail||{};U(!!(Array.isArray(r.rooms)?r.rooms.map(String):[]).includes(String(e._id)))};return window.addEventListener("activeGroupCallsUpdated",t),()=>window.removeEventListener("activeGroupCallsUpdated",t)},[l,e._id]);let R=r.default.useMemo(()=>l?e.name?.trim()?e.name.trim():e.members?.map(e=>e?.name).filter(Boolean).slice(0,3).join(", ")||"Nhóm trống":e.nicknames?.[m]||e.name||e.username||"Người dùng",[e,l,m]),D=e.lastMessage||(l?"Nhóm mới tạo":"Bắt đầu trò chuyện"),O=(0,s.formatTimeAgo)(e.lastMessageAt),B=(()=>{if(l)return;let t=e.lastSeen??null;return null!=t?Date.now()-t<=3e5:!!e.online})(),F=r.default.useMemo(()=>{var t;return(t=(0,i.getProxyUrl)(e.avatar))?String(t).trim().replace(/^[('"]+/,"").replace(/[)'"]+$/,""):""},[e.avatar]),z=r.default.useMemo(()=>{if(!F)return"/logo/avata.webp";try{let e=new URL(F);return"https:"===e.protocol&&"files.hupuna.vn"===e.hostname&&e.pathname.startsWith("/api/files/")||"http:"===e.protocol&&"117.4.242.30"===e.hostname&&"8090"===e.port&&e.pathname.startsWith("/api/files/")||"https:"===e.protocol&&"cdn.jsdelivr.net"===e.hostname||"https:"===e.protocol&&"mega.nz"===e.hostname&&e.pathname.startsWith("/file/")?F:"/logo/avata.webp"}catch{return"/logo/avata.webp"}},[F]),V=()=>{null!=w.current&&(clearTimeout(w.current),w.current=null)},G=t=>{f(!1),d(e._id,t,"pin"===t?!C:!_,l)};(0,r.useEffect)(()=>{if(!p)return;let e=e=>{v.current&&!v.current.contains(e.target)&&f(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[p]);let[W,X]=(0,r.useState)(!1),[J,K]=(0,r.useState)(null),[q,Q]=(0,r.useState)(!1);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{onClick:()=>c(e),onContextMenu:e=>{e.preventDefault(),e.stopPropagation();let t=e.clientX,r=e.clientY,s=t+240>window.innerWidth?window.innerWidth-240-16:t+12,n=r>window.innerHeight/2;y({x:s,y:r,align:n?"bottom":"top"}),f(!0)},onTouchStart:e=>{V(),j.current=!1;let t=e.touches&&e.touches[0],r=t?t.clientX:0,s=t?t.clientY:0;w.current=window.setTimeout(()=>{let e=r+240>window.innerWidth?window.innerWidth-240-16:r+12,t=s>window.innerHeight/2;y({x:e,y:s,align:t?"bottom":"top"}),f(!0),j.current=!0},500)},onTouchEnd:e=>{let t=j.current;V(),t&&(e.preventDefault(),e.stopPropagation())},onTouchCancel:V,onTouchMove:()=>{V()},className:`
          group relative mx-1 rounded-[0.25rem] transition-all duration-300 cursor-pointer
          ${g?"bg-blue-100 shadow-xl":"hover:bg-gradient-to-r hover:from-gray-50 hover:to-indigo-50 hover:shadow-lg"}
          ${_?"opacity-60":""}
        `,children:(0,t.jsxs)("div",{className:"flex items-center gap-1 md:gap-2 py-[0.5rem] md:py-1 px-2 ",children:[(0,t.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,t.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,t.jsx)("div",{className:`
                w-12 h-12  rounded-4xl overflow-hidden ring-2 ring-white shadow-2xl flex items-center justify-center text-white font-bold text-2xl
                ${l?"bg-gradient-to-br from-sky-500 via-blue-500 to-blue-500":"bg-gradient-to-br from-indigo-500 to-blue-600"}
              `,children:e.avatar&&!N?(0,t.jsx)(n.default,{src:z,alt:R,width:64,height:64,className:"w-full h-full object-cover",onError:()=>S(!0)}):(0,t.jsx)(n.default,{src:"/logo/avata.webp",alt:R,width:64,height:64,className:"w-full h-full object-cover"})}),!l&&(0,t.jsx)("div",{className:`absolute bottom-0 right-0 w-3 md:w-4
               h-3 md:h-4 rounded-full border-2 md:border-3 border-white shadow-lg
                ${B?"bg-green-400":"bg-gray-400"}`}),l&&(0,t.jsx)("div",{className:"absolute -bottom-1 -right-1 p-1 bg-white rounded-2xl shadow-xl",children:(0,t.jsx)(a.HiUserGroup,{className:"w-4 h-4 text-purple-600"})}),C&&(0,t.jsx)("div",{className:"absolute -top-2 -left-2 p-1 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl shadow-xl animate-pulse",children:(0,t.jsx)(a.HiOutlineMapPin,{className:"w-4 h-4 text-white rotate-12"})})]}),T.length>0&&(0,t.jsx)("div",{className:"",children:(0,t.jsx)("div",{className:"flex flex-wrap gap-1",children:T.map(e=>{let r=u.find(t=>t.id===e);return r?(0,t.jsxs)("span",{className:"inline-flex items-center gap-1.5 px-1 py-0.5 rounded-full text-[10px] font-medium bg-white/80 border border-gray-200 text-gray-700 shadow-sm",children:[(0,t.jsx)("span",{className:`w-2 h-2 rounded-full ${r.color}`}),(0,t.jsx)("span",{className:"truncate max-w-[1.75rem]",children:r.label})]},e):null})})})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0 ml-1 transition-colors duration-150 border-b pb-2 border-gray-200 lg:border-b-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("h4",{className:`
                 text-[1rem] md:text-[1.125rem] font-medium truncate max-w-[11rem]
                  ${k>0?"text-gray-900":"text-gray-500"}
                `,children:R}),(0,t.jsxs)("span",{className:"text-sm text-gray-500 flex items-center gap-1",children:[(0,t.jsx)(a.HiCheck,{className:"w-4 h-4 text-indigo-500"}),O]})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:`
                  text-[0.875rem] md:text-[1rem] truncate max-w-[13rem]
                  ${k>0?"font-semibold text-gray-800":"text-gray-600"}
                `,children:e.isRecall?"Tin nhắn đã được thu hồi":H(D)}),P&&l&&(0,t.jsx)("span",{className:"bg-green-500 text-xs rounded-md px-1.5 py-0.5 text-white inline-block mt-1",children:"Cuộc gọi đang diễn ra"})]}),k>0&&(0,t.jsx)("div",{className:"relative",children:(0,t.jsx)("div",{className:"relative w-6 h-6 flex items-center justify-center bg-gradient-to-r from-red-500 to-pink-600 rounded-full shadow-xl",children:(0,t.jsx)("span",{className:"text-sm font-bold text-white",children:k>99?"99+":k})})})]}),(E.length>0||W)&&(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-1 mt-2 relative z-10 w-full",children:[(q?E:E.slice(0,3)).map(e=>{let r=h.find(t=>t.id===e);return r?(0,t.jsx)("span",{className:`inline-block px-1.5 py-0.5 mb-[0.25rem] text-[10px] font-bold text-white rounded-[0.125rem] shadow-sm ${r.color} whitespace-nowrap`,children:r.label},e):null}),!q&&E.length>3&&(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),Q(!0)},className:"inline-flex items-center justify-center px-1 py-0.5 mb-[0.25rem] text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-[0.125rem] transition-colors",children:(0,t.jsx)(a.HiEllipsisHorizontal,{className:"w-3 h-3"})}),q&&E.length>3&&(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),Q(!1)},className:"inline-flex items-center justify-center px-1 py-0.5 mb-[0.25rem] text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-[0.125rem] transition-colors",title:"Thu gọn",children:(0,t.jsx)(a.HiChevronUp,{className:"w-3 h-3"})}),(0,t.jsx)("div",{className:"relative",children:(0,t.jsx)("button",{onClick:e=>{if(e.stopPropagation(),W)X(!1);else{let t=e.currentTarget.getBoundingClientRect(),r=t.bottom>window.innerHeight/2;K({x:t.left,y:r?t.top-4:t.bottom+4,align:r?"bottom":"top"}),X(!0)}},className:`cursor-pointer p-0.5 rounded-[0.1  25rem] hover:bg-gray-200 text-gray-400 hover:text-gray-600 transition-colors ${E.length>0?"opacity-0 group-hover:opacity-100":""} ${W?"opacity-100 bg-gray-200 text-gray-600":""}`,title:"Thêm thẻ tag",children:(0,t.jsx)(a.HiPlus,{className:"w-3.5 h-3.5"})})})]})]})]})}),p&&b&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-[9998] ",onClick:()=>f(!1)}),(0,t.jsxs)("div",{ref:v,style:{top:"bottom"===b.align?"auto":b.y,bottom:"bottom"===b.align?window.innerHeight-b.y:"auto",left:b.x,position:"fixed"},className:`z-[9999] w-60 bg-white rounded-lg shadow-xl border border-gray-100 overflow-hidden animate-in fade-in duration-200 ${"bottom"===b.align?"slide-in-from-bottom-2":"slide-in-from-top-2"}`,children:[(0,t.jsxs)("button",{onClick:()=>G("pin"),className:"flex cursor-pointer items-center w-full px-4 py-3 hover:bg-gray-50 transition-colors gap-3 group",children:[(0,t.jsx)(a.HiOutlineMapPin,{className:`w-5 h-5 ${C?"text-orange-500 rotate-45":"text-gray-400 group-hover:text-gray-600"}`}),(0,t.jsx)("span",{className:"flex-1 text-left text-gray-700 font-medium text-sm",children:C?"Bỏ ghim":"Ghim lên đầu"}),C&&(0,t.jsx)(a.HiCheck,{className:"w-4 h-4 text-orange-500"})]}),(0,t.jsxs)("button",{onClick:()=>G("hide"),className:"flex cursor-pointer items-center w-full px-4 py-3 hover:bg-gray-50 transition-colors gap-3 group border-t border-gray-100",children:[_?(0,t.jsx)(a.HiEye,{className:"w-5 h-5 text-green-500"}):(0,t.jsx)(a.HiEyeSlash,{className:"w-5 h-5 text-gray-400 group-hover:text-gray-600"}),(0,t.jsx)("span",{className:"flex-1 text-left text-gray-700 font-medium text-sm",children:_?"Hiện lại":"Ẩn trò chuyện"}),_&&(0,t.jsx)(a.HiCheck,{className:"w-4 h-4 text-green-500"})]}),(0,t.jsxs)("div",{className:"border-t border-gray-100",children:[(0,t.jsx)("div",{className:"px-4 py-2 text-xs text-gray-500",children:"Theo thẻ phân loại"}),(0,t.jsx)("div",{className:"max-h-30 overflow-auto custom-scrollbar",children:u.map(r=>{let s=T.includes(r.id);return(0,t.jsxs)("button",{onClick:()=>{var t;return t=r.id,void M(r=>{let s=r.includes(t)?[]:[t];try{localStorage.setItem(A,JSON.stringify(s))}catch{}let n=l?"/api/groups":"/api/users",i=l?{action:"updateCategories",_id:String(m),conversationId:String(e._id),data:{categories:s}}:{action:"updateCategories",currentUserId:String(m),roomId:String(e._id),data:{categories:s}};try{fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(()=>{})}catch{}return s})},className:"flex cursor-pointer items-center w-full px-4 py-2 hover:bg-gray-50 transition-colors gap-3",children:[(0,t.jsx)("span",{className:`inline-block w-3.5 h-3.5 rounded-sm ${r.color} border border-white`}),(0,t.jsx)("span",{className:"flex-1 text-left text-gray-700 text-sm",children:r.label}),(0,t.jsx)("input",{type:"checkbox",checked:s,readOnly:!0,className:"w-4 h-4"})]},r.id)})})]}),(0,t.jsxs)("div",{className:"border-t border-gray-100",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-2",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Theo thẻ tags"}),(0,t.jsx)("button",{onClick:()=>{f(!1),X(!0)},className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"+ Thêm"})]}),(0,t.jsx)("div",{className:"max-h-30 overflow-auto custom-scrollbar",children:h.map(e=>{let r=E.includes(e.id);return(0,t.jsxs)("button",{onClick:()=>L(e.id),className:"flex cursor-pointer items-center w-full px-4 py-2 hover:bg-gray-50 transition-colors gap-3",children:[(0,t.jsx)("span",{className:`inline-block w-3.5 h-3.5 rounded-sm ${e.color} border border-white`}),(0,t.jsx)("span",{className:"flex-1 text-left text-gray-700 text-sm",children:e.label}),(0,t.jsx)("input",{type:"checkbox",checked:r,readOnly:!0,className:"w-4 h-4"})]},e.id)})})]})]})]}),W&&J&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-[9998]",onClick:e=>{e.stopPropagation(),X(!1)}}),(0,t.jsxs)("div",{style:{top:"bottom"===J.align?"auto":J.y,bottom:"bottom"===J.align?window.innerHeight-J.y:"auto",left:J.x,position:"fixed"},className:"z-[9999] w-48 bg-white rounded-lg shadow-xl border border-gray-100 overflow-hidden animate-in fade-in zoom-in-95 duration-200",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"p-1 max-h-48 overflow-y-auto custom-scrollbar",children:[0===h.length&&(0,t.jsx)("div",{className:"text-xs text-gray-400 text-center py-2",children:"Chưa có thẻ nào"}),h.map(e=>(0,t.jsxs)("button",{onClick:()=>L(e.id),className:"flex items-center w-full gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-left transition-colors group/item",children:[(0,t.jsx)("div",{className:`w-3 h-3 rounded-full ${e.color} shadow-sm`}),(0,t.jsx)("span",{className:"flex-1 text-xs font-medium text-gray-700 truncate",children:e.label}),E.includes(e.id)&&(0,t.jsx)(a.HiCheck,{className:"w-3.5 h-3.5 text-blue-500"})]},e.id))]}),(0,t.jsx)("div",{className:"border-t border-gray-100 p-1 bg-gray-50",children:(0,t.jsxs)("button",{onClick:()=>{X(!1),x?.()},className:"flex items-center justify-center w-full gap-1 px-2 py-1.5 text-xs text-blue-600 font-bold hover:bg-blue-100 rounded transition-colors",children:[(0,t.jsx)(a.HiPlus,{className:"w-3 h-3"})," Quản lý thẻ"]})})]})]})]})}let o=({activeTab:e,setActiveTab:r,contactsCount:s,messagesCount:n})=>{let i=[{key:"all",label:"Tất cả",icon:a.HiMagnifyingGlass,count:s+n},{key:"contacts",label:"Liên hệ",icon:a.HiUser,count:s},{key:"messages",label:"Tin nhắn",icon:a.HiChatBubbleLeftRight,count:n}];return(0,t.jsx)("div",{className:"flex flex-nowrap border-b border-gray-200 bg-white sticky top-0 z-5 -mx-4 px-4 ",children:i.map(s=>{let n=e===s.key;return(0,t.jsxs)("button",{onClick:()=>r(s.key),className:`flex-shrink-0 flex cursor-pointer items-center justify-center gap-2 py-4 px-3 text-sm font-semibold transition-all relative ${n?"text-[#0088ff]":"text-gray-600 hover:text-gray-900"}`,children:[(0,t.jsx)("span",{children:s.label}),n&&(0,t.jsx)("div",{className:"absolute bottom-0 left-3 right-3 h-0.5 bg-[#0088ff] rounded-full"})]},s.key)})})},c=({text:e,keyword:r})=>{if(!r.trim()||!e)return(0,t.jsx)("span",{className:"text-gray-800",children:e});let s=(0,i.buildAccentInsensitiveRegex)(r),n=e.split(s);return(0,t.jsx)("span",{children:n.map((e,r)=>s.test(e)?(0,t.jsx)("span",{className:" text-blue-600 md:text-blue-700 rounded ",children:e},r):(0,t.jsx)("span",{className:"text-gray-800",children:e},r))})},d=()=>(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-16 text-gray-500",children:[(0,t.jsx)("div",{className:"w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"}),(0,t.jsx)("p",{className:"text-lg font-medium",children:"Đang tìm kiếm..."})]}),m=()=>(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-20 text-center text-gray-400",children:[(0,t.jsx)("div",{className:"p-10 bg-gray-100 rounded-full mb-6",children:(0,t.jsx)(a.HiMagnifyingGlass,{className:"w-20 h-20 text-gray-300"})}),(0,t.jsx)("p",{className:"text-xl font-semibold text-gray-500",children:"Không tìm thấy kết quả"}),(0,t.jsx)("p",{className:"text-sm mt-2",children:"Thử tìm với từ khóa khác nhé!"})]}),u=({contacts:e,searchTerm:r,onSelectContact:s,currentUserId:l})=>0===e.length?null:(0,t.jsxs)("section",{className:"space-y-3 p-2 bg-white",children:[(0,t.jsx)("div",{className:"flex items-center gap-3 px-2",children:(0,t.jsxs)("h4",{className:"text-sm font-bold text-gray-800",children:["Liên hệ (",e.length,")"]})}),e.map(e=>{let o=!!e.isGroup,d=String(e.name||e.username||"Người dùng").trim();return!o&&l&&e.nicknames?.[l]&&(d=e.nicknames[l]),(0,t.jsxs)("button",{onClick:()=>s(e),className:"w-full cursor-pointer flex items-center gap-4 p-2 rounded-2xl hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all active:scale-98 group",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-3xl overflow-hidden ring-2 ring-white shadow-xl",children:e.avatar?(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(e.avatar),width:56,height:56,alt:"",className:"w-full h-full object-cover"}):(0,t.jsx)(n.default,{src:"/logo/avata.webp",alt:d,width:64,height:64,className:"w-full h-full object-cover"})}),o&&(0,t.jsx)("div",{className:"absolute -bottom-1 -right-1 p-1.5 bg-purple-600 rounded-full shadow-lg",children:(0,t.jsx)(a.HiUsers,{className:"w-3 h-3 text-white"})})]}),(0,t.jsxs)("div",{className:"flex-1 text-left border-b border-gray-200 pb-1",children:[(0,t.jsx)("p",{className:" text-gray-900",children:(0,t.jsx)(c,{text:d,keyword:r})}),(0,t.jsxs)("p",{className:"text-sm text-gray-500 flex items-center gap-2",children:[o?(0,t.jsx)(a.HiUsers,{className:"w-4 h-4"}):(0,t.jsx)(a.HiUser,{className:"w-4 h-4"}),o?"Nhóm chat":"Liên hệ cá nhân"]})]})]},e._id)})]}),h=({groupedMessages:e,searchTerm:r,onNavigateToMessage:s,onClearSearch:l,onOpenRoomResults:o})=>{if(0===e.length)return null;let d=e=>e>=99?"99+":String(e);return(0,t.jsxs)("section",{className:" bg-white px-2 md:px-0",children:[(0,t.jsx)("div",{className:"flex items-center gap-3 px-2 py-2",children:(0,t.jsxs)("h4",{className:"text-sm font-bold text-gray-800",children:["Tin nhắn (",d(e.reduce((e,t)=>e+t.messages.length,0)),")"]})}),e.map(e=>(0,t.jsxs)("div",{className:"bg-white flex overflow-hidden border-y border-gray-100 py-1",children:[(0,t.jsx)("div",{className:"p-2 flex  gap-4",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-3xl overflow-hidden ring-2 ring-white shadow-xl",children:e.avatar?(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(e.avatar),width:56,height:56,alt:"",className:"w-full h-full object-cover"}):(0,t.jsx)(n.default,{src:"/logo/avata.webp",alt:e.roomName,width:64,height:64,className:"w-full h-full object-cover"})}),e.isGroupChat&&(0,t.jsx)("div",{className:"absolute -top-2 -right-1 p-1.5 bg-emerald-700 rounded-full",children:(0,t.jsx)(a.HiUsers,{className:"w-3 h-3 text-white"})})]})}),(0,t.jsx)("div",{className:"w-full",children:(0,t.jsxs)("div",{className:"divide-y divide-gray-200",children:[e.messages.slice(0,1).map(n=>{let i,o;return(0,t.jsx)("button",{onClick:()=>{s(n),l()},className:"w-full  cursor-pointer px-5 text-left hover:bg-gray-50 transition-all flex items-start gap-4 active:scale-99",children:(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:" justify-between mb-2",children:[(0,t.jsx)("div",{className:"flex-1 min-w-0 ",children:(0,t.jsxs)("div",{className:"flex  justify-between",children:[(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("p",{className:" text-gray-900 text-lg w-[14rem] md:w-[10rem] truncate",children:e.roomName}),(0,t.jsx)("div",{className:"flex items-center justify-between gap-2",children:(0,t.jsx)("p",{className:"text-sm text-gray-600",children:e.isGroupChat?"Nhóm":"Chat cá nhân"})})]}),(0,t.jsxs)("span",{className:"text-xs text-gray-500 flex items-center gap-1",children:[(0,t.jsx)(a.HiClock,{className:"w-3 h-3"}),(i=new Date(n.timestamp),0===(o=Math.floor((new Date().getTime()-i.getTime())/864e5))?i.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}):1===o?"Hôm qua":o<7?`${o} ng\xe0y trước`:i.toLocaleDateString("vi-VN"))]})]})}),(0,t.jsx)("span",{className:"font-bold text-gray-800",children:n.senderName})]}),(0,t.jsx)("p",{className:"text-gray-700 line-clamp-2",children:(0,t.jsx)(c,{text:"file"===n.type?n.fileName||"File":"image"===n.type?"Hình ảnh":"video"===n.type?"Video":"sticker"===n.type?"Sticker":n.content||"Tin nhắn",keyword:r})})]})},n._id)}),(0,t.jsxs)("button",{onClick:()=>{o?o(e.roomId,e.roomName,e.isGroupChat,e.avatar):s(e.messages[0]),l()},className:"flex px-5 py-3 items-center gap-1 text-[1rem]  hover:text-blue-700 cursor-pointer",children:[(0,t.jsxs)("span",{className:"",children:[d(e.messages.length)," kết quả phù hợp"]}),(0,t.jsx)(a.HiChevronRight,{className:"w-4 h-4"})]})]})})]},e.roomId))]})};function x({activeTab:e,setActiveTab:r,isSearching:s,hasResults:n,contacts:i,groupedMessages:a,searchTerm:l,onSelectContact:c,onNavigateToMessage:x,currentUserId:g,onOpenRoomResults:p}){return(0,t.jsxs)("div",{className:"pb-20",children:[(0,t.jsx)(o,{activeTab:e,setActiveTab:r,contactsCount:i.length,messagesCount:a.reduce((e,t)=>e+t.messages.length,0)}),s&&(0,t.jsx)(d,{}),!s&&!n&&(0,t.jsx)(m,{}),!s&&n&&(0,t.jsxs)("div",{className:"space-y-3  bg-gray-200",children:[("all"===e||"contacts"===e)&&(0,t.jsx)(u,{contacts:i,searchTerm:l,onSelectContact:c,currentUserId:g}),("all"===e||"messages"===e)&&(0,t.jsx)(h,{groupedMessages:a,searchTerm:l,onNavigateToMessage:x,onClearSearch:()=>{},onOpenRoomResults:p})]})]})}let g={all:{label:"Tất cả",icon:a.HiChatBubbleLeftRight,color:"indigo"},group:{label:"Nhóm",icon:a.HiUsers,color:"purple"},personal:{label:"Cá nhân",icon:a.HiUserCircle,color:"pink"},unread:{label:"Chưa đọc",icon:a.HiEnvelope,color:"blue"},read:{label:"Đã đọc",icon:a.HiEnvelopeOpen,color:"green"},hidden:{label:"Ẩn",icon:a.HiEyeSlash,color:"gray"}};var p=e.i(84828);function f({isOpen:e,onClose:s,filterType:n,setFilterType:i,counts:a,onOpenCreateGroup:l,onOpenGlobalFolder:o,buttonRef:c,onlyGroups:d=!1,onlyPersonal:m=!1}){let u=(0,r.useRef)(null);if((0,r.useEffect)(()=>{let t=e=>{u.current&&!u.current.contains(e.target)&&c.current&&!c.current.contains(e.target)&&s()};return e&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[e,s,c]),!e)return null;let h=a.hidden>0?["all","group","personal","unread","read","hidden"]:["all","group","personal","unread","read"],x=h;return d?x=h.filter(e=>"personal"!==e):m&&(x=h.filter(e=>"group"!==e)),(0,t.jsx)("div",{ref:u,className:"absolute top-12 right-0 z-50 w-64 bg-white rounded-lg shadow-xl border border-gray-100 py-1 animate-in fade-in zoom-in-95 duration-200 origin-top-right",children:(0,t.jsxs)("div",{className:"space-y-0.5",children:[!m&&(0,t.jsxs)("button",{onClick:()=>{l(),s()},className:"w-full cursor-pointer flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors text-gray-700 text-sm font-medium",children:[(0,t.jsx)("div",{className:"flex items-center justify-center w-5 h-5 text-gray-500",children:(0,t.jsx)(p.FaPlus,{className:"w-4 h-4"})}),(0,t.jsx)("span",{children:"Tạo nhóm mới"})]}),(0,t.jsx)("div",{className:"my-1 border-t border-gray-100"}),(0,t.jsx)("div",{className:"text-xs font-semibold text-gray-400 px-4 py-2 uppercase tracking-wider",children:"Bộ lọc tin nhắn"}),x.map(e=>{let{label:r,icon:l,color:o}=g[e],c=n===e,d=a[e],m={indigo:"text-indigo-600",blue:"text-blue-600",green:"text-emerald-600",purple:"text-purple-600",pink:"text-pink-600",gray:"text-gray-600"}[o]||"text-gray-600";return(0,t.jsxs)("button",{onClick:()=>{i(e),s()},className:`
                w-full cursor-pointer flex items-center justify-between px-4 py-2.5 transition-colors text-sm
                ${c?`${({indigo:"bg-indigo-50",blue:"bg-blue-50",green:"bg-emerald-50",purple:"bg-purple-50",pink:"bg-pink-50",gray:"bg-gray-50"})[o]||"bg-gray-50"} ${m} font-medium`:"text-gray-600 hover:bg-gray-50"}
              `,children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(l,{className:`w-5 h-5 ${c?m:"text-gray-400"}`}),(0,t.jsx)("span",{children:r})]}),d>0&&(0,t.jsx)("span",{className:`
                  text-xs px-2 py-0.5 rounded-full font-medium
                  ${c?"bg-white/60":"bg-gray-100 text-gray-600"}
                `,children:d>99?"99+":d})]},e)})]})})}var b=e.i(18566),y=e.i(40141);function v(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"rect",attr:{width:"416",height:"384",x:"48",y:"80",fill:"none",strokeLinejoin:"round",strokeWidth:"32",rx:"48"},child:[]},{tag:"circle",attr:{cx:"296",cy:"232",r:"24"},child:[]},{tag:"circle",attr:{cx:"376",cy:"232",r:"24"},child:[]},{tag:"circle",attr:{cx:"296",cy:"312",r:"24"},child:[]},{tag:"circle",attr:{cx:"376",cy:"312",r:"24"},child:[]},{tag:"circle",attr:{cx:"136",cy:"312",r:"24"},child:[]},{tag:"circle",attr:{cx:"216",cy:"312",r:"24"},child:[]},{tag:"circle",attr:{cx:"136",cy:"392",r:"24"},child:[]},{tag:"circle",attr:{cx:"216",cy:"392",r:"24"},child:[]},{tag:"circle",attr:{cx:"296",cy:"392",r:"24"},child:[]},{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"32",d:"M128 48v32m256-32v32"},child:[]},{tag:"path",attr:{fill:"none",strokeLinejoin:"round",strokeWidth:"32",d:"M464 160H48"},child:[]}]})(e)}function w(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"32",d:"M416 128 192 384l-96-96"},child:[]}]})(e)}function j(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"m289.94 256 95-95A24 24 0 0 0 351 127l-95 95-95-95a24 24 0 0 0-34 34l95 95-95 95a24 24 0 1 0 34 34l95-95 95 95a24 24 0 0 0 34-34z"},child:[]}]})(e)}function N(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeMiterlimit:"10",strokeWidth:"32",d:"m400 148-21.12-24.57A191.43 191.43 0 0 0 240 64C134 64 48 150 48 256s86 192 192 192a192.09 192.09 0 0 0 181.07-128"},child:[]},{tag:"path",attr:{d:"M464 97.42V208a16 16 0 0 1-16 16H337.42c-14.26 0-21.4-17.23-11.32-27.31L436.69 86.1C446.77 76 464 83.16 464 97.42z"},child:[]}]})(e)}function S(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M456.69 421.39 362.6 327.3a173.81 173.81 0 0 0 34.84-104.58C397.44 126.38 319.06 48 222.72 48S48 126.38 48 222.72s78.38 174.72 174.72 174.72A173.81 173.81 0 0 0 327.3 362.6l94.09 94.09a25 25 0 0 0 35.3-35.3zM97.92 222.72a124.8 124.8 0 1 1 124.8 124.8 124.95 124.95 0 0 1-124.8-124.8z"},child:[]}]})(e)}function k(e){return(0,y.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"m476.59 227.05-.16-.07L49.35 49.84A23.56 23.56 0 0 0 27.14 52 24.65 24.65 0 0 0 16 72.59v113.29a24 24 0 0 0 19.52 23.57l232.93 43.07a4 4 0 0 1 0 7.86L35.53 303.45A24 24 0 0 0 16 327v113.31A23.57 23.57 0 0 0 26.59 460a23.94 23.94 0 0 0 13.22 4 24.55 24.55 0 0 0 9.52-1.93L476.4 285.94l.19-.09a32 32 0 0 0 0-58.8z"},child:[]}]})(e)}function C({isOpen:e,roomId:s,roomName:l,roomAvatar:o,isGroupChat:c=!1,keyword:d,allUsers:m,onClose:u,onNavigateToMessage:h,anchorToParent:x=!1}){let[g,p]=(0,r.useState)(!1),[f,b]=(0,r.useState)([]),[y,v]=(0,r.useState)(!1),[w,j]=(0,r.useState)(!1),[S,k]=(0,r.useState)(""),[C,_]=(0,r.useState)(""),[T,M]=(0,r.useState)(""),A=(0,r.useRef)(null),E=(0,r.useMemo)(()=>`__cache_room_results__:${s}:${d}`,[s,d]),$=(0,r.useMemo)(()=>`__room_results_scroll__:${s}:${d}`,[s,d]),[I,L]=(0,r.useState)(null);(0,r.useEffect)(()=>{try{let e=localStorage.getItem("info_user");if(e){let t=JSON.parse(e);t&&t._id&&L(String(t._id))}}catch{}},[]),(0,r.useEffect)(()=>{if(e)try{if(!(window.innerWidth<1024))return;localStorage.setItem("__return_room_results__",JSON.stringify({origin:x?"sidebar":"global",roomId:s,roomName:l,roomAvatar:o,isGroupChat:c,keyword:d,ts:Date.now()}))}catch{}},[e,s,l,o,c,d,x]),(0,r.useEffect)(()=>{if(!e||!d.trim()||!s)return void b([]);let t=!1,r=!1;try{let e=localStorage.getItem(E);if(e){let t=JSON.parse(e);Array.isArray(t)&&(b(t),r=!0,p(!1))}}catch{}return(async()=>{p(!r);try{let e=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"read",filters:{roomId:s,searchQuery:d.trim(),isRecalled:{$ne:!0},isDeleted:{$ne:!0},type:{$ne:"notify"}},limit:500,sort:{field:"timestamp",order:"desc"}})}),r=await e.json(),n=Array.isArray(r?.data)?r.data:[];if(!t){(0,i.normalizeNoAccent)(d),(0,i.hasDiacritics)(d);let e=n.filter(e=>{let t="file"===e.type?String(e.fileName||""):"sticker"===e.type?"":String(e.content||"");return(0,i.accentAwareIncludes)(t,d)}).slice().sort((e,t)=>Number(t.timestamp)-Number(e.timestamp));b(e);try{localStorage.setItem(E,JSON.stringify(e))}catch{}}}catch{t||r||b([])}finally{t||p(!1)}})(),()=>{t=!0}},[e,s,d,E]),(0,r.useEffect)(()=>{if(e)try{let e=Number(localStorage.getItem($)||"0");A.current&&e>0&&(A.current.scrollTop=e)}catch{}},[e,$]),(0,r.useEffect)(()=>{let e=A.current;if(!e)return;let t=()=>{try{localStorage.setItem($,String(e.scrollTop))}catch{}};return e.addEventListener("scroll",t),()=>{e.removeEventListener("scroll",t)}},[$,e]);let P=(0,r.useMemo)(()=>{let e=new Set,t=new Map;return f.forEach(r=>{let s="object"==typeof r.sender&&r.sender?String(r.sender._id):String(r.sender||"");s&&(e.add(s),"object"==typeof r.sender&&r.sender.name&&t.set(s,r.sender.name))}),Array.from(e).map(e=>{let r=m.find(t=>String(t._id)===String(e)),s=r?.name||r?.username||t.get(e)||e;return{id:e,name:s}}).sort((e,t)=>e.name.localeCompare(t.name))},[f,m]),H=(0,r.useMemo)(()=>{let e=[],t=C?new Date(C+"T00:00:00").getTime():null,r=T?new Date(T+"T23:59:59").getTime():null;return f.forEach(s=>{let n,i=!!y&&(n=String(s.content||""),/(https?:\/\/|www\.)/i.test(n)),a=!!w&&("file"===s.type||"image"===s.type||"video"===s.type),l=!y&&!w||y&&i||w&&a,o="object"==typeof s.sender&&s.sender?String(s.sender._id):String(s.sender||""),c=!S||String(o)===String(S),d=Number(s.timestamp||0);l&&c&&(!t||d>=t)&&(!r||d<=r)&&e.push(s)}),e},[f,y,w,S,C,T]),U=(0,r.useMemo)(()=>{let e=new Map,t=new Date;return H.forEach(r=>{let s=new Date(r.timestamp||0),n=s.toDateString()===t.toDateString()?"Hôm nay":`Th\xe1ng ${s.getMonth()+1}, ${s.getFullYear()}`;e.has(n)||e.set(n,[]),e.get(n).push(r)}),Array.from(e.entries()).map(([e,t])=>({label:e,items:t,count:t.length}))},[H]),R=(0,r.useMemo)(()=>{if(c)return;if(o)return o;let e=null,t=String(I||"");if(s&&s.includes("_")){let r=s.split("_");e=r[0]===t?r[1]:r[1]===t?r[0]:null}if(!e&&f.length>0){let r=f.find(e=>("object"==typeof e.sender?e.sender._id:String(e.sender))!==t);r&&(e="object"==typeof r.sender?r.sender._id:String(r.sender))}let r=e?m.find(t=>String(t._id)===String(e)):void 0;return r?.avatar},[c,o,s,I,f,m]),D=c?o:R||o;return e?(0,t.jsx)("div",{className:`${x?"absolute":"fixed"} inset-0 z-[50] flex items-center justify-center bg-black/40 backdrop-blur-sm px-0`,children:(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none shadow-none border-none overflow-hidden flex flex-col",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:u,className:"p-2 rounded-full hover:bg-gray-100 cursor-pointer",children:(0,t.jsx)(a.HiArrowLeft,{className:"w-5 h-5 text-gray-700"})}),(0,t.jsx)("div",{className:"w-9 h-9 rounded-full overflow-hidden bg-indigo-600 text-white flex items-center justify-center",children:D?(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(D),alt:"",width:36,height:36,className:"w-full h-full object-cover"}):(0,t.jsx)(n.default,{src:"/logo/avata.webp",alt:" ",width:64,height:64,className:"w-full h-full object-cover"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-semibold text-gray-900 text-sm truncate w-[10rem] md:w-[10rem]",children:l||"Cuộc trò chuyện"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:d})]})]}),(0,t.jsx)("button",{onClick:u,className:"p-2 rounded-full hover:bg-gray-100 cursor-pointer",children:(0,t.jsx)(a.HiXMark,{className:"w-5 h-5 text-gray-700"})})]}),(0,t.jsxs)("div",{className:" px-4 py-2 space-y-2 border-b border-gray-300",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("button",{onClick:()=>v(e=>!e),className:`px-3 py-1.5 text-sm rounded-full border cursor-pointer ${y?"bg-blue-100 text-blue-700 border-blue-300 hover:bg-blue-200":"bg-white text-gray-700 border-gray-300 hover:bg-gray-200"}`,children:"Link"}),(0,t.jsx)("button",{onClick:()=>j(e=>!e),className:`px-3 py-1.5 text-sm rounded-full border cursor-pointer ${w?"bg-green-100 text-green-700 border-green-300 hover:bg-green-200":"bg-white text-gray-700 border-gray-300 hover:bg-gray-200"}`,children:"File"}),(0,t.jsxs)("select",{value:S,onChange:e=>k(e.target.value),className:"border border-gray-300 rounded-lg px-2 py-1 text-sm cursor-pointer",children:[(0,t.jsx)("option",{value:"",children:"Tất cả"}),P.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name||e.id},e.id))]}),(0,t.jsx)("div",{className:"ml-auto text-xs text-gray-500",children:g?"Đang tải...":`${H.length} kết quả`})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 w-full",children:[(0,t.jsx)("input",{type:"date",value:C,onChange:e=>_(e.target.value),onInput:e=>_(e.target.value),placeholder:"Chọn ngày",className:"cursor-pointer border border-gray-300 rounded-lg px-2 py-1 text-sm w-1/2"}),(0,t.jsx)("span",{className:"text-gray-500 text-xs",children:"→"}),(0,t.jsx)("input",{type:"date",value:T,placeholder:"Chọn ngày",onChange:e=>M(e.target.value),onInput:e=>M(e.target.value),className:" cursor-pointer border border-gray-300 rounded-lg px-2 py-1 text-sm w-1/2"}),(0,t.jsx)("button",{type:"button",onClick:()=>{_(""),M("")},className:"ml-auto px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-gray-100 cursor-pointer",children:(0,t.jsx)(N,{className:"w-5 h-5"})})]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",ref:A,children:[U.map(e=>(0,t.jsxs)("div",{className:"px-4 py-3",children:[(0,t.jsxs)("div",{className:"text-xs font-bold text-gray-600 mb-2",children:[e.label," (",e.count,")"]}),(0,t.jsx)("div",{className:"space-y-2",children:e.items.map(e=>{var r;let g,p,b=(g="object"==typeof(r=e.sender)&&r?r._id:String(r||""),p=m.find(e=>String(e._id)===String(g)),p?.avatar||(c?void 0:R||o)),y="object"==typeof e.sender&&e.sender?e.sender._id:String(e.sender),v=m.find(e=>String(e._id)===String(y)),w=v?.name||("object"==typeof e.sender?e.sender.name:""),j="file"===e.type?e.fileName||"File":"sticker"===e.type?"[Sticker]":String(e.content||"");return(0,t.jsxs)("button",{onClick:()=>{let t=v?.name||("object"==typeof e.sender&&e.sender?e.sender.name:"")||"",r={_id:e._id,content:e.content,type:e.type,fileName:e.fileName,timestamp:e.timestamp,sender:y,senderName:t,roomId:e.roomId,roomName:l||"",isGroupChat:c,fileUrl:e.fileUrl};try{localStorage.setItem("__return_room_results__",JSON.stringify({origin:x?"sidebar":"global",roomId:s,roomName:l,roomAvatar:o,isGroupChat:c,keyword:d,ts:Date.now()}))}catch{}try{localStorage.setItem(E,JSON.stringify(f))}catch{}h(r,d),u()},className:"cursor-pointer w-full flex items-center gap-3 px-2 py-2 rounded-2xl hover:bg-gray-100 transition-colors text-left",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-gray-300 flex items-center justify-center flex-shrink-0",children:b?(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(b),alt:"",width:40,height:40,className:"w-full h-full object-cover"}):(0,t.jsx)(n.default,{src:"/logo/avata.webp",alt:" ",width:64,height:64,className:"w-full h-full object-cover"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsx)("span",{className:"font-semibold text-gray-800 text-[1rem] truncate",children:w||l}),(0,t.jsx)("span",{className:"text-sm text-gray-500",children:new Date(e.timestamp).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})})]}),"image"===e.type&&e.fileUrl?(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(String(e.fileUrl)),alt:"",width:320,height:240,className:"w-10 h-18 rounded-lg object-cover"})}):"video"===e.type&&e.fileUrl?(0,t.jsxs)("div",{className:"relative rounded-2xl overflow-hidden cursor-pointer shadow-lg max-w-[8vw] sm:max-w-[6rem] aspect-video bg-black",children:[(0,t.jsx)("video",{src:(0,i.getProxyUrl)(String(e.fileUrl)),className:"w-full h-full object-cover",muted:!0,playsInline:!0,loop:!0}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-4 h-4 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(a.HiPlay,{className:"w-2 h-2 text-blue-600"})})})]}):(0,t.jsx)("p",{className:" text-gray-700 line-clamp-2",children:(e=>{if(!d.trim()||!e)return e;let r=(0,i.buildAccentInsensitiveRegex)(d),s=String(e).split(r);return(0,t.jsx)("span",{children:s.map((e,s)=>r.test(e)?(0,t.jsx)("span",{className:" text-blue-600 md:text-blue-700 font-semibold rounded",children:e},s):(0,t.jsx)("span",{children:e},s))})})(j)})]})]},e._id)})})]},e.label)),!g&&0===H.length&&(0,t.jsx)("div",{className:"h-full flex items-center justify-center px-6",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-full bg-gray-100 mx-auto mb-3"}),(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"Không tìm thấy tin nhắn phù hợp"})]})})]})]})}):null}e.s(["IoCalendarOutline",()=>v,"IoCheckmark",()=>w,"IoClose",()=>j,"IoReload",()=>N,"IoSearch",()=>S,"IoSend",()=>k],69620);var _=e.i(50719);let T=({isOpen:e,onClose:r,title:s="Tính năng đang phát triển",description:n="Chúng tôi đang nỗ lực hoàn thiện tính năng này để mang đến trải nghiệm tốt nhất cho bạn. Vui lòng quay lại sau!"})=>e?(0,t.jsxs)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity",onClick:r}),(0,t.jsxs)("div",{className:"relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all animate-in fade-in zoom-in duration-200",children:[(0,t.jsxs)("div",{className:"h-24 bg-gradient-to-br from-blue-500 to-indigo-600 relative overflow-hidden",children:[(0,t.jsx)("div",{className:"absolute top-0 right-0 p-8 bg-white/10 rounded-full transform translate-x-1/2 -translate-y-1/2 blur-2xl w-32 h-32"}),(0,t.jsx)("div",{className:"absolute bottom-0 left-0 p-8 bg-black/10 rounded-full transform -translate-x-1/2 translate-y-1/2 blur-xl w-24 h-24"}),(0,t.jsx)("button",{onClick:r,className:"absolute top-3 right-3 p-1.5 bg-white/20 hover:bg-white/30 text-white rounded-full transition-colors backdrop-blur-sm",children:(0,t.jsx)(_.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"px-6 pb-8 pt-0 relative",children:[(0,t.jsx)("div",{className:"absolute -top-12 left-1/2 transform -translate-x-1/2",children:(0,t.jsx)("div",{className:"w-10 h-10 bg-white rounded-full p-1.5 shadow-lg flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-full h-full bg-blue-50 rounded-full flex items-center justify-center",children:(0,t.jsx)(_.HiSparkles,{className:"w-10 h-10 text-blue-500 animate-pulse"})})})}),(0,t.jsxs)("div",{className:"mt-10 text-center space-y-3",children:[(0,t.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:s}),(0,t.jsx)("p",{className:"text-gray-500 text-sm leading-relaxed",children:n})]}),(0,t.jsx)("div",{className:"mt-8 flex justify-center",children:(0,t.jsx)("button",{onClick:r,className:"px-8 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 shadow-lg shadow-blue-500/30 transform transition-all active:scale-95",children:"Đã hiểu"})})]})]})]}):null;var M=e.i(25685);function A({isOpen:e,onClose:s,currentUserId:l,currentUser:o,groups:c=[],allUsers:d=[],config:m}){let[u,h]=(0,r.useState)(o?.[m.fields.userTags]||[]);r.default.useEffect(()=>{async function t(){if(l)try{let e=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:l})}),t=await e.json(),r=t&&t.row||(Array.isArray(t?.data)?t.data[0]:null),s=r?.[m.fields.userTags]||[];h(Array.isArray(s)?s:[])}catch{}}e&&t()},[e,l,m.fields.userTags]),r.default.useEffect(()=>{function e(e){let t=e.detail;t&&String(t.userId)===String(l)&&h(Array.isArray(t.tags)?t.tags:[])}return window.addEventListener(m.events.userUpdated,e),()=>{window.removeEventListener(m.events.userUpdated,e)}},[l,m.events.userUpdated]);let[x,g]=(0,r.useState)(null),[p,f]=(0,r.useState)(null),b=(0,r.useMemo)(()=>u.find(e=>e.id===x)||null,[u,x]),y=(0,r.useMemo)(()=>u.find(e=>e.id===p)||null,[u,p]),v=(0,r.useMemo)(()=>[...c,...d],[c,d]),w=e=>!0===e.isGroup||Array.isArray(e.members)?(e.name||"").trim()||"Nhóm":l&&e.nicknames?.[l]?e.nicknames[l].trim():(e.name||e.username||"Người dùng").trim(),[j,N]=(0,r.useState)({});r.default.useEffect(()=>{function e(e){let t=e.detail;if(!t||String(t.userId)!==String(l))return;let r=t[m.api.updateChatDataField]||t.categories||t.tags;N(e=>({...e,[t.roomId]:r||[]}))}return window.addEventListener(m.events.chatUpdated,e),()=>{window.removeEventListener(m.events.chatUpdated,e)}},[l,m.events.chatUpdated,m.api.updateChatDataField]);let S=e=>{if(j[String(e._id)])return j[String(e._id)];let t=e[m.fields.chatTagsBy],r=e[m.fields.chatTagsSimple],s=(r&&Array.isArray(r)?r:void 0)||(t&&l?t[String(l)]:void 0)||[];return Array.isArray(s)?s.filter(e=>"string"==typeof e):[]},[k,C]=(0,r.useState)([]),[_,T]=(0,r.useState)(""),[A,E]=(0,r.useState)(""),[$,I]=(0,r.useState)(!1),[L,P]=(0,r.useState)(""),[H,U]=(0,r.useState)(!1),[R,D]=(0,r.useState)(!1),O=(0,r.useMemo)(()=>["bg-red-500","bg-pink-500","bg-orange-400","bg-yellow-400","bg-green-500","bg-teal-500","bg-blue-500","bg-purple-500"],[]),[B,F]=(0,r.useState)(!1),z=async e=>{if(l)try{await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",field:"_id",value:l,data:{[m.fields.userTags]:e}})})}catch(e){console.error("Failed to save tags",e)}},V=()=>{g(null),F(!1),C([]),T(""),E(""),I(!1),P("")},G=async(e,t)=>{try{let r=!0===e.isGroup||Array.isArray(e.members),s=String(e._id);await fetch(r?"/api/groups":"/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:m.api.updateChatAction,currentUserId:l,roomId:s,data:{[m.api.updateChatDataField]:t}})});try{let e=`${m.events.localStorageKeyPrefix}:${String(l)}:${s}`;localStorage.setItem(e,JSON.stringify(t));let r=new CustomEvent(m.events.chatUpdated,{detail:{userId:String(l),roomId:s,[m.api.updateChatDataField]:t}});window.dispatchEvent(r)}catch{}}catch{}},W=async()=>{if(!b&&!B)return;let e=B?`tag_${Date.now()}`:b.id,t=B?[]:v.filter(t=>S(t).includes(e)).map(e=>String(e._id)),r=k.filter(e=>!t.includes(e)),s=t.filter(e=>!k.includes(e));U(!0);let n=[];for(let t of v){let i=String(t._id),a=S(t);if(r.includes(i)){let r=[...a,e].filter((e,t,r)=>r.indexOf(e)===t);n.push(G(t,r))}else if(s.includes(i)){let r=a.filter(t=>t!==e);n.push(G(t,r))}}await Promise.all(n);let i=[...u];B?i.push({id:e,label:_,color:A}):i=u.map(t=>t.id===e?{...t,label:_,color:A}:t),await z(i),h(i);try{let e=new CustomEvent(m.events.userUpdated,{detail:{userId:String(l),tags:i}});window.dispatchEvent(e)}catch{}U(!1),V()},[X,J]=(0,r.useState)(null),K=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"};return e?(0,t.jsxs)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 md:p-4",children:[(0,t.jsxs)("div",{className:"bg-white w-full h-full md:h-auto md:max-w-md md:rounded-lg shadow-xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 flex flex-col",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100 flex-none",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-800",children:m.titles.main}),(0,t.jsx)("button",{onClick:s,className:"p-1 rounded-full hover:bg-gray-100 text-gray-500 transition-colors cursor-pointer",children:(0,t.jsx)(a.HiXMark,{className:"w-6 h-6"})})]}),(0,t.jsxs)("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:[(0,t.jsx)("div",{className:"mb-3 text-sm text-gray-600 flex-none",children:m.titles.list}),(0,t.jsx)("div",{className:"space-y-2 flex-1 overflow-y-auto custom-scrollbar md:max-h-[60vh]",children:u.map((e,r)=>(0,t.jsxs)("div",{draggable:!0,onDragStart:e=>{J(r),e.dataTransfer.effectAllowed="move"},onDragOver:K,onDrop:e=>((e,t)=>{if(e.preventDefault(),null===X||X===t)return;let r=[...u],[s]=r.splice(X,1);r.splice(t,0,s),h(r),z(r);try{let e=new CustomEvent(m.events.userUpdated,{detail:{userId:String(l),tags:r}});window.dispatchEvent(e)}catch{}J(null)})(e,r),className:`flex items-center justify-between gap-3 p-3 bg-gray-50 rounded-md group hover:bg-gray-100 transition-colors cursor-move mr-1 ${X===r?"opacity-50 ring-2 ring-blue-500 ring-dashed":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{className:"text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing",children:(0,t.jsx)(a.HiBars3,{className:"w-5 h-5"})}),(0,t.jsx)("div",{className:"flex items-center justify-center",children:(0,t.jsx)("div",{className:`h-4 w-6 ${e.color}`,style:{clipPath:"polygon(0% 0%, 75% 0%, 100% 50%, 75% 100%, 0% 100%)"}})}),(0,t.jsx)("span",{className:"flex-1 text-gray-700 font-medium text-sm",children:e.label})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("button",{className:"cursor-pointer text-gray-400 hover:text-gray-600 transition-colors",onClick:()=>{var t;let r;return g(t=e.id),F(!1),r=u.find(e=>e.id===t),void(T(r?.label||""),E(r?.color||O[0]),C(v.filter(e=>S(e).includes(t)).map(e=>String(e._id))),I(!1),P(""))},children:(0,t.jsx)(M.CiEdit,{className:"w-5 h-5"})}),(0,t.jsx)("button",{className:"cursor-pointer text-red-600 hover:text-red-700 transition-colors",onClick:()=>{f(e.id)},children:(0,t.jsx)(M.CiTrash,{className:"w-5 h-5"})})]})]},e.id))}),(0,t.jsxs)("button",{className:"cursor-pointer mt-4 flex items-center gap-2 text-blue-600 font-medium hover:text-blue-700 transition-colors w-full px-2 py-2 rounded-md hover:bg-blue-50",onClick:()=>{F(!0),g(null),T(""),E(O[0]),C([]),I(!1),P("")},children:[(0,t.jsx)(a.HiPlus,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:m.titles.add})]})]})]}),y&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/40 p-4",children:(0,t.jsxs)("div",{className:"bg-white w-full max-w-sm rounded-lg shadow-xl overflow-hidden",children:[(0,t.jsx)("div",{className:"px-4 py-3 border-b border-gray-100",children:(0,t.jsx)("h4",{className:"text-base font-semibold text-gray-800",children:m.titles.deleteConfirm})}),(0,t.jsxs)("div",{className:"px-4 py-3 text-sm text-gray-700",children:["Bạn có chắc muốn xóa ",m.titles.itemName," “",y.label,"”?"]}),(0,t.jsxs)("div",{className:"px-4 py-3 flex items-center justify-end gap-2",children:[(0,t.jsx)("button",{className:"cursor-pointer px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 text-sm font-medium",onClick:()=>f(null),children:"Hủy"}),(0,t.jsx)("button",{className:"cursor-pointer px-3 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white text-sm font-medium",onClick:()=>{if(!y)return;let e=u.filter(e=>e.id!==y.id);h(e),z(e);try{let t=new CustomEvent(m.events.userUpdated,{detail:{userId:String(l),tags:e}});window.dispatchEvent(t)}catch{}f(null)},children:"Xóa"})]})]})}),(b||B)&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/40 md:p-4",children:(0,t.jsxs)("div",{className:"bg-white w-full h-full md:h-auto md:max-w-lg md:rounded-lg shadow-xl overflow-hidden flex flex-col",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100 flex-none",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:V,className:"p-1 rounded-full hover:bg-gray-100 text-gray-500 transition-colors cursor-pointer",title:"Quay lại",children:(0,t.jsx)(a.HiChevronLeft,{className:"w-6 h-6"})}),(0,t.jsx)("h4",{className:"text-base font-semibold text-gray-800",children:B?m.titles.create:m.titles.edit})]}),(0,t.jsx)("button",{onClick:V,className:"p-1 rounded-full hover:bg-gray-100 text-gray-500 transition-colors cursor-pointer",children:(0,t.jsx)(a.HiXMark,{className:"w-6 h-6"})})]}),(0,t.jsxs)("div",{className:"p-4 space-y-4 flex-1 overflow-y-auto",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-600",children:["Tên ",m.titles.itemName]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{value:_,onChange:e=>T(e.target.value),placeholder:`Nhập t\xean ${m.titles.itemName}`,className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{className:`cursor-pointer h-6 w-10 ${A} rounded-md`,onClick:()=>D(e=>!e),style:{clipPath:"polygon(0% 0%, 75% 0%, 100% 50%, 75% 100%, 0% 100%)"},title:"Đổi màu"}),R&&(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl p-2 z-[10001]",children:[(0,t.jsx)("div",{className:"px-1 pb-1 text-xs font-medium text-gray-600",children:"Thay đổi màu thẻ"}),(0,t.jsx)("div",{className:"flex items-center gap-2",children:O.map(e=>(0,t.jsx)("button",{className:`relative w-6 h-6 rounded-sm ${e} border border-white shadow-sm`,onClick:()=>{E(e),D(!1)},title:e,children:A===e&&(0,t.jsx)("span",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)(a.HiCheck,{className:"w-3.5 h-3.5 text-yellow-300 drop-shadow"})})},e))})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Hội thoại được gắn thẻ"}),(0,t.jsx)("button",{className:"cursor-pointer text-blue-600 text-sm font-medium",onClick:()=>I(e=>!e),children:"+ Thêm hội thoại"}),$&&(0,t.jsxs)("div",{className:"mt-2 border border-gray-200 rounded-md",children:[(0,t.jsx)("div",{className:"p-2 border-b border-gray-200",children:(0,t.jsx)("input",{value:L,onChange:e=>P(e.target.value),placeholder:"Tìm hội thoại",className:"w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})}),(0,t.jsxs)("div",{className:"max-h-48 overflow-auto custom-scrollbar",children:[v.filter(e=>!k.includes(String(e._id))).filter(e=>(0,i.accentAwareIncludes)(w(e),L.trim())).slice(0,50).map(e=>(0,t.jsxs)("button",{className:"w-full flex items-center gap-3 p-2 hover:bg-gray-50 text-left transition-colors",onClick:()=>{C(t=>[...t,String(e._id)]),I(!1),P("")},children:[(0,t.jsx)("div",{className:"relative w-8 h-8 flex-none",children:(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(e.avatar||"/logo/avata.webp"),alt:"",fill:!0,className:"rounded-full object-cover"})}),(0,t.jsx)("span",{className:"text-sm text-gray-700 truncate",children:w(e)})]},String(e._id))),0===v.filter(e=>!k.includes(String(e._id))).length&&(0,t.jsx)("div",{className:"p-4 text-center text-sm text-gray-500",children:"Không còn hội thoại nào để thêm"})]})]}),(0,t.jsxs)("div",{className:"space-y-1 max-h-48 overflow-y-auto custom-scrollbar",children:[k.map(e=>{let r=v.find(t=>String(t._id)===e);return r?(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-md",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 overflow-hidden",children:[(0,t.jsx)("div",{className:"relative w-6 h-6 flex-none",children:(0,t.jsx)(n.default,{src:(0,i.getProxyUrl)(r.avatar||"/placeholder-user.jpg"),alt:"",fill:!0,className:"rounded-full object-cover"})}),(0,t.jsx)("span",{className:"text-sm text-gray-700 truncate",children:w(r)})]}),(0,t.jsx)("button",{className:"text-gray-400 hover:text-red-500 transition-colors p-1",onClick:()=>{C(t=>t.filter(t=>t!==e))},children:(0,t.jsx)(a.HiXMark,{className:"w-4 h-4"})})]},e):null}),0===k.length&&!$&&(0,t.jsx)("div",{className:"text-sm text-gray-400 italic py-2",children:"Chưa có hội thoại nào được chọn"})]})]})]}),(0,t.jsxs)("div",{className:"p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50",children:[(0,t.jsx)("button",{className:"cursor-pointer px-4 py-2 rounded-md text-gray-700 hover:bg-gray-200 text-sm font-medium transition-colors",onClick:V,children:"Hủy"}),(0,t.jsx)("button",{className:"cursor-pointer px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:W,disabled:!_.trim()||H,children:H?"Đang lưu...":"Lưu thay đổi"})]})]})})]}):null}let E={titles:{main:"Quản lý thẻ phân loại",list:"Danh sách thẻ phân loại",add:"Thêm phân loại",edit:"Chi tiết thẻ phân loại",create:"Thêm phân loại",deleteConfirm:"Xác nhận xóa",itemName:"thẻ phân loại"},fields:{userTags:"categoryTags",chatTagsBy:"categoriesBy",chatTagsSimple:"categories"},events:{userUpdated:"userCategoryTagsUpdated",chatUpdated:"chatCategoriesUpdated",localStorageKeyPrefix:"chatCategories"},api:{updateChatAction:"updateCategories",updateChatDataField:"categories"}};function $(e){return(0,t.jsx)(A,{...e,config:E})}let I={titles:{main:"Quản lý thẻ tags",list:"Danh sách thẻ tags",add:"Thêm thẻ mới",edit:"Chi tiết thẻ tags",create:"Thêm thẻ mới",deleteConfirm:"Xác nhận xóa",itemName:"thẻ tags"},fields:{userTags:"userTags",chatTagsBy:"tagsBy",chatTagsSimple:"tags"},events:{userUpdated:"userTagsUpdated",chatUpdated:"chatTagsUpdated",localStorageKeyPrefix:"chatTags"},api:{updateChatAction:"updateTags",updateChatDataField:"tags"}};function L(e){return(0,t.jsx)(A,{...e,config:I})}let P=(e,t)=>!0===e.isGroup||Array.isArray(e.members)?(e.name||"").trim()||"Nhóm":t&&e.nicknames?.[t]?e.nicknames[t].trim():(e.name||e.username||"Người dùng").trim(),H=(e,t=50)=>{if(!e)return"";let r=e.replace(/@\[([^\]]+)\]\([^)]+\)/g,"@$1");return r.length>t?r.slice(0,t)+"...":r};function U({currentUser:e,groups:s,allUsers:n,searchTerm:o,setSearchTerm:c,setShowCreateGroupModal:d,selectedChat:m,onSelectChat:u,onChatAction:h,onNavigateToMessage:g,styleWidget:y="",onlyGroups:v=!1,onlyPersonal:w=!1}){let[j,N]=(0,r.useState)("calendar"),S=e._id,[k,_]=(0,r.useState)("all"),[M,A]=(0,r.useState)({contacts:[],messages:[]}),[E,I]=(0,r.useState)(!1),H=(0,r.useRef)(null),U=(0,r.useRef)(null),[R,D]=(0,r.useState)("all");(0,b.useRouter)();let O=(0,b.usePathname)(),B="/chat-iframe"===O||(O?.startsWith("/chat-iframe")??!1),[F,z]=(0,r.useState)(!1),[V,G]=(0,r.useState)(!1),W=(0,r.useRef)(null),[X,J]=(0,r.useState)({isOpen:!1,title:"",desc:""}),[K,q]=(0,r.useState)(null),[Q,Y]=(0,r.useState)(!1),Z=(0,r.useRef)(null),[ee,et]=(0,r.useState)(!1),[er,es]=(0,r.useState)([]),[en,ei]=(0,r.useState)(e?.categoryTags||[]);(0,r.useEffect)(()=>{function e(e){Z.current&&!Z.current.contains(e.target)&&Y(!1)}return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,r.useEffect)(()=>{ei(e?.categoryTags||[])},[e]),(0,r.useEffect)(()=>{!async function(){if(S)try{let e=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:String(S)})}),t=await e.json(),r=t&&t.row||(Array.isArray(t?.data)?t.data[0]:null);if(r){let e=r.categoryTags||[];ei(Array.isArray(e)?e:[]);let t=r.userTags||[];eh(Array.isArray(t)?t:[])}}catch{}}()},[S]),(0,r.useEffect)(()=>{function e(e){let t=e.detail;t&&String(t.userId)===String(S)&&ei(Array.isArray(t.tags)?t.tags:[])}return window.addEventListener("userCategoryTagsUpdated",e),()=>{window.removeEventListener("userCategoryTagsUpdated",e)}},[S]);let[ea,el]=(0,r.useState)(!1),[eo,ec]=(0,r.useState)([]),[ed,em]=(0,r.useState)(!1),[eu,eh]=(0,r.useState)(e?.userTags||[]),ex=(0,r.useRef)(null);(0,r.useEffect)(()=>{function e(e){ex.current&&!ex.current.contains(e.target)&&em(!1)}return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,r.useEffect)(()=>{eh(e?.userTags||[])},[e]),(0,r.useEffect)(()=>{function e(e){let t=e.detail;t&&String(t.userId)===String(S)&&eh(Array.isArray(t.tags)?t.tags:[])}return window.addEventListener("userTagsUpdated",e),()=>{window.removeEventListener("userTagsUpdated",e)}},[S]);let eg=(0,r.useCallback)(e=>{let t=e.categories||e.categoriesBy?.[String(S)]||[];if(Array.isArray(t)&&t.length>0)return t.filter(e=>"string"==typeof e);try{let t=`chatCategories:${String(S)}:${String(e._id)}`,r=localStorage.getItem(t);if(!r)return[];let s=JSON.parse(r);if(Array.isArray(s))return s.filter(e=>"string"==typeof e)}catch{}return[]},[S]);(0,r.useEffect)(()=>{try{let e=localStorage.getItem("__return_room_results__");if(!e)return;let t=JSON.parse(e);t&&"sidebar"===t.origin&&(c((t.keyword||"").toString()),q({roomId:t.roomId,roomName:t.roomName,roomAvatar:t.roomAvatar,isGroupChat:!!t.isGroupChat}),localStorage.removeItem("__return_room_results__"))}catch{}},[m]);let ep=(0,r.useCallback)(async t=>{if(!t.trim()||!e)return void A({contacts:[],messages:[]});(0,i.normalizeNoAccent)(t),(0,i.hasDiacritics)(t);let r=[...s,...n];v?r=[...s]:w&&(r=[...n]);let a=r.filter(e=>(0,i.accentAwareIncludes)(P(e,String(S)),t)).map(e=>({item:e,score:(0,i.computeMatchScore)(P(e,String(S)),t)})).sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;let r=P(e.item,String(S)),s=P(t.item,String(S));return r.localeCompare(s)}).slice(0,10).map(e=>e.item);try{let r=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"globalSearch",data:{userId:e._id,searchTerm:t,limit:200}})}),s=(await r.json()).data||[],n=s;v?n=s.filter(e=>e.isGroupChat):w&&(n=s.filter(e=>!e.isGroupChat));let l=e=>"file"===e.type?e.fileName||"File":"image"===e.type?"Hình ảnh":"video"===e.type?"Video":"sticker"===e.type?"Sticker":e.content||"";n=[...n=n.filter(e=>(0,i.accentAwareIncludes)(l(e),t))].sort((e,r)=>{let s=(0,i.computeMatchScore)(l(e),t),n=(0,i.computeMatchScore)(l(r),t);return n!==s?n-s:(r.timestamp||0)-(e.timestamp||0)}),A({contacts:a,messages:n})}catch(e){console.error("Global search error:",e),A({contacts:a,messages:[]})}},[e,s,n,v,w,S]);(0,r.useEffect)(()=>{o.trim()&&0===M.contacts.length&&0===M.messages.length&&(I(!0),(async()=>{await ep(o),I(!1)})())},[o,M.contacts.length,M.messages.length,ep]);let ef=(0,r.useMemo)(()=>M.messages,[M.messages]),eb=(0,r.useMemo)(()=>M.messages,[M.messages]),ey=(0,r.useMemo)(()=>{let e=new Map;return ef.forEach(t=>{if(!t.roomId)return;let r=t.roomId;e.has(r)||e.set(r,{roomId:t.roomId,roomName:t.roomName||"Cuộc trò chuyện",isGroupChat:t.isGroupChat||!1,avatar:((e,t)=>{if(t){let t=s.find(t=>String(t._id)===String(e));return t?.avatar}let r=String(e).split("_"),i=String(S),a=r[0]===i?r[1]:r[1]===i?r[0]:r.find(e=>e!==i),l=n.find(e=>String(e._id)===String(a));return l?.avatar})(t.roomId,t.isGroupChat||!1),messages:[],latestTimestamp:t.timestamp||Date.now()}),e.get(r).messages.push(t)}),Array.from(e.values())},[ef]),ev=(0,r.useMemo)(()=>{let e=new Map;return eb.forEach(t=>{if(!t.roomId)return;let r=t.roomId;e.has(r)||e.set(r,{roomId:t.roomId,roomName:t.roomName||"Cuộc trò chuyện",isGroupChat:t.isGroupChat||!1,avatar:((e,t)=>{if(t){let t=s.find(t=>String(t._id)===String(e));return t?.avatar}let r=String(e).split("_"),i=String(S),a=r[0]===i?r[1]:r[1]===i?r[0]:r.find(e=>e!==i),l=n.find(e=>String(e._id)===String(a));return l?.avatar})(t.roomId,t.isGroupChat||!1),files:[],latestTimestamp:t.timestamp||Date.now()}),e.get(r).files.push(t)}),Array.from(e.values())},[eb]),ew=M.contacts.length>0||M.messages.length>0,ej=o.trim().length>0,eN=(0,r.useMemo)(()=>v?[...s]:w?[...n]:[...s,...n],[s,n,v,w,S]),eS=(0,r.useMemo)(()=>{let e=new Map;return eN.forEach(t=>{e.set(String(t._id),eg(t))}),e},[eN,eg]),ek=(0,r.useMemo)(()=>{let e=eN.filter(e=>{let t=e.isHidden,r=P(e,String(S)),s=!ej||(0,i.accentAwareIncludes)(r,o);return ej?s:"hidden"===R?t&&s:!t&&s});return ej||("group"===R?e=e.filter(e=>!0===e.isGroup||Array.isArray(e.members)):"personal"===R?e=e.filter(e=>!(!0===e.isGroup||Array.isArray(e.members))):"unread"===R?e=e.filter(e=>(e.unreadCount||0)>0):"read"===R&&(e=e.filter(e=>0===(e.unreadCount||0)))),e.sort((e,t)=>{let r=e.lastMessageAt||0,s=t.lastMessageAt||0,n=e.isPinned||!1,i=t.isPinned||!1;return n&&!i?-1:!n&&i?1:0===r&&0===s?P(e).localeCompare(P(t)):s-r}),er.length>0&&(e=e.filter(e=>(eS.get(String(e._id))||[]).some(e=>er.includes(e)))),eo.length>0&&(e=e.filter(e=>{let t=e.tags||e.tagsBy?.[String(S)]||[];if(!t||0===t.length)try{let t=`chatTags:${String(S)}:${String(e._id)}`,r=localStorage.getItem(t);if(r){let e=JSON.parse(r);if(Array.isArray(e))return e.some(e=>eo.includes(e))}}catch{}return t.some(e=>eo.includes(e))})),e},[eN,o,R,ej,er,eS,eo,S]),eC=(0,r.useMemo)(()=>{let e=eN.filter(e=>!e.isHidden),t=eN.filter(e=>e.isHidden),r=e.filter(e=>!0===e.isGroup||Array.isArray(e.members)),s=e.filter(e=>!(!0===e.isGroup||Array.isArray(e.members)));return{all:e.length,unread:e.filter(e=>(e.unreadCount||0)>0).length,read:e.filter(e=>0===(e.unreadCount||0)).length,group:r.length,personal:s.length,hidden:t.length}},[eN]);return(0,r.useEffect)(()=>{"hidden"===R&&0===eC.hidden&&D("all")},[R,eC.hidden]),(0,t.jsxs)("aside",{id:"left-sidebar-container",className:"relative flex flex-col h-[100dvh] lg:h-full bg-gradient-to-br from-slate-50 via-white to-indigo-50 border-r border-gray-200 w-full lg:w-[20rem] shadow-2xl overflow-hidden",children:[(0,t.jsxs)("div",{className:"bg-blue-400 shadow-2xl lg:bg-white lg:shadow-none mb-1",children:[(0,t.jsx)("div",{className:"px-2 pb-3 pt-3 lg:px-2 lg:py-3 ",children:(0,t.jsxs)("div",{className:"flex items-center gap-4 lg:gap-3",children:[(0,t.jsxs)("div",{className:"relative flex-1 group",children:[(0,t.jsx)(a.HiMagnifyingGlass,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white/70 lg:text-gray-500 pointer-events-none  transition-colors duration-300 group-focus-within:text-[#0068ff] group-focus-within:opacity-100"}),(0,t.jsx)("input",{ref:U,type:"text",placeholder:"Tìm kiếm",value:o,onChange:e=>(e=>{if(c(e),H.current&&clearTimeout(H.current),!e.trim()){A({contacts:[],messages:[]}),I(!1);return}I(!0),H.current=setTimeout(()=>{ep(e),I(!1)},400)})(e.target.value),className:"w-full pl-11 pr-10 py-1 bg-transparent rounded-xl focus:outline-none focus:bg-white transition-all duration-300 text-base text-white placeholder-white/70 focus:text-gray-800 focus:placeholder-gray-500 lg:pl-10 lg:py-2 lg:bg-[#EAEDF0] lg:rounded-md lg:text-sm lg:text-gray-900 lg:placeholder-gray-500 lg:focus:ring-1 lg:focus:ring-[#0068ff]"}),o&&(0,t.jsx)("button",{onClick:()=>{c(""),A({contacts:[],messages:[]})},className:"absolute cursor-pointer right-3 lg:right-2 top-1/2 -translate-y-1/2 w-7 h-7 lg:w-6 lg:h-6 rounded-full bg-white/20 hover:bg-white/30 group-focus-within:bg-gray-300 group-focus-within:hover:bg-gray-400 lg:bg-transparent lg:hover:bg-gray-200 lg:group-focus-within:bg-transparent transition-all duration-300 flex items-center justify-center active:scale-95",children:(0,t.jsx)(a.HiXMark,{className:"w-4 h-4 text-white group-focus-within:text-gray-600 lg:text-gray-500 transition-colors duration-300"})})]}),!B&&(0,t.jsxs)("div",{className:"flex items-center gap-4 lg:gap-1",children:[!w&&(0,t.jsxs)("button",{onClick:()=>d(!0),className:"cursor-pointer w-8 h-8 flex items-center justify-center bg-white/20 hover:bg-white/30 rounded-3xl backdrop-blur-sm lg:bg-transparent lg:hover:bg-gray-100 lg:rounded-md transition-all active:scale-95 group",title:"Tạo nhóm mới",children:[(0,t.jsx)(p.FaPlus,{className:"w-4 h-4 text-white lg:hidden"}),(0,t.jsxs)("div",{className:"hidden lg:block relative",children:[(0,t.jsx)(a.HiUserGroup,{className:"w-5 h-5 text-gray-600 group-hover:text-[#0068ff] transition-colors"}),(0,t.jsx)("span",{className:"absolute -top-1 -right-1 text-[10px] text-gray-600 font-bold",children:"+"})]})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsxs)("button",{ref:W,onClick:()=>G(!V),className:"cursor-pointer p-1 w-8 h-8 flex items-center justify-center bg-white/20 hover:bg-white/30 rounded-3xl backdrop-blur-sm lg:bg-transparent lg:hover:bg-gray-100 lg:rounded-md transition-all active:scale-95 group",children:[(0,t.jsx)(a.HiEllipsisVertical,{className:"w-5 h-5 text-white text-sm lg:hidden"}),(0,t.jsx)(p.FaPlus,{className:"hidden lg:block w-5 h-5 text-gray-600 group-hover:text-[#0068ff] transition-colors"})]}),(0,t.jsx)(f,{isOpen:V,onClose:()=>G(!1),filterType:R,setFilterType:D,counts:eC,onOpenCreateGroup:()=>d(!0),onOpenGlobalFolder:()=>z(!0),buttonRef:W,onlyGroups:v,onlyPersonal:w})]})]})]})}),(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 bg-white border-b border-gray-200 select-none",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)("button",{onClick:()=>D("all"),className:`relative py-3 text-sm font-medium transition-colors cursor-pointer ${"all"===R||"group"===R&&v||"personal"===R&&w?"text-blue-600":"text-gray-500 hover:text-gray-700"}`,children:["Tất cả",("all"===R||"group"===R&&v||"personal"===R&&w)&&(0,t.jsx)("span",{className:"absolute bottom-0 left-0 w-full h-0.5 bg-blue-600 rounded-t-full"})]}),(0,t.jsxs)("button",{onClick:()=>D("unread"),className:`relative py-3 text-sm font-medium transition-colors cursor-pointer ${"unread"===R?"text-blue-600":"text-gray-500 hover:text-gray-700"}`,children:["Chưa đọc","unread"===R&&(0,t.jsx)("span",{className:"absolute bottom-0 left-0 w-full h-0.5 bg-blue-600 rounded-t-full"})]})]}),(0,t.jsxs)("div",{className:"flex justify-end items-center gap-4",children:[(0,t.jsxs)("div",{className:"relative",ref:ex,children:[(0,t.jsxs)("button",{onClick:()=>em(!ed),className:`flex items-center gap-1 text-sm font-medium py-3 transition-colors cursor-pointer ${eo.length>0?"text-blue-600":"text-gray-500 hover:text-gray-700"}`,children:["Tags",(0,t.jsx)(a.HiChevronDown,{className:`w-4 h-4 transition-transform duration-200 ${ed?"rotate-180":""}`})]}),ed&&(0,t.jsxs)("div",{className:"absolute right-[-5.7rem] top-full mt-1 w-64 bg-white rounded-lg shadow-xl border border-gray-100 py-2 z-50",children:[(0,t.jsx)("div",{className:"px-4 pb-2 text-xs text-gray-500",children:"Theo thẻ tags"}),(0,t.jsx)("div",{className:"max-h-64 overflow-auto custom-scrollbar",children:eu.map(e=>{let r=eo.includes(e.id);return(0,t.jsxs)("button",{onClick:()=>{ec(t=>r?t.filter(t=>t!==e.id):[...t,e.id])},className:"w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 cursor-pointer",children:[(0,t.jsx)("span",{className:`inline-block w-3.5 h-3.5 rounded-sm ${e.color} border border-white shadow-sm`}),(0,t.jsx)("span",{className:"flex-1 text-left text-sm text-gray-800",children:e.label}),(0,t.jsx)("input",{type:"checkbox",checked:r,readOnly:!0,className:"w-4 h-4"})]},e.id)})}),(0,t.jsx)("div",{className:"border-t mt-2 pt-2",children:(0,t.jsx)("button",{onClick:()=>{el(!0),em(!1)},className:"w-full p-1 text-sm text-[#0068ff] hover:bg-gray-50 cursor-pointer",children:"Quản lý thẻ tags"})})]})]}),(0,t.jsxs)("div",{className:"relative",ref:Z,children:[(0,t.jsxs)("button",{onClick:()=>Y(!Q),className:`flex items-center gap-1 text-sm font-medium py-3 transition-colors cursor-pointer ${er.length>0?"text-blue-600":"text-gray-500 hover:text-gray-700"}`,children:["Phân loại",(0,t.jsx)(a.HiChevronDown,{className:`w-4 h-4 transition-transform duration-200 ${Q?"rotate-180":""}`})]}),Q&&(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-64 bg-white rounded-lg shadow-xl border border-gray-100 py-2 z-50",children:[(0,t.jsx)("div",{className:"px-4 pb-2 text-xs text-gray-500",children:"Theo thẻ phân loại"}),(0,t.jsx)("div",{className:"max-h-64 overflow-auto",children:en.map(e=>{let r=er.includes(e.id);return(0,t.jsxs)("button",{onClick:()=>{es(t=>r?t.filter(t=>t!==e.id):[...t,e.id])},className:"w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 cursor-pointer",children:[(0,t.jsx)("span",{className:`inline-block w-3.5 h-3.5 rounded-sm ${e.color} border border-white shadow-sm`}),(0,t.jsx)("span",{className:"flex-1 text-left text-sm text-gray-800",children:e.label}),(0,t.jsx)("input",{type:"checkbox",checked:r,readOnly:!0,className:"w-4 h-4"})]},e.id)})}),(0,t.jsx)("div",{className:"border-t mt-2 pt-2",children:(0,t.jsx)("button",{onClick:()=>{et(!0),Y(!1)},className:"w-full p-1  text-sm text-[#0068ff] hover:bg-gray-50 cursor-pointer",children:"Quản lý thẻ phân loại"})})]})]})]})]})]}),v&&(0,t.jsxs)("div",{className:"flex items-center justify-around px-2 py-3 bg-white border-b border-gray-200 md:hidden",children:[(0,t.jsxs)("button",{onClick:()=>J({isOpen:!0,title:"Lịch nhóm",desc:"Tính năng Lịch nhóm đang được phát triển để giúp bạn quản lý thời gian hiệu quả hơn."}),className:`flex flex-col items-center justify-center gap-1 p-2 rounded-xl transition-all duration-200 flex-1 mx-1 ${"calendar"===j?"bg-blue-50 text-blue-600 shadow-sm":"text-gray-500 hover:bg-gray-50 hover:text-gray-700"}`,children:[(0,t.jsx)(a.HiCalendarDays,{className:"w-6 h-6"}),(0,t.jsx)("span",{className:"text-[10px] font-medium leading-none",children:"Lịch"})]}),(0,t.jsxs)("button",{onClick:()=>J({isOpen:!0,title:"Nhắc hẹn",desc:"Tính năng Nhắc hẹn sẽ sớm ra mắt để bạn không bỏ lỡ bất kỳ sự kiện quan trọng nào."}),className:`flex flex-col items-center justify-center gap-1 p-2 rounded-xl transition-all duration-200 flex-1 mx-1 ${"reminder"===j?"bg-blue-50 text-blue-600 shadow-sm":"text-gray-500 hover:bg-gray-50 hover:text-gray-700"}`,children:[(0,t.jsx)(a.HiClock,{className:"w-6 h-6"}),(0,t.jsx)("span",{className:"text-[10px] font-medium leading-none",children:"Nhắc hẹn"})]}),(0,t.jsxs)("button",{onClick:()=>J({isOpen:!0,title:"Nhóm Offline",desc:"Tính năng Nhóm Offline đang được xây dựng để kết nối mọi người dễ dàng hơn."}),className:`flex flex-col items-center justify-center gap-1 p-2 rounded-xl transition-all duration-200 flex-1 mx-1 ${"offline"===j?"bg-blue-50 text-blue-600 shadow-sm":"text-gray-500 hover:bg-gray-50 hover:text-gray-700"}`,children:[(0,t.jsx)(a.HiUserGroup,{className:"w-6 h-6"}),(0,t.jsx)("span",{className:"text-[10px] font-medium leading-none",children:"Nhóm Offline"})]})]}),(0,t.jsx)("div",{className:"flex-1 overflow-x-hidden overflow-y-auto bg-gradient-to-b from-white/80 to-gray-50/80 custom-scrollbar",children:ej?(0,t.jsx)(x,{activeTab:k,setActiveTab:_,isSearching:E,hasResults:ew,contacts:M.contacts,groupedMessages:ey,groupedFiles:ev,fileMessages:eb,searchTerm:o,onSelectContact:e=>{u(e),c(""),A({contacts:[],messages:[]})},onNavigateToMessage:e=>{g(e,o)},currentUserId:String(S),onOpenRoomResults:(e,t,r,s)=>q({roomId:e,roomName:t,isGroupChat:r,roomAvatar:s})}):(0,t.jsx)(t.Fragment,{children:0===ek.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-8 text-gray-400",children:[(0,t.jsx)("div",{className:"p-8 bg-gray-100 rounded-full mb-6",children:(0,t.jsx)(a.HiChatBubbleLeftRight,{className:"w-16 h-16 text-gray-300"})}),(0,t.jsxs)("p",{className:"text-lg font-medium text-gray-500",children:["unread"===R&&"Không có tin nhắn chưa đọc","read"===R&&"Không có tin nhắn đã đọc","hidden"===R&&"Không có cuộc trò chuyện ẩn","all"===R&&"Bắt đầu một cuộc trò chuyện mới!"]}),"all"===R&&(0,t.jsx)("p",{className:"text-sm mt-2 text-gray-400",children:"Nhấn vào nút tạo nhóm để bắt đầu"})]}):(0,t.jsx)("div",{className:`space-y-1 pb-20 ${y}`,children:ek.map(e=>{let r=!0===e.isGroup||Array.isArray(e.members);return(0,t.jsx)(l,{item:e,isGroup:r,selectedChat:m,onSelectChat:u,onChatAction:h,currentUserId:String(S),categoryTags:en,userTags:eu,onOpenTagManager:()=>el(!0)},e._id)})})})}),(0,t.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-gray-100 to-transparent pointer-events-none"}),K&&(0,t.jsx)(C,{isOpen:!!K,roomId:K.roomId,roomName:K.roomName,roomAvatar:K.roomAvatar,isGroupChat:K.isGroupChat,keyword:o,allUsers:n,anchorToParent:!0,onClose:()=>q(null),onNavigateToMessage:(e,t)=>{g(e,t),q(null)}}),X.isOpen&&(0,t.jsx)(T,{isOpen:X.isOpen,onClose:()=>J({...X,isOpen:!1}),title:X.title,description:X.desc}),ee&&(0,t.jsx)($,{isOpen:ee,onClose:()=>et(!1),currentUserId:String(S),currentUser:e,groups:s,allUsers:n}),ea&&(0,t.jsx)(L,{isOpen:ea,onClose:()=>el(!1),currentUserId:String(S),currentUser:e,groups:s,allUsers:n})]})}},22597,69848,20608,20978,e=>{"use strict";var t=e.i(43476),r=e.i(71645),s=e.i(74715),n=e.i(96085),i=e.i(50719),a=e.i(57688),l=e.i(74080),o=e.i(18566),c=e.i(40141);function d(e){return(0,c.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"},child:[]}]})(e)}function m(e){return(0,c.GenIcon)({tag:"svg",attr:{viewBox:"0 0 640 512"},child:[{tag:"path",attr:{d:"M528 448H112c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h416c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zm64-320c-26.5 0-48 21.5-48 48 0 7.1 1.6 13.7 4.4 19.8L476 239.2c-15.4 9.2-35.3 4-44.2-11.6L350.3 85C361 76.2 368 63 368 48c0-26.5-21.5-48-48-48s-48 21.5-48 48c0 15 7 28.2 17.7 37l-81.5 142.6c-8.9 15.6-28.9 20.8-44.2 11.6l-72.3-43.4c2.7-6 4.4-12.7 4.4-19.8 0-26.5-21.5-48-48-48S0 149.5 0 176s21.5 48 48 48c2.6 0 5.2-.4 7.7-.8L128 416h384l72.3-192.8c2.5.4 5.1.8 7.7.8 26.5 0 48-21.5 48-48s-21.5-48-48-48z"},child:[]}]})(e)}function u(e){return(0,c.GenIcon)({tag:"svg",attr:{viewBox:"0 0 640 512"},child:[{tag:"path",attr:{d:"M622.3 271.1l-115.2-45c-4.1-1.6-12.6-3.7-22.2 0l-115.2 45c-10.7 4.2-17.7 14-17.7 24.9 0 111.6 68.7 188.8 132.9 213.9 9.6 3.7 18 1.6 22.2 0C558.4 489.9 640 420.5 640 296c0-10.9-7-20.7-17.7-24.9zM496 462.4V273.3l95.5 37.3c-5.6 87.1-60.9 135.4-95.5 151.8zM224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm96 40c0-2.5.8-4.8 1.1-7.2-2.5-.1-4.9-.8-7.5-.8h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c6.8 0 13.3-1.5 19.2-4-54-42.9-99.2-116.7-99.2-212z"},child:[]}]})(e)}var h=e.i(37963),x=e.i(14674);function g({currentUser:e,allUsers:l,onClose:o,onGroupCreated:c,mode:m="create",conversationId:u,existingMemberIds:g=[],reLoad:p,onMembersAdded:f}){let{groupName:b,setGroupName:y,searchTerm:v,setSearchTerm:w,selectedMembers:j,loading:N,error:S,groupedUsers:k,sortedGroupKeys:C,handleMemberToggle:_,handleSubmit:T,avatarPreview:M,handleAvatarChange:A}=function({currentUser:e,allUsers:t,mode:s,conversationId:i,existingMemberIds:a=[],reLoad:l,onMembersAdded:o,onGroupCreated:c,onClose:d}){let[m,u]=(0,r.useState)(""),[x,g]=(0,r.useState)(""),[p,f]=(0,r.useState)(null),[b,y]=(0,r.useState)(null),[v,w]=(0,r.useState)(()=>{let t=String(e._id);return Array.from(new Set([...a.map(String),t]))}),[j,N]=(0,r.useState)(!1),[S,k]=(0,r.useState)(""),C=(0,r.useMemo)(()=>{let e=t;if(x.trim()){let r=(0,h.normalizeNoAccent)(x);e=t.filter(e=>(0,h.normalizeNoAccent)(e.name||"").includes(r))}let r=[...e].sort((e,t)=>(e.name||"").localeCompare(t.name||"")),s={};return r.forEach(e=>{let t=(e.name?.charAt(0)||"#").toUpperCase(),r=/^[A-Z]$/.test(t)?t:"#";s[r]||(s[r]=[]),s[r].push(e)}),s},[t,x]),_=(0,r.useMemo)(()=>Object.keys(C).sort((e,t)=>"#"===e?1:"#"===t?-1:e.localeCompare(t)),[C]),T=async()=>{if("create"===s&&!m.trim())return void k("Vui lòng nhập tên nhóm");let r=v.filter(e=>!a.includes(e));if("add"===s&&0===r.length)return void k("Bạn chưa chọn thêm thành viên mới nào");if("create"===s&&v.length<3)return void k("Nhóm phải có ít nhất 3 thành viên (bao gồm bạn)");N(!0),k("");try{let u,x="";if("create"===s&&p){let t=`group_avatar_${Date.now()}`,r=new FormData;r.append("file",p),r.append("roomId","new_group"),r.append("sender",String(e._id)),r.append("type","image"),r.append("folderName","GroupAvatars");let s=await fetch(`/api/upload?uploadId=${t}`,{method:"POST",body:r}),n=await s.json();n.success&&n.link&&(x=n.link)}u="create"===s?{action:"createGroup",data:{name:m,members:v,createdBy:e._id,avatar:x||void 0}}:{action:"addMembers",conversationId:i,newMembers:r,_id:String(e._id)};let g=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}),f=await g.json();if(f.success){if(l?.(),"add"===s&&o){let s=t.filter(e=>r.includes(String(e._id)));o(s);try{let t=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),s=(a||[]).map(e=>({_id:String(e)})),l=r.map(t=>({_id:t,role:"MEMBER",joinedAt:Date.now(),addedBy:String(e._id)}));t.emit("group_members_updated",{conversationId:i,members:[...s,...l],action:"add"}),setTimeout(()=>t.disconnect(),500)}catch{}c()}else if("create"===s){let t=f.group;c(t);try{let r=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),s=String(t?._id||f?.groupId||""),i=t?.members||v,a=Array.isArray(i)?i.map(e=>"object"==typeof e&&e?._id?{_id:String(e._id)}:String(e)):[];r.emit("group_created",{roomId:s,members:a,sender:e._id,senderName:e.name,groupName:t?.name||m}),setTimeout(()=>r.disconnect(),500)}catch{}}d()}else k(f.error||"Thực hiện thất bại")}catch(e){console.error(e),k("Lỗi kết nối server")}finally{N(!1)}};return{groupName:m,setGroupName:u,searchTerm:x,setSearchTerm:g,selectedMembers:v,loading:j,error:S,groupedUsers:C,sortedGroupKeys:_,handleMemberToggle:e=>{"add"===s&&a.includes(e)||w(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},handleSubmit:T,avatarFile:p,avatarPreview:b,handleAvatarChange:e=>{let t=e.target.files?.[0];if(t){if(!t.type.startsWith("image/"))return void k("Vui lòng chọn file ảnh");f(t),y(URL.createObjectURL(t)),k("")}}}}({currentUser:e,allUsers:l,mode:m,conversationId:u,existingMemberIds:r.default.useMemo(()=>{if(g&&g.length>0)return g.map(String);try{let e=window.__createGroupInitialMemberIds;if(Array.isArray(e)&&e.length>0)return e.map(String)}catch{}return[]},[g]),reLoad:p,onMembersAdded:f,onGroupCreated:c,onClose:o}),[E,$]=r.default.useState(!1);r.default.useEffect(()=>{$(!1)},[M]),r.default.useEffect(()=>()=>{try{window.__createGroupInitialMemberIds=null}catch{}},[]);let I=r.default.useMemo(()=>l.filter(e=>j.includes(String(e._id))),[l,j]);return(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm sm:px-0",children:(0,t.jsxs)("div",{className:"sm:mx-[0.5rem] bg-white w-full h-full sm:w-full sm:max-w-2xl  sm:max-h-[90vh] sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 bg-white  border-b border-gray-100 sm:border-none",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 w-full",children:[(0,t.jsx)("button",{onClick:o,className:"sm:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors text-gray-800",children:(0,t.jsx)(x.HiChevronLeft,{className:"w-6 h-6"})}),(0,t.jsxs)("div",{className:"flex flex-col items-start justify-center flex-1 sm:flex-none",children:[(0,t.jsx)("h2",{className:"text-lg font-bold leading-tight",children:"create"===m?"Nhóm mới":"Thêm thành viên"}),(0,t.jsxs)("p",{className:"text-sm text-gray-500 font-medium sm:hidden",children:["Đã chọn: ",j.length]})]})]}),(0,t.jsx)("button",{onClick:o,className:"hidden sm:block p-2.5 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200 active:scale-90",children:(0,t.jsx)(i.HiX,{className:"w-4 h-4"})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 bg-gray-50",children:[(0,t.jsxs)("div",{className:"p-4 bg-white border-b border-gray-100",children:["create"===m&&(0,t.jsxs)("div",{className:"flex items-center gap-4 mb-2",children:[(0,t.jsx)("div",{className:"relative w-12 h-12 flex-shrink-0",children:(0,t.jsxs)("label",{className:"w-full h-full rounded-full bg-gray-100 flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors overflow-hidden border border-gray-200",title:"Đổi ảnh nhóm",children:[M&&!E?(0,t.jsx)(a.default,{src:M,alt:"Group Avatar",width:48,height:48,className:"w-full h-full object-cover",onError:()=>$(!0)}):(0,t.jsx)(x.HiCamera,{className:"w-6 h-6 text-gray-500"}),(0,t.jsx)("input",{type:"file",accept:"image/*",className:"hidden",onChange:A})]})}),(0,t.jsxs)("div",{className:"flex-1 relative border-b-2 focus-within:border-[#0068ff] border-gray-200 transition-colors pb-1",children:[(0,t.jsx)("input",{type:"text",value:b,onChange:e=>y(e.target.value),placeholder:"Đặt tên nhóm",className:"w-full py-2 bg-transparent focus:outline-none text-lg font-medium placeholder:text-gray-400 pr-8"}),(0,t.jsx)("button",{className:"absolute right-0 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:(0,t.jsx)(x.HiFaceSmile,{className:"w-6 h-6"})})]}),j.length>=3&&(0,t.jsx)("button",{onClick:T,disabled:N,className:"p-1 rounded-full hover:bg-blue-50 transition-colors",children:(0,t.jsx)(d,{className:"w-6 h-6 text-[#0068ff]"})})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(x.HiMagnifyingGlass,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 pointer-events-none"}),(0,t.jsx)("input",{type:"text",value:v,onChange:e=>w(e.target.value),placeholder:"Tìm tên...",className:"w-full pl-12 pr-4 py-2.5 bg-gray-100 rounded-xl focus:outline-none focus:bg-white focus:ring-1 focus:ring-[#0068ff] text-base placeholder:text-gray-500 transition-all duration-200"})]}),S&&(0,t.jsxs)("div",{className:"mt-4 p-4 bg-red-50 border border-red-200 rounded-2xl flex items-center gap-3",children:[(0,t.jsx)(i.HiXCircle,{className:"w-6 h-6 text-red-600 flex-shrink-0"}),(0,t.jsx)("span",{className:"text-sm font-medium text-red-700",children:S})]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 custom-scrollbar",children:[(0,t.jsxs)("h4",{className:"hidden  font-semibold text-sm text-gray-600 mb-3 md:flex items-center",children:["create"===m?"Danh sách bạn bè":"Thành viên có thể thêm",(0,t.jsx)("span",{className:"ml-2 bg-blue-100 text-blue-700 py-0.5 px-2 rounded-full text-xs",children:j.length})]}),C.map(r=>(0,t.jsx)("div",{className:"mb-2",children:k[r].map(r=>{let n=String(r._id),i=g.includes(n),l=j.includes(n),o=n===String(e._id),c=String(r.nicknames?.[String(e._id)]||"").trim()||String(r.name||r.username||"Người dùng").trim();return(0,t.jsxs)("label",{className:`flex items-center p-3 mb-1 cursor-pointer transition-colors justify-between rounded-2xl
                          ${l?"bg-blue-50":"hover:bg-gray-50"} ${"add"===m&&i||o?"bg-gray-50 opacity-60 cursor-not-allowed":""}
                                                `,children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("div",{className:"sm:w-10 sm:h-10 w-10 h-10 mr-3 rounded-full overflow-hidden sm:ring-4 ring-2 ring-white shadow-md",children:r.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(r.avatar),alt:"",width:48,height:48,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:"",width:48,height:48,className:"w-full h-full object-cover"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)("p",{className:"sm:text-sm font-semibold text-gray-900 px-1",children:c})}),(0,t.jsx)("span",{className:`text-xs px-1 font-medium ${r.online?"text-green-600":"text-gray-500"}`,children:r.online?"Đang hoạt động":r.lastSeen?`Hoạt động ${(0,s.formatTimeAgo)(r.lastSeen)} trước`:"Hoạt động gần đây"}),i&&"add"===m&&(0,t.jsx)("span",{className:"text-xs text-gray-400 font-medium",children:"Đã tham gia"})]}),o&&(0,t.jsx)("span",{className:"text-xs text-gray-400 font-medium px-1",children:"Bạn"})]}),(0,t.jsxs)("div",{className:"relative flex items-center justify-center w-6 h-6 mr-3",children:[(0,t.jsx)("input",{type:"checkbox",checked:l,disabled:"add"===m&&i||o,onChange:()=>_(n),className:"peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-full checked:bg-[#0573ff] checked:border-[#0573ff] transition-all"}),(0,t.jsx)("svg",{className:"absolute w-3.5 h-3.5 text-white hidden peer-checked:block pointer-events-none",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:"3",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]})]},r._id)})},r)),0===C.length&&(0,t.jsx)("div",{className:"text-center py-10 opacity-50",children:(0,t.jsx)("p",{children:"Không tìm thấy kết quả"})})]})]}),(I.length>0||"create"===m)&&(0,t.jsx)("div",{className:"px-3 py-2 bg-white border-t border-gray-100",children:(0,t.jsxs)("div",{className:"flex gap-2 overflow-x-auto custom-scrollbar pb-1 pt-2",children:["create"===m&&(0,t.jsx)("div",{className:"relative flex-shrink-0 cursor-default opacity-100",children:(0,t.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden border-2 border-blue-500 shadow-sm",children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:e.name,width:40,height:40,className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-[#0068ff] to-[#00a0e9] text-white font-bold flex items-center justify-center text-lg",children:e.name?.charAt(0).toUpperCase()})})}),I.filter(t=>"create"!==m||String(t._id)!==String(e._id)).map(r=>(0,t.jsxs)("div",{className:"relative flex-shrink-0 cursor-pointer group",onClick:()=>_(String(r._id)),children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden border border-gray-200 shadow-sm transition-opacity",children:r.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(r.avatar),alt:String(r.nicknames?.[String(e._id)]||"").trim()||String(r.name||r.username||"Người dùng").trim(),width:40,height:40,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:"",width:48,height:48,className:"w-full h-full object-cover"})}),(0,t.jsx)("div",{className:"absolute -top-1 -right-1 bg-gray-100 rounded-full text-gray-500 ",children:(0,t.jsx)(i.HiXCircle,{className:"w-4 h-4"})})]},r._id))]})}),(0,t.jsxs)("div",{className:"p-3 bg-white border-t border-gray-200 flex gap-3",children:[(0,t.jsx)("button",{onClick:o,className:"flex-1 py-3 cursor-pointer text-base font-medium text-gray-600 bg-transparent hover:bg-gray-100 rounded-2xl transition-all duration-200 active:scale-95",children:"Hủy"}),(0,t.jsx)("button",{onClick:T,disabled:N||0===j.length,className:`flex-1 py-3 text-base font-bold text-white rounded-2xl cursor-pointer transition-all duration-300 active:scale-95 flex items-center justify-center gap-1.5 shadow-md
      ${N||0===j.length?"bg-gray-400 cursor-not-allowed":"bg-[#0068ff] hover:bg-[#005edc] shadow-[#0068ff]/50"}`,children:N?(0,t.jsx)(t.Fragment,{children:"Đang xử lý..."}):"create"===m?(0,t.jsxs)(t.Fragment,{children:["Tạo nhóm",j.length>0&&(0,t.jsxs)("span",{className:"ml-1 text-sm font-normal opacity-90",children:["(",j.length,")"]})]}):(0,t.jsxs)(t.Fragment,{children:["Thêm",j.filter(e=>!g.includes(e)).length>0&&(0,t.jsxs)("span",{className:"ml-1 text-sm font-normal opacity-90",children:["(",j.filter(e=>!g.includes(e)).length,")"]})]})})]})]})})}e.s(["default",()=>g],69848);var p=e.i(74842),f=e.i(10880);function b({role:e,className:r="",showIcon:s=!0}){return"OWNER"===e?(0,t.jsxs)("span",{className:`px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-bold bg-gradient-to-r from-yellow-400 to-orange-500 text-white shadow-sm flex items-center gap-1 ${r}`,children:[s&&(0,t.jsx)(m,{className:"w-3 h-3"}),"Trưởng nhóm"]}):"ADMIN"===e?(0,t.jsxs)("span",{className:`px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-bold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-sm flex items-center gap-1 ${r}`,children:[s&&(0,t.jsx)(u,{className:"w-3 h-3"}),"Phó nhóm"]}):null}function y(e){if(!e)return"";if("string"==typeof e)return e;if("number"==typeof e)return String(e);if("object"==typeof e&&null!==e){if("_id"in e)return y(e._id);if("id"in e)return y(e.id)}return String(e)}function v(e,t){let r=y(e),s=y(t);if(r===s)return!0;let n=Number(r),i=Number(s);return!(isNaN(n)||isNaN(i))&&n===i}function w({members:e,onClose:s,isOpen:c,groupName:d,currentUser:m,allUsers:u,conversationId:w,reLoad:j,onMembersAdded:N,onMemberRemoved:S,onRoleChange:k,sendNotifyMessage:C,lastUpdated:_}){let T=window.matchMedia("(min-width: 768px)").matches,[M,A]=(0,r.useState)(!1),[E,$]=(0,r.useState)(""),[I,L]=(0,r.useState)([]),[P,H]=(0,r.useState)(null),[U,R]=(0,r.useState)(null),[D,O]=(0,r.useState)("all"),[B,F]=(0,r.useState)(!1),[z,V]=(0,r.useState)(null),G=(0,p.useToast)(),W=(0,o.useRouter)(),X=r.default.useMemo(()=>{let e=new Map;if(m){let t=y(m._id||m.id);t&&(e.set(t,m),isNaN(Number(t))||e.set(String(Number(t)),m))}return u.forEach(t=>{let r=y(t._id||t.id);r&&(e.set(r,t),isNaN(Number(r))||e.set(String(Number(r)),t))}),e},[m,u]);if((0,r.useEffect)(()=>{let t=(e||[]).map(e=>{let t=y(e._id??e.id);if(console.log(`[ModalMembers] Process member ${t}:`,{name:e.name,role:e.role,addedBy:e.addedBy,rawObject:e}),!t)return console.warn("⚠️ Member without ID:",e),null;let r=e.role??"MEMBER",s="number"==typeof e.joinedAt?e.joinedAt:Date.now(),n=X.get(t);n||isNaN(Number(t))||(n=X.get(String(Number(t))));let i=y(m._id||m.id),a=e.name||n?.name||"Thành viên";return{_id:t,name:e.nickname||n?.nicknames?.[i]||a,avatar:e.avatar||n?.avatar,role:r,joinedAt:s,addedBy:e.addedBy,originalName:a}}).filter(Boolean),r=new Map;t.forEach(e=>{let t=y(e._id||e.id);r.has(t)||r.set(t,e)}),L(Array.from(r.values()))},[e,u,X,m,w,_]),!c)return null;let J=y(m._id||m.id),K=I.find(e=>v(e._id||e.id,J)),q=K?.role||"MEMBER",Q=async(e,t)=>{if(!w)return;H(t);let r=I.find(e=>v(e._id||e.id,t)),s=r?r.name:"Thành viên";try{let r=[...I];if((await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify("kick"===e?{conversationId:w,targetUserId:t,action:"kickMember",_id:J}:{conversationId:w,targetUserId:t,action:"changeRole",data:{role:"promote"===e?"ADMIN":"MEMBER"},_id:J})})).ok){if("kick"===e){L(e=>e.filter(e=>!v(e._id||e.id,t))),S&&S(t,s);try{let e=String(w||""),s=r.filter(e=>!v(e._id||e.id,t)).map(e=>({_id:String(e._id||e.id||""),role:e.role,name:e.name,avatar:e.avatar})),i=r.map(e=>({_id:String(e._id||e.id||"")})),a=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});a.emit("group_members_updated",{roomId:e,members:s,prevMembers:i,sender:J,senderName:m.name,groupName:d}),setTimeout(()=>a.disconnect(),500)}catch{}}else if("promote"===e||"demote"===e){let r="promote"===e?"ADMIN":"MEMBER";L(e=>e.map(e=>v(e._id||e.id,t)?{...e,role:r}:e)),k?.(t,s,r)}j?.()}else G({type:"error",message:"Thao tác thất bại",duration:3e3})}catch{G({type:"error",message:"Lỗi mạng, vui lòng thử lại",duration:3e3})}finally{H(null)}},Y=I.filter(e=>(0,h.accentAwareIncludes)(e.name||"",E)).filter(e=>"all"===D||("admin"===D?"OWNER"===e.role||"ADMIN"===e.role:"invited"!==D&&"blocked"!==D)),Z=I.map(e=>y(e._id||e.id)),ee=async(e,t)=>{if(w)try{if(!(await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateMemberNickname",conversationId:w,targetUserId:e,data:{nickname:t}})})).ok)throw Error("Failed to update nickname");let r=String(t||"").trim();L(t=>t.map(t=>{if(v(t._id||t.id,e)){let s=X.get(y(e))||X.get(String(Number(e))),n=s?.nicknames?.[J],i=t.originalName||s?.name||t.name,a=r||n||i;return{...t,name:a||"Thành viên",nickname:r}}return t}));try{let t=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});t.emit("room_nickname_updated",{roomId:w,targetUserId:e,nickname:r}),setTimeout(()=>t.disconnect(),500)}catch{}if(j?.(),C){let t=m.name||"Một thành viên",s=I.find(t=>v(t._id||t.id,e)),n=X.get(y(e))||X.get(String(Number(e))),i=n?.name||s?.name||"Thành viên",a="";a=r?`${t} đ\xe3 đặt biệt danh cho ${i} l\xe0 "${r}".`:`${t} đ\xe3 x\xf3a biệt danh của ${i}.`,C(a)}}catch{G({type:"error",message:"Cập nhật biệt danh thất bại",duration:3e3})}},et=(0,t.jsxs)("div",{className:`${T?"absolute inset-0":"fixed inset-0"} z-50 flex items-stretch justify-center ${T?"bg-black/20":"bg-black/40"} backdrop-blur-sm sm:px-0`,children:[(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none overflow-hidden flex flex-col",children:[(0,t.jsxs)("div",{className:"flex-none bg-blue-400 text-white",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:s,className:"p-2 rounded-full cursor-pointer hover:bg-white/20 active:scale-95",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,t.jsx)("h2",{className:"text-lg font-bold",children:"Thành viên"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>A(!0),className:"p-2 rounded-full cursor-pointer hover:bg-white/20 active:scale-95",title:"Thêm thành viên",children:(0,t.jsx)(x.HiUserPlus,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:()=>F(e=>!e),className:"p-2 rounded-full cursor-pointer hover:bg-white/20 active:scale-95",title:"Tìm kiếm",children:(0,t.jsx)(i.HiSearch,{className:"w-6 h-6"})})]})]}),B&&(0,t.jsx)("div",{className:"px-4 pb-3",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(i.HiSearch,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white/90 focus:outline-none focus:bg-white focus:text-gray-900 transition-all"}),(0,t.jsx)("input",{type:"text",value:E,onChange:e=>$(e.target.value),placeholder:"Tìm kiếm thành viên",className:"w-full pl-10 pr-4 py-2.5 rounded-xl bg-white/15 text-white  focus:outline-none focus:bg-white focus:text-gray-900 transition-all"})]})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-h-0  bg-white sm:bg-gray-50",children:[(0,t.jsxs)("div",{className:"flex items-center gap-6 px-4 border-b border-gray-200 overflow-x-auto custom-scrollbar",children:[(0,t.jsx)("button",{onClick:()=>O("all"),className:`cursor-pointer py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap shrink-0 ${"all"===D?"border-gray-900 text-gray-900":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Tất cả"}),(0,t.jsx)("button",{onClick:()=>O("admin"),className:`cursor-pointer py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap shrink-0 ${"admin"===D?"border-gray-900 text-gray-900":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Trưởng và phó nhóm"}),(0,t.jsx)("button",{onClick:()=>O("invited"),className:`cursor-pointer py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap shrink-0 ${"invited"===D?"border-gray-900 text-gray-900":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Đã mời"}),(0,t.jsx)("button",{onClick:()=>O("blocked"),className:`cursor-pointer py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap shrink-0 ${"blocked"===D?"border-gray-900 text-gray-900":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Đã chặn"})]}),U&&(0,t.jsx)("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden",children:[(0,t.jsxs)("div",{className:"p-5 border-b border-gray-100 flex justify-between items-center",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Đặt biệt danh"}),(0,t.jsx)("button",{onClick:()=>R(null),className:"p-2 hover:bg-gray-100 rounded-full",children:(0,t.jsx)(i.HiX,{className:"w-6 h-6 text-gray-500"})})]}),(0,t.jsxs)("div",{className:"p-6 space-y-5",children:[(0,t.jsxs)("p",{className:"text-base text-gray-600",children:["Đặt biệt danh cho ",(0,t.jsx)("b",{children:U.name})," trong nhóm này."]}),(0,t.jsx)("input",{type:"text",autoFocus:!0,defaultValue:U.currentVal||U.name,className:"w-full px-4 py-3 border border-gray-300 rounded-2xl text-base focus:outline-none focus:border-[#0088ff] focus:ring-2 focus:ring-[#0088ff]/30",placeholder:"Nhập biệt danh...",onKeyDown:e=>{"Enter"===e.key&&(ee(U.id,e.currentTarget.value),R(null))},id:"nickname-input"}),(0,t.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,t.jsx)("button",{onClick:()=>R(null),className:"px-6 py-3 text-gray-600 font-medium rounded-2xl hover:bg-gray-100",children:"Hủy"}),(0,t.jsx)("button",{onClick:()=>{let e=document.getElementById("nickname-input")?.value;ee(U.id,e),R(null)},className:"px-6 py-3 bg-[#0088ff] text-white font-medium rounded-2xl hover:bg-[#0070d9] transition-colors",children:"Lưu"})]})]})]})}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-4 custom-scrollbar",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold text-gray-500 uppercase tracking-wide",children:"Danh sách thành viên"}),(0,t.jsx)("span",{className:"text-xl font-bold text-[#0088ff]",children:Y.length})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[Y.map(e=>{let r,s=y(e._id||e.id),n=e.role,i=v(s,J),l=P===s;return(0,t.jsxs)("div",{className:`flex items-center justify-between gap-4 py-3 px-3 rounded-2xl hover:bg-gray-50 transition-colors relative group ${l?"opacity-60":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-full overflow-hidden flex-shrink-0 cursor-pointer",onClick:()=>{let e;return e=y(s),void W.push(`/profile/${e}`)},children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:e.name,width:48,height:48,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:e.name,width:48,height:48,className:"w-full h-full object-cover"})}),(0,t.jsxs)("div",{className:" min-w-0 space-y-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("p",{className:"text-base font-medium text-gray-900",children:e.name}),i&&(0,t.jsx)("span",{className:"px-2.5  py-1 bg-[#0088ff]/10 text-[#0088ff] rounded-full text-xs font-medium",children:"Bạn"})]}),(0,t.jsx)("div",{className:" gap-3 flex ",children:(0,t.jsx)(b,{role:e.role})}),e.addedBy&&(0,t.jsx)("div",{className:"text-xs text-gray-500",children:v(e.addedBy,J)?"Thêm bởi bạn":(0,t.jsxs)(t.Fragment,{children:["Thêm bởi ",(0,t.jsx)("span",{className:"font-medium",children:((r=X.get(y(e.addedBy)))||console.warn("[ModalMembers] Unknown adder:",e.addedBy),r?.name||"Người dùng")})]})})]})]}),!l&&(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{onClick:()=>V(z===s?null:s),className:"p-2 rounded-full cursor-pointer hover:bg-gray-200 active:scale-95",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5 text-gray-700"})}),z===s&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-10",onClick:()=>V(null)}),(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-56 bg-white rounded-xl shadow-xl border border-gray-200 z-20 overflow-hidden",children:[(0,t.jsx)("button",{onClick:()=>{let t=String(e.nickname||"");R({id:s,name:e.name,currentVal:t}),V(null)},className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50",children:"Đặt biệt danh"}),!i&&"OWNER"===q&&"MEMBER"===n&&(0,t.jsx)("button",{onClick:()=>{(0,f.confirmAlert)({title:"Bổ nhiệm làm Phó nhóm",message:`Bổ nhiệm ${e.name} l\xe0m Ph\xf3 nh\xf3m?`,okText:"Bổ nhiệm",onOk:()=>Q("promote",s)}),V(null)},className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50",children:"Bổ nhiệm làm Phó nhóm"}),!i&&"OWNER"===q&&"ADMIN"===n&&(0,t.jsx)("button",{onClick:()=>{(0,f.confirmAlert)({title:"Hủy quyền Phó nhóm",message:`Hủy quyền Ph\xf3 nh\xf3m ${e.name}?`,okText:"Có",onOk:()=>Q("demote",s)}),V(null)},className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50",children:"Bãi nhiệm"}),!i&&("OWNER"===q||"ADMIN"===q&&"MEMBER"===n)&&(0,t.jsx)("button",{onClick:()=>{(0,f.confirmAlert)({title:"Xóa thành viên",message:`X\xf3a ${e.name} khỏi nh\xf3m?`,okText:"Xóa",onOk:()=>Q("kick",s)}),V(null)},className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50 text-red-600",children:"Xóa khỏi nhóm"})]})]})]}),l&&(0,t.jsx)("div",{className:"absolute inset-0 bg-white/70 rounded-2xl flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-8 h-8 border-4 border-[#0088ff] border-t-transparent rounded-full animate-spin"})})]},s)}),0===Y.length&&(0,t.jsxs)("div",{className:"text-center py-20 text-gray-400",children:[(0,t.jsx)(i.HiSearch,{className:"w-20 h-20 mx-auto mb-6 opacity-30"}),(0,t.jsx)("p",{className:"text-lg font-medium",children:"Không tìm thấy thành viên"})]})]})]})]})]}),M&&(0,t.jsx)(g,{mode:"add",conversationId:w,existingMemberIds:Z,currentUser:m,allUsers:u,onClose:()=>A(!1),reLoad:j,onMembersAdded:e=>{let t=e.map(e=>({_id:y(e._id??e.id),name:e.name,avatar:e.avatar,role:"MEMBER",joinedAt:Date.now(),addedBy:J}));L(e=>[...e,...t]),A(!1),N(e)},onGroupCreated:()=>A(!1)})]}),er=T&&"undefined"!=typeof document?document.getElementById("right-sidebar-container"):null;return T&&er?(0,l.createPortal)(et,er):et}var j=e.i(84828),N=e.i(95884),S=e.i(69620);function k({mediaUrl:e,mediaType:s="image",chatName:n,onClose:l,onSend:o}){let[c,d]=(0,r.useState)(""),[m,u]=(0,r.useState)(!1),[x,g]=(0,r.useState)(!1),[p,f]=(0,r.useState)(e),[b,y]=(0,r.useState)(null),[v,w]=(0,r.useState)(!1),[k,C]=(0,r.useState)(1),[_,T]=(0,r.useState)(0),[M,A]=(0,r.useState)(!1),[E,$]=(0,r.useState)("#ff3b30"),[I,L]=(0,r.useState)(6),[P,H]=(0,r.useState)(!1),[U,R]=(0,r.useState)([]),[D,O]=(0,r.useState)(!0),B=(0,r.useRef)(null),F=(0,r.useRef)(null),z=(0,r.useRef)(null),V=(0,r.useRef)(null),[G,W]=(0,r.useState)(null),[X,J]=(0,r.useState)(null),[K,q]=(0,r.useState)(!1),[Q,Y]=(0,r.useState)(""),[Z,ee]=(0,r.useState)("#ffffff"),[et,er]=(0,r.useState)(20),[es,en]=(0,r.useState)([]),[ei,ea]=(0,r.useState)(null),[el,eo]=(0,r.useState)({x:0,y:0}),[ec,ed]=(0,r.useState)(null),[em,eu]=(0,r.useState)({width:0,height:0}),eh=(0,r.useRef)(null),[ex,eg]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!F.current)return;let e=()=>{F.current&&eu({width:F.current.clientWidth,height:F.current.clientHeight})},t=new ResizeObserver(e);return t.observe(F.current),e(),()=>t.disconnect()},[]);let ep=(0,r.useCallback)(async()=>{let e=e=>{try{let t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;let r=t.getContext("2d");if(!r)return null;return r.drawImage(e,0,0,t.width,t.height),t.toDataURL("image/jpeg",.92)}catch(e){return console.warn("Failed to capture video frame (likely CORS):",e),null}};if(z.current&&z.current.videoWidth&&z.current.videoHeight){let t=e(z.current);if(t)return t}try{let t=document.createElement("video");return t.crossOrigin="anonymous",t.muted=!0,t.playsInline=!0,await new Promise((e,r)=>{t.addEventListener("loadeddata",()=>e(),{once:!0}),t.addEventListener("error",r,{once:!0}),t.src=(0,h.getProxyUrl)(p),t.load()}),0===t.currentTime&&(t.currentTime=.1,await new Promise(e=>t.addEventListener("seeked",e,{once:!0}))),e(t)}catch(e){return console.error("Failed to generate video poster fallback:",e),null}},[p]),ef=(0,r.useCallback)(()=>{let e=B.current,t=F.current;if(!e||!t)return;let r=t.clientWidth,s=t.clientHeight;e.width!==r&&(e.width=r),e.height!==s&&(e.height=s)},[]),eb=(0,r.useCallback)((e,t,r,s)=>{let n=r/s;if(n>e/t){let r=e/n,s=Math.round(r);J({x:0,y:Math.round((t-r)/2),width:Math.round(e),height:s})}else{let r=t*n,s=Math.round(r);J({x:Math.round((e-r)/2),y:0,width:s,height:Math.round(t)})}},[]);(0,r.useEffect)(()=>{if(!v)return;let e=V.current;if(!e)return;let t=e.getState();t&&e.setState({...t,transforms:{...t.transforms||{},rotate:_}})},[k,_,v]),(0,r.useEffect)(()=>{let e=F.current;if(e&&"image"===s){let t=new window.Image;t.onload=()=>eb(e.clientWidth,e.clientHeight,t.naturalWidth||t.width,t.naturalHeight||t.height),t.src=(0,h.getProxyUrl)(p)}},[eb,p,s]),(0,r.useEffect)(()=>{let e=F.current,t=z.current;e&&t&&"video"===s&&t.videoWidth&&t.videoHeight&&eb(e.clientWidth,e.clientHeight,t.videoWidth,t.videoHeight)},[eb,s]),(0,r.useEffect)(()=>{if("video"!==s||!b||!b.croppedAreaPixels)return;let{width:e,height:t}=em;if(e<=0||t<=0)return;let{width:r,height:n}=b.croppedAreaPixels;if(0===(b.rotation||0)){let s=Math.min(e/r,t/n),i=Math.round(r*s),a=Math.round(n*s);J({x:Math.round((e-i)/2),y:Math.round((t-a)/2),width:i,height:a})}else J({x:0,y:0,width:e,height:t})},[s,b,em]);let ey=(0,r.useCallback)((e,t)=>{if(t.points.length<2){let r=t.points[0];if(!r)return;e.beginPath(),e.arc(r.x,r.y,t.size/2,0,2*Math.PI),e.fillStyle=t.color,e.fill();return}e.strokeStyle=t.color,e.lineWidth=t.size,e.lineJoin="round",e.lineCap="round",e.beginPath();let[r,...s]=t.points;for(let t of(e.moveTo(r.x,r.y),s))e.lineTo(t.x,t.y);e.stroke()},[]),ev=(0,r.useCallback)(()=>{let e=B.current;if(!e)return;let t=e.getContext("2d");if(t){for(let r of(t.clearRect(0,0,e.width,e.height),X&&D&&(t.save(),t.beginPath(),t.rect(X.x,X.y,X.width,X.height),t.clip()),U))ey(t,r);X&&D&&t.restore()}},[U,ey,X,D]),[ew,ej]=(0,r.useState)(null);(0,r.useEffect)(()=>{ef(),ev()},[ef,ev,M]),(0,r.useEffect)(()=>{let e=()=>{ef(),ev()};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[ef,ev]);let eN=e=>{let t=B.current;if(!t)return{x:0,y:0};let r=t.getBoundingClientRect();if("touches"in e&&e.touches.length){let t=e.touches[0];return{x:t.clientX-r.left,y:t.clientY-r.top}}return{x:e.clientX-r.left,y:e.clientY-r.top}},eS=e=>{if(!M)return;ef(),H(!0);let t=eN(e);if(X&&D){let e=t.x<X.x||t.x>X.x+X.width,r=t.y<X.y||t.y>X.y+X.height;if(e||r)return}let r=t;X&&D&&(r={x:Math.min(Math.max(t.x,X.x),X.x+X.width),y:Math.min(Math.max(t.y,X.y),X.y+X.height)}),R(e=>[...e,{color:E,size:I,points:[r]}])},ek=e=>{if(!M||!P)return;let t=eN(e),r=t;X&&D&&(r={x:Math.min(Math.max(t.x,X.x),X.x+X.width),y:Math.min(Math.max(t.y,X.y),X.y+X.height)}),R(e=>{if(!e.length)return e;let t=e[e.length-1],s={...t,points:[...t.points,r]};return[...e.slice(0,-1),s]}),ev()},eC=()=>{M&&H(!1)},e_=async()=>{try{if(!V.current)return;if("image"===s){let e=V.current.getCanvas();if(e){let t=e.toDataURL("image/jpeg",.92);f(t),w(!1),T(0),C(1)}}else{let e=V.current.getState(),t=V.current.getCoordinates();if(e&&t){let r=F.current?.clientWidth||t.width,s=F.current?.clientHeight||t.height;y({crop:{x:t.left,y:t.top},zoom:1,rotation:e.transforms.rotate||0,croppedAreaPixels:{x:t.left,y:t.top,width:t.width,height:t.height},baseWidth:r,baseHeight:s}),w(!1)}}}catch(e){console.error(e)}},eT=async()=>{try{let e=F.current,t=B.current;if(!e||!t||0===U.length||"video"===s)return void A(!1);let r=await new Promise((e,t)=>{let r=new window.Image;r.crossOrigin="anonymous",r.onload=()=>e(r),r.onerror=t,r.src=(0,h.getProxyUrl)(p)}),n=e.clientWidth,i=e.clientHeight,a=document.createElement("canvas");a.width=n,a.height=i;let l=a.getContext("2d"),o=r.width/r.height,c=n/i;if(o>c){let e=n/o,t=(i-e)/2;l.drawImage(r,0,t,n,e)}else{let e=i*o,t=(n-e)/2;l.drawImage(r,t,0,e,i)}let d=t.getContext("2d").getImageData(0,0,t.width,t.height),m=document.createElement("canvas");m.width=t.width,m.height=t.height,m.getContext("2d").putImageData(d,0,0),l.drawImage(m,0,0,n,i);let u=a.toDataURL("image/jpeg",.92);f(u),A(!1),R([]);let x=t.getContext("2d");x&&x.clearRect(0,0,t.width,t.height)}catch(e){A(!1)}},eM=async()=>{try{let e=F.current;if(!e||"video"===s||0===es.length)return;let t=await new Promise((e,t)=>{let r=new window.Image;r.crossOrigin="anonymous",r.onload=()=>e(r),r.onerror=t,r.src=(0,h.getProxyUrl)(p)}),r=e.clientWidth,n=e.clientHeight,i=t.width/t.height,a=r/n,l=(()=>{if(i>a){let e=r/i;return{dx:0,dy:(n-e)/2,dw:r,dh:e}}{let e=n*i;return{dx:(r-e)/2,dy:0,dw:e,dh:n}}})(),o=document.createElement("canvas");o.width=t.width,o.height=t.height;let c=o.getContext("2d");c.drawImage(t,0,0,o.width,o.height);let d=B.current;if(d){let e=o.width/l.dw;for(let t of(c.drawImage(d,l.dx,l.dy,l.dw,l.dh,0,0,o.width,o.height),c.textAlign="center",c.textBaseline="middle",es)){let r=(t.x-l.dx)*e,s=(t.y-l.dy)*e,n=t.size*e;c.fillStyle=t.color,c.font=`${n}px sans-serif`,c.fillText(t.text,r,s)}}let m=o.toDataURL("image/jpeg",.92);f(m),en([]),ed(null)}catch{}};return(0,t.jsxs)("div",{className:"fixed inset-0 z-[10001] bg-black flex flex-col",children:[(0,t.jsx)("div",{className:"px-4 py-4 flex items-center justify-between text-white bg-black border-b border-white/10",children:v?(0,t.jsxs)("div",{className:"flex items-center justify-between w-full pointer-events-auto",children:[(0,t.jsx)("button",{onClick:()=>w(!1),className:"cursor-pointer p-2 -ml-2",children:(0,t.jsx)(i.HiX,{className:"w-8 h-8"})}),(0,t.jsx)("div",{className:"text-lg font-semibold",children:"Cắt ảnh"}),(0,t.jsx)("button",{onClick:e_,className:"p-2 -mr-2 text-blue-400",children:(0,t.jsx)(i.HiCheck,{className:"w-8 h-8"})})]}):M?(0,t.jsxs)("div",{className:"flex items-center justify-between w-full pointer-events-auto",children:[(0,t.jsx)("button",{onClick:()=>{A(!1),R([]);let e=B.current,t=e?.getContext("2d");e&&t&&t.clearRect(0,0,e.width,e.height)},className:"cursor-pointer p-2 -ml-2",children:(0,t.jsx)(i.HiX,{className:"w-8 h-8"})}),(0,t.jsx)("div",{className:"text-lg font-semibold",children:"Vẽ"}),(0,t.jsx)("button",{onClick:eT,className:"cursor-pointer p-2 -mr-2 text-blue-400",children:(0,t.jsx)(i.HiCheck,{className:"w-8 h-8"})})]}):K?(0,t.jsxs)("div",{className:"flex items-center justify-between w-full pointer-events-auto",children:[(0,t.jsx)("button",{onClick:()=>{q(!1),Y("")},className:"cursor-pointer p-2 -ml-2",children:(0,t.jsx)(i.HiX,{className:"w-8 h-8"})}),(0,t.jsx)("div",{className:"text-lg font-semibold",children:"Văn bản"}),(0,t.jsx)("button",{onClick:()=>{if(!F.current||!Q.trim()||!X){q(!1),Y("");return}let e=Math.random().toString(36).slice(2);en(t=>[...t,{id:e,text:Q.trim(),x:Math.round(X.x+X.width/2),y:Math.round(X.y+X.height/2),color:Z,size:et}]),q(!1),Y("")},className:"cursor-pointer p-2 -mr-2 text-blue-400",children:(0,t.jsx)(i.HiCheck,{className:"w-8 h-8"})})]}):(0,t.jsxs)("div",{className:"flex items-center justify-between w-full pointer-events-auto",children:[(0,t.jsx)("button",{onClick:l,className:"cursor-pointer p-2 -ml-2",children:(0,t.jsx)(i.HiX,{className:"w-8 h-8"})}),(0,t.jsxs)("div",{className:"flex items-center gap-6",children:[p!==e||b?(0,t.jsx)("button",{onClick:()=>{f(e),y(null),T(0),C(1),A(!1),R([]),q(!1),en([]),Y("")},className:"cursor-pointer px-3 py-1 rounded-full bg-white/10 text-xs hover:bg-white/20",children:"Khôi phục"}):null,(0,t.jsx)("button",{className:"cursor-pointer p-2",onClick:async()=>{if("video"===s){let e=await ep();e&&ej(e)}w(!0)},children:(0,t.jsx)(j.FaCropSimple,{className:"w-6 h-6"})}),(0,t.jsx)("button",{className:"cursor-pointer p-2",onClick:()=>A(!0),children:(0,t.jsx)(j.FaPen,{className:"w-6 h-6"})}),(0,t.jsx)("button",{className:"cursor-pointer p-2 font-serif text-xl font-bold",onClick:()=>q(!0),children:"Aa"}),es.length>0&&"image"===s?(0,t.jsx)("button",{onClick:eM,className:"cursor-pointer px-3 py-1 rounded-full bg-white/10 text-xs hover:bg-white/20",children:"Áp dụng văn bản"}):null]})]})}),(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center bg-black overflow-hidden relative w-full h-full",ref:F,children:v?(0,t.jsx)("div",{className:"relative w-full h-full",children:(0,t.jsx)(N.Cropper,{ref:V,src:"video"===s?ew||"":(0,h.getProxyUrl)(p),className:"w-full h-full object-contain",stencilProps:{aspectRatio:void 0}})}):(0,t.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center",children:["image"===s?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(p),alt:"Editing",fill:!0,className:"object-contain",priority:!0}):null,es.map(e=>(0,t.jsx)("div",{style:{position:"absolute",left:e.x,top:e.y,transform:"translate(-50%, -50%)",color:e.color,fontSize:`${e.size}px`,fontWeight:700,cursor:"grab",userSelect:"none"},onMouseDown:t=>{ea(e.id),eo({x:t.clientX-e.x,y:t.clientY-e.y}),ed(e.id)},onMouseMove:t=>{if(ei!==e.id)return;let r=t.clientX-el.x,s=t.clientY-el.y,n=X?Math.min(Math.max(r,X.x),X.x+X.width):r,i=X?Math.min(Math.max(s,X.y),X.y+X.height):s;en(t=>t.map(t=>t.id===e.id?{...t,x:n,y:i}:t))},onMouseUp:()=>{ei===e.id&&ea(null)},onTouchStart:t=>{let r=t.touches[0];ea(e.id),eo({x:r.clientX-e.x,y:r.clientY-e.y}),ed(e.id)},onTouchMove:t=>{if(ei!==e.id)return;let r=t.touches[0],s=r.clientX-el.x,n=r.clientY-el.y,i=X?Math.min(Math.max(s,X.x),X.x+X.width):s,a=X?Math.min(Math.max(n,X.y),X.y+X.height):n;en(t=>t.map(t=>t.id===e.id?{...t,x:i,y:a}:t))},onTouchEnd:()=>{ei===e.id&&ea(null)},children:(0,t.jsxs)("span",{className:"relative inline-block",children:[e.text,ec===e.id&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),en(t=>t.filter(t=>t.id!==e.id)),ed(null)},className:"absolute -top-3 -right-3 w-6 h-6 rounded-full bg-red-600 text-white flex items-center justify-center shadow",title:"Xóa",children:(0,t.jsx)(i.HiX,{className:"w-4 h-4"})})]})},e.id)),"video"===s&&b&&b.croppedAreaPixels&&(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(()=>{let{x:e,y:r,width:s,height:n}=b.croppedAreaPixels,{width:i,height:a}=em;if(0===(b.rotation||0)&&G&&i>0&&a>0){let l=Math.min(i/s,a/n),o=G.width*l,c=G.height*l;return(0,t.jsxs)("div",{style:{width:s*l,height:n*l,overflow:"hidden",position:"relative"},children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(p),autoPlay:!ex,loop:!0,muted:ex,playsInline:!0,"webkit-playsinline":"true",onLoadedMetadata:e=>{let t=e.currentTarget;G&&G.width===t.videoWidth&&G.height===t.videoHeight||W({width:t.videoWidth,height:t.videoHeight})},ref:eh,style:{position:"absolute",left:-e*l,top:-r*l,width:o,height:c,maxWidth:"none",maxHeight:"none"}}),(0,t.jsx)("button",{onClick:()=>{let e=eh.current;eg(t=>{let r=!t;return e&&(e.muted=r,r||e.play().catch(()=>{})),r})},className:"absolute bottom-4 left-4 px-3 py-1.5 rounded-full bg-black/60 text-white text-xs border border-white/20",title:ex?"Bật âm thanh":"Tắt âm thanh",children:ex?"Bật âm thanh":"Tắt âm thanh"})]})}return(0,t.jsx)(N.Cropper,{src:ew||(0,h.getProxyUrl)(p),defaultCoordinates:{left:b.croppedAreaPixels.x,top:b.croppedAreaPixels.y,width:b.croppedAreaPixels.width,height:b.croppedAreaPixels.height},stencilProps:{movable:!1,resizable:!1},className:"w-full h-full object-contain pointer-events-none",backgroundClassName:"bg-black/95"})})()}),"video"===s&&!b&&(0,t.jsx)("div",{className:"relative w-full h-full flex items-center justify-center",children:(0,t.jsx)("video",{src:(0,h.getProxyUrl)(p),crossOrigin:"anonymous",autoPlay:!0,loop:!0,muted:!1,controls:!1,ref:z,onLoadedMetadata:()=>{let e=F.current,t=z.current;e&&t&&(W({width:t.videoWidth,height:t.videoHeight}),eb(e.clientWidth,e.clientHeight,t.videoWidth,t.videoHeight),ep().then(e=>{e&&ej(e)}))},className:"max-w-full max-h-full object-contain"})}),(0,t.jsx)("canvas",{ref:B,className:"absolute inset-0",style:{pointerEvents:M?"auto":"none"},onMouseDown:eS,onMouseMove:ek,onMouseUp:eC,onMouseLeave:eC,onTouchStart:eS,onTouchMove:ek,onTouchEnd:eC})]})}),!v&&!M&&!K&&(0,t.jsxs)("div",{className:"px-4 py-4 pb-8 flex flex-col gap-4 border-t border-white/10 bg-black",children:[(0,t.jsx)("div",{className:"flex items-center gap-3",children:(0,t.jsx)("div",{className:"flex-1 bg-gray-800/80 backdrop-blur-md rounded-full flex items-center px-4 py-2 border border-white/10",children:(0,t.jsx)("input",{type:"text",placeholder:`Nhập m\xf4 tả gửi ${n||"..."}`,className:"w-full bg-transparent text-white placeholder-gray-400 outline-none text-sm",value:c,onChange:e=>d(e.target.value)})})}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("button",{onClick:()=>u(!m),className:`cursor-pointer flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${m?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"}`,children:["HD",(0,t.jsx)("span",{className:"text-[10px] leading-none",children:"▼"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)("button",{onClick:()=>g(!x),className:"flex items-center gap-2 text-white text-sm",children:[(0,t.jsx)("div",{className:`cursor-pointer w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${x?"bg-blue-500 border-blue-500":"border-white/60"}`,children:x&&(0,t.jsx)("div",{className:"w-2.5 h-2.5 bg-white rounded-full"})}),(0,t.jsx)("span",{children:"Chọn"})]}),(0,t.jsx)("button",{onClick:async()=>{if("image"===s){let e=U.length>0,t=es.length>0;(e||t)&&await eM()}o?.({description:c,isHD:m,selected:x,imageDataUrl:"image"===s?p:void 0,videoCropConfig:b}),l()},className:"cursor-pointer w-10 h-10 bg-blue-500 hover:bg-blue-600 rounded-full flex items-center justify-center text-white transition-colors",children:(0,t.jsx)(S.IoSend,{className:"w-5 h-5 ml-0.5"})})]})]})]}),K&&(0,t.jsxs)("div",{className:"px-4 py-4 pb-8 flex flex-col gap-4 border-t border-white/10 bg-black",children:[(0,t.jsx)("div",{className:"flex items-center gap-3",children:(0,t.jsx)("div",{className:"flex-1 bg-gray-800/80 backdrop-blur-md rounded-full flex items-center px-4 py-2 border border-white/10",children:(0,t.jsx)("input",{type:"text",placeholder:"Nhập văn bản",className:"w-full bg-transparent text-white placeholder-gray-400 outline-none text-sm",value:Q,onChange:e=>Y(e.target.value)})})}),(0,t.jsx)("div",{className:"flex items-center justify-center gap-2",children:["#ffffff","#000000","#ff3b30","#ff9500","#ffcc00","#34c759","#5ac8fa","#007aff","#5856d6","#af52de"].map(e=>(0,t.jsx)("button",{onClick:()=>ee(e),className:`w-8 h-8 rounded-full border ${Z===e?"ring-2 ring-white":"border-white/30"}`,style:{backgroundColor:e}},e))}),(0,t.jsxs)("div",{className:"flex items-center gap-4 px-8",children:[(0,t.jsx)("span",{className:"text-xs text-white",children:"Kích thước"}),(0,t.jsx)("input",{type:"range",min:12,max:48,step:1,value:et,onChange:e=>er(Number(e.target.value)),className:"flex-1 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer range-sm"})]})]}),M&&(0,t.jsxs)("div",{className:"px-4 py-4 pb-8 flex flex-col gap-4 border-t border-white/10 bg-black",children:[(0,t.jsx)("div",{className:"flex items-center justify-center",children:(0,t.jsx)("button",{onClick:()=>O(e=>!e),className:`px-3 py-1.5 rounded-full text-xs font-medium ${D?"bg-white text-black":"bg-white/10 text-white"}`,children:D?"Chỉ vẽ trong ảnh/video":"Vẽ toàn khung"})}),(0,t.jsx)("div",{className:"flex items-center justify-center gap-2",children:["#ff3b30","#ff9500","#ffcc00","#34c759","#30d158","#5ac8fa","#007aff","#5856d6","#af52de","#ffffff","#000000"].map(e=>(0,t.jsx)("button",{onClick:()=>$(e),className:`w-8 h-8 rounded-full border ${E===e?"ring-2 ring-white":"border-white/30"}`,style:{backgroundColor:e}},e))}),(0,t.jsxs)("div",{className:"flex items-center gap-4 px-8",children:[(0,t.jsx)("span",{className:"text-xs text-white",children:"Độ đậm"}),(0,t.jsx)("input",{type:"range",min:2,max:24,step:1,value:I,onChange:e=>L(Number(e.target.value)),className:"flex-1 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer range-sm"})]})]})]})}function C({media:e,chatName:s,isGroup:n,onClose:l,roomId:o,onReply:c,onShare:d,onShareMessage:m,onJumpToMessage:u}){let[g,p]=(0,r.useState)([]),f=(0,r.useMemo)(()=>g.flatMap(e=>e.items),[g]),[b,y]=(0,r.useState)(e),v=(0,r.useRef)(null),w=(0,r.useRef)({}),N=(0,r.useRef)(0),[S,C]=(0,r.useState)(1),[_,T]=(0,r.useState)({x:0,y:0}),[M,A]=(0,r.useState)(!1),E=(0,r.useRef)(null),[$,I]=(0,r.useState)(!0),[L,P]=(0,r.useState)(!1);(0,r.useEffect)(()=>{y(e),e&&(N.current=Date.now()),C(1),T({x:0,y:0})},[e]);let H=()=>{A(!1),E.current=null};(0,r.useEffect)(()=>{(async()=>{if(o)try{let e=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readAssets",roomId:o,assetType:"media",limit:5e3})}),t=await e.json(),r=Array.isArray(t?.groups)?t.groups:[];p(r)}catch{}})()},[o]),(0,r.useEffect)(()=>{C(1),T({x:0,y:0})},[b?.url]),(0,r.useEffect)(()=>{if(!b)return;let e=w.current[b.url],t=v.current;if(e&&t)try{if(window.innerWidth<768){let r=e.offsetLeft-(t.clientWidth/2-e.clientWidth/2);t.scrollTo({left:Math.max(0,r),behavior:"smooth"})}else{let r=e.offsetTop-(t.clientHeight/2-e.clientHeight/2);t.scrollTo({top:Math.max(0,r),behavior:"smooth"})}}catch{}},[b,f,$]);let[U,R]=(0,r.useState)(!1),D=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=e=>{D.current&&!D.current.contains(e.target)&&R(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]);let O=async()=>{if(b?.url){try{let e=await fetch((0,h.getProxyUrl)(b.url,!0)),t=await e.blob(),r=window.URL.createObjectURL(t),s=document.createElement("a");s.style.display="none",s.href=r,s.download=b.url.split("/").pop()||"download",document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(r),document.body.removeChild(s)}catch(e){window.open((0,h.getProxyUrl)(b.url,!0),"_blank")}R(!1)}},B=()=>{if(!b?.url)return;let e=(0,h.getProxyUrl)(b.url,!0);if(m&&o){m({_id:b.id||Date.now().toString(),roomId:o,sender:"unknown",type:b.type,fileUrl:b.url,timestamp:Date.now()}),R(!1);return}if(d)d(e,b?.id);else if(navigator.share)navigator.share({title:s||"Media",url:e}).catch(()=>{});else try{navigator.clipboard.writeText(e)}catch{}R(!1)};return b?L&&b?(0,t.jsx)(k,{mediaUrl:b.url,mediaType:b.type,chatName:s,onClose:()=>P(!1),onSend:e=>{try{let t={type:b.type,imageDataUrl:e?.videoCropConfig?void 0:e?.imageDataUrl??void 0,originalUrl:b.url,videoCropConfig:e?.videoCropConfig??void 0},r=new CustomEvent("sendEditedMedia",{detail:t});window.dispatchEvent(r)}catch{}P(!1),l()}}):(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] bg-black/95 flex items-center justify-center",onClick:e=>{e.target!==e.currentTarget||Date.now()-N.current<200||l()},children:(0,t.jsxs)("div",{className:"relative w-full max-w-6xl mx-auto",onClick:e=>e.stopPropagation(),children:[(0,t.jsx)("div",{className:"hidden md:block absolute top-0 left-0 right-0 z-20 px-4 sm:px-6 py-3 text-white text-center",children:(0,t.jsx)("h3",{className:"text-lg sm:text-xl font-semibold truncate",children:s||(n?"Nhóm chat":"Cuộc trò chuyện")})}),(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen md:py-16 py-12 overflow-hidden",children:(0,t.jsx)("div",{className:"relative max-w-full max-h-full overflow-hidden flex items-center justify-center",onMouseDown:e=>{S<=1||(A(!0),E.current={x:e.clientX-_.x,y:e.clientY-_.y},e.preventDefault())},onMouseMove:e=>{M&&E.current&&!(S<=1)&&T({x:e.clientX-E.current.x,y:e.clientY-E.current.y})},onMouseUp:H,onMouseLeave:H,onTouchStart:e=>{if(S<=1)return;A(!0);let t=e.touches[0];E.current={x:t.clientX-_.x,y:t.clientY-_.y}},onTouchMove:e=>{if(!M||!E.current||S<=1)return;let t=e.touches[0];T({x:t.clientX-E.current.x,y:t.clientY-E.current.y})},onTouchEnd:()=>{A(!1),E.current=null},style:{cursor:S>1?M?"grabbing":"grab":"default"},children:"image"===b.type?(0,t.jsx)("div",{className:"animate-in fade-in zoom-in-95 duration-300",style:{transform:`translate(${_.x}px, ${_.y}px) scale(${S})`,transformOrigin:"center center",transition:M?"none":"transform 0.2s"},children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(b.url),alt:"Xem ảnh lớn",width:1600,height:1200,className:"max-h-[70vh] w-auto max-w-full object-contain rounded-md shadow-2xl select-none pointer-events-none",priority:!0})}):(0,t.jsx)("div",{className:"animate-in fade-in duration-300 rounded-md overflow-hidden shadow-2xl",style:{transform:`translate(${_.x}px, ${_.y}px) scale(${S})`,transformOrigin:"center center",transition:M?"none":"transform 0.2s"},children:(0,t.jsx)("video",{src:(0,h.getProxyUrl)(b.url),controls:S<=1,autoPlay:!0,loop:!0,muted:!1,className:"max-h-[70vh] w-auto max-w-full rounded-md select-none",playsInline:!0})})})}),f.length>0&&$&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"hidden md:flex absolute right-36 top-1/2 -translate-y-1/2 flex-col items-center gap-3 z-20",children:[(0,t.jsx)("button",{className:"p-2 cursor-pointer rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white shadow-lg",onClick:()=>{let e=v.current;e&&e.scrollBy({top:-300,behavior:"smooth"})},children:(0,t.jsx)(i.HiChevronUp,{className:"w-5 h-5"})}),(0,t.jsx)("button",{className:"p-2 cursor-pointer rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white shadow-lg",onClick:()=>{let e=v.current;e&&e.scrollBy({top:300,behavior:"smooth"})},children:(0,t.jsx)(i.HiChevronDown,{className:"w-5 h-5"})})]}),(0,t.jsx)("div",{className:"md:hidden absolute left-2 top-1/2 -translate-y-1/2 z-20",children:(0,t.jsx)("button",{className:"p-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white shadow-lg backdrop-blur-sm",onClick:e=>{e.stopPropagation();let t=f.findIndex(e=>e.url===b?.url);if(t>0){let e=f[t-1];y({id:e.id,url:e.url,type:e.type})}},style:{visibility:f.findIndex(e=>e.url===b?.url)>0?"visible":"hidden"},children:(0,t.jsx)(i.HiChevronLeft,{className:"w-8 h-8"})})}),(0,t.jsx)("div",{className:"md:hidden absolute right-2 top-1/2 -translate-y-1/2 z-20",children:(0,t.jsx)("button",{className:"p-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white shadow-lg backdrop-blur-sm",onClick:e=>{e.stopPropagation();let t=f.findIndex(e=>e.url===b?.url);if(t<f.length-1){let e=f[t+1];y({id:e.id,url:e.url,type:e.type})}},style:{visibility:f.findIndex(e=>e.url===b?.url)<f.length-1?"visible":"hidden"},children:(0,t.jsx)(i.HiChevronRight,{className:"w-8 h-8"})})})]}),(0,t.jsxs)("div",{className:"absolute left-0 right-0 top-0 z-20 px-4 sm:px-6 py-2 bg-black/40 backdrop-blur-sm border-t border-white/10 text-white flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 min-w-0",children:[(0,t.jsx)("button",{onClick:l,className:"md:hidden p-2 rounded-full cursor-pointer bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95",title:"Đóng",children:(0,t.jsx)(i.HiChevronLeft,{className:"w-6 h-6"})}),(0,t.jsx)("div",{className:"text-sm font-medium truncate md:max-w-[40vw] max-w-[50vw] text-center md:text-left",children:s||(n?"Nhóm chat":"Cuộc trò chuyện")})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-white/80",children:[(0,t.jsx)("button",{className:"cursor-pointer inline-flex p-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95",onClick:e=>{e.preventDefault(),O()},title:"Tải xuống",children:(0,t.jsx)(i.HiDownload,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{className:"relative",ref:D,children:[(0,t.jsx)("button",{onClick:()=>R(!U),className:"p-2 rounded-full cursor-pointer bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95",title:"Thêm",children:(0,t.jsx)(i.HiDotsHorizontal,{className:"w-5 h-5"})}),U&&(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-2 w-48 bg-gray-900 border border-white/10 rounded-lg shadow-xl overflow-hidden z-50 flex flex-col py-1",children:[(0,t.jsxs)("button",{onClick:()=>C(e=>Math.min(2.5,+(e+.2).toFixed(2))),className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(x.HiMagnifyingGlassPlus,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Phóng to"})]}),(0,t.jsxs)("button",{onClick:()=>C(e=>Math.max(.5,+(e-.2).toFixed(2))),className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(x.HiMagnifyingGlassMinus,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Thu nhỏ"})]}),(0,t.jsxs)("button",{onClick:()=>{P(!0),R(!1)},className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(i.HiPencil,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Chỉnh sửa ảnh"})]}),(0,t.jsxs)("button",{onClick:O,className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(i.HiSave,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Lưu về máy"})]}),(0,t.jsxs)("button",{onClick:B,className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(i.HiShare,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Chia sẻ"})]}),(0,t.jsxs)("button",{onClick:()=>{if(b?.url){try{navigator.clipboard.writeText((0,h.getProxyUrl)(b.url,!0))}catch{}R(!1)}},className:"cursor-pointer flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left text-sm text-white transition-colors",children:[(0,t.jsx)(i.HiDuplicate,{className:"w-5 h-5"}),(0,t.jsx)("span",{children:"Copy"})]})]})]}),(0,t.jsx)("button",{onClick:l,className:"hidden md:inline-flex p-2 rounded-full cursor-pointer bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95",title:"Đóng",children:(0,t.jsx)(i.HiX,{className:"w-6 h-6"})})]})]}),(0,t.jsxs)("div",{className:"absolute left-0 right-0 bottom-0 z-20 flex flex-col items-center justify-end bg-black/60 backdrop-blur-sm border-t border-white/10 pb-2",children:[g.length>0&&$&&(0,t.jsx)("div",{className:"w-full overflow-x-auto no-scrollbar py-2",ref:v,children:(0,t.jsx)("div",{className:"flex flex-row items-center justify-center gap-2 px-2 min-w-max mx-auto",children:g.map((e,r)=>(0,t.jsx)("div",{className:"flex flex-row gap-2",children:e.items.map(e=>(0,t.jsxs)("div",{ref:t=>{w.current[e.url]=t},className:`relative rounded-md overflow-hidden border ${b&&b.url===e.url?"border-blue-400":"border-transparent"} cursor-pointer w-16 h-16 shrink-0`,onClick:()=>y({id:e.id,url:e.url,type:e.type}),children:["image"===e.type?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.url),alt:"thumb",width:120,height:120,className:"w-full h-full object-cover"}):(0,t.jsx)("video",{src:(0,h.getProxyUrl)(e.url),className:"w-full h-full object-cover",preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 hover:bg-black/30 transition-opacity duration-300 flex items-center justify-center",children:"video"===e.type&&(0,t.jsx)(i.HiPlay,{className:"w-6 h-6 text-white drop-shadow-lg"})})]},e.id))},`${e.dateLabel}-${r}`))})}),(0,t.jsxs)("div",{className:"flex items-center justify-between w-full gap-4 px-5 sm:px-6 py-2 text-white",children:[(0,t.jsx)("div",{className:"flex items-center justify-center gap-4",children:(0,t.jsx)("button",{className:`cursor-pointer p-3 md:p-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95 ${$?"bg-white/30":""}`,title:"Hiện/Ẩn danh sách",onClick:()=>I(!$),children:(0,t.jsx)(i.HiPhotograph,{className:"w-6 h-6 md:w-5 md:h-5"})})}),(0,t.jsx)("button",{className:"cursor-pointer p-3 md:p-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 transition-all active:scale-95 ",title:"Chia sẻ",onClick:B,children:(0,t.jsx)(j.FaRegShareFromSquare,{className:"w-6 h-6 md:w-4 md:h-4"})})]})]})]})}):null}function _({userName:e,userAvatar:s,onUpdateNickname:n}){let[l,o]=(0,r.useState)(!1),[c,d]=(0,r.useState)(e),[m,u]=(0,r.useState)(!1),x=(0,r.useRef)(null);(0,r.useEffect)(()=>{d(e)},[e]),(0,r.useEffect)(()=>{l&&x.current?.focus()},[l]);let g=async()=>{let t=c.trim();if(t!==(e||"").trim()||""===t)try{u(!0),await n?.(t,{silent:!0})}finally{u(!1)}o(!1)},p=()=>{d(e),o(!1)};return(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"relative group",children:[(0,t.jsx)("div",{className:"w-20 h-20 rounded-full overflow-hidden ring-4 ring-white shadow-2xl bg-gray-200 transition-all duration-500 group-hover:scale-105 group-hover:shadow-3xl",children:s?(0,t.jsx)(a.default,{width:100,height:100,src:(0,h.getProxyUrl)(s),alt:e,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.style.display="none",e.currentTarget.nextElementSibling?.classList.remove("hidden")}}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:e,width:40,height:40,className:"w-full h-full object-cover"})}),(0,t.jsx)("div",{className:"absolute inset-0 rounded-full ring-4 ring-transparent group-hover:ring-blue-300/30 transition-all duration-500 pointer-events-none"})]}),(0,t.jsx)("div",{className:"mt-6 text-center relative group/name w-full flex justify-center",children:l?(0,t.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,t.jsx)("input",{ref:x,value:c,onChange:e=>d(e.target.value),className:"text-xl font-bold text-gray-900 text-center border-b-2 border-blue-500 focus:outline-none bg-transparent min-w-[9.375rem] max-w-[15.625rem]",onKeyDown:e=>{"Enter"===e.key&&g(),"Escape"===e.key&&p()},disabled:m}),(0,t.jsx)("button",{onClick:g,disabled:m,className:`p-1 rounded-full transition-colors cursor-pointer ${m?"bg-green-100 text-green-500 opacity-70":"hover:bg-green-100 text-green-500"}`,children:m?(0,t.jsx)("span",{className:"w-5 h-5 inline-block border-2 border-green-500 border-t-transparent rounded-full animate-spin"}):(0,t.jsx)(i.HiCheck,{className:"w-5 h-5"})}),(0,t.jsx)("button",{onClick:p,disabled:m,className:"p-1 rounded-full hover:bg-red-100 text-red-500 transition-colors cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}):(0,t.jsx)("div",{className:"flex items-center justify-center gap-2 group/edit cursor-pointer",onClick:()=>n&&o(!0),children:(0,t.jsx)("h3",{className:"text-xl font-bold text-gray-900 tracking-tight truncate max-w-[15.625rem]",children:e||"Người dùng"})})}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500 font-medium",children:"Đang trò chuyện riêng"})]})}var T=e.i(25685);function M(e){return(0,c.GenIcon)({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M2 21a8 8 0 0 1 13.292-6"},child:[]},{tag:"circle",attr:{cx:"10",cy:"8",r:"5"},child:[]},{tag:"path",attr:{d:"M19 16v6"},child:[]},{tag:"path",attr:{d:"M22 19h-6"},child:[]}]})(e)}function A({isGroup:e,localIsPinned:r,localIsHidden:s,onPinToggle:n,onHideToggle:i,onCreateGroup:a,onOpenMembers:l,onSearchMessages:o,onChangeWallpaper:c,isMuted:d,onToggleMute:m,onOpenProfile:u}){return e?(0,t.jsxs)("div",{className:"flex justify-around items-center ",children:[(0,t.jsxs)("button",{onClick:o,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-2xl ",title:"Tìm tin nhắn",children:[(0,t.jsx)("div",{className:"p-1 rounded-full bg-gray-100 text-gray-700 group-hover:bg-gray-200 transition-all  group-hover:shadow-lg",children:(0,t.jsx)(T.CiSearch,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Tìm tin nhắn"})]}),(0,t.jsxs)("button",{onClick:l,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-2xl transition-all duration-300 active:scale-95",title:"Thêm thành viên",children:[(0,t.jsx)("div",{className:"p-1 rounded-full bg-gray-100 text-gray-700 group-hover:bg-gray-200 transition-all  group-hover:shadow-lg",children:(0,t.jsx)(M,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Thêm thành viên"})]}),(0,t.jsxs)("button",{onClick:m,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-full transition-all duration-300 active:scale-95",title:d?"Bật thông báo":"Tắt thông báo",children:[(0,t.jsx)("div",{className:`p-1 rounded-3xl transition-all duration-300  group-hover:shadow-lg ${d?"bg-red-100 text-red-600 ring-2 ring-red-200":"bg-gray-100 text-gray-700 group-hover:bg-gray-200"}`,children:(0,t.jsx)(T.CiBellOn,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:`text-xs font-medium ${d?"text-red-700":"text-gray-700"}`,children:d?"Đã tắt":"Tắt thông báo"})]})]}):(0,t.jsxs)("div",{className:"flex justify-around items-center ",children:[(0,t.jsxs)("button",{onClick:o,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-2xl transition-all duration-300 hover:bg-gray-50 active:scale-95",title:"Tìm tin nhắn",children:[(0,t.jsx)("div",{className:"p-1 rounded-full bg-gray-100 text-gray-700 group-hover:bg-gray-200 transition-all group-hover:shadow-lg",children:(0,t.jsx)(T.CiSearch,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Tìm tin nhắn"})]}),(0,t.jsxs)("button",{onClick:u,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-2xl transition-all duration-300  active:scale-95",title:"Trang cá nhân",children:[(0,t.jsx)("div",{className:"p-1 rounded-full bg-gray-100 text-gray-700 group-hover:bg-gray-200 transition-all group-hover:shadow-lg",children:(0,t.jsx)(T.CiUser,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Trang cá nhân"})]}),(0,t.jsxs)("button",{onClick:m,className:"cursor-pointer group flex flex-col items-center gap-3 p-2 rounded-full transition-all duration-300 active:scale-95",title:d?"Bật thông báo":"Tắt thông báo",children:[(0,t.jsx)("div",{className:`p-1 rounded-full transition-all duration-300  group-hover:shadow-lg ${d?"bg-red-100 text-red-600 ring-2 ring-red-200":"bg-gray-100 text-gray-700 group-hover:bg-gray-200"}`,children:(0,t.jsx)(T.CiBellOn,{className:"w-5 h-5"})}),(0,t.jsx)("span",{className:`text-xs font-medium ${d?"text-red-700":"text-gray-700"}`,children:d?"Đã tắt":"Tắt thông báo"})]})]})}function E({canLeaveGroup:e,canDisbandGroup:r,onLeaveClick:s,onDisbandClick:n}){return(0,t.jsxs)(t.Fragment,{children:[e&&(0,t.jsxs)("button",{onClick:s,className:"w-full px-5 py-4 flex items-center gap-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-200 group cursor-pointer mb-0",children:[(0,t.jsx)(T.CiLogout,{className:"w-5 h-5 text-red-500 group-hover:text-red-600 transition-colors"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-red-500 font-medium group-hover:text-red-600 transition-colors",children:"Rời nhóm"})]}),r&&(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("button",{onClick:n,className:"w-full px-5 py-4 flex items-center gap-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-200 group cursor-pointer",children:[(0,t.jsx)(T.CiTrash,{className:"w-5 h-5 text-red-500 group-hover:text-red-600 transition-colors"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-red-500 font-medium group-hover:text-red-600 transition-colors",children:"Giải tán nhóm"})]})})]})}function $({isGroup:e,membersCount:r,onOpenMembers:s}){return e?(0,t.jsx)("div",{className:"bg-white overflow-hidden",children:(0,t.jsxs)("button",{onClick:s,className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between ",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"rounded-xl  text-gray-500",children:(0,t.jsx)(x.HiOutlineUserGroup,{className:"w-5 h-5"})}),(0,t.jsxs)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-900",children:["Xem thành viên ",(0,t.jsxs)("span",{className:"text-gray-500",children:["(",r,")"]})]})]}),(0,t.jsx)(i.HiOutlineArrowRight,{className:"w-5 h-5 text-gray-400 group-hover:text-indigo-600 transition-colors"})]})}):null}function I({onOpen:e}){return(0,t.jsx)("div",{className:"bg-white   border border-gray-100 overflow-hidden",children:(0,t.jsxs)("button",{className:"cursor-pointer w-full px-5 py-4 flex items-center gap-5 hover:bg-gray-50 transition-all duration-200 group",onClick:e,title:"Xem danh sách nhắc hẹn",children:[(0,t.jsx)("div",{className:" rounded-xl   ",children:(0,t.jsx)(T.CiCalendarDate,{className:"w-5 h-5 text-gray-500"})}),(0,t.jsx)("div",{className:"text-left",children:(0,t.jsx)("p",{className:"text-base text-[1.125rem] md:text-[1rem] text-gray-900 group-hover:text-amber-600 transition-colors",children:"Lịch hẹn"})}),(0,t.jsx)("div",{className:"ml-auto text-gray-400 group-hover:text-amber-600 transition-colors",children:(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400 group-hover:text-amber-600"})})]})})}function L({onOpen:e}){return(0,t.jsx)("div",{className:"bg-white  border border-gray-100 overflow-hidden",children:(0,t.jsxs)("button",{className:"cursor-pointer w-full px-5 py-4 flex items-center gap-5 hover:bg-gray-50 transition-all duration-200 group",onClick:e,title:"Xem danh sách bình chọn",children:[(0,t.jsx)("div",{className:" rounded-xl  text-gray-500  ",children:(0,t.jsx)(T.CiWavePulse1,{className:"w-5 h-5"})}),(0,t.jsx)("div",{className:"text-left",children:(0,t.jsx)("p",{className:"text-base text-[1.125rem] md:text-[1rem] text-gray-900 group-hover:text-indigo-600 transition-colors",children:"Bình chọn"})}),(0,t.jsx)("div",{className:"ml-auto text-gray-400 group-hover:text-indigo-600 transition-colors",children:(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400 group-hover:text-indigo-600"})})]})})}function P({itemUrl:e,itemId:r,fileName:s,activeMenuId:n,onClose:a,onJumpToMessage:l,onRemoveFromFolder:o,onShareById:c}){return n!==r?null:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-40 cursor-default",onClick:e=>{e.stopPropagation(),a()}}),(0,t.jsxs)("div",{className:"absolute top-10 right-0 z-50 w-40 bg-white rounded-md shadow-xl border border-gray-200 py-1 animate-in fade-in zoom-in duration-100 origin-top-right",children:["function"==typeof c&&(0,t.jsxs)("button",{onClick:e=>{e.stopPropagation();try{c(r)}finally{a()}},className:"cursor-pointer w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[(0,t.jsx)(i.HiOutlineShare,{className:"w-5 h-5"}),"Chia sẻ tin nhắn"]}),e&&e.trim()&&(0,t.jsxs)("a",{href:e,download:s||"download",onClick:e=>{e.stopPropagation(),a()},target:"_blank",rel:"noreferrer",className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4 text-gray-500",children:[(0,t.jsx)("path",{d:"M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z"}),(0,t.jsx)("path",{d:"M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z"})]}),"Tải xuống"]}),o&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("hr",{className:"my-1 border-gray-200"}),(0,t.jsxs)("button",{onClick:e=>{e.stopPropagation(),o(r),a()},className:"cursor-pointer w-full text-left px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 flex items-center gap-2",children:[(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M8 2a1 1 0 00-1 1v1H5a1 1 0 100 2h10a1 1 0 100-2h-2V3a1 1 0 00-1-1H8zm-3 6a1 1 0 011 1v7a1 1 0 001 1h6a1 1 0 001-1V9a1 1 0 112 0v7a3 3 0 01-3 3H8a3 3 0 01-3-3V9a1 1 0 011-1zm4 1a1 1 0 10-2 0v6a1 1 0 102 0V9zm3-1a1 1 0 00-1 1v6a1 1 0 102 0V9a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Loại khỏi folder"]})]})]})]})}function H({isOpen:e,renameInput:r,onChangeInput:s,onClose:n,onSubmit:a}){return e?(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm px-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95 duration-200",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"relative cursor-pointer px-6 pt-8 pb-6 bg-blue-400 text-white text-center",children:[(0,t.jsx)("div",{className:"absolute top-4 right-4",children:(0,t.jsx)("button",{onClick:n,className:"p-2 cursor-pointer rounded-full bg-white/20 hover:bg-white/30 transition-all duration-200 active:scale-95",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})}),(0,t.jsx)("h3",{className:"text-2xl font-bold",children:"Đổi tên nhóm"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-white/80",children:"Tất cả thành viên sẽ thấy tên nhóm mới"})]}),(0,t.jsxs)("div",{className:"p-6 pt-8",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("input",{type:"text",value:r,onChange:e=>s(e.target.value),onKeyDown:e=>{"Enter"===e.key&&r.trim()&&(e.preventDefault(),a())},autoFocus:!0,placeholder:"Nhập tên nhóm mới...",className:"w-full pl-3 pr-12 py-2 bg-[#EAEDF0] rounded-md focus:outline-none focus:bg-white focus:ring-1 focus:ring-[#0068ff] transition-all duration-300 text-sm text-gray-900 placeholder-gray-500"}),r&&(0,t.jsx)(i.HiCheck,{className:"absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-green-600"})]}),(0,t.jsxs)("p",{className:"mt-3 text-xs text-gray-500 text-center",children:["Nhấn ",(0,t.jsx)("kbd",{className:"px-2 py-1 bg-gray-100 rounded text-xs font-medium",children:"Enter"})," để lưu nhanh"]})]}),(0,t.jsxs)("div",{className:"flex gap-3 px-6 pb-8",children:[(0,t.jsx)("button",{onClick:n,className:"cursor-pointer flex-1 py-3.5 text-base font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-2xl transition-all duration-200 active:scale-95",children:"Hủy"}),(0,t.jsxs)("button",{onClick:a,disabled:!r.trim(),className:`flex-1 py-3.5 cursor-pointer text-base font-bold text-white rounded-2xl shadow-lg transition-all duration-300 active:scale-95 flex items-center justify-center gap-2
              ${!r.trim()?"bg-gray-400 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600 shadow-blue-300"}`,children:[(0,t.jsx)(i.HiCheck,{className:"w-5 h-5"}),"Lưu tên nhóm"]})]})]})}):null}function U({confirmAction:e,onCancel:r,onConfirmLeave:s,onConfirmDisband:n}){if(!e)return null;let a="leave"===e;return(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm px-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-xl border border-gray-100 w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"px-4 py-4 flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:a?"Rời khỏi nhóm?":"Giải tán nhóm?"}),(0,t.jsx)("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsx)("div",{className:"h-px bg-gray-100 mx-4"}),(0,t.jsx)("div",{className:"px-4 py-6",children:(0,t.jsx)("div",{className:"flex flex-col items-center text-center",children:(0,t.jsx)("p",{className:"text-gray-600 leading-relaxed",children:a?"Bạn sẽ không còn nhận được tin nhắn từ nhóm này nữa. Bạn vẫn có thể tham gia lại nếu được mời.":"Toàn bộ thành viên sẽ bị xóa khỏi nhóm và lịch sử trò chuyện sẽ bị xóa vĩnh viễn. Hành động này không thể hoàn tác."})})}),(0,t.jsx)("div",{className:"h-px bg-gray-100 mx-4 mb-4"}),(0,t.jsxs)("div",{className:"flex items-center justify-end gap-3 px-4 pb-4",children:[(0,t.jsx)("button",{type:"button",onClick:r,className:"cursor-pointer px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Hủy"}),(0,t.jsx)("button",{type:"button",onClick:a?s:n,className:"cursor-pointer px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-sm transition-colors flex items-center gap-2",children:a?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiOutlineUserMinus,{className:"w-4 h-4"}),"Rời nhóm"]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.HiTrash,{className:"w-4 h-4"}),"Giải tán nhóm"]})})]})]})})}let R=(0,r.createContext)(void 0),D=({value:e,children:r})=>(0,t.jsx)(R.Provider,{value:e,children:r}),O=()=>{let e=(0,r.useContext)(R);if(!e)throw Error("useChatContext must be used within a ChatProvider");return e};var B=e.i(91849);function F({isOpen:e,onClose:s,onCreate:n,createLoading:a}){let[o,c]=(0,r.useState)(""),[d,m]=(0,r.useState)(""),[u,h]=(0,r.useState)("none"),[g,p]=(0,r.useState)(!1),[f,b]=(0,r.useState)(!1),y=window.matchMedia("(min-width: 1024px)").matches,v=(0,r.useMemo)(()=>{let e=new Date,t=e=>String(e).padStart(2,"0"),r=e.getFullYear(),s=t(e.getMonth()+1),n=t(e.getDate()),i=t(e.getHours()),a=t(e.getMinutes());return`${r}-${s}-${n}T${i}:${a}`},[]),w=(0,r.useMemo)(()=>{let e=Date.parse(d||v);return Number.isNaN(e)?"Chọn thời gian":new Date(e).toLocaleString("vi-VN",{hour12:!1})},[d,v]),j=(0,r.useMemo)(()=>{switch(u){case"daily":return"Hàng ngày";case"weekly":return"Hàng tuần";case"monthly":return"Hàng tháng";default:return"Không lặp lại"}},[u]),N=o.trim().length>0&&(d||v).trim().length>0;if(!e)return null;let S=(0,t.jsx)("div",{className:`${y?"absolute inset-0":"fixed inset-0"} z-[50] flex items-stretch justify-center ${y?"bg-black/20":"bg-black/50"} backdrop-blur-sm`,children:(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none overflow-hidden animate-in fade-in duration-200 flex flex-col",children:[(0,t.jsx)("div",{className:"p-3 pb-3 bg-gray-100 text-black w-full",children:(0,t.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,t.jsxs)("div",{className:"flex items-center ",children:[(0,t.jsx)("button",{onClick:s,className:" cursor-pointer top-3 left-3 p-2 ",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})}),(0,t.jsx)("h3",{className:"text-xl ",children:"Tạo nhắc hẹn mới"})]}),(0,t.jsx)("button",{onClick:()=>{n({content:o,dateTime:d||v,repeat:u}),c(""),m(""),h("none")},disabled:a,className:`px-4 py-2 font-bold transition-all duration-200 
                ${N&&!a?"text-blue-500 cursor-pointer active:opacity-70":"text-gray-400 cursor-not-allowed opacity-50"}`,children:(0,t.jsx)("div",{className:"flex items-center gap-2 text-blue-500 justify-end ",children:"Xong"})})]})}),(0,t.jsxs)("div",{className:"px-4 sm:px-6 py-4 space-y-2 flex-1 overflow-y-auto",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 px-3 py-3  border-b border-gray-300 ",children:[(0,t.jsx)("div",{className:"text-rose-600",children:(0,t.jsx)(x.HiBellAlert,{className:"w-6 h-6"})}),(0,t.jsx)("input",{value:o,onChange:e=>c(e.target.value),className:"flex-1 bg-transparent outline-none text-lg",placeholder:"Nhập tiêu đề nhắc hẹn...",type:"text"})]}),(0,t.jsxs)("button",{className:"w-full text-left px-3 py-3 border-b border-gray-300  flex items-center gap-3 cursor-pointer active:scale-[0.99]",onClick:()=>b(!0),children:[(0,t.jsx)("div",{className:"text-gray-700",children:(0,t.jsx)(x.HiClock,{className:"w-6 h-6"})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)("p",{className:"text-gray-800 text-[15px]",children:w})})]}),(0,t.jsxs)("button",{className:"w-full text-left px-3 py-3 border-b border-gray-300 flex items-center gap-3 cursor-pointer active:scale-[0.99]",onClick:()=>p(!0),children:[(0,t.jsx)("div",{className:"text-gray-700",children:(0,t.jsx)(x.HiCalendarDays,{className:"w-6 h-6"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-gray-800 text-[15px]",children:"Chọn kiểu lặp lại"}),(0,t.jsx)("p",{className:"text-gray-500 text-xs",children:j})]})]})]}),g&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-end bg-black/40",onClick:()=>p(!1),children:(0,t.jsxs)("div",{className:"w-full bg-white rounded-t-2xl p-4",onClick:e=>{e.stopPropagation()},children:[(0,t.jsxs)("div",{className:"flex items-center justify-between pb-2",children:[(0,t.jsx)("p",{className:"font-semibold",children:"Chọn kiểu lặp lại"}),(0,t.jsx)("button",{onClick:()=>p(!1),className:"px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 cursor-pointer",children:"Xong"})]}),(0,t.jsx)("div",{className:"space-y-2",children:[{key:"none",label:"Không lặp lại"},{key:"daily",label:"Hàng ngày"},{key:"weekly",label:"Hàng tuần"},{key:"monthly",label:"Hàng tháng"}].map(e=>(0,t.jsxs)("label",{className:"flex items-center gap-3 px-3 py-2 rounded-xl border border-gray-200 cursor-pointer",children:[(0,t.jsx)("input",{type:"radio",name:"repeat",checked:u===e.key,onChange:()=>h(e.key)}),(0,t.jsx)("span",{children:e.label})]},e.key))})]})}),f&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-end bg-black/40",onClick:()=>b(!1),children:(0,t.jsxs)("div",{className:"w-full bg-white rounded-t-2xl p-4 space-y-3",onClick:e=>{e.stopPropagation()},children:[(0,t.jsx)("div",{className:"px-1",children:(0,t.jsx)("input",{type:"datetime-local",value:d||v,onChange:e=>m(e.target.value),className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"})}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{onClick:()=>b(!1),className:"px-3 py-2 rounded-xl bg-blue-600 text-white font-semibold cursor-pointer",children:"Chọn"})})]})})]})}),k=y&&"undefined"!=typeof document?document.getElementById("right-sidebar-container"):null;return y&&k?(0,l.createPortal)(S,k):S}function z({isOpen:e,message:s,onClose:o,onRefresh:c}){let d,m,{selectedChat:u,currentUser:g,isGroup:p,allUsers:f}=O(),b=(d=String(g._id),m=String(u._id),p?m:[d,m].sort().join("_")),[y,v]=(0,r.useState)(""),[w,j]=(0,r.useState)(""),[N,S]=(0,r.useState)("none"),[k,C]=(0,r.useState)(!1),[_,T]=(0,r.useState)(!1),[M,A]=(0,r.useState)(!1),[E,$]=(0,r.useState)(!1),[I,L]=(0,r.useState)(!1),P=window.matchMedia("(min-width: 1024px)").matches,H=(0,r.useMemo)(()=>String(s?.content||""),[s]),U=(0,r.useMemo)(()=>s?new Date((s.reminderAt||s.timestamp)-6e4*new Date().getTimezoneOffset()).toISOString().slice(0,16):"",[s]),R=(0,r.useMemo)(()=>s&&s.reminderRepeat||"none",[s]),D=(0,r.useMemo)(()=>{let e=Date.parse(w);return!!y.trim()&&!Number.isNaN(e)},[y,w]),F=(0,r.useMemo)(()=>y.trim()!==H.trim()||w!==U||N!==R,[y,w,N,H,U,R]);(0,r.useEffect)(()=>{s&&(v(String(s.content||"")),j(new Date((s.reminderAt||s.timestamp)-6e4*new Date().getTimezoneOffset()).toISOString().slice(0,16)),S(s.reminderRepeat||"none"),C(!1),A(!1))},[s]);let z=(0,r.useMemo)(()=>{let e=Date.parse(w);return Number.isNaN(e)?"":new Date(e).toLocaleString("vi-VN",{hour12:!1})},[w]),V=(0,r.useMemo)(()=>{switch(N){case"daily":return"Hàng ngày";case"weekly":return"Hàng tuần";case"monthly":return"Hàng tháng";default:return"Không lặp lại"}},[N]),G=(0,r.useMemo)(()=>{if(!s)return{name:"",avatar:null};let e=s.sender,t="object"==typeof e&&e?String(e._id||e.id||""):String(e||""),r=(p&&u.members||[]).find(e=>String(e._id||e.id||"")===t),n=(f||[]).find(e=>String(e._id||e.id||"")===t),i="object"==typeof e&&e?e:void 0,a=r?.avatar||n?.avatar||i?.avatar||null,l=i?.name||r?.name||n?.name||"";return{name:t&&String(g._id)===t?"Bạn":l||"Người dùng",avatar:a}},[s,p,u,f,g._id]);if(!e||!s)return null;let W=async()=>{let e=Date.parse(w);if(!(!y.trim()||Number.isNaN(e))){T(!0);try{await (0,B.updateMessageApi)(String(s._id),{content:y.trim(),reminderAt:e,reminderFired:!1,reminderRepeat:N});let t=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),r=p?null:String(u._id),i=p&&u.members||[];t.emit("edit_message",{_id:s._id,roomId:b,sender:String(g._id),senderName:g.name,isGroup:p,receiver:r,members:i,content:y.trim(),newContent:y.trim(),editedAt:Date.now(),originalContent:s.content,reminderAt:e,reminderFired:!1,reminderRepeat:N});let a=g.name,l=new Date(e).toLocaleString("vi-VN"),d=await (0,B.createMessageApi)({roomId:b,sender:String(g._id),type:"notify",content:`${a} đ\xe3 chỉnh sửa lịch hẹn: "${y.trim()}" l\xfac ${l}`,timestamp:Date.now(),replyToMessageId:String(s._id)});d?.success&&"string"==typeof d._id&&t.emit("send_message",{_id:d._id,roomId:b,sender:String(g._id),senderName:g.name,isGroup:p,receiver:r,members:i,type:"notify",content:`${a} đ\xe3 chỉnh sửa lịch hẹn: "${y.trim()}" l\xfac ${l}`,timestamp:Date.now(),replyToMessageId:String(s._id)}),t.disconnect(),c&&c(),o()}catch(e){console.error("❌ Lỗi khi lưu lịch hẹn:",e),alert("Không thể lưu lịch hẹn. Vui lòng thử lại.")}finally{T(!1)}}},X=async()=>{if(confirm("Bạn có chắc muốn xóa vĩnh viễn lịch hẹn này?")){T(!0);try{await (0,B.deleteMessageApi)(String(s._id));let e=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),t=p?null:String(u._id),r=p&&u.members||[];e.emit("message_deleted",{_id:s._id,roomId:b,sender:String(g._id),senderName:g.name,isGroup:p,receiver:t,members:r,type:"delete",timestamp:Date.now()});let i=g.name,a=await (0,B.createMessageApi)({roomId:b,sender:String(g._id),type:"notify",content:`${i} đ\xe3 x\xf3a lịch hẹn: "${String(s.content||"")}"`,timestamp:Date.now(),replyToMessageId:String(s._id)});a?.success&&"string"==typeof a._id&&e.emit("send_message",{_id:a._id,roomId:b,sender:String(g._id),senderName:g.name,isGroup:p,receiver:t,members:r,type:"notify",content:`${i} đ\xe3 x\xf3a lịch hẹn: "${String(s.content||"")}"`,timestamp:Date.now(),replyToMessageId:String(s._id)}),e.disconnect(),o()}catch(e){console.error("❌ Lỗi khi xóa lịch hẹn:",e),alert("Không thể xóa lịch hẹn. Vui lòng thử lại.")}finally{T(!1)}}},J=(0,t.jsx)("div",{className:`${P?"absolute inset-0":"fixed inset-0"} z-[50] flex items-stretch justify-center ${P?"bg-black/20":"bg-black/50"} backdrop-blur-sm`,children:(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none overflow-hidden flex flex-col",children:[(0,t.jsx)("div",{className:"p-3 bg-gray-100 text-black w-full",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center ",children:[(0,t.jsx)("button",{onClick:o,disabled:_,className:"p-2 cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5 md:w-6 md:h-6"})}),(0,t.jsx)("h3",{className:"text-lg md:text-2xl ",children:k?"Sửa nhắc hẹn":"Chi tiết nhắc hẹn"})]}),k?(0,t.jsx)("button",{onClick:W,disabled:_||!F||!D,className:`px-4 py-1.5 font-bold cursor-pointer ${_||!F||!D?"text-gray-400":"text-blue-600"}`,children:"Xong"}):(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("button",{onClick:()=>C(!0),className:"p-2 rounded-xl hover:bg-gray-200 cursor-pointer",title:"Sửa",children:(0,t.jsx)(x.HiOutlinePencil,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{onClick:()=>A(e=>!e),className:"p-2 rounded-xl hover:bg-gray-200 cursor-pointer",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5"})}),M&&(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-36 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-10",children:[(0,t.jsx)("button",{onClick:()=>{A(!1),C(!0)},className:"w-full px-4 py-2 text-left hover:bg-gray-50",children:"Sửa"}),(0,t.jsx)("button",{onClick:()=>{A(!1),X()},className:"w-full px-4 py-2 text-left text-red-600 hover:bg-red-50",children:"Xóa"})]})]})]})]})}),k?(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,t.jsxs)("div",{className:"divide-y divide-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-4",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-3xl overflow-hidden ring-4 ring-white shadow-2xl",children:G.avatar?(0,t.jsx)(a.default,{width:32,height:32,src:(0,h.getProxyUrl)(G.avatar),alt:G.name,className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xs flex items-center justify-center",children:(G.name||"N").charAt(0).toUpperCase()})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)("div",{className:"text-gray-800 text-xl",children:G.name})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-4",children:[(0,t.jsx)(x.HiBellAlert,{className:"w-6 h-6 text-rose-600"}),(0,t.jsx)("input",{value:y,onChange:e=>v(e.target.value),className:"flex-1 bg-transparent outline-none text-[15px]",placeholder:"Nhập tiêu đề nhắc hẹn...",type:"text"})]}),(0,t.jsxs)("button",{className:"w-full text-left flex items-center gap-3 px-4 py-4 cursor-pointer",onClick:()=>L(!0),children:[(0,t.jsx)(x.HiOutlineClock,{className:"w-6 h-6 text-gray-700"}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)("div",{className:"text-gray-800 text-xl",children:z})})]}),(0,t.jsxs)("button",{className:"w-full text-left flex items-center gap-3 px-4 py-4 cursor-pointer",onClick:()=>$(!0),children:[(0,t.jsx)(x.HiOutlineClock,{className:"w-6 h-6 text-gray-700"}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("div",{className:"text-gray-800 text-[15px]",children:"Chọn kiểu lặp lại"}),(0,t.jsx)("div",{className:"text-gray-500 text-xs",children:V})]})]})]})}):(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-4",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-3xl overflow-hidden ring-4 ring-white shadow-2xl",children:G.avatar?(0,t.jsx)(a.default,{width:32,height:32,src:(0,h.getProxyUrl)(G.avatar),alt:G.name,className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xl flex items-center justify-center",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:G.name||"User",width:38,height:38,className:"w-full h-full rounded-full object-cover"})})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)("div",{className:"text-gray-800 text-xl",children:G.name})})]}),(0,t.jsxs)("div",{className:"divide-y divide-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-start gap-3 px-4 py-4",children:[(0,t.jsx)(x.HiBellAlert,{className:"w-6 h-6 text-rose-600 shrink-0"}),(0,t.jsx)("p",{className:"flex-1 min-w-0 text-xl text-gray-800 whitespace-pre-wrap break-words",children:y})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-4",children:[(0,t.jsx)(x.HiOutlineClock,{className:"w-6 h-6 text-gray-700"}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("div",{className:"text-gray-800 text-xl",children:z}),(0,t.jsxs)("div",{className:"text-gray-500 text-lg",children:["Lặp: ",V]})]})]})]})]}),E&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-end bg-black/40",onClick:()=>$(!1),children:(0,t.jsxs)("div",{className:"w-full bg-white rounded-t-2xl p-4",onClick:e=>{e.stopPropagation()},children:[(0,t.jsxs)("div",{className:"flex items-center justify-between pb-2",children:[(0,t.jsx)("p",{className:"font-semibold",children:"Chọn kiểu lặp lại"}),(0,t.jsx)("button",{onClick:()=>$(!1),className:"px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 cursor-pointer",children:"Xong"})]}),(0,t.jsx)("div",{className:"space-y-2",children:[{key:"none",label:"Không lặp lại"},{key:"daily",label:"Hàng ngày"},{key:"weekly",label:"Hàng tuần"},{key:"monthly",label:"Hàng tháng"}].map(e=>(0,t.jsxs)("label",{className:"flex items-center gap-3 px-3 py-2 rounded-xl border border-gray-200 cursor-pointer",children:[(0,t.jsx)("input",{type:"radio",name:"repeat",checked:N===e.key,onChange:()=>S(e.key)}),(0,t.jsx)("span",{children:e.label})]},e.key))})]})}),I&&(0,t.jsx)("div",{className:"fixed inset-0 z-[10000] flex items-end bg:black/40",onClick:()=>L(!1),children:(0,t.jsxs)("div",{className:"w-full bg-white rounded-t-2xl p-4 space-y-3",onClick:e=>{e.stopPropagation()},children:[(0,t.jsx)("div",{className:"px-1",children:(0,t.jsx)("input",{type:"datetime-local",value:w,onChange:e=>j(e.target.value),className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"})}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{onClick:()=>L(!1),className:"px-3 py-2 rounded-xl bg-blue-600 text-white font-semibold cursor-pointer",children:"Chọn"})})]})})]})}),K=P&&"undefined"!=typeof document?document.getElementById("right-sidebar-container"):null;return P&&K?(0,l.createPortal)(J,K):J}function V({onClose:e,embedded:s=!1}){let{selectedChat:a,currentUser:l,isGroup:o}=O(),c=(0,r.useMemo)(()=>{let e=String(l._id),t=String(a._id);return o?t:[e,t].sort().join("_")},[o,a,l]),[d,m]=(0,r.useState)([]),[u,g]=(0,r.useState)(!1),[p,f]=(0,r.useState)(!1),[b,y]=(0,r.useState)(null),[v,w]=(0,r.useState)(null),N=(0,r.useRef)(new Map),[k,C]=(0,r.useState)(!1),_=(0,r.useCallback)(async()=>{try{g(!0);let e=await (0,B.readMessagesApi)(c,{limit:200,sortOrder:"desc",extraFilters:{type:"reminder",isRecalled:{$ne:!0}}}),t=Array.isArray(e.data)?e.data:[];m(t)}catch(e){console.error("❌ Lỗi khi tải danh sách lịch hẹn:",e)}finally{g(!1)}},[c]);(0,r.useEffect)(()=>{_()},[_]),(0,r.useEffect)(()=>{let e=e=>{if(!v)return;let t=N.current.get(v);t&&!t.contains(e.target)&&w(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[v]),(0,r.useEffect)(()=>{let e=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});return e.emit("join_room",c),e.on("receive_message",e=>{e.roomId===c&&"reminder"===e.type&&m(t=>{let r=new Map;return[...t,e].forEach(e=>r.set(String(e._id),e)),Array.from(r.values()).sort((e,t)=>Number(t.timestamp)-Number(e.timestamp))})}),e.on("message_edited",e=>{e.roomId===c&&(m(t=>t.map(t=>String(t._id)===String(e._id)?{...t,content:e.content,editedAt:e.editedAt,originalContent:e.originalContent||t.originalContent||t.content,reminderAt:e.reminderAt??t.reminderAt,reminderNote:e.reminderNote??t.reminderNote}:t)),_())}),e.on("edit_message",e=>{e.roomId===c&&(m(t=>t.map(t=>String(t._id)===String(e._id)?{...t,content:e.newContent,editedAt:e.editedAt,originalContent:e.originalContent||t.originalContent||t.content}:t)),_())}),e.on("message_recalled",e=>{e.roomId===c&&(m(t=>t.filter(t=>String(t._id)!==String(e._id))),_())}),e.on("message_deleted",e=>{e.roomId===c&&(m(t=>t.filter(t=>String(t._id)!==String(e._id))),_())}),()=>{e.disconnect()}},[c,_]);let T=async({content:e,dateTime:t,note:r,repeat:s})=>{C(!0);let i=Date.parse(t);if(!e.trim()||Number.isNaN(i))return void alert("Vui lòng nhập đầy đủ thông tin hợp lệ");try{let t=await (0,B.createMessageApi)({roomId:c,sender:String(l._id),type:"reminder",content:e.trim(),timestamp:Date.now(),reminderAt:i,reminderNote:r?.trim()||"",reminderFired:!1,reminderRepeat:s||"none"});if(t?.success){let d=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),m=o?null:String(a._id),u=o&&a.members||[],x={roomId:c,sender:String(l._id),senderName:l.name,isGroup:o,receiver:m,members:u};"string"==typeof t._id&&d.emit("send_message",{...x,_id:t._id,type:"reminder",content:e.trim(),timestamp:Date.now(),reminderAt:i,reminderNote:r?.trim()||"",reminderFired:!1,reminderRepeat:s||"none"});let g=new Date(i).toLocaleString("vi-VN"),p=l.name,f=await (0,B.createMessageApi)({roomId:c,sender:String(l._id),type:"notify",content:`${p} đ\xe3 tạo lịch hẹn: "${e.trim()}" l\xfac ${g}`,timestamp:Date.now()});f?.success&&"string"==typeof f._id&&d.emit("send_message",{...x,_id:f._id,type:"notify",content:`${p} đ\xe3 tạo lịch hẹn: "${e.trim()}" l\xfac ${g}`,timestamp:Date.now()}),d.disconnect(),await _()}else alert("Tạo lịch hẹn thất bại. Vui lòng kiểm tra kết nối máy chủ.");C(!1)}catch(e){console.error("❌ Lỗi khi tạo lịch hẹn:",e),alert("Không thể tạo lịch hẹn. Vui lòng thử lại.")}f(!1)},M=async e=>{if(confirm("Xóa vĩnh viễn lịch hẹn này?"))try{await (0,B.deleteMessageApi)(String(e._id));let t=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});t.emit("message_deleted",{_id:e._id,roomId:c}),t.disconnect(),w(null),await _()}catch(e){console.error("❌ Lỗi khi xóa lịch hẹn:",e),alert("Không thể xóa lịch hẹn. Vui lòng thử lại.")}},A=e=>{y(e),w(null)};return(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:"relative flex flex-col h-full bg-gray-50 overflow-hidden",children:[!s&&(0,t.jsxs)("div",{className:"bg-blue-400 text-white p-3 flex items-center justify-between shadow-lg",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold",children:"Danh sách lịch hẹn"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>f(!0),className:"px-3 py-2 cursor-pointer rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 flex items-center gap-2",children:(0,t.jsx)(j.FaRegClock,{})}),(0,t.jsx)("button",{onClick:e,className:"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300",children:(0,t.jsx)("div",{className:"space-y-5 p-5",children:u?(0,t.jsxs)("div",{className:"text-center text-gray-500 py-10",children:[(0,t.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"}),(0,t.jsx)("p",{className:"mt-2",children:"Đang tải..."})]}):0===d.length?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"flex items-center justify-center",children:(0,t.jsx)(S.IoCalendarOutline,{className:"w-[8.125rem] h-[8.125rem] text-blue-300"})}),(0,t.jsx)("p",{className:"text-center text-sm text-gray-500",children:"Chưa có lịch hẹn nào được chia sẻ trong cuộc hội thoại này"}),(0,t.jsx)("div",{className:"flex items-center justify-center",children:(0,t.jsxs)("button",{onClick:()=>f(!0),className:"px-3 py-2 cursor-pointer hover:bg-blue-400 transition-all duration-200 flex items-center gap-2 bg-blue-300 rounded-lg ",children:[(0,t.jsx)(j.FaRegClock,{})," Tạo lịch hẹn mới"]})})]}):d.map(e=>{let r=String(e._id),s=new Date("number"==typeof e.reminderAt?e.reminderAt:e.timestamp).toLocaleString("vi-VN"),n=e.sender,i="object"==typeof n&&n&&n.name||"",a=e.reminderRepeat||"none",l=v===r;return(0,t.jsx)("div",{className:"relative p-4 rounded-2xl bg-white border border-gray-100 shadow-sm hover:shadow-md transition-shadow",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-base font-semibold text-gray-900 truncate",children:e.content||"Lịch hẹn"}),(0,t.jsxs)("p",{className:"text-sm text-gray-500 mt-1 flex items-center gap-1",children:[(0,t.jsx)(j.FaRegClock,{className:"w-3 h-3"})," ",s]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Lặp: ","daily"===a?"Hàng ngày":"weekly"===a?"Hàng tuần":"monthly"===a?"Hàng tháng":"Không lặp lại"]}),e.reminderNote?(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded-lg truncate",children:String(e.reminderNote)}):null,i?(0,t.jsxs)("p",{className:"text-xs text-gray-400 mt-2",children:["Tạo bởi ",i]}):null]}),(0,t.jsxs)("div",{className:"relative",ref:e=>{e?N.current.set(r,e):N.current.delete(r)},children:[(0,t.jsx)("button",{onClick:()=>w(l?null:r),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer","aria-label":"Mở menu",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5 text-gray-600"})}),l&&(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-40 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-10 animate-in fade-in slide-in-from-top-2 duration-200",children:[(0,t.jsxs)("button",{onClick:()=>A(e),className:"w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer flex items-center gap-2",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Xem chi tiết"]}),(0,t.jsxs)("button",{onClick:()=>A(e),className:"w-full px-4 py-2.5 text-left text-sm text-blue-600 hover:bg-blue-50 transition-colors cursor-pointer flex items-center gap-2",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Chỉnh sửa"]}),(0,t.jsxs)("button",{onClick:()=>M(e),className:"w-full px-4 py-2.5 text-left text-sm text-red-600 hover:bg-red-50 transition-colors cursor-pointer flex items-center gap-2",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Xóa"]})]})]})]})},r)})})}),(0,t.jsx)(F,{isOpen:p,onClose:()=>f(!1),onCreate:T,createLoading:k}),(0,t.jsx)(z,{isOpen:!!b,message:b,onClose:()=>y(null),onRefresh:_})]})})}let G=({size:e=24,className:r="",onClick:s})=>(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",width:e,height:e,fill:"none",stroke:"currentColor",strokeWidth:18,strokeLinecap:"round",strokeLinejoin:"round",className:r,onClick:s,children:(0,t.jsx)("path",{d:"M499.505,128.508l-72.045-72.045c-3.163-3.162-8.293-3.162-11.455,0   c-3.163,3.164-3.163,8.293,0,11.456l72.045,72.044   c10.2,10.201,10.2,27.222,0,37.422c-10.201,10.2-27.221,10.2-37.421-0.001   L334.614,61.371c-10.2-10.199-10.2-27.22,0-37.419   c10.2-10.201,27.221-10.201,37.421,0l23.986,23.984   c3.163,3.162,8.293,3.163,11.455-0.001c3.163-3.163,3.163-8.293,0-11.455   l-23.984-23.984C375.434,4.438,364.721,0,353.324,0   c-11.396,0-22.108,4.438-30.167,12.495   c-8.057,8.058-12.495,18.771-12.495,30.167   c0,8.646,2.56,16.895,7.312,23.894L204.956,179.574   c-3.392-1.254-6.81-2.441-10.263-3.52   c-31.896-9.958-66.224-12.369-99.277-6.976   c-6.383,1.041-9.004,9.14-4.423,13.723l95.046,95.046   l-25.347,25.347c-3.163,3.165-3.163,8.293,0,11.456   c3.163,3.162,8.293,3.162,11.455,0l25.347-25.347   l25.203,25.202L58.708,478.495l-37.804,12.602   l12.601-37.804l120.011-120.011c3.163-3.164,3.163-8.293,0-11.456   c-3.163-3.162-8.293-3.162-11.455,0L20.697,443.19   c-0.889,0.889-1.56,1.973-1.957,3.167L0.411,501.343   c-2.069,6.207,4.033,12.317,10.246,10.246l54.987-18.329   c1.192-0.397,2.277-1.067,3.167-1.957l165.341-165.341   l95.047,95.046c4.583,4.583,12.681,1.954,13.723-4.424   c5.394-33.054,2.981-67.384-6.976-99.277   c-1.078-3.453-2.266-6.87-3.52-10.264l113.019-113.019   c6.999,4.752,15.248,7.312,23.894,7.312   c11.396,0,22.108-4.438,30.167-12.495   c8.057-8.058,12.495-18.771,12.495-30.167   S507.562,136.566,499.505,128.508z"})});function W({isOpen:e,onClose:s,onCreate:n}){let a,o,c,[d,m]=(0,r.useState)(""),[u,h]=(0,r.useState)(["",""]),[x,g]=(0,r.useState)(!1),p=window.matchMedia("(min-width: 768px)").matches,[f,b]=(0,r.useState)(!0),[y,v]=(0,r.useState)(!0),[w,j]=(0,r.useState)(!1),[N,S]=(0,r.useState)(!1),[k,C]=(0,r.useState)(null),[_,T]=(0,r.useState)(!1),[M,A]=(0,r.useState)(k?"time":"none"),[E,$]=(0,r.useState)("");if(!e)return null;let I=async()=>{let e=d.trim(),t=u.map(e=>e.trim()).filter(e=>e),r=Array.from(new Set(t.map(e=>e.toLowerCase()))).map(e=>t.find(t=>t.toLowerCase()===e));if(e&&!(r.length<2)){g(!0);try{await n({question:e,options:r,pollAllowMultiple:f,pollAllowAddOptions:y,pollHideVoters:w,pollHideResultsUntilVote:N,pollEndAt:k??null}),m(""),h(["",""]),b(!0),v(!0),j(!1),S(!1),C(null),A("none"),$(""),T(!1)}finally{g(!1)}}},L=(0,t.jsx)("div",{className:`${p?"absolute inset-0":"fixed inset-0"} z-[50] flex items-stretch justify-center ${p?"bg-black/20":"bg-black/50"} backdrop-blur-sm`,children:(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none overflow-hidden flex flex-col",children:[(0,t.jsx)("div",{className:" px-4 pt-3 pb-2  text-black bg-gray-50 flex-shrink-0 border-b border-gray-200",children:(0,t.jsxs)("div",{className:"flex gap-3 items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("button",{onClick:s,disabled:x,className:" cursor-pointer  ",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})}),(0,t.jsx)("div",{className:"flex items-center gap-3 ",children:(0,t.jsx)("h3",{className:"text-xl ",children:"Tạo bình chọn"})})]}),(0,t.jsx)("button",{onClick:I,disabled:x||!d.trim()||new Set(u.map(e=>e.trim()).filter(e=>e).map(e=>e.toLowerCase())).size<2,className:" cursor-pointer hover:text-blue-700 text-blue-500 font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed",children:(0,t.jsx)("span",{className:" justify-end gap-2",children:x?"Đang tạo...":"Tạo"})})]})}),(0,t.jsxs)("div",{className:"px-4 py-4 space-y-4 flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Câu hỏi *"}),(0,t.jsx)("textarea",{value:d,onChange:e=>m(e.target.value),rows:3,placeholder:"Đặt câu hỏi bình chọn",className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white"}),(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tùy chọn *"}),(0,t.jsx)("div",{className:"space-y-2",children:u.map((e,r)=>(0,t.jsx)("input",{placeholder:`Phương \xe1n ${r+1}`,type:"text",value:e,onChange:e=>{var t;return t=e.target.value,void h(e=>e.map((e,s)=>s===r?t:e))},className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white"},r))}),(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("button",{onClick:()=>{h(e=>e.length>=10?e:[...e,""])},disabled:u.length>=10,className:"cursor-pointer px-4 py-2 mb-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed",children:"Thêm lựa chọn"}),(0,t.jsxs)("p",{className:"text-xs px-4 text-gray-500",children:["Cần tối thiểu 2 lựa chọn. Tối đa ",10," lựa chọn."]})]}),(c=(o=new Set((a=u.map(e=>e.trim()).filter(e=>e)).map(e=>e.toLowerCase())).size)!==a.length,(0,t.jsxs)(t.Fragment,{children:[o<2&&(0,t.jsx)("p",{className:"text-xs px-4 text-gray-500",children:"Cần ít nhất 2 lựa chọn hợp lệ"}),c&&(0,t.jsx)("p",{className:"text-xs px-4 text-gray-500",children:"Các lựa chọn trùng lặp sẽ được tự loại bỏ"})]})),(0,t.jsxs)("div",{className:"mt-4 pt-4 border-t border-gray-200 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-700",children:"Đặt thời hạn"}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:k?new Date(k).toLocaleString("vi-VN"):"Không có thời hạn"})]}),(0,t.jsx)("button",{onClick:()=>{T(!0),A(k?"time":"none"),$(k?new Date(k).toISOString().slice(0,16):new Date(Date.now()+72e5).toISOString().slice(0,16))},className:"cursor-pointer px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-xl text-sm font-semibold",children:"Thiết lập"})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:"Ẩn người bình chọn"}),(0,t.jsx)("button",{onClick:()=>j(e=>!e),className:`cursor-pointer w-12 h-6 rounded-full transition ${w?"bg-blue-600":"bg-gray-300"}`,"aria-pressed":w,children:(0,t.jsx)("span",{className:`block ml-0.5  w-5 h-5 bg-white rounded-full transform transition ${w?"translate-x-6":"translate-x-0"}`})})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:"Ẩn kết quả khi chưa bình chọn"}),(0,t.jsx)("button",{onClick:()=>S(e=>!e),className:`cursor-pointer w-12 h-6 rounded-full transition ${N?"bg-blue-600":"bg-gray-300"}`,"aria-pressed":N,children:(0,t.jsx)("span",{className:`block ml-0.5 w-5 h-5 bg-white rounded-full transform transition ${N?"translate-x-6":"translate-x-0"}`})})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:"Chọn nhiều phương án"}),(0,t.jsx)("button",{onClick:()=>b(e=>!e),className:`cursor-pointer w-12 h-6 rounded-full transition ${f?"bg-blue-600":"bg-gray-300"}`,"aria-pressed":f,children:(0,t.jsx)("span",{className:`block ml-0.5 w-5 h-5 bg-white rounded-full transform transition ${f?"translate-x-6":"translate-x-0"}`})})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:"Có thể thêm phương án"}),(0,t.jsx)("button",{onClick:()=>v(e=>!e),className:`cursor-pointer w-12 h-6 rounded-full transition ${y?"bg-blue-600":"bg-gray-300"}`,"aria-pressed":y,children:(0,t.jsx)("span",{className:`block ml-0.5 w-5 h-5 bg-white rounded-full transform transition ${y?"translate-x-6":"translate-x-0"}`})})]})]})]}),_&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/10",onClick:()=>T(!1)}),(0,t.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl border-t border-gray-200 p-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-800",children:"Đặt thời hạn"}),(0,t.jsx)("button",{onClick:()=>T(!1),className:"cursor-pointer text-gray-500",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("label",{className:"cursor-pointer flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"radio",checked:"none"===M,onChange:()=>A("none")}),"Không giới hạn thời gian"]}),(0,t.jsxs)("label",{className:"cursor-pointer flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"radio",checked:"time"===M,onChange:()=>A("time")}),"Chọn thời điểm kết thúc"]}),"time"===M&&(0,t.jsx)("input",{type:"datetime-local",value:E,onChange:e=>$(e.target.value),className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl"}),(0,t.jsxs)("div",{className:"flex gap-3 pt-2",children:[(0,t.jsx)("button",{onClick:()=>{if("none"===M){C(null),T(!1);return}let e=Date.parse(E);Number.isNaN(e)||(C(e),T(!1))},className:"flex-1 cursor-pointer py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold text-sm",children:"Xong"}),(0,t.jsx)("button",{onClick:()=>T(!1),className:"flex-1 cursor-pointer py-2 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold text-sm",children:"Hủy"})]})]})]})]})]})}),P=p&&"undefined"!=typeof document?document.getElementById("right-sidebar-container"):null;return p&&P?(0,l.createPortal)(L,P):L}let X=({size:e=24,className:r="",onClick:s})=>(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:e,height:e,fill:"white",stroke:"currentColor",strokeWidth:.504,strokeLinecap:"round",strokeLinejoin:"round",className:r,onClick:s,children:[(0,t.jsx)("path",{d:"M20.5001 6H3.5"}),(0,t.jsx)("path",{d:"M18.8332 8.5L18.3732 15.3991   C18.1962 18.054 18.1077 19.3815 17.2427 20.1907   C16.3777 21 15.0473 21 12.3865 21H11.6132   C8.95235 21 7.62195 21 6.75694 20.1907   C5.89194 19.3815 5.80344 18.054 5.62644 15.3991   L5.1665 8.5"}),(0,t.jsx)("path",{d:"M6.5 6   C6.55588 6 6.58382 6 6.60915 5.99936   C7.43259 5.97849 8.15902 5.45491 8.43922 4.68032   C8.44784 4.65649 8.45667 4.62999 8.47434 4.57697   L8.57143 4.28571   C8.65431 4.03708 8.69575 3.91276 8.75071 3.8072   C8.97001 3.38607 9.37574 3.09364 9.84461 3.01877   C9.96213 3 10.0932 3 10.3553 3H13.6447   C13.9068 3 14.0379 3 14.1554 3.01877   C14.6243 3.09364 15.03 3.38607 15.2493 3.8072   C15.3043 3.91276 15.3457 4.03708 15.4286 4.28571   L15.5257 4.57697   C15.5433 4.62992 15.5522 4.65651 15.5608 4.68032   C15.841 5.45491 16.5674 5.97849 17.3909 5.99936   C17.4162 6 17.4441 6 17.5 6"})]});function J({isOpen:e,message:s,onClose:o,onRefresh:c}){let d,m,u,g,{selectedChat:p,currentUser:f,isGroup:b}=O(),y=(d=String(f._id),m=String(p._id),b?m:[d,m].sort().join("_")),[v,w]=(0,r.useState)(""),[j,N]=(0,r.useState)([]),[S,k]=(0,r.useState)(!1),[C,_]=(0,r.useState)(!1),T=String(f._id),M=window.matchMedia("(min-width: 768px)").matches,A=(0,r.useMemo)(()=>s?.pollVotes||{},[s]),E=(0,r.useMemo)(()=>{let e=[];return(s?.pollOptions||[]).forEach(t=>{(Array.isArray(A[t])?A[t]:[]).includes(T)&&e.push(t)}),e},[A,s,T]),[$,I]=(0,r.useState)([]),[L,P]=(0,r.useState)(!1),[H,U]=(0,r.useState)(""),[R,D]=(0,r.useState)(!1),[F,z]=(0,r.useState)(!1),[V,G]=(0,r.useState)(""),[W,J]=(0,r.useState)(!1),[K,q]=(0,r.useState)(!1),[Q,Y]=(0,r.useState)(!1),[Z,ee]=(0,r.useState)(!1),[et,er]=(0,r.useState)(null),[es,en]=(0,r.useState)(!1),[ei,ea]=(0,r.useState)("none"),[el,eo]=(0,r.useState)(""),ec=(0,r.useMemo)(()=>{if(!s)return!1;let e=s.sender;return("object"==typeof e&&e?String(e._id):String(e))===String(f._id)},[s,f._id]),ed=(0,r.useMemo)(()=>s?.pollEndAt?Number(s.pollEndAt):null,[s]),em=(0,r.useMemo)(()=>!!ed&&Date.now()>=ed,[ed]),eu=(0,r.useMemo)(()=>!!(s?.isPollLocked||em),[s?.isPollLocked,em]),eh=(0,r.useMemo)(()=>b&&p.members||[],[b,p]),ex=(0,r.useMemo)(()=>{let e=new Map;return eh.forEach(t=>{let r=String(t._id||t.id||"");r&&e.set(r,{name:t.name,avatar:t.avatar})}),e},[eh]);(0,r.useEffect)(()=>{if(!s)return;let e=String(s.content||s.pollQuestion||""),t=Array.isArray(s.pollOptions)?s.pollOptions:[];w(e),N(t),k(!1),I(E),P(!1),U(""),J(!!s.pollAllowMultiple),q(!!s.pollAllowAddOptions),Y(!!s.pollHideVoters),ee(!!s.pollHideResultsUntilVote),er(s.pollEndAt?Number(s.pollEndAt):null)},[s,E]);let eg=async()=>{if(!s||!ec)return;let e=j.map(e=>e.trim()).filter(e=>e);if(v.trim()&&!(e.length<2)){_(!0);try{let t=Date.now(),r=s.pollVotes||{},i={};e.forEach(e=>{let t=Array.isArray(r[e])?r[e]:[];i[e]=t});let a={content:v.trim(),pollQuestion:v.trim(),pollOptions:e,pollVotes:i,pollAllowMultiple:W,pollAllowAddOptions:K,pollHideVoters:Q,pollHideResultsUntilVote:Z,pollEndAt:et,editedAt:t,timestamp:t};await (0,B.updateMessageApi)(String(s._id),a);let l=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});l.once("connect",async()=>{l.emit("join_room",y);let e=b?null:String(p._id),r=b&&p.members||[];l.emit("edit_message",{_id:s._id,roomId:y,...a,originalContent:s.content,sender:String(f._id),senderName:f.name,isGroup:b,members:r,receiver:e}),l.emit("message_edited",{_id:s._id,roomId:y,...a,originalContent:s.content,sender:String(f._id),senderName:f.name,isGroup:b,members:r,receiver:e});let n=f.name||"Ai đó",i=`${n} đ\xe3 chỉnh sửa b\xecnh chọn: "${v.trim()}"`,o=await (0,B.createMessageApi)({roomId:y,sender:String(f._id),type:"notify",content:i,timestamp:t,replyToMessageId:String(s._id)});o?.success&&l.emit("send_message",{roomId:y,sender:String(f._id),senderName:f.name,isGroup:b,receiver:e,members:r,_id:o._id,type:"notify",content:i,timestamp:t,replyToMessageId:String(s._id)}),setTimeout(()=>l.disconnect(),300)}),c&&await c(),o()}finally{_(!1)}}},ep=(0,r.useMemo)(()=>{let e={};return(s?.pollOptions||[]).forEach(t=>{let r=(Array.isArray(A[t])?[...A[t]]:[]).filter(e=>e!==T),s=$.includes(t);e[t]=s?[...r,T]:r}),e},[s,A,$,T]),ef=(0,r.useMemo)(()=>{let e=new Set;return(s?.pollOptions||[]).forEach(t=>{(Array.isArray(ep[t])?ep[t]:[]).forEach(t=>e.add(String(t)))}),e},[s,ep]),eb=(0,r.useMemo)(()=>{let e=0;return(s?.pollOptions||[]).forEach(t=>{let r=Array.isArray(ep[t])?ep[t]:[];e+=r.length}),e},[s,ep]),ey=(0,r.useMemo)(()=>{let e=new Set;return eh.forEach(t=>{let r=String(t._id||t.id||"");r&&e.add(r)}),ef.forEach(t=>e.delete(t)),Array.from(e)},[eh,ef]),ev=async()=>{if(!s||eu)return;let e=s.pollVotes||{},t={};(s.pollOptions||[]).forEach(r=>{let s=(Array.isArray(e[r])?[...e[r]]:[]).filter(e=>e!==T);t[r]=s}),$.forEach(e=>{let r=Array.isArray(t[e])?t[e]:[];r.includes(T)||(t[e]=[...r,T])}),_(!0);try{let e=Date.now();await (0,B.updateMessageApi)(String(s._id),{pollVotes:t,editedAt:e,timestamp:e});let r=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});r.once("connect",async()=>{r.emit("join_room",y),r.emit("edit_message",{_id:s._id,roomId:y,pollVotes:t,editedAt:e,timestamp:e});let n=b?null:String(p._id),i=b&&p.members||[],a=s.pollHideVoters?"Một thành viên":f.name||"Ai đó",l=$.join(", "),o=`${a} đ\xe3 b\xecnh chọn:  ${l} trong b\xecnh chọn: "${v}"`,c=await (0,B.createMessageApi)({roomId:y,sender:T,type:"notify",content:o,timestamp:e,replyToMessageId:String(s._id)});c?.success&&r.emit("send_message",{roomId:y,sender:T,senderName:f.name,isGroup:b,receiver:n,members:i,_id:c._id,type:"notify",content:o,timestamp:e,replyToMessageId:String(s._id)}),setTimeout(()=>r.disconnect(),300)}),c&&await c(),o()}finally{_(!1)}},ew=async()=>{if(!s||eu)return;let e=H.trim();if(!e)return;if(j.map(e=>e.toLowerCase()).includes(e.toLowerCase())){P(!1),U("");return}let t=[...j,e];_(!0);try{let r=Date.now();await (0,B.updateMessageApi)(String(s._id),{pollOptions:t,editedAt:r,timestamp:r});let i=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});i.once("connect",async()=>{i.emit("join_room",y),i.emit("edit_message",{_id:s._id,roomId:y,pollOptions:t,editedAt:r,timestamp:r});let n=b?null:String(p._id),a=b&&p.members||[],l=s.pollHideVoters?"Một thành viên":f.name||"Ai đó",o=`${l} đ\xe3 th\xeam lựa chọn "${e}" trong b\xecnh chọn: "${v}"`,c=await (0,B.createMessageApi)({roomId:y,sender:String(f._id),type:"notify",content:o,timestamp:r,replyToMessageId:String(s._id)});c?.success&&i.emit("send_message",{roomId:y,sender:String(f._id),senderName:f.name,isGroup:b,receiver:n,members:a,_id:c._id,type:"notify",content:o,timestamp:r,replyToMessageId:String(s._id)}),setTimeout(()=>i.disconnect(),300)}),c&&await c(),N(t),P(!1),U("")}finally{_(!1)}},ej=async()=>{if(!s||!ec)return;let e=!(s.isPollLocked||em);if(e||null==s.pollEndAt){_(!0);try{let t=Date.now(),r=e?{isPollLocked:!0,pollLockedAt:t,editedAt:t,timestamp:t}:{isPollLocked:!1,editedAt:t,timestamp:t};await (0,B.updateMessageApi)(String(s._id),r);let i=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});i.emit("edit_message",{_id:s._id,roomId:y,...r});let a=f.name;if(e){let e=b?null:String(p._id),r=b&&p.members||[],n=new Date(t).toLocaleString("vi-VN"),l=`${a} đ\xe3 kh\xf3a b\xecnh chọn: "${String(s.content||s.pollQuestion||"")}" (kết th\xfac l\xfac ${n})`,o=await (0,B.createMessageApi)({roomId:y,sender:String(f._id),type:"notify",content:l,timestamp:t,replyToMessageId:String(s._id)});o?.success&&i.emit("send_message",{roomId:y,sender:String(f._id),senderName:f.name,isGroup:b,receiver:e,members:r,_id:o._id,type:"notify",content:l,timestamp:t,replyToMessageId:String(s._id)})}else{let e=b?null:String(p._id),r=b&&p.members||[],n=`${a} đ\xe3 mở kh\xf3a b\xecnh chọn: "${String(s.content||s.pollQuestion||"")}"`,l=await (0,B.createMessageApi)({roomId:y,sender:String(f._id),type:"notify",content:n,timestamp:t,replyToMessageId:String(s._id)});l?.success&&i.emit("send_message",{roomId:y,sender:String(f._id),senderName:f.name,isGroup:b,receiver:e,members:r,_id:l._id,type:"notify",content:n,timestamp:t,replyToMessageId:String(s._id)})}i.disconnect(),c&&await c(),o()}finally{_(!1)}}};if(!e||!s)return null;let eN=(0,t.jsx)("div",{className:`${M?"absolute inset-0":"fixed inset-0"} z-[50] flex items-stretch justify-center ${M?"bg-black/20":"bg-black/50"} backdrop-blur-sm`,children:(0,t.jsxs)("div",{className:"bg-white w-full h-full rounded-none overflow-hidden flex flex-col relative",children:[(0,t.jsx)("div",{className:"px-3 pt-3 pb-2 bg-white text-black border-b border-gray-200 relative",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("button",{onClick:o,disabled:C,className:"cursor-pointer p-2",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})}),(0,t.jsx)("div",{className:"flex items-center gap-3",children:(0,t.jsx)("h3",{className:"text-xl",children:"Bình chọn"})})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{onClick:()=>D(e=>!e),className:"p-2 rounded-xl hover:bg-gray-100 cursor-pointer",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5"})}),R&&(0,t.jsx)("div",{className:"absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-2xl shadow-2xl z-[100]",children:ec&&!(null!=s.pollEndAt&&em)&&(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("button",{onClick:()=>{D(!1),k(!0)},className:"w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-800 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:"Chỉnh sửa bình chọn"}),(0,t.jsx)("button",{onClick:()=>{D(!1),ej()},className:"w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-800 cursor-pointer",children:s.isPollLocked||em?"Mở khóa bình chọn":"Khóa bình chọn"})]})})]})]})}),(0,t.jsx)("div",{className:"px-6 py-5 space-y-4 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:(u=!(s?.pollHideResultsUntilVote&&0===E.length),S?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Câu hỏi *"}),(0,t.jsx)("textarea",{value:v,onChange:e=>w(e.target.value),rows:3,className:"w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-blue-500 focus:bg-white"}),(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tùy chọn *"}),(0,t.jsx)("div",{className:"space-y-2",children:j.map((e,r)=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"text",value:e,onChange:e=>{var t;return t=e.target.value,void N(e=>e.map((e,s)=>s===r?t:e))},className:"flex-1 px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-blue-500 focus:bg-white"}),(0,t.jsx)("button",{onClick:()=>{N(e=>e.filter((e,t)=>t!==r))},className:"px-3 py-2 cursor-pointer  text-red-600  disabled:opacity-50 disabled:cursor-not-allowed",children:(0,t.jsx)(X,{className:"w-10 h-10"})})]},r))}),(0,t.jsx)("button",{onClick:()=>{N(e=>[...e,""])},className:"cursor-pointer px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-xl font-semibold text-sm",children:"+ Thêm lựa chọn"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{className:"text-[1rem] text-gray-800 whitespace-pre-wrap break-words",children:v}),eu&&(0,t.jsxs)("p",{className:"text-[1rem] text-gray-500 mt-1",children:["Kết thúc lúc"," ",new Date(ed||s.pollLockedAt||s.editedAt||s.timestamp).toLocaleString("vi-VN")]}),(0,t.jsxs)("p",{className:"text-sm text-gray-500 mt-2 space-y-2",children:[(0,t.jsx)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:s.pollAllowMultiple?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiListBullet,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn nhiều phương án"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiCheckCircle,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn 1 phương án"})]})}),s.pollHideVoters&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiEyeSlash,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn người bình chọn"})]}),s.pollAllowAddOptions&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiPlus,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Cho phép thêm phương án"})]}),s.pollHideResultsUntilVote&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiLockClosed,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn kết quả khi chưa bình chọn"})]})]}),(0,t.jsx)("div",{className:"border-t border-gray-200"}),s?.pollHideVoters||!u?null:(0,t.jsx)("button",{onClick:()=>z(!0),className:"cursor-pointer text-sm text-blue-600 hover:underline mt-2",children:`${ef.size} người đ\xe3 b\xecnh chọn`}),!u&&(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"Bình chọn để xem kết quả"}),(0,t.jsx)("div",{className:"space-y-2 mt-2",children:j.map((e,r)=>{let n=Array.isArray(ep[e])?ep[e].length:0,i=$.includes(e),l=Array.isArray(ep[e])?ep[e]:[],o=l.length?String(l[l.length-1]):"",c=o?ex.get(o):void 0,d=u&&eb>0?n/eb*100:0;return(0,t.jsxs)("button",{onClick:()=>(e=>{if(eu)return;let t=!!s?.pollAllowMultiple;I(r=>{let s=r.includes(e);return t?s?r.filter(t=>t!==e):[...r,e]:s?[]:[e]})})(e),disabled:eu,className:`w-full cursor-pointer relative bg-gray-100 overflow-hidden px-4 py-3 rounded-xl  text-left transition-colors ${eu?"opacity-50 cursor-not-allowed":""}`,children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 bottom-0 transition-all duration-500 ease-out bg-blue-200",style:{width:`${d}%`}}),(0,t.jsxs)("div",{className:"flex items-center gap-3 relative z-10 w-full",children:[(0,t.jsx)("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded-full border ${i?"bg-blue-600 text-white border-blue-600":"border-gray-400"}`,children:i&&(0,t.jsx)(x.HiCheck,{className:"w-3 h-3"})}),(0,t.jsx)("span",{className:"flex-1 min-w-0 text-[1rem] leading-relaxed break-words whitespace-pre-wrap",children:e}),u&&(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-xs text-gray-500",children:n}),!s?.pollHideVoters&&o?c?.avatar?(0,t.jsx)("div",{className:"w-6 h-6 rounded-full border-2 border-white overflow-hidden bg-gray-200",title:c?.name,children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(c.avatar),alt:"",width:24,height:24,className:"w-full h-full object-cover"})}):(0,t.jsx)("div",{title:c?.name,className:"w-6 h-6 rounded-full border-2 border-white bg-blue-500 text-white flex items-center justify-center font-bold text-[10px]",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:"",width:64,height:64,className:"w-full h-full object-cover"})}):null]})]})]},r)})}),(0,t.jsx)("div",{className:"mt-3",children:L?(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{value:H,onChange:e=>U(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),ew())},className:"flex-1 px-3 py-2 bg-gray-50 outline-none border-2 border-gray-200 rounded-2xl",placeholder:"Nhập lựa chọn"}),(0,t.jsx)("button",{onClick:ew,disabled:eu,className:"px-2 py-2 cursor-pointer bg-blue-600 text-white rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed",children:"+"}),(0,t.jsx)("button",{onClick:()=>{P(!1),U("")},className:"px-2 py-2 text-red-600 cursor-pointer bg-red-50 rounded-2xl",children:(0,t.jsx)(X,{className:"text-red-600"})})]}):s?.pollAllowAddOptions&&!eu?(0,t.jsx)("button",{onClick:()=>{P(!0)},className:"cursor-pointer px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-xl font-semibold text-sm",children:"+ Thêm phương án"}):null})]}))}),(0,t.jsx)("div",{className:"px-6 pb-6 pt-2 border-t border-gray-200 flex-shrink-0",children:S?(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{onClick:()=>{if(k(!1),s){let e=String(s.content||s.pollQuestion||""),t=Array.isArray(s.pollOptions)?s.pollOptions:[];w(e),N(t)}},disabled:C,className:"flex-1 cursor-pointer py-3.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-2xl",children:"Hủy"}),(0,t.jsx)("button",{onClick:eg,disabled:C,className:"flex-1 cursor-pointer py-3.5 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-2xl",children:"Lưu"})]}):(0,t.jsx)("button",{onClick:ev,disabled:C||eu,className:`w-full cursor-pointer py-3.5 rounded-2xl font-semibold ${$.length>0&&!eu?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-200 text-gray-500 cursor-not-allowed"}`,children:"Bình chọn"})}),F&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/10",onClick:()=>{z(!1),G("")}}),(0,t.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-white h-[50vh] rounded-t-2xl shadow-2xl border-t border-gray-200 z-[100] ",children:[(0,t.jsxs)("div",{className:"px-4 pt-3 pb-2 flex gap-2 overflow-x-auto whitespace-nowrap custom-scrollbar",children:[(s.pollOptions||[]).map(e=>{let r=Array.isArray(ep[e])?ep[e].length:0,n=V===e||!V&&e===(s.pollOptions||[])[0];return(0,t.jsxs)("button",{onClick:()=>G(e),className:`flex items-center shrink-0 text-sm cursor-pointer px-2 ${n?"border-b border-black text-black":"text-black"}`,children:[(0,t.jsx)("span",{className:"truncate",children:e}),(0,t.jsxs)("span",{className:"ml-1",children:["(",r,")"]})]},e)}),(0,t.jsx)("button",{onClick:()=>G("__none__"),className:`shrink-0 px-3 py-2 text-sm cursor-pointer whitespace-nowrap ${"__none__"===V?"border-b border-black text-black":"text-black"}`,children:"Chưa bình chọn"})]}),(0,t.jsx)("div",{className:"p-4 max-h-[40vh] overflow-y-auto",children:0===(g="__none__"===V?ey:(Array.isArray(ep[V])?ep[V]:[]).map(e=>String(e))).length?(0,t.jsx)("p",{className:"px-1 text-sm text-gray-500",children:"Chưa có ai"}):g.map(e=>{let r=ex.get(String(e));return(0,t.jsxs)("div",{className:"flex items-center gap-3 px-2 py-2",children:[r?.avatar?(0,t.jsx)("div",{className:"w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-sm text-gray-600",children:(0,t.jsx)(a.default,{width:25,height:25,src:(0,h.getProxyUrl)(r.avatar),alt:r?.name||String(e),className:" w-full h-full object-cover rounded-full"})}):(0,t.jsx)("div",{className:"w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-sm text-gray-600",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:r?.name||"User",width:56,height:56,className:"w-full h-full object-cover"})}),(0,t.jsx)("span",{className:"text-sm",children:r?.name||String(e)})]},e)})})]})]}),es&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/10",onClick:()=>en(!1)}),(0,t.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl border-t border-gray-200 p-4 z-[110]",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-800",children:"Đặt thời hạn"}),(0,t.jsx)("button",{onClick:()=>en(!1),className:"cursor-pointer text-gray-500",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"radio",checked:"none"===ei,onChange:()=>ea("none")}),"Không giới hạn thời gian"]}),(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,t.jsx)("input",{type:"radio",checked:"time"===ei,onChange:()=>ea("time")}),"Chọn thời điểm kết thúc"]}),"time"===ei&&(0,t.jsx)("input",{type:"datetime-local",value:el,onChange:e=>eo(e.target.value),className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl"}),(0,t.jsxs)("div",{className:"flex gap-3 pt-2",children:[(0,t.jsx)("button",{onClick:()=>{if("none"===ei){er(null),en(!1);return}let e=Date.parse(el);Number.isNaN(e)||(er(e),en(!1))},className:"flex-1 cursor-pointer py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold text-sm",children:"Xong"}),(0,t.jsx)("button",{onClick:()=>en(!1),className:"flex-1 cursor-pointer py-2 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold text-sm",children:"Hủy"})]})]})]})]})]})}),eS=M&&"undefined"!=typeof document?document.getElementById("right-sidebar-container"):null;return M&&eS?(0,l.createPortal)(eN,eS):eN}function K({onClose:e,onRefresh:s,embedded:l=!1}){let{selectedChat:o,currentUser:c,isGroup:d}=O(),m=(0,r.useMemo)(()=>{let e=String(c._id),t=String(o._id);return d?t:[e,t].sort().join("_")},[d,o,c]),[u,g]=(0,r.useState)([]),[p,f]=(0,r.useState)(!1),[b,y]=(0,r.useState)(!1),[v,w]=(0,r.useState)(null),[j,N]=(0,r.useState)(null),S=(0,r.useRef)(new Map),k=(0,r.useRef)(null),C=(0,r.useCallback)(async()=>{try{f(!0);let e=await (0,B.readMessagesApi)(m,{limit:200,sortOrder:"desc",extraFilters:{type:"poll",isRecalled:{$ne:!0}}}),t=Array.isArray(e.data)?e.data:[];g(t)}catch{}finally{f(!1)}},[m]);(0,r.useEffect)(()=>{C()},[C]),(0,r.useEffect)(()=>{let e=e=>{if(!j)return;let t=S.current.get(j);t&&!t.contains(e.target)&&N(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[j]),(0,r.useEffect)(()=>(k.current?.disconnect(),k.current=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),k.current.emit("join_room",m),k.current.on("receive_message",e=>{String(e.roomId)===String(m)&&"poll"===e.type&&g(t=>{let r=new Map;return[...t,e].forEach(e=>r.set(String(e._id),e)),Array.from(r.values()).sort((e,t)=>Number(t.timestamp)-Number(e.timestamp))})}),k.current.on("message_edited",e=>{String(e.roomId)===String(m)&&g(t=>t.map(t=>String(t._id)===String(e._id)?{...t,content:e.content??t.content,editedAt:e.editedAt??t.editedAt,pollQuestion:e.pollQuestion??t.pollQuestion,pollOptions:e.pollOptions??t.pollOptions,pollVotes:e.pollVotes??t.pollVotes,isPollLocked:e.isPollLocked??t.isPollLocked,pollLockedAt:e.pollLockedAt??t.pollLockedAt,pollAllowMultiple:e.pollAllowMultiple??t.pollAllowMultiple,pollAllowAddOptions:e.pollAllowAddOptions??t.pollAllowAddOptions,pollHideVoters:e.pollHideVoters??t.pollHideVoters,pollHideResultsUntilVote:e.pollHideResultsUntilVote??t.pollHideResultsUntilVote,pollEndAt:void 0!==e.pollEndAt?e.pollEndAt:t.pollEndAt,timestamp:e.timestamp??t.timestamp,isPinned:"boolean"==typeof e.isPinned?e.isPinned:t.isPinned}:t).sort((e,t)=>Number(t.timestamp)-Number(e.timestamp)))}),k.current.on("edit_message",e=>{String(e.roomId)===String(m)&&g(t=>t.map(t=>String(t._id)===String(e._id)?{...t,...e,content:e.newContent||e.content||t.content,editedAt:e.editedAt,originalContent:t.originalContent||t.content}:t))}),k.current.on("message_deleted",e=>{String(e.roomId)===String(m)&&g(t=>t.filter(t=>String(t._id)!==String(e._id)))}),k.current.on("message_pinned",e=>{String(e.roomId)===String(m)&&g(t=>t.map(t=>String(t._id)===String(e._id)?{...t,isPinned:!!e.isPinned}:t))}),()=>{k.current?.disconnect(),k.current=null}),[m,C]);let _=async({question:e,options:t,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a})=>{let l=e.trim(),u=t.map(e=>e.trim()).filter(e=>e),h=Array.from(new Set(u.map(e=>e.toLowerCase()))).map(e=>u.find(t=>t.toLowerCase()===e));if(l&&!(h.length<2)){try{let e=await (0,B.createMessageApi)({roomId:m,sender:String(c._id),type:"poll",content:l,timestamp:Date.now(),pollQuestion:l,pollOptions:h,pollVotes:{},isPollLocked:!1,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a??null});if(e?.success){let t=d?null:String(o._id),u=d&&o.members||[],x={roomId:m,sender:String(c._id),senderName:c.name,isGroup:d,receiver:t,members:u},g=c.name;if("string"==typeof e._id){k.current?.emit("send_message",{...x,_id:e._id,type:"poll",content:l,timestamp:Date.now(),pollQuestion:l,pollOptions:h,pollVotes:{},isPollLocked:!1,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a??null});let t=await (0,B.createMessageApi)({roomId:m,sender:String(c._id),type:"notify",content:`${g} tạo cuộc b\xecnh chọn mới: "${l}"`,timestamp:Date.now(),replyToMessageId:e._id});t?.success&&k.current?.emit("send_message",{...x,_id:t._id,type:"notify",content:`${g} tạo cuộc b\xecnh chọn mới: "${l}"`,timestamp:Date.now(),replyToMessageId:e._id})}}}catch{}y(!1)}},T=e=>{let t=e.sender;return("object"==typeof t&&t?String(t._id):String(t))===String(c._id)},M=async e=>{if(!T(e))return;let t=!e.isPollLocked;if(t||null==e.pollEndAt)try{let r=Date.now(),n=c.name,i=t?{isPollLocked:!0,pollLockedAt:r,editedAt:r,timestamp:r}:{isPollLocked:!1,editedAt:r,timestamp:r};if(await (0,B.updateMessageApi)(String(e._id),i),k.current?.emit("edit_message",{_id:e._id,roomId:m,...i}),t){let t=d?null:String(o._id),s=d&&o.members||[],i=new Date(r).toLocaleString("vi-VN"),a=`${n} đ\xe3 kh\xf3a b\xecnh chọn: "${String(e.content||e.pollQuestion||"")}" (kết th\xfac l\xfac ${i})`,l=await (0,B.createMessageApi)({roomId:m,sender:String(c._id),type:"notify",content:a,timestamp:r,replyToMessageId:String(e._id)});l?.success&&k.current?.emit("send_message",{roomId:m,sender:String(c._id),senderName:c.name,isGroup:d,receiver:t,members:s,_id:l._id,type:"notify",content:a,timestamp:r,replyToMessageId:String(e._id)})}else{let t=d?null:String(o._id),s=d&&o.members||[],i=`${n} đ\xe3 mở kh\xf3a b\xecnh chọn: "${String(e.content||e.pollQuestion||"")}"`,a=await (0,B.createMessageApi)({roomId:m,sender:String(c._id),type:"notify",content:i,timestamp:r,replyToMessageId:String(e._id)});a?.success&&k.current?.emit("send_message",{roomId:m,sender:String(c._id),senderName:c.name,isGroup:d,receiver:t,members:s,_id:a._id,type:"notify",content:i,timestamp:r,replyToMessageId:String(e._id)})}s&&await s()}catch{}},A=async e=>{let t=!e.isPinned;g(r=>r.map(r=>String(r._id)===String(e._id)?{...r,isPinned:t}:r));try{let r=Date.now();await (0,B.updateMessageApi)(String(e._id),{isPinned:t,editedAt:r}),k.current?.emit("edit_message",{_id:e._id,roomId:m,isPinned:t,editedAt:r}),await (0,B.updateMessageApi)(String(e._id),{isPinned:t}),k.current?.emit("pin_message",{_id:e._id,roomId:m,isPinned:t});let s=d?null:String(o._id),n=d&&o.members||[],i=c.name||"Ai đó",a=t?"đã ghim":"đã bỏ ghim",l=`${i} ${a} một b\xecnh chọn: "${String(e.content||e.pollQuestion||"")}"`,u=await (0,B.createMessageApi)({roomId:m,sender:String(c._id),type:"notify",content:l,timestamp:r,replyToMessageId:String(e._id)});u?.success&&k.current?.emit("send_message",{roomId:m,sender:String(c._id),senderName:c.name,isGroup:d,receiver:s,members:n,_id:u._id,type:"notify",content:l,timestamp:r,replyToMessageId:String(e._id)})}catch{g(r=>r.map(r=>String(r._id)===String(e._id)?{...r,isPinned:!t}:r))}},E=e=>{w(e),N(null)},$=(0,r.useCallback)(e=>{if(String(e)===String(c._id))return c;if(d){let t=(o.members||[]).find(t=>String(t._id||t.id)===String(e));if(t)return t}else if(String(o._id)===String(e))return o;return null},[c,d,o]);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex flex-col h-full bg-gray-50 overflow-hidden",children:[!l&&(0,t.jsxs)("div",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm z-10",children:[(0,t.jsx)("h2",{className:"text-lg font-bold text-gray-800",children:"Bình chọn"}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[d&&(0,t.jsx)("button",{onClick:()=>y(!0),className:"p-2 cursor-pointer rounded-full hover:bg-gray-100 text-blue-600 transition-all duration-200",title:"Tạo bình chọn mới",children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-6 h-6",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"})})}),(0,t.jsx)("button",{onClick:e,className:"p-2 cursor-pointer rounded-full hover:bg-gray-100 text-gray-500 transition-all duration-200",children:(0,t.jsx)(i.HiX,{className:"w-6 h-6"})})]})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 bg-gray-100 p-3",children:(0,t.jsx)("div",{className:"space-y-4 max-w-2xl mx-auto",children:p?(0,t.jsxs)("div",{className:"text-center text-gray-500 py-10",children:[(0,t.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"}),(0,t.jsx)("p",{className:"mt-2",children:"Đang tải..."})]}):0===u.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-20 text-gray-400",children:[(0,t.jsx)("svg",{className:"w-16 h-16 mb-4 opacity-50",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),(0,t.jsx)("p",{className:"text-sm",children:"Chưa có bình chọn nào"})]}):u.map(e=>{let r=String(e._id),s=e.sender,n=$("object"==typeof s?String(s._id):String(s))||("object"==typeof s?s:null),i=n?.name||"Ai đó",l=n?.avatar,o=j===r,d=!!e.isPollLocked,m=Object.values(e.pollVotes||{}).flat().length,u=new Set(Object.values(e.pollVotes||{}).flat()).size,g=Object.values(e.pollVotes||{}).some(e=>e.includes(String(c._id))),p=!(e.pollHideResultsUntilVote&&!g);return(0,t.jsxs)("div",{className:"relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:[(0,t.jsxs)("div",{className:"p-4 pb-2",children:[(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-gray-200",children:l?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(l),alt:i,width:40,height:40,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:i,width:40,height:40,className:"w-full h-full object-cover"})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsxs)("div",{className:"flex justify-between items-start",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[(0,t.jsxs)("span",{children:[i," ",(0,t.jsx)("span",{className:"font-normal text-gray-500",children:"tạo một bình chọn"})]}),d&&(0,t.jsxs)("span",{className:"inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-500 border border-gray-200",children:[(0,t.jsx)(x.HiLockClosed,{className:"w-3 h-3"}),"Đã khóa"]})]}),(0,t.jsx)("p",{className:"text-xs text-gray-400 mt-0.5",children:(e=>{try{let t=new Date(e),r=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0");return`${r}/${s} l\xfac ${n}:${i}`}catch{return""}})(e.timestamp)})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{onClick:()=>N(o?null:r),className:"p-1 cursor-pointer text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5"})}),o&&(0,t.jsxs)("div",{ref:e=>{e?S.current.set(r,e):S.current.delete(r)},className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-xl border border-gray-100 z-20 py-1",children:[(0,t.jsx)("button",{onClick:()=>E(e),className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50",children:"Xem chi tiết"}),(0,t.jsx)("button",{onClick:()=>A(e),className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50",children:e.isPinned?"Bỏ ghim":"Ghim bình chọn"}),T(e)&&!(null!=e.pollEndAt&&Date.now()>=Number(e.pollEndAt))&&(0,t.jsx)("button",{onClick:()=>M(e),className:"cursor-pointer w-full px-4 py-2 text-left text-sm hover:bg-gray-50 text-red-600",children:d?"Mở khóa bình chọn":"Khóa bình chọn"})]})]})]})})]}),(0,t.jsxs)("div",{className:"mt-3",children:[(0,t.jsx)("p",{className:"text-base font-medium text-gray-900 mb-2 leading-snug truncate",children:e.content||e.pollQuestion||"Bình chọn"}),(0,t.jsxs)("div",{className:"flex flex-col gap-0.5 mb-2",children:[(0,t.jsx)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:e.pollAllowMultiple?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiListBullet,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn nhiều phương án"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiCheckCircle,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn 1 phương án"})]})}),e.pollHideVoters&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiEyeSlash,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn người bình chọn"})]}),e.pollAllowAddOptions&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiPlus,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Cho phép thêm phương án"})]}),e.pollHideResultsUntilVote&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiLockClosed,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn kết quả khi chưa bình chọn"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1 mb-3 cursor-pointer",onClick:()=>E(e),children:[(0,t.jsx)("span",{className:"text-sm text-blue-500 font-medium hover:underline",children:p?`${u} người đ\xe3 b\xecnh chọn`:"Bình chọn để xem kết quả"}),(0,t.jsx)("svg",{className:"w-4 h-4 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),(0,t.jsx)("div",{className:"space-y-2",children:(e.pollOptions||[]).map((s,n)=>{let i,l=(e.pollVotes||{})[s]||[],o=l.length,d=(i=String(c._id),((e.pollVotes||{})[s]||[]).includes(i),p&&m>0?o/m*100:0),u=l.slice(0,3).map(e=>{let t=$(e);return t?{id:e,avatar:t.avatar,name:t.name}:{id:e,avatar:null,name:"User"}});return(0,t.jsxs)("div",{onClick:()=>E(e),className:`group relative overflow-hidden bg-gray-100 rounded-lg p-3 cursor-pointer transition-all duration-200
                                               
                                             
                                            `,children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 bottom-0 transition-all duration-500 ease-out bg-blue-200",style:{width:`${d}%`}}),(0,t.jsxs)("div",{className:"relative flex items-center justify-between gap-3 z-10",children:[(0,t.jsx)("span",{className:"text-sm  ",children:s}),!e.pollHideVoters&&p&&(0,t.jsxs)("div",{className:"flex items-center -space-x-2",children:[u.map((e,r)=>(0,t.jsx)("div",{className:"w-6 h-6 rounded-full border-2 border-white overflow-hidden bg-gray-200",title:e.name,children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:"",width:24,height:24,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:"",width:24,height:24,className:"w-full h-full object-cover"})},r)),o>3&&(0,t.jsxs)("div",{className:"w-6 h-6 rounded-full border-2 border-white bg-gray-700 text-white text-[10px] flex items-center justify-center font-bold",children:["+",o-3]}),o>0&&o<=3&&u.length<o&&(0,t.jsx)("div",{className:"w-6 h-6 rounded-full border-2 border-white bg-gray-300 text-gray-600 text-[10px] flex items-center justify-center font-bold",children:o})]}),e.pollHideVoters&&p&&o>0&&(0,t.jsxs)("div",{className:"text-xs text-gray-500 font-medium",children:[o," lượt"]})]})]},`${r}-${n}`)})})]})]}),(0,t.jsx)("div",{className:"p-4 pt-2",children:(0,t.jsx)("button",{onClick:()=>E(e),disabled:!1,className:`w-full cursor-pointer py-2.5 rounded-lg font-medium transition-colors text-sm
                                ${d?"bg-gray-100 text-gray-500 cursor-default":"bg-blue-50 text-blue-600 hover:bg-blue-100 active:bg-blue-200"}`,children:d?"Đã khóa bình chọn":e.pollVotes&&Object.values(e.pollVotes).some(e=>e.includes(String(c._id)))?"Đổi bình chọn":"Bình chọn"})})]},r)})})})]}),(0,t.jsx)(W,{isOpen:b,onClose:()=>y(!1),onCreate:_}),(0,t.jsx)(J,{isOpen:!!v,message:v,onClose:()=>w(null)})]})}function q({onClose:e,onJumpToMessage:s}){let{selectedChat:l,currentUser:o,isGroup:c,allUsers:d}=O(),m=(0,r.useMemo)(()=>{let e=String(o._id),t=String(l._id);return c?t:[e,t].sort().join("_")},[c,l,o]),[u,x]=(0,r.useState)("pinned"),[g,p]=(0,r.useState)([]),[f,b]=(0,r.useState)(!1),[y,v]=(0,r.useState)(!1),[w,j]=(0,r.useState)(!1),[N,S]=(0,r.useState)(!1),[k,C]=(0,r.useState)(!1),[_,T]=(0,r.useState)(null),M=(0,r.useRef)(null);(0,r.useEffect)(()=>(M.current=(0,n.io)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),()=>{M.current?.disconnect()}),[]);let A=(0,r.useCallback)(async()=>{try{b(!0);let e=await (0,B.readMessagesApi)(m,{limit:200,sortOrder:"desc",extraFilters:{isPinned:!0,isRecalled:{$ne:!0}}}),t=Array.isArray(e.data)?e.data:[];p(t)}catch(e){console.error("❌ Lỗi khi tải danh sách tin nhắn đã ghim:",e)}finally{b(!1)}},[m]);(0,r.useEffect)(()=>{"pinned"===u&&A()},[A,u]);let E=async({question:e,options:t,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a})=>{let d=e.trim();if(d)try{let e=await (0,B.createMessageApi)({roomId:m,sender:String(o._id),type:"poll",content:d,timestamp:Date.now(),pollQuestion:d,pollOptions:t,pollVotes:{},isPollLocked:!1,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a??null});if(e?.success){let h=c?null:String(l._id),g=c&&l.members||[],p={roomId:m,sender:String(o._id),senderName:o.name,isGroup:c,receiver:h,members:g};if("string"==typeof e._id){M.current?.emit("send_message",{...p,_id:e._id,type:"poll",content:d,timestamp:Date.now(),pollQuestion:d,pollOptions:t,pollVotes:{},isPollLocked:!1,pollAllowMultiple:r,pollAllowAddOptions:s,pollHideVoters:n,pollHideResultsUntilVote:i,pollEndAt:a??null});let l=await (0,B.createMessageApi)({roomId:m,sender:String(o._id),type:"notify",content:`${o.name} tạo cuộc b\xecnh chọn mới: "${d}"`,timestamp:Date.now(),replyToMessageId:e._id});l?.success&&M.current?.emit("send_message",{...p,_id:l._id,type:"notify",content:`${o.name} tạo cuộc b\xecnh chọn mới: "${d}"`,timestamp:Date.now(),replyToMessageId:e._id})}j(!1),"poll"!==u&&x("poll")}}catch(e){console.error("Failed to create poll:",e)}},$=async({content:e,dateTime:t,note:r,repeat:s})=>{C(!0);let n=Date.parse(t);if(!e.trim()||Number.isNaN(n)){alert("Vui lòng nhập đầy đủ thông tin hợp lệ"),C(!1);return}try{let t=await (0,B.createMessageApi)({roomId:m,sender:String(o._id),type:"reminder",content:e.trim(),timestamp:Date.now(),reminderAt:n,reminderNote:r?.trim()||"",reminderFired:!1,reminderRepeat:s||"none"});if(t?.success){let i=c?null:String(l._id),a=c&&l.members||[],d={roomId:m,sender:String(o._id),senderName:o.name,isGroup:c,receiver:i,members:a};"string"==typeof t._id&&M.current?.emit("send_message",{...d,_id:t._id,type:"reminder",content:e.trim(),timestamp:Date.now(),reminderAt:n,reminderNote:r?.trim()||"",reminderFired:!1,reminderRepeat:s||"none"});let h=new Date(n).toLocaleString("vi-VN"),g=await (0,B.createMessageApi)({roomId:m,sender:String(o._id),type:"notify",content:`${o.name} đ\xe3 tạo lịch hẹn: "${e.trim()}" l\xfac ${h}`,timestamp:Date.now()});g?.success&&"string"==typeof g._id&&M.current?.emit("send_message",{...d,_id:g._id,type:"notify",content:`${o.name} đ\xe3 tạo lịch hẹn: "${e.trim()}" l\xfac ${h}`,timestamp:Date.now()}),S(!1),"note"!==u&&x("note")}else alert("Tạo lịch hẹn thất bại. Vui lòng kiểm tra kết nối máy chủ.")}catch(e){console.error("❌ Lỗi khi tạo lịch hẹn:",e),alert("Không thể tạo lịch hẹn. Vui lòng thử lại.")}finally{C(!1)}},I=async e=>{try{await (0,B.togglePinMessageApi)(e,!1),p(t=>t.filter(t=>t._id!==e)),T(null)}catch(e){console.error("Failed to unpin message:",e)}};return(0,t.jsxs)("div",{className:"flex flex-col h-full bg-gray-50 relative",children:[(0,t.jsxs)("div",{className:"bg-blue-500 text-white p-3 flex items-center justify-between shadow-sm sticky top-0 z-20",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("button",{onClick:e,className:"p-1 cursor-pointer hover:bg-white/20 rounded-full transition-colors",children:(0,t.jsx)(i.HiChevronLeft,{className:"w-6 h-6"})}),(0,t.jsx)("h3",{className:"font-medium text-lg",children:"Bảng tin nhóm"})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{onClick:()=>v(!y),className:"p-1 hover:bg-white/20 rounded-full transition-colors cursor-pointer",children:(0,t.jsx)(i.HiPlus,{className:"w-6 h-6"})}),y&&(0,t.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 text-gray-800 z-50 animate-fade-in",children:[c&&(0,t.jsx)("button",{onClick:()=>{v(!1),j(!0)},className:"cursor-pointer block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm",children:"Tạo bình chọn"}),(0,t.jsx)("button",{onClick:()=>{v(!1),S(!0)},className:"cursor-pointer block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm",children:"Tạo ghi chú"})]})]})]}),(0,t.jsxs)("div",{className:"bg-white px-1 flex items-center border-b border-gray-200 sticky top-[0] z-10",children:[(0,t.jsx)("div",{onClick:()=>x("pinned"),className:`flex-1 text-center py-3 border-b-2 font-medium text-sm cursor-pointer transition-colors ${"pinned"===u?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:bg-gray-50"}`,children:"Tin nhắn đã ghim"}),c&&(0,t.jsx)("div",{onClick:()=>x("poll"),className:`flex-1 text-center py-3 border-b-2 font-medium text-sm cursor-pointer transition-colors ${"poll"===u?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:bg-gray-50"}`,children:"Bình chọn"}),(0,t.jsx)("div",{onClick:()=>x("note"),className:`flex-1 text-center py-3 border-b-2 font-medium text-sm cursor-pointer transition-colors ${"note"===u?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:bg-gray-50"}`,children:"Ghi chú"})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-hidden relative",children:["pinned"===u&&(0,t.jsx)("div",{className:"absolute inset-0 overflow-y-auto p-4 space-y-4 custom-scrollbar",children:f?(0,t.jsx)("div",{className:"text-center py-10 text-gray-500",children:"Đang tải..."}):0===g.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full gap-4 text-center p-8 opacity-70",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(G,{className:"w-16 h-16 text-blue-200"}),(0,t.jsx)("div",{className:"absolute -bottom-2 -right-2 bg-white rounded-full p-1 shadow-sm",children:(0,t.jsx)("div",{className:"w-4 h-4 bg-blue-500 rounded-full"})})]}),(0,t.jsx)("p",{className:"text-gray-500 text-sm",children:"Bấm giữ một tin nhắn và chọn Ghim để gây chú ý cho cả nhóm"})]}):g.map(r=>{let n="object"==typeof r.sender?r.sender:d.find(e=>String(e._id)===String(r.sender))||{},l=r.pinnedAt||r.timestamp;return(0,t.jsxs)("div",{className:"bg-white rounded-lg p-3 shadow-sm border border-gray-100 space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600",children:(0,t.jsx)(G,{className:"w-4 h-4"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-gray-700",children:(0,t.jsx)("span",{className:"font-semibold text-gray-900",children:"Tin nhắn đã ghim"})}),(0,t.jsx)("p",{className:"text-xs text-gray-400",children:l?new Date(l).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}):""})]})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{className:"cursor-pointer text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100",onClick:e=>{e.stopPropagation(),T(_===r._id?null:r._id)},children:(0,t.jsx)(i.HiDotsHorizontal,{className:"w-5 h-5"})}),_===r._id&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-10",onClick:()=>T(null)}),(0,t.jsxs)("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-100 z-20 overflow-hidden py-1",children:[(0,t.jsx)("button",{className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2",onClick:t=>{var n;t.stopPropagation(),n=r._id,s&&(s(n),e()),T(null)},children:(0,t.jsx)("span",{children:"Di chuyển đến tin nhắn"})}),(0,t.jsx)("button",{className:"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:e=>{e.stopPropagation(),I(r._id)},children:(0,t.jsx)("span",{children:"Xóa ghim"})})]})]})]})]}),(0,t.jsxs)("div",{className:"pl-3 border-l-[3px] border-blue-500 py-1",children:[(0,t.jsx)("div",{className:"mb-1",children:(0,t.jsx)("span",{className:"font-semibold text-sm text-gray-900",children:n.name||"Người gửi"})}),"image"===r.type?(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)("div",{className:" w-20 h-20 rounded-md overflow-hidden relative bg-gray-100",children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(String(r.fileUrl||r.content))||"/imgs/img1.JPEG",alt:"Image",width:200,height:200,className:"object-cover w-auto h-auto",unoptimized:String(r.fileUrl||r.content).includes("mega.nz")})})}):"video"===r.type?(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)("video",{src:(0,h.getProxyUrl)(String(r.fileUrl||r.content))||"https://www.w3schools.com/html/mov_bbb.mp4",controls:!0,className:"w-full max-w-[200px] rounded-md bg-black"})}):"file"===r.type?(0,t.jsxs)("div",{className:"mt-1 flex items-center gap-2 p-2 bg-gray-50 rounded-md border border-gray-200",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"})})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsx)("p",{className:"text-sm font-medium text-gray-700 truncate",children:r.fileName||"File đính kèm"})})]}):(0,t.jsx)("p",{className:"text-sm text-gray-800 line-clamp-3 whitespace-pre-wrap",children:r.content||"Tin nhắn không có nội dung"})]})]},r._id)})}),"poll"===u&&(0,t.jsx)(K,{embedded:!0,onClose:e}),"note"===u&&(0,t.jsx)(V,{embedded:!0,onClose:e})]}),(0,t.jsx)(W,{isOpen:w,onClose:()=>j(!1),onCreate:E}),(0,t.jsx)(F,{isOpen:N,onClose:()=>S(!1),onCreate:$,createLoading:k})]})}var Q=e.i(37902);function Y({show:e,type:r,message:s,onClose:n,onConfirm:a}){return e?(0,t.jsxs)("div",{className:"jsx-e3636f235cc88d75 fixed inset-0 bg-white/30 bg-opacity-50 flex items-center justify-center p-4 z-50",children:[(0,t.jsxs)("div",{className:"jsx-e3636f235cc88d75 bg-white rounded-lg shadow-xl max-w-md w-full animate-[scale-in_0.2s_ease-out]",children:[(0,t.jsxs)("div",{className:"jsx-e3636f235cc88d75 flex items-center justify-between p-4 border-b border-gray-300",children:[(0,t.jsxs)("div",{className:"jsx-e3636f235cc88d75 flex items-center gap-2",children:["success"===r&&(0,t.jsx)("div",{className:"jsx-e3636f235cc88d75 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:(0,t.jsx)(i.HiCheckCircle,{className:"w-5 h-5 text-green-600"})}),"error"===r&&(0,t.jsx)("div",{className:"jsx-e3636f235cc88d75 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5 text-red-600"})}),"confirm"===r&&(0,t.jsx)("div",{className:"jsx-e3636f235cc88d75 w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center",children:(0,t.jsx)(i.HiExclamationCircle,{className:"w-5 h-5 text-yellow-600"})}),(0,t.jsxs)("h3",{className:"jsx-e3636f235cc88d75 text-lg font-semibold",children:["success"===r&&"Thành công","error"===r&&"Lỗi","confirm"===r&&"Xác nhận"]})]}),(0,t.jsx)("button",{onClick:n,className:"jsx-e3636f235cc88d75 text-gray-400 hover:text-gray-600 transition-colors hover:cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsx)("div",{className:"jsx-e3636f235cc88d75 p-6",children:(0,t.jsx)("p",{className:"jsx-e3636f235cc88d75 text-gray-700",children:s})}),(0,t.jsx)("div",{className:"jsx-e3636f235cc88d75 flex gap-2 p-4 border-t border-gray-300 bg-gray-50",children:"confirm"===r?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onClick:n,className:"jsx-e3636f235cc88d75 flex-1 px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition-colors",children:"Hủy"}),(0,t.jsx)("button",{onClick:a,className:"jsx-e3636f235cc88d75 flex-1 px-4 py-2 hover:cursor-pointer bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Xác nhận"})]}):(0,t.jsx)("button",{onClick:n,className:"jsx-e3636f235cc88d75 flex-1 px-4 py-2 bg-blue-600 hover:cursor-pointer text-white rounded hover:bg-blue-700 transition-colors",children:"Đóng"})})]}),(0,t.jsx)(Q.default,{id:"e3636f235cc88d75",children:"@keyframes scale-in{0%{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}"})]}):null}function Z({inviteCode:e,onGenerateLink:s,onRegenerateLink:n}){let[a,l]=(0,r.useState)(e||""),[o,c]=(0,r.useState)(!1),[d,m]=(0,r.useState)(!1),[u,h]=(0,r.useState)({show:!1,type:"success",message:""}),x=a?`${window.location.origin}/invite/${a}`:"",g=(e,t)=>{h({show:!0,type:e,message:t})},p=()=>{h({show:!1,type:"success",message:""})},f=async()=>{c(!0);try{let e=await s();l(e)}catch(e){console.error("Generate link error:",e),g("error","Tạo link mời thất bại")}finally{c(!1)}},b=async()=>{c(!0);try{let e=await n();l(e),g("success","Đã tạo link mời mới")}catch(e){console.error("Regenerate link error:",e),g("error","Tạo link mới thất bại")}finally{c(!1)}},y=async()=>{if(x)try{await navigator.clipboard.writeText(x),m(!0),setTimeout(()=>m(!1),2e3)}catch{let e=document.createElement("input");e.value=x,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),m(!0),setTimeout(()=>m(!1),2e3)}};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"bg-white  border border-gray-200 overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 flex items-center justify-between",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(T.CiLink,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Link nhóm"})]})}),(0,t.jsx)("div",{className:"p-4 space-y-3",children:a?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center gap-0.5",children:[(0,t.jsx)("input",{type:"text",value:x,readOnly:!0,className:"flex-1 px-3 py-2 border-none outline-none rounded-lg bg-gray-50 text-sm text-gray-700 select-all"}),(0,t.jsx)("button",{onClick:y,className:"p-2 hover:bg-gray-100 hover:cursor-pointer rounded-lg transition flex-shrink-0",title:"Sao chép link",children:d?(0,t.jsx)(i.HiCheck,{className:"w-5 h-5 text-green-600"}):(0,t.jsx)(T.CiFloppyDisk,{className:"w-5 h-5 text-gray-600"})}),(0,t.jsx)("button",{onClick:()=>g("confirm","Tạo link mới sẽ vô hiệu hóa link cũ. Bạn có chắc chắn?"),disabled:o,className:"p-2 hover:bg-gray-100 rounded-lg transition flex-shrink-0 hover:cursor-pointer disabled:opacity-50",title:"Tạo link mới",children:(0,t.jsx)(i.HiRefresh,{className:`w-5 h-5 text-gray-600 ${o?"animate-spin":""}`})})]}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"💡 Mọi người có link này có thể tham gia nhóm"})]}):(0,t.jsxs)("div",{className:"text-center py-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"Tạo link mời để chia sẻ với bạn bè"}),(0,t.jsx)("button",{onClick:f,disabled:o,className:"px-4 py-2 hover:cursor-pointer bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:o?"Đang tạo...":"Tạo link mời"})]})})]}),(0,t.jsx)(Y,{show:u.show,type:u.type,message:u.message,onClose:p,onConfirm:"confirm"===u.type?()=>{p(),b()}:void 0})]})}function ee({onOpen:e}){let{selectedChat:s,currentUser:n,isGroup:i}=O(),a=(0,r.useMemo)(()=>{let e=String(n._id),t=String(s._id);return i?t:[e,t].sort().join("_")},[i,s,n]),[l,o]=(0,r.useState)(null);return(0,r.useEffect)(()=>{(async()=>{try{let e=await (0,B.readPinnedMessagesApi)(a,{limit:1});e.data&&e.data.length>0?o(e.data[0]):o(null)}catch(e){console.error("Failed to load pinned message preview:",e)}})()},[a]),(0,t.jsx)("div",{className:"bg-white border border-gray-100 overflow-hidden",children:(0,t.jsxs)("button",{className:"cursor-pointer w-full px-5 py-4 flex items-center gap-5 hover:bg-gray-50 transition-all duration-200 group",onClick:e,title:"Xem danh sách tin nhắn đã ghim",children:[(0,t.jsx)("div",{className:" rounded-xl",children:(0,t.jsx)(T.CiMapPin,{className:"w-5 h-5 text-gray-500"})}),(0,t.jsxs)("div",{className:"text-left flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-base text-[1.125rem] md:text-[1rem] text-gray-900 group-hover:text-amber-600 transition-colors",children:"Tin nhắn đã ghim"}),l&&(0,t.jsx)("p",{className:"text-sm text-gray-500 truncate mt-0.5 max-w-[200px]",children:"image"===l.type?"[Hình ảnh]":"video"===l.type?"[Video]":"file"===l.type?"[File] "+(l.fileName||""):"poll"===l.type?"[Bình chọn] "+(l.pollQuestion||l.content):l.content||"Tin nhắn đã ghim"})]}),(0,t.jsx)("div",{className:"ml-auto text-gray-400 group-hover:text-amber-600 transition-colors",children:(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400 group-hover:text-amber-600"})})]})})}var et=e.i(51122);let er=({isOpen:e,onClose:s,title:n="Thành công",description:a="Thao tác đã được thực hiện thành công.",autoCloseTime:l=3e3})=>((0,r.useEffect)(()=>{if(e&&l>0){let e=setTimeout(()=>{s()},l);return()=>clearTimeout(e)}},[e,l,s]),e)?(0,t.jsxs)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity",onClick:s}),(0,t.jsxs)("div",{className:"relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all animate-in fade-in zoom-in duration-200",children:[(0,t.jsxs)("div",{className:"h-24 bg-gradient-to-br from-green-400 to-emerald-600 relative overflow-hidden",children:[(0,t.jsx)("div",{className:"absolute top-0 right-0 p-8 bg-white/10 rounded-full transform translate-x-1/2 -translate-y-1/2 blur-2xl w-32 h-32"}),(0,t.jsx)("div",{className:"absolute bottom-0 left-0 p-8 bg-black/10 rounded-full transform -translate-x-1/2 translate-y-1/2 blur-xl w-24 h-24"}),(0,t.jsx)("button",{onClick:s,className:"absolute top-3 right-3 p-1.5 bg-white/20 hover:bg-white/30 text-white rounded-full transition-colors backdrop-blur-sm",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"px-6 pb-8 pt-0 relative",children:[(0,t.jsx)("div",{className:"absolute -top-12 left-1/2 transform -translate-x-1/2",children:(0,t.jsx)("div",{className:"w-10 h-10 bg-white rounded-full p-2 shadow-lg flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-full h-full bg-green-50 rounded-full flex items-center justify-center border-4 border-green-100",children:(0,t.jsx)(i.HiCheck,{className:"w-10 h-10 text-green-500"})})})}),(0,t.jsxs)("div",{className:"mt-12 text-center space-y-3",children:[(0,t.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:n}),(0,t.jsx)("p",{className:"text-gray-500 text-sm leading-relaxed",children:a})]}),(0,t.jsx)("div",{className:"mt-8 flex justify-center",children:(0,t.jsx)("button",{onClick:s,className:"cursor-pointer px-8 py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-sm font-semibold rounded-xl hover:from-green-600 hover:to-emerald-700 shadow-lg shadow-green-500/30 transform transition-all active:scale-95",children:"Đóng"})})]})]})]}):null;var es=e.i(98539);function en({isOpen:e,onClose:s,currentUser:l,selectedChat:o,onShowCreateGroup:c,reLoad:d}){let[m,u]=(0,r.useState)([]),[g,p]=(0,r.useState)(!1),[f,b]=(0,r.useState)(""),[y,v]=(0,r.useState)(""),[w,j]=(0,r.useState)([]),[N,S]=(0,r.useState)(!1),k=(0,r.useCallback)(async()=>{try{let e=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:l._id})}),t=await e.json(),r=Array.isArray(t.data)?t.data:[];u(r)}catch{}},[l]);(0,r.useEffect)(()=>{e&&(b(""),v(""),j([]),k())},[e,k]);let C=(0,r.useMemo)(()=>(0,h.normalizeNoAccent)(y.trim())?((0,h.hasDiacritics)(y.trim()),m.filter(e=>(0,h.accentAwareIncludes)(String(e.name||""),y.trim()))):m,[y,m]),_=(0,r.useCallback)(e=>{b(""),j(t=>t.includes(e)?t.filter(t=>t!==e):t.length>=5?(b(`Chỉ chọn tối đa 5 nh\xf3m`),t):[...t,e])},[5]),T=(0,r.useCallback)(async()=>{if(0!==w.length){p(!0),b("");try{let e=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),t=String(o._id);for(let r of w){let s=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"addMembers",conversationId:r,newMembers:[t],_id:l._id})});if((await s.json()).success){let s=m.find(e=>String(e._id)===String(r))||null,n=(Array.isArray(s?.members)?s.members:[]).map(e=>"string"==typeof e?String(e):String(e._id||e.id||"")).filter(e=>!!e),i=Array.from(new Set([...n,t])),a=n.map(e=>({_id:e})),o=i.map(e=>({_id:e}));e.emit("group_members_updated",{roomId:String(r),members:o,prevMembers:a,sender:String(l._id),senderName:l.name,groupName:s?.name})}else b("Một số nhóm thêm thất bại")}setTimeout(()=>e.disconnect(),500),S(!0),d?.(),s()}catch{b("Lỗi kết nối")}finally{p(!1)}}},[w,o,d,s,l._id,l.name,m]);return e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-white md:bg-black/50 md:px-4",children:(0,t.jsxs)("div",{className:"bg-white md:rounded-2xl shadow-2xl w-full h-full md:h-[45rem] md:max-w-md overflow-hidden flex flex-col",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-100 bg-gray-50 flex-none",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsx)("h3",{className:"font-bold text-gray-800",children:"Thêm vào nhóm"}),(0,t.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-200 rounded-full cursor-pointer transition-colors",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5 text-gray-500"})})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Đã chọn: ",w.length,"/",5]})]}),(0,t.jsx)("div",{className:"p-3 border-b border-gray-100 flex-none",children:(0,t.jsx)("input",{value:y,onChange:e=>v(e.target.value),placeholder:"Nhập tên nhóm",className:"w-full px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"})}),(0,t.jsxs)("button",{onClick:()=>{try{window.__createGroupInitialMemberIds=[String(o._id)]}catch{}c(),s()},className:"cursor-pointer w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-all flex-none",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(x.HiPlus,{className:"w-5 h-5 text-blue-600"}),(0,t.jsxs)("span",{className:"text-sm text-gray-800",children:["Tạo nhóm với ",o.name||o.username||"Người dùng"]})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),(0,t.jsxs)("div",{className:"p-4 space-y-2 overflow-y-auto flex-1 custom-scrollbar",children:[0===C.length?(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Chưa có nhóm nào"}):C.map(e=>{let r=Array.isArray(e.members)&&e.members.some(e=>String("string"==typeof e?e:e._id||e.id)===String(o._id)),s=w.includes(String(e._id));return(0,t.jsx)("button",{onClick:()=>{r||g||_(String(e._id))},disabled:g||r,className:`w-full flex items-center justify-between px-3 py-2 rounded-xl transition-colors cursor-pointer ${r?"opacity-50 cursor-not-allowed bg-gray-50":s?"bg-blue-50":"hover:bg-gray-50"}`,children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:`w-6 h-6 rounded-full border flex items-center justify-center ${r?"bg-blue-400 border-blue-400":s?"bg-blue-600 border-blue-600":"border-gray-300 bg-white"}`,children:(s||r)&&(0,t.jsx)("svg",{className:"w-5 h-5 text-white",viewBox:"0 0 24 24",fill:"currentColor",children:(0,t.jsx)("path",{d:"M20 6L9 17l-5-5"})})}),(0,t.jsx)("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-gray-100",children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:"",width:36,height:36,className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gray-200 text-gray-700 font-bold",children:String(e.name||"N").charAt(0).toUpperCase()})}),(0,t.jsxs)("div",{className:"flex flex-col justify-center items-start min-w-0",children:[(0,t.jsx)("span",{className:"text-[1.3rem]  text-gray-800 truncate max-w-[15rem]",children:e.name||"Nhóm"}),(0,t.jsx)("span",{className:"text-[1rem] text-gray-500",children:r?"Đã tham gia":`${Array.isArray(e.members)?e.members.length:0} tv`})]})]})},e._id)}),f&&(0,t.jsx)("div",{className:"text-xs text-red-600",children:f})]}),(0,t.jsx)("div",{className:"p-4 border-t border-gray-100 flex-none",children:(0,t.jsx)("button",{disabled:0===w.length||g,onClick:T,className:`w-full px-4 py-2 rounded-xl font-bold ${0===w.length||g?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:g?"Đang thêm...":"Thêm vào nhóm"})})]})}),(0,t.jsx)(er,{isOpen:N,onClose:()=>S(!1),title:"Thành công",description:"Đã thêm thành viên vào nhóm thành công."})]}):null}function ei({groups:e,partner:s,onBack:n,onShowCreateGroup:l,onShowAddToGroup:o}){let[c,d]=(0,r.useState)(!1),[m,u]=(0,r.useState)(""),g=(0,r.useMemo)(()=>m.trim()?((0,h.normalizeNoAccent)(m),(0,h.hasDiacritics)(m),e.filter(e=>(0,h.accentAwareIncludes)(e.name||"",m))):e,[e,m]);return(0,t.jsxs)("div",{className:"flex flex-col h-full bg-white w-full",children:[(0,t.jsx)("div",{className:"bg-blue-500 text-white px-4 py-3 flex items-center justify-between shrink-0 h-[3.5rem]",children:c?(0,t.jsxs)("div",{className:"flex items-center gap-2 w-full animate-fadeIn",children:[(0,t.jsxs)("div",{className:"flex-1 bg-white/20 rounded-lg flex items-center px-3 py-1.5",children:[(0,t.jsx)(x.HiMagnifyingGlass,{className:"w-5 h-5 text-white/70"}),(0,t.jsx)("input",{autoFocus:!0,value:m,onChange:e=>u(e.target.value),placeholder:"Tìm nhóm...",className:"w-full bg-transparent border-none outline-none text-white placeholder-white/70 ml-2 text-sm"}),m&&(0,t.jsx)("button",{onClick:()=>u(""),children:(0,t.jsx)(i.HiX,{className:"w-5 h-5 text-white/70"})})]}),(0,t.jsx)("button",{onClick:()=>{d(!1),u("")},className:"text-black text-sm font-medium whitespace-nowrap cursor-pointer hover:bg-gray-300 p-1 rounded-xl",children:"Hủy"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("button",{onClick:n,className:"p-1 hover:bg-white/20 rounded-full cursor-pointer ",children:(0,t.jsx)(i.HiChevronLeft,{className:"w-6 h-6"})}),(0,t.jsxs)("h1",{className:"text-lg font-medium",children:["Nhóm chung (",e.length,")"]})]}),(0,t.jsx)("button",{onClick:()=>d(!0),className:"p-1 hover:bg-white/20 rounded-full cursor-pointer",children:(0,t.jsx)(x.HiMagnifyingGlass,{className:"w-6 h-6"})})]})}),!c&&(0,t.jsxs)("div",{className:"bg-white shrink-0",children:[(0,t.jsxs)("button",{onClick:l,className:"w-full flex items-center gap-4 px-4 py-3 hover:bg-gray-50 active:bg-gray-100",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500",children:(0,t.jsx)(x.HiPlus,{className:"w-6 h-6"})}),(0,t.jsxs)("span",{className:"text-blue-500 font-medium",children:["Tạo nhóm với ",s.name||s.username]})]}),(0,t.jsxs)("button",{onClick:o,className:"w-full flex items-center gap-4 px-4 py-3 hover:bg-gray-50 active:bg-gray-100",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500",children:(0,t.jsx)(i.HiUserAdd,{className:"w-6 h-6"})}),(0,t.jsxs)("span",{className:"text-blue-500 font-medium",children:["Thêm ",s.name||s.username," vào nhóm"]})]})]}),!c&&(0,t.jsx)("div",{className:"h-2 bg-gray-100 shrink-0"}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto ",children:[g.map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-4 px-4 py-3 hover:bg-gray-50 ",children:[(0,t.jsx)("div",{className:"relative w-12 h-12 rounded-full overflow-hidden border border-gray-100 shrink-0",children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:e.name||"Group",fill:!0,className:"object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold",children:(e.name||"G").charAt(0).toUpperCase()})}),(0,t.jsx)("span",{className:"text-[1.3rem] text-gray-800 truncate ",children:e.name||"Nhóm"})]},e._id)),0===g.length&&(0,t.jsx)("div",{className:"p-8 text-center text-gray-500",children:m?"Không tìm thấy nhóm nào":"Không có nhóm chung nào"})]})]})}function ea({isOpen:e,onClose:r,groups:s,partner:n,onShowCreateGroup:i,onShowAddToGroup:a}){return e?(0,t.jsx)("div",{className:"fixed inset-0 z-[100] bg-white md:bg-black/50 md:flex md:items-center md:justify-center",children:(0,t.jsx)("div",{className:"bg-white md:rounded-2xl shadow-2xl w-full h-full md:h-[45rem] md:max-w-md overflow-hidden flex flex-col",children:(0,t.jsx)(ei,{groups:s,partner:n,onBack:r,onShowCreateGroup:i,onShowAddToGroup:a})})}):null}function el(e){return(0,c.GenIcon)({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M892 772h-80v-80c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v80h-80c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h80v80c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8v-80h80c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zM373.5 498.4c-.9-8.7-1.4-17.5-1.4-26.4 0-15.9 1.5-31.4 4.3-46.5.7-3.6-1.2-7.3-4.5-8.8-13.6-6.1-26.1-14.5-36.9-25.1a127.54 127.54 0 0 1-38.7-95.4c.9-32.1 13.8-62.6 36.3-85.6 24.7-25.3 57.9-39.1 93.2-38.7 31.9.3 62.7 12.6 86 34.4 7.9 7.4 14.7 15.6 20.4 24.4 2 3.1 5.9 4.4 9.3 3.2 17.6-6.1 36.2-10.4 55.3-12.4 5.6-.6 8.8-6.6 6.3-11.6-32.5-64.3-98.9-108.7-175.7-109.9-110.8-1.7-203.2 89.2-203.2 200 0 62.8 28.9 118.8 74.2 155.5-31.8 14.7-61.1 35-86.5 60.4-54.8 54.7-85.8 126.9-87.8 204a8 8 0 0 0 8 8.2h56.1c4.3 0 7.9-3.4 8-7.7 1.9-58 25.4-112.3 66.7-153.5 29.4-29.4 65.4-49.8 104.7-59.7 3.8-1.1 6.4-4.8 5.9-8.8zM824 472c0-109.4-87.9-198.3-196.9-200C516.3 270.3 424 361.2 424 472c0 62.8 29 118.8 74.2 155.5a300.95 300.95 0 0 0-86.4 60.4C357 742.6 326 814.8 324 891.8a8 8 0 0 0 8 8.2h56c4.3 0 7.9-3.4 8-7.7 1.9-58 25.4-112.3 66.7-153.5C505.8 695.7 563 672 624 672c110.4 0 200-89.5 200-200zm-109.5 90.5C690.3 586.7 658.2 600 624 600s-66.3-13.3-90.5-37.5a127.26 127.26 0 0 1-37.5-91.8c.3-32.8 13.4-64.5 36.3-88 24-24.6 56.1-38.3 90.4-38.7 33.9-.3 66.8 12.9 91 36.6 24.8 24.3 38.4 56.8 38.4 91.4-.1 34.2-13.4 66.3-37.6 90.5z"},child:[]}]})(e)}function eo({isGroup:e,groupAvatar:r,groupName:s,chatName:n,isGroupAvatarUploading:i,avatarInputRef:l,onChangeGroupAvatar:o,onRenameGroup:c,myRole:d}){return(0,t.jsxs)("div",{className:"flex flex-col items-center mb-2 ",children:[(0,t.jsxs)("div",{className:"relative group",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>l.current?.click(),className:"cursor-pointer relative block focus:outline-none focus:ring-4 focus:ring-blue-300 rounded-full transition-all duration-300",disabled:i,title:"Nhấn để thay đổi ảnh nhóm",children:[(0,t.jsx)("div",{className:"w-20 h-20 rounded-full overflow-hidden shadow-2xl p-1",children:(0,t.jsxs)("div",{className:"w-full h-full rounded-full overflow-hidden bg-gray-200",children:[r?(0,t.jsx)(a.default,{width:100,height:100,src:(0,h.getProxyUrl)(r),alt:n||"Avatar nhóm",className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-105",onError:e=>{e.currentTarget.style.display="none",e.currentTarget.nextElementSibling?.classList.remove("hidden")}}):null,(0,t.jsx)("div",{className:`w-full h-full flex items-center justify-center text-4xl font-bold text-white ${r?"hidden":""}`,children:(0,t.jsx)(a.default,{width:40,height:40,src:"/logo/avata.webp",alt:n||"Avatar nhóm",className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"})})]})}),(0,t.jsx)("div",{className:`absolute inset-0 rounded-full flex flex-col items-center justify-center transition-all duration-300
              ${i?"bg-black/70 backdrop-blur-sm":"bg-black/50 backdrop-blur-sm opacity-0 group-hover:opacity-100"}`,children:i?(0,t.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,t.jsx)("div",{className:"w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"}),(0,t.jsx)("span",{className:"text-white text-sm font-medium",children:"Đang cập nhật..."})]}):(0,t.jsxs)("div",{className:"flex flex-col items-center gap-1",children:[(0,t.jsxs)("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]}),(0,t.jsx)("span",{className:"text-white text-xs font-medium",children:"Đổi ảnh"})]})})]}),(0,t.jsx)("button",{type:"button",onClick:()=>l.current?.click(),className:"absolute -bottom-1 -right-1 p-1.5 rounded-full bg-white shadow-lg  hover:bg-gray-50 transition",title:"Đổi ảnh nhóm",children:(0,t.jsxs)("svg",{className:"w-4 h-4 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})}),(0,t.jsx)("input",{type:"file",accept:"image/*",ref:l,className:"hidden",onChange:o})]}),(0,t.jsxs)("div",{className:"mt-6 flex items-center gap-3 ",children:[(0,t.jsx)("h3",{className:"text-xl font-medium text-gray-900 tracking-tight truncate max-w-[10rem]",children:s||"Nhóm chat"}),(0,t.jsx)("button",{onClick:c,className:"cursor-pointer p-1 rounded-xl  bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-all duration-200 hover:shadow-md active:scale-95",title:"Đổi tên nhóm",children:(0,t.jsx)(T.CiEdit,{className:"w-4 h-4"})})]}),e&&d&&"MEMBER"!==d&&(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)(b,{role:d})})]})}e.s(["default",()=>en],20608),e.s(["default",()=>ei],20978);var ec=e.i(92006);function ed({onClose:e,onShowCreateGroup:s,onMembersAdded:l,members:c,onJumpToMessage:d,onMemberRemoved:m,onRoleChange:u,onChatAction:g,reLoad:f,onLeftGroup:b,onRefresh:y,sendNotifyMessage:v,lastUpdated:j,initialSection:N,groups:S=[]}){let{messages:k,currentUser:M,allUsers:R,chatName:D,isGroup:B,selectedChat:F}=O(),z=(0,p.useToast)(),[G,W]=(0,r.useState)(!1),[X,J]=(0,r.useState)(B?F.avatar:void 0),[Q,Y]=(0,r.useState)(!1),[ei,ed]=(0,r.useState)(D||""),[em,eu]=(0,r.useState)(!1),[eh,ex]=(0,r.useState)(""),[eg,ep]=(0,r.useState)(null),[ef,eb]=(0,r.useState)(null),[ey,ev]=(0,r.useState)(!1),[ew,ej]=(0,r.useState)(!1),[eN,eS]=(0,r.useState)(!1),ek=(0,r.useRef)(null),[eC,e_]=(0,r.useState)(!1),[eT,eM]=(0,r.useState)(!1),[eA,eE]=(0,r.useState)("media"),[e$,eI]=(0,r.useState)(!1),[eL,eP]=(0,r.useState)(!1),[eH,eU]=(0,r.useState)(!0),[eR,eD]=(0,r.useState)("off"),[eO,eB]=(0,r.useState)(!1),[eF,ez]=(0,r.useState)(null),[eV,eG]=(0,r.useState)("group-avatar.jpg"),[eW,eX]=(0,r.useState)(null),[eJ,eK]=(0,r.useState)(!1),[eq,eQ]=(0,r.useState)(!1),[eY,eZ]=(0,r.useState)(!1),e0=(0,o.useRouter)(),[e1,e2]=(0,r.useState)(!1),[e5,e3]=(0,r.useState)(!1),[e4,e6]=(0,r.useState)(!1),e8=(0,r.useMemo)(()=>{if(B||!F||!S)return[];let e=String(F._id);return S.filter(t=>!!Array.isArray(t.members)&&t.members.some(t=>String("string"==typeof t?t:t._id||t.id)===e))},[S,F,B]),e9=String(M._id||M?.id||""),e7=(0,r.useMemo)(()=>{if(!B||!c)return"MEMBER";let e=c.find(e=>String(e._id||e.id)===e9);return e?.role||"MEMBER"},[c,e9,B]),[te,tt]=(0,r.useState)(null),[tr,ts]=(0,r.useState)(null),tn=B&&"OWNER"===e7;(0,r.useEffect)(()=>{ed(D||"")},[D]),(0,r.useEffect)(()=>{"reminder"===N?(ev(!0),eS(!1),W(!1)):"poll"===N?(eS(!0),ev(!1),W(!1)):"members"===N&&(ev(!1),eS(!1),B?W(!0):W(!1))},[N,B]);let{localIsPinned:ti,localIsHidden:ta,openItems:tl,activeMenuId:to,setActiveMenuId:tc,handleChatActionClick:td,toggleItem:tm,closeMenu:tu,mediaList:th,mediaGroups:tx,fileList:tg,fileGroups:tp,linkList:tf,linkGroups:tb,mediaTotal:ty,fileTotal:tv,linkTotal:tw,isMediaExpanded:tj,isFileExpanded:tN,isLinkExpanded:tS,fetchAssets:tk}=function({selectedChat:e,isGroup:t,messages:s,currentUser:n,onChatAction:i}){let a=e=>{if(!e)return"";if("string"==typeof e)return e;if("number"==typeof e)return String(e);if("object"==typeof e&&null!==e){if("_id"in e&&null!=e._id)return String(e._id);if("id"in e&&null!=e.id)return String(e.id)}return""},l=t?a(e):[a(n),a(e)].sort().join("_"),{isPinned:o,isHidden:c}=e,[d,m]=(0,r.useState)(!0===o),[u,h]=(0,r.useState)(!0===c),[x,g]=(0,r.useState)({}),[p,f]=(0,r.useState)(null);(0,r.useEffect)(()=>{m(!0===o),h(!0===c)},[l,o,c]);let[b,y]=(0,r.useState)([]),[v,w]=(0,r.useState)([]),[j,N]=(0,r.useState)([]),[S,k]=(0,r.useState)([]),[C,_]=(0,r.useState)([]),[T,M]=(0,r.useState)([]),[A,E]=(0,r.useState)(0),[$,I]=(0,r.useState)(0),[L,P]=(0,r.useState)(0),[H,U]=(0,r.useState)(!1),[R,D]=(0,r.useState)(!1),[O,B]=(0,r.useState)(!1),F=(0,r.useRef)(0),z=(0,r.useCallback)(e=>e.flatMap(e=>e.items??[]),[]),V=(0,r.useCallback)(async(e,t)=>{let r=F.current;try{let s=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readAssets",roomId:l,assetType:e,limit:t?5e3:6})}),n=await s.json();if(F.current!==r)return;let i=Array.isArray(n.groups)?n.groups:[];if("media"===e){let e=z(i),r="number"==typeof n.total?n.total:e.length;y(e.map(e=>({id:e.id,url:e.url,fileName:e.fileName,type:e.type,timestamp:e.timestamp}))),w(i.map(e=>({dateLabel:String(e.dateLabel||""),items:(e.items||[]).map(e=>({id:e.id,url:e.url,fileName:e.fileName,type:e.type,timestamp:e.timestamp}))}))),E(r),U(t)}else if("file"===e){let e=z(i),r="number"==typeof n.total?n.total:e.length;N(e.map(e=>({id:e.id,url:e.url,fileName:e.fileName||"Tài liệu",timestamp:e.timestamp}))),k(i.map(e=>({dateLabel:String(e.dateLabel||""),items:(e.items||[]).map(e=>({id:e.id,url:e.url,fileName:e.fileName||"Tài liệu",timestamp:e.timestamp}))}))),I(r),D(t)}else{let e=z(i),r="number"==typeof n.total?n.total:e.length;_(e),M(i.map(e=>({dateLabel:String(e.dateLabel||""),items:(e.items||[]).map(e=>({id:e.id,url:e.url,timestamp:e.timestamp}))}))),P(r),B(t)}}catch{}},[l,z]);return(0,r.useEffect)(()=>{if(!Array.isArray(s)||0===s.length)return;let e=s[s.length-1],t=/(\.mp4|\.mov|\.mkv|\.webm|\.avi|\.m4v)$/i,r="image"===e.type||"video"===e.type||"file"===e.type&&(t.test(String(e.fileUrl||""))||t.test(String(e.fileName||""))),n="file"===e.type&&!(t.test(String(e.fileUrl||""))||t.test(String(e.fileName||""))),i="text"===e.type&&/(https?:\/\/|www\.)\S+/i.test(String(e.content||""));r&&x["Ảnh/Video"]&&V("media",H),n&&x.File&&V("file",R),i&&x.Link&&V("link",O)},[s,x,H,R,O,V]),(0,r.useEffect)(()=>{x["Ảnh/Video"]&&0===b.length&&V("media",!1)},[x,b.length,V]),(0,r.useEffect)(()=>{x.File&&0===j.length&&V("file",!1)},[x,j.length,V]),(0,r.useEffect)(()=>{x.Link&&0===C.length&&V("link",!1)},[x,C.length,V]),(0,r.useEffect)(()=>{F.current+=1,g({}),f(null),y([]),w([]),N([]),k([]),_([]),M([]),E(0),I(0),P(0),U(!1),D(!1),B(!1)},[l]),{currentRoomId:l,localIsPinned:d,localIsHidden:u,openItems:x,activeMenuId:p,setActiveMenuId:f,handleChatActionClick:r=>{let s=t?l:a(e);if("pin"===r){let e=!d;m(e),i(s,"pin",e,t)}else if("hide"===r){let e=!u;h(e),i(s,"hide",e,t)}},toggleItem:e=>{g(t=>({...t,[e]:!t[e]}))},closeMenu:()=>f(null),mediaList:b,mediaGroups:v,fileList:j,fileGroups:S,linkList:C,linkGroups:T,mediaTotal:A,fileTotal:$,linkTotal:L,isMediaExpanded:H,isFileExpanded:R,isLinkExpanded:O,fetchAssets:V}}({selectedChat:F,isGroup:B,messages:k,currentUser:M,onChatAction:g}),tC=(0,r.useCallback)(()=>{e2(!0)},[]);(0,r.useEffect)(()=>{0===th.length&&tk("media",!1)},[th.length,tk]);let t_=(0,r.useMemo)(()=>[...th].filter(e=>"image"===e.type).sort((e,t)=>(t.timestamp||0)-(e.timestamp||0)).slice(0,4),[th]),tT=(e,t)=>[e,t].sort().join("_"),tM=B?String(F._id):tT(String(M._id),String(F._id));(0,r.useEffect)(()=>{try{let e=`roomMuted:${tM}:${String(M._id)}`,t="true"===localStorage.getItem(e);e_(t)}catch{}},[tM,M._id]);let[tA,tE]=(0,r.useState)(B?"":String(F.nicknames?.[e9]||"")),[t$,tI]=(0,r.useState)(()=>{let e=String(F._id);return String(M.nicknames?.[e]||"")});(0,r.useEffect)(()=>{B||tE(String(F.nicknames?.[e9]||""))},[B,F,e9]),(0,r.useEffect)(()=>{if(B)return;let e=String(F._id);(async()=>{try{let t=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:String(M._id)})}),r=await t.json(),s=r?.row??r,n=s?.nicknames?.[e]??"";tI(String(n||""))}catch{}})()},[B,F,M._id]),(0,r.useCallback)(()=>{tk("media",!tj)},[tk,tj]),(0,r.useCallback)(()=>{tk("file",!tN)},[tk,tN]),(0,r.useCallback)(()=>{tk("link",!tS)},[tk,tS]),(0,r.useEffect)(()=>{if(!B)try{let e=String(F._id),t=localStorage.getItem(`best_friend_${e}`);eP(!!t&&"1"===t);let r=localStorage.getItem(`call_alert_${tM}`);eU(!r||"1"===r);let s=localStorage.getItem(`auto_delete_${tM}`);eD("24h"===s?"24h":"7d"===s?"7d":"off")}catch{}},[B,F,tM]);let tL=(0,r.useCallback)(async e=>{let t=e.target.files?.[0];if(t&&B)try{let r=e.target,s=new FileReader;s.onload=()=>{ez(String(s.result||"")),eG(t.name||"group-avatar.jpg"),eX(()=>()=>{r.value=""}),eB(!0)},s.readAsDataURL(t)}catch{}},[B,F,M._id,M.name,f,v]),tP=async()=>{if(!B||eh.trim()===ei)return void eu(!1);try{if(!(await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"renameGroup",conversationId:F._id,data:{name:eh.trim()}})})).ok)throw Error();ed(eh.trim()),eu(!1);try{let e=M.name||"Một thành viên",t=`${e} đ\xe3 đổi t\xean nh\xf3m th\xe0nh "${eh.trim()}".`;await v?.(t)}catch{}try{let e=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),t=String(F._id),r=(c||[]).map(e=>({_id:String(e._id??e.id??"")}));e.emit("group_renamed",{roomId:t,groupName:eh.trim(),members:r,sender:String(M._id),senderName:M.name}),setTimeout(()=>e.disconnect(),500)}catch{}f?.()}catch{alert("Đổi tên nhóm thất bại.")}},tH=async()=>{try{if(!(await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"leaveGroup",conversationId:F._id,_id:M._id})})).ok)throw Error();let t=M.name||"Một thành viên",r=`${t} đ\xe3 rời nh\xf3m`;await v?.(r);try{let e=String(F._id),t=String(M._id),r=(c||[]).filter(e=>String(e._id??e.id??"")!==t).map(e=>({_id:String(e._id??e.id??""),role:e.role,name:e.name,avatar:e.avatar})),s=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});s.emit("group_members_updated",{roomId:e,members:r,sender:t,senderName:M.name}),setTimeout(()=>s.disconnect(),500)}catch{}f?.(),b?.(),e()}catch{alert("Rời nhóm thất bại.")}},tU=async()=>{try{if(!(await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"disbandGroup",conversationId:F._id,_id:M._id})})).ok)throw Error();e(),b?.(),f?.()}catch{alert("Giải tán nhóm thất bại.")}},tR=(0,r.useCallback)(async()=>{if(!B)throw Error("Not a group");let e=F._id,t=await fetch("/api/groups/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"generate",groupId:e})}),r=await t.json();if(!t.ok||!r.success)throw Error(r.message||"Tạo link thất bại");return r.inviteCode},[B,F]),tD=(0,r.useCallback)(async()=>{if(!B)throw Error("Not a group");let e=F._id,t=await fetch("/api/groups/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"regenerate",groupId:e})}),r=await t.json();if(!t.ok||!r.success)throw Error(r.message||"Tạo link mới thất bại");return f?.(),r.inviteCode},[B,F,f]),tO=(0,r.useCallback)(async(e,t)=>{if(F?._id&&M?._id)try{let r=String(e||"").trim();if(tE(r),!(await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateNickname",roomId:F._id,currentUserId:M._id,data:{nickname:r}})})).ok)throw Error();try{let e=tT(String(M._id),String(F._id));window.dispatchEvent(new CustomEvent("roomNicknamesUpdated",{detail:{roomId:e,targetUserId:String(F._id),nickname:r}}))}catch{}if(v&&!t?.silent){let e=M.name||"Bạn",t=F.name||F.username||"Người dùng",s=r?`${e} đ\xe3 đặt biệt danh cho ${t} l\xe0 "${r}".`:`${e} đ\xe3 x\xf3a biệt danh của ${t}.`;v(s)}}catch{tE(String(F.nicknames?.[e9]||F.name||"")),alert("Cập nhật biệt danh thất bại")}},[F,M,v,e9]),tB=(0,r.useCallback)(async e=>{if(F?._id&&M?._id)try{let t=String(F._id),r=String(e||"").trim();if(tI(r),!(await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateNickname",roomId:M._id,currentUserId:F._id,data:{nickname:r}})})).ok)throw Error();try{let e=tT(String(M._id),String(t));window.dispatchEvent(new CustomEvent("roomNicknamesUpdated",{detail:{roomId:e,targetUserId:String(M._id),nickname:r}}))}catch{}if(v){let e=M.name||"Bạn",t=r?`${e} đ\xe3 đặt biệt danh của ch\xednh m\xecnh l\xe0 "${r}".`:`${e} đ\xe3 x\xf3a biệt danh của ch\xednh m\xecnh.`;v(t)}}catch{let e=String(F._id);tI(String(M.nicknames?.[e]||M.name||"")),alert("Cập nhật biệt danh thất bại")}},[F,M,v]);return(0,t.jsxs)(t.Fragment,{children:[ey?(0,t.jsx)(V,{onClose:()=>ev(!1)}):ew?(0,t.jsx)(q,{onClose:()=>ej(!1),onJumpToMessage:d}):eN?(0,t.jsx)(K,{onClose:()=>eS(!1),onRefresh:y}):(0,t.jsxs)("div",{className:"flex flex-col h-full bg-gray-50 overflow-hidden",children:[(0,t.jsxs)("div",{className:"bg-blue-400 to-indigo-700 text-white p-3 flex items-center justify-between shadow-lg",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:e,className:"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200 block sm:hidden","aria-label":"Quay lại",children:(0,t.jsx)(i.HiChevronLeft,{className:"w-5 h-5"})}),(0,t.jsx)("h2",{className:"text-lg font-semibold",children:"Tùy chọn"})]}),(0,t.jsx)("div",{className:"hidden sm:block",children:(0,t.jsx)("button",{onClick:e,className:"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200","aria-label":"Đóng",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300",children:(0,t.jsxs)("div",{className:"space-y-3  bg-gray-200",children:[(0,t.jsxs)("div",{className:"bg-white p-5",children:[B?(0,t.jsx)(eo,{isGroup:B,groupAvatar:X,groupName:ei,chatName:D,isGroupAvatarUploading:Q,avatarInputRef:ek,onChangeGroupAvatar:tL,onRenameGroup:()=>{ex(ei),eu(!0)},myRole:e7}):(0,t.jsx)(_,{userName:tA||F.nicknames?.[e9]||F.name||F.username||"Người dùng",userAvatar:F.avatar,onUpdateNickname:tO}),(0,t.jsx)(A,{isGroup:B,localIsPinned:ti,localIsHidden:ta,onPinToggle:()=>td("pin"),onHideToggle:()=>td("hide"),onCreateGroup:()=>{s(),e()},onOpenMembers:()=>W(!0),onSearchMessages:()=>{try{let e=new CustomEvent("openRoomSearch",{detail:{roomId:tM}});window.dispatchEvent(e)}catch{}},onChangeWallpaper:()=>{alert("Tính năng đổi hình nền sẽ sớm có mặt.")},isMuted:eC,onToggleMute:()=>{let e=!eC;e_(e);try{let t=`roomMuted:${tM}:${String(M._id)}`;localStorage.setItem(t,String(e));let r=new CustomEvent("roomMutedChanged",{detail:{roomId:tM,muted:e}});window.dispatchEvent(r)}catch{}},onOpenProfile:()=>{if(!B){let e=String(F._id);e&&e0.push(`/profile/${e}`)}}})]}),B&&(0,t.jsx)("div",{className:"bg-white  border border-gray-200",children:(0,t.jsxs)("button",{className:"cursor-pointer w-full p-2 flex items-center justify-between hover:bg-gray-50 transition-all",title:"Thêm mô tả nhóm",children:[(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Thêm mô tả nhóm"}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]})}),!B&&(0,t.jsx)("div",{className:"bg-white shadow-sm border border-gray-100 overflow-hidden mt-2",children:(0,t.jsxs)("div",{className:"divide-y divide-gray-100",children:[(0,t.jsxs)("button",{onClick:()=>{tt({id:String(F._id),name:F.name||F.username||"Người dùng",currentVal:tA})},className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(T.CiEdit,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Đổi tên gọi nhớ"})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),(0,t.jsxs)("div",{className:"px-5 py-4 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(T.CiStar,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Đánh dấu bạn thân"})]}),(0,t.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,t.jsx)("input",{type:"checkbox",className:"sr-only peer",checked:eL,onChange:()=>{alert("Chức năng đang được hoàn thiện")}}),(0,t.jsx)("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors"}),(0,t.jsx)("div",{className:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow"})]})]}),(0,t.jsxs)("button",{onClick:()=>alert("Chức năng đang được hoàn thiện"),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiBookmarkCheck,{className:"w-6 h-6 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Nhật ký chung"})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]})]})}),(0,t.jsxs)("div",{className:"bg-white  shadow-sm border border-gray-200 mt-2",children:[(0,t.jsxs)("button",{onClick:()=>{eM(!0),tk("media",!0),tk("file",!0),tk("link",!0)},className:"cursor-pointer w-full py-4 px-5 flex items-center justify-between hover:bg-gray-50 transition-all duration-200 group",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(T.CiImageOn,{className:"w-5 h-5"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-900",children:"Ảnh, file, link"})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),(0,t.jsx)("div",{className:"pl-5 pr-1 pb-2 border-t border-gray-100",children:t_.length>0?(0,t.jsxs)("div",{className:"grid grid-cols-5 gap-[0.125rem] mt-2",children:[t_.map(e=>(0,t.jsxs)("div",{className:"relative aspect-square rounded-[0.25rem] overflow-hidden bg-gray-100 cursor-pointer group",onClick:()=>{eE("media"),eM(!0)},children:[(0,t.jsx)(a.default,{width:200,height:200,src:(0,h.getProxyUrl)(e.url),alt:"Ảnh",className:"w-full h-full object-cover"}),(0,t.jsx)(P,{itemUrl:e.url,itemId:e.id,fileName:e.fileName,activeMenuId:to,onClose:tu,onJumpToMessage:d,onShareById:e=>{try{let t=new CustomEvent("shareMessage",{detail:{messageId:e}});window.dispatchEvent(t)}catch{}}})]},e.id)),(0,t.jsx)("div",{className:"relative aspect-square rounded-[0.25rem] overflow-hidden bg-gray-100 cursor-pointer group flex items-center justify-center",onClick:()=>{eE("media"),eM(!0),tk("media",!0),tk("file",!0),tk("link",!0)},title:"Xem tất cả ảnh, file, link",children:(0,t.jsx)(T.CiPlay1,{className:"w-4 h-4 text-gray-400"})})]}):(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"Chưa có ảnh nào"})}),(0,t.jsxs)("div",{className:"pt-2",children:[(0,t.jsx)(I,{onOpen:()=>ev(!0)}),(0,t.jsx)(ee,{onOpen:()=>ej(!0)}),B&&(0,t.jsx)(L,{onOpen:()=>eS(!0)})]})]}),!B&&(0,t.jsx)("div",{className:"bg-white shadow-sm border border-gray-100 overflow-hidden",children:(0,t.jsxs)("div",{className:"divide-y divide-gray-100",children:[(0,t.jsxs)("button",{onClick:()=>{try{window.__createGroupInitialMemberIds=[String(F._id)]}catch{}s()},className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiCirclePlus,{className:"w-5 h-5 text-gray-600"}),(0,t.jsxs)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:["Tạo nhóm với ",F.name||F.username||"Người dùng"]})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),(0,t.jsxs)("button",{onClick:()=>{tC()},className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between   hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(el,{className:"w-5 h-5 text-gray-600"}),(0,t.jsxs)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800 ",children:["Thêm ",F.name||F.username||"Người dùng"," vào nhóm"]})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),(0,t.jsxs)("button",{onClick:()=>e3(!0),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiUser,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Xem nhóm chung"})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]})]})}),(0,t.jsxs)("div",{className:"bg-white space-y-2",children:[B&&(0,t.jsx)($,{isGroup:B,groupName:ei,membersCount:F.members.length,onOpenMembers:()=>W(!0)}),B&&(0,t.jsx)(Z,{groupId:F._id,inviteCode:F.inviteCode,onGenerateLink:tR,onRegenerateLink:tD})]}),(0,t.jsx)("div",{className:"bg-white  shadow-sm border border-gray-100 overflow-hidden",children:(0,t.jsxs)("div",{className:"divide-y divide-gray-100",children:[(0,t.jsxs)("div",{className:"px-5 py-4 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,t.jsx)(T.CiMapPin,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Ghim trò chuyện"})]}),(0,t.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,t.jsx)("input",{type:"checkbox",className:"sr-only peer",checked:ti,onChange:()=>td("pin")}),(0,t.jsx)("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors"}),(0,t.jsx)("div",{className:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow"})]})]}),(0,t.jsxs)("div",{className:"px-5 py-4 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiUnread,{className:"w-5 h-5 text-gray-500"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Ẩn trò chuyện"})]}),(0,t.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,t.jsx)("input",{type:"checkbox",className:"sr-only peer",checked:ta,onChange:()=>td("hide")}),(0,t.jsx)("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors"}),(0,t.jsx)("div",{className:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow"})]})]}),!B&&(0,t.jsxs)("div",{className:"px-5 py-4 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiBellOn,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Báo cuộc gọi đến"})]}),(0,t.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,t.jsx)("input",{type:"checkbox",className:"sr-only peer",checked:eH,onChange:()=>{alert("Chức năng đang được hoàn thiện")}}),(0,t.jsx)("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors"}),(0,t.jsx)("div",{className:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow"})]})]}),!B&&(0,t.jsxs)("button",{onClick:()=>alert("Chức năng đang được hoàn thiện"),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiSettings,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Cài đặt cá nhân"})]}),(0,t.jsx)(x.HiChevronRight,{className:"w-4 h-4 text-gray-400"})]}),!B&&(0,t.jsxs)("button",{onClick:()=>alert("Chức năng đang được hoàn thiện"),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiAlarmOn,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Tin nhắn tự xóa"})]}),(0,t.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"off"===eR?"Không tự xóa":"24h"===eR?"24 giờ":"7 ngày"})]}),!B&&(0,t.jsx)("button",{onClick:()=>eZ(!0),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiCircleInfo,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Báo xấu"})]})}),(!B||B&&"OWNER"===e7)&&(0,t.jsx)("button",{className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiTrash,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Xóa lịch sử"})]})}),!B&&(0,t.jsx)("button",{onClick:()=>alert("Chức năng đang được hoàn thiện"),className:"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(T.CiNoWaitingSign,{className:"w-5 h-5 text-gray-600"}),(0,t.jsx)("span",{className:"text-[1.125rem] md:text-[1rem] text-gray-800",children:"Quản lý chặn"})]})})]})}),B&&(0,t.jsx)(E,{canLeaveGroup:B,canDisbandGroup:tn,onLeaveClick:()=>eb("leave"),onDisbandClick:()=>eb("disband")})]})})]}),e$&&!B&&(0,t.jsx)(et.default,{isOpen:e$,onClose:()=>eI(!1),user:F}),eJ&&!B&&(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-md px-4",onClick:()=>eK(!1),children:(0,t.jsxs)("div",{className:"w-full max-w-[25rem] bg-white rounded-lg shadow-2xl h-auto max-h-[90vh] overflow-hidden no-scrollbar relative flex flex-col",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100",children:[(0,t.jsx)("h3",{className:"text-base font-bold text-gray-900",children:"Tin nhắn tự xóa"}),(0,t.jsx)("button",{onClick:()=>eK(!1),className:"text-gray-500 hover:text-gray-700 cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"p-4 space-y-2",children:[(0,t.jsx)("button",{onClick:()=>{eD("off");try{localStorage.setItem(`auto_delete_${tM}`,"off")}catch{}eK(!1)},className:`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${"off"===eR?"bg-blue-50 text-blue-700":"hover:bg-gray-100"}`,children:"Không tự xóa"}),(0,t.jsx)("button",{onClick:()=>{eD("24h");try{localStorage.setItem(`auto_delete_${tM}`,"24h")}catch{}eK(!1)},className:`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${"24h"===eR?"bg-blue-50 text-blue-700":"hover:bg-gray-100"}`,children:"24 giờ"}),(0,t.jsx)("button",{onClick:()=>{eD("7d");try{localStorage.setItem(`auto_delete_${tM}`,"7d")}catch{}eK(!1)},className:`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${"7d"===eR?"bg-blue-50 text-blue-700":"hover:bg-gray-100"}`,children:"7 ngày"})]})]})}),G&&B&&(0,t.jsx)(w,{allUsers:R,currentUser:M,isOpen:G,onClose:()=>W(!1),members:c||[],groupName:D,onMembersAdded:l,conversationId:F._id,onMemberRemoved:m,onRoleChange:u,sendNotifyMessage:v,lastUpdated:j}),te&&!B&&(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/20 backdrop-blur-md px-4",onClick:()=>tt(null),children:(0,t.jsxs)("div",{className:"w-full max-w-[400px] bg-white rounded-lg shadow-2xl h-auto max-h-[90vh] overflow-hidden no-scrollbar relative flex flex-col",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-100",children:[(0,t.jsx)("h3",{className:"text-base font-bold text-gray-900",children:"Đặt biệt danh"}),(0,t.jsx)("button",{onClick:()=>tt(null),className:"text-gray-500 hover:text-gray-700 cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsxs)("div",{className:"p-4 space-y-4",children:[(0,t.jsxs)("p",{className:"text-sm text-gray-600",children:["Đặt biệt danh cho ",(0,t.jsx)("b",{children:te.name})," trong cuộc trò chuyện này."]}),(0,t.jsx)("input",{type:"text",autoFocus:!0,defaultValue:te.currentVal||te.name,className:"w-full px-4 py-2 border border-gray-300 rounded-[0.5rem] focus:outline-none",placeholder:"Nhập biệt danh...",onKeyDown:e=>{"Enter"===e.key&&(tO((e.currentTarget.value||"").trim()),tt(null))},id:"personal-nickname-input"}),(0,t.jsxs)("div",{className:"flex gap-2 justify-end pt-2",children:[(0,t.jsx)("button",{onClick:()=>tt(null),className:"px-4 py-2 cursor-pointer text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-colors",children:"Hủy"}),(0,t.jsx)("button",{onClick:()=>{tO(String(document.getElementById("personal-nickname-input")?.value||"").trim()),tt(null)},className:"px-4 py-2 cursor-pointer bg-blue-500 text-white font-bold rounded-[0.5rem] hover:bg-blue-600 transition-all shadow-lg shadow-blue-200",children:"Lưu"})]})]})]})}),e1&&!B&&(0,t.jsx)(en,{isOpen:e1,onClose:()=>e2(!1),currentUser:M,selectedChat:F,onShowCreateGroup:()=>{window.innerWidth<768?(e2(!1),setTimeout(()=>s(),300)):s()},reLoad:f}),e5&&!B&&(0,t.jsx)(ea,{isOpen:e5,onClose:()=>e3(!1),groups:e8,partner:F,onShowCreateGroup:()=>{if(window.innerWidth<768)e3(!1),setTimeout(()=>{try{window.__createGroupInitialMemberIds=[String(F._id)]}catch{}s()},300);else{try{window.__createGroupInitialMemberIds=[String(F._id)]}catch{}s()}},onShowAddToGroup:()=>{e3(!1),setTimeout(()=>e2(!0),300)}}),(0,t.jsx)(er,{isOpen:e4,onClose:()=>e6(!1),title:"Thành công",description:"Đã thêm thành viên vào nhóm thành công."}),eq&&(0,t.jsx)(es.ConfirmModal,{title:"Xóa lịch sử",message:"Bạn có chắc muốn xóa toàn bộ lịch sử trò chuyện?",onCancel:()=>eQ(!1),onConfirm:async()=>{eQ(!1);try{if((await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"clearHistory",roomId:tM})})).ok){z({type:"success",message:"Đã xóa lịch sử trò chuyện"});try{window.dispatchEvent(new CustomEvent("chatHistoryCleared",{detail:{roomId:tM}}))}catch{}try{y?.()}catch{}}else z({type:"error",message:"Xóa lịch sử thất bại"})}catch{z({type:"error",message:"Lỗi khi xóa lịch sử"})}},confirmText:"Xóa",variant:"danger"}),eY&&(0,t.jsx)(es.ConfirmModal,{title:"Báo xấu",message:"Bạn có muốn báo cáo cuộc trò chuyện này?",onCancel:()=>eZ(!1),onConfirm:async()=>{eZ(!1);try{await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:{roomId:tM,sender:M._id,type:"notify",content:"Bạn đã báo xấu cuộc trò chuyện này"}})}),z({type:"success",message:"Đã gửi báo xấu"})}catch{z({type:"error",message:"Gửi báo xấu thất bại"})}},confirmText:"Báo xấu",variant:"warning"}),tr&&!B&&(0,t.jsx)("div",{className:"absolute inset-0 z-40 flex items-center justify-center bg-black/50 p-4",children:(0,t.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50",children:[(0,t.jsx)("h3",{className:"font-bold text-gray-800",children:"Đặt biệt danh của bạn"}),(0,t.jsx)("button",{onClick:()=>ts(null),className:"p-2 hover:bg-gray-200 rounded-full cursor-pointer transition-colors",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5 text-gray-500"})})]}),(0,t.jsxs)("div",{className:"p-4 space-y-4",children:[(0,t.jsxs)("p",{className:"text-sm text-gray-600",children:["Biệt danh của bạn sẽ hiển thị với ",(0,t.jsx)("b",{children:F.name||"đối phương"}),"."]}),(0,t.jsx)("input",{type:"text",autoFocus:!0,defaultValue:tr.currentVal||tr.name,className:"w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"Nhập biệt danh...",onKeyDown:e=>{"Enter"===e.key&&(tB((e.currentTarget.value||"").trim()),ts(null))},id:"self-nickname-input"}),(0,t.jsxs)("div",{className:"flex gap-2 justify-end pt-2",children:[(0,t.jsx)("button",{onClick:()=>ts(null),className:"px-4 py-2 text-gray-600 cursor-pointer font-medium hover:bg-gray-100 rounded-xl transition-colors",children:"Hủy"}),(0,t.jsx)("button",{onClick:()=>{tB(String(document.getElementById("self-nickname-input")?.value||"").trim()),ts(null)},className:"px-4 py-2 cursor-pointer  bg-blue-500 text-white font-bold rounded-[0.5rem] hover:bg-blue-600 transition-all shadow-lg shadow-blue-200",children:"Lưu"})]})]})]})}),em&&B&&(0,t.jsx)(H,{isOpen:em,renameInput:eh,onChangeInput:ex,onClose:()=>eu(!1),onSubmit:tP}),ef&&B&&(0,t.jsx)(U,{confirmAction:ef,onCancel:()=>eb(null),onConfirmLeave:tH,onConfirmDisband:tU}),(0,t.jsx)(C,{media:eg,chatName:D,isGroup:B,roomId:tM,onClose:()=>ep(null)}),eT&&(0,t.jsxs)("div",{className:`${window.innerWidth>=1024?"absolute inset-0":"fixed inset-0"} z-50 flex flex-col bg-white`,children:[(0,t.jsx)("div",{className:"bg-blue-400 text-white p-3 flex items-center justify-between shadow-lg",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>eM(!1),className:"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200",children:(0,t.jsx)(i.HiChevronLeft,{className:"w-5 h-5"})}),(0,t.jsx)("h2",{className:"text-lg font-semibold",children:"Ảnh, file, link"})]})}),(0,t.jsxs)("div",{className:"p-3 bg-white border-b border-gray-200 flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>eE("media"),className:`cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${"media"===eA?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:"Ảnh"}),(0,t.jsx)("button",{onClick:()=>eE("file"),className:` cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${"file"===eA?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:"File"}),(0,t.jsx)("button",{onClick:()=>eE("link"),className:`cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${"link"===eA?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:"Link"})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto",children:["media"===eA&&(0,t.jsx)("div",{className:"px-5 py-4",children:(tx&&tx.length>0?tx:[{dateLabel:"",items:th}]).map((e,r)=>(0,t.jsxs)("div",{className:"mt-4",children:[e.dateLabel&&(0,t.jsx)("div",{className:"text-xs font-semibold text-gray-500 mb-2",children:e.dateLabel}),(0,t.jsx)("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:e.items.map(e=>(0,t.jsxs)("div",{className:`relative aspect-square rounded-xl cursor-pointer ${"video"===e.type?" w-full h-full flex gap-2":""}  group bg-gray-100 ${to===e.id?"z-50":"z-0"}`,onClick:()=>{let t="video"===e.type?"video":"image";ep({url:e.url,type:t})},children:["video"===e.type?(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(e.url),className:"w-full h-full object-cover pointer-events-none",preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-8 h-8 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(x.HiPlay,{className:"w-5 h-5 text-blue-600 ml-0.5"})})})]}):(0,t.jsx)(a.default,{width:200,height:200,src:(0,h.getProxyUrl)(e.url),alt:"Media",className:"w-full h-full object-cover"}),(0,t.jsx)("button",{className:`cursor-pointer absolute top-2 right-2 p-1.5 bg-white/90 backdrop-blur-sm rounded-full shadow-lg transition-all duration-200 z-10 ${to===e.id?"opacity-100 ring-2 ring-blue-500":"opacity-0 group-hover:opacity-100"} hover:bg-white hover:scale-110`,onClick:t=>{t.stopPropagation(),tc(to===e.id?null:e.id)},children:(0,t.jsxs)("svg",{className:"w-4 h-4 text-gray-700",viewBox:"0 0 24 24",fill:"currentColor",children:[(0,t.jsx)("circle",{cx:"5",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"19",cy:"12",r:"2"})]})}),(0,t.jsx)(P,{itemUrl:e.url,itemId:e.id,fileName:e.fileName,activeMenuId:to,onClose:tu,onJumpToMessage:d,onShareById:e=>{try{let t=new CustomEvent("shareMessage",{detail:{messageId:e}});window.dispatchEvent(t)}catch{}}})]},e.id))})]},`${e.dateLabel}-${r}`))}),"file"===eA&&(0,t.jsx)("div",{className:"px-5 py-4",children:(tp&&tp.length>0?tp:[{dateLabel:"",items:tg}]).map((e,r)=>(0,t.jsxs)("div",{className:"mt-4",children:[e.dateLabel&&(0,t.jsx)("div",{className:"text-xs font-semibold text-gray-500 mb-2",children:e.dateLabel}),(0,t.jsx)("div",{className:"space-y-3",children:e.items.map(e=>(0,t.jsxs)("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 transition-all duration-200 group cursor-pointer border border-gray-200 hover:border-blue-300",onClick:()=>window.open(e.url,"_blank"),children:[(0,t.jsx)("div",{className:"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 text-white shadow-lg",children:(0,t.jsx)("svg",{className:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor",children:(0,t.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"})})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate group-hover:text-blue-600 transition-colors",children:e.fileName})}),(0,t.jsx)("button",{className:`cursor-pointer p-2 rounded-full  bg-white/90 backdrop-blur-sm shadow-md transition-all duration-200 z-10 ${to===e.id?"opacity-100 ring-2 ring-blue-500":"opacity-0 group-hover:opacity-100"} hover:bg-white hover:scale-110`,onClick:t=>{t.stopPropagation(),tc(to===e.id?null:e.id)},children:(0,t.jsxs)("svg",{className:"w-4 h-4 text-gray-700",viewBox:"0 0 24 24",fill:"currentColor",children:[(0,t.jsx)("circle",{cx:"5",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"19",cy:"12",r:"2"})]})}),(0,t.jsx)(P,{itemUrl:e.url,itemId:e.id,fileName:e.fileName,activeMenuId:to,onClose:tu,onJumpToMessage:d,onShareById:e=>{try{let t=new CustomEvent("shareMessage",{detail:{messageId:e}});window.dispatchEvent(t)}catch{}}})]},e.id))})]},`${e.dateLabel}-${r}`))}),"link"===eA&&(0,t.jsx)("div",{className:"px-5 py-4",children:(tb&&tb.length>0?tb:[{dateLabel:"",items:tf}]).map((e,r)=>(0,t.jsxs)("div",{className:"mt-4",children:[e.dateLabel&&(0,t.jsx)("div",{className:"text-xs font-semibold text-gray-500 mb-2",children:e.dateLabel}),(0,t.jsx)("div",{className:"space-y-3",children:e.items.map(e=>{let r=e.url.startsWith("http")?e.url:`https://${e.url}`;return(0,t.jsxs)("div",{className:"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 transition-all duration-200 group cursor-pointer border border-gray-200 hover:border-purple-300",onClick:()=>window.open(r,"_blank"),children:[(0,t.jsx)("div",{className:"p-3 rounded-xl bg-gradient-to-br from-sky-500 via-blue-500 to-blue-500 text-white shadow-lg",children:(0,t.jsx)("svg",{className:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor",children:(0,t.jsx)("path",{d:"M3.9 12a5 5 0 0 1 5-5h4a5 5 0 0 1 0 10h-4a5 5 0 0 1-5-5zm7-3h2a3 3 0 0 1 0 6h-2a3 3 0 0 1 0-6z"})})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsx)("p",{className:"text-sm font-semibold text-purple-600 truncate group-hover:underline transition-all",children:e.url})}),(0,t.jsx)("button",{className:`cursor-pointer p-2 rounded-full bg-white/90 backdrop-blur-sm shadow-md transition-all duration-200 z-10 ${to===e.id?"opacity-100 ring-2 ring-purple-500":"opacity-0 group-hover:opacity-100"} hover:bg-white hover:scale-110`,onClick:t=>{t.stopPropagation(),tc(to===e.id?null:e.id)},children:(0,t.jsxs)("svg",{className:"w-4 h-4 text-gray-700",viewBox:"0 0 24 24",fill:"currentColor",children:[(0,t.jsx)("circle",{cx:"5",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,t.jsx)("circle",{cx:"19",cy:"12",r:"2"})]})}),(0,t.jsx)(P,{itemUrl:e.url,itemId:e.id,activeMenuId:to,onClose:tu,onJumpToMessage:d,onShareById:e=>{try{let t=new CustomEvent("shareMessage",{detail:{messageId:e}});window.dispatchEvent(t)}catch{}}})]},e.id)})})]},`${e.dateLabel}-${r}`))})]})]}),(0,t.jsx)(ec.default,{open:eO,src:eF,onClose:()=>eB(!1),onConfirm:async e=>{if(B){Y(!0);try{let t=F._id,r=new FormData;r.append("file",e),r.append("roomId",String(t)),r.append("sender",String(M._id)),r.append("type","image"),r.append("folderName",`GroupAvatar_${t}`),r.append("skipSaveMessage","true");let s=await fetch(`/api/upload?uploadId=group-avatar-${t}-${Date.now()}`,{method:"POST",body:r}),n=await s.json();if(!s.ok||!n?.success||!n?.link)throw Error("Upload failed");if(!(await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateAvatar",conversationId:t,data:{avatar:n.link}})})).ok)throw Error("Update failed");J(n.link);try{let e=M.name||"Một thành viên",t=`${e} đ\xe3 đổi ảnh đại diện nh\xf3m.`;await v?.(t)}catch{}f?.()}catch{alert("Cập nhật ảnh nhóm thất bại. Vui lòng thử lại.")}finally{Y(!1),eW?.(),eB(!1),ez(null)}}},aspectRatio:1,circle:!0,fileName:eV,outputType:"image/jpeg",quality:.92})]})}function em({onClose:e,onConfirm:s}){let[n,i]=(0,r.useState)("");return(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100",children:[(0,t.jsxs)("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[(0,t.jsx)(x.HiMapPin,{className:"w-5 h-5 text-blue-600"}),"Ghim tin nhắn"]}),(0,t.jsx)("button",{onClick:e,className:"cursor-pointer p-1.5 hover:bg-gray-100 rounded-full text-gray-500 transition-colors",children:(0,t.jsx)(x.HiXMark,{className:"w-5 h-5"})})]}),(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),s(n)},className:"p-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"Bạn có thể đặt tiêu đề cho tin nhắn ghim này (tùy chọn):"}),(0,t.jsx)("input",{type:"text",value:n,onChange:e=>i(e.target.value),placeholder:"Nhập tiêu đề...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",autoFocus:!0}),(0,t.jsxs)("div",{className:"flex justify-end gap-2 mt-5",children:[(0,t.jsx)("button",{type:"button",onClick:e,className:"cursor-pointer px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",children:"Hủy"}),(0,t.jsx)("button",{type:"submit",className:"cursor-pointer px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm",children:"Ghim"})]})]})]})})}function eu({chatName:e,isGroup:s,memberCount:n,showPopup:i,onTogglePopup:l,onOpenMembers:o,showSearchSidebar:c,onToggleSearchSidebar:d,avatar:m,onBackFromChat:u,presenceText:g,presenceOnline:p,onVoiceCall:f,onVideoCall:b,isMobile:y=!1,isSearchActive:v=!1,initialKeyword:w=null,onSearchTermChange:j,onSearchFocus:N,searchInputRef:S}){let[k,C]=(0,r.useState)(!1),[_,M]=(0,r.useState)(""),A=(0,r.useRef)(!1),E=(0,r.useRef)(null),$=(0,r.useRef)(!1);return((0,r.useEffect)(()=>{C(!1)},[m]),(0,r.useEffect)(()=>{let e=(w||"").trim();if(e&&(M(e),y&&v)){if(E.current===e&&A.current)return;A.current=!0,E.current=e,setTimeout(()=>{S?.current?.focus?.()},100),j?.(e)}},[w,y,v,j]),(0,r.useEffect)(()=>{y&&!v&&$.current&&($.current=!1,A.current=!1,E.current=null)},[v,y,j]),y&&v)?(0,t.jsxs)("div",{className:"flex items-center gap-2 px-2 py-2 bg-white border-b border-gray-200 shadow-sm",children:[(0,t.jsx)("button",{onClick:()=>{v?($.current=!0,M(""),j?.(""),d?.()):u?.()},className:"p-2 rounded-full hover:bg-gray-100 transition-colors cursor-pointer flex-shrink-0",title:"Quay lại",children:(0,t.jsx)(x.HiArrowLeft,{className:"w-5 h-5 text-gray-700"})}),(0,t.jsx)(T.CiSearch,{className:"w-5 h-5 text-gray-500 flex-shrink-0"}),(0,t.jsxs)("div",{className:"flex-1 relative",children:[(0,t.jsx)("input",{ref:S,type:"text",value:_,onChange:e=>{M(e.target.value),j?.(e.target.value)},onFocus:N,placeholder:"Tìm kiếm...",className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base",autoFocus:!0}),_&&(0,t.jsx)("button",{onClick:()=>{M(""),j?.("")},className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full hover:bg-gray-200 transition-colors cursor-pointer",children:(0,t.jsx)(x.HiXMark,{className:"w-4 h-4 text-gray-500"})})]})]}):(0,t.jsxs)("div",{className:"flex items-center cursor-pointer justify-between px-2 bg-blue-400  md:bg-white border-b border-gray-200 shadow-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[u&&(0,t.jsx)("button",{onClick:u,className:"p-2 rounded-full   transition-colors lg:hidden cursor-pointer",title:"Quay lại",children:(0,t.jsx)(x.HiArrowLeft,{className:"w-5 h-5 text-white md:text-gray-600"})}),(0,t.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,t.jsx)("div",{className:`
            w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md overflow-hidden ring-2 ring-white
            ${s?"bg-gradient-to-br from-blue-500 to-indigo-600":"bg-gradient-to-br from-gray-400 to-gray-600"}
          `,children:m&&!k?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(m),alt:e,width:40,height:40,className:"w-full h-full object-cover",onError:()=>C(!0)}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:e,width:40,height:40,className:"w-full h-full object-cover"})}),!s&&(0,t.jsx)("div",{className:`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white shadow-sm ${p?"bg-green-500":"bg-gray-400"}`})]}),(0,t.jsxs)("button",{onClick:o,className:" cursor-pointer text-left md:hover:bg-gray-50 rounded-xl px-3 py-2 -ml-2 transition-colors",children:[(0,t.jsx)("h1",{className:"font-semibold text-white md:text-gray-900 truncate w-[150px] md:w-full md:max-w-[300px] text-base",children:e}),(0,t.jsx)("p",{className:"text-xs text-white md:text-gray-500 flex items-center gap-1 mt-0.5",children:s?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiUserGroup,{className:"w-3.5 h-3.5"}),n," thành viên"]}):(0,t.jsx)(t.Fragment,{children:g||"Đang hoạt động"})})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsxs)(t.Fragment,{children:["function"==typeof f&&!s&&(0,t.jsx)("button",{onClick:f,className:"p-2 rounded-full cursor-pointer transition-all duration-200 hover:bg-gray-600 md:hover:bg-gray-100 text-white md:text-gray-600",title:"Gọi thoại",children:(0,t.jsx)(T.CiPhone,{className:"w-5 h-5"})}),"function"==typeof b&&(0,t.jsx)("button",{onClick:b,className:"p-2 rounded-full cursor-pointer transition-all duration-200 hover:bg-gray-600 md:hover:bg-gray-100 text-white md:text-gray-600",title:"Gọi video",children:(0,t.jsx)(T.CiVideoOn,{className:"w-5 h-5"})})]}),(0,t.jsx)("button",{onClick:()=>{y||i&&l(),d&&d()},className:`
            p-2 rounded-full text-white md:text-gray-600 cursor-pointer transition-all duration-200
            ${c||v?"bg-blue-100 text-blue-600 shadow-sm":"hover:bg-gray-600 md:hover:bg-gray-100 text-gray-600"}
          `,title:"Tìm kiếm tin nhắn",children:(0,t.jsx)(T.CiSearch,{className:"w-5 h-5"})}),(0,t.jsxs)("button",{onClick:()=>{c&&d(),l()},className:`
            p-2 rounded-full text-white md:text-gray-600 cursor-pointer transition-all duration-200 relative
            ${i?"bg-blue-100 text-blue-600 shadow-sm":"hover:bg-gray-600 md:hover:bg-gray-100 text-gray-600"}
          `,title:"Thông tin trò chuyện",children:[(0,t.jsx)(x.HiEllipsisVertical,{className:"w-4 h-4"}),i&&(0,t.jsx)("div",{className:"absolute top-0 right-0 w-2 h-2 bg-blue-600 rounded-full"})]})]})]})}function eh({messages:e,onClose:r,onJumpToMessage:s,onGetSenderName:n,onGetContentDisplay:l,onUnpinMessage:o,hasMore:c,onLoadMore:d,loadingMore:m}){return(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md h-[82vh] max-h-[40rem] sm:max-h-[50rem] mx-4 flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between p-5 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50 sticky top-0 z-10",children:[(0,t.jsxs)("h3",{className:"flex items-center gap-2.5 text-lg font-bold text-yellow-800",children:[(0,t.jsx)(x.HiMapPin,{className:"w-6 h-6 text-yellow-600 rotate-45"}),"Tin nhắn đã ghim",(0,t.jsx)("span",{className:"ml-2 px-2.5 py-0.5 bg-yellow-200 text-yellow-800 text-xs font-bold rounded-full",children:e.length})]}),(0,t.jsx)("button",{onClick:r,className:"p-2 cursor-pointer rounded-full hover:bg-white/80 transition-all hover:scale-110",title:"Đóng",children:(0,t.jsx)(x.HiXMark,{className:"w-6 h-6 text-gray-600"})})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar",children:[0===e.length?(0,t.jsxs)("div",{className:"text-center py-16 text-gray-400",children:[(0,t.jsx)(x.HiMapPin,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),(0,t.jsx)("p",{className:"text-base",children:"Chưa có tin nhắn nào được ghim"})]}):e.map(e=>(0,t.jsxs)("div",{onClick:()=>{s(e._id),r()},className:"relative group p-4 bg-gradient-to-r from-yellow-50 to-white rounded-xl border border-yellow-200 hover:border-yellow-400 hover:shadow-md cursor-pointer transition-all duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)("span",{className:"font-semibold text-yellow-800 text-sm",children:n(e.sender)}),(0,t.jsx)("span",{className:`text-[0.6875rem] px-2 py-0.5 rounded-md font-semibold ${"poll"===e.type?"bg-yellow-100 text-yellow-800":"reminder"===e.type?"bg-blue-100 text-blue-800":"image"===e.type?"bg-pink-100 text-pink-800":"video"===e.type?"bg-blue-100 text-blue-800":"file"===e.type?"bg-gray-100 text-gray-800":"sticker"===e.type?"bg-indigo-100 text-indigo-800":"bg-gray-100 text-gray-700"}`,children:e.pinnedTitle||("poll"===e.type?"Bình chọn":"reminder"===e.type?"Lịch hẹn":"image"===e.type?"Ảnh":"video"===e.type?"Video":"file"===e.type?"File":"sticker"===e.type?"Sticker":"Tin nhắn")})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-xs text-gray-500 whitespace-nowrap",children:new Date(e.timestamp).toLocaleDateString("vi-VN",{day:"numeric",month:"short",year:"numeric"})}),(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),o(e)},className:"px-2 py-1 text-[0.74rem] rounded-lg border border-red-300 text-red-700 hover:bg-red-50 cursor-pointer whitespace-nowrap",children:"Bỏ ghim"})]})]}),e.isRecalled?(0,t.jsx)("div",{className:"text-sm text-gray-500 italic",children:"đã thu hồi tin nhắn"}):(0,t.jsx)(t.Fragment,{children:"image"===e.type&&e.fileUrl?(0,t.jsxs)("div",{className:"mt-1",children:[(0,t.jsx)("div",{className:"relative  overflow-hidden border border-gray-200 shadow-sm w-full max-w-[2rem]",children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.fileUrl),alt:"Ảnh",width:320,height:240,className:"w-full h-full object-cover",unoptimized:String(e.fileUrl).includes("mega.nz")})}),e.content&&(0,t.jsx)("div",{className:"mt-2 text-sm text-gray-700 line-clamp-3 leading-relaxed",children:e.content})]}):"video"===e.type&&e.fileUrl?(0,t.jsxs)("div",{className:"mt-1",children:[(0,t.jsxs)("div",{className:"relative rounded-xl overflow-hidden border border-gray-200 shadow-sm w-full max-w-[6rem] bg-black",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(e.fileUrl),className:"w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,t.jsx)("div",{className:"w-6 h-6 rounded-full bg-white/80 flex items-center justify-center",children:(0,t.jsx)("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 text-gray-800",children:(0,t.jsx)("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})})})]}),e.content&&(0,t.jsx)("div",{className:"mt-2 text-sm text-gray-700 line-clamp-3 leading-relaxed",children:e.content})]}):(0,t.jsx)("div",{className:"text-sm text-gray-700 line-clamp-3 leading-relaxed",children:l(e)})}),"text"===e.type&&!e.isRecalled&&(()=>{let r=(e.content||"").match(/(https?:\/\/|www\.)\S+/i);if(!r)return null;let s=r[0],n=s.startsWith("http")?s:`https://${s}`,a=(()=>{try{return new URL(n).hostname.replace("www.","")}catch{return"Website"}})();return(0,t.jsx)("div",{className:"mt-2 rounded-xl shadow-xl bg-white overflow-hidden",children:(0,t.jsxs)("button",{onClick:e=>{e.stopPropagation(),window.open(n,"_blank")},className:"w-full text-left p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50",children:[(0,t.jsx)("div",{className:"p-2.5 rounded-xl bg-gradient-to-br from-sky-500 via-blue-500 to-blue-500 text-white",children:(0,t.jsx)(i.HiLink,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-purple-600 truncate",children:s}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-0.5",children:a})]})]})})})(),(0,t.jsx)("div",{className:"absolute inset-0 rounded-xl ring-2 ring-yellow-400 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"})]},e._id)),c&&(0,t.jsx)("div",{className:"flex justify-center",children:(0,t.jsx)("button",{onClick:d,disabled:m,className:"px-3 py-1.5 text-xs rounded-lg border border-yellow-300 bg-yellow-50 text-yellow-800 hover:bg-yellow-100 cursor-pointer disabled:opacity-60",children:m?"Đang tải...":"Xem thêm"})})]}),(0,t.jsx)("div",{className:"p-3 text-center text-xs text-gray-400 border-t border-gray-100 bg-gray-50",children:"Nhấn vào tin nhắn để nhảy đến vị trí gốc"})]})})}function ex({allPinnedMessages:e,showPinnedList:s,onOpenPinnedList:n,onClosePinnedList:i,onJumpToMessage:o,getSenderName:c,onUnpinMessage:d,onLoadMorePinned:m,pinnedHasMore:u,pinnedLoading:g,isSidebarOpen:p}){let f=0===e.length&&!s,b=e=>/\.(mp4|webm|mov|mkv|avi)$/i.test(String(e||"")),y=e=>/\.(jpg|jpeg|png|gif|webp|bmp|svg|avif)$/i.test(String(e||"")),v=e=>{let r=String(e.fileUrl||e.previewUrl||""),s="video"===e.type||b(e.fileName)||b(r);return"image"===e.type||y(e.fileName)||y(r)?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(r),alt:"Ảnh",width:40,height:40,className:"w-10 h-10 rounded-lg object-cover"}):s?(0,t.jsxs)("div",{className:"relative w-10 h-10 rounded-lg overflow-hidden bg-black",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(r),className:"w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,t.jsx)("div",{className:"w-5 h-5 rounded-full bg-white/80 flex items-center justify-center",children:(0,t.jsx)("svg",{viewBox:"0 0 24 24",className:"w-3.5 h-3.5 text-gray-800",children:(0,t.jsx)("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})})})]}):null},w=e=>{if(e.pinnedTitle&&e.pinnedTitle.trim())return e.pinnedTitle.trim();let t=e.content?.trim();return"image"===e.type?"[Hình ảnh]":"video"===e.type?"[Video]":"file"===e.type?"[Tệp]":"sticker"===e.type?"[Sticker]":"poll"===e.type?"[Bình chọn]":"reminder"===e.type?"[Lịch hẹn]":t||"[Tin nhắn]"},j=e[0],N=j?w(j):"",S=j?c(j.sender):"",k=e.length>1?e.length-1:0,[C,_]=(0,r.useState)(!1),[T,M]=(0,r.useState)(null),[A,E]=(0,r.useState)(""),$=e.filter(e=>{let t=String(e.content||""),r=String(e.pinnedTitle||"");return(0,h.accentAwareIncludes)(t,A)||(0,h.accentAwareIncludes)(r,A)}),[I,L]=(0,r.useState)({top:0,left:0}),P=(0,r.useRef)(null),H=(0,r.useRef)(null);(0,r.useEffect)(()=>{p&&(_(!1),M(null))},[p]);let U=(e,t)=>{e.stopPropagation();let r=e.currentTarget.getBoundingClientRect();L({top:r.bottom+window.scrollY+5,left:r.right+window.scrollX-128}),M(T===t?null:t)};return((0,r.useEffect)(()=>{let e=e=>{let t=e.target;if(C&&P.current&&!P.current.contains(t)){if(T&&H.current&&H.current.contains(t))return;_(!1)}T&&H.current&&!H.current.contains(t)&&M(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[C,T]),f)?null:(0,t.jsxs)(t.Fragment,{children:[e.length>0&&(0,t.jsxs)("div",{className:"relative group flex items-center justify-between gap-2 px-2 py-1 bg-white border border-gray-200 rounded-[0.5rem] shadow-sm hover:shadow-md hover:border-gray-300 select-none m-2 sm:m-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0 cursor-pointer hover:bg-gray-50 rounded-lg p-1 transition-colors",onClick:()=>j&&o(j._id),children:[(0,t.jsx)("div",{className:"flex items-center justify-center w-7 h-7 rounded-full bg-blue-100 text-blue-600 border border-blue-200",children:(0,t.jsx)(x.HiChatBubbleLeftRight,{className:"w-4 h-4"})}),(0,t.jsxs)("div",{className:"flex flex-col min-w-0 items-start",children:[(0,t.jsx)("div",{className:"text-[0.875rem] md:text-[1rem] font-semibold text-gray-900 truncate",children:N}),(0,t.jsx)("div",{className:"text-[0.875rem] md:text-[1rem] text-gray-600 truncate w-[10rem] md:w-[20rem]",children:S?`Tin nhắn của ${S}`:"Tin nhắn đã ghim"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[!p&&j&&v(j),!p&&(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{className:"cursor-pointer p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600",onClick:e=>U(e,"main-pinned"),children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5"})}),"main-pinned"===T&&"undefined"!=typeof document&&(0,l.createPortal)((0,t.jsx)("div",{ref:H,style:{top:I.top,left:I.left},className:"fixed z-[9999] w-32 bg-white rounded-lg shadow-lg border border-gray-100 py-1",children:(0,t.jsxs)("button",{className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50",onClick:e=>{e.stopPropagation(),j&&d(j),M(null)},children:[(0,t.jsx)(x.HiTrash,{className:"w-4 h-4"}),"Bỏ ghim"]})}),document.body)]}),!p&&(0,t.jsx)("div",{className:"h-10 w-px bg-gray-200"}),(0,t.jsxs)("div",{className:"px-3 py-1.5 rounded-full border border-gray-300 bg-gray-50 text-gray-800 flex items-center gap-1.5 cursor-pointer",onClick:e=>{e.stopPropagation(),k>0&&_(e=>!e)},children:[(0,t.jsx)("span",{className:"text-sm font-semibold",children:k>0?`+${k}`:"+0"}),(0,t.jsx)(x.HiChevronDown,{className:"w-4 h-4"})]}),C&&(0,t.jsx)("div",{className:"fixed inset-0 z-40 bg-black/30",onClick:e=>{e.stopPropagation(),_(!1)}}),C&&(0,t.jsxs)("div",{ref:P,className:"absolute left-3 right-3 top-full mt-2 bg-white border border-gray-200 rounded-2xl shadow-xl z-50",children:[(0,t.jsxs)("div",{className:"px-4 py-3 border-b border-gray-200 flex flex-col gap-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"text-sm font-semibold text-gray-900",children:["Danh sách ghim (",e.length,")"]}),(0,t.jsxs)("button",{className:"text-sm font-medium text-blue-700 hover:text-blue-800 flex items-center gap-1 cursor-pointer",onClick:e=>{e.stopPropagation(),_(!1)},children:["Thu gọn",(0,t.jsx)(x.HiChevronUp,{className:"w-4 h-4"})]})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,t.jsx)(x.HiMagnifyingGlass,{className:"h-4 w-4 text-gray-400"})}),(0,t.jsx)("input",{type:"text",className:"block w-full pl-9 pr-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-gray-50 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Tìm kiếm ghim...",value:A,onChange:e=>E(e.target.value),onClick:e=>e.stopPropagation()})]})]}),(0,t.jsxs)("div",{className:"max-h-[20rem] custom-scrollbar overflow-auto divide-y divide-gray-100",children:[0===$.length&&(0,t.jsx)("div",{className:"px-4 py-8 text-center text-sm text-gray-500",children:"Không tìm thấy tin nhắn ghim nào"}),$.map(e=>{let r=w(e);!e.pinnedTitle&&"text"===e.type&&e.content&&(r="[Tin nhắn]");let s=c(e.sender);return(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-3 hover:bg-gray-50 cursor-pointer rounded-2xl",onClick:t=>{t.stopPropagation(),_(!1),o(String(e._id))},children:[(0,t.jsx)("div",{className:"flex items-center justify-center w-7 h-7 rounded-full bg-blue-100 text-blue-600 border border-blue-200 shrink-0",children:(0,t.jsx)(x.HiChatBubbleLeftRight,{className:"w-4 h-4"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("div",{className:"text-sm font-semibold text-gray-900 truncate",children:r}),e.content&&e.content!==r&&(0,t.jsx)("div",{className:"text-sm text-gray-700 truncate",children:e.content}),(0,t.jsx)("div",{className:"text-xs text-gray-500 truncate",children:s?`Tin nhắn của ${s}`:"Tin nhắn"})]}),v(e),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("button",{className:"cursor-pointer p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600",onClick:t=>U(t,String(e._id)),children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-5 h-5"})}),T===String(e._id)&&"undefined"!=typeof document&&(0,l.createPortal)((0,t.jsx)("div",{ref:H,style:{top:I.top,left:I.left},className:"fixed z-[9999] w-32 bg-white rounded-lg shadow-lg border border-gray-100 py-1",children:(0,t.jsxs)("button",{className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50",onClick:t=>{t.stopPropagation(),d(e),M(null)},children:[(0,t.jsx)(x.HiTrash,{className:"w-4 h-4"}),"Bỏ ghim"]})}),document.body)]})]},String(e._id))})]})]})]})]}),s&&(0,t.jsx)(eh,{messages:e,onClose:i,onJumpToMessage:o,onGetSenderName:c,hasMore:u,onLoadMore:m,loadingMore:g,onGetContentDisplay:e=>"poll"===e.type?`B\xecnh chọn: ${e.pollQuestion||e.content||""}`:"reminder"===e.type?`Lịch hẹn: ${e.content||""}`:"image"===e.type?"Ảnh":"video"===e.type?"Video":"file"===e.type?(0,t.jsxs)("a",{href:(0,h.getProxyUrl)(e.fileUrl,!0),download:e.fileName||"download",target:"_blank",rel:"noreferrer",className:"flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-2xl max-w-[70vw] sm:max-w-[18rem] shadow-sm hover:bg-gray-50",children:[(0,t.jsx)("div",{className:"p-2 bg-blue-600 rounded-xl",children:(0,t.jsx)(x.HiOutlineDocumentText,{className:"w-6 h-6 text-white"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate",children:e.fileName||"Tệp đính kèm"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:"Nhấn để tải xuống"})]})]}):"sticker"===e.type?"Sticker":e.content?.trim()||"[Tin nhắn]",onUnpinMessage:d})]})}function eg({unicode:e,size:r=32}){return(0,t.jsx)(a.default,{src:`https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/${e}.png`,alt:"emoji",width:r,height:r,unoptimized:!0})}let ep=["1f600","1f601","1f602","1f603","1f604","1f606","1f607","1f609","1f60a","1f60b","1f60d","1f60e","1f60f","1f612","1f613","1f614","1f616","1f618","1f61a","1f61c","1f61d","1f61e","1f620","1f621","1f622","1f623","1f624","1f625","1f626","1f627","1f628","1f629","1f62a","1f62b","1f62d","1f630","1f631","1f632","1f633","1f634","1f635","1f636","1f637","1f641","1f642","1f643","1f644","1f910","1f911","1f912","1f914","1f917","1f920","1f921","1f922","1f923","1f924","1f925","1f927","1f928","1f929","1f92a","1f92b","1f92c","1f92d","1f92e","1f92f","1f970","1f973","1f974","1f975","1f976","1f978","1f979","1f97a","1f9d0","2764","1f49b","1f49a","1f499","1f49c","1f90e","1f5a4","1f44d","1f44f","1f64f","1f44e","1f448","1f449","1f64c","270a","270c","1f64b","1f91d","1f44a","1f680"];function ef({showEmojiPicker:e,pickerTab:s,setPickerTab:n,onEmojiClick:i,stickers:l,onSelectSticker:o}){let c=(0,r.useRef)(null),[d,m]=(0,r.useState)(300);return((0,r.useEffect)(()=>{if(!c.current)return;let e=new ResizeObserver(e=>{let t=e[0].contentRect.height;t>50&&m(t-10)});return e.observe(c.current),()=>e.disconnect()},[]),e)?(0,t.jsxs)("div",{className:"absolute bottom-full left-0 right-0 sm:right-auto mb-2 bg-white shadow-xl border border-gray-200 rounded-xl z-50 w-full sm:w-80 lg:w-[28rem] xl:w-[32rem] max-w-[90vw] flex flex-col overflow-hidden",children:[(0,t.jsx)("div",{className:"flex border-b",children:(0,t.jsx)("button",{className:`flex-1 p-2 sm:p-3 cursor-pointer text-xs sm:text-sm font-medium ${"emoji"===s?"bg-gray-100 text-blue-600":"hover:bg-gray-50"}`,onClick:()=>n("emoji"),children:"Emoji"})}),(0,t.jsx)("div",{ref:c,className:"flex-1 overflow-y-auto custom-scrollbar min-h-[18rem] max-h-[70vh] p-2",children:"emoji"===s?(0,t.jsx)("div",{style:{height:d},className:"grid grid-cols-8 sm:grid-cols-10 md:grid-cols-12 gap-2",children:ep.map(e=>(0,t.jsx)("div",{onClick:()=>i(e),className:"cursor-pointer flex items-center justify-center rounded hover:bg-gray-100",children:(0,t.jsx)(eg,{unicode:e,size:36})},e))}):(0,t.jsx)("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2",children:l.map((e,r)=>(0,t.jsx)(a.default,{width:40,height:40,src:e,className:"w-full h-16 object-contain cursor-pointer hover:bg-gray-100 rounded p-1",onClick:()=>o(e),alt:"sticker"},r))})})]}):null}function eb({replyingTo:e,getSenderName:r,onCancel:s}){if(!e)return null;let n=String(e.fileUrl||e.previewUrl||""),i="video"===e.type||(0,h.isVideoFile)(e.fileName)||(0,h.isVideoFile)(n),l="image"===e.type||/\.(jpg|jpeg|png|gif|webp|bmp|svg|avif)$/i.test(String(e.fileName||n||"")),o=e.isRecalled?"đã thu hồi tin nhắn":"file"===e.type?e.fileName||"[File]":"image"===e.type?"[Ảnh]":"video"===e.type?"[Video]":"sticker"===e.type?"[Sticker]":"reminder"===e.type?e.content||"[Nhắc nhở]":e.content||"Tin nhắn";return(0,t.jsxs)("div",{className:" bottom-full left-0 right-0 p-3 bg-gray-200 rounded-t-xl flex justify-between items-center text-sm text-gray-700",children:[(0,t.jsxs)("div",{className:"border-l-2 border-blue-400 pl-2 max-w-[15rem] sm:max-w-[80rem] overflow-hidden ",children:[(0,t.jsxs)("div",{className:"text-sm  text-black ",children:["Trả lời ",r(e.sender)]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[!e.isRecalled&&(l||i)&&(l?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(n),alt:"Ảnh",width:40,height:40,className:"w-10 h-10 rounded-md object-cover border border-blue-200"}):(0,t.jsxs)("div",{className:"relative w-10 h-10 bg-black rounded-md overflow-hidden border border-blue-200",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(n),className:"w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,t.jsx)("div",{className:"w-5 h-5 rounded-full bg-white/80 flex items-center justify-center",children:(0,t.jsx)("svg",{viewBox:"0 0 24 24",className:"w-3.5 h-3.5 text-gray-800",children:(0,t.jsx)("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})})})]})),(0,t.jsx)("p",{className:"text-xs text-gray-700 w-full",children:o})]})]}),(0,t.jsx)("button",{onClick:s,className:"cursor-pointer text-gray-500 hover:text-gray-700 p-1",children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})}function ey({showMentionMenu:e,mentionSuggestions:s,selectedMentionIndex:n,mentionMenuRef:i,onSelectMention:l}){let o=(0,r.useRef)([]);return((0,r.useEffect)(()=>{n>=0&&o.current[n]&&o.current[n]?.scrollIntoView({block:"nearest"})},[n]),e&&0!==s.length)?(0,t.jsxs)("div",{ref:i,onMouseDown:e=>e.preventDefault(),className:"absolute bottom-full left-0 right-0 mb-2 bg-white rounded-lg shadow-2xl border border-gray-200 max-h-60 overflow-hidden z-50",children:[(0,t.jsx)("div",{className:"p-2 border-b bg-gray-50",children:(0,t.jsx)("p",{className:"text-xs text-gray-600 font-medium",children:"Chọn người để đề cập"})}),(0,t.jsx)("div",{className:"max-h-48 overflow-y-auto custom-scrollbar",children:s.map((e,r)=>{let s=e.id??e._id,i=e.name||"User",c=e.avatar;return(0,t.jsxs)("div",{role:"button",ref:e=>{o.current[r]=e},onClick:()=>l(e),className:`w-full flex cursor-pointer items-center gap-3 p-3 hover:bg-blue-50 transition-colors ${r===n?"bg-blue-100":""}`,children:[c?(0,t.jsx)(a.default,{width:40,height:40,src:(0,h.getProxyUrl)(c),alt:i,className:"w-5 h-5 sm:w-10 sm:h-10 rounded-full object-cover"}):(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 text-white flex items-center justify-center font-semibold",children:i.charAt(0).toUpperCase()}),(0,t.jsxs)("div",{className:"text-left flex-1",children:[(0,t.jsx)("p",{className:"font-medium text-gray-800 text-sm",children:i}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["@",i.toLowerCase().replace(/\s+/g,"")]})]}),r===n&&(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5 text-blue-500",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z",clipRule:"evenodd"})})]},s)})})]}):null}let ev=({dotColor:e="#000000",className:r,...s})=>(0,t.jsxs)("svg",{viewBox:"0 0 500 500",xmlns:"http://www.w3.org/2000/svg",className:r,...s,children:[(0,t.jsx)("rect",{width:"500",height:"500",fill:"none"}),(0,t.jsx)("circle",{cx:"180.21",cy:"250",r:"14.38",fill:e}),(0,t.jsx)("circle",{cx:"250",cy:"250",r:"14.38",fill:e}),(0,t.jsx)("circle",{cx:"319.79",cy:"250",r:"14.38",fill:e})]}),ew=({iconColor:e="#000000",className:r,...s})=>(0,t.jsxs)("svg",{viewBox:"0 0 500 500",xmlns:"http://www.w3.org/2000/svg",className:r,...s,children:[(0,t.jsx)("rect",{width:"500",height:"500",fill:"none"}),(0,t.jsx)("path",{fill:e,d:"m312.44,345.37h-124.89c-18.15,0-32.92-14.77-32.92-32.92v-124.89c0-18.15,14.77-32.92,32.92-32.92h124.89c18.15,0,32.92,14.77,32.92,32.92v124.89c0,18.15-14.77,32.92-32.92,32.92Zm-124.89-180.12c-12.3,0-22.31,10.01-22.31,22.31v124.89c0,12.3,10.01,22.31,22.31,22.31h124.89c12.3,0,22.31-10.01,22.31-22.31v-124.89c0-12.3-10.01-22.31-22.31-22.31h-124.89Z"}),(0,t.jsx)("circle",{cx:"215.17",cy:"214.99",r:"14.28",fill:e}),(0,t.jsx)("path",{fill:e,d:"m161.71,307.88l-7-8.1,34.06-29.43c6.33-5.46,15.57-5.55,21.98-.2l14.15,11.84c2.71,2.26,6.6,2.27,9.26.02l42.53-35.22c6.23-5.15,15.17-5.05,21.25.21l45.59,38.98-6.95,8.14-45.62-39c-2.15-1.86-5.26-1.88-7.44-.08l-42.49,35.18c-6.61,5.58-16.29,5.58-22.98-.01l-14.15-11.84c-2.33-1.94-5.83-1.91-8.13.08l-34.05,29.43Z"})]}),ej=({strokeWidth:e=10,className:r,...s})=>(0,t.jsxs)("svg",{viewBox:"0 0 500 500",xmlns:"http://www.w3.org/2000/svg",className:r,stroke:"black",fill:"none",...s,children:[(0,t.jsx)("path",{d:"m251.81,298.44c-23.98,0-43.48-19.51-43.48-43.48v-66.07c0-23.98,19.51-43.49,43.48-43.49s43.48,19.51,43.48,43.49v66.07c0,23.98-19.51,43.48-43.48,43.48Z",strokeWidth:e}),(0,t.jsx)("path",{d:"m250.16,323.9c-18.31,0-36.25-7.74-49.47-21.41-13.97-14.43-21.3-34.12-20.1-54.01",strokeWidth:e,strokeLinecap:"round"}),(0,t.jsx)("path",{d:"m250.16,323.9c18.24-.49,36.01-8.76,48.77-22.7,13.27-14.49,19.93-33.21,18.73-52.7",strokeWidth:e,strokeLinecap:"round"}),(0,t.jsx)("path",{d:"m277.58,354.6h-51.54",strokeWidth:e,strokeLinecap:"round"}),(0,t.jsx)("path",{d:"m251.81,320.37v27.21",strokeWidth:e,strokeLinecap:"round"})]});function eN({socket:e,onToggleEmojiPicker:s,isListening:n,onVoiceInput:l,editableRef:o,onInputEditable:c,onKeyDownEditable:d,onPasteEditable:m,onFocusEditable:u,onSendMessage:h,onSelectImage:g,onSelectFile:f,onAttachFromFolder:b,attachments:y,onRemoveAttachment:v,onClearAttachments:w,isUploading:j=!1,uploadingCount:N=0,overallUploadPercent:S=0}){let{currentUser:k,selectedChat:C,isGroup:_}=O(),M=(0,p.useToast)(),A=(0,r.useMemo)(()=>{if(!_||!C.members||!Array.isArray(C.members))return"MEMBER";let e=String(k._id||k?.id||""),t=C.members.find(t=>String("string"==typeof t?t:t._id||t.id)===e);return t&&"string"!=typeof t&&t.role||"MEMBER"},[_,C,k]),E=!_||_&&"OWNER"===A,$=e=>e&&(null!=e._id||null!=e.id)?String(e._id??e.id):String(e??""),I=_?$(C):[$(k),$(C)].sort().join("_"),[L,P]=(0,r.useState)(!1),[H,U]=(0,r.useState)(!1),[R,D]=(0,r.useState)(!1),z=(0,r.useRef)(null),V=(0,r.useRef)({active:!1,startX:0,startScroll:0}),G=e=>{let t=z.current;if(V.current.active=!1,t&&"number"==typeof V.current.pid)try{t.releasePointerCapture(V.current.pid)}catch{}},X=async({question:t,options:r,pollAllowMultiple:s,pollAllowAddOptions:n,pollHideVoters:i,pollHideResultsUntilVote:a,pollEndAt:l})=>{let o=t.trim();if(o)try{let t=await (0,B.createMessageApi)({roomId:I,sender:String(k._id),type:"poll",content:o,timestamp:Date.now(),pollQuestion:o,pollOptions:r,pollVotes:{},isPollLocked:!1,pollAllowMultiple:s,pollAllowAddOptions:n,pollHideVoters:i,pollHideResultsUntilVote:a,pollEndAt:l??null});if(t?.success){let c=_?null:String(C._id),d=_&&C.members||[],m={roomId:I,sender:String(k._id),senderName:k.name,isGroup:_,receiver:c,members:d};if("string"==typeof t._id){e?.emit("send_message",{...m,_id:t._id,type:"poll",content:o,timestamp:Date.now(),pollQuestion:o,pollOptions:r,pollVotes:{},isPollLocked:!1,pollAllowMultiple:s,pollAllowAddOptions:n,pollHideVoters:i,pollHideResultsUntilVote:a,pollEndAt:l??null});let c=await (0,B.createMessageApi)({roomId:I,sender:String(k._id),type:"notify",content:`${k.name} tạo cuộc b\xecnh chọn mới: "${o}"`,timestamp:Date.now(),replyToMessageId:t._id});c?.success&&e?.emit("send_message",{...m,_id:c._id,type:"notify",content:`${k.name} tạo cuộc b\xecnh chọn mới: "${o}"`,timestamp:Date.now(),replyToMessageId:t._id})}P(!1)}}catch(e){console.error("Failed to create poll:",e)}},J=async({content:t,dateTime:r,note:s,repeat:n})=>{D(!0);let i=Date.parse(r);if(!t.trim()||Number.isNaN(i)){alert("Vui lòng nhập đầy đủ thông tin hợp lệ"),D(!1);return}try{let r=await (0,B.createMessageApi)({roomId:I,sender:String(k._id),type:"reminder",content:t.trim(),timestamp:Date.now(),reminderAt:i,reminderNote:s?.trim()||"",reminderFired:!1,reminderRepeat:n||"none"});if(r?.success){let a=_?null:String(C._id),l=_&&C.members||[],o={roomId:I,sender:String(k._id),senderName:k.name,isGroup:_,receiver:a,members:l};if("string"==typeof r._id){e?.emit("send_message",{...o,_id:r._id,type:"reminder",content:t.trim(),timestamp:Date.now(),reminderAt:i,reminderNote:s?.trim()||"",reminderFired:!1,reminderRepeat:n||"none"});let a=await (0,B.createMessageApi)({roomId:I,sender:String(k._id),type:"notify",content:`${k.name} tạo lịch hẹn mới: "${t.trim()}"`,timestamp:Date.now(),replyToMessageId:r._id});a?.success&&e?.emit("send_message",{...o,_id:a._id,type:"notify",content:`${k.name} tạo lịch hẹn mới: "${t.trim()}"`,timestamp:Date.now(),replyToMessageId:r._id})}U(!1)}}catch(e){console.error("Failed to create reminder:",e)}finally{D(!1)}},[K,q]=(0,r.useState)(!1),[Y,Z]=(0,r.useState)([]),[ee,et]=(0,r.useState)(null),[er,en]=(0,r.useState)([]),[ei,ea]=(0,r.useState)(!1),[el,eo]=(0,r.useState)(""),[ec,ed]=(0,r.useState)(0),[em,eu]=(0,r.useState)(!1),[eh,ex]=(0,r.useState)(null),[eg,ep]=(0,r.useState)(!1),ef=(0,r.useRef)(null),eb=(0,r.useRef)(null),ey=(0,r.useRef)(null),eN=(0,r.useRef)(!1),eS=(0,r.useRef)(!0),[ek,eC]=(0,r.useState)(!1),[e_,eT]=(0,r.useState)(!1),[eM,eA]=(0,r.useState)(!1),[eE,e$]=(0,r.useState)(!1),eI={"bg-red-500":"#ef4444","bg-pink-500":"#ec4899","bg-orange-400":"#fb923c","bg-yellow-400":"#facc15","bg-green-500":"#22c55e","bg-teal-500":"#14b8a6","bg-blue-500":"#3b82f6","bg-purple-500":"#a855f7"},[eL,eP]=(0,r.useState)([]),[eH,eU]=(0,r.useState)([]),eR=(0,r.useMemo)(()=>C?._id&&k?._id?`chatTags:${k._id}:${C._id}`:"",[C?._id,k?._id]);(0,r.useEffect)(()=>{(async()=>{if(k?._id){k.userTags&&Array.isArray(k.userTags)&&eP(k.userTags);try{let e=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:String(k._id)})}),t=await e.json(),r=t&&t.row||(Array.isArray(t?.data)?t.data[0]:null);r&&Array.isArray(r.userTags)&&eP(r.userTags)}catch{}}})();let e=e=>{e.detail&&String(e.detail.userId)===String(k?._id)&&eP(e.detail.tags||[])};return window.addEventListener("userTagsUpdated",e),()=>window.removeEventListener("userTagsUpdated",e)},[k?._id]),(0,r.useEffect)(()=>{if(!eR)return;let e=C.tags||C.tagsBy?.[String(k._id)]||[];if(Array.isArray(e)&&e.length>0)eU(e.filter(e=>"string"==typeof e));else try{let e=localStorage.getItem(eR);if(e){let t=JSON.parse(e);Array.isArray(t)&&eU(t)}else eU([])}catch{eU([])}},[eR,C]),(0,r.useEffect)(()=>{let e=e=>{try{let t=e.detail||{};if(String(t.userId)!==String(k._id)||String(t.roomId)!==String(C?._id))return;let r=Array.isArray(t.tags)?t.tags.filter(e=>"string"==typeof e):[];eU(r)}catch{}};return window.addEventListener("chatTagsUpdated",e),()=>window.removeEventListener("chatTagsUpdated",e)},[k._id,C?._id]);let eD=async e=>{if(!eR)return;let t=eH.includes(e)?eH.filter(t=>t!==e):[...eH,e];eU(t);try{localStorage.setItem(eR,JSON.stringify(t))}catch{}window.dispatchEvent(new CustomEvent("chatTagsUpdated",{detail:{userId:k._id,roomId:C?._id,tags:t}}));try{let e=_?"/api/groups":"/api/users",r=_?{action:"updateTags",_id:String(k._id),conversationId:String(C?._id),data:{tags:t}}:{action:"updateTags",currentUserId:String(k._id),roomId:String(C?._id),data:{tags:t}};await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(e){console.error("Failed to update tags",e)}},eO=()=>{eT(!0),window.setTimeout(()=>eT(!1),1500)},eB=()=>{o.current?eC((o.current.innerText||"").trim().length>0):eC(!1)};(0,r.useEffect)(()=>{eB()},[]);let eF=()=>{h(),eC(!1),setTimeout(eB,100)};(0,r.useEffect)(()=>{if(!eg)return;let e=e=>{let t=e.target;if(!(ef.current&&t&&ef.current.contains(t))&&!(eb.current&&t&&eb.current.contains(t))){ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}}};return document.addEventListener("mousedown",e,!0),document.addEventListener("touchstart",e,!0),()=>{document.removeEventListener("mousedown",e,!0),document.removeEventListener("touchstart",e,!0)}},[eg]),(0,r.useEffect)(()=>{if(!eg&&eN.current){eN.current=!1;let e=o.current;if(e)try{requestAnimationFrame(()=>{try{e.focus();let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(t)}catch{}setTimeout(()=>{try{e.focus()}catch{}},120)})}catch{}}},[eg]),(0,r.useEffect)(()=>{let e=()=>{if(document.hidden){eS.current=!1;try{o.current?.blur?.()}catch{}}};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[]);let ez=()=>{let e=o.current?String(o.current.innerText||""):"",t=e.match(/\/\s*([\w-]*)$/);eo(t?t[1]:""),ea(/\//.test(e))};return(0,r.useEffect)(()=>{let e=e=>{if(document.activeElement!==o.current)return;let t=e.target;if(!(ey.current&&ey.current.contains(t)))try{o.current?.blur()}catch{}};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}},[]),(0,t.jsxs)("div",{ref:ey,className:"jsx-820bcd66933fca31 relative w-full p-2 bg-gradient-to-t from-white via-white to-gray-50/50 md:bg-white md:border md:border-gray-200 md:rounded-xl md:px-1 md:py-2 md:pt-0",children:[y&&y.length>0?(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 mb-2",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 flex items-center justify-between mb-1",children:[(0,t.jsxs)("span",{className:"jsx-820bcd66933fca31 text-xs text-gray-600",children:[y.length," ",(y.length,"đính kèm")]}),(0,t.jsx)("button",{onClick:w,className:"jsx-820bcd66933fca31 text-xs text-red-600 hover:underline cursor-pointer",children:"Xóa tất cả"})]}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 flex gap-2 overflow-x-auto no-scrollbar py-1",children:y.map((e,r)=>(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-20 h-20 rounded-xl overflow-hidden border border-gray-200 bg-white",children:["image"===e.type?(0,t.jsx)(a.default,{src:e.previewUrl,alt:"",fill:!0,sizes:"80px",className:"object-cover",unoptimized:!0,priority:!0}):"video"===e.type?(0,t.jsx)("video",{src:e.previewUrl,muted:!0,playsInline:!0,className:"jsx-820bcd66933fca31 w-full h-full object-cover"}):(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31  rounded-xl bg-gray-50 hover:bg-gray-100 transition-all duration-200 group cursor-pointer border border-gray-200 hover:border-blue-300",children:[(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 p-3 rounded-xl bg-gradient-to-br from-blue-500 text-white shadow-lg",children:(0,t.jsx)(i.HiDocumentText,{className:"w-3 h-3"})}),(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"jsx-820bcd66933fca31 text-sm font-semibold text-gray-800 truncate group-hover:text-blue-600 transition-colors",children:e.fileName||"Tệp"}),(0,t.jsxs)("p",{className:"jsx-820bcd66933fca31 text-xs text-gray-500 mt-1 font-medium uppercase tracking-wider",children:[".",e.fileName?.split(".").pop()]})]})]}),(0,t.jsx)("button",{onClick:()=>v(r),"aria-label":"Xóa",className:"jsx-820bcd66933fca31 absolute top-1 right-1 p-1 rounded-full bg-black/50 text-white hover:bg-black/70 cursor-pointer",children:(0,t.jsx)(i.HiX,{className:"w-3 h-3"})}),(0,t.jsx)("button",{onClick:()=>e$(!0),"aria-label":"Báo xấu",className:"jsx-820bcd66933fca31 group p-2 rounded-full cursor-pointer hover:bg-gray-100 transition-all duration-300 active:scale-90",children:(0,t.jsx)(x.HiShieldCheck,{className:"w-7 h-7 text-gray-500 group-hover:text-red-600 transition-colors"})}),E&&(0,t.jsx)("button",{onClick:()=>eA(!0),"aria-label":"Xóa lịch sử",className:`jsx-820bcd66933fca31 p-2 rounded-full cursor-pointer text-gray-700  ${j?"opacity-50 pointer-events-none grayscale":""}`,children:(0,t.jsx)(x.HiTrash,{className:"w-7 h-7 text-gray-500"})})]},r))})]}):null,(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 hidden md:flex items-center mt-1 gap-2 mb-0  rounded-xl bg-white ",children:[(0,t.jsx)("button",{onClick:()=>{try{o.current?.blur?.()}catch{}setTimeout(()=>s(),100)},"aria-label":"Chọn emoji",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiFaceSmile,{className:"w-6 h-6"})}),(0,t.jsxs)("label",{"aria-label":"Gửi ảnh hoặc video",className:"jsx-820bcd66933fca31  rounded-lg cursor-pointer p-1 hover:bg-gray-100 transition-all duration-200 text-gray-700",children:[(0,t.jsx)(T.CiImageOn,{className:"w-6 h-6"}),(0,t.jsx)("input",{type:"file",accept:"image/*,video/*",onChange:e=>{(e.target.files?Array.from(e.target.files):[]).forEach(e=>g(e)),e.target.value=""},multiple:!0,className:"jsx-820bcd66933fca31 sr-only"})]}),(0,t.jsxs)("label",{"aria-label":"Gửi file",className:"jsx-820bcd66933fca31  rounded-lg cursor-pointer p-1 hover:bg-gray-100 transition-all duration-200 text-gray-700",children:[(0,t.jsx)(T.CiFileOn,{className:"w-6 h-6"}),(0,t.jsx)("input",{type:"file",multiple:!0,onChange:e=>{(e.target.files?Array.from(e.target.files):[]).forEach(e=>f(e)),e.target.value=""},className:"jsx-820bcd66933fca31 sr-only"})]}),(0,t.jsx)("button",{onClick:eO,"aria-label":"Nhập bằng giọng nói",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiCreditCard2,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:eO,"aria-label":"Chọn Zalo",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiInstagram,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:eO,"aria-label":"Chỉnh sửa Zalo",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiEdit,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:eO,"aria-label":"Gửi Zalo",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiPen,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:eO,"aria-label":"Chọn Zalo",className:`jsx-820bcd66933fca31 rounded-lg p-1 cursor-pointer transition-all duration-200 ${n?"text-red-500 bg-red-50":"text-gray-700 hover:bg-gray-100"}`,children:(0,t.jsx)(T.CiCircleMore,{className:"w-6 h-6"})})]}),eL.length>0&&(0,t.jsx)("div",{ref:z,onPointerDown:e=>{let t=z.current;t&&(V.current.active=!0,V.current.startX=e.clientX,V.current.startScroll=t.scrollLeft,V.current.pid=e.pointerId,t.setPointerCapture(e.pointerId))},onPointerMove:e=>{if(!V.current.active)return;let t=z.current;if(!t)return;let r=e.clientX-V.current.startX;t.scrollLeft=V.current.startScroll-r,e.preventDefault()},onPointerUp:G,onPointerCancel:G,className:"jsx-820bcd66933fca31 flex items-center gap-2 overflow-x-auto custom-scrollbar w-full p-1 whitespace-nowrap overscroll-x-contain x-scroll-touch select-none cursor-grab active:cursor-grabbing",children:eL.map(e=>{let r=eH.includes(e.id),s=eI[e.color]||"#9ca3af";return(0,t.jsx)("div",{onClick:()=>eD(e.id),style:{backgroundColor:r?s:"white",borderColor:s,color:r?"#ffffff":s},className:`jsx-820bcd66933fca31 
                  cursor-pointer flex-none px-2.5 py-1 rounded-[0.25rem] text-xs font-semibold border transition-all duration-200 shadow-sm active:scale-95
                  ${r?"shadow-md":"hover:shadow"}
                `,children:e.label},e.id)})}),(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 flex items-end gap-2",children:[(0,t.jsx)("button",{onClick:()=>{try{o.current?.blur?.()}catch{}setTimeout(()=>s(),100)},"aria-label":"Chọn emoji",className:"jsx-820bcd66933fca31 md:hidden group p-2 rounded-full cursor-pointer hover:bg-gray-100 transition-all duration-300 active:scale-90",children:(0,t.jsx)(x.HiFaceSmile,{className:"w-7 h-7 text-gray-500 group-hover:text-yellow-500 transition-colors"})}),(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative flex-1 min-w-0",children:[(0,t.jsx)("div",{ref:o,contentEditable:!0,inputMode:"text",role:"textbox","aria-multiline":"true",onClick:()=>{ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},onInput:()=>{c(),ez(),eB()},onKeyDown:e=>{let t=o.current?String(o.current.innerText||""):"",r=er.filter(e=>e.key.toLowerCase().startsWith((el||"").toLowerCase()));if(ei&&r.length>0){if("ArrowDown"===e.key){e.preventDefault(),ed(e=>(e+1)%r.length);return}if("ArrowUp"===e.key){e.preventDefault(),ed(e=>(e-1+r.length)%r.length);return}if("Enter"===e.key){e.preventDefault();let s=r[Math.max(0,Math.min(ec,r.length-1))];if(s&&o.current){let e=t.replace(/\/\s*[\w-]*$/,s.value);o.current.innerText=e;try{let e=document.createRange();e.selectNodeContents(o.current),e.collapse(!1);let t=window.getSelection();t?.removeAllRanges(),t?.addRange(e)}catch{}ea(!1),ed(0),c();return}}if("Escape"===e.key){e.preventDefault(),ea(!1),ed(0);return}}if(d(e),ez(),"Enter"===e.key&&!e.shiftKey){if(y&&y.length>0)return;try{let e=o.current;if(e){e.focus();let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(t)}}catch{}}},onFocus:()=>{u(),ez(),ep(!1)},onPaste:e=>{m(e),ez()},style:{overscrollBehavior:"contain"},"data-placeholder":"Nhập tin nhắn...",className:"jsx-820bcd66933fca31 min-h-10 max-h-40 px-2 py-2 bg-white/90   focus:outline-none  transition-all duration-300 text-[0.875rem] md:text-[1rem] text-gray-800 overflow-auto custom-scrollbar w-full max-w-full break-words whitespace-pre-wrap"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 pointer-events-none absolute inset-0 flex items-center px-2 py-4 text-gray-400 select-none text-[0.875rem] md:text-[1rem]",children:(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 flex items-center gap-2",children:"Nhập tin nhắn..."})})]}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 flex items-center gap-1",children:ek||y&&y.length>0?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onMouseDown:e=>e.preventDefault(),onTouchStart:e=>e.preventDefault(),onClick:()=>{if(eF(),(!y||!(y.length>0))&&!document.hidden&&eS.current){eS.current=!0;try{requestAnimationFrame(()=>{let e=o.current;if(e){e.focus();let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(t)}})}catch{}}},"aria-label":"Gửi tin nhắn",className:"jsx-820bcd66933fca31 lg:hidden p-2 rounded-full cursor-pointer text-blue-600 hover:bg-blue-50 transition-all duration-300 active:scale-90 group",children:(0,t.jsx)(x.HiPaperAirplane,{className:"w-7 h-7 -rotate-12 group-hover:rotate-0 transition-transform duration-300"})}),(0,t.jsx)("button",{onMouseDown:e=>e.preventDefault(),onTouchStart:e=>e.preventDefault(),onClick:()=>{if(eF(),(!y||!(y.length>0))&&!document.hidden&&eS.current){eS.current=!0;try{requestAnimationFrame(()=>{let e=o.current;if(e){e.focus();let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(t)}})}catch{}}},"aria-label":"Gửi tin nhắn",className:"jsx-820bcd66933fca31 hidden lg:block p-2 rounded-full cursor-pointer text-blue-600 hover:bg-blue-50 transition-all duration-300 active:scale-90 group",children:(0,t.jsx)(x.HiPaperAirplane,{className:"w-7 h-7 -rotate-12 group-hover:rotate-0 transition-transform duration-300"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 hidden md:flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>{try{o.current?.blur?.()}catch{}setTimeout(()=>s(),100)},"aria-label":"Chọn emoji",className:"jsx-820bcd66933fca31 group p-2 rounded-full cursor-pointer hover:bg-gray-100 transition-all duration-300 active:scale-90",children:(0,t.jsx)(T.CiFaceSmile,{className:"w-7 h-7 text-gray-500 group-hover:text-yellow-500 transition-colors"})}),(0,t.jsx)("button",{onClick:()=>{let e=o.current;e&&(e.innerText="👍",c(),eF())},"aria-label":"Gửi like",className:`jsx-820bcd66933fca31 p-2 rounded-full cursor-pointer text-gray-700  ${j?"opacity-50 pointer-events-none grayscale":""}`,children:(0,t.jsx)(a.default,{src:"/imgs/like.png",width:24,height:24,alt:"Like Zalo",className:"w-7 h-7"})})]}),(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 md:hidden flex items-center gap-2",children:[(0,t.jsx)("button",{ref:eb,onClick:()=>{if(eg){ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}return}let e=o.current,t=document.activeElement===e,r=window.visualViewport;if(t||r&&r.height<.75*window.innerHeight){try{t&&e?.blur()}catch{}if(r&&"function"==typeof r.addEventListener){let e=r.height,t=!1,s=()=>{if(!t){t=!0,ep(!0);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!0}}))}catch{}}},n=()=>{if(r.height-e>40){try{r.removeEventListener("resize",n)}catch{}window.clearTimeout(i),s()}};r.addEventListener("resize",n);let i=window.setTimeout(()=>{try{r.removeEventListener("resize",n)}catch{}s()},500);return}setTimeout(()=>{ep(!0);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!0}}))}catch{}},150);return}ep(!0);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!0}}))}catch{}},"aria-label":"Mở thêm hành động",className:"jsx-820bcd66933fca31 block rounded-full cursor-pointer text-gray-500 hover:bg-gray-100 transition-all duration-300 active:scale-90",children:(0,t.jsx)(ev,{className:"w-11 h-11"})}),(0,t.jsx)("button",{onClick:l,"aria-label":"Nhập bằng giọng nói",className:`jsx-820bcd66933fca31  rounded-full cursor-pointer transition-all duration-300 active:scale-90 ${n?"text-red-500 animate-pulse bg-red-50":"text-gray-500 hover:bg-gray-100"}`,children:(0,t.jsx)(ej,{className:"w-11 h-11 text-black"})}),(0,t.jsxs)("label",{"aria-label":"Gửi ảnh hoặc video",className:"jsx-820bcd66933fca31  rounded-full cursor-pointer text-gray-500 hover:bg-gray-100 transition-all duration-300 active:scale-90",children:[(0,t.jsx)(ew,{className:"w-11 h-11"}),(0,t.jsx)("input",{type:"file",accept:"image/*,video/*",onChange:e=>{(e.target.files?Array.from(e.target.files):[]).forEach(e=>g(e)),e.target.value=""},multiple:!0,className:"jsx-820bcd66933fca31 sr-only"})]})]})]})})]}),eg&&(0,t.jsxs)("div",{ref:ef,className:"jsx-820bcd66933fca31 lg:hidden w-full grid grid-cols-4 gap-2 items-center justify-between mx-auto mt-4",children:[(0,t.jsxs)("label",{"aria-label":"Gửi ảnh hoặc video",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-blue-100 to-cyan-100 hover:from-blue-200 hover:to-cyan-200  shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiPhoto,{className:"w-6 h-6 text-blue-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Ảnh/Video"}),(0,t.jsx)("input",{type:"file",accept:"image/*,video/*",onChange:e=>{(e.target.files?Array.from(e.target.files):[]).forEach(e=>g(e)),e.target.value="",ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},multiple:!0,className:"jsx-820bcd66933fca31 sr-only"})]}),(0,t.jsxs)("label",{"aria-label":"Gửi file",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiPaperClip,{className:"w-6 h-6 text-green-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200 rotate-12"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"File"}),(0,t.jsx)("input",{type:"file",multiple:!0,onChange:e=>{(e.target.files?Array.from(e.target.files):[]).forEach(e=>f(e)),e.target.value="",ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},className:"jsx-820bcd66933fca31 sr-only"})]}),_&&(0,t.jsxs)("button",{onClick:()=>{P(!0),ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},"aria-label":"Bình chọn",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-indigo-100 to-blue-100 hover:from-indigo-200 hover:to-blue-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiChartBar,{className:"w-6 h-6 text-blue-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Bình chọn"})]}),(0,t.jsxs)("button",{onClick:()=>{U(!0),ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},"aria-label":"Nhắc hẹn",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-indigo-100 to-red-600 hover:from-indigo-200 hover:to-blue-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiClock,{className:"w-6 h-6 text-white drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Nhắc hẹn"})]}),(0,t.jsxs)("button",{onClick:()=>{l(),ep(!1);try{window.dispatchEvent(new CustomEvent("mobileActionsToggle",{detail:{open:!1}}))}catch{}},"aria-label":"Nhập bằng giọng nói",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:`jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full flex items-center justify-center transition-all duration-500 shadow-2xl ${n?"bg-gradient-to-br from-red-500 to-pink-600 ring-4 ring-red-300/50 scale-110":"bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300"}`,children:[(0,t.jsx)(x.HiMicrophone,{className:`w-6 h-6 ${n?"text-white":"text-gray-700"} drop-shadow-md group-hover:scale-110 transition-transform duration-200`}),n&&(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full bg-red-500/30 animate-ping"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Voice"})]}),(0,t.jsxs)("button",{onClick:()=>{M({type:"info",message:"Chức năng đang hoàn thiện"})},"aria-label":"Chat nhanh",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-violet-100 to-purple-100 hover:from-violet-200 hover:to-purple-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(i.HiLightningBolt,{className:"w-6 h-6 text-yellow-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Chat nhanh"})]}),(0,t.jsxs)("button",{onClick:()=>{M({type:"info",message:"Chức năng đang hoàn thiện"})},"aria-label":"Báo xấu",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-rose-100 to-pink-100 hover:from-rose-200 hover:to-pink-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiShieldCheck,{className:"w-6 h-6 text-red-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Báo xấu"})]}),E&&(0,t.jsxs)("button",{onClick:()=>{M({type:"info",message:"Chức năng đang hoàn thiện"})},"aria-label":"Xóa lịch sử",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-slate-100 to-gray-100 hover:from-slate-200 hover:to-gray-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiTrash,{className:"w-6 h-6 text-gray-700 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Xóa lịch sử"})]}),(0,t.jsxs)("button",{onClick:()=>M({type:"info",message:"Chức năng đang hoàn thiện"}),"aria-label":"Vị trí",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-rose-100 to-pink-100 hover:from-rose-200 hover:to-pink-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiMapPin,{className:"w-6 h-6 text-rose-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Vị trí"})]}),(0,t.jsxs)("button",{onClick:()=>M({type:"info",message:"Chức năng đang hoàn thiện"}),"aria-label":"Danh thiếp",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-teal-100 to-cyan-100 hover:from-teal-200 hover:to-cyan-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiIdentification,{className:"w-6 h-6 text-teal-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Danh thiếp"})]}),(0,t.jsxs)("button",{onClick:()=>M({type:"info",message:"Chức năng đang hoàn thiện"}),"aria-label":"Vẽ hình",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-purple-100 to-fuchsia-100 hover:from-purple-200 hover:to-fuchsia-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)(x.HiPencil,{className:"w-6 h-6 text-purple-600 drop-shadow-md group-hover:scale-110 transition-transform duration-200"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"Vẽ hình"})]}),(0,t.jsxs)("button",{onClick:()=>M({type:"info",message:"Chức năng đang hoàn thiện"}),"aria-label":"Vẽ hình",className:"jsx-820bcd66933fca31 group relative cursor-pointer flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 relative w-12 h-12 mb-3 rounded-full bg-gradient-to-br from-slate-100 to-gray-100 hover:from-slate-200 hover:to-gray-200 shadow-2xl group-hover:shadow-3xl group-active:scale-95 transition-all duration-300 flex items-center justify-center",children:[(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-xs font-black text-gray-700 drop-shadow-md group-hover:scale-110 transition-transform duration-200",children:"@GIF"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 absolute inset-0 rounded-full shadow-inner shadow-white/50"})]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-sm font-medium text-gray-800",children:"@GIF"})]})]}),eM&&(0,t.jsx)(es.ConfirmModal,{title:"Xóa lịch sử",message:"Bạn có chắc muốn xóa toàn bộ lịch sử trò chuyện?",onCancel:()=>eA(!1),onConfirm:async()=>{eA(!1);try{if((await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"clearHistory",roomId:I})})).ok){M({type:"success",message:"Đã xóa lịch sử trò chuyện"});try{window.dispatchEvent(new CustomEvent("chatHistoryCleared",{detail:{roomId:I}}))}catch{}}else M({type:"error",message:"Xóa lịch sử thất bại"})}catch{M({type:"error",message:"Lỗi khi xóa lịch sử"})}},confirmText:"Xóa",variant:"danger"}),eE&&(0,t.jsx)(es.ConfirmModal,{title:"Báo xấu",message:"Bạn có muốn báo cáo cuộc trò chuyện này?",onCancel:()=>e$(!1),onConfirm:async()=>{e$(!1);try{await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:{roomId:I,sender:k._id,type:"notify",content:"Bạn đã báo xấu cuộc trò chuyện này"}})}),M({type:"success",message:"Đã gửi báo xấu"})}catch{M({type:"error",message:"Gửi báo xấu thất bại"})}},confirmText:"Báo xấu",variant:"warning"}),(0,t.jsx)(Q.default,{id:"820bcd66933fca31",children:"[contenteditable].jsx-820bcd66933fca31:empty~div.jsx-820bcd66933fca31>span.jsx-820bcd66933fca31{opacity:1}[contenteditable].jsx-820bcd66933fca31:not(:empty)~div.jsx-820bcd66933fca31>span.jsx-820bcd66933fca31,[contenteditable].jsx-820bcd66933fca31:focus~div.jsx-820bcd66933fca31>span.jsx-820bcd66933fca31{opacity:0}[contenteditable].jsx-820bcd66933fca31:focus~div.jsx-820bcd66933fca31>span.jsx-820bcd66933fca31{transition:opacity .3s}"}),ei&&er.length>0&&(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 absolute left-4 bottom-20 z-40 w-64 bg-white rounded-xl shadow-xl border border-gray-200",children:[(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 px-3 py-2 border-b text-xs text-gray-500",children:"Gợi ý Chat nhanh"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 max-h-48 overflow-y-auto",children:er.filter(e=>e.key.toLowerCase().startsWith((el||"").toLowerCase())).map((e,r)=>(0,t.jsxs)("button",{onClick:()=>{if(o.current){o.current.focus();try{let t=String(o.current.innerText||"").replace(/\/\s*[\w-]*$/,e.value);o.current.innerText=t;let r=document.createRange();r.selectNodeContents(o.current),r.collapse(!1);let s=window.getSelection();s?.removeAllRanges(),s?.addRange(r),ea(!1),ed(0),c()}catch{}}},className:`jsx-820bcd66933fca31 w-full text-left px-3 py-2 text-sm flex items-center gap-2 ${r===ec?"bg-indigo-50":"hover:bg-gray-50"}`,children:[(0,t.jsxs)("span",{className:"jsx-820bcd66933fca31 text-indigo-600",children:["/",e.key]}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 text-gray-500 truncate",children:e.value})]},e.key))})]}),K&&(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm px-4",children:(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 bg-white w-full max-w-sm rounded-2xl shadow-xl border border-gray-200 overflow-hidden",children:[(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 px-4 py-3 bg-gray-50 border-b flex items-center justify-between",children:[(0,t.jsx)("p",{className:"jsx-820bcd66933fca31 text-sm font-semibold text-gray-800",children:"Chọn thư mục ChatFlash"}),(0,t.jsx)("button",{onClick:()=>q(!1),className:"jsx-820bcd66933fca31 p-2 rounded-full cursor-pointer hover:bg-white/20",children:(0,t.jsx)(i.HiX,{className:"w-5 h-5"})})]}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 p-3",children:0===Y.length?(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 text-center text-gray-500 py-8 text-sm",children:"Chưa có thư mục"}):(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 space-y-2",children:Y.map(e=>(0,t.jsxs)("button",{onClick:()=>(e=>{et(e);try{localStorage.setItem(`chatFlashActiveFolder:${I}`,JSON.stringify(e))}catch{}q(!1)})(e),className:"jsx-820bcd66933fca31 w-full text-left px-3 py-2 rounded-xl bg-gray-50 hover:bg-gray-100 border border-gray-200 text-sm flex items-center gap-2",children:[(0,t.jsx)(x.HiFolder,{className:"w-4 h-4 text-indigo-600"}),(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 truncate",children:e.name}),ee?.id===e.id&&(0,t.jsx)("span",{className:"jsx-820bcd66933fca31 ml-auto text-xs text-indigo-600",children:"Đang chọn"})]},e.id))})})]})}),e_&&(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 fixed inset-0 z-[9999] flex items-center justify-center p-4",children:[(0,t.jsx)("div",{onClick:()=>eT(!1),className:"jsx-820bcd66933fca31 absolute inset-0 bg-black/40"}),(0,t.jsx)("div",{className:"jsx-820bcd66933fca31 relative bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden",children:(0,t.jsxs)("div",{className:"jsx-820bcd66933fca31 px-5 py-4 text-center space-y-2",children:[(0,t.jsx)("p",{className:"jsx-820bcd66933fca31 text-base font-bold text-gray-900",children:"Đang cập nhật"}),(0,t.jsx)("p",{className:"jsx-820bcd66933fca31 text-sm text-gray-500",children:"Tính năng đang được cập nhật."}),(0,t.jsx)("button",{onClick:()=>eT(!1),className:"jsx-820bcd66933fca31 cursor-pointer mt-2 px-4 py-2 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-gray-800 transition",children:"Đóng"})]})})]}),L&&(0,t.jsx)(W,{isOpen:L,onClose:()=>P(!1),onCreate:X}),H&&(0,t.jsx)(F,{isOpen:H,onClose:()=>U(!1),onCreate:J,createLoading:R})]})}var eS=e.i(83872);let ek=({size:e=24,className:r="",onClick:s})=>(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:e,height:e,fill:"none",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round",className:r,onClick:s,children:(0,t.jsx)("path",{d:"M10.1141,4.49112   L9.91063,7.63542   L9.891,8.05196   L9.8012,8.06134   C5.36297,8.583 2,12.3671 2,17   C2,17.457 2.03414,17.91 2.10168,18.3565   C2.38094,20.2022 2.59088,20.3807 3.87391,18.8547   C4.18977,18.479 4.54227,18.1439 4.91368,17.8247   C6.24977,16.7224 7.90632,16.0786 9.66842,16.0067   L9.894,16.002   L9.95549,17.2308   L10.1215,19.576   C10.2008,20.38 11.0467,20.9293 11.8253,20.4902   C12.1766,20.2919 12.52,20.0809 12.8641,19.8706   C14.652,18.7519 16.3249,17.4666 17.9553,16.1321   C18.9147,15.3326 19.7558,14.5744 20.4714,13.8844   C20.8007,13.5606 21.1304,13.2376 21.4496,12.9037   C21.9118,12.42 21.9575,11.6189 21.4737,11.1124   C20.3603,9.94706 18.7862,8.48751 16.8271,6.94049   C15.2394,5.69825 13.597,4.53773 11.8571,3.51856   C11.0203,3.04172 10.1902,3.69599 10.1141,4.49112 Z"})}),eC=({size:e=16,className:r="",onClick:s})=>(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",width:e,height:e,fill:"none",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round",className:r,onClick:s,children:[(0,t.jsx)("path",{d:"M1.75 9.75L4.25 12.25"}),(0,t.jsx)("path",{d:"M5.75 8.25L8.25 5.75"}),(0,t.jsx)("path",{d:"M3.75 10.25L6.25 12.75L12.25 6.25"})]});function e_({message:e,isGroup:s,isRecalled:n,isMine:i,isLast:l,myId:o,allUsersMap:c,getSenderInfo:d,isMobile:m,isUploading:u}){let[x,g]=(0,r.useState)(!1);if(!i||!l||n||u)return null;let p=e.readBy||[];if(!s){let e=p.some(e=>String(e)!==String(o));return(0,t.jsxs)("span",{className:"flex items-center bg-gray-400 text-[0.75rem] mt-2 text-white px-2 py-0.5 rounded-full",children:[(0,t.jsx)(eC,{className:" w-4 h-4"}),e?"Đã xem":"Đã gửi"]})}let f=p.filter(e=>String(e)!==String(o)),b=f.map(e=>c.get(String(e))||"Người dùng");return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"flex mt-2 cursor-pointer",title:f.length>0?b.join(", "):void 0,onClick:()=>{g(!0)},children:(0,t.jsx)("div",{className:"flex items-center justify-center gap-1",children:0===f.length?(0,t.jsxs)("span",{className:"flex items-center gap-1 bg-gray-400 text-[0.75rem] text-white px-2 py-0.5 rounded-full",children:[(0,t.jsx)(eC,{className:"w-4 h-4 flex-shrink-0"}),"Đã gửi"]}):(0,t.jsxs)(t.Fragment,{children:[f.slice(0,6).map((r,s)=>{let n=d(r),i=`${e._id}-reader-${s}`;return(0,t.jsx)("div",{className:"w-4 h-4 rounded-full bg-gray-300 overflow-hidden ring-1 ring-white flex-shrink-0",children:(0,t.jsx)(a.default,{src:n.avatar?(0,h.getProxyUrl)(n.avatar):"/logo/avata.webp",alt:n.name,width:16,height:16,className:"w-full h-full object-cover"})},i)}),f.length>6&&(0,t.jsxs)("div",{className:"w-4 h-4 rounded-full bg-gray-200 text-gray-700 text-[0.625rem] flex items-center justify-center ring-1 ring-white flex-shrink-0",children:["+",f.length-6]})]})})}),x&&f.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-[9998]",onClick:()=>g(!1)}),(0,t.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none",children:(0,t.jsxs)("div",{className:"min-w-[11.25rem] max-w-[18rem] px-3 py-2.5 bg-white rounded-xl border border-gray-200 shadow-xl pointer-events-auto",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-gray-100",children:[(0,t.jsx)("span",{className:"text-sm font-semibold text-gray-700",children:"Đã xem"}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[f.length," người"]})]}),(0,t.jsx)("ul",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:f.map((r,s)=>{let n=d(r),i=n.name||c.get(String(r))||"Người dùng";return(0,t.jsxs)("li",{className:"flex items-center gap-2 py-1",children:[(0,t.jsx)("div",{className:"w-4 h-4 rounded-full bg-gray-300 overflow-hidden ring-1 ring-white flex-shrink-0",children:(0,t.jsx)(a.default,{src:n.avatar?(0,h.getProxyUrl)(n.avatar):"/logo/avata.webp",alt:i,width:16,height:16,className:"w-full h-full object-cover"})}),(0,t.jsx)("span",{className:"text-sm text-gray-700",children:i})]},`${e._id}-reader-name-${s}`)})})]})})]})]})}function eT(e){let t=new Date,r=t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate(),s=e.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}),n=e.toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"});return r?`H\xf4m nay l\xfac ${s}`:`${n} l\xfac ${s}`}function eM({variant:e,title:r,date:s,senderName:n,senderAvatar:i,isMe:l=!1,highlighted:o=!1,onOpen:c}){let d=s.getMonth()+1,m=s.getDate();return"due"===e?(0,t.jsxs)("div",{className:`w-full max-w-[18rem] p-4 bg-white rounded-2xl border border-gray-200 shadow-sm text-center ${o?"ring-2 ring-yellow-300":""}`,children:[(0,t.jsx)("div",{className:"flex justify-center mb-2",children:(0,t.jsx)(x.HiOutlineClock,{className:"w-7 h-7 text-red-500"})}),(0,t.jsxs)("p",{className:"text-base font-semibold text-gray-900 truncate",children:["Nhắc hẹn: ",r||""]}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-0.5",children:eT(s)}),(0,t.jsx)("div",{className:"pt-2",children:(0,t.jsx)("button",{onClick:c,className:"w-[10rem] cursor-pointer px-4 py-1 text-gray-700 bg-gray-100 border border-gray-300 rounded-full hover:bg-gray-200 font-bold text-sm uppercase transition-all",children:"MỞ LỊCH"})})]}):(0,t.jsxs)("div",{className:`bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden w-full max-w-[18rem] ${o?"ring-2 ring-yellow-300":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 p-3 border-b border-gray-100 bg-white",children:[(0,t.jsx)("div",{className:"w-6 h-6 rounded-full overflow-hidden flex-shrink-0",children:i?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(i),width:24,height:24,className:"object-cover w-full h-full",alt:""}):(0,t.jsx)("div",{className:"w-full h-full bg-blue-500 text-white flex items-center justify-center text-[10px] font-bold",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:"",width:64,height:64,className:"w-full h-full object-cover"})})}),(0,t.jsxs)("span",{className:"text-sm text-gray-700",children:[l?"Bạn":n," đã tạo một nhắc hẹn"]})]}),(0,t.jsxs)("div",{className:"flex p-4 gap-4 items-center cursor-pointer",children:[(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center min-w-[50px]",children:[(0,t.jsxs)("span",{className:"text-red-500 text-xs font-bold uppercase tracking-wider",children:["THG ",d]}),(0,t.jsx)("span",{className:"text-3xl text-gray-800 font-normal leading-none mt-1",children:m})]}),(0,t.jsxs)("div",{className:"flex flex-col overflow-hidden",children:[(0,t.jsx)("p",{className:"text-lg font-semibold text-gray-900 truncate",children:r||"Không có tiêu đề"}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-0.5",children:eT(s)})]})]})]})}function eA({messagesGrouped:e,messages:s,currentUser:n,allUsersMap:l,uploadingFiles:o,highlightedMsgId:c,isGroup:d,onContextMenu:m,onMobileLongPress:u,onReplyMessage:g,onJumpToMessage:p,getSenderInfo:f,renderMessageContent:b,onOpenMedia:y,editingMessageId:v,setEditingMessageId:w,editContent:j,setEditContent:N,onSaveEdit:S,onRefresh:k,onPinMessage:C,onToggleReaction:_,contextMenu:T,scrollManagedExternally:M=!1,isSidebarOpen:A=!1,isMobile:E=!1,onShareMessage:$,onOpenChatInfoSection:I}){let[,L]=(0,r.useState)(null),[P,H]=(0,r.useState)(null),[U,R]=(0,r.useState)(null),[D,O]=(0,r.useState)(null),[B,F]=(0,r.useState)(null),V=(0,r.useRef)(null),G=(0,r.useRef)(!1),[W,X]=(0,r.useState)(null),[K,q]=(0,r.useState)({id:null,dx:0}),[Q,Y]=(0,r.useState)(null),[Z,ee]=(0,r.useState)(new Set),et=(0,r.useRef)({x:0,y:0,id:null,isMe:!1});(0,r.useEffect)(()=>{let e=e=>{if(U){let t=document.getElementById(`msg-${U}`);t&&!t.contains(e.target)&&R(null)}},t=()=>{document.hidden&&R(null)},r=()=>{R(null)},s=e=>{"Escape"===e.key&&R(null)};return document.addEventListener("click",e),document.addEventListener("visibilitychange",t),window.addEventListener("blur",r),document.addEventListener("keydown",s),()=>{document.removeEventListener("click",e),document.removeEventListener("visibilitychange",t),window.removeEventListener("blur",r),document.removeEventListener("keydown",s)}},[U]),(0,r.useEffect)(()=>{T?.visible||X(null)},[T]);let er=e=>{let t=new Date(e),r=new Date;return t.toDateString()===r.toDateString()?t.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}):t.toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit",year:"numeric"})};return(0,r.useEffect)(()=>{!M&&c&&setTimeout(()=>{let e=document.getElementById(`msg-${c}`);e&&(e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{e.scrollIntoView({behavior:"auto",block:"center"})},100))},100)},[c,M]),(0,t.jsxs)(t.Fragment,{children:[Array.from(e.entries()).map(([e,k])=>{let M;return(0,t.jsxs)(r.default.Fragment,{children:[(0,t.jsx)("div",{className:"flex justify-center my-4 sticky top-1 z-10",children:(0,t.jsx)("span",{className:"px-4 py-1 text-xs font-medium text-gray-600 bg-gray-50/90 rounded-full shadow",children:e})}),(M=new Set,(0,t.jsx)(t.Fragment,{children:k.map((e,D)=>{let z,J,es,en,ei,ea,el,eo,ec,ed,em,eu,eh,ex,eg,ep,ef,eb,ey;if(M.has(e._id))return null;let ev=e._id===s[s.length-1]?._id,ew=f(e.sender),ej=String(ew._id)===String(n._id),eN=e.replyToMessageId?s.find(t=>t._id===e.replyToMessageId):null,eC=o[e._id],eT=!!e.isSending,eA="string"==typeof e.fileUrl&&e.fileUrl.startsWith("blob:"),eE=e._id===v,e$=e.editedAt&&!eE,eI=e.isRecalled,eL="video"===e.type||e.fileUrl&&(0,h.isVideoFile)(e.fileUrl),eP=("image"===e.type||"video"===e.type||"file"===e.type&&!eL)&&(void 0!==eC||eT||eA),eH=e.reactions||{},eU=String(n._id),eR=Object.values(eH).some(e=>(e||[]).length>0),eD=D>0?k[D-1]:null,eO=!1;if(eD&&"notify"!==eD.type){let t=f(eD.sender),r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(eD.serverTimestamp??eD.timestamp)||0;t._id===ew._id&&r-s<3e5&&(eO=!0)}let eB=Number(e.serverTimestamp??e.timestamp)||0,eF=null!=eD?Number(eD.serverTimestamp??eD.timestamp)||0:null,ez=null!=eF&&eB-eF>=18e5?(0,t.jsx)("div",{className:"flex justify-center my-4",children:(0,t.jsx)("span",{className:"px-4 py-2 text-white  text-xs font-medium  bg-gray-400/60 rounded-full shadow",children:(z=new Date(eB),J=new Date,(es=new Date).setDate(J.getDate()-1),en=(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),ei=z.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}),ea=en(z,J)?"Hôm nay":en(z,es)?"Hôm qua":z.toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"}),`${ei} ${ea}`)})}):null,eV=D<k.length-1?k[D+1]:null,eG=!0;if(eV&&"notify"!==eV.type){let t=f(eV.sender),r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(eV.serverTimestamp??eV.timestamp)||0;t._id===ew._id&&s-r<3e5&&(eG=!1)}if(!eI&&("image"===e.type||"video"===e.type)){let i=[e],p=e.batchId;for(let e=D+1;e<k.length;e++){let t=k[e];if(t.isRecalled||"image"!==t.type&&"video"!==t.type)break;let r=f(t.sender),s=Math.abs(Number(t.timestamp)-Number(i[i.length-1].timestamp)),n=t.batchId;if((p||n)&&p!==n||r._id!==ew._id||s>12e4)break;i.push(t)}if(i.length>1){let p,b;i.slice(1).forEach(e=>M.add(e._id));let v=i[i.length-1],w=String(ew._id)===String(n._id),j=v._id===s[s.length-1]?._id,N=D+i.length,S=N<k.length?k[N]:null,C=!0;if(S&&"notify"!==S.type){let e=f(S.sender),t=Number(v.serverTimestamp??v.timestamp)||0,r=Number(S.serverTimestamp??S.timestamp)||0;e._id===ew._id&&r-t<3e5&&(C=!1)}let T=i.some(e=>{let t=void 0!==o[e._id],r=!!e.isSending,s="string"==typeof e.fileUrl&&e.fileUrl.startsWith("blob:");return t||r||s});return(0,t.jsxs)(r.default.Fragment,{children:[null,ez,(0,t.jsxs)("div",{id:`msg-${e._id}`,className:`
                      w-full  sm:max-w-[23rem]
                      flex gap-2 group relative
                      ${w?"ml-auto flex-row-reverse":"mr-auto flex-row"}
                      ${eO?"mt-2":"mt-4"}
                      ${j?"mb-8":""}
                    `,children:[!w&&(0,t.jsx)("div",{className:`${eO?"opacity-0":""} flex-shrink-0`,children:ew.avatar?(0,t.jsx)("div",{className:"w-9 h-9 rounded-full overflow-hidden flex-shrink-0",children:(0,t.jsx)(a.default,{width:38,height:38,src:(0,h.getProxyUrl)(ew.avatar),alt:ew.name,className:"w-full h-full object-cover",unoptimized:String(ew.avatar).includes("mega.nz")})}):(0,t.jsx)("div",{className:"w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:ew.name||"User",width:38,height:38,className:"w-full h-full rounded-full object-cover"})})}),(0,t.jsxs)("div",{className:`flex flex-col min-w-0 ${w?"items-end":"items-start"}`,children:[d&&!eO&&!eI&&!w&&(0,t.jsx)("p",{className:"text-sm mb-1 px-2 py-1 bg-white rounded-[2rem] text-gray-600",children:l.get(ew._id)||ew.name}),(0,t.jsxs)("div",{className:` px-0 py-0 rounded-lg shadow-none max-w-[70vw] sm:max-w-[22rem] mt-1 bg-transparent relative ${eR?"mb-4":""}`,style:E&&K.id===e._id?{transform:`translateX(${Math.max(-100,Math.min(100,K.dx))}px)`}:void 0,onClick:()=>{R(e._id),F(null)},onTouchStart:t=>{try{if(eI)return;G.current=!1,null!=V.current&&(clearTimeout(V.current),V.current=null);let r=t.touches&&t.touches[0],s=r?r.clientX:0,n=r?r.clientY:0,i=t.currentTarget;et.current={x:s,y:n,id:e._id,isMe:w},q({id:null,dx:0}),Y(e._id),V.current=window.setTimeout(()=>{G.current=!0,R(e._id),F(null),u?.(e,i,s,n)},420)}catch{}},onTouchEnd:t=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),G.current&&(t.preventDefault(),t.stopPropagation()),E&&et.current.id===e._id&&((et.current.isMe?K.dx<-64:K.dx>64)&&g?.(e),q({id:null,dx:0}),et.current={x:0,y:0,id:null,isMe:!1})}catch{}},onTouchMove:t=>{try{if(null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),!E)return;let r=t.touches&&t.touches[0],s=r?r.clientX:0,n=r?r.clientY:0,i=s-et.current.x,a=n-et.current.y;if(et.current.id===e._id&&Math.abs(i)>8&&24>Math.abs(a)){let r=et.current.isMe?i<0:i>0;q({id:e._id,dx:r?i:0}),t.preventDefault()}}catch{}},onTouchCancel:()=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),E&&et.current.id===e._id&&(q({id:null,dx:0}),et.current={x:0,y:0,id:null,isMe:!1})}catch{}},children:[!eI&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onClick:t=>{t.preventDefault(),$({...e,batchItems:i.map(e=>({id:e._id,content:e.content||"",type:"video"===e.type?"video":"image",fileUrl:e.fileUrl||e.previewUrl,fileName:e.fileName}))})},className:`absolute cursor-pointer top-1/2 -translate-y-1/2 p-1.5 bg-white/90 rounded-full shadow hover:bg-indigo-50 ${w?"right-full mr-2":"left-full ml-2"}`,"aria-label":"Chia sẻ nhóm media",title:"Chia sẻ nhóm media",children:(0,t.jsx)(ek,{className:"w-4 h-4 text-indigo-600"})}),E&&K.id===e._id&&(0,t.jsx)("div",{className:`absolute top-1/2 -translate-y-1/2 ${w?"left-full ml-2":"right-full mr-2"}`,style:{opacity:Math.min(Math.abs(K.dx)/64,1)},children:(0,t.jsx)("div",{className:"p-2 bg-white rounded-full shadow border border-gray-200",children:w?(0,t.jsx)(x.HiArrowUturnLeft,{className:"w-5 h-5 text-blue-600"}):(0,t.jsx)(x.HiArrowUturnRight,{className:"w-5 h-5 text-blue-600"})})}),!E&&(0,t.jsx)(t.Fragment,{children:(0,t.jsx)("button",{onClick:t=>{t.preventDefault(),m(t,e)},className:`absolute cursor-pointer top-1/2 -translate-y-1/2 z-10 p-1.5 bg-white/90 rounded-full shadow hover:bg-blue-50 ${w?"right-full mr-10":"left-full ml-10"} opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto`,"aria-label":"Mở menu",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-4 h-4 text-gray-600"})})}),!E&&(0,t.jsx)(eS.default,{isMine:w,visible:U===e._id,onPick:t=>{_?.(e,t),R(null)},className:`${w?"right-full mr-18":"left-full ml-18"} ${U===e._id?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto"}`})]}),(0,t.jsx)("div",{className:`inline-grid gap-1 rounded-xl overflow-hidden ${A?"sm:grid-cols-[6rem_6rem]":"sm:grid-cols-[10rem_10rem]"} grid-cols-[8rem_8rem]`,children:i.map((r,s)=>{let n,l,d="video"===r.type||r.fileUrl&&(0,h.isVideoFile)(r.fileUrl),g=String(r.fileUrl||r.previewUrl||""),p=o[r._id],f=!!r.isSending,b=String(g).startsWith("blob:"),v=void 0!==p||f||b,j=i.length%2!=0,N=s===i.length-1,S=j&&N;return d?(0,t.jsxs)("div",{id:`msg-${r._id}`,className:`relative bg-black rounded-[0.25rem] overflow-hidden cursor-pointer h-[8rem] ${S?"col-span-2 w-full":"w-[8rem]"}  ${A?S?"sm:w-full sm:h-[6rem] aspect-square":"sm:w-[6rem] sm:h-[6rem] aspect-square":S?"sm:w-full sm:h-[10rem] sm:aspect-video aspect-square":"sm:aspect-video aspect-square sm:h-[10rem] sm:w-[10rem]"} ${c===r._id?"ring-2 ring-yellow-300":""} ${Q===r._id?"ring-2 ring-blue-300 scale-[0.98] transition-transform":""}`,onClick:()=>!v&&y(String(r.fileUrl),"video"),onContextMenu:e=>{e.preventDefault(),e.stopPropagation(),m(e,r)},onTouchStart:t=>{try{if(t.stopPropagation(),r.isRecalled)return;G.current=!1,null!=V.current&&(clearTimeout(V.current),V.current=null);let s=t.touches&&t.touches[0],n=s?s.clientX:0,i=s?s.clientY:0,a=t.currentTarget;et.current={x:n,y:i,id:e._id,isMe:w},q({id:null,dx:0}),Y(r._id),V.current=window.setTimeout(()=>{G.current=!0,R(r._id),F(null),u?.(r,a,n,i)},420)}catch{}},onTouchEnd:e=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),G.current&&(e.preventDefault(),e.stopPropagation())}catch{}},onTouchMove:()=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null)}catch{}},children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(g),className:"w-full h-full object-cover",playsInline:!0,preload:"metadata"}),!v&&(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-8 h-8 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(x.HiPlay,{className:"w-5 h-5 text-blue-600 ml-0.5"})})}),v&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/60 text-white flex items-center justify-center",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-white/60 border-t-transparent rounded-full animate-spin"}),void 0!==p&&(0,t.jsxs)("span",{className:"text-sm font-semibold",children:[Math.round(p),"%"]})]})})]},`${r._id}-${s}`):(0,t.jsxs)("div",{id:`msg-${r._id}`,className:`relative rounded-[0.25rem] overflow-hidden cursor-pointer hover:bg-gray-100 shadow-sm h-[8rem] ${S?"col-span-2 w-full":"w-[8rem]"} ${A?S?"sm:w-full sm:h-[6rem]":"sm:w-[6rem] sm:h-[6rem]":S?"sm:w-full sm:h-[10rem]":"sm:w-[10rem] sm:h-[10rem]"} ${c===r._id?"ring-2 ring-yellow-300":""} ${Q===r._id?"ring-2 ring-blue-300 scale-[0.98] transition-transform":""}`,onClick:e=>{e.stopPropagation(),v||y(String(r.fileUrl||r.previewUrl||""),"image")},onContextMenu:e=>{e.preventDefault(),e.stopPropagation(),m(e,r)},onTouchStart:t=>{try{if(t.stopPropagation(),r.isRecalled)return;G.current=!1,null!=V.current&&(clearTimeout(V.current),V.current=null);let s=t.touches&&t.touches[0],n=s?s.clientX:0,i=s?s.clientY:0,a=t.currentTarget;et.current={x:n,y:i,id:e._id,isMe:w},q({id:null,dx:0}),Y(r._id),V.current=window.setTimeout(()=>{G.current=!0,R(r._id),F(null),u?.(r,a,n,i)},420)}catch{}},onTouchEnd:e=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),G.current&&(e.preventDefault(),e.stopPropagation())}catch{}},onTouchMove:()=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null)}catch{}},children:[String(g).startsWith("blob:")?(0,t.jsx)(a.default,{width:600,height:600,src:g,alt:"Ảnh",className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{width:600,height:600,src:(0,h.getProxyUrl)(g),alt:"Ảnh",className:"w-full h-full object-cover"}),v&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/70 flex items-center justify-center",children:(n=2*Math.PI*18,l=Math.max(0,Math.min(100,Number(p||0))),(0,t.jsx)("div",{className:"flex flex-col items-center",children:(0,t.jsxs)("svg",{width:40,height:40,viewBox:"0 0 40 40",children:[(0,t.jsx)("circle",{cx:20,cy:20,r:18,stroke:"rgba(255,255,255,0.3)",strokeWidth:4,fill:"none"}),(0,t.jsx)("circle",{cx:20,cy:20,r:18,stroke:"white",strokeWidth:4,fill:"none",strokeDasharray:n,strokeDashoffset:n-l/100*n,strokeLinecap:"round",transform:"rotate(-90 20 20)"})]})}))})]},`${r._id}-${s}`)})}),0===(p=Object.entries(eH).map(([e,t])=>({emoji:e,count:(t||[]).length,mine:(t||[]).includes(eU),users:(t||[]).map(e=>l.get(String(e))||"Người dùng")})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count)).length?null:(0,t.jsxs)("div",{className:`absolute ${w?"right-2 -mr-1":"left-2 -ml-1"} bottom-1 flex items-center gap-1`,children:[(0,t.jsxs)("div",{className:"flex items-center bg-white rounded-full shadow-lg border border-gray-200",children:[p.slice(0,3).map((r,s)=>(0,t.jsxs)("div",{onClick:t=>{t.stopPropagation(),F(B?.msgId===e._id&&B?.emoji===r.emoji?null:{msgId:e._id,emoji:r.emoji})},className:`flex items-center gap-0.5 py-0.5 rounded-full text-sm cursor-pointer transition-all duration-200 hover:bg-gray-100 active:scale-95 ${r.mine?"bg-blue-50":"bg-transparent"}`,title:`${r.count} người`,children:[(0,t.jsx)("span",{className:"text-lg leading-none",children:r.emoji}),r.count>1&&(0,t.jsx)("span",{className:`text-xs font-medium ${r.mine?"text-blue-600":"text-gray-600"}`,children:r.count})]},`${e._id}-react-group-${s}`)),p.length>3&&(0,t.jsxs)("div",{className:"px-2 text-xs text-gray-500 font-medium",children:["+",p.length-3]})]}),(0,t.jsx)("div",{className:"absolute inset-0 -z-10 bg-white/60 backdrop-blur-sm rounded-full scale-0 group-hover:scale-100 transition-transform duration-300"})]}),B&&B.msgId===e._id&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-30",onClick:()=>F(null)}),(0,t.jsx)("div",{ref:t=>{if(t&&B.msgId===e._id){let e=t.parentElement?.getBoundingClientRect();if(e){let r=window.innerHeight-e.bottom,s=e.top;r<250&&s>r?(t.style.bottom="100%",t.style.top="auto",t.style.marginBottom="0.625rem",t.style.marginTop="0"):(t.style.top="100%",t.style.bottom="auto",t.style.marginTop="0.625rem",t.style.marginBottom="0")}}},className:`absolute ${w?"right-2":"left-2"} z-40`,children:(b=(eH[B.emoji]||[]).map(e=>l.get(String(e))||String(e)),(0,t.jsxs)("div",{className:"min-w-[11.25rem] max-w-[15rem] px-3 py-2.5 bg-white rounded-xl border border-gray-200 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-gray-100",children:[(0,t.jsx)("span",{className:"text-2xl",children:B.emoji}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-gray-700",children:[b.length," người"]})]}),b.length>0?(0,t.jsx)("ul",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:b.map((r,s)=>(0,t.jsx)("li",{className:"text-sm text-gray-700 py-1 hover:text-blue-600 transition-colors",children:r},`${e._id}-user-group-${s}`))}):(0,t.jsx)("div",{className:"text-sm text-gray-500 py-1",children:"Chưa có ai"})]}))})]}),C&&(0,t.jsx)("div",{className:`text-xs mt-2 ${w?"text-gray-700":"text-gray-500"}`,children:(0,t.jsx)("span",{className:"inline-block px-2 py-1 bg-white rounded-[2rem]",children:er(Number(v.serverTimestamp??v.timestamp)||0)})})]}),(0,t.jsx)(e_,{message:v,isGroup:d,isRecalled:!!v.isRecalled,isMine:w,isLast:j,myId:eU,allUsersMap:l,getSenderInfo:f,isMobile:E,isUploading:T})]})]},`group-${e._id}`)]},`group-${e._id}-frag`)}}if(!eI&&"file"===e.type&&!eL){let i=[e];for(let e=D+1;e<k.length;e++){let t=k[e];if(t.isRecalled||!("file"===t.type&&!(t.fileUrl&&(0,h.isVideoFile)(t.fileUrl))))break;let r=f(t.sender),s=Math.abs(Number(t.timestamp)-Number(i[i.length-1].timestamp));if(r._id!==ew._id||s>12e4)break;i.push(t)}if(i.length>1){let g,p;i.slice(1).forEach(e=>M.add(e._id));let b=i[i.length-1],y=String(ew._id)===String(n._id),v=b._id===s[s.length-1]?._id,w=D+i.length,j=w<k.length?k[w]:null,N=!0;if(j&&"notify"!==j.type){let e=f(j.sender),t=Number(b.serverTimestamp??b.timestamp)||0,r=Number(j.serverTimestamp??j.timestamp)||0;e._id===ew._id&&r-t<3e5&&(N=!1)}let S=i.some(e=>{let t=void 0!==o[e._id],r=!!e.isSending,s="string"==typeof e.fileUrl&&e.fileUrl.startsWith("blob:");return t||r||s});return(0,t.jsxs)(r.default.Fragment,{children:[null,ez,(0,t.jsxs)("div",{id:`msg-${e._id}`,className:`
                      w-full  sm:max-w-[23rem]
                      flex gap-2 group relative
                      ${y?"ml-auto flex-row-reverse":"mr-auto flex-row"}
                      ${eO?"mt-2":"mt-4"}
                      ${v?"mb-8":""}
                    `,children:[!y&&(0,t.jsx)("div",{className:`${eO?"opacity-0":""} flex-shrink-0`,children:ew.avatar?(0,t.jsx)("div",{className:"w-9 h-9 rounded-full overflow-hidden flex-shrink-0",children:(0,t.jsx)(a.default,{width:38,height:38,src:(0,h.getProxyUrl)(ew.avatar),alt:ew.name,className:"w-full h-full object-cover",unoptimized:String(ew.avatar).includes("mega.nz")})}):(0,t.jsx)("div",{className:"w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:ew.name||"User",width:38,height:38,className:"w-full h-full rounded-full object-cover"})})}),(0,t.jsxs)("div",{className:`flex flex-col min-w-0 ${y?"":"items-start"}`,children:[d&&!eO&&!eI&&!y&&(0,t.jsx)("p",{className:"text-sm  px-2  text-gray-600",children:l.get(ew._id)||ew.name}),(0,t.jsxs)("div",{className:`py-2 rounded-lg max-w-[70vw] sm:max-w-[18rem] mt-1  relative ${eR?"mb-4":""}`,onClick:()=>{R(e._id),F(null)},children:[!eI&&(0,t.jsxs)(t.Fragment,{children:[!E&&(0,t.jsx)(t.Fragment,{children:(0,t.jsx)("button",{onClick:t=>{t.preventDefault(),m(t,e)},className:`absolute top-1/2 -translate-y-1/2 z-10 p-1.5 bg-white/90 rounded-full shadow hover:bg-blue-50 ${y?"right-full mr-2":"left-full ml-2"} opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto`,"aria-label":"Mở menu",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-4 h-4 text-gray-600"})})}),!E&&(0,t.jsx)(eS.default,{isMine:y,visible:U===e._id,onPick:t=>{_?.(e,t),R(null)},className:`${y?"right-full mr-10":"left-full ml-10"} ${U===e._id?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto"}`})]}),(0,t.jsx)("div",{className:"space-y-2",children:i.map((e,r)=>{let s,n;return(0,t.jsxs)("a",{id:`msg-${e._id}`,href:(0,h.getProxyUrl)(String(e.fileUrl||""),!0),download:e.fileName||"download",target:"_blank",rel:"noreferrer",className:`relative flex items-center bg-white gap-3 p-2 rounded-xl border cursor-pointer ${c===e._id?"bg-yellow-50 border-yellow-300":"border-gray-200 hover:bg-gray-50"} ${Q===e._id?"ring-2 ring-blue-300 scale-[0.98] transition-transform":""}`,onClick:t=>{void 0!==o[e._id]&&t.preventDefault()},onContextMenu:t=>{t.preventDefault(),t.stopPropagation(),m(t,e)},onTouchStart:t=>{try{if(e.isRecalled)return;G.current=!1,null!=V.current&&(clearTimeout(V.current),V.current=null);let r=t.touches&&t.touches[0],s=r?r.clientX:0,n=r?r.clientY:0,i=t.currentTarget;Y(e._id),V.current=window.setTimeout(()=>{G.current=!0,R(e._id),F(null),u?.(e,i,s,n)},420)}catch{}},onTouchEnd:e=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),G.current&&(e.preventDefault(),e.stopPropagation())}catch{}},onTouchMove:()=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null)}catch{}},"aria-disabled":void 0!==o[e._id]||void 0,children:[(0,t.jsx)("div",{className:"p-2 bg-blue-600 rounded-xl",children:(0,t.jsx)(x.HiOutlineDocumentText,{className:"w-5 h-5 text-white"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate",children:e.fileName||"Tệp đính kèm"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:"Nhấn để tải xuống"})]}),void 0!==o[e._id]&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/60 text-white flex items-center justify-center",children:(s=2*Math.PI*14.5,n=Math.max(0,Math.min(100,Number(o[e._id]||0))),(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsxs)("svg",{width:32,height:32,viewBox:"0 0 32 32",children:[(0,t.jsx)("circle",{cx:16,cy:16,r:14.5,stroke:"rgba(255,255,255,0.35)",strokeWidth:3,fill:"none"}),(0,t.jsx)("circle",{cx:16,cy:16,r:14.5,stroke:"white",strokeWidth:3,fill:"none",strokeDasharray:s,strokeDashoffset:s-n/100*s,strokeLinecap:"round",transform:"rotate(-90 16 16)"})]}),(0,t.jsxs)("span",{className:"text-xs font-semibold mt-1",children:[Math.round(n),"%"]})]}))})]},`${e._id}-${r}`)})}),0===(g=Object.entries(eH).map(([e,t])=>({emoji:e,count:(t||[]).length,mine:(t||[]).includes(eU),users:(t||[]).map(e=>l.get(String(e))||"Người dùng")})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count)).length?null:(0,t.jsxs)("div",{className:`absolute ${y?"right-2 -mr-1":"left-2 -ml-1"} bottom-1 flex items-center gap-1`,children:[(0,t.jsxs)("div",{className:"flex items-center bg-white rounded-full shadow-lg border border-gray-200",children:[g.slice(0,3).map((r,s)=>(0,t.jsxs)("div",{onClick:t=>{t.stopPropagation(),F(B?.msgId===e._id&&B?.emoji===r.emoji?null:{msgId:e._id,emoji:r.emoji})},className:`flex items-center gap-0.5 py-0.5 rounded-full text-sm cursor-pointer transition-all duration-200 hover:bg-gray-100 active:scale-95 ${r.mine?"bg-blue-50":"bg-transparent"}`,title:`${r.count} người`,children:[(0,t.jsx)("span",{className:"text-lg leading-none",children:r.emoji}),r.count>1&&(0,t.jsx)("span",{className:`text-xs font-medium ${r.mine?"text-blue-600":"text-gray-600"}`,children:r.count})]},`${e._id}-react-filegroup-${s}`)),g.length>3&&(0,t.jsxs)("div",{className:"px-2 text-xs text-gray-500 font-medium",children:["+",g.length-3]})]}),(0,t.jsx)("div",{className:"absolute inset-0 -z-10 bg-white/60 backdrop-blur-sm rounded-full scale-0 group-hover:scale-100 transition-transform duration-300"})]}),B&&B.msgId===e._id&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-30",onClick:()=>F(null)}),(0,t.jsx)("div",{ref:t=>{if(t&&B.msgId===e._id){let e=t.parentElement?.getBoundingClientRect();if(e){let r=window.innerHeight-e.bottom,s=e.top;r<250&&s>r?(t.style.bottom="100%",t.style.top="auto",t.style.marginBottom="0.625rem",t.style.marginTop="0"):(t.style.top="100%",t.style.bottom="auto",t.style.marginTop="0.625rem",t.style.marginBottom="0")}}},className:`absolute ${y?"right-2":"left-2"} z-40`,children:(p=(eH[B.emoji]||[]).map(e=>l.get(String(e))||String(e)),(0,t.jsxs)("div",{className:"min-w-[11.25rem] max-w-[15rem] px-3 py-2.5 bg-white rounded-xl border border-gray-200 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-gray-100",children:[(0,t.jsx)("span",{className:"text-2xl",children:B.emoji}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-gray-700",children:[p.length," người"]})]}),p.length>0?(0,t.jsx)("ul",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:p.map((r,s)=>(0,t.jsx)("li",{className:"text-sm text-gray-700 py-1 hover:text-blue-600 transition-colors",children:r},`${e._id}-user-filegroup-${s}`))}):(0,t.jsx)("div",{className:"text-sm text-gray-500 py-1",children:"Chưa có ai"})]}))})]}),N&&(0,t.jsx)("div",{className:`text-xs mt-2 block ${y?"text-gray-700":"text-gray-500"} flex items-center gap-2`,children:(0,t.jsx)("span",{children:er(Number(b.serverTimestamp??b.timestamp)||0)})})]}),(0,t.jsx)(e_,{message:b,isGroup:d,isRecalled:!!b.isRecalled,isMine:y,isLast:v,myId:eU,allUsersMap:l,getSenderInfo:f,isMobile:E,isUploading:S})]})]},`group-file-${e._id}`)]},`group-file-${e._id}-frag`)}}if("notify"===e.type){let a=!!e.callType,l=(e.content||"").toLowerCase(),o=l.includes("đến giờ lịch hẹn")||l.includes("đã tạo lịch hẹn");if(!a&&!o){let r=D>0?k[D-1]:null,s=r?.type==="notify",n=s&&!!r.callType,i=(r?.content||"").toLowerCase(),a=s&&(i.includes("đến giờ lịch hẹn")||i.includes("đã tạo lịch hẹn"));if(!s||n||a){let r=[e];for(let e=D+1;e<k.length;e++){let t=k[e];if("notify"!==t.type)break;let s=!!t.callType,n=(t.content||"").toLowerCase(),i=n.includes("đến giờ lịch hẹn")||n.includes("đã tạo lịch hẹn");if(s||i)break;r.push(t)}if(r.length>=3){let s=e._id;if(!Z.has(s))return r.slice(1).forEach(e=>M.add(e._id)),(0,t.jsx)("div",{className:"flex justify-center my-4",children:(0,t.jsx)("button",{onClick:()=>{let e=new Set(Z);e.add(s),ee(e)},className:"px-4 py-1.5 bg-white text-xs font-medium text-blue-600 rounded-full shadow-sm border border-blue-100 hover:bg-blue-50 transition-all cursor-pointer",children:"Xem cập nhật trước"})},`group-notify-${s}`)}}}if(e.callType){let s=D>0?k[D-1]:null;if(!(s?.type==="notify"&&s.callType)){let r=[e];for(let e=D+1;e<k.length;e++){let t=k[e];if("notify"!==t.type||!t.callType)break;r.push(t)}if(r.length>=3){let s=e._id;if(!Z.has(s))return r.slice(1).forEach(e=>M.add(e._id)),(0,t.jsx)("div",{className:"flex justify-center my-4",children:(0,t.jsx)("button",{onClick:()=>{let e=new Set(Z);e.add(s),ee(e)},className:"px-4 py-1.5 bg-white text-xs font-medium text-blue-600 rounded-full shadow-sm border border-blue-100 hover:bg-blue-50 transition-all cursor-pointer",children:"Xem thông báo cuộc gọi trước"})},`group-notify-call-${s}`)}}let i="video"===e.callType?"video":"voice",a=e.calleeId||"",l=e.callStatus||"answered",o=Number(e.callDurationSec||0),d=String(n._id)===String(a),m="video"===i?"rejected"===l||"timeout"===l?(0,t.jsx)(x.HiVideoCamera,{className:"w-4 h-4 text-red-600"}):(0,t.jsx)(x.HiVideoCamera,{className:"w-4 h-4 text-blue-600"}):"rejected"===l||"timeout"===l?(0,t.jsx)(x.HiPhone,{className:"w-4 h-4 text-red-600"}):(0,t.jsx)(x.HiPhone,{className:"w-4 h-4 text-green-600"}),u=d?(0,t.jsx)(x.HiArrowDown,{className:"w-4 h-4 text-gray-600"}):(0,t.jsx)(x.HiArrowUp,{className:"w-4 h-4 text-gray-600"}),h=`Cuộc gọi ${"video"===i?"video":"thoại"} ${d?"đến":"đi"}`,g="answered"===l?`${Math.floor(o/60)} ph\xfat ${Math.floor(o%60)} gi\xe2y`:"rejected"===l?"Bị từ chối":d?"Nhỡ":"Không phản hồi",p=new Date(e.timestamp),f=new Date,b=new Date;b.setDate(f.getDate()-1);let y=(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),v=y(p,f)?"Hôm nay":y(p,b)?"Hôm qua":p.toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"}),w=p.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});return(0,t.jsxs)(r.default.Fragment,{children:[null,ez,(0,t.jsx)("div",{id:`msg-${e._id}`,"data-message-id":e._id,className:"flex justify-center my-3",children:(0,t.jsx)("div",{className:`px-4 p-1.5  bg-white rounded-full max-w-[80vw]  sm:max-w-[28rem] overflow-hidden ${c===e._id?"bg-yellow-50":"bg-gray-100"}`,children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[m,u,(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:`${h} – ${g}`}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:` ${v} • ${w}`})]})]})})},e._id)]},`notify-call-${e._id}-frag`)}let d=e.replyToMessageId?s.find(t=>t._id===e.replyToMessageId):null,m=e.content||"",u=m.trim().toLowerCase(),h=u.includes("tham gia nhóm"),g=m;if(!h&&ej){let e=n.name||"";!g.trim().toLowerCase().startsWith("bạn")&&e&&g.startsWith(e)?g="Bạn"+g.slice(e.length):g.startsWith("Một thành viên")&&(g="Bạn"+g.slice(14))}let p=g.toLowerCase(),f=p.includes("đã tạo lịch hẹn"),b=p.includes("đến giờ lịch hẹn"),y=p.includes("đã chỉnh sửa")||p.includes("chỉnh sửa"),v=p.includes("đã xóa")||p.includes("xóa"),w=d?.type==="poll"||p.includes("bình chọn"),j=p.includes("ghim"),N=p.includes("đã thêm")||p.includes("mời")&&p.includes("vào nhóm"),S=p.includes("đã rời nhóm"),C=p.includes("bổ nhiệm")||p.includes("phó nhóm"),_=p.includes("hủy quyền phó nhóm")||p.includes("bãi nhiệm"),T=p.includes("ra khỏi nhóm")||p.includes("xóa khỏi nhóm"),A=p.includes("tạo nhóm"),$=p.includes("đổi tên nhóm")||p.includes("đã đổi tên nhóm"),L=p.includes("biệt danh"),P=p.includes("ảnh đại diện")||p.includes("đổi ảnh"),H=b?(0,t.jsx)(x.HiOutlineClock,{className:"w-4 h-4 text-red-500"}):f?(0,t.jsx)(x.HiOutlineClock,{className:"w-4 h-4 text-indigo-500"}):w?(0,t.jsx)(x.HiChartBar,{className:"w-4 h-4 text-blue-500"}):j?(0,t.jsx)(x.HiMapPin,{className:"w-4 h-4 text-orange-500"}):$?(0,t.jsx)(x.HiPencil,{className:"w-4 h-4 text-indigo-600"}):L?(0,t.jsx)(x.HiPencil,{className:"w-4 h-4 text-blue-600"}):P?(0,t.jsx)(x.HiPhoto,{className:"w-4 h-4 text-pink-600"}):N?(0,t.jsx)(x.HiUserPlus,{className:"w-4 h-4 text-emerald-600"}):S?(0,t.jsx)(i.HiOutlineLogout,{className:"w-4 h-4 text-red-600"}):C?(0,t.jsx)(x.HiShieldCheck,{className:"w-4 h-4 text-blue-600"}):_?(0,t.jsx)(x.HiUserMinus,{className:"w-4 h-4 text-yellow-600"}):T?(0,t.jsx)(x.HiUserMinus,{className:"w-4 h-4 text-red-600"}):A?(0,t.jsx)(x.HiUserGroup,{className:"w-4 h-4 text-purple-600"}):null,U=ew.name||"",R=(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:g});if(h){let e=String(ew._id)===String(n._id)&&n.name||U,r=u.indexOf("đã tham gia nhóm"),s=r>-1?m.slice(r):"đã tham gia nhóm qua link mời";R=(0,t.jsxs)("span",{className:"text-xs text-gray-500 truncate",children:[(0,t.jsx)("a",{href:`/profile/${ew._id}`,className:"text-blue-600 hover:underline",children:e||"Một thành viên"}),` ${s}`]})}let B=(0,t.jsxs)(r.default.Fragment,{children:[null,ez,(0,t.jsx)("div",{id:`msg-${e._id}`,className:`flex justify-center mt-3 ${ev?"mb-4":"mb-3"}`,children:(0,t.jsx)("div",{className:`px-4 p-1.5  bg-white rounded-full max-w-[80vw]  sm:max-w-[28rem] overflow-hidden ${c===e._id?"bg-yellow-50":"bg-gray-100"}`,children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[H,R]})})},`pill-${e._id}`)]},`pill-${e._id}-frag`);if(b){if(d?.type==="reminder")return(0,t.jsxs)(r.default.Fragment,{children:[B,(0,t.jsx)("div",{className:`flex justify-center -mt-2 ${ev?"mb-4":""}`,children:(0,t.jsx)(eM,{variant:"due",title:d.content||"",date:new Date(d.reminderAt||d.timestamp),onOpen:()=>{E||I?.("reminder"),O(d)}})})]},`notify-${e._id}-due`);let s=e.reminderAt,n=e.reminderContent||e.content||"",i=e.reminderNote,a={_id:e.replyToMessageId||String(e._id),roomId:String(e.roomId||""),sender:e.sender,content:n,type:"reminder",timestamp:Number(e.timestamp)||Date.now(),reminderAt:"number"==typeof s?s:void 0,reminderNote:i,reminderRepeat:e.reminderRepeat};return(0,t.jsxs)(r.default.Fragment,{children:[B,(0,t.jsx)("div",{className:`flex justify-center -mt-2 ${ev?"mb-4":""}`,children:(0,t.jsx)(eM,{variant:"due",title:n||"",date:new Date("number"==typeof s&&s?s:Number(e.timestamp)||Date.now()),onOpen:()=>{E||I?.("reminder"),O(a)}})})]},`notify-${e._id}-due-inline`)}if(d?.type==="reminder"&&f)return(0,t.jsx)("div",{className:"flex justify-center my-4",children:(0,t.jsx)(eM,{variant:"create",title:d.content||"",date:new Date(d.reminderAt||d.timestamp),senderName:ew.name,senderAvatar:ew.avatar,isMe:ej})},`notify-${e._id}-create`);if(d?.type==="reminder"&&(y||v))return(0,t.jsxs)(r.default.Fragment,{children:[B,(0,t.jsx)("div",{className:"flex justify-center -mt-2",children:(0,t.jsx)("button",{onClick:()=>O(d),className:"z-10 -mt-1 px-5 py-1.5 bg-white text-blue-600 text-xs font-bold rounded-full border border-blue-100 shadow-sm hover:bg-blue-50 transition-all uppercase tracking-wide cursor-pointer",children:"XEM CHI TIẾT"})})]},`notify-${e._id}-reminder`);if(f||y||v){let s=e.reminderAt,n=e.reminderContent||"",i=e.reminderNote;if("number"==typeof s&&n){let a={_id:e.replyToMessageId||String(e._id),roomId:String(e.roomId||""),sender:e.sender,content:n,type:"reminder",timestamp:Number(e.timestamp)||Date.now(),reminderAt:s,reminderNote:i,reminderRepeat:e.reminderRepeat};return f?(0,t.jsx)("div",{className:"flex justify-center my-4",children:(0,t.jsx)(eM,{variant:"create",title:n||"",date:new Date(s),senderName:ew.name,senderAvatar:ew.avatar,isMe:ej})},`notify-${e._id}-create-inline`):(0,t.jsxs)(r.default.Fragment,{children:[B,(0,t.jsx)("div",{className:`flex justify-center -mt-2 ${ev?"mb-4":""}`,children:(0,t.jsx)("button",{onClick:()=>O(a),className:"z-10 -mt-1 px-5 py-1.5 bg-white text-blue-600 text-xs font-bold rounded-full border border-blue-100 shadow-sm hover:bg-blue-50 transition-all uppercase tracking-wide cursor-pointer",children:"XEM CHI TIẾT"})})]},`notify-${e._id}-reminder-inline`)}}return d?.type==="poll"?(0,t.jsxs)(r.default.Fragment,{children:[B,(0,t.jsx)("div",{className:"flex justify-center -mt-2 mb-2",children:(0,t.jsx)("button",{onClick:()=>{E||I?.("poll"),O(d)},className:"text-xs text-blue-600 hover:underline hover:cursor-pointer",children:"Xem"})})]},`notify-${e._id}-poll`):B}if("reminder"===e.type)return(0,t.jsxs)(r.default.Fragment,{children:[ez,(0,t.jsx)("div",{id:`msg-${e._id}`,className:"flex justify-center mt-4",children:(0,t.jsx)("div",{onClick:()=>O(e),children:(0,t.jsx)(eM,{variant:"message",title:e.content||"",date:new Date(e.reminderAt||e.timestamp),senderName:ew.name,senderAvatar:ew.avatar,isMe:ej,highlighted:c===e._id})})},e._id)]},`reminder-${e._id}-frag`);if("poll"===e.type){let s,i,a,l,o,d,m=String(n._id),u=Array.isArray(e.pollOptions)?e.pollOptions:[],h=e.pollVotes||{},g=!!e.isPollLocked;return(0,t.jsxs)(r.default.Fragment,{children:[ez,(0,t.jsx)("div",{id:`msg-${e._id}`,className:`flex justify-center mt-3 ${ev?"mb-4":"mb-3"}`,children:(0,t.jsxs)("div",{className:`w-full max-w-[18rem] p-3 rounded-2xl border shadow-sm ${c===e._id?"bg-yellow-50 border-yellow-300":"bg-white border-gray-200"}`,onClick:()=>O(e),children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("div",{className:"flex items-center gap-2 min-w-0",children:(0,t.jsx)("p",{className:"text-base font-semibold text-gray-900 break-words truncate",children:e.content||e.pollQuestion||"Bình chọn"})}),(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),C?.(e)},className:"px-2 py-1 text-xs font-semibold rounded-lg    border-blue-200 text-blue-600 hover:bg-blue-50 hover:cursor-pointer",children:e.isPinned?"Bỏ ghim":"Ghim"})})]}),g&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:["Kết thúc lúc"," ",new Date(e.pollLockedAt||e.editedAt||e.timestamp).toLocaleString("vi-VN")]}),(0,t.jsxs)("div",{className:"flex flex-col gap-0.5 mt-1",children:[(0,t.jsx)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:e.pollAllowMultiple?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiListBullet,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn nhiều phương án"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiCheckCircle,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Chọn 1 phương án"})]})}),e.pollHideVoters&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiEyeSlash,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn người bình chọn"})]}),e.pollAllowAddOptions&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiPlus,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Cho phép thêm phương án"})]}),e.pollHideResultsUntilVote&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-xs text-gray-500",children:[(0,t.jsx)(x.HiLockClosed,{className:"w-3.5 h-3.5 flex-shrink-0"}),(0,t.jsx)("span",{children:"Ẩn kết quả khi chưa bình chọn"})]})]}),(0,t.jsx)("button",{onClick:()=>O(e),className:"text-xs text-blue-600 hover:underline mt-1",children:(s=new Set,i=0,a=!1,((e.pollOptions||[]).forEach(e=>{let t=Array.isArray(h[e])?h[e]:[];i+=t.length,t.forEach(e=>s.add(String(e))),t.includes(m)&&(a=!0)}),e.pollHideResultsUntilVote&&!a)?"Bình chọn để xem kết quả":e.pollHideVoters?`${i} lượt b\xecnh chọn`:`${s.size} người b\xecnh chọn, ${i} lượt b\xecnh chọn`)}),(0,t.jsx)("div",{className:"mt-3 space-y-2",children:(l=u.reduce((e,t)=>e+(Array.isArray(h[t])?h[t]:[]).length,0),o=u.some(e=>(Array.isArray(h[e])?h[e]:[]).includes(m)),d=!(e.pollHideResultsUntilVote&&!o),u.map((r,s)=>{let n=Array.isArray(h[r])?h[r]:[],i=n.length,a=(n.includes(m),d&&l>0?i/l*100:0);return(0,t.jsxs)("button",{onClick:t=>{t.stopPropagation(),E||I?.("poll"),O(e)},className:`w-full cursor-pointer bg-gray-100  relative overflow-hidden px-2 py-1 rounded-[5px]  text-left transition-colors
                                   
                                  `,children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 bottom-0 transition-all duration-500 ease-out bg-blue-200",style:{width:`${a}%`}}),(0,t.jsxs)("div",{className:"flex items-center justify-between  relative z-10",children:[(0,t.jsx)("span",{className:"truncate text-[12px]",children:r}),(0,t.jsx)("span",{className:"text-sm",children:d?i:""})]})]},`${String(e._id)}-${s}`)}))}),(0,t.jsx)("div",{className:"pt-2",children:(0,t.jsx)("button",{onClick:()=>{E||I?.("poll"),O(e)},className:"w-full cursor-pointer px-2 py-1 mt-1 text-blue-600 border border-blue-300 rounded-xl hover:bg-blue-50 font-semibold text-sm",children:g?"Xem lựa chọn":"Đổi lựa chọn"})})]})},e._id)]},`poll-${e._id}-frag`)}let eW=l.get(ew._id)||ew.name;return(0,t.jsxs)(r.default.Fragment,{children:[null,ez,(0,t.jsxs)("div",{id:`msg-${e._id}`,onContextMenu:t=>{t.preventDefault(),m(t,e)},className:`
                  w-full sm:max-w-[36rem] lg:max-w-[46rem]
                  flex gap-2 group relative
                  ${ej?"ml-auto flex-row-reverse":"mr-auto flex-row"}
                  mt-2
                  ${ev?"mb-8":""}
                  ${c===e._id?"bg-yellow-50 rounded-xl":""}
                `,children:[!ej&&(0,t.jsx)("div",{className:`${eO?"opacity-0":""} flex-shrink-0`,children:ew.avatar?(0,t.jsx)("div",{className:"w-9 h-9 rounded-full overflow-hidden flex-shrink-0",children:(0,t.jsx)(a.default,{width:38,height:38,src:(0,h.getProxyUrl)(ew.avatar),alt:ew.name,className:"w-full h-full object-cover"})}):(0,t.jsx)("div",{className:"w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold",children:(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:ew.name||"User",width:38,height:38,className:"w-full h-full rounded-full object-cover"})})}),(0,t.jsxs)("div",{className:`flex flex-col min-w-0 ${ej?"items-end":"items-start"}`,children:[e$&&!eI&&(0,t.jsx)("span",{className:"text-[10px] px-1 text-blue-500 hover:underline hover:cursor-pointer",onClick:()=>H(t=>t===e._id?null:e._id),children:P===e._id?(0,t.jsx)("p",{children:"Ẩn chỉnh sửa"}):(0,t.jsx)("p",{children:"Đã chỉnh sửa"})}),eN&&(el=String(eN.fileUrl||eN.previewUrl||""),eo="video"===eN.type||(0,h.isVideoFile)(eN.fileName)||(0,h.isVideoFile)(el),ec="image"===eN.type||/\.(jpg|jpeg|png|gif|webp|bmp|svg|avif)$/i.test(String(eN.fileName||el||"")),ed=eN.isRecalled?"Tin nhắn đã bị thu hồi":"file"===eN.type?eN.fileName||"[File]":"image"===eN.type?"[Ảnh]":"video"===eN.type?"[Video]":"sticker"===eN.type?"[Sticker]":"reminder"===eN.type?eN.content||"[Nhắc nhở]":eN.content||"Tin nhắn",(0,t.jsxs)("div",{onClick:()=>p(eN._id),className:"max-w-[88vw] sm:max-w-[26rem] lg:max-w-[34rem] px-3 py-2 mb-1 mt-2 text-xs bg-gray-100 border-l-2 border-blue-500 rounded-xl cursor-pointer",children:[(0,t.jsx)("p",{className:"font-semibold text-blue-600",children:e.replyToMessageName||eW}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[!eN.isRecalled&&(ec||eo)&&(ec?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(el),alt:"Ảnh",width:40,height:40,className:"w-10 h-10 rounded-md object-cover border border-blue-200",unoptimized:String(el).includes("mega.nz")}):(0,t.jsxs)("div",{className:"relative w-10 h-10 bg-black rounded-md overflow-hidden border border-blue-200",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(el),className:"w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,t.jsx)("div",{className:"w-5 h-5 rounded-full bg-white/80 flex items-center justify-center",children:(0,t.jsx)("svg",{viewBox:"0 0 24 24",className:"w-3.5 h-3.5 text-gray-800",children:(0,t.jsx)("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})})})]})),(0,t.jsx)("p",{className:"truncate text-gray-600",children:ed})]})]})),(0,t.jsxs)("div",{className:`  
                  px-4 py-2 rounded-lg shadow-md max-w-[70vw] ${!eI&&"text"===e.type&&A&&!E?"sm:max-w-[26rem] lg:max-w-[32rem]":"sm:max-w-[34rem] lg:max-w-[38rem]"} break-words mt-1
                  ${!eI&&(eL||"sticker"===e.type||"file"===e.type||"image"===e.type)?"!bg-transparent shadow-none":ej?"bg-blue-100 text-white":"bg-white text-gray-800 "}
                      ${!eO&&ej?"rounded-tr-md":""}
                      ${!eO&&!ej?"rounded-tl-md":""}
                      ${eI?"!bg-gray-200 !text-gray-500 italic !px-4 !py-2 !max-w-[92vw] sm:!max-w-[34rem] lg:!max-w-[44rem]":""}
                      ${!eI&&(eL||"sticker"===e.type||"file"===e.type||"image"===e.type)?"!p-0 !shadow-none ":""}
                    ${!eI&&"image"===e.type?"!p-0":""}
                    ${!eI&&"file"===e.type?"!p-0":""}
                  relative ${eR?"mb-4":""}
                  ${T?.visible&&String(T.message._id)===String(e._id)?"z-[9998]":""}
                  ${Q===e._id?"ring-2 ring-blue-300 scale-[0.98]":""}
                  `,style:E&&K.id===e._id?{transform:`translateX(${Math.max(-100,Math.min(100,K.dx))}px)`}:void 0,onClick:()=>{L(t=>t===e._id?null:e._id),R(e._id),F(null)},onTouchStart:t=>{try{if(eI)return;G.current=!1,null!=V.current&&(clearTimeout(V.current),V.current=null);let r=t.touches&&t.touches[0],s=r?r.clientX:0,n=r?r.clientY:0,i=t.currentTarget;et.current={x:s,y:n,id:e._id,isMe:ej},q({id:null,dx:0}),Y(e._id),V.current=window.setTimeout(()=>{G.current=!0,R(e._id),F(null),E&&"text"===e.type&&X(e._id),u?.(e,i,s,n)},420)}catch{}},onTouchEnd:t=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),G.current&&(t.preventDefault(),t.stopPropagation()),E&&et.current.id===e._id&&((et.current.isMe?K.dx<-64:K.dx>64)&&g?.(e),q({id:null,dx:0}),et.current={x:0,y:0,id:null,isMe:!1})}catch{}},onTouchMove:t=>{try{if(null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),!E)return;let r=t.touches&&t.touches[0],s=r?r.clientX:0,n=r?r.clientY:0,i=s-et.current.x,a=n-et.current.y;if(et.current.id===e._id&&Math.abs(i)>8&&24>Math.abs(a)){let r=et.current.isMe?i<0:i>0;q({id:e._id,dx:r?i:0}),t.preventDefault()}}catch{}},onTouchCancel:()=>{try{null!=V.current&&(clearTimeout(V.current),V.current=null),Y(null),E&&et.current.id===e._id&&(q({id:null,dx:0}),et.current={x:0,y:0,id:null,isMe:!1})}catch{}},children:[!eI&&(0,t.jsxs)(t.Fragment,{children:[("image"===e.type||"video"===e.type)&&(0,t.jsx)("button",{onClick:t=>{t.preventDefault(),$(e)},className:`absolute top-1/2 -translate-y-1/2  cursor-pointer p-1.5 bg-white/90 rounded-full shadow hover:bg-blue-50 ${ej?"right-full mr-2":"left-full ml-2"} opacity-100 pointer-events-auto`,"aria-label":"Chia sẻ",title:"Chia sẻ",children:(0,t.jsx)(ek,{className:"w-4 h-4 text-indigo-600"})}),E&&K.id===e._id&&(0,t.jsx)("div",{className:`absolute top-1/2 -translate-y-1/2 ${ej?"left-full ml-2":"right-full mr-2"}`,style:{opacity:Math.min(Math.abs(K.dx)/64,1)},children:(0,t.jsx)("div",{className:"p-2 bg-white rounded-full shadow border border-gray-200",children:ej?(0,t.jsx)(x.HiArrowUturnLeft,{className:"w-5 h-5 text-blue-600"}):(0,t.jsx)(x.HiArrowUturnRight,{className:"w-5 h-5 text-blue-600"})})}),!E&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onClick:t=>{t.preventDefault(),m(t,e)},className:`absolute top-1/2 -translate-y-1/2 z-10 cursor-pointer p-1.5 bg-white/90 rounded-full shadow hover:bg-blue-50 ${ej?"right-full mr-10":"left-full ml-10"} opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto`,"aria-label":"Mở menu",title:"Thêm",children:(0,t.jsx)(x.HiEllipsisVertical,{className:"w-4 h-4 text-gray-600"})}),(0,t.jsx)(eS.default,{isMine:ej,visible:U===e._id,onPick:t=>{_?.(e,t),R(null)},className:`absolute top-1/2 -translate-y-1/2  ${ej?"right-full mr-18":"left-full ml-18"} ${U===e._id?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto"} transition-opacity duration-200`})]})]}),!eI&&(0,t.jsxs)(t.Fragment,{children:[0===(em=Object.entries(eH).map(([e,t])=>({emoji:e,count:(t||[]).length,mine:(t||[]).includes(eU),users:(t||[]).map(e=>l.get(String(e))||"Người dùng")})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count)).length?null:(0,t.jsxs)("div",{className:`
                                  absolute ${ej?"right-2 -mr-1":"left-2 -ml-1"} 
                                  -bottom-4 
                                  flex items-center gap-1
                                `,children:[(0,t.jsxs)("div",{className:"flex items-center",children:[em.slice(0,3).map((r,s)=>(0,t.jsxs)("div",{onClick:t=>{t.stopPropagation(),F(B?.msgId===e._id&&B?.emoji===r.emoji?null:{msgId:e._id,emoji:r.emoji})},className:`
                                          flex items-center gap-0.5 py-0.5 rounded-full text-sm cursor-pointer
                                          transition-all duration-200 hover:bg-gray-100 active:scale-95
                                          ${r.mine?"bg-blue-50":"bg-transparent"}
                                        `,title:`${r.count} người`,children:[(0,t.jsx)("span",{className:"text-lg leading-none",children:r.emoji}),r.count>1&&(0,t.jsx)("span",{className:`text-xs font-medium ${r.mine?"text-blue-600":"text-gray-600"}`,children:r.count})]},`${e._id}-react-${s}`)),em.length>3&&(0,t.jsxs)("div",{className:"px-2 text-xs text-gray-500 font-medium",children:["+",em.length-3]})]}),(0,t.jsx)("div",{className:"absolute inset-0 -z-10 bg-white/60 backdrop-blur-sm rounded-full scale-0 group-hover:scale-100 transition-transform duration-300"})]}),B&&B.msgId===e._id&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-30",onClick:()=>F(null)}),(0,t.jsx)("div",{ref:t=>{if(t&&B.msgId===e._id){let e=t.parentElement?.getBoundingClientRect();if(e){let r=window.innerHeight-e.bottom,s=e.top;r<250&&s>r?(t.style.bottom="100%",t.style.top="auto",t.style.marginBottom="0.625rem",t.style.marginTop="0"):(t.style.top="100%",t.style.bottom="auto",t.style.marginTop="0.625rem",t.style.marginBottom="0")}}},className:`
                                    absolute ${ej?"right-2":"left-2"} 
                                    z-40
                                  `,children:(eu=(eH[B.emoji]||[]).map(e=>l.get(String(e))||String(e)),(0,t.jsxs)("div",{className:"min-w-[11.25rem] max-w-[15rem] px-3 py-2.5 bg-white rounded-xl border border-gray-200 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-gray-100",children:[(0,t.jsx)("span",{className:"text-2xl",children:B.emoji}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-gray-700",children:[eu.length," người"]})]}),eu.length>0?(0,t.jsx)("ul",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:eu.map((r,s)=>(0,t.jsx)("li",{className:"text-sm text-gray-700 py-1 hover:text-blue-600 transition-colors",children:r},`${e._id}-user-${s}`))}):(0,t.jsx)("div",{className:"text-sm text-gray-500 py-1",children:"Chưa có ai"})]}))})]})]}),d&&!eO&&!eI&&!ej&&(0,t.jsx)("p",{className:`text-sm inline-block  ${"image"===e.type||"video"===e.type||"file"===e.type?" px-2 py-1 bg-white rounded-[2rem] mb-1":"py-1"} text-gray-600`,children:eW}),"text"===e.type&&!eI&&!eE&&(0,t.jsxs)("div",{className:`relative text-[0.875rem] ${A&&!E?"md:text-[0.875rem]":"md:text-[1rem]"} leading-relaxed text-black whitespace-pre-wrap select-none lg:select-text`,style:E&&T?.visible&&String(T.message._id)===String(e._id)&&W===e._id?{maxHeight:"calc(var(--vvh) * 0.42)",overflow:"hidden"}:void 0,children:[b(e.content||"",e.mentions,ej),E&&T?.visible&&String(T.message._id)===String(e._id)&&W===e._id&&(0,t.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 h-16 flex items-end justify-center pointer-events-none",children:[(0,t.jsx)("div",{className:"absolute inset-x-0 bottom-8 h-16 bg-gradient-to-t from-white/95 to-transparent"}),(0,t.jsx)("button",{onClick:()=>{X(null);try{document.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0}))}catch{}},className:"pointer-events-auto mb-2 px-3 py-1 rounded-full bg-white/90 border border-gray-200 text-sm text-blue-600 shadow hover:bg-blue-50 active:scale-95",children:"Xem thêm"})]}),(()=>{let r=(e.content||"").match(/(https?:\/\/|www\.)\S+/i);if(!r)return null;let s=r[0],n=s.startsWith("http")?s:`https://${s}`,a=(()=>{try{return new URL(n).hostname.replace("www.","")}catch{return"Website"}})();return(0,t.jsx)("div",{className:`mt-2 rounded-xl border ${ej?"border-white/30":"border-gray-200"} bg-white overflow-hidden`,children:(0,t.jsxs)("button",{onClick:()=>window.open(n,"_blank"),className:"w-full text-left p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50",children:[(0,t.jsx)("div",{className:"p-2.5 rounded-xl bg-gradient-to-br from-sky-500 via-blue-500 to-blue-500 text-white",children:(0,t.jsx)(i.HiLink,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-purple-600 truncate",children:s}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-0.5",children:a})]})]})})})()]}),"text"===e.type&&!eI&&eE&&(0,t.jsxs)("div",{className:"text-sm leading-relaxed",children:[(0,t.jsx)("textarea",{value:"string"==typeof j?j:e.content||"",onChange:e=>N?.(e.target.value),className:"w-full p-2 rounded-xl border  text-gray-800",rows:3}),(0,t.jsxs)("div",{className:`mt-2 flex gap-2 ${ej?"justify-end":"justify-start"}`,children:[(0,t.jsx)("button",{onClick:()=>{w?.(null),N?.("")},className:"px-3 py-1.5 cursor-pointer rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 hover:cursor-pointer",children:"Hủy"}),(0,t.jsx)("button",{onClick:()=>{let t="string"==typeof j?j:e.content||"";S?.(e._id,t)},className:"px-3 py-1.5 cursor-pointer rounded-lg bg-blue-500 text-white hover:bg-blue-600 hover:cursor-pointer",children:"Lưu"})]})]}),"image"===e.type&&e.fileUrl&&!eI&&(0,t.jsxs)("div",{className:"  rounded-[0.25rem] overflow-hidden cursor-pointer shadow-md max-w-[50vw] sm:max-w-[10rem] select-none lg:select-auto",onClick:()=>!eP&&y(String(e.fileUrl),"image"),style:{WebkitTouchCallout:"none"},children:[String(e.fileUrl).startsWith("blob:")?(0,t.jsx)(a.default,{width:600,height:600,src:String(e.fileUrl),alt:"Ảnh",className:"w-full h-full object-cover",draggable:!1}):(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.fileUrl),alt:"Ảnh",width:600,height:600,className:"w-full h-full object-cover",unoptimized:String(e.fileUrl).includes("mega.nz"),draggable:!1}),eP&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/70 flex items-center justify-center",children:(eh=2*Math.PI*18,ex=Math.max(0,Math.min(100,Number(eC||0))),(0,t.jsx)("div",{className:"flex flex-col items-center",children:(0,t.jsxs)("svg",{width:40,height:40,viewBox:"0 0 40 40",children:[(0,t.jsx)("circle",{cx:20,cy:20,r:18,stroke:"rgba(255,255,255,0.3)",strokeWidth:4,fill:"none"}),(0,t.jsx)("circle",{cx:20,cy:20,r:18,stroke:"white",strokeWidth:4,fill:"none",strokeDasharray:eh,strokeDashoffset:eh-ex/100*eh,strokeLinecap:"round",transform:"rotate(-90 20 20)"})]})}))})]}),"image"===e.type&&!eI&&e.content&&(0,t.jsx)("div",{className:"mt-2 text-sm leading-relaxed px-2 text-gray-700",children:b(e.content||"",e.mentions,ej)}),eL&&e.fileUrl&&!eI&&(0,t.jsxs)("div",{className:"relative rounded-[0.25rem] overflow-hidden cursor-pointer shadow-lg max-w-[70vw] sm:max-w-[18rem] aspect-video bg-black select-none lg:select-auto",onClick:()=>!eP&&y(String(e.fileUrl),"video"),style:{WebkitTouchCallout:"none"},children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(e.fileUrl),className:"w-full h-full object-cover m-[0.125rem]",playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-12 h-12 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(x.HiPlay,{className:"w-7 h-7 text-blue-600 ml-1"})})}),eP&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center text-white",children:void 0!==eC?(0,t.jsxs)(t.Fragment,{children:[Math.round(eC),"%"]}):(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-white/60 border-t-transparent rounded-full animate-spin"})})]}),eL&&!eI&&e.content&&(0,t.jsx)("div",{className:"px-2 mt-2 text-sm leading-relaxed text-gray-700",children:b(e.content||"",e.mentions,ej)}),"file"===e.type&&e.fileUrl&&!eL&&!eI&&(0,t.jsxs)("a",{href:(0,h.getProxyUrl)(e.fileUrl,!0),download:e.fileName||"download",target:"_blank",rel:"noreferrer",className:"relative flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-2xl max-w-[70vw] sm:max-w-[18rem] shadow-sm hover:bg-gray-50 select-none lg:select-text",onClick:e=>{eP&&e.preventDefault()},"aria-disabled":!!eP||void 0,draggable:!1,style:{WebkitTouchCallout:"none"},children:[(0,t.jsx)("div",{className:"p-2 bg-blue-600 rounded-xl",children:(0,t.jsx)(x.HiOutlineDocumentText,{className:"w-6 h-6 text-white"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate",children:e.fileName||"Tệp đính kèm"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:"Nhấn để tải xuống"})]}),eP&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/60 text-white flex items-center justify-center rounded-2xl",children:(eg=2*Math.PI*14.5,ep=Math.max(0,Math.min(100,Number(eC||0))),(0,t.jsxs)("div",{className:"flex flex-col items-center",children:[(0,t.jsxs)("svg",{width:32,height:32,viewBox:"0 0 32 32",children:[(0,t.jsx)("circle",{cx:16,cy:16,r:14.5,stroke:"rgba(255,255,255,0.35)",strokeWidth:3,fill:"none"}),(0,t.jsx)("circle",{cx:16,cy:16,r:14.5,stroke:"white",strokeWidth:3,fill:"none",strokeDasharray:eg,strokeDashoffset:eg-ep/100*eg,strokeLinecap:"round",transform:"rotate(-90 16 16)"})]}),(0,t.jsxs)("span",{className:"text-xs font-semibold mt-1",children:[Math.round(ep),"%"]})]}))})]}),"file"===e.type&&!eI&&e.content&&(0,t.jsx)("div",{className:"mt-2 text-sm leading-relaxed px-2 text-gray-700",children:b(e.content||"",e.mentions,ej)}),eI&&(0,t.jsx)("p",{className:"text-sm italic opacity-70",children:"đã thu hồi tin nhắn"}),e$&&!eI&&e.originalContent&&(0,t.jsx)("div",{className:" border-gray-300 ",children:P===e._id&&(0,t.jsx)("div",{className:"text-xs border-t-[1px] border-t-gray-300  text-gray-500 space-y-1 flex items-center justify-between",children:(0,t.jsx)("p",{className:`p-1 m-1 whitespace-pre-wrap pt-2 pb-1 rounded w-full ${ej?"bg-white":""}`,children:e.originalContent})})}),eG&&(0,t.jsx)("div",{className:`text-xs mt-1 ${ej?"text-gray-700":"text-gray-500"}`,children:(0,t.jsx)("span",{className:"text"===e.type?void 0:"inline-block px-2 py-1 bg-white rounded-[2rem]",children:er(Number(e.serverTimestamp??e.timestamp)||0)})})]}),(0,t.jsx)(e_,{message:e,isGroup:d,isRecalled:eI,isMine:ej,isLast:ev,myId:eU,allUsersMap:l,getSenderInfo:f,isMobile:E,isUploading:(ef=void 0!==o[e._id],eb=!!e.isSending,ey="string"==typeof e.fileUrl&&e.fileUrl.startsWith("blob:"),("image"===e.type||"video"===e.type||"file"===e.type&&!eL)&&(ef||eb||ey))})]})]},e._id)]},`${e._id}-frag`)})}))]},e)}),(0,t.jsx)(z,{isOpen:!!D,message:D,onClose:()=>O(null)}),(0,t.jsx)(J,{isOpen:!!D&&"poll"===D.type,message:D&&"poll"===D.type?D:null,onClose:()=>O(null),onRefresh:k})]})}let eE=({children:e,onClick:r,isRed:s=!1,isAnchor:n=!1,href:i="#",download:a=""})=>{let l=`cursor-pointer w-full text-left px-3 py-1 mb-1 hover:bg-gray-100 flex items-center gap-3 ${s?"text-red-500":"text-gray-700"}`;return n?(0,t.jsx)("a",{href:i,download:a,onClick:r,target:"_blank",rel:"noreferrer",className:l,children:e}):(0,t.jsx)("button",{onClick:r,className:l,type:"button",children:e})},e$=({contextMenu:e,currentUserId:r,onClose:s,onPinMessage:n,onRecallMessage:i,setEditingMessageId:a,setEditContent:l,closeContextMenu:o,onReplyMessage:c,onShareMessage:d})=>{var m;if(!e||!e.visible)return null;let{x:u,y:h,message:x,placement:g}=e,p=((m=x.sender)?"string"==typeof m?m:"object"==typeof m&&null!==m&&"_id"in m&&null!=m._id?String(m._id):"object"==typeof m&&null!==m&&"id"in m&&null!=m.id?String(m.id):"":"")===r,f="text"===x.type,b=x.isRecalled,y=f&&!b,v=("image"===x.type||"file"===x.type||"sticker"===x.type)&&x.fileUrl,w=p&&!b,N=!0===x.isPinned,S=p&&f&&!b,k=async e=>{try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0}catch{}try{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();let r=document.execCommand("copy");if(document.body.removeChild(t),r)return!0}catch{}try{let t=document.createElement("input");t.value=e,t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();let r=document.execCommand("copy");if(document.body.removeChild(t),r)return!0}catch{}return!1};return(0,t.jsxs)("div",{"data-context-menu":"true",className:`fixed z-[9999] bg-white space-y-2 rounded-lg shadow-2xl border border-gray-200 py-1 w-[200px] text-sm ${"above"===g?"animate-in fade-in slide-in-from-bottom-2 duration-200":"animate-in fade-in slide-in-from-top-2 duration-200"}`,style:{top:h,left:u},onContextMenu:e=>e.preventDefault(),children:[!b&&c&&(0,t.jsx)(eE,{onClick:e=>{e.stopPropagation(),e.preventDefault(),c(x),s()},children:(0,t.jsxs)("span",{className:"flex items-center gap-4",children:[(0,t.jsx)(j.FaRepeat,{size:24,className:"w-5 h-5"}),(0,t.jsx)("p",{className:"text-[1rem]",children:"Trả lời"})]})}),!b&&(0,t.jsx)(eE,{onClick:e=>{e.stopPropagation(),e.preventDefault(),d(x),s()},children:(0,t.jsxs)("span",{className:"flex gap-4 items-center",children:[(0,t.jsx)(j.FaRegShareFromSquare,{className:"w-5 h-5"}),(0,t.jsx)("p",{className:"text-[1rem]",children:"Chia sẻ"})]})}),y&&(0,t.jsx)(eE,{onClick:async e=>{e.stopPropagation(),e.preventDefault(),await k(x.content||"")||alert("Sao chép thất bại!"),s()},children:(0,t.jsxs)("span",{className:"flex gap-4 items-center",children:[(0,t.jsx)(j.FaCopy,{className:"w-5 h-5 "}),(0,t.jsx)("span",{className:"text-[1rem] ",children:"Sao chép"})]})}),!b&&(0,t.jsx)(eE,{onClick:e=>{e.stopPropagation(),e.preventDefault(),n(x),s()},children:N?(0,t.jsxs)("p",{className:"text-red-500 flex gap-4 items-center",children:[(0,t.jsx)(j.FaPaperclip,{className:"text-red-600 w-5 h-5 "}),(0,t.jsx)("span",{className:"text-[1rem]",children:"Bỏ ghim tin nhắn"})]}):(0,t.jsxs)("p",{className:"flex gap-4 items-center ",children:[(0,t.jsx)(j.FaPaperclip,{className:"w-5 h-5"}),(0,t.jsx)("span",{className:"text-[1rem]",children:"Ghim tin nhắn"})]})}),S&&(0,t.jsx)(eE,{onClick:e=>{e.stopPropagation(),e.preventDefault(),a&&l&&o&&(a(x._id),l(x.content||""),o())},children:(0,t.jsxs)("span",{className:"flex gap-4 items-center",children:[(0,t.jsx)(j.FaRegPenToSquare,{className:"w-5 h-5"}),(0,t.jsx)("span",{className:"text-[1rem]",children:"Chỉnh sửa"})]})}),v&&(0,t.jsx)(eE,{isAnchor:!0,href:x.fileUrl,download:x.fileName||"file_chat",onClick:e=>{e.stopPropagation(),setTimeout(()=>s(),100)},children:(0,t.jsxs)("span",{className:"flex gap-4 items-center",children:[(0,t.jsx)(j.FaDownload,{className:"w-5 h-5"}),(0,t.jsx)("span",{className:"text-[1rem]",children:"Tải xuống"})]})}),w&&(0,t.jsx)(eE,{isRed:!0,onClick:e=>{e.stopPropagation(),e.preventDefault(),i(x._id),s()},children:(0,t.jsxs)("span",{className:"flex gap-4 items-center",children:[(0,t.jsx)(j.FaTrashCan,{className:"w-5 h-5"}),(0,t.jsx)("span",{className:"text-[1rem]",children:"Thu hồi"})]})})]})};var eI=e.i(52773);globalThis.uploadProgressMap=globalThis.uploadProgressMap||new Map;let eL=(e,t)=>{globalThis.uploadProgressMap&&globalThis.uploadProgressMap.set(e,t)},eP=e=>{globalThis.uploadProgressMap?.delete(e)},eH=null,eU=!1,eR=new Map;async function eD(){if(!("serviceWorker"in navigator))return null;eH||(eH=navigator.serviceWorker.register("/sw-upload.js",{scope:"/"}).then(()=>navigator.serviceWorker.ready));let e=await eH.catch(()=>null);return e&&!eU&&(eU=!0,navigator.serviceWorker.addEventListener("message",e=>{let t=e.data;if(!t||!t.type)return;let r=String(t.uploadId||""),s=eR.get(r);s&&("UPLOAD_COMPLETE"===t.type&&t.response?(s.resolve(t.response),eR.delete(r)):"UPLOAD_FAILED"===t.type&&(s.reject(Error(t.message||"Upload failed")),eR.delete(r)))})),e}let eO=(e,t)=>{let r=window.getSelection();if(!r||0===r.rangeCount)return void e.appendChild(document.createTextNode(t));let s=r.getRangeAt(0),n=s.commonAncestorContainer,i=!1;for(;n;){if(n===e){i=!0;break}n=n.parentNode}if(!i)return void e.appendChild(document.createTextNode(t));s.deleteContents();let a=document.createTextNode(t);s.insertNode(a),s.setStartAfter(a),s.collapse(!0),r.removeAllRanges(),r.addRange(s)};var eB=e.i(91416);let eF={src:e.i(67340).default,width:24,height:24,blurWidth:0,blurHeight:0},ez=({isOpen:e,onClose:s,roomId:n,onJumpToMessage:i,getSenderName:l,initialKeyword:o,onKeywordClear:c,initialSelectedMessageId:d})=>{let[m,u]=(0,r.useState)(""),[g,p]=(0,r.useState)([]),[f,b]=(0,r.useState)(!1),[y,v]=(0,r.useState)(-1),w=(0,r.useRef)(null),j=(0,r.useRef)(!1),N=(0,r.useRef)(null),k=(0,r.useRef)(null),[_,T]=(0,r.useState)(""),[M,A]=(0,r.useState)(""),[E,$]=(0,r.useState)(""),[I,L]=(0,r.useState)(null),P=(0,r.useCallback)(async e=>{if(!e.trim()||!n)return void p([]);b(!0);try{let t=(()=>{let e,t;if(M){let t=new Date(`${M}T00:00:00`);Number.isNaN(t.getTime())||(e=t.getTime())}if(E){let e=new Date(`${E}T23:59:59`);Number.isNaN(e.getTime())||(t=e.getTime())}if(void 0!==e||void 0!==t){let r={};return void 0!==e&&(r.$gte=e),void 0!==t&&(r.$lte=t),r}})(),r=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"read",filters:{roomId:n,searchQuery:e.trim(),isRecalled:{$ne:!0},isDeleted:{$ne:!0},type:{$ne:"notify"},...t?{timestamp:t}:{}},limit:500,sort:{field:"timestamp",order:"desc"}})}),s=await r.json(),i=(Array.isArray(s?.data)?s.data:[]).filter(t=>{let r="file"===t.type?String(t.fileName||""):"sticker"===t.type?"":String(t.content||"");return(0,h.accentAwareIncludes)(r,e)}).slice().sort((e,t)=>Number(t.timestamp)-Number(e.timestamp));p(i),v(e=>0===i.length?-1:e)}catch(e){console.error("Fetch search results error:",e),p([])}finally{b(!1)}},[n,i]);(0,r.useEffect)(()=>{let t=(o||"").trim();e&&t&&(N.current===t&&j.current||(u(t),j.current=!0,N.current=t,k.current=d||null,setTimeout(()=>{w.current?.focus()},100),P(t)))},[o,d,e,P]),(0,r.useEffect)(()=>{!e&&(j.current=!1,N.current=null,k.current=null,v(-1),c&&c())},[e,c]),(0,r.useEffect)(()=>{if(o&&m===o&&j.current)return;if(!m.trim()){p([]),v(-1);return}let e=setTimeout(()=>{P(m)},500);return()=>{clearTimeout(e)}},[m,P,o]);let H=(0,r.useMemo)(()=>{let e=new Set,t=[];return g.forEach(r=>{let s="object"==typeof r.sender&&r.sender?String(r.sender._id):String(r.sender||"");if(s&&!e.has(s)){e.add(s);let n=l(r.sender);t.push({id:s,name:n})}}),t.sort((e,t)=>e.name.localeCompare(t.name))},[g,l]),U=(0,r.useMemo)(()=>{let e=M?new Date(M+"T00:00:00").getTime():null,t=E?new Date(E+"T23:59:59").getTime():null;return g.filter(r=>{let s="object"==typeof r.sender&&r.sender?String(r.sender._id):String(r.sender||""),n=!_||s===_,i=Number(r.timestamp||0);return n&&(!e||i>=e)&&(!t||i<=t)})},[g,_,M,E]),R=(0,r.useMemo)(()=>U.slice().sort((e,t)=>Number(t.timestamp)-Number(e.timestamp)),[U]);if((0,r.useMemo)(()=>R.filter(e=>("image"===e.type||"video"===e.type)&&e.fileUrl).map(e=>({url:String(e.fileUrl),type:e.type})),[R]),(0,r.useEffect)(()=>{0===R.length&&v(-1)},[R.length]),!e||window.innerWidth<1024)return null;let D=(e,t)=>{void 0!==t&&v(t),i(e),window.innerWidth<1024?setTimeout(()=>{s()},300):setTimeout(()=>{w.current?.focus()},900)},O=()=>{if(0===R.length)return;let e=y<=0?R.length-1:y-1;v(e),D(R[e]._id,e)},B=()=>{if(0===R.length)return;let e=y>=R.length-1?0:y+1;v(e),D(R[e]._id,e)};return(0,t.jsxs)("div",{className:`bg-white shadow-lg w-full sm:w-[21.875rem] flex flex-col h-full overflow-y-auto relative transition-transform duration-300 transform
        ${e?"translate-x-0":"translate-x-full"}`,children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50",children:[(0,t.jsx)("h2",{className:"text-xl font-bold text-black",children:"Tìm kiếm tin nhắn"}),(0,t.jsx)("button",{onClick:s,className:"cursor-pointer p-2 hover:bg-gray-200 rounded-full",title:"Đóng tìm kiếm",children:(0,t.jsx)(a.default,{src:eF,alt:"Close",width:24,height:24,className:"w-6 h-6 rotate-180"})})]}),(0,t.jsxs)("div",{className:"p-4 border-b border-gray-100 bg-white",children:[(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{type:"text",placeholder:"Nhập từ khóa tìm kiếm...",value:m,onChange:e=>u(e.target.value),onKeyDown:e=>{"Enter"===e.key?P(m):"ArrowUp"===e.key?(e.preventDefault(),O()):"ArrowDown"===e.key&&(e.preventDefault(),B())},className:"flex-1 border-b outline-none p-2  text-sm ",ref:w,autoFocus:!0}),(0,t.jsx)("button",{onClick:()=>P(m),className:"cursor-pointer bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 disabled:bg-blue-300 transition-colors shrink-0",disabled:f||!m.trim(),children:f?(0,t.jsxs)("svg",{className:"animate-spin h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):"Tìm"})]}),(0,t.jsxs)("div",{className:"mt-3 space-y-2 items-center gap-2 ",children:[(0,t.jsxs)("select",{value:_,onChange:e=>T(e.target.value),className:" cursor-pointer text-[1rem] border border-gray-300 rounded-lg px-2 py-1 text-sm flex-1",children:[(0,t.jsx)("option",{value:"",children:"Tất cả"}),H.map(e=>(0,t.jsx)("option",{className:"cursor-pointer ",value:e.id,children:e.name||e.id},e.id))]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("input",{type:"date",value:M,onChange:e=>A(e.target.value),onInput:e=>A(e.target.value),className:"border border-gray-300 rounded-lg px-1 py-1 text-sm cursor-pointer"}),(0,t.jsx)("span",{className:"text-gray-500 text-xs",children:" → "}),(0,t.jsx)("input",{type:"date",value:E,onChange:e=>$(e.target.value),onInput:e=>$(e.target.value),className:"border border-gray-300 rounded-lg px-1 py-1 text-sm cursor-pointer"}),(0,t.jsx)("button",{type:"button",onClick:()=>{A(""),$("")},className:"ml-1 px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-gray-100 cursor-pointer",children:(0,t.jsx)(S.IoReload,{className:"w-5 h-5"})})]})]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50",children:[f&&(0,t.jsx)("p",{className:"text-center text-blue-500 text-sm",children:"Đang tìm kiếm..."}),!f&&m.trim()&&0===g.length&&(0,t.jsxs)("p",{className:"text-center text-gray-500 text-sm",children:["Không tìm thấy tin nhắn nào khớp với: **",m,"**"]}),!f&&!m.trim()&&(0,t.jsx)("p",{className:"text-center text-gray-400 text-sm",children:"Nhập từ khóa để tìm kiếm trong hội thoại này."}),R.map((e,r)=>{let s=!0===e.isRecalled,n="file"===e.type?e.fileName||"File":"sticker"===e.type?"[Sticker]":String(e.content||""),i=r===y,o=l(e.sender),c=new Date(e.timestamp),d=new Date,u=new Date;u.setDate(d.getDate()-1);let g=(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),p=g(c,d)?"Hôm nay":g(c,u)?"Hôm qua":c.toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"}),f=c.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});return(0,t.jsxs)("div",{className:`p-3 rounded-lg shadow-sm hover:bg-gray-100 cursor-pointer transition-colors border ${i?"bg-blue-50 border-blue-300":"bg-white border-gray-200"}`,onClick:()=>D(e._id,r),children:[(0,t.jsxs)("p",{className:"text-xs text-blue-600 font-semibold",children:[o," • ",p," • ",f]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("div",{className:"flex items-center justify-between gap-2"}),"image"===e.type&&e.fileUrl?(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(String(e.fileUrl)),alt:"",width:320,height:240,className:"w-10 h-18 rounded-lg object-cover"})}):"video"===e.type&&e.fileUrl?(0,t.jsxs)("div",{className:"relative rounded-2xl overflow-hidden cursor-pointer shadow-lg max-w-[8vw] sm:max-w-[6rem] aspect-video bg-black",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(String(e.fileUrl)),className:"w-full h-full object-cover",muted:!0,playsInline:!0,loop:!0}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-4 h-4 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(x.HiPlay,{className:"w-3 h-3 text-blue-600 "})})})]}):(0,t.jsx)("p",{className:`text-sm mt-1 line-clamp-2 ${s?"italic text-gray-500":"text-gray-800"}`,children:((e,r)=>{if(!r.trim()||!e)return e;let s=(0,h.buildAccentInsensitiveRegex)(r),n=e.split(s);return(0,t.jsx)(t.Fragment,{children:n.map((e,r)=>s.test(e)?(0,t.jsx)("mark",{className:" text-blue-900 px-0.5 rounded font-medium",children:e},r):(0,t.jsx)("span",{children:e},r))})})(n,m)})]})]},e._id)})]}),g.length>0&&window.innerWidth<1024&&(0,t.jsx)("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-100 border-t border-gray-200",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:O,className:"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Kết quả trước",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,t.jsx)("span",{className:"text-xs text-gray-600 font-medium min-w-[80px] text-center",children:y>=0&&y<R.length?`Kết quả ${y+1}/${R.length}`:`0/${R.length}`}),(0,t.jsx)("button",{onClick:B,className:"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Kết quả tiếp theo",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})}),I&&(0,t.jsx)(C,{media:I,chatName:void 0,isGroup:void 0,onClose:()=>L(null),roomId:n})]})};function eV({isOpen:e,onClose:s,message:n,currentUser:l,allUsers:o,groups:c=[],onShare:d}){let[m,u]=(0,r.useState)(""),[g,p]=(0,r.useState)(new Set),[f,b]=(0,r.useState)(!1),[y,v]=(0,r.useState)(""),w=(0,r.useRef)(null),j=(0,r.useRef)(null),[N,k]=(0,r.useState)(!1),C=(0,r.useRef)(null),_=()=>{let e=w.current;if(e){try{e.scrollTop=e.scrollHeight}catch{}try{C.current?.scrollIntoView({block:"end"})}catch{}}};(0,r.useEffect)(()=>{k(window.innerWidth<1024)},[]),(0,r.useEffect)(()=>{if(!e||!N)return;let t=document.documentElement,r=()=>{let e=window.visualViewport;e&&(t.style.setProperty("--vvh",`${e.height}px`),t.style.setProperty("--vvw",`${e.width}px`),t.style.setProperty("--vvTop",`${e.offsetTop||0}px`),t.style.setProperty("--vvLeft",`${e.offsetLeft||0}px`),j.current&&(j.current.style.height=`${e.height}px`),_())},s=window.visualViewport;return s&&(s.addEventListener("resize",r),s.addEventListener("scroll",r),r()),document.body.classList.add("vv-body-lock"),()=>{s&&(s.removeEventListener("resize",r),s.removeEventListener("scroll",r)),document.body.classList.remove("vv-body-lock"),t.style.removeProperty("--vvh"),t.style.removeProperty("--vvw"),t.style.removeProperty("--vvTop"),t.style.removeProperty("--vvLeft")}},[e,N]);let T=(0,r.useMemo)(()=>{let e=o.filter(e=>e._id!==l._id).map(e=>({id:String(e._id),name:e.name||"Người dùng",avatar:e.avatar,isGroup:!1,type:"user"}));return[...c.map(e=>({id:String(e._id),name:e.name||"Nhóm",avatar:e.avatar,isGroup:!0,type:"group"})),...e]},[o,c,l._id]),M=(0,r.useMemo)(()=>m.trim()?T.filter(e=>(0,h.accentAwareIncludes)(e.name||"",m)):T,[T,m]),A=e=>{p(t=>{let r=new Set(t);return r.has(e)?r.delete(e):r.add(e),r})},E=async()=>{if(0!==g.size){b(!0);try{let e=Array.from(g).map(e=>{let t=T.find(t=>t.id===e);if(t?.isGroup)return e;{let t=[l._id,e].sort();return`${t[0]}_${t[1]}`}});await d(e,n,y),p(new Set),u(""),v(""),s()}catch(e){console.error("Share error:",e)}finally{b(!1)}}};return e?(0,t.jsx)("div",{ref:j,className:`fixed inset-0 z-[10001] flex items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4 animate-in fade-in duration-200 ${N?"vv-fixed":""}`,children:(0,t.jsxs)("div",{ref:w,className:"w-full h-full sm:w-full sm:h-auto sm:max-w-lg bg-white shadow-2xl flex flex-col sm:max-h-[90vh] overflow-hidden animate-in zoom-in-95 duration-200 md:rounded-xl",children:[(0,t.jsx)("div",{className:"relative p-1 bg-gray-200 text-black ",children:(0,t.jsxs)("div",{className:"flex items-center px-2 gap-3",children:[(0,t.jsx)("button",{onClick:s,className:"top-4 right-4 hover:cursor-pointer  hover:bg-white/20 rounded-full transition-all duration-200 hover:rotate-90",children:(0,t.jsx)(i.HiX,{className:"w-6 h-6"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-[1rem] ",children:"Chia sẻ"}),(0,t.jsxs)("p",{className:"text-black text-sm mt-0.5",children:["Đã chọn: ",g.size]})]})]})}),(0,t.jsx)("div",{className:"py-1.5 px-3 bg-white border-b border-gray-300 pb-3",children:(0,t.jsxs)("div",{className:"relative ",children:[(0,t.jsx)(S.IoSearch,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),(0,t.jsx)("input",{type:"text",placeholder:"Tìm kiếm người dùng hoặc nhóm...",value:m,onChange:e=>u(e.target.value),className:"w-full pl-12 pr-4 py-2 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 bg-gray-50 focus:bg-white"})]})}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,t.jsx)("div",{className:"px-3 py-1.5 bg-white",children:g.size>0&&(0,t.jsx)("div",{className:"mt-3 flex items-center gap-2 text-sm",children:(0,t.jsxs)("div",{className:"flex items-center gap-1.5 text-blue-600 font-medium",children:[(0,t.jsx)(S.IoCheckmark,{className:"w-5 h-5"}),(0,t.jsxs)("span",{children:[g.size," đã chọn"]})]})})}),(0,t.jsx)("div",{className:"px-3 pb-2",children:0===M.length?(0,t.jsxs)("div",{className:"p-12 text-center",children:[(0,t.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,t.jsx)(S.IoSearch,{className:"w-8 h-8 text-gray-400"})}),(0,t.jsx)("p",{className:"text-gray-500 font-medium",children:"Không tìm thấy kết quả"}),(0,t.jsx)("p",{className:"text-gray-400 text-sm mt-1",children:"Thử tìm kiếm với từ khóa khác"})]}):(0,t.jsx)("div",{className:"divide-y divide-gray-100",children:M.map(e=>{let r=g.has(e.id);return(0,t.jsxs)("button",{onClick:()=>A(e.id),className:"w-full  p-2 mb-2 flex items-center gap-4 transition-all hover:cursor-pointer duration-200 hover:bg-gray-50  border-transparent",children:[(0,t.jsxs)("div",{className:"relative flex-shrink-0 flex items-center gap-5",children:[(0,t.jsx)("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${r?"bg-blue-500 border-blue-500":"border-gray-300 bg-white"}`,children:r&&(0,t.jsx)(S.IoCheckmark,{className:"w-5 h-5 text-white"})}),(0,t.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden transition-all duration-200",children:e.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(e.avatar),alt:"",width:36,height:36,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:e.name,width:64,height:64,className:"w-full h-full object-cover"})})]}),(0,t.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,t.jsx)("p",{className:"font-semibold text-gray-800 truncate",children:e.name}),(0,t.jsx)("div",{className:"flex items-center gap-1.5 mt-0.5",children:e.isGroup?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiUsers,{className:"w-4 h-4 text-purple-500"}),(0,t.jsx)("span",{className:"text-xs text-purple-600 font-medium",children:"Nhóm"})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.HiUser,{className:"w-4 h-4 text-gray-400"}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"Người dùng"})]})})]})]},e.id)})})})]}),(0,t.jsx)("div",{className:"py-2 px-4 bg-gradient-to-br from-gray-50 to-white border-t border-gray-200 rounded-none sm:rounded-b-2xl",children:0===g.size?(0,t.jsx)("p",{className:"text-center text-gray-400 text-sm",children:"Chưa chọn người nhận nào"}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"mb-3",children:(0,t.jsxs)("p",{className:"text-sm font-semibold text-gray-700",children:["Đã chọn (",g.size,")"]})}),(0,t.jsx)("div",{className:"flex gap-3 overflow-x-auto  scrollbar-thin scrollbar-thumb-gray-300",children:Array.from(g).map(e=>{let r=T.find(t=>t.id===e);return r?(0,t.jsxs)("div",{className:"flex-shrink-0 flex flex-col items-center gap-2 group",children:[(0,t.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,t.jsx)("div",{className:"w-14 h-14 rounded-full overflow-hidden border-4 border-white shadow-lg",children:r.avatar?(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(r.avatar),alt:r.name,width:56,height:56,className:"w-full h-full object-cover"}):(0,t.jsx)(a.default,{src:"/logo/avata.webp",alt:r.name,width:56,height:56,className:"w-full h-full object-cover"})}),(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),A(e)},className:"absolute -top-[2px] cursor-pointer -right-1 w-5 h-5 bg-gray-400 hover:bg-red-600 rounded-full flex items-center justify-center shadow-lg border-2 border-white transition-all duration-200 opacity-100 hover:scale-110","aria-label":"Xóa khỏi danh sách chia sẻ",children:(0,t.jsx)(S.IoClose,{className:"w-4 h-4 text-white"})}),r.isGroup&&(0,t.jsx)("div",{className:"absolute -bottom-[2px] -right-2 w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center border-3 border-white shadow-md",children:(0,t.jsx)(x.HiUsers,{className:"w-4.5 h-4.5 text-white"})})]}),(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 max-w-[64px] truncate text-center mt-1",children:r.name})]},e):null})})]})}),(0,t.jsxs)("div",{className:"px-2 pb-3 mb-2 bg-white border-t border-gray-200",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:[(0,t.jsxs)("div",{className:"py-2 bg-gradient-to-br from-gray-50 to-blue-50/30",children:[(0,t.jsx)("p",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2",children:"Nội dung chia sẻ"}),(0,t.jsx)("div",{className:"bg-white p-2 rounded-xl border border-gray-200 shadow-sm  whitespace-pre-wrap break-words",children:(()=>{let e=n.batchItems||[];if(Array.isArray(e)&&e.length>1){let r=e.slice(0,6);return(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:"text-xs text-gray-500 mb-2",children:[e.length," mục sẽ được chia sẻ"]}),(0,t.jsx)("div",{className:"grid grid-cols-10 gap-1",children:r.map((e,r)=>{let s=(0,h.getProxyUrl)(String(e.fileUrl||""));return"image"===e.type?(0,t.jsx)("div",{className:"relative w-full max-w-[5rem] aspect-square bg-gray-50 rounded-lg overflow-hidden border border-gray-100",children:s?(0,t.jsx)(a.default,{src:s,alt:"Ảnh",width:200,height:200,className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gray-100"})},`share-preview-img-${r}`):"video"===e.type?(0,t.jsxs)("div",{className:"relative w-full max-w-[5rem] aspect-square bg-black rounded-lg overflow-hidden border border-gray-100",children:[s?(0,t.jsx)("video",{src:s,preload:"metadata",className:"w-full h-full object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gray-900"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:" rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(i.HiPlay,{className:"w-3 h-3 text-blue-600 ml-1"})})})]},`share-preview-vid-${r}`):(0,t.jsx)("div",{className:"flex items-center justify-center w-full aspect-square rounded-lg border border-gray-200 bg-white",children:(0,t.jsx)(x.HiOutlineDocumentText,{className:"w-6 h-6 text-gray-500"})},`share-preview-other-${r}`)})})]})}if("text"===n.type){let e=(n.content||"").slice(0,120)+((n.content||"").length>120?"...":"");return(0,t.jsx)("p",{className:"text-sm text-gray-700 leading-relaxed",children:e})}let r=(0,h.getProxyUrl)(n.fileUrl||n.previewUrl);return"image"===n.type&&r?(0,t.jsx)("div",{className:"w-full max-w-[5rem]",children:(0,t.jsx)(a.default,{src:r,alt:"Ảnh chia sẻ",width:300,height:200,className:"w-full max-h-20 object-contain rounded-xl border border-gray-100"})}):"video"===n.type&&r?(0,t.jsx)("div",{className:"w-full max-w-[7rem]",children:(0,t.jsx)("video",{src:r,controls:!0,preload:"metadata",className:"w-full max-h-20 rounded-xl border border-gray-100 bg-black"})}):"file"===n.type?(0,t.jsxs)("a",{href:(0,h.getProxyUrl)(n.fileUrl),target:"_blank",rel:"noreferrer",className:"flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-2xl max-w-[70vw] sm:max-w-[18rem] shadow-sm hover:bg-gray-50",children:[(0,t.jsx)("div",{className:"p-2 bg-blue-600 rounded-xl",children:(0,t.jsx)(x.HiOutlineDocumentText,{className:"w-6 h-6 text-white"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate",children:n.fileName||"Tệp đính kèm"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:"Nhấn để tải xuống"})]})]}):"sticker"===n.type?(0,t.jsx)("p",{className:"text-sm text-gray-700",children:"😊 Sticker"}):(0,t.jsx)("p",{className:"text-sm text-gray-700",children:"Tin nhắn"})})()})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{ref:C,type:"text",placeholder:"Nhập tin nhắn đính kèm (tùy chọn)",value:y,onChange:e=>v(e.target.value),onFocus:()=>{setTimeout(()=>{_(),C.current?.scrollIntoView({behavior:"smooth",block:"center"})},300)},className:"w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 bg-gray-50 focus:bg-white"}),(0,t.jsx)("button",{onClick:E,disabled:0===g.size||f,className:"flex-1 px-4 py-4 hover:cursor-pointer bg-blue-400 text-white font-semibold rounded-full hover:from-blue-600 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:-translate-y-0.5 flex items-center justify-center gap-2",children:f?(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):(0,t.jsx)(S.IoSend,{className:"w-4 h-4"})})]})]})]})}):null}function eG({contextMenu:e,currentUserId:s,onClose:n,onPinMessage:l,onRecallMessage:o,onReplyMessage:c,onShareMessage:d,onToggleReaction:m,setEditingMessageId:u,setEditContent:g,closeContextMenu:p,iconSize:f=35,reactionSize:b=35}){let y,v,w=(0,r.useRef)(null),N=(0,r.useRef)(!1),S=e?.focusTop??void 0,k=e?.focusHeight??void 0,C=!!e?.visible,_=e?.message;e?.x;let T=e?.y??0,M=e?.placement??"below",A=(0,r.useMemo)(()=>(e=>{try{if(!e)return"";if("string"==typeof e)return String(e);let t=e&&e._id,r=e&&e.id;if(null!=t)return String(t);if(null!=r)return String(r)}catch{}return""})(_?.sender)===String(s),[_,s]),E=_?.type==="text",$=!!_?.isRecalled,I=E&&!$,L=!!_?.fileUrl&&(_?.type==="image"||_?.type==="file"||_?.type==="sticker"||_?.type==="video"),P=A&&!$,H=!!_?.isPinned,U=A&&E&&!$,[R,D]=(0,r.useState)(null);(0,r.useEffect)(()=>{if(!C)return;let e=document.body.style.overflow;document.body.style.overflow="hidden";let t=e=>{e.preventDefault()};return document.addEventListener("touchmove",t,{passive:!1}),()=>{document.body.style.overflow=e,document.removeEventListener("touchmove",t)}},[C]),(0,r.useEffect)(()=>{D(null)},[_?.fileUrl,_?.type]),(0,r.useEffect)(()=>{if(C&&_?.type==="image"&&_?.fileUrl)try{let e=document.createElement("img");e.src=(0,h.getProxyUrl)(_.fileUrl),e.decoding="async",e.onload=()=>{let t=e.naturalWidth||0,r=e.naturalHeight||0;if(t>0&&r>0){let e=window.innerWidth,s=window.innerHeight,n="number"==typeof k?k:Math.floor(.78*s),i=Math.floor(t*n/r),a=Math.floor(.88*e),l=Math.max(120,Math.min(i,a));D({w:l,h:n})}}}catch{}},[C,_?.type,_?.fileUrl,k]);let O=async()=>{let e=_?.content||"";if(e){try{let t=window;if(navigator.clipboard&&t.isSecureContext){await navigator.clipboard.writeText(e),n();return}}catch{}try{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();let r=document.execCommand("copy");document.body.removeChild(t),r&&n()}catch{}}};return C&&_?(0,t.jsxs)("div",{className:"fixed inset-0 z-[9999]",onContextMenu:e=>e.preventDefault(),children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm",onClick:n,onTouchStart:e=>{w.current=e.touches[0].clientY,N.current=!1},onTouchMove:e=>{let t=e.touches[0],r=w.current??t.clientY;Math.abs(t.clientY-r)>8&&(N.current=!0)},onTouchEnd:e=>{let t=e.changedTouches[0],r=w.current??t.clientY;t.clientY-r>60&&n()}}),"text"===_.type&&"number"==typeof S&&(0,t.jsx)("div",{className:"fixed left-1/2 -translate-x-1/2 z-[10000] w-[88vw] max-w-[22rem] px-2 animate-in fade-in zoom-in-95 duration-200",style:{top:S},children:(0,t.jsxs)("div",{className:`mx-auto rounded-2xl shadow-2xl border ${A?"bg-[#E5F1FF] border-blue-200":"bg-white border-gray-200"} px-4 py-3 text-[1rem] text-black relative`,style:{maxHeight:k?`${k}px`:"32vh",overflow:"hidden"},children:[(0,t.jsx)("div",{className:"whitespace-pre-wrap break-words",children:_.content||""}),(0,t.jsx)("div",{className:"absolute left-0 right-0 bottom-0 h-8 pointer-events-none bg-gradient-to-t from-white/90 to-transparent"})]})}),"image"===_.type&&_.fileUrl&&"number"==typeof S&&(y=Math.floor(.88*window.innerWidth),v=R?.w??y,(0,t.jsx)("div",{className:"fixed left-1/2 -translate-x-1/2 z-[10000] px-2 animate-in fade-in zoom-in-95 duration-200",style:{top:S,width:v},children:(0,t.jsx)("div",{className:"mx-auto rounded-2xl shadow-2xl border bg-white border-gray-200 p-2 relative",style:{height:k?`${k}px`:"78vh"},children:(0,t.jsx)("div",{className:"relative w-full h-full",children:(0,t.jsx)(a.default,{src:(0,h.getProxyUrl)(_.fileUrl),alt:_.fileName||"Ảnh",fill:!0,className:"object-contain"})})})})),"video"===_.type&&_.fileUrl&&"number"==typeof S&&(0,t.jsx)("div",{className:"fixed left-1/2 -translate-x-1/2 z-[10000] w-[88vw] max-w-[22rem] px-2 animate-in fade-in zoom-in-95 duration-200",style:{top:S},children:(0,t.jsx)("div",{className:"mx-auto rounded-2xl shadow-2xl border bg-white border-gray-200 p-2 relative",style:{maxHeight:k?`${k}px`:"34vh",overflow:"hidden"},children:(0,t.jsxs)("div",{className:"relative w-full",children:[(0,t.jsx)("video",{src:(0,h.getProxyUrl)(_.fileUrl),className:"w-full h-auto object-contain bg-black rounded-xl",style:{maxHeight:"100%"},playsInline:!0,preload:"metadata"}),(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-100",children:(0,t.jsx)("div",{className:"w-12 h-12 bg-white/80 rounded-full flex items-center justify-center shadow",children:(0,t.jsx)(x.HiPlay,{className:"w-7 h-7 text-blue-600 ml-1"})})})]})})}),"file"===_.type&&_.fileUrl&&"number"==typeof S&&(0,t.jsx)("div",{className:"fixed left-1/2 -translate-x-1/2 z-[10000] w-[92vw] max-w-[24rem] px-2",style:{top:S},children:(0,t.jsx)("div",{className:"mx-auto rounded-2xl shadow-2xl border bg-white border-gray-200 p-3 relative",style:{maxHeight:"38vh",overflow:"hidden"},children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"p-2 bg-blue-600 rounded-xl",children:(0,t.jsx)(i.HiOutlineDownload,{className:"w-5 h-5 text-white"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800 truncate",children:_.fileName||"Tệp đính kèm"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:"Giữ để mở thêm hành động"})]})]})})}),(0,t.jsxs)("div",{className:`absolute z-[10001] ${"above"===M?"bottom-auto":"top-auto"} `,"data-context-menu":"true",style:{top:T,left:"50%",transform:"translateX(-50%)"},onMouseDown:e=>{e.stopPropagation()},onClick:e=>{e.stopPropagation()},onTouchStart:e=>{e.stopPropagation()},children:[!$&&"function"==typeof m&&(0,t.jsx)("div",{className:"bottom-full bg-white rounded-xl p-2 mb-2 ",onMouseDown:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),onTouchStart:e=>e.stopPropagation(),children:(0,t.jsx)("div",{className:"flex items-center justify-between gap-2",children:["👍","❤️","😂","😮","😢","😡"].map(e=>(0,t.jsx)("button",{onClick:()=>{m?.(_,e),n()},"aria-label":`Biểu cảm ${e}`,title:`Biểu cảm ${e}`,children:(0,t.jsx)("span",{className:"leading-none",style:{fontSize:b},children:e})},e))})}),(0,t.jsx)("div",{className:"w-[92vw] max-w-[24rem] mx-auto bg-white rounded-2xl shadow-2xl border border-gray-200 p-1 animate-in fade-in zoom-in-95 duration-200",children:(0,t.jsxs)("div",{className:"grid grid-cols-4 gap-1",children:[c&&!$&&(0,t.jsxs)("button",{onClick:()=>{c(_),n()},className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-blue-50 active:scale-95 transition-all","aria-label":"Trả lời tin nhắn",title:"Trả lời tin nhắn",children:[(0,t.jsx)(j.FaRepeat,{size:24,color:"#2563eb",className:"w-7 h-7"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Trả lời"})]}),!$&&(0,t.jsxs)("button",{onClick:()=>{d(_),n()},className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-indigo-50 active:scale-95 transition-all","aria-label":"Chia sẻ tin nhắn",title:"Chia sẻ tin nhắn",children:[(0,t.jsx)(j.FaRegShareFromSquare,{className:"w-7 h-7 text-blue-500"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Chia sẻ"})]}),U&&(0,t.jsxs)("button",{onClick:()=>{u&&g&&(u(String(_._id)),g(String(_.content||""))),(p||n)()},className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl hover:bg-purple-50 active:scale-95 transition-all","aria-label":"Chỉnh sửa tin nhắn",title:"Chỉnh sửa tin nhắn",children:[(0,t.jsx)(j.FaRegPenToSquare,{className:"w-7 h-7  "}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Chỉnh sửa"})]}),I&&(0,t.jsxs)("button",{onClick:O,className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl hover:bg-green-50 active:scale-95 transition-all","aria-label":"Sao chép nội dung",title:"Sao chép nội dung",children:[(0,t.jsx)(j.FaCopy,{className:"w-7 h-7 text-blue-500"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Sao chép"})]}),!$&&(0,t.jsxs)("button",{onClick:()=>{l(_),n()},className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-amber-50 active:scale-95 transition-all","aria-label":H?"Bỏ ghim":"Ghim",title:H?"Bỏ ghim":"Ghim",children:[(0,t.jsx)(j.FaPaperclip,{className:`${H?"text-amber-600":"text-red-600"}`,size:24}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:H?"Bỏ ghim":"Ghim"})]}),L&&(0,t.jsxs)("a",{href:_?.fileUrl,download:_?.fileName||"file_chat",onClick:()=>setTimeout(n,100),className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-teal-50 active:scale-95 transition-all","aria-label":"Tải xuống",title:"Tải xuống",children:[(0,t.jsx)(j.FaDownload,{className:"w-7 h-7 text-blue-500 hover:text-blue-500 cursor-pointer"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Tải xuống"})]}),!$&&(0,t.jsxs)("button",{className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-orange-50 active:scale-95 transition-all","aria-label":"Lưu vào thư mục",title:"Lưu vào thư mục",children:[(0,t.jsx)(j.FaFolderOpen,{className:"w-7 h-7 text-orange-300 hover:text-orange-500 cursor-pointer"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Thư mục"})]}),P&&(0,t.jsxs)("button",{onClick:()=>{o(String(_?._id)),n()},className:"flex flex-col items-center justify-center gap-1 p-1 rounded-xl  hover:bg-red-50 active:scale-95 transition-all","aria-label":"Thu hồi tin nhắn",title:"Thu hồi tin nhắn",children:[(0,t.jsx)(j.FaTrashCan,{className:"w-7 h-7 text-red-600"}),(0,t.jsx)("span",{className:"text-[0.75rem] text-gray-800",children:"Thu hồi"})]})]})})]})]}):null}let eW=["https://cdn-icons-png.flaticon.com/512/9408/9408176.png","https://cdn-icons-png.flaticon.com/512/9408/9408201.png"],eX=e=>e?"string"==typeof e?e:"_id"in e&&null!=e._id?String(e._id):"id"in e&&null!=e.id?String(e.id):"":"";function eJ({selectedChat:e,currentUser:i,allUsers:a,onShowCreateGroup:l,reLoad:c,onChatAction:d,scrollToMessageId:m,onScrollComplete:u,roomSearchKeyword:g,setRoomSearchKeyword:p,onBackFromChat:f,groups:b,socket:y}){let v=(0,o.useRouter)(),[j,N]=(0,r.useState)([]),[S,k]=(0,r.useState)(!1),[_,T]=(0,r.useState)(null),[M,A]=(0,r.useState)(!1),E=(0,r.useRef)(null),$=(0,r.useRef)(null),I=(0,r.useRef)(null),L=(0,r.useRef)(null),[P,H]=(0,r.useState)(null),U=(0,r.useRef)(null),R=(0,r.useRef)(!1),O=(0,r.useRef)(!1),F=(0,r.useRef)(!0),[z,V]=(0,r.useState)(!1),[G,W]=(0,r.useState)("emoji"),[X,J]=(0,r.useState)(null),[K,q]=(0,r.useState)(null),[Q,Y]=(0,r.useState)(!1),[Z,ee]=(0,r.useState)(0),et=(0,r.useRef)(0),er=(0,r.useRef)(!1),es=(0,r.useCallback)(()=>{let e=String(i._id||"");e&&N(t=>t.map(t=>{let r=Array.isArray(t.readBy)?t.readBy:[];return r.some(t=>String(t)===e)?t:{...t,readBy:[...r,e]}}))},[i._id]),en="isGroup"in e&&!0===e.isGroup,[ei,ea]=(0,r.useState)(null),[,el]=(0,r.useState)(null),[eo,ec]=(0,r.useState)([]),[eh,eg]=(0,r.useState)(!1),[ep,ev]=(0,r.useState)(0),[ew,ej]=(0,r.useState)(null),[eS,ek]=(0,r.useState)(!1),[eC,e_]=(0,r.useState)(null),[eT,eM]=(0,r.useState)(null),[eE,eH]=(0,r.useState)(""),[eU,eF]=(0,r.useState)(!0),[eJ,eK]=(0,r.useState)(!1),[eq,eQ]=(0,r.useState)(null),[eY,eZ]=(0,r.useState)(!1),[e0,e1]=(0,r.useState)([]),e2=(0,r.useRef)(new Set),e5=(0,r.useRef)(new Map),e3=(0,r.useRef)(new Set),e4=(0,r.useRef)(new Map),e6=(0,r.useRef)([]),[e8,e9]=(0,r.useState)(!1),[e7,te]=(0,r.useState)(null),tt=en?eX(e):[eX(i),eX(e)].sort().join("_"),[tr,ts]=(0,r.useState)(!1),[tn,ti]=(0,r.useState)(!1),[ta,tl]=(0,r.useState)("voice"),[to,tc]=(0,r.useState)([]),[td,tm]=(0,r.useState)(!1),[tu,th]=(0,r.useState)(!1),[tx,tg]=(0,r.useState)(!1);(0,r.useEffect)(()=>{try{let e=`roomMuted:${tt}:${String(i._id)}`,t="true"===localStorage.getItem(e);ts(t)}catch{}},[tt,i._id]),(0,r.useEffect)(()=>{try{localStorage.setItem("CURRENT_ROOM_ID",String(tt));let e=new CustomEvent("currentRoomChanged",{detail:{roomId:String(tt)}});window.dispatchEvent(e)}catch{}},[tt]),(0,r.useEffect)(()=>{try{let e="true"===localStorage.getItem(`livekit_room_${tt}_active`),t=localStorage.getItem(`livekit_room_${tt}_type`),r=localStorage.getItem(`livekit_room_${tt}_participants`),s=r?JSON.parse(r):[];ti(!!e),tl("video"===t?"video":"voice"),tc(Array.isArray(s)?s.map(e=>String(e)):[])}catch{}},[tt]),(0,r.useEffect)(()=>{let e=e=>{let t=e.detail||{};String(t.roomId)===String(tt)&&(ti(!!t.active),tl("video"===t.type?"video":"voice"),tc(Array.isArray(t.participants)?t.participants.map(e=>String(e)):[]))};return window.addEventListener("roomCallStateChanged",e),()=>window.removeEventListener("roomCallStateChanged",e)},[tt]),(0,r.useEffect)(()=>{try{tg("1"===localStorage.getItem("GLOBAL_INCOMING_CALL")),tm("1"===localStorage.getItem("GLOBAL_CALL_ACTIVE")),th("1"===localStorage.getItem("GLOBAL_CALL_CONNECTING"))}catch{}let e=e=>{let t=e.detail||{};tm(!!t.active),th(!!t.connecting),tg(!!t.incoming)};return window.addEventListener("globalCallStatusChanged",e),()=>window.removeEventListener("globalCallStatusChanged",e)},[]),(0,r.useEffect)(()=>{let e=e=>{let t=e.detail;t&&String(t.roomId)===String(tt)&&ts(!!t.muted)};return window.addEventListener("roomMutedChanged",e),()=>window.removeEventListener("roomMutedChanged",e)},[tt]),(0,r.useEffect)(()=>{e6.current=j},[j]);let tp=(0,r.useMemo)(()=>{if(en)return e.name;let t=String(i._id||i?.id||"");return e.nicknames?.[t]||e.name||e.username||"Người dùng"},[e,en,i]),[tf,tb]=(0,r.useState)(!1),ty=e.avatar,tv=(0,r.useCallback)(async e=>{O.current=!0,tL.current=Date.now()+1800;let t=$.current;if(!t){console.error("❌ [JUMP] Container not found"),O.current=!1;return}F.current=!1;let r=(e,t)=>{let r=e.getBoundingClientRect(),s=t.getBoundingClientRect();return t.scrollTop+(r.top-s.top)},s=e=>{try{let s=r(e,t)-t.clientHeight/2+e.clientHeight/2,n=Math.max(0,t.scrollHeight-t.clientHeight),i=Math.max(0,Math.min(s,n));t.scrollTo({top:i,behavior:"smooth"})}catch{}},n=(i,a=0)=>{let l=$.current?.querySelector(`[id="${i}"]`)||document.getElementById(i);if(l){try{l.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch{}return s(l),J(e),setTimeout(()=>J(null),2500),setTimeout(()=>{let e,n,a,l,o=$.current?.querySelector(`[id="${i}"]`)||document.getElementById(i);!o||(n=(e=t.scrollTop)+t.clientHeight,l=(a=r(o,t))+o.clientHeight,a>=e&&l<=n)||s(o),O.current=!1,tL.current=0},320),!0}return a<15?setTimeout(()=>n(i,a+1),200):(console.warn("❌ [JUMP] Element not found after 10 attempts"),O.current=!1),!1};if(document.getElementById(`msg-${e}`))return void n(`msg-${e}`);if(j.find(t=>String(t._id)===String(e)))return void setTimeout(()=>n(`msg-${e}`),100);try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:e})}),r=await t.json(),s=r?.row?.row||r?.row;if(!s||String(s.roomId)!==String(tt)){console.error("❌ [JUMP] Message not found or wrong room"),alert("Không tìm thấy tin nhắn này trong cuộc trò chuyện."),O.current=!1;return}let i=Number(s.timestamp),[a,l]=await Promise.all([(0,B.readMessagesApi)(tt,{limit:100,sortOrder:"desc",extraFilters:{timestamp:{$lte:i}}}),(0,B.readMessagesApi)(tt,{limit:50,sortOrder:"asc",extraFilters:{timestamp:{$gt:i}}})]),o=Array.isArray(a.data)?a.data:[],c=Array.isArray(l.data)?l.data:[],d=[...o.reverse(),...c],m=new Set(j.map(e=>String(e._id))),u=d.filter(e=>!m.has(String(e._id)));if(u.length>0){N(e=>{let t=[...e,...u];return t.sort((e,t)=>{let r=Number(e.timestamp)||0,s=Number(t.timestamp)||0;return r-s}),t});let e=Math.min(...u.map(e=>Number(e.timestamp)));eQ(t=>Math.min(e,t??1/0)),eF(100===o.length)}setTimeout(()=>{n(`msg-${e}`)},300)}catch(e){console.error("❌ [JUMP] Error:",e),alert("Có lỗi xảy ra khi tải tin nhắn."),O.current=!1,tL.current=0}},[tt,j,eq]),[tw,tj]=(0,r.useState)(""),[tN,tS]=(0,r.useState)([]),[tk,tC]=(0,r.useState)(!1),[t_,tT]=(0,r.useState)(-1),tM=(0,r.useRef)(null),tA=(0,r.useCallback)(()=>{try{let t=new CustomEvent("startCall",{detail:{type:ta,roomId:tt,isGroup:en,selectedChat:e}});window.dispatchEvent(t)}catch{}},[ta,tt,en,e]),tE=(0,r.useRef)(!1),t$=window.innerWidth<1024,tI=window.innerWidth>=1024&&window.innerWidth<1280,tL=(0,r.useRef)(0),tP=(0,r.useRef)(!1),tH=(0,r.useRef)(null),tU=(0,r.useRef)(-1),tR=(0,r.useRef)(!1),[tD,tO]=(0,r.useState)(!1),tB=(0,r.useRef)([]);(0,r.useEffect)(()=>{tU.current=t_},[t_]),(0,r.useEffect)(()=>{tB.current=tN},[tN]),(0,r.useEffect)(()=>{t$||!tR.current&&g&&g.trim()&&m&&!tf&&tb(!0)},[g,m,t$,tf]);let tF=(0,r.useCallback)(async(e,t=!1)=>{if(!e.trim()||!tt){tS([]),tT(-1),tO(!1);return}tC(!0);try{let r=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"read",filters:{roomId:tt,searchQuery:e.trim(),isRecalled:{$ne:!0},isDeleted:{$ne:!0},type:{$ne:"notify"}},skip:t?tB.current.length:0,limit:200,sort:{field:"timestamp",order:"desc"}})}),s=await r.json(),n=Array.isArray(s?.data)?s.data:[],i=n.filter(t=>{let r="file"===t.type?String(t.fileName||""):"sticker"===t.type?"":String(t.content||"");return(0,h.accentAwareIncludes)(r,e)}).slice().sort((e,t)=>Number(e.timestamp)-Number(t.timestamp)),a=t?[...tB.current,...i]:i;if(tS(a),tO(200===n.length),a.length>0){let e=tH.current;if(tP.current&&e){let t=a.findIndex(t=>String(t._id)===String(e));if(t>=0)tT(t);else{let e=tU.current,t=Math.max(0,Math.min(a.length-1,e));tT(t)}tP.current=!1,tH.current=null}else if(-1===tU.current){let e=a.length-1;tT(e)}else{let e=tU.current,t=Math.max(0,Math.min(a.length-1,e));tT(t)}}else tT(-1)}catch(e){console.error("Fetch search results error:",e),tS([]),tT(-1),tO(!1)}finally{tC(!1)}},[tt,tv]);(0,r.useEffect)(()=>{!tR.current&&t$&&g&&g.trim()&&!tE.current&&!tf&&(tj(g),tE.current=!0,tb(!0),tF(g),setTimeout(()=>{tM.current?.focus()},100))},[g,t$,tF,tf]),(0,r.useEffect)(()=>{if(!t$||g&&tw===g&&tE.current)return;if(!tw.trim()){tS([]),tT(-1);return}let e=setTimeout(()=>{tF(tw,!1)},500);return()=>{clearTimeout(e)}},[tw,t$,g,tF]);let tz=(0,r.useCallback)(()=>{if(0===tN.length)return;let e=t_<=0?tN.length-1:t_-1;tT(e),tP.current=!0,tH.current=tN[e]._id,tv(tN[e]._id),setTimeout(()=>{tP.current=!1,tH.current=null},1200)},[tN,t_]),tV=(0,r.useCallback)(async()=>{if(0===tB.current.length)return;if(t_>=tB.current.length-1){if(tD){await tF(tw,!0);let e=Math.min(t_+1,tB.current.length-1);tT(e),tP.current=!0,tH.current=tB.current[e]._id,tv(tB.current[e]._id),setTimeout(()=>{tP.current=!1,tH.current=null},1200)}else tT(0),tP.current=!0,tH.current=tB.current[0]._id,tv(tB.current[0]._id),setTimeout(()=>{tP.current=!1,tH.current=null},1200);return}let e=t_+1;tT(e),tP.current=!0,tH.current=tB.current[e]._id,tv(tB.current[e]._id),setTimeout(()=>{tP.current=!1,tH.current=null},1200)},[tD,t_,tw,tF]);(0,r.useEffect)(()=>{!tf&&t$&&(tR.current=!0,tj(""),tS([]),tT(-1),tE.current=!1,setTimeout(()=>{tR.current=!1},300))},[tf,t$,p]);let tG=(0,r.useMemo)(()=>{if(en)return{online:void 0,text:""};let t=eX(e),r=a.find(e=>String(e._id)===String(t)),n=r?.lastSeen??null,i=Date.now(),l=null!=n?i-n<=3e5:!!r?.online,o=l?"Đang hoạt động":n?`Hoạt động ${(0,s.formatTimeAgo)(n)} trước`:"Hoạt động gần đây";return{online:l,text:o}},[en,e,a]),tW=(0,r.useCallback)((e=!1)=>{if(!e&&(tf||tL.current&&Date.now()<tL.current)||O.current)return;let t=$.current;if(!t)return;t.scrollTop=t.scrollHeight;let r=E.current;r&&"function"==typeof r.scrollIntoView&&r.scrollIntoView({block:"end"}),ee(0),et.current=0,er.current=!1,Y(!1)},[tf]),tX=(0,r.useCallback)(()=>{tW(),setTimeout(tW,0),setTimeout(tW,100),setTimeout(tW,300)},[tW]),tJ=(0,r.useCallback)(async t=>{try{if(t._id){let r=String(t._id);N(e=>{let s=[...e,{...t,_id:r}];return tQ(s)}),tX();let s={...t,_id:r,roomId:tt,sender:i._id,senderName:i.name,isGroup:en,receiver:en?null:eX(e),members:en?e.members:[]};L.current?.emit("send_message",s),ea(null)}else{let r=await (0,B.createMessageApi)({...t,roomId:tt});if(r.success&&"string"==typeof r._id){let s=r._id;N(e=>{let r=[...e,{...t,_id:s}];return tQ(r)}),tX();let n={...t,_id:s,roomId:tt,sender:i._id,senderName:i.name,isGroup:en,receiver:en?null:eX(e),members:en?e.members:[]};L.current?.emit("send_message",n),ea(null)}}}catch(e){console.error("Save message error:",e)}},[tt,i,en,e,tX]),tK=(0,r.useCallback)(()=>{try{window.dispatchEvent(new CustomEvent("startCall",{detail:{type:"voice",roomId:tt,isGroup:en,selectedChat:e}}))}catch{}},[tt,en,e]),tq=(0,r.useCallback)(()=>{try{window.dispatchEvent(new CustomEvent("startCall",{detail:{type:"video",roomId:tt,isGroup:en,selectedChat:e}}))}catch{}},[tt,en,e]);(0,r.useEffect)(()=>{let e=e=>{try{let t=e.detail||{};t&&t.roomId}catch{}k(!1),tb(!0),t$&&setTimeout(()=>{try{tM.current?.focus()}catch{}},100)};return window.addEventListener("openRoomSearch",e),()=>window.removeEventListener("openRoomSearch",e)},[t$,k,tb]);let tQ=(0,r.useCallback)(e=>{let t=e=>{let t=Number(e);return Number.isFinite(t)?t:0};return e.slice().sort((e,r)=>{let s=t(e.serverTimestamp??e.timestamp),n=t(r.serverTimestamp??r.timestamp);if(s!==n)return s-n;let i=String(e._id||""),a=String(r._id||"");return i.startsWith("temp_")&&!a.startsWith("temp_")?1:!i.startsWith("temp_")&&a.startsWith("temp_")?-1:i.localeCompare(a)})},[]),tY=(0,r.useCallback)(async(e,t)=>{let r={roomId:tt,sender:i._id,content:e,type:"notify",timestamp:Date.now(),replyToMessageId:t};await tJ(r)},[tt,i._id,tJ]),tZ=(0,r.useCallback)(e=>{if(!rX(e.sender,i._id))return;let t=String(e._id),r=e4.current.get(t);r&&(clearTimeout(r),e4.current.delete(t),e3.current.delete(t));let s=e.pollEndAt,n=!!e.isPollLocked;if("number"!=typeof s||n)return;let a=Math.max(0,s-Date.now()),l=window.setTimeout(async()=>{let e=e6.current.find(e=>String(e._id)===t);if(!e||e.isRecalled||e.isPollLocked){e3.current.delete(t);let e=e4.current.get(t);e&&(clearTimeout(e),e4.current.delete(t));return}let r=e.pollEndAt;try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:e._id})}),s=await t.json(),n=s&&(s.row?.row||s.row),i=n&&n.pollEndAt;("number"==typeof i||null===i)&&(r=i)}catch{}let s=Date.now();if("number"==typeof r&&r>s){let e=Math.max(0,r-s),n=window.setTimeout(async()=>{let e=e6.current.find(e=>String(e._id)===t);if(!e||e.isRecalled||e.isPollLocked){e3.current.delete(t);let e=e4.current.get(t);e&&(clearTimeout(e),e4.current.delete(t));return}let s=new Date(r).toLocaleString("vi-VN"),n=Date.now(),i={isPollLocked:!0,pollLockedAt:n,editedAt:n,timestamp:n};try{let t=await (0,B.tryLockPollApi)(String(e._id),i);t.success&&t.modifiedCount&&t.modifiedCount>0&&(L.current?.emit("edit_message",{_id:e._id,roomId:tt,...i}),await tY(`B\xecnh chọn đ\xe3 tự động kh\xf3a: "${String(e.content||e.pollQuestion||"")}" (kết th\xfac l\xfac ${s})`,String(e._id)))}catch{}e3.current.delete(t),e4.current.delete(t)},e);e4.current.set(t,n);return}let n=new Date(r||s).toLocaleString("vi-VN"),i={isPollLocked:!0,pollLockedAt:s,editedAt:s,timestamp:s};try{let t=await (0,B.tryLockPollApi)(String(e._id),i);t.success&&t.modifiedCount&&t.modifiedCount>0&&(L.current?.emit("edit_message",{_id:e._id,roomId:tt,...i}),await tY(`B\xecnh chọn đ\xe3 tự động kh\xf3a: "${String(e.content||e.pollQuestion||"")}" (kết th\xfac l\xfac ${n})`,String(e._id)))}catch{}e3.current.delete(t),e4.current.delete(t)},a);e4.current.set(t,l),e3.current.add(t)},[tt,tY,i._id]),{uploadingFiles:t0,handleUploadAndSend:t1}=function({roomId:e,currentUser:t,selectedChat:s,isGroup:n,sendMessageProcess:i,setMessages:a,onScrollBottom:l}){let o=e=>{let t=e=>{let t=Number(e);return Number.isFinite(t)?t:0};return e.slice().sort((e,r)=>{let s=t(e.timestamp),n=t(r.timestamp);if(s!==n)return s-n;let i=String(e._id||""),a=String(r._id||"");return i.startsWith("temp_")&&!a.startsWith("temp_")?1:!i.startsWith("temp_")&&a.startsWith("temp_")?-1:i.localeCompare(a)})},[c,d]=(0,r.useState)({}),m=(0,r.useRef)({}),u=`pendingUploads:${e}`,h=()=>{try{let e=localStorage.getItem(u);return e?JSON.parse(e):[]}catch{return[]}},x=e=>{try{localStorage.setItem(u,JSON.stringify(e))}catch{}},g=(e,t)=>{x(h().map(r=>r.tempId===e?{...r,percent:t}:r))},p=e=>{x(h().filter(t=>t.tempId!==e))},f=(0,r.useCallback)(async(r,c,u,f,b,y,v,w)=>{var j;let N,S=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_]/g,""),k=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,C=`temp_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,_=new FormData;_.append("file",r),_.append("roomId",e),_.append("sender",t._id),!n&&"_id"in s&&_.append("receiver",s._id),_.append("type",c),_.append("fileName",r.name),v&&_.append("batchId",v);let T="";if(n)T=`Group__${S(s.name)}`;else{let e=[S(t.name||"Me"),S("_id"in s&&"name"in s&&s.name||"User")].sort();T=`${e[0]}__${e[1]}`}_.append("folderName",T);let M={_id:C,roomId:e,sender:t._id,senderModel:t,batchId:v,fileUrl:URL.createObjectURL(r),fileName:r.name,type:c,timestamp:Date.now(),content:u,isSending:!0};a(e=>o([...e,M])),d(e=>({...e,[C]:0})),eL(C,0),j={tempId:C,uploadId:k,type:c,fileName:r.name,caption:u,fileUrl:M.fileUrl||"",percent:0},x((N=h()).some(e=>e.tempId===j.tempId)?N.map(e=>e.tempId===j.tempId?j:e):[...N,j]);try{l?.()}catch{}let A=!1,E="";if(await eD()){let l=new EventSource(`/api/upload/progress?id=${encodeURIComponent(k)}`);l&&(m.current[k]=l,l.onmessage=e=>{try{var t;let r,s=JSON.parse(e.data);t="number"==typeof s.percent?s.percent:0,r=Math.min(t,95),d(e=>({...e,[C]:r})),eL(C,r),g(C,r),s.done&&(l.close(),delete m.current[k])}catch{}},l.onerror=()=>{try{l.close(),delete m.current[k]}catch{}});for(let l=0;l<2&&!A;l++)try{let l=await new Promise((i,a)=>{eR.set(k,{resolve:i,reject:a});let l=navigator.serviceWorker.controller,o={file:r,roomId:e,sender:t._id,receiver:!n&&"_id"in s?s._id:"",type:c,fileName:r.name,folderName:T,batchId:v};l?.postMessage({type:"UPLOAD",uploadId:k,fields:o})});if(l.success){A=!0;let r=l.data;a(e=>e.filter(e=>e._id!==C));let o={...r,_id:l._id||l.data._id||Date.now().toString(),roomId:e,sender:t._id,senderName:y||t.name,isGroup:n,receiver:n?null:"_id"in s?s._id:"",members:n?s.members:[],type:c,timestamp:Date.now(),content:u,replyToMessageId:f,mentions:b,batchId:v,videoCropConfig:"video"===c?w??null:null};await i(o)}else E=l.message||"Không xác định"}catch(e){E=e?.message||String(e)||"Không xác định"}try{l?.close(),l&&delete m.current[k]}catch{}}else for(let r=0;r<2&&!A;r++)try{let r=await (0,eI.uploadFileWithProgress)(`/api/upload?uploadId=${k}`,_,e=>{let t=Math.min(e,95);d(e=>({...e,[C]:t})),eL(C,t),g(C,t)});if(r.success){A=!0;let l=r.data;a(e=>e.filter(e=>e._id!==C));let o={...l,_id:r._id||r.data._id||Date.now().toString(),roomId:e,sender:t._id,senderName:y||t.name,isGroup:n,receiver:n?null:"_id"in s?s._id:"",members:n?s.members:[],type:c,timestamp:Date.now(),content:u,replyToMessageId:f,mentions:b,batchId:v,videoCropConfig:"video"===c?w??null:null};await i(o)}else E=r.message||"Không xác định"}catch(e){E=e?.message||String(e)||"Không xác định"}if(!A){a(e=>e.filter(e=>e._id!==C));try{alert(`Tải l\xean thất bại: ${r.name}. L\xfd do: ${E}`)}catch{}}d(e=>{let t={...e};return delete t[C],t}),eP(C),p(C)},[e,t,n,s,i,a,l]);return(0,r.useEffect)(()=>{let r=h();if(0!==r.length)return r.forEach(r=>{var s;let n;a(s=>s.some(e=>e._id===r.tempId)?s:o([...s,{_id:r.tempId,roomId:e,sender:t._id,senderModel:t,type:r.type,fileUrl:r.fileUrl,fileName:r.fileName,timestamp:Date.now(),content:r.caption,isSending:!0}]));let i=(s=r.tempId,(n=globalThis.uploadProgressMap)&&n.has(s)?n.get(s)??0:-1),l=i>=0?i:r.percent||0;if(d(e=>({...e,[r.tempId]:Math.min(l,95)})),!m.current[r.uploadId])try{let t=new EventSource(`/api/upload/progress?id=${encodeURIComponent(r.uploadId)}`);m.current[r.uploadId]=t,t.onmessage=s=>{try{let n=JSON.parse(s.data),i="number"==typeof n.percent?n.percent:0,l=Math.min(i,95);d(e=>({...e,[r.tempId]:l})),eL(r.tempId,l),g(r.tempId,l),n.done&&(t.close(),delete m.current[r.uploadId],d(e=>{let t={...e};return delete t[r.tempId],t}),a(e=>e.filter(e=>e._id!==r.tempId)),eP(r.tempId),p(r.tempId),(async()=>{try{let t=await (0,B.readMessagesApi)(e,{limit:1,sortOrder:"desc",extraFilters:{uploadId:r.uploadId}}),s=(t?.data||[])[0];s&&a(e=>e.some(e=>String(e._id)===String(s._id))?e:[...e,s])}catch{}})())}catch{}},t.onerror=()=>{try{t.close(),delete m.current[r.uploadId]}catch{}}}catch{}}),setTimeout(()=>{h().forEach(r=>{a(s=>s.some(e=>e._id===r.tempId)?s:o([...s,{_id:r.tempId,roomId:e,sender:t._id,senderModel:t,type:r.type,fileUrl:r.fileUrl,fileName:r.fileName,timestamp:Date.now(),content:r.caption,isSending:!0}]))})},600),setTimeout(()=>{h().forEach(r=>{a(s=>s.some(e=>e._id===r.tempId)?s:o([...s,{_id:r.tempId,roomId:e,sender:t._id,senderModel:t,type:r.type,fileUrl:r.fileUrl,fileName:r.fileName,timestamp:Date.now(),content:r.caption,isSending:!0}]))})},1500),()=>{Object.values(m.current).forEach(e=>{try{e.close()}catch{}}),m.current={}}},[e,t,a]),(0,r.useEffect)(()=>{let r=async r=>{let l=r.data;if(!l||!l.type)return;let o=String(l.uploadId||"");if(!o)return;let c=h().find(e=>e.uploadId===o);if(c)if("UPLOAD_COMPLETE"===l.type&&l.response){let r=l.response;if(r.success){d(e=>{let t={...e};return delete t[c.tempId],t}),a(e=>e.filter(e=>e._id!==c.tempId)),eP(c.tempId),p(c.tempId);let l=r.data,o={...l,_id:l._id||Date.now().toString(),roomId:e,sender:t._id,senderName:t.name,isGroup:n,receiver:n?null:"_id"in s?s._id:"",members:n?s.members:[],type:c.type,timestamp:Date.now(),content:c.caption,batchId:l.batchId};try{await i(o)}catch{}}else d(e=>{let t={...e};return delete t[c.tempId],t}),a(e=>e.filter(e=>e._id!==c.tempId)),eP(c.tempId),p(c.tempId)}else"UPLOAD_FAILED"===l.type&&(d(e=>{let t={...e};return delete t[c.tempId],t}),a(e=>e.filter(e=>e._id!==c.tempId)),eP(c.tempId),p(c.tempId))};return"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",r),()=>{"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",r)}},[e,t,s,n,i,a]),{uploadingFiles:c,handleUploadAndSend:f}}({roomId:tt,currentUser:i,selectedChat:e,isGroup:en,sendMessageProcess:tJ,setMessages:N,onScrollBottom:tW}),t2=Object.values(t0),t5=t2.length>0,t3=t5?t2.reduce((e,t)=>e+t,0)/t2.length:0,t4=t2.length;(0,r.useEffect)(()=>{if(!$.current)return;let e=j[j.length-1],t=e&&String(e.sender)===String(i._id)||t4>0;if(eY||O.current)return;let r=er.current&&!F.current;!t||r||eJ||(tW(),setTimeout(tW,0),setTimeout(tW,250))},[j.length,t4,i._id,tW,eJ]),(0,r.useEffect)(()=>{let e=$.current;if(!e)return;let t=Array.from(e.querySelectorAll("img")),r=()=>{let e=!!tL.current&&Date.now()<tL.current;!F.current||e||tf||eY||tW()};return t.forEach(e=>e.addEventListener("load",r,{once:!0})),()=>{t.forEach(e=>e.removeEventListener("load",r))}},[j.length,tW,tf]);let{memberCount:t6,activeMembers:t8,handleMemberRemoved:t9,handleRoleChange:t7,handleMembersAdded:re}=function({selectedChat:e,isGroup:t,currentUser:s,sendNotifyMessage:n}){let[i,a]=(0,r.useState)(0),[l,o]=(0,r.useState)([]);(0,r.useEffect)(()=>{if(t&&e.members){let t=e.members;o(t),a(t.length)}else o([]),a(0)},[e,t]);let c=(0,r.useCallback)(async(e,t)=>{o(t=>t.filter(t=>String(t._id)!==String(e))),a(e=>Math.max(0,e-1));let r=s.name||"Quản trị viên";await n(`${r} đ\xe3 mời ${t} ra khỏi nh\xf3m.`)},[s.name,n]);return{memberCount:i,activeMembers:l,handleMemberRemoved:c,handleRoleChange:(0,r.useCallback)(async(e,t,r)=>{o(t=>t.map(t=>String(t._id)===String(e)?{...t,role:r}:t));let i=s.name||"Quản trị viên",a="";a="ADMIN"===r?`đ\xe3 bổ nhiệm ${t} l\xe0m ph\xf3 nh\xf3m.`:`đ\xe3 hủy quyền ph\xf3 nh\xf3m của ${t}.`,await n(`${i} ${a}`)},[s.name,n]),handleMembersAdded:(0,r.useCallback)(async e=>{if(!e||0===e.length)return;let t=e.map(e=>({_id:e._id,name:e.name||"Thành viên",avatar:e.avatar,role:"MEMBER",joinedAt:Date.now()}));o(e=>[...e,...t]),a(t=>t+e.length)},[s.name,n])}}({selectedChat:e,isGroup:en,currentUser:i,sendNotifyMessage:tY}),{showMentionMenu:rt,mentionSuggestions:rr,selectedMentionIndex:rs,mentionMenuRef:rn,editableRef:ri,getPlainTextFromEditable:ra,parseMentions:rl,handleInputChangeEditable:ro,handleKeyDownEditable:rc,selectMention:rd,setShowMentionMenu:rm}=function({allUsers:e,activeMembers:t,currentUser:s,allUsersMap:n}){let[i,a]=(0,r.useState)(!1),[l,o]=(0,r.useState)(""),[c,d]=(0,r.useState)(null),[m,u]=(0,r.useState)(0),x=(0,r.useRef)(null),g=(0,r.useRef)(null),p=(0,r.useCallback)(()=>{if(!g.current)return"";let e=new Set(["DIV","P","LI","UL","OL","H1","H2","H3","H4","H5","H6"]),t=r=>{if(r.nodeType===Node.TEXT_NODE)return r.textContent||"";if(r.nodeType===Node.ELEMENT_NODE){if(r.dataset&&r.dataset.mention){let e=r.dataset.userId,t=r.dataset.userName;return`@[${t}](${e})`}if("BR"===r.tagName)return"\n";let s="";return r.childNodes.forEach(e=>{s+=t(e)}),e.has(r.tagName)&&s&&!s.endsWith("\n")&&(s+="\n"),s}return""};return t(g.current)},[]),f=()=>{let e=window.getSelection();if(!e||!g.current||0===e.rangeCount)return 0;let t=e.getRangeAt(0);if(!g.current.contains(t.commonAncestorContainer))return 0;try{let e=t.cloneRange();return e.selectNodeContents(g.current),e.setEnd(t.endContainer,t.endOffset),e.toString().length}catch(e){return console.error("Error getting cursor position:",e),0}},b=(0,r.useMemo)(()=>{let r=t.length>0?t:e,i=s._id,a=r.some(e=>String(e._id||e.id)===String(i))?r:[...r,s];return l?((0,h.normalizeNoAccent)(l),(0,h.hasDiacritics)(l),a.filter(e=>(0,h.accentAwareIncludes)((e=>{if(n){let t=e._id||e.id,r=n.get(String(t));if(r)return r}return e.name||e.name})(e)||"",l))):a},[l,t,e,s,n]),y=e=>{let t,r,s,i,l,m,u;if(null===c||!g.current)return;let h=g.current,x=e._id,p=n?.get(String(x))||e.name||"User",b=f(),y=document.createElement("span");y.contentEditable="false",y.className="inline-flex items-center bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-sm font-medium mx-0.5",y.dataset.mention="true",y.dataset.userId=x,y.dataset.userName=p,y.textContent=`@${p}`;let v=(t=document.createRange(),r=0,s=null,i=0,l=null,m=0,((u=e=>{if(e.nodeType===Node.TEXT_NODE){let t=e.textContent||"",n=r+t.length;!s&&c>=r&&c<=n&&(s=e,i=c-r),!l&&b>=r&&b<=n&&(l=e,m=b-r),r=n}else e.childNodes.forEach(e=>{if(!l&&u(e))return});return!!l})(h),s&&l)?(t.setStart(s,i),t.setEnd(l,m),t):null);if(v){v.deleteContents();let e=document.createTextNode(" ");v.insertNode(y),y.after(e);let t=window.getSelection();if(t){let r=document.createRange();r.setStartAfter(e),r.collapse(!0),t.removeAllRanges(),t.addRange(r)}}else{h.appendChild(y);let e=document.createTextNode(" ");h.appendChild(e);let t=window.getSelection();if(t){let r=document.createRange();r.setStartAfter(e),r.collapse(!0),t.removeAllRanges(),t.addRange(r)}}a(!1),d(null),o(""),setTimeout(()=>{h.focus()},0)};return{showMentionMenu:i,mentionSuggestions:b,selectedMentionIndex:m,mentionMenuRef:x,editableRef:g,getPlainTextFromEditable:p,parseMentions:e=>{let t,r=/@\[([^\]]+)\]\(([^)]+)\)/g,s=[];for(;null!==(t=r.exec(e));)s.push(t[2]);return{mentions:s,displayText:e}},handleInputChangeEditable:()=>{if(!g.current)return;let e=g.current.textContent||"",t=f(),r=e.slice(0,t),s=r.lastIndexOf("@");if(-1!==s){let e=r.slice(s+1);e.includes(" ")||e.includes("\n")?(a(!1),d(null)):(a(!0),o(e),d(s),u(0))}else a(!1),d(null)},handleKeyDownEditable:e=>{i&&("ArrowDown"===e.key?(e.preventDefault(),u(e=>Math.min(e+1,b.length-1))):"ArrowUp"===e.key?(e.preventDefault(),u(e=>Math.max(e-1,0))):"Enter"===e.key?(e.preventDefault(),b[m]&&y(b[m])):"Escape"===e.key&&(a(!1),d(null)))},selectMention:y,setShowMentionMenu:a}}({allUsers:a,activeMembers:t8,currentUser:i}),ru=(0,r.useCallback)(()=>{try{document.activeElement?.blur?.()}catch{}try{ri.current?.blur?.()}catch{}tW(),setTimeout(tW,0),setTimeout(tW,150)},[ri,tW]),rh="__ALL__",rx=(0,r.useMemo)(()=>en?rr.some(e=>e._id===rh)?rr:[...rr,{_id:rh,name:"All",avatar:void 0}]:rr,[en,rr]),rg=(0,r.useCallback)(async(t,r)=>{let s=String(i._id),a=t.reactions||{},l=Object.fromEntries(Object.entries(a).map(([e,t])=>[e,(Array.isArray(t)?t:[]).filter(e=>String(e)!==s)])),o=Array.isArray(a[r])&&a[r].includes(s),c={...l},d=Array.isArray(c[r])?c[r]:[];c[r]=o?d.filter(e=>String(e)!==s):[...d,s],N(e=>e.map(e=>String(e._id)===String(t._id)?{...e,reactions:c}:e));let m={_id:t._id,roomId:tt,reactions:c,sender:i._id,senderName:i.name,isGroup:en,receiver:en?null:eX(e),members:en?e.members:[]};try{if(L.current?.connected)L.current.emit("toggle_reaction",m);else{let e=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});e.on("connect",()=>{e.emit("toggle_reaction",m),setTimeout(()=>e.disconnect(),500)})}}catch(e){console.error("❌ Socket emit error:",e)}try{await (0,B.updateMessageApi)(String(t._id),{reactions:c})}catch(e){console.error("❌ API update error:",e),N(e=>e.map(e=>String(e._id)===String(t._id)?{...e,reactions:a}:e))}},[i._id,i.name,tt,en,e]),rp=(0,r.useCallback)((e,t)=>{let r,s,n,a;e.preventDefault();let l=e.currentTarget.getBoundingClientRect(),o=(n=t.sender?._id,a=t.sender?.id,String(n??a??t.sender??"")===String(i._id)),c="text"===t.type,d=!!t.isRecalled,m=Math.max(44,40*[!d,!d,!d,o&&c&&!d,c&&!d,!!t.fileUrl&&("image"===t.type||"file"===t.type||"sticker"===t.type),o&&!d].filter(Boolean).length+8),u=window.innerWidth,h=window.innerHeight,x="below";c?(r=e.clientX-100,s=e.clientY-m/2):(r=l.left+l.width/2-100,s=l.top+l.height/2-m/2),r+200>u&&(r=u-200-8),r<8&&(r=8),s+m>h&&(s=Math.max(8,h-m-8),x="above"),s<8&&(s=8),q({visible:!0,x:r,y:s,placement:x,message:t})},[i._id]),rf=(0,r.useCallback)((e,t,r,s)=>{try{let r,s=t.getBoundingClientRect(),n=window.innerHeight,i=window.innerWidth,a=String(e.type||""),l="image"===a,o=Math.floor(n*(l?.5:.34)),c=l?o:Math.min(s.height,o);try{t.scrollIntoView({behavior:"auto",block:"center"})}catch{}let d=c>.3*n,m=c>.22*n,u=Math.floor(n*(d?.12:m?.16:.2)),x=(r=n-c-260-20,Math.max(8,Math.min(u,r))),g=x+c+16,p=e;try{let t=j.findIndex(t=>String(t._id)===String(e._id)),r=String(e.type||""),s="image"===r||"video"===r,n="file"===r&&!(e.fileUrl&&(0,h.isVideoFile)(String(e.fileUrl)));if(t>=0&&(s||n)){let r,n,i=(r=e.sender?._id,n=e.sender?.id,String(r??n??e.sender??"")),a=[j[t]];for(let e=t+1;e<j.length;e+=1){let t=j[e];if(t.isRecalled)break;let r=String(t.type||""),n="image"===r||"video"===r,l="file"===r&&!(t.fileUrl&&(0,h.isVideoFile)(String(t.fileUrl)));if(s?!n:!l)break;let o=(()=>{let e=t.sender?._id,r=t.sender?.id;return String(e??r??t.sender??"")})(),c=Math.abs(Number(t.timestamp)-Number(a[a.length-1].timestamp));if(o!==i||c>12e4)break;a.push(t)}if(a.length>1){let t=a.map(e=>({id:String(e._id),content:e.content||"",type:"video"===e.type?"video":"image"===e.type?"image":"file",fileUrl:String(e.fileUrl||e.previewUrl||""),fileName:e.fileName}));p={...e,batchItems:t}}}}catch{}q({visible:!0,x:Math.floor(i/2),y:Math.max(8,g),placement:"below",message:p,focusTop:x,focusHeight:c})}catch{}},[j]),rb=(0,r.useCallback)(()=>{q(null)},[]),{playMessageSound:ry,showMessageNotification:rv,flashTabTitle:rw}=(0,eB.useChatNotifications)({chatName:tp});(0,r.useEffect)(()=>{if(!K?.visible)return;let e=e=>{let t=e.target,r=document.querySelector('[data-context-menu="true"]');r&&r.contains(t)||rb()};return setTimeout(()=>{document.addEventListener("mousedown",e)},0),()=>document.removeEventListener("mousedown",e)},[K,rb]),(0,r.useEffect)(()=>{if(!K?.visible)return;let e=document.querySelector('[data-context-menu="true"]');if(!e)return;let t=e.getBoundingClientRect(),r=K.x,s=K.y,n=K.placement??"below",i=window.innerWidth,a=window.innerHeight;r+t.width+8>i&&(r=i-t.width-8),r<8&&(r=8),s+t.height+8>a&&(s=Math.max(8,s-t.height),n="above"),s<8&&(s=8),(r!==K.x||s!==K.y||n!==K.placement)&&q({...K,x:r,y:s,placement:n})},[K]),(0,r.useEffect)(()=>{if(!K?.visible)return;let e=$.current;if(!e)return;let t=()=>{rb()};return e.addEventListener("scroll",t,{passive:!0}),()=>e.removeEventListener("scroll",t)},[K,rb]),(0,r.useEffect)(()=>{m&&(R.current=!0,setTimeout(()=>{tv(m),"function"==typeof u&&u()},50))},[m,tv,u]),(0,r.useEffect)(()=>{let e=$.current;e&&(!t$||!tf)&&(R.current||!(j.length>0)||O.current||m||(e.scrollTop=e.scrollHeight,R.current=!0))},[j.length,tt,m,t$,tf]);let rj=(0,r.useMemo)(()=>{let e,t,r,s;return e=new Map,t=new Set,j.forEach(r=>{let s=String(r._id);if(t.has(s))return;t.add(s);let n=new Date(Number(r.serverTimestamp??r.timestamp)||0).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric"});e.has(n)||e.set(n,[]),e.get(n).push(r)}),r=e=>{let t=Number(e);return Number.isFinite(t)?t:0},s=(e,t)=>{let s=r(e.serverTimestamp??e.timestamp),n=r(t.serverTimestamp??t.timestamp);if(s!==n)return s-n;let i=String(e._id||""),a=String(t._id||"");return i.startsWith("temp_")&&!a.startsWith("temp_")?1:!i.startsWith("temp_")&&a.startsWith("temp_")?-1:i.localeCompare(a)},Array.from(e.values()).forEach(e=>e.sort(s)),e},[j]),[rN,rS]=(0,r.useState)(null),[rk,rC]=(0,r.useState)(!1),r_=async(e,t,r)=>{let s=r?.trim(),n={...e,isPinned:t,pinnedTitle:s,pinnedAt:t?Date.now():null};el(t?n:null);try{if((await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"togglePin",messageId:e._id,data:{isPinned:t,pinnedTitle:s}})})).ok){N(r=>r.map(r=>r._id===e._id?{...r,isPinned:t,pinnedTitle:s,pinnedAt:t?Date.now():null}:r)),ec(r=>{let n={...e,isPinned:t,pinnedTitle:s,editedAt:Date.now(),pinnedAt:t?Date.now():null},i=r.filter(t=>String(t._id)!==String(e._id));return(t?[n,...i]:i).sort((e,t)=>Number(t.pinnedAt??0)-Number(e.pinnedAt??0))}),L.current?.emit("edit_message",{_id:e._id,roomId:tt,isPinned:t,pinnedTitle:s,pinnedAt:t?Date.now():null});let r=t?"đã ghim":"đã bỏ ghim",n=i.name||"Một thành viên",a="";a="text"===e.type?`${n} ${r} một tin nhắn văn bản.`:"image"===e.type?`${n} ${r} một h\xecnh ảnh.`:"file"===e.type?`${n} ${r} tệp tin "${e.fileName||"file"}".`:"poll"===e.type?`${n} ${r} một b\xecnh chọn.`:`${n} ${r} một tin nhắn.`,t&&s&&(a+=` Ti\xeau đề: "${s}"`),await tY(a)}else el(e.isPinned?e:null),console.error("API togglePin failed")}catch(t){console.error("Ghim tin nhắn thất bại",t),el(e.isPinned?e:null)}},rT=async e=>{e.isPinned?r_(e,!1):(rS(e),rC(!0))};(0,r.useEffect)(()=>{j.length>0?el(j.find(e=>e.isPinned)||null):el(null)},[j]);let rM=(0,r.useCallback)(async()=>{if(!tt||eJ||!eU||null==eq)return;let e=$.current;eK(!0),Y(!0);let t=e?e.scrollHeight:0,r=!1;try{let s=await (0,B.readMessagesApi)(tt,{limit:20,before:eq,sortOrder:"desc"}),n=Array.isArray(s.data)?s.data:[],i=new Set(j.map(e=>String(e._id))),a=n.filter(e=>!i.has(String(e._id))).slice().reverse();if(a.length>0){N(e=>[...a,...e]);let e=a[0]?.timestamp??eq;eQ(e??eq),r=!0}eF(20===n.length),e&&!O.current&&setTimeout(()=>{let r=e.scrollHeight;e.scrollTop=r-t+80},0)}catch(e){console.error("Load more messages error:",e),eF(!1)}finally{eK(!1)}return r},[tt,eJ,eU,eq,j]);(0,r.useEffect)(()=>{let e=$.current;if(!e)return;let t=()=>{!(e.scrollTop<=50)||O.current||tf||!R.current||eY||rM();let t=e.scrollHeight-e.scrollTop-e.clientHeight,r=t<=80;F.current=r,!r&&t>60&&(er.current=!0),r&&!eJ&&(er.current=!1,ee(0),et.current=0),Y(er.current||et.current>0||eJ)};return e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)},[rM,eJ]);let rA=(0,r.useCallback)(e=>{ea(e)},[]);(0,r.useEffect)(()=>{if(!m)return;let e=setTimeout(()=>{tv(m),u?.()},0);return()=>clearTimeout(e)},[m,eY,eq,j.length,tv,u]),(0,r.useEffect)(()=>{tW(),setTimeout(tW,50),setTimeout(tW,150)},[z,G,ei,rt,e0.length,tW]),(0,r.useEffect)(()=>{let e=()=>{tW(),setTimeout(tW,50),setTimeout(tW,150)};return window.addEventListener("mobileActionsToggle",e),()=>window.removeEventListener("mobileActionsToggle",e)},[tW]),(0,r.useEffect)(()=>{let e=e=>{String((e.detail||{}).roomId)===String(tt)&&(N([]),ec([]),eF(!1),eQ(null))};return window.addEventListener("chatHistoryCleared",e),()=>window.removeEventListener("chatHistoryCleared",e)},[tt]);let{isListening:rE,handleVoiceInput:r$}=function({editableRef:e,handleInputChangeEditable:t}){let[s,n]=(0,r.useState)(!1),i=(0,r.useRef)(null),a=(0,r.useCallback)(async()=>{let r=window.SpeechRecognition||window.webkitSpeechRecognition;if(!r)return void alert("Trình duyệt của bạn không hỗ trợ chức năng này. Vui lòng dùng Chrome hoặc Edge.");if(s){i.current&&i.current.stop(),n(!1);return}let a="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;if(!(window.isSecureContext||"https:"===window.location.protocol)&&!a)return void alert("Vui lòng truy cập qua HTTPS hoặc localhost để sử dụng nhập bằng giọng nói.");try{"undefined"!=typeof navigator&&navigator.mediaDevices?.getUserMedia&&(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch{alert("Vui lòng cấp quyền microphone cho trình duyệt để sử dụng nhập bằng giọng nói.");return}let l=new r;l.lang="vi-VN",l.continuous=!1,l.interimResults=!1,l.onstart=()=>{n(!0)},l.onend=()=>{n(!1)},l.onresult=r=>{let s=r.results[0][0].transcript,n=e.current;n&&(n.focus(),eO(n,s),t())},l.onerror=e=>{"not-allowed"===(e.error||"").toLowerCase()&&alert("Truy cập microphone bị từ chối. Vui lòng cấp quyền trong cài đặt trình duyệt."),n(!1)},i.current=l,l.start()},[s,e,t]);return{isListening:s,handleVoiceInput:a}}({editableRef:ri,handleInputChangeEditable:ro}),rI=(0,r.useCallback)(e=>{if(!ri.current)return;let t=ri.current,r=(e=>{let t="string"==typeof e?e:e.emoji;if(/^[0-9a-fA-F-]+$/.test(t)){let e=t.split("-").map(e=>parseInt(e,16)).filter(e=>!Number.isNaN(e));if(e.length>0)return String.fromCodePoint(...e)}return t})(e);t.focus(),eO(t,r),ro()},[ri,ro]),rL=(0,r.useCallback)(async e=>{tX();let t={roomId:tt,sender:i._id,fileUrl:e,type:"sticker",timestamp:Date.now()};await tJ(t),V(!1)},[tt,i._id,tJ,tX]),rP=(0,r.useCallback)(async()=>{try{ek(!0);let e=await (0,B.readPinnedMessagesApi)(tt,{limit:10,skip:0}),t=e.data||[];ec(t);let r=e.total;ej("number"==typeof r?r:null),ev(t.length)}catch(e){console.error("Fetch Pinned messages error:",e),ec([]),ej(null),ev(0)}finally{ek(!1)}},[tt,10]),rH=(0,r.useCallback)(async()=>{try{let e;eZ(!0);let t=0,r=new Map,s=e=>{let t=String(e||"");return"text"===t||"image"===t||"video"===t};for(;;){let n=await (0,B.readMessagesApi)(tt,{limit:50,sortOrder:"desc",before:e}),i=Array.isArray(n.data)?n.data:[];if(t=i.length,0===i.length)break;i.forEach(e=>{let t=String(e._id);r.has(t)||r.set(t,e)});let a=Array.from(r.values()).sort((e,t)=>{let r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(t.serverTimestamp??t.timestamp)||0;if(s!==r)return s-r;let n=String(e._id||"");return String(t._id||"").localeCompare(n)}).reduce((e,t)=>e+ +!!s(t.type),0),l=i.reduce((e,t)=>{let r=Number(t.serverTimestamp??t.timestamp)||0;return null===e||r<e?r:e},null);if(e="number"==typeof l?l:void 0,a>=20||i.length<50)break}let n=Array.from(r.values()).sort((e,t)=>{let r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(t.serverTimestamp??t.timestamp)||0;if(s!==r)return s-r;let n=String(e._id||"");return String(t._id||"").localeCompare(n)}).slice().reverse();N(n);try{let e=localStorage.getItem(`pendingUploads:${tt}`),t=e?JSON.parse(e):[];Array.isArray(t)&&t.length>0&&N(e=>{let r=new Set(e.map(e=>String(e._id))),s=t.filter(e=>!r.has(String(e.tempId))).map(e=>({_id:e.tempId,roomId:tt,sender:i._id,senderModel:i,type:e.type,fileUrl:e.fileUrl,fileName:e.fileName,timestamp:Date.now(),content:e.caption,isSending:!0})),n=[...e,...s];return n.sort((e,t)=>{let r=Number(e.timestamp)||0,s=Number(t.timestamp)||0;return r-s}),n})}catch{}let a=n[0]?.timestamp??null;eQ(a??null),eF(t>=50||n.length>0),eZ(!1)}catch(e){console.error("Fetch messages error:",e),N([]),eF(!1),eQ(null),eZ(!1)}},[tt]),rU=(0,r.useCallback)(async()=>{if(eS)return;let e=ew??0;if(!(e>0)||!(eo.length>=e))try{ek(!0);let e=await (0,B.readPinnedMessagesApi)(tt,{limit:10,skip:ep}),t=e.data||[];t.length>0&&(ec(e=>{let r=new Set(e.map(e=>String(e._id)));return[...e,...t.filter(e=>!r.has(String(e._id)))].sort((e,t)=>Number(t.pinnedAt??0)-Number(e.pinnedAt??0))}),ev(e=>e+t.length));let r=e.total,s="number"==typeof r?r:ew;ej(s)}catch(e){console.error("Load more pinned messages error:",e)}finally{ek(!1)}},[eS,ew,eo.length,tt,10,ep]);(0,r.useEffect)(()=>{tt&&(N([]),rH(),ec([]),ev(0),ej(null),rP(),R.current=!1)},[tt,rH,rP]),(0,r.useEffect)(()=>{tt&&rH()},[e,tt,rH]);let[rR,rD]=(0,r.useState)(0),rO=(0,r.useMemo)(()=>{let e=new Map,t=String(i?._id||""),r={};try{let e=tt&&t?localStorage.getItem(`roomNicknames:${tt}:${t}`):null;r=e?JSON.parse(e):{}}catch{}if(i){let t=r[String(i._id)]||i.name||"Bạn";i._id&&e.set(String(i._id),t)}return Array.isArray(a)&&a.forEach(s=>{let n=r[String(s._id)]||s.nicknames?.[t]||s.name;n&&s._id&&e.set(String(s._id),n)}),en&&Array.isArray(t8)&&t8.forEach(r=>{let s=r.nickname||r.nicknames?.[t]||r.name||"Thành viên";r._id&&e.set(String(r._id),s)}),e},[i,a,en,t8,tt,rR]);(0,r.useEffect)(()=>{let e=e=>{let t=e.detail||{},r="video"===t.type?"video":"image",s=String(i._id);if(rO.get(s)||i.name,"image"===r&&"string"==typeof t.imageDataUrl)try{let e=t.imageDataUrl.split(","),r=e[0].match(/:(.*?);/)?.[1]||"image/jpeg",s=atob(e[1]),n=s.length,i=new Uint8Array(n);for(;n--;)i[n]=s.charCodeAt(n);let a=new Blob([i],{type:r}),l=new File([a],"edited.jpg",{type:r}),o=URL.createObjectURL(a);e1(e=>[...e,{file:l,type:"image",previewUrl:o,fileName:"edited.jpg"}]),ru()}catch{}else"video"===r&&"string"==typeof t.originalUrl&&(async()=>{try{let e=await fetch((0,h.getProxyUrl)(t.originalUrl)),r=await e.blob(),s=r.type||"video/mp4",n=new File([r],"edited.mp4",{type:s}),i=URL.createObjectURL(r);e1(e=>[...e,{file:n,type:"video",previewUrl:i,fileName:"edited.mp4",videoCropConfig:t.videoCropConfig||null}]),ru()}catch{}})()};return window.addEventListener("sendEditedMedia",e),()=>window.removeEventListener("sendEditedMedia",e)},[i._id,rO,t1,ru]),(0,r.useEffect)(()=>{let e=e=>{let t=e.detail||{};if(String(t.roomId)===String(tt)&&(rD(e=>e+1),en&&t.targetUserId))try{let e="string"==typeof t.nickname?t.nickname:"";L.current?.emit("room_nickname_updated",{roomId:tt,targetUserId:String(t.targetUserId),nickname:e})}catch{}};return window.addEventListener("roomNicknamesUpdated",e),()=>window.removeEventListener("roomNicknamesUpdated",e)},[tt]),(0,r.useEffect)(()=>{if(tt)return L.current&&L.current.connected||(L.current=(0,n.default)((0,h.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),H(L.current)),L.current.on("receive_message",e=>{if(String(e.roomId)!==String(tt))return;if(N(t=>{let r=String(e._id);if(t.some(e=>String(e._id)===r))return tQ(t.map(t=>String(t._id)===r?{...t,...e}:t));let s=new Map;return[...t,e].forEach(e=>s.set(String(e._id),e)),Array.from(s.values()).sort((e,t)=>{let r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(t.serverTimestamp??t.timestamp)||0;if(r!==s)return r-s;let n=String(e._id||""),i=String(t._id||"");return n.startsWith("temp_")&&!i.startsWith("temp_")?1:!n.startsWith("temp_")&&i.startsWith("temp_")?-1:n.localeCompare(i)})}),"poll"===e.type){let t=e.pollEndAt,r=!!e.isPollLocked;"number"!=typeof t||r||tZ(e)}e.sender===i._id||tr||(ry(),rv(e),rw());let t=!!tL.current&&Date.now()<tL.current,r=$.current,s=r?r.scrollHeight-r.scrollTop-r.clientHeight:0,n=s<=80;if(t||e.sender!==i._id&&!n&&s>60){if(e.sender!==i._id&&(ee(e=>{let t=e+1;return et.current=t,t}),Y(er.current||et.current>0),n)){(0,B.markAsReadApi)(tt,String(i._id)),es();try{L.current?.emit("messages_read",{roomId:tt,userId:String(i._id)})}catch{}}}else if(tW(),setTimeout(tW,0),setTimeout(tW,150),setTimeout(tW,300),ee(0),et.current=0,er.current=!1,Y(!1),e.sender!==i._id){(0,B.markAsReadApi)(tt,String(i._id)),es();try{L.current?.emit("messages_read",{roomId:tt,userId:String(i._id)})}catch{}}}),L.current.on("room_nickname_updated",e=>{String(e.roomId)===String(tt)&&c?.()}),L.current.on("room_nicknames_state",e=>{if(String(e.roomId)===String(tt)){try{let t=String(i._id||""),r=`roomNicknames:${tt}:${t}`,s=e.map||{};localStorage.setItem(r,JSON.stringify(s))}catch{}rD(e=>e+1)}}),L.current.on("reaction_updated",e=>{String(e.roomId)===String(tt)&&N(t=>t.map(t=>String(t._id)===String(e._id)?{...t,reactions:e.reactions}:t))}),L.current.on("messages_read",e=>{if(String(e.roomId)!==String(tt))return;let t=String(e.userId||""),r=String(i._id||"");if(!t||rX(t,r))return;let s=[...e6.current].slice().reverse().find(e=>rX(e.sender,r)&&!e.isRecalled);s&&N(e=>e.map(e=>{if(String(e._id)!==String(s._id))return e;let r=new Set((e.readBy||[]).map(e=>String(e)));return r.has(t)?e:{...e,readBy:[...r,t]}}))}),L.current.on("room_nickname_updated",e=>{String(e.roomId)===String(tt)&&(c?.(),rD(Date.now()))}),L.current.on("edit_message",e=>{if(String(e.roomId)===String(tt)){N(t=>[...t.map(t=>String(t._id)===String(e._id)?{...t,content:e.content??t.content,editedAt:e.editedAt,originalContent:e.originalContent||t.originalContent||t.content,reminderAt:e.reminderAt??t.reminderAt,reminderNote:e.reminderNote??t.reminderNote,pollQuestion:e.pollQuestion??t.pollQuestion,pollOptions:e.pollOptions??t.pollOptions,pollVotes:e.pollVotes??t.pollVotes,isPollLocked:e.isPollLocked??t.isPollLocked,pollLockedAt:e.pollLockedAt??t.pollLockedAt,pollAllowMultiple:e.pollAllowMultiple??t.pollAllowMultiple,pollAllowAddOptions:e.pollAllowAddOptions??t.pollAllowAddOptions,pollHideVoters:e.pollHideVoters??t.pollHideVoters,pollHideResultsUntilVote:e.pollHideResultsUntilVote??t.pollHideResultsUntilVote,pollEndAt:void 0!==e.pollEndAt?e.pollEndAt:t.pollEndAt,timestamp:e.timestamp??t.timestamp,isPinned:"boolean"==typeof e.isPinned?e.isPinned:t.isPinned,pinnedAt:void 0!==e.pinnedAt?e.pinnedAt:t.pinnedAt,reactions:e.reactions??t.reactions}:t)].sort((e,t)=>{let r=Number(e.serverTimestamp??e.timestamp)||0,s=Number(t.serverTimestamp??t.timestamp)||0;if(r!==s)return r-s;let n=String(e._id||""),i=String(t._id||"");return n.startsWith("temp_")&&!i.startsWith("temp_")?1:!n.startsWith("temp_")&&i.startsWith("temp_")?-1:n.localeCompare(i)})),"boolean"==typeof e.isPinned&&ec(t=>{let r=e6.current.find(t=>String(t._id)===String(e._id)),s=r?{...r,content:e.content??r.content,pollQuestion:e.pollQuestion??r.pollQuestion,pollOptions:e.pollOptions??r.pollOptions,pollVotes:e.pollVotes??r.pollVotes,isPollLocked:e.isPollLocked??r.isPollLocked,pollLockedAt:e.pollLockedAt??r.pollLockedAt,timestamp:e.timestamp??r.timestamp,editedAt:e.editedAt??r.editedAt,isPinned:e.isPinned,pinnedTitle:e.pinnedTitle??r.pinnedTitle,pinnedAt:void 0!==e.pinnedAt?e.pinnedAt:r.pinnedAt}:{_id:e._id,roomId:tt,sender:i._id,content:e.content||"",type:"text",timestamp:e.timestamp||Date.now(),editedAt:e.editedAt||Date.now(),isPinned:e.isPinned,pinnedTitle:e.pinnedTitle,pinnedAt:void 0!==e.pinnedAt?e.pinnedAt:Date.now()},n=t.filter(t=>String(t._id)!==String(e._id));return(e.isPinned?[s,...n]:n).sort((e,t)=>Number(t.pinnedAt??0)-Number(e.pinnedAt??0))});let t=String(e._id),r=e5.current.get(t);r&&(clearTimeout(r),e5.current.delete(t),e2.current.delete(t));let s=Date.now(),n="number"==typeof e.reminderAt?e.reminderAt:void 0;if("number"==typeof n){let e=Math.max(0,n-s),r=window.setTimeout(async()=>{let e=e6.current.find(e=>String(e._id)===t);if(!e||e.isRecalled){e2.current.delete(t);let e=e5.current.get(t);e&&(clearTimeout(e),e5.current.delete(t));return}let r=e.reminderAt||e.timestamp;try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:e._id})}),s=await t.json(),n=s&&(s.row?.row||s.row),i=n&&n.reminderAt;"number"==typeof i&&(r=i)}catch{}let s=Date.now();if(r>s){let e=Math.max(0,r-s),n=window.setTimeout(async()=>{let e=e6.current.find(e=>String(e._id)===t);if(!e||e.isRecalled){e2.current.delete(t);let e=e5.current.get(t);e&&(clearTimeout(e),e5.current.delete(t));return}let r=new Date(e.reminderAt||e.timestamp).toLocaleString("vi-VN");try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",field:"_id",value:e._id,data:{reminderFired:!0}})}),s=await t.json();s?.success&&await tY(`Đến giờ lịch hẹn: "${e.content||""}" l\xfac ${r}`,String(e._id))}catch{}e2.current.delete(t),e5.current.delete(t)},e);e5.current.set(t,n);return}let n=new Date(r).toLocaleString("vi-VN");try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",field:"_id",value:e._id,data:{reminderFired:!0}})}),r=await t.json();r?.success&&await tY(`Đến giờ lịch hẹn: "${e.content||""}" l\xfac ${n}`,String(e._id))}catch{}e2.current.delete(t),e5.current.delete(t)},e);e5.current.set(t,r),e2.current.add(t)}let a=e4.current.get(t);a&&(clearTimeout(a),e4.current.delete(t),e3.current.delete(t));let l=e.pollEndAt;if("number"==typeof l&&!e.isPollLocked){let r=e6.current.find(e=>String(e._id)===t);tZ(r?{...r,pollEndAt:l,isPollLocked:e.isPollLocked}:{_id:e._id,roomId:e.roomId,pollEndAt:l,isPollLocked:e.isPollLocked})}}}),L.current.on("edit_message",e=>{if(String(e.roomId)===String(tt)){N(t=>t.map(t=>String(t._id)===String(e._id)?{...t,content:e.newContent??e.content??t.content,editedAt:e.editedAt,originalContent:e.originalContent||t.originalContent||t.content,timestamp:"number"==typeof e.timestamp?e.timestamp:t.timestamp}:t));let t=String(e._id),r=e5.current.get(t);r&&(clearTimeout(r),e5.current.delete(t),e2.current.delete(t))}}),L.current.on("message_recalled",e=>{if(e.roomId===tt){N(t=>t.map(t=>t._id===e._id?{...t,isRecalled:!0}:t));let t=String(e._id),r=e5.current.get(t);r&&(clearTimeout(r),e5.current.delete(t),e2.current.delete(t));let s=e4.current.get(t);s&&(clearTimeout(s),e4.current.delete(t)),e3.current.delete(t)}}),L.current.on("message_deleted",e=>{if(e.roomId===tt){N(t=>t.filter(t=>t._id!==e._id));let t=String(e._id),r=e5.current.get(t);r&&(clearTimeout(r),e5.current.delete(t)),e2.current.delete(t);let s=e4.current.get(t);s&&(clearTimeout(s),e4.current.delete(t)),e3.current.delete(t),rH()}}),L.current.emit("join_room",tt),L.current.emit("join_user",{userId:String(i._id)}),()=>{try{L.current?.off("receive_message"),L.current?.off("room_nickname_updated"),L.current?.off("room_nicknames_state"),L.current?.off("reaction_updated"),L.current?.off("messages_read"),L.current?.off("edit_message"),L.current?.off("message_recalled"),L.current?.off("message_deleted")}catch{}H(null)}},[tt,i._id,ry,rv,rH,tY,y]),(0,r.useEffect)(()=>{j.forEach(e=>{let t=String(e._id),r=e3.current.has(t),s=e.pollEndAt,n=!!e.isPollLocked;if("number"!=typeof s||n||r||tZ(e),(null==s||n)&&r){let e=e4.current.get(t);e&&(clearTimeout(e),e4.current.delete(t)),e3.current.delete(t)}})},[j,tZ]),(0,r.useEffect)(()=>{let e=I.current;if(!e)return;let t=e=>!!e&&!!(e.closest('[contenteditable="true"]')||e.closest(".overflow-y-auto")),r=e=>{t(e.target)||e.preventDefault()},s=e=>{t(e.target)||e.preventDefault()};return e.addEventListener("touchmove",r,{passive:!1}),e.addEventListener("wheel",s,{passive:!1}),()=>{e.removeEventListener("touchmove",r),e.removeEventListener("wheel",s)}},[]);let rB=async t=>{if(confirm("Bạn có chắc chắn muốn thu hồi tin nhắn này?"))try{let r=await (0,B.recallMessageApi)(tt,t);if(r.success){N(e=>e.map(e=>e._id===t?{...e,isRecalled:!0}:e));let r={_id:t,roomId:tt,sender:i._id,isGroup:en,receiver:en?null:eX(e),members:en?e.members:[],type:"recall",content:"đã thu hồi tin nhắn",timestamp:Date.now()};L.current?.emit("recall_message",r)}else r.message&&alert("Không thể thu hồi: "+r.message)}catch(e){console.error("Recall error:",e)}},rF=(0,r.useCallback)(async()=>{if(tt&&i)try{await (0,B.markAsReadApi)(tt,eX(i)),U.current=tt;try{L.current?.emit("messages_read",{roomId:tt,userId:eX(i)})}catch{}}catch(e){console.error("Mark as read failed:",e)}},[tt,i,c]);(0,r.useEffect)(()=>{tt&&i&&U.current!==tt&&(rF(),es())},[tt,i,rF]),(0,r.useEffect)(()=>{let e=e=>{rn.current&&!rn.current.contains(e.target)&&rm(!1)};return rt&&document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[rt,rn,rm]),(0,r.useEffect)(()=>{let e=e=>{let t=e.target,r=I.current,s=ri.current;if(s&&document.activeElement===s&&!(r&&t&&r.contains(t))){try{s.blur()}catch{}V(!1)}};return document.addEventListener("mousedown",e,!0),document.addEventListener("touchstart",e,!0),()=>{document.removeEventListener("mousedown",e,!0),document.removeEventListener("touchstart",e,!0)}},[ri,I,V]);let rz=(0,r.useCallback)(()=>{try{ri.current?.blur?.()}catch{}setTimeout(()=>V(e=>!e),120)},[ri,V]),rV=e=>{let t=rW(e),r=rO.get(t);if(r)return r;let s=Number(t);if(!Number.isNaN(s)){let e=String(s),t=rO.get(e);if(t)return t}return"object"==typeof e&&e&&"name"in e&&e.name?e.name:"Người dùng"},rG=async()=>{if(!ri.current)return;let e=ra().trim(),t=e0.length>0;if(!e&&!t)return;let{mentions:r,displayText:s}=rl(e),n=s;try{let e=localStorage.getItem(`chatFlashActiveFolder:${tt}`),t=e?JSON.parse(e):null,r=t?.id,s="true"===localStorage.getItem(`chatFlashEnabled:${tt}`);if(r&&s){let e=localStorage.getItem(`chatFlashKV:${tt}:${r}`),t=e?JSON.parse(e):[],s=new Map((Array.isArray(t)?t:[]).map(e=>[String(e.key),String(e.value)]));n=String(n).replace(/(^|\s)\/([\w-]+)/g,(e,t,r)=>{let n=s.get(r);return null!=n?t+n:e})}}catch{}let a=ei?rV(ei.sender):void 0,l=new Set;r.forEach(e=>{"__ALL__"===e?t8.forEach(e=>{let t=String(e._id||e.id||"");t&&l.add(t)}):l.add(e)});let o=Array.from(l);ri.current&&(ri.current.innerHTML="");let c=[];if(t&&(c=[...e0],e1([])),e){let e=String(i._id),t=rO.get(e)||i.name,r={roomId:tt,sender:i._id,senderName:t,content:n,type:"text",timestamp:Date.now(),replyToMessageId:ei?._id,replyToMessageName:a,mentions:o.length>0?o:void 0};await tJ(r)}if(t){let e=String(i._id),t=rO.get(e)||i.name,r=`batch_${Date.now()}_${Math.random().toString(36).slice(2)}`;c.forEach(e=>{t1(e.file,e.type,void 0,ei?._id,void 0,t,r,e.videoCropConfig||null).then(()=>{try{URL.revokeObjectURL(e.previewUrl)}catch{}})})}try{let e=ri.current;if(e)if(t)ru();else{e.focus();let t=document.createRange();t.selectNodeContents(e),t.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(t)}}catch{}};function rW(e){if(!e)return"";if("string"==typeof e)return e;if("number"==typeof e)return String(e);if("object"==typeof e&&null!==e){if("_id"in e)return rW(e._id);if("id"in e)return rW(e.id)}return String(e)}function rX(e,t){let r=rW(e),s=rW(t);if(r===s)return!0;let n=Number(r),i=Number(s);return!(isNaN(n)||isNaN(i))&&n===i}let rJ=(0,r.useMemo)(()=>({currentUser:i,allUsers:a,selectedChat:e,messages:j,isGroup:en,chatName:tp}),[i,a,e,j,en,tp]),rK=async(t,r)=>{if(!r.trim())return;let s=j.find(e=>e._id===t);if(!s)return;let n=Date.now(),a=s.originalContent||s.content||"";N(e=>e.map(e=>e._id===t?{...e,content:r,editedAt:n,originalContent:a}:e)),eM(null);try{await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"editMessage",data:{messageId:t,newContent:r}})});let s=String(i._id),l=rO.get(s)||i.name,o={_id:t,roomId:tt,newContent:r,editedAt:n,originalContent:a,sender:i._id,senderName:l,isGroup:en,receiver:en?null:eX(e),members:en?e.members:[]};L.current?.emit("edit_message",o)}catch(e){console.error("❌ [CLIENT] Chỉnh sửa thất bại:",e),alert("Lỗi khi lưu chỉnh sửa."),N(e=>e.map(e=>e._id===t?s:e))}},rq=(0,r.useCallback)(e=>{te(e),e9(!0)},[]),rQ=(0,r.useCallback)(async(e,t,r)=>{try{let s="",n=rV(t.sender);"text"===t.type&&(s=t.content||"");let a=t.batchItems||[],l=Array.isArray(b)?b:[];for(let o of e){let e=l.some(e=>String(e._id)===String(o)),c=String(i._id),d=rO.get(c)||i.name,m={roomId:o,sender:i._id,type:t.type,content:"text"===t.type?s:t.content,fileUrl:t.fileUrl,fileName:t.fileName,timestamp:Date.now(),sharedFrom:{messageId:String(t._id),originalSender:n,originalRoomId:String(t.roomId)}};if(r&&r.trim()){let t={roomId:o,sender:i._id,senderName:d,content:r.trim(),type:"text",timestamp:Date.now()},s=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:t})}),n=await s.json();if(n.success&&"string"==typeof n._id){let r=e?{roomId:o,sender:i._id,senderName:d,isGroup:!0,receiver:null,members:l.find(e=>String(e._id)===String(o))?.members||[]}:{roomId:o,sender:i._id,senderName:d,isGroup:!1,receiver:o.split("_").find(e=>e!==String(i._id)),members:[]};L.current?.emit("send_message",{...r,...t,_id:n._id})}}if(a.length>0){let r=`${String(t._id)}-${Date.now()}`;for(let s of a){let a={roomId:o,sender:i._id,type:s.type,content:"text"===s.type?s.content:void 0,fileUrl:s.fileUrl,fileName:s.fileName,timestamp:Date.now(),batchId:r,sharedFrom:{messageId:String(s.id||t._id),originalSender:n,originalRoomId:String(t.roomId)}},c=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:a})}),m=await c.json();if(m.success&&"string"==typeof m._id){let t=e?{roomId:o,sender:i._id,senderName:d,isGroup:!0,receiver:null,members:l.find(e=>String(e._id)===String(o))?.members||[]}:{roomId:o,sender:i._id,senderName:d,isGroup:!1,receiver:o.split("_").find(e=>e!==String(i._id)),members:[]};L.current?.emit("send_message",{...t,...a,_id:m._id})}}}else{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:m})}),r=await t.json();if(r.success&&"string"==typeof r._id){let t=e?{roomId:o,sender:i._id,senderName:d,isGroup:!0,receiver:null,members:l.find(e=>String(e._id)===String(o))?.members||[]}:{roomId:o,sender:i._id,senderName:d,isGroup:!1,receiver:o.split("_").find(e=>e!==String(i._id)),members:[]};L.current?.emit("send_message",{...t,...m,_id:r._id})}}}}catch(e){throw console.error("Share message error:",e),e}},[i,b,rV]);(0,r.useEffect)(()=>{let e=async e=>{try{let t=e.detail||{},r=String(t.messageId||"");if(!r)return;let s=j.find(e=>String(e._id)===r);if(s)return void rq(s);try{let e=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:r})}),t=await e.json(),s=t&&(t.row?.row||t.row);s&&String(s.roomId)===tt&&rq(s)}catch{}}catch{}};return window.addEventListener("shareMessage",e),()=>window.removeEventListener("shareMessage",e)},[j,rq,tt]),(0,r.useEffect)(()=>{let e=e=>{let t=e.detail;t&&String(t.roomId)===String(tt)&&L.current?.emit("room_nickname_updated",t)};return window.addEventListener("roomNicknamesUpdated",e),()=>window.removeEventListener("roomNicknamesUpdated",e)},[tt]);let rY=(0,r.useRef)(null),rZ=(0,r.useCallback)(()=>{let e=window.visualViewport;if(!e)return;let t=document.documentElement;t.style.setProperty("--vvh",`${e.height}px`),t.style.setProperty("--vvw",`${e.width}px`),t.style.setProperty("--vvTop",`${e.offsetTop||0}px`),t.style.setProperty("--vvLeft",`${e.offsetLeft||0}px`)},[]);return(0,r.useEffect)(()=>{let e=()=>{if(!rY.current||!window.visualViewport)return;let e=window.visualViewport;window.scrollTo(0,0),rY.current.style.height=`${e.height}px`,tW()},t=window.visualViewport;return t&&(t.addEventListener("resize",e),t.addEventListener("scroll",e),e()),()=>{t&&(t.removeEventListener("resize",e),t.removeEventListener("scroll",e))}},[tW]),(0,r.useEffect)(()=>{if(!t$)return;rZ();let e=window.visualViewport,t=()=>rZ(),r=()=>rZ(),s=()=>rZ(),n=()=>rZ(),i=()=>rZ(),a=()=>rZ();return e&&(e.addEventListener("resize",t),e.addEventListener("scroll",r)),window.addEventListener("resize",s),window.addEventListener("orientationchange",s),window.addEventListener("focusin",n),window.addEventListener("focusout",i),window.addEventListener("mobileActionsToggle",a),document.body.classList.add("vv-body-lock"),()=>{e&&(e.removeEventListener("resize",t),e.removeEventListener("scroll",r)),window.removeEventListener("resize",s),window.removeEventListener("orientationchange",s),window.removeEventListener("focusin",n),window.removeEventListener("focusout",i),window.removeEventListener("mobileActionsToggle",a),document.body.classList.remove("vv-body-lock");let l=document.documentElement;l.style.removeProperty("--vvh"),l.style.removeProperty("--vvw"),l.style.removeProperty("--vvTop"),l.style.removeProperty("--vvLeft")}},[t$,rZ]),(0,t.jsx)(D,{value:rJ,children:(0,t.jsxs)("main",{ref:rY,className:`flex ${t$?"vv-fixed":"h-full"} bg-gray-700 overflow-hidden no-scrollbar`,children:[(0,t.jsxs)("div",{className:`flex flex-col h-full relative bg-gray-100 transition-all duration-300 ${S?"md:w-[calc(100%-21.875rem)] lg:w-full xl:w-[calc(100%-21.875rem)]":"w-full"} border-r border-gray-200`,children:[(0,t.jsx)(eu,{chatName:tp,isGroup:en,memberCount:t6,showPopup:S,onTogglePopup:()=>k(e=>!e),onOpenMembers:()=>{if(en)T("members"),k(!0);else{let t=eX(e);t&&v.push(`/profile/${t}`)}},showSearchSidebar:tf,onToggleSearchSidebar:()=>tb(e=>{let t=!e;return!t&&t$&&(tR.current=!0,tj(""),tS([]),tT(-1),tE.current=!1,p&&p(null),setTimeout(()=>{tR.current=!1},300)),t}),avatar:ty,onBackFromChat:f,presenceText:en?void 0:tG.text,presenceOnline:en?void 0:tG.online,onVoiceCall:tK,onVideoCall:tq,isMobile:t$,isSearchActive:t$&&tf,initialKeyword:g||null,onSearchTermChange:tj,searchInputRef:tM,onCloseSearch:()=>{tR.current=!0,tb(!1),tj(""),tS([]),tT(-1),tE.current=!1,p&&p(null),setTimeout(()=>{tR.current=!1},300)}}),(0,t.jsx)(ex,{allPinnedMessages:eo,showPinnedList:eh,onOpenPinnedList:()=>eg(!0),onClosePinnedList:()=>eg(!1),onJumpToMessage:tv,getSenderName:rV,onUnpinMessage:rT,onLoadMorePinned:rU,pinnedHasMore:(ew??0)>eo.length,pinnedLoading:eS,isSidebarOpen:S||!t$&&tf}),en&&tn&&!tx&&!tu&&!td&&(0,t.jsx)("div",{className:"fixed z-[2000] left-6 top-6 w-[90vw] max-w-[560px]",children:(0,t.jsxs)("div",{className:"rounded-xl p-0 shadow-2xl ring-1 ring-black/10 bg-white/5 backdrop-blur",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 bg-black/70 text-white rounded-t-xl select-none",children:[(0,t.jsx)("span",{className:"text-sm",children:"Cuộc gọi nhóm đang diễn ra"}),(0,t.jsx)("span",{className:"text-xs",children:"video"===ta?"Video":"Thoại"})]}),(0,t.jsx)("div",{className:"rounded-b-xl pt-2 p-2 relative bg-black/20",children:(0,t.jsxs)("div",{className:"rounded-lg overflow-hidden bg-black/30 text-white px-3 py-3",children:[(0,t.jsx)("div",{className:"text-sm mb-2",children:"Cuộc gọi nhóm đang diễn ra"}),(0,t.jsx)("button",{className:"cursor-pointer px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition",onClick:tA,children:"Tham gia lại"})]})})]})}),(0,t.jsxs)("div",{ref:$,className:"relative flex-1 overflow-y-auto overflow-x-hidden p-4 pb-0 bg-gray-100 flex flex-col custom-scrollbar overscroll-y-contain",children:[(eY||eJ)&&(0,t.jsxs)("div",{className:"sticky top-0 z-20 flex items-center justify-center py-2",children:[(0,t.jsx)("div",{className:"h-4 w-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin mr-2"}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:eY?"Đang tải tin nhắn...":"Đang tải thêm..."})]}),(0,t.jsx)(eA,{onShareMessage:rq,messagesGrouped:rj,messages:j,currentUser:i,allUsersMap:rO,uploadingFiles:t0,highlightedMsgId:X,isGroup:en,onContextMenu:rp,onMobileLongPress:rf,isMobile:t$,onReplyMessage:rA,onJumpToMessage:tv,getSenderInfo:e=>{let t=rW(e);if(rX(i._id,t))return{_id:t,name:i.name||"Bạn",avatar:i.avatar??null};let r=rO.get(t)||rO.get(String(Number(t))),s=a.find(e=>rX(e._id||e.id,t)),n=en&&Array.isArray(t8)?t8.find(e=>rX(e._id||e.id,t)):null,l=s||n,o="object"==typeof e&&null!==e?e:null;return{_id:t,name:r||l?.name||o?.name||"Người dùng",avatar:l?.avatar||o?.avatar||null}},renderMessageContent:(e,s,n)=>((e,s,n,a)=>{if(!e)return null;let l=(e,r)=>{if(!r||!r.trim()||!e)return e;let s=(0,h.buildAccentInsensitiveRegex)(r),n=e.split(s);return(0,t.jsx)(t.Fragment,{children:n.map((e,r)=>s.test(e)?(0,t.jsx)("mark",{className:"bg-yellow-200 text-yellow-900 px-0.5 rounded font-medium",children:e},r):(0,t.jsx)("span",{children:e},r))})};return e.split(/(@\[[^\]]+\]\([^)]+\))/g).map((e,s)=>{let o,c=e.match(/@\[([^\]]+)\]\(([^)]+)\)/);if(c){let[,e,r]=c,a=r===String(i._id);return(0,t.jsxs)("span",{className:`font-semibold px-1 rounded ${a?"bg-yellow-300 text-yellow-900":n?"bg-blue-300 text-blue-900":"bg-gray-300 text-gray-900"}`,children:["@",e]},`m-${s}`)}let d=/(https?:\/\/|www\.)\S+/gi,m=[],u=0;for(;null!==(o=d.exec(e));){let r=o.index,n=r+o[0].length;if(r>u){let n=e.slice(u,r);m.push((0,t.jsx)("span",{children:l(n,a)},`t-${s}-${u}`))}let i=o[0],c=i.startsWith("http")?i:`https://${i}`;m.push((0,t.jsx)("a",{href:c,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline break-all",children:l(i,a)},`a-${s}-${r}`)),u=n}if(u<e.length){let r=e.slice(u);m.push((0,t.jsx)("span",{children:l(r,a)},`t-${s}-${u}-end`))}return(0,t.jsx)(r.default.Fragment,{children:m},`p-${s}`)})})(e,0,n,t$?tw:g),onOpenMedia:(e,t)=>e_({url:e,type:t}),editingMessageId:eT,setEditingMessageId:eM,editContent:eE,setEditContent:eH,onSaveEdit:rK,onRefresh:rH,onPinMessage:rT,onToggleReaction:rg,contextMenu:K,isSidebarOpen:!t$&&(S||tf),onOpenChatInfoSection:e=>{t$||(T(e),k(!0))}}),(0,t.jsx)("div",{ref:E,className:"h-8 sm:h-10"})]}),(0,t.jsx)("button",{onClick:()=>tW(!0),"aria-label":"Cuộn xuống cuối",className:`absolute cursor-pointer hover:bg-gray-100 md:bottom-35 bottom-45   right-4 z-5 rounded-full bg-white border border-gray-200 shadow-lg p-3 transition-all ${Q?"opacity-100":"opacity-0 pointer-events-none"}`,children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(x.HiChevronDoubleDown,{className:"w-6 h-6 text-gray-700"}),Z>0&&(0,t.jsx)("span",{className:"absolute -top-6  w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center",children:Z})]})}),(0,t.jsxs)("div",{ref:I,className:"bg-white p-0  border-t rounded-t-xl border-gray-200 relative space-y-1",children:[(0,t.jsx)(ef,{showEmojiPicker:z,pickerTab:G,setPickerTab:W,onEmojiClick:e=>rI({emoji:e}),stickers:eW,onSelectSticker:rL}),(0,t.jsx)(eb,{replyingTo:ei,getSenderName:rV,onCancel:()=>ea(null)}),en&&(0,t.jsx)(ey,{showMentionMenu:rt,mentionSuggestions:rx,selectedMentionIndex:rs,mentionMenuRef:rn,onSelectMention:rd}),t$&&tN.length>0&&tw.trim()&&(0,t.jsxs)("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-100 border-t border-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("svg",{className:"w-4 h-4 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),(0,t.jsxs)("span",{className:"text-xs text-gray-600 font-medium",children:["Kết quả thứ ",t_>=0?t_+1:0,"/",tN.length]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:tz,className:"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Kết quả trước",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,t.jsx)("button",{onClick:tV,className:"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Kết quả tiếp theo",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})]}),(0,t.jsx)(eN,{socket:P,showEmojiPicker:z,onToggleEmojiPicker:rz,isListening:rE,onVoiceInput:r$,editableRef:ri,onInputEditable:ro,onKeyDownEditable:e=>{if(rc(e),rt)return;let t=ri.current;if(!t)return;let r=String(t.innerText||""),s=r.trim();if("Enter"===e.key&&!e.shiftKey&&"/key"===s){e.preventDefault();try{localStorage.setItem(`chatFlashEnabled:${tt}`,"true")}catch{}t.innerText="",ro();return}if(" "===e.key&&"/key"===s)try{localStorage.setItem(`chatFlashEnabled:${tt}`,"false")}catch{}if("Enter"===e.key&&!e.shiftKey){e.preventDefault();let s=r;try{let e=localStorage.getItem(`chatFlashActiveFolder:${tt}`),t=e?JSON.parse(e):null,r=t?.id,n="true"===localStorage.getItem(`chatFlashEnabled:${tt}`);if(r&&n){let e=localStorage.getItem(`chatFlashKV:${tt}:${r}`),t=e?JSON.parse(e):[],n=new Map((Array.isArray(t)?t:[]).map(e=>[String(e.key),String(e.value)]));s=String(s).replace(/(^|\s)\/\s*([\w-]+)/g,(e,t,r)=>{let s=n.get(r);return null!=s?t+s:e})}}catch{}if(s!==r){t.innerText=s;try{let e=document.createRange();e.selectNodeContents(t),e.collapse(!1);let r=window.getSelection();r?.removeAllRanges(),r?.addRange(e)}catch{}ro();return}rG()}},onPasteEditable:e=>{let t=Array.from(e.clipboardData?.items||[]).filter(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")));if(t.length>0){e.preventDefault(),t.forEach(e=>{let t=e.getAsFile();if(t){let e=t.type.startsWith("video/")||(0,h.isVideoFile)(t.name),r=t.type.startsWith("image/"),s=e?"video":r?"image":"file",n=URL.createObjectURL(t);e1(e=>[...e,{file:t,type:s,previewUrl:n,fileName:t.name}])}}),ru();return}e.preventDefault();let r=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,r),ro()},onSendMessage:rG,onSelectImage:e=>{let t=e.type.startsWith("video/")||(0,h.isVideoFile)(e.name)?"video":"image",r=URL.createObjectURL(e);e1(s=>[...s,{file:e,type:t,previewUrl:r,fileName:e.name}]),ru()},onSelectFile:e=>{let t=e.type.startsWith("video/")||(0,h.isVideoFile)(e.name)?"video":"file",r=URL.createObjectURL(e);e1(s=>[...s,{file:e,type:t,previewUrl:r,fileName:e.name}]),ru()},onAttachFromFolder:async e=>{let t=(0,h.getProxyUrl)(e.url),r=e.fileName||("image"===e.type?"image.jpg":"video"===e.type?"video.mp4":"file"),s={file:new File([new Blob([])],r,{type:"application/octet-stream"}),type:e.type,previewUrl:t,fileName:r};e1(e=>[...e,s]),ru();try{let s=await fetch(t),n=await s.blob(),i=n.type||("image"===e.type?"image/jpeg":"video"===e.type?"video/mp4":"application/octet-stream"),a=new File([n],r,{type:i}),l=URL.createObjectURL(n);e1(s=>s.map(s=>s.previewUrl===t?{file:a,type:e.type,previewUrl:l,fileName:r}:s))}catch{}},onFocusEditable:()=>{V(!1),tW(),setTimeout(tW,0),setTimeout(tW,200);try{ri.current?.scrollIntoView({block:"end"})}catch{}},attachments:e0.map(e=>({previewUrl:e.previewUrl,type:e.type,fileName:e.fileName})),onRemoveAttachment:e=>{e1(t=>{let r=[...t],[s]=r.splice(e,1);if(s)try{URL.revokeObjectURL(s.previewUrl)}catch{}return r})},onClearAttachments:()=>{e1(e=>(e.forEach(e=>{try{URL.revokeObjectURL(e.previewUrl)}catch{}}),[]))},isUploading:t5,uploadingCount:t4,overallUploadPercent:t3})]})]}),S&&tI&&(0,t.jsx)("div",{"aria-hidden":"true",className:"hidden lg:block lg:fixed lg:inset-0 lg:bg-transparent z-10",onClick:()=>{k(!1),T(null)}}),S&&(0,t.jsx)("div",{id:"right-sidebar-container",className:"fixed inset-0 md:relative md:inset-auto md:w-[21.875rem] lg:fixed lg:inset-y-0 lg:right-0 lg:w-[21.875rem] lg:z-20 xl:relative xl:inset-auto xl:w-[21.875rem] h-full z-10 ",children:(0,t.jsx)(ed,{onClose:()=>{k(!1),T(null)},onShowCreateGroup:l,onMembersAdded:re,members:t8,onMemberRemoved:t9,onRoleChange:t7,onJumpToMessage:tv,onChatAction:d,reLoad:c,onLeftGroup:f,onRefresh:rH,sendNotifyMessage:e=>tY(e),lastUpdated:rR,initialSection:_,groups:b})}),tf&&!t$&&(0,t.jsx)("div",{className:"fixed inset-0 sm:static sm:inset-auto sm:w-[21.875rem] h-full z-10 ",children:(0,t.jsx)(ez,{isOpen:tf,onClose:()=>{tb(!1),p&&p(null)},roomId:tt,onJumpToMessage:tv,getSenderName:rV,initialKeyword:g||null,onKeywordClear:()=>{p&&p(null)}})}),rk&&rN&&(0,t.jsx)(em,{onClose:()=>{rC(!1),rS(null)},onConfirm:e=>{r_(rN,!0,e),rC(!1),rS(null)}}),e8&&e7&&(0,t.jsx)(eV,{isOpen:e8,onClose:()=>{e9(!1),te(null)},message:e7,currentUser:i,allUsers:a,groups:b,onShare:rQ}),M&&en&&(0,t.jsx)(w,{conversationId:e._id,currentUser:i,reLoad:c,isOpen:M,onClose:()=>A(!1),members:t8,groupName:tp,allUsers:a,onMembersAdded:re,onMemberRemoved:t9,onRoleChange:t7,sendNotifyMessage:e=>tY(e),lastUpdated:rR}),K&&K.visible&&(0,t.jsx)(t.Fragment,{children:t$?(0,t.jsx)(eG,{contextMenu:K,currentUserId:String(i._id),onClose:rb,onPinMessage:rT,onRecallMessage:rB,onReplyMessage:rA,onShareMessage:rq,onToggleReaction:rg,setEditingMessageId:eM,setEditContent:eH,closeContextMenu:rb}):(0,t.jsx)(e$,{contextMenu:K,currentUserId:String(i._id),onClose:rb,onPinMessage:rT,onRecallMessage:rB,setEditingMessageId:eM,setEditContent:eH,closeContextMenu:rb,onReplyMessage:rA,onShareMessage:rq})}),(0,t.jsx)(C,{media:eC,chatName:tp,isGroup:en,roomId:tt,onClose:()=>e_(null),onShareMessage:rq})]})})}e.s(["default",()=>eJ],22597)},23484,e=>{"use strict";var t=e.i(71645),r=e.i(18566),s=e.i(96085),n=e.i(37963),i=e.i(91416);function a(e){let a=(0,r.useRouter)(),[l,o]=(0,t.useState)(null),[c,d]=(0,t.useState)(!0),{playMessageSound:m}=(0,i.useChatNotifications)({}),[u,h]=(0,t.useState)([]),x=(0,t.useRef)([]),[g,p]=(0,t.useState)([]),[f,b]=(0,t.useState)(null),y=(0,t.useRef)(null),[v,w]=(0,t.useState)(""),[j,N]=(0,t.useState)(!1),S=(0,t.useRef)(null),[k,C]=(0,t.useState)(!1),[_,T]=(0,t.useState)(""),[M,A]=(0,t.useState)({contacts:[],messages:[]}),[E,$]=(0,t.useState)(null),[I,L]=(0,t.useState)(null),P=(0,t.useRef)(new Map),H=(0,t.useRef)(new Set);(0,t.useEffect)(()=>{T(v)},[v]),(0,t.useEffect)(()=>{x.current=u},[u]);let U=(0,t.useCallback)(async()=>{if(l){try{let e=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"read",currentUserId:l._id})}),t=await e.json(),r=Array.isArray(t)?t:t.data||[];h(r.filter(e=>e._id!==l._id))}catch(e){console.error("Fetch users error:",e)}try{let e=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:l._id})}),t=await e.json();t.data&&(p(t.data),b(e=>{if(!e||!(!0===e.isGroup||Array.isArray(e.members)))return e;let r=t.data.find(t=>t._id===e._id);return r||null}))}catch(e){console.error("Fetch groups error:",e)}}},[l]),R=(0,t.useCallback)(e=>{b(e),y.current=e,e.isGroup||e.members?p(t=>t.map(t=>t._id===e._id?{...t,unreadCount:0}:t)):h(t=>t.map(t=>t._id===e._id?{...t,unreadCount:0}:t))},[]),D=(0,t.useCallback)(e=>{C(!1),$(null);let t=null;(t=e.isGroup?g.find(t=>t._id===e._id)??null:u.find(t=>t._id===e._id)??null)?R(t):console.warn("Contact not found:",e._id)},[g,u,R]),O=(0,t.useCallback)(async t=>{if(T(t),!t.trim()||!l)return void A({contacts:[],messages:[]});let r=(0,n.normalizeNoAccent)(t),s=[...g,...u];e?.onlyGroups?s=[...g]:e?.onlyPersonal&&(s=[...u]);let i=String(l._id),a=s.map(e=>{let t=e.isGroup||!!e.members,r=String(e.name||"").trim();return t||(r=e.nicknames?.[i]?String(e.nicknames[i]).trim()||r||String(e.username||"Người dùng"):String(e.name||e.username||"Người dùng").trim()),{contact:e,isGroup:t,displayName:r}}).filter(({contact:e,displayName:t})=>!e.isHidden&&(0,n.normalizeNoAccent)(t).includes(r)).map(({contact:e,isGroup:t,displayName:r})=>({_id:e._id,name:r,avatar:e.avatar,isGroup:t})).slice(0,10);try{let r=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"globalSearch",data:{userId:l._id,searchTerm:t,limit:50}})}),s=((await r.json()).data||[]).filter(e=>["text","image","file","sticker","video","reminder"].includes(e.type)).filter(t=>!e?.onlyGroups||t.isGroupChat).map(e=>({_id:e._id,content:e.content,type:e.type,fileName:e.fileName,timestamp:e.timestamp,sender:e.sender,senderName:e.senderName||"",roomId:e.roomId,roomName:e.roomName||"",isGroupChat:e.isGroupChat||!1,partnerId:e.partnerId,partnerName:e.partnerName,fileUrl:e.fileUrl,receiver:e.receiver,displayRoomName:e.displayRoomName}));A({contacts:a,messages:s})}catch(e){console.error("Global search API error:",e),A({contacts:a,messages:[]})}},[l,g,u,e?.onlyGroups,e?.onlyPersonal]),B=(0,t.useCallback)(e=>{if(g.some(t=>String(t._id)===String(e))){let t=g.find(t=>String(t._id)===String(e)),r=t?t.members:[];return{roomId:e,sender:String(l?._id||""),senderName:l?.name||"",isGroup:!0,receiver:null,members:r}}let t=null;if(e.includes("_")){let r=e.split("_");t=r[0]===String(l?._id||"")?r[1]:r[0]}return{roomId:e,sender:String(l?._id||""),senderName:l?.name||"",isGroup:!1,receiver:t,members:[]}},[g,l]),F=(0,t.useCallback)(e=>{let t=String(e._id);if(H.current.has(t))return;let r=Math.max(0,(e.reminderAt||e.timestamp)-Date.now());H.current.add(t);let s=window.setTimeout(async()=>{try{let t=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"fireReminder",messageId:e._id,userId:String(l?._id||"")})}),r=await t.json(),s=B(String(e.roomId));r?.success&&r?.updated&&"string"==typeof r?.notifyId&&S.current?.emit("send_message",{...s,_id:r.notifyId,type:"notify",content:`Đến giờ lịch hẹn: "${e.content||""}"`,timestamp:Date.now(),replyToMessageId:String(e._id)}),r?.nextAt&&S.current?.emit("edit_message",{_id:e._id,roomId:e.roomId,content:e.content,newContent:e.content,editedAt:Date.now(),originalContent:e.originalContent||e.content,reminderAt:r.nextAt,reminderNote:e.reminderNote})}catch{}H.current.delete(t),P.current.get(t)&&P.current.delete(t)},r);P.current.set(t,s)},[l,B]),z=(0,t.useCallback)(async()=>{if(l)try{let e=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readReminders",data:{userId:l._id,limit:5e3,untilTs:Date.now()+2592e6}})}),t=await e.json();(Array.isArray(t?.data)?t.data:[]).forEach(e=>F(e))}catch{}},[l,F]);(0,t.useEffect)(()=>{if(!l)return;window.__globalReminderSchedulerActive=!0,z();let e=setInterval(()=>void z(),6e4);return()=>{clearInterval(e),window.__globalReminderSchedulerActive=!1}},[l,z]);let V=(0,t.useCallback)(()=>{C(e=>{let t=!e;return t&&(v.trim()?(T(v),O(v)):(T(""),A({contacts:[],messages:[]}))),t})},[v,O]),G=(0,t.useCallback)((e,t)=>{let r=null,s=String(l?._id);if(!0===e.isGroupChat&&e.roomId)r=g.find(t=>String(t._id)===String(e.roomId))??null;else if(!1===e.isGroupChat){let t=null;if(e.partnerId)t=String(e.partnerId);else if(e.roomId&&e.roomId.includes("_")){let r=e.roomId.split("_");t=r[0]===s?r[1]:r[0]}else{let r=String(e.sender),n=e.receiver?String(e.receiver):null;t=r===s?n:r}t&&(r=u.find(e=>String(e._id)===t)??null)}r?(C(!1),R(r),t&&t.trim()&&L(t),setTimeout(()=>{$(String(e._id))},200)):(console.warn("❌ Chat not found locally. Refetching data..."),U().then(()=>{alert("Không tìm thấy cuộc trò chuyện. Đã tải lại dữ liệu, vui lòng thử lại.")}))},[g,u,l,U,R]);(0,t.useEffect)(()=>{(async()=>{d(!0);try{let e=JSON.parse(localStorage.getItem("info_user")||"{}");e&&e._id?o(e):a.push("/")}catch{a.push("/")}finally{d(!1)}})();let e=e=>{if("info_user"===e.key)try{let t=e.newValue?JSON.parse(e.newValue):null;t&&t._id&&o(t)}catch{}};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[a]),(0,t.useEffect)(()=>{l&&U()},[l,U]),(0,t.useEffect)(()=>{y.current=f},[f]),(0,t.useEffect)(()=>{if(!l)return;let e=(0,n.resolveSocketUrl)();S.current=(0,s.default)(e,{transports:["websocket"],withCredentials:!1}),S.current.emit("join_room",l._id),S.current.emit("user_online",{userId:l._id});let t=setInterval(()=>{try{S.current?.emit("heartbeat",{userId:l._id})}catch{}},6e4);S.current.on("presence_update",e=>{h(t=>t.map(t=>String(t._id)===String(e.userId)?{...t,online:e.online,lastSeen:e.lastSeen??t.lastSeen}:t))});let r=()=>{try{S.current?.emit("heartbeat",{userId:l._id})}catch{}};return window.addEventListener("beforeunload",r),S.current.on("update_sidebar",e=>{let t=e.sender===l._id,r=y.current?._id||null,s="Người lạ";if(t)s="Bạn";else{let t=x.current.find(t=>t._id===e.sender);t&&(s=t.name||"Người lạ"),e.senderName&&(s=e.senderName)}let n="";if(e.lastMessage&&!e.isRecalled&&"recall"!==e.type)n=e.lastMessage;else if(e.isRecalled||"recall"===e.type)n=e.isGroup?t?"Bạn: Tin nhắn đã được thu hồi":`${s}: Tin nhắn đ\xe3 được thu hồi`:"Tin nhắn đã được thu hồi";else{let t="text"===e.type||"notify"===e.type?e.content||"":`[${e.type||"Unknown"}]`;n=`${s}: ${t}`}let i="text"===e.type||"image"===e.type||"file"===e.type||"sticker"===e.type||"video"===e.type||"notify"===e.type,a=l?.notifications?.soundEnabled!==!1;if(!t&&i&&a&&m(),e.isGroup)p(i=>{let a=i.findIndex(t=>t._id===e.roomId);if(-1===a){let t=String(l._id);if((Array.isArray(e.members)?e.members.map(e=>"object"==typeof e&&e?._id?String(e._id):String(e)).filter(Boolean):[]).includes(t)){let t=Array.isArray(e.members)?e.members.map(e=>"object"==typeof e&&e?._id?{_id:String(e._id),role:"MEMBER",joinedAt:Date.now()}:{_id:String(e),role:"MEMBER",joinedAt:Date.now()}):[],r=[{_id:String(e.roomId),name:(e.groupName||e.senderName||"Nhóm").trim()||"Nhóm",isGroup:!0,members:t,createdBy:String(e.sender||""),unreadCount:0,lastMessage:n,lastMessageAt:e.timestamp||Date.now()},...i];return setTimeout(()=>U(),200),r}return U(),i}let o=r===e.roomId,c=s;if(!t){let t=i[a],r=t.members?.find(t=>("object"==typeof t&&t&&"_id"in t?String(t._id):String(t))===String(e.sender));r&&"object"==typeof r&&r.nickname&&(c=r.nickname)}let d=n;if(!t){let t="text"===e.type||"notify"===e.type,r=e.content||"";if(e.isRecalled||"recall"===e.type)d=`${c}: Tin nhắn đ\xe3 được thu hồi`;else if(t)d=`${c}: ${r}`;else{let t=e.type?`[${e.type}]`:"[Tin nhắn]";d=`${c}: ${t}`}}let m={...i[a],lastMessage:d,lastMessageAt:e.timestamp||Date.now(),isRecall:e.isRecalled||!1,unreadCount:t||o?0:(i[a].unreadCount||0)+1},u=[...i];return u.splice(a,1),[m,...u]});else{let s=t?e.receiver:e.sender;h(i=>{let a=i.findIndex(e=>e._id===s);if(-1===a)return U(),i;let l={...i[a],lastMessage:n,lastMessageAt:e.timestamp||Date.now(),isRecall:e.isRecalled||!1,unreadCount:t||r===s?0:(i[a].unreadCount||0)+1},o=[...i];return o.splice(a,1),[l,...o]})}}),S.current.on("group_members_updated",e=>{let t=String(l._id);!(Array.isArray(e.members)?e.members.map(e=>String(e._id)):[]).includes(t)&&(p(t=>t.filter(t=>String(t._id)!==String(e.roomId))),y.current&&String(y.current._id)===String(e.roomId)&&b(null))}),S.current.on("group_renamed",e=>{p(t=>t.map(t=>String(t._id)===String(e.roomId)?{...t,name:e.groupName}:t)),y.current&&String(y.current._id)===String(e.roomId)&&b(t=>t?{...t,name:e.groupName}:t)}),()=>{try{clearInterval(t)}catch{}window.removeEventListener("beforeunload",r),S.current?.disconnect()}},[l,U,m]);let W=(0,t.useCallback)(async(e,t,r,s)=>{if(l?._id)try{let n={action:"toggleChatStatus",_id:l._id,currentUserId:l._id,roomId:e,conversationId:e,data:"pin"===t?{isPinned:r}:{isHidden:r}};(await fetch(s?"/api/groups":"/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok&&(s?p(s=>s.map(s=>s._id===e?{...s,["pin"===t?"isPinned":"isHidden"]:r}:s)):h(s=>s.map(s=>s._id===e?{...s,["pin"===t?"isPinned":"isHidden"]:r}:s)),setTimeout(()=>{U()},500))}catch(e){console.error(`Lỗi ${t} chat:`,e)}},[l,U]);return{currentUser:l,isLoading:c,allUsers:u,groups:g,selectedChat:f,searchTerm:v,setSearchTerm:w,showCreateGroupModal:j,setShowCreateGroupModal:N,showGlobalSearchModal:k,globalSearchTerm:_,globalSearchResults:M,scrollToMessageId:E,setScrollToMessageId:$,roomSearchKeyword:I,setRoomSearchKeyword:L,handleOpenGlobalSearch:V,handleGlobalSearch:O,handleSelectContact:D,handleNavigateToMessage:G,fetchAllData:U,handleChatAction:W,handleSelectChat:R,setSelectedChat:b}}e.s(["useHomePage",()=>a])}]);