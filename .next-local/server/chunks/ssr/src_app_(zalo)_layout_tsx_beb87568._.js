module.exports=[21328,a=>{"use strict";let b,c,d,e,f,g,h,i,j;var k,l,m=a.i(87924),n=a.i(72131),o=a.i(50944),p=a.i(71987);function q(a,b,c={}){if("undefined"==typeof document)return;let d=[`${encodeURIComponent(a)}=${encodeURIComponent(b)}`],e=c.path??"/";e&&d.push(`Path=${e}`),c.domain&&d.push(`Domain=${c.domain}`),"number"==typeof c.maxAge?d.push(`Max-Age=${Math.max(0,c.maxAge)}`):c.expires&&d.push(`Expires=${c.expires.toUTCString()}`),c.secure&&d.push("Secure"),c.sameSite&&d.push(`SameSite=${c.sameSite}`),document.cookie=d.join("; ")}let r={path:"/",maxAge:2592e3},s={set(a,b){q(a,JSON.stringify(b),r)},get(a){let b=function(a){if("undefined"==typeof document)return null;let b=`${encodeURIComponent(a)}=`;for(let a of document.cookie?document.cookie.split("; "):[])if(a.startsWith(b))return decodeURIComponent(a.slice(b.length));return null}(a);if(!b)return null;try{return JSON.parse(b)}catch{return null}},remove(a){!function(a,b={}){q(a,"",{...b,maxAge:0})}(a,{path:"/"})}};var t=a.i(45112),u=a.i(18634);let v={src:a.i(36874).default,width:441,height:80,blurWidth:8,blurHeight:1,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAABCAYAAADjAO9DAAAAI0lEQVR42mOQy33yT6346X+W2If/GaIfADGQjgFiED/u0T8AJnISWO9FrscAAAAASUVORK5CYII="},w=()=>(0,m.jsxs)("div",{className:"w-120 h-60 rounded-xl overflow-hidden shadow-2xl bg-white",children:[(0,m.jsx)("div",{className:"relative w-120 h-20",children:(0,m.jsx)(p.default,{src:v,alt:"Zalo Banner",fill:!0,className:"object-cover ",priority:!0})}),(0,m.jsxs)("div",{className:"p-5",children:[(0,m.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-4 ",children:"Liên hệ"}),(0,m.jsxs)("div",{className:"flex items-center mb-4 text-base",children:[(0,m.jsx)("span",{className:"text-gray-600 font-medium w-32",children:"Email:"}),(0,m.jsx)("a",{href:"mailto:feedbackpc@zalo.me",className:"text-[#0068FF] hover:text-blue-700 hover:underline transition duration-150 break-words",children:"feedbackpc@zalo.me"})]}),(0,m.jsxs)("div",{className:"flex items-center text-base",children:[(0,m.jsx)("span",{className:"text-gray-600 font-medium w-32",children:"Website:"}),(0,m.jsx)("a",{href:"https://zalo.me/pc",target:"_blank",rel:"noopener noreferrer",className:"text-[#0068FF] hover:text-blue-700 hover:underline transition duration-150 break-words",children:"https://zalo.me/pc"})]})]})]}),x={src:a.i(48797).default,width:868,height:540,blurWidth:8,blurHeight:5,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAYAAAB4ka1VAAAAsElEQVR42gGlAFr/AAAAAAAFBgcBSFlgGYeswDSJrcE0RlZfFQUHBwEAAAAAAAAAAABASEwLttThPa7d+W2s2fhwuNfoO0NNUhABAQEBAAQFBQGHkpkVv9nyWHWs9NBpoPLfsdLzYXqWrV4IDhQUAAQFBwM9TFkjgqTPdFWI1dlTgtPZd5jKci88SCQBAgMDAAAAAAARGiMiKz9USBEaKSARGSkgFx0kEgcLDwoAAAAAQ2QyAhRAwfQAAAAASUVORK5CYII="},y=({onClose:a})=>(0,m.jsxs)("div",{className:"relative w-85 ml-1 bg-white rounded-xl overflow-hidden shadow-xl border border-gray-200",children:[(0,m.jsx)("button",{onClick:a,className:"cursor-pointer absolute top-2 right-2 text-gray-400 hover:text-gray-600 p-1","aria-label":"Close",children:(0,m.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,m.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})}),(0,m.jsxs)("div",{className:"bg-[#f0f7ff] p-4 flex flex-col items-center justify-center relative",children:[(0,m.jsx)(p.default,{priority:!0,width:100,height:40,src:x.src,alt:"ZCloud",className:"w-100 h-40 object-contain"}),(0,m.jsx)("span",{className:"absolute top-2 left-1/4 w-2 h-2 bg-red-500 rounded-full rotate-45"}),(0,m.jsx)("span",{className:"absolute top-6 right-1/4 w-2 h-2 bg-yellow-400 rounded-full"}),(0,m.jsx)("span",{className:"absolute bottom-6 left-6 w-3 h-3 bg-blue-400 rounded-lg"}),(0,m.jsx)("span",{className:"absolute bottom-8 right-10 w-2 h-2 bg-green-500 rounded-full"})]}),(0,m.jsxs)("div",{className:"p-4",children:[(0,m.jsx)("h2",{className:"text-lg font-bold text-gray-900 mb-2",children:"Bảo toàn dữ liệu Zalo với zCloud"}),(0,m.jsx)("p",{className:"text-sm text-gray-600 leading-relaxed mb-4",children:"Khám phá ngay tiện ích lưu trữ an toàn ảnh, video, và tệp quan trọng trên zCloud, đồng thời giải phóng dung lượng máy."}),(0,m.jsx)("button",{className:"cursor-pointer w-full py-2 bg-[#e8e9ea] text-sm font-semibold text-gray-800 rounded-lg hover:bg-[#dcdde0] transition duration-200",children:"Tìm hiểu zCloud ngay"})]})]});var z=a.i(75357),A=a.i(74362),B=a.i(97168),C=a.i(17256);function D({totalUnread:a=0,unreadGroups:b=0,unreadContacts:c=0}){let d=(0,o.useRouter)(),[e,f]=(0,n.useState)({avatar:!1,business:!1,cloud:!1,submenu:null}),[g,h]=(0,n.useState)("home"),[i,j]=(0,n.useState)(!1),[k,l]=(0,n.useState)(!1),[q,r]=(0,n.useState)(!1),[v,x]=(0,n.useState)(null),D=(0,n.useRef)(null),E=(0,n.useRef)(null);(0,n.useEffect)(()=>{try{let a=localStorage.getItem("info_user");a&&x(JSON.parse(a))}catch(a){console.error("Failed to parse info_user",a)}},[]),(0,n.useEffect)(()=>{let a=a=>{D.current&&!D.current.contains(a.target)&&f(a=>({...a,avatar:!1,submenu:null})),E.current&&!E.current.contains(a.target)&&f(a=>({...a,business:!1}))};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]);let F=async()=>{try{await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"logout"})})}catch(a){console.error("Logout error:",a)}s.remove("session_token"),s.remove("remember_login"),localStorage.removeItem("info_user"),localStorage.removeItem("remember_login"),d.push("/")},G=(0,n.useCallback)((a,b)=>{h(b),d.push(a)},[d]),H=(a,b)=>{f(c=>({...c,[a]:void 0!==b?b:!c[a],submenu:"avatar"===a&&!0!==b?null:c.submenu}))};return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("div",{className:"h-screen w-16 bg-blue-400 flex flex-col items-center py-6 text-white shadow-2xl",children:[(0,m.jsxs)("div",{ref:D,className:"mb-10 relative",children:[(0,m.jsxs)("button",{onClick:()=>H("avatar"),className:"group cursor-pointer relative w-10 h-10 rounded-full overflow-hidden ring-2 ring-white/30 hover:ring-yellow-400 transition-all duration-300 shadow-2xl",children:[v?.avatar?(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(v.avatar),width:56,height:56,alt:v.name,className:"w-full h-full object-cover"}):(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:v?.name||"User",width:56,height:56,className:"w-full h-full object-cover"}),(0,m.jsx)("div",{className:"absolute inset-0 rounded-full bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300"})]}),e.avatar&&v&&(0,m.jsxs)("div",{className:"absolute left-4 top-12 w-80 bg-white text-gray-800 rounded-lg shadow-xl z-50 overflow-hidden animate-in fade-in slide-in-from-top-4 duration-300 border border-gray-100",children:[(0,m.jsx)("div",{className:"px-4 py-4",children:(0,m.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:v.name})}),(0,m.jsx)("div",{className:"h-px bg-gray-100 mx-4"}),(0,m.jsxs)("div",{className:"py-2",children:[(0,m.jsx)("div",{className:"flex items-center justify-between px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>{f({avatar:!1,business:!1,cloud:!1,submenu:null}),d.push(`/profile/${v.username}`)},children:(0,m.jsx)("span",{className:"text-gray-700 font-medium",children:"Hồ sơ của bạn"})}),(0,m.jsx)("div",{className:"flex items-center justify-between px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>{f({avatar:!1,business:!1,cloud:!1,submenu:null}),l(!0)},children:(0,m.jsx)("span",{className:"text-gray-700 font-medium",children:"Tài khoản"})}),(0,m.jsx)("div",{className:"h-px bg-gray-100 mx-4 my-1"}),(0,m.jsx)("div",{className:"flex items-center justify-between px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>{f({avatar:!1,business:!1,cloud:!1,submenu:null}),r(!0),f(a=>({...a,avatar:!1}))},children:(0,m.jsx)("span",{className:"text-gray-700 font-medium",children:"Đăng xuất"})})]})]})]}),(0,m.jsxs)("nav",{className:"flex-1 flex flex-col items-center gap-4 mt-4",children:[(0,m.jsxs)("button",{onClick:()=>G("/home","home"),className:`relative p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${"home"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:[(0,m.jsx)(A.HiHome,{className:"w-5 h-5"}),a>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-2 min-w-[1.25rem] h-5 px-1 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center shadow-sm",children:a>99?"99+":a})]}),(0,m.jsxs)("button",{onClick:()=>G("/group","group"),className:`relative p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${"group"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:[(0,m.jsx)(C.HiRectangleGroup,{className:"w-5 h-5"}),b>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-2 min-w-[1.25rem] h-5 px-1 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center shadow-sm",children:b>99?"99+":b})]}),(0,m.jsx)("button",{onClick:()=>G("/moments","moments"),className:`p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${"moments"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:(0,m.jsx)(B.FaPager,{className:"w-5 h-5"})}),(0,m.jsxs)("button",{onClick:()=>G("/directory","directory"),className:`relative p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${"directory"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:[(0,m.jsx)(A.HiUserGroup,{className:"w-5 h-5"}),c>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-2 min-w-[1.25rem] h-5 px-1 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center shadow-sm",children:c>99?"99+":c})]}),(0,m.jsx)("button",{onClick:()=>{v?._id?G(`/profile/${v._id}`,"profile"):console.warn("User info or ID missing")},className:`p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${"profile"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:(0,m.jsx)(A.HiUserCircle,{className:"w-5 h-5"})})]}),(0,m.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,m.jsxs)("div",{className:"relative",children:[(0,m.jsx)("button",{onClick:()=>H("cloud"),className:`p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${e.cloud?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:(0,m.jsx)(A.HiUpload,{className:"w-5 h-5"})}),e.cloud&&(0,m.jsx)("div",{className:"absolute left-24 bottom-0 z-50",children:(0,m.jsx)(y,{onClose:()=>H("cloud",!1)})})]}),(0,m.jsx)("button",{className:"p-2 cursor-pointer rounded-[0.5rem] hover:bg-white/10 hover:scale-110 transition-all",children:(0,m.jsx)(A.HiDeviceMobile,{className:"w-5 h-5"})}),(0,m.jsxs)("div",{ref:E,className:"relative",children:[(0,m.jsx)("button",{onClick:()=>H("business"),className:`p-2 cursor-pointer rounded-[0.5rem] transition-all duration-300 ${e.business?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:(0,m.jsx)(A.HiBriefcase,{className:"w-5 h-5"})}),e.business&&(0,m.jsxs)("div",{className:"absolute left-24 bottom-0 w-96 bg-white rounded-3xl shadow-2xl p-8 z-50 border border-gray-100",children:[(0,m.jsx)("h3",{className:"text-2xl font-bold text-gray-800 mb-8",children:"Công cụ zBusiness"}),(0,m.jsx)("div",{className:"grid grid-cols-3 gap-8",children:[{icon:(0,m.jsx)(A.HiLightningBolt,{className:"w-10 h-10 text-yellow-500"}),label:"Tin nhắn nhanh"},{icon:(0,m.jsx)(A.HiCollection,{className:"w-10 h-10 text-gray-400"}),label:"Danh mục",disabled:!0},{icon:(0,m.jsx)(A.HiChatAlt2,{className:"w-10 h-10 text-gray-400"}),label:"Trả lời tự động",disabled:!0},{icon:(0,m.jsx)(A.HiStar,{className:"w-10 h-10 text-purple-500"}),label:"Tin đánh dấu"},{icon:(0,m.jsx)(A.HiClock,{className:"w-10 h-10 text-gray-400"}),label:"Tin đồng thời",disabled:!0},{icon:(0,m.jsx)(A.HiDocumentText,{className:"w-10 h-10 text-blue-500"}),label:"Ghi chú"}].map((a,b)=>(0,m.jsxs)("div",{className:`text-center ${a.disabled?"opacity-40":"cursor-pointer hover:scale-110 transition-transform"}`,children:[(0,m.jsx)("div",{className:"w-20 h-20 bg-gray-100 rounded-3xl flex items-center justify-center shadow-xl mb-3 mx-auto",children:a.icon}),(0,m.jsx)("p",{className:"text-sm font-medium text-gray-700",children:a.label})]},b))})]})]}),(0,m.jsx)("button",{className:`p-2 cursor-pointer rounded-2xl transition-all duration-300 ${"setting"===g?"bg-white/20 shadow-xl scale-110":"hover:bg-white/10 hover:scale-110"}`,children:(0,m.jsx)(A.HiCog,{className:"w-5 h-5"})})]})]}),q&&(0,m.jsx)(z.ConfirmModal,{title:"Đăng xuất",message:"Bạn có chắc chắn muốn thoát khỏi tài khoản hiện tại?",confirmText:"Đăng xuất",onCancel:()=>r(!1),onConfirm:F}),i&&(0,m.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4",onClick:()=>j(!1),children:(0,m.jsx)("div",{onClick:a=>a.stopPropagation(),children:(0,m.jsx)(w,{})})}),v&&(0,m.jsx)(u.default,{isOpen:k,onClose:()=>l(!1),user:v,onAvatarUpdated:a=>x(b=>b?{...b,avatar:a}:null),onUserUpdated:a=>x(b=>b?{...b,...a}:b)})]})}var E=a.i(83915),F=a.i(20800),G=a.i(82773);let H=({className:a,stroke:b,title:c})=>(0,m.jsx)("div",{children:(0,m.jsxs)("svg",{className:a,width:"800px",height:"800px",viewBox:"0 0 56 56",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[c&&(0,m.jsx)("title",{children:c}),(0,m.jsx)("path",{d:"M 33.7891 25.5859 L 33.7891 11.2656 C 33.7891 6.9297 30.8828 3.7187 26.711 3.7187 C 22.6094 3.7187 19.6094 6.8125 19.6094 11.0078 L 19.6094 11.3828 Z",fill:b||"#000"}),(0,m.jsx)("path",{d:"M 46.3281 47.1484 C 47.0313 47.8516 48.1797 47.8516 48.8594 47.1484 C 49.5859 46.4687 49.5859 45.2969 48.8594 44.5937 L 9.6719 5.4062 C 8.9688 4.7031 7.7735 4.7031 7.0938 5.4062 C 6.4141 6.1094 6.4141 7.2813 7.0938 7.9609 Z",fill:b||"#000"}),(0,m.jsx)("path",{d:"M 15.7657 48.7422 C 14.8281 48.7422 13.9844 49.5859 13.9844 50.5234 C 13.9844 51.4609 14.8281 52.2813 15.7657 52.2813 L 37.6328 52.2813 C 38.5703 52.2813 39.4141 51.4609 39.4141 50.5234 C 39.4141 49.5859 38.5703 48.7422 37.6328 48.7422 L 28.4688 48.7422 L 28.4688 43.6094 C 31.4453 43.3516 34.0469 42.3906 36.1797 40.8906 L 33.6719 38.3828 C 31.7735 39.6484 29.4062 40.375 26.711 40.375 C 19.3516 40.375 14.2188 35.125 14.2188 27.9766 L 14.2188 22.5391 C 14.2188 21.4375 13.5157 20.7578 12.4844 20.7578 C 11.4531 20.7578 10.7735 21.4375 10.7735 22.5391 L 10.7735 27.9766 C 10.7735 36.5547 16.3984 42.8594 24.9297 43.6094 L 24.9297 48.7422 Z",fill:b||"#000"}),(0,m.jsx)("path",{d:"M 42.625 22.5391 C 42.625 21.4375 41.9453 20.7578 40.9141 20.7578 C 39.8828 20.7578 39.1797 21.4375 39.1797 22.5391 L 39.1797 27.9766 C 39.1797 28.914 39.0859 29.8047 38.8984 30.6953 L 41.7578 33.5313 C 42.3203 31.8203 42.625 29.9687 42.625 27.9766 Z",fill:b||"#000"}),(0,m.jsx)("path",{d:"M 29.9453 34.6562 L 19.6094 24.3203 L 19.6094 28 C 19.6094 32.3125 22.5157 35.5469 26.711 35.5469 C 27.9531 35.5469 29.0313 35.2187 29.9453 34.6562 Z",fill:b||"#000"})]})}),I=({className:a,stroke:b,title:c})=>(0,m.jsx)("div",{children:(0,m.jsxs)("svg",{className:a,width:"800px",height:"800px",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-label":c,role:"img",children:[c&&(0,m.jsx)("title",{children:c}),(0,m.jsx)("path",{d:"M3 6V16C3 17.1046 3.89543 18 5 18H13C13.3151 18 13.6095 17.9252 13.8712 17.792M16 10L21 7V17L18.5 15.75",stroke:b||"#141415",strokeWidth:"0.9",strokeLinecap:"round",strokeLinejoin:"round"}),(0,m.jsx)("path",{d:"M3 3L21 21",stroke:b||"#141415",strokeWidth:"1.2",strokeLinecap:"round"})]})});function J({avatar:a,name:b,mode:c,callType:d,callStartAt:e,localVideoRef:f,currentUserName:g,currentUserAvatar:h,remotePeers:i=[],participants:j=[],micEnabled:k=!0,camEnabled:l=!0,onToggleMic:o,onToggleCamera:q,onEndCall:r}){let s=(()=>{if(!e)return"";let a=Math.floor((Date.now()-e)/1e3),b=String(Math.floor(a/60)).padStart(2,"0"),c=String(a%60).padStart(2,"0");return`${b}:${c}`})(),[u,v]=(0,n.useState)(!1),w=(0,n.useRef)(new Map),x=(0,n.useRef)(new Map);return((0,n.useEffect)(()=>{i.forEach(a=>{let b=w.current.get(a.userId);if(b)try{b.muted=!1,b.autoplay=!0,b.srcObject=a.stream,b.play().catch(()=>{})}catch{}let c=x.current.get(a.userId);if(c)try{c.srcObject=a.stream,c.play().catch(()=>{})}catch{}})},[i]),"connecting"===c)?(0,m.jsxs)("div",{className:"relative w-full max-md:h-[100vh] md:min-h-[24rem] md:max-h-[28rem] md:rounded-xl rounded-none overflow-hidden bg-black",children:[a&&(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(a),alt:b,fill:!0,className:"object-cover blur-xl opacity-40",sizes:"100vw"}),(0,m.jsx)("div",{className:"absolute inset-0 bg-blue/40"}),(0,m.jsxs)("div",{className:"relative z-10 h-full flex flex-col items-center justify-center gap-4",children:[(0,m.jsxs)("div",{className:"flex flex-col items-center gap-3 pt-10",children:[a?(0,m.jsx)("div",{className:"w-24 h-24 rounded-full overflow-hidden ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(a),alt:b,width:96,height:96,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-24 h-24 rounded-full bg-gray-500 flex items-center rounded-full justify-center text-white text-2xl font-semibold ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full rounded-full object-cover"})}),(0,m.jsx)("div",{className:"text-white font-medium text-base",children:b}),(0,m.jsx)("div",{className:"text-white/80 text-sm",children:"Đang đổ chuông..."})]}),(0,m.jsxs)("div",{className:"mt-6 md:flex hidden items-center justify-center gap-4",children:[(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 text-white opacity-60 cursor-default",disabled:!0,title:"Mic",children:(0,m.jsx)(C.HiMicrophone,{className:"w-6 h-6"})}),(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:r,title:"Kết thúc",children:(0,m.jsx)(C.HiPhone,{className:"w-7 h-7 text-red-500"})}),"video"===d&&(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 opacity-60 cursor-default",disabled:!0,title:"Video",children:(0,m.jsx)(C.HiVideoCamera,{className:"w-6 h-6 text-white"})})]}),(0,m.jsxs)("div",{className:"fixed bottom-8 left-0 right-0 md:hidden flex justify-center gap-6",children:["video"===d&&(0,m.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,m.jsx)("button",{className:"w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition",onClick:()=>q&&q(),title:l?"Tắt camera":"Bật camera",children:l?(0,m.jsx)(C.HiVideoCamera,{className:"w-6 h-6"}):(0,m.jsx)(I,{className:"w-6 h-6"})}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Camera"})]}),(0,m.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,m.jsx)("button",{className:"w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition",onClick:()=>o&&o(),title:k?"Tắt mic":"Bật mic",children:k?(0,m.jsx)(C.HiMicrophone,{className:"w-6 h-6"}):(0,m.jsx)(H,{className:"w-6 h-6",stroke:"red"})}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Mic"})]}),(0,m.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,m.jsx)("button",{className:"w-12 h-12 flex items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-700 transition",onClick:r,title:"Kết thúc",children:(0,m.jsx)(C.HiPhone,{className:"w-6 h-6"})}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Kết thúc"})]})]})]})]}):(0,m.jsxs)("div",{className:"relative w-full max-md:h-[100vh] md:min-h-[24rem] md:max-h-[28rem] md:rounded-xl rounded-none overflow-hidden bg-black",children:[a&&(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(a),alt:b,fill:!0,className:"object-cover blur-xl opacity-40",sizes:"100vw"}),(0,m.jsx)("div",{className:" inset-0 bg-black/30"}),s&&(0,m.jsx)("div",{className:"absolute top-4 left-4 z-20",children:(0,m.jsx)("span",{className:"px-2 py-1 rounded bg-green-700 text-white text-xs font-medium",children:s})}),"voice"===d?(0,m.jsxs)("div",{className:"relative z-10 h-full flex flex-col items-center justify-center gap-5 pt-10",children:[a?(0,m.jsx)("div",{className:"w-24 h-24 rounded-full overflow-hidden ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(a),alt:b,width:96,height:96,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-24 h-24 rounded-full bg-gray-500 flex items-center rounded-full justify-center text-white text-2xl font-semibold ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full rounded-full object-cover"})}),(0,m.jsx)("div",{className:"text-white font-medium text-base",children:b}),(0,m.jsxs)("div",{className:" b-0 left-0 right-0 flex items-center justify-center gap-4",children:[(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:o,title:k?"Tắt mic":"Bật mic",children:k?(0,m.jsx)(C.HiMicrophone,{className:"w-6 h-6 text-white"}):(0,m.jsx)(H,{className:"w-6 h-6",stroke:"red"})}),(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:r,title:"Kết thúc",children:(0,m.jsx)(C.HiPhone,{className:"w-7 h-7 text-red-500"})})]}),(0,m.jsx)("div",{className:"sr-only",children:i.map(a=>(0,m.jsx)("audio",{autoPlay:!0,ref:b=>{if(b){b.srcObject=a.stream;try{b.play()}catch{}w.current.set(a.userId,b)}}},a.userId))})]}):(0,m.jsxs)("div",{className:"relative z-10 p-3",children:[i.length<=1?(0,m.jsxs)("div",{className:"relative w-full aspect-video bg-black rounded-lg overflow-hidden",children:[(()=>{let c=i[0],d=!!c&&c.stream.getVideoTracks().some(a=>a.enabled);if(c&&d)return(0,m.jsx)("video",{className:"w-full h-full object-cover",autoPlay:!0,playsInline:!0,ref:a=>{if(a){a.srcObject=c.stream;try{a.play()}catch{}}}});let e=c?.avatar??a,f=c?.name??b;return(0,m.jsx)("div",{className:"flex items-center justify-center w-full h-full bg-black",children:e?(0,m.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(e),alt:f||"",width:112,height:112,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-28 h-28 rounded-full bg-gray-500 flex items-center justify-center text-white text-2xl font-semibold ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full rounded-full object-cover"})})})})(),(0,m.jsxs)("div",{className:"",children:[u?(0,m.jsx)("button",{className:"cursor-pointer hover:bg-gray-600 z-[50] absolute top-4 right-4 text-white text-sm bg-black/50 px-1 py-1 rounded-full transition-colors",onClick:()=>v(!1),children:(0,m.jsx)(C.HiChevronLeft,{className:"w-4 h-4 text-gray-400"})}):(0,m.jsx)("button",{className:"cursor-pointer hover:bg-gray-600 z-[50] absolute top-4 right-4 text-white text-sm bg-black/50 px-1 py-1 rounded-full transition-colors",onClick:()=>v(!0),children:(0,m.jsx)(C.HiChevronRight,{className:"w-4 h-4 text-gray-400"})}),(0,m.jsxs)("div",{className:`absolute top-3 right-3 w-40 aspect-video bg-black/80 rounded-lg overflow-hidden border border-white/20 ${u?"hidden":""}`,children:[(0,m.jsx)("video",{ref:f,className:`w-full h-full object-cover ${l?"":"opacity-0"}`,muted:!0,playsInline:!0,autoPlay:!0}),!l&&(0,m.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:h?(0,m.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden ring-2 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(h),alt:g||"",width:64,height:64,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-16 h-16 rounded-full bg-gray-500 flex items-center justify-center text-white text-xl font-semibold ring-2 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full rounded-full object-cover"})})})]})]}),(0,m.jsx)("p",{className:"absolute bottom-3 left-3 text-white text-sm",children:b||"U"})]}):(0,m.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,m.jsxs)("div",{className:"relative bg-black rounded-lg overflow-hidden aspect-video",children:[(0,m.jsx)("video",{ref:f,className:`w-full h-full object-cover ${l?"":"opacity-0"}`,muted:!0,playsInline:!0,autoPlay:!0}),!l&&(0,m.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black",children:h?(0,m.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(h),alt:g||"",width:96,height:96,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-16 h-16 rounded-full bg-gray-500 flex items-center justify-center text-white text-2xl font-semibold ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full object-cover"})})})]}),i.map(a=>(0,m.jsx)("div",{className:"relative bg-black rounded-lg overflow-hidden aspect-video",children:a.stream.getVideoTracks().some(a=>a.enabled)?(0,m.jsx)("video",{className:"w-full h-full object-cover",autoPlay:!0,playsInline:!0,ref:b=>{if(b){try{b.muted=!0}catch{}b.srcObject=a.stream;try{b.play()}catch{}x.current.set(a.userId,b)}}}):(0,m.jsx)("div",{className:"flex items-center justify-center w-full h-full bg-black",children:a.avatar?(0,m.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:(0,t.getProxyUrl)(a.avatar),alt:a.name||"",width:96,height:96,className:"w-full h-full object-cover"})}):(0,m.jsx)("div",{className:"w-16 h-16 rounded-full bg-gray-500 flex items-center justify-center text-white text-2xl font-semibold ring-4 ring-white/60",children:(0,m.jsx)(p.default,{src:"/logo/avata.webp",alt:b,width:64,height:64,className:"w-full h-full object-cover"})})})},a.userId)),(0,m.jsx)("div",{className:"sr-only",children:i.map(a=>(0,m.jsx)("audio",{autoPlay:!0,ref:b=>{if(b){b.srcObject=a.stream;try{b.play()}catch{}w.current.set(a.userId,b)}}},`aud-${a.userId}`))})]}),(0,m.jsxs)("div",{className:"flex items-center justify-center gap-4 mt-3",children:[(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:o,title:k?"Tắt mic":"Bật mic",children:k?(0,m.jsx)(C.HiMicrophone,{className:"w-6 h-6 text-white"}):(0,m.jsx)(H,{className:"w-6 h-6",stroke:"red"})}),(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:q,title:l?"Tắt video":"Bật video",children:l?(0,m.jsx)(C.HiVideoCamera,{className:"w-6 h-6 text-white"}):(0,m.jsx)(I,{className:"w-6 h-6",stroke:"red"})}),(0,m.jsx)("button",{className:"px-4 py-3 rounded-full bg-white/10 hover:bg-white/20 hover:cursor-pointer",onClick:r,title:"Kết thúc",children:(0,m.jsx)(C.HiPhone,{className:"w-7 h-7 text-red-500"})})]})]})]})}var K=Object.defineProperty,L=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?K(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class M{constructor(){L(this,"_locking"),L(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let a;this._locks+=1;let b=new Promise(b=>a=()=>{this._locks-=1,b()}),c=this._locking.then(()=>a);return this._locking=this._locking.then(()=>b),c}}function N(a,b){if(!a)throw Error(b)}function O(a){if("number"!=typeof a)throw Error("invalid int 32: "+typeof a);if(!Number.isInteger(a)||a>0x7fffffff||a<-0x80000000)throw Error("invalid int 32: "+a)}function P(a){if("number"!=typeof a)throw Error("invalid uint 32: "+typeof a);if(!Number.isInteger(a)||a>0xffffffff||a<0)throw Error("invalid uint 32: "+a)}function Q(a){if("number"!=typeof a)throw Error("invalid float 32: "+typeof a);if(Number.isFinite(a)&&(a>34028234663852886e22||a<-34028234663852886e22))throw Error("invalid float 32: "+a)}let R=Symbol("@bufbuild/protobuf/enum-type");function S(a,b,c,d){a[R]=T(b,c.map(b=>({no:b.no,name:b.name,localName:a[b.no]})))}function T(a,b,c){let d=Object.create(null),e=Object.create(null),f=[];for(let a of b){let b=U(a);f.push(b),d[a.name]=b,e[a.no]=b}return{typeName:a,values:f,findName:a=>d[a],findNumber:a=>e[a]}}function U(a){return"localName"in a?a:Object.assign(Object.assign({},a),{localName:a.name})}class V{equals(a){return this.getType().runtime.util.equals(this.getType(),this,a)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(a,b){let c=this.getType().runtime.bin,d=c.makeReadOptions(b);return c.readMessage(this,d.readerFactory(a),a.byteLength,d),this}fromJson(a,b){let c=this.getType(),d=c.runtime.json,e=d.makeReadOptions(b);return d.readMessage(c,a,e,this),this}fromJsonString(a,b){let c;try{c=JSON.parse(a)}catch(a){throw Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(a instanceof Error?a.message:String(a)))}return this.fromJson(c,b)}toBinary(a){let b=this.getType().runtime.bin,c=b.makeWriteOptions(a),d=c.writerFactory();return b.writeMessage(this,d,c),d.finish()}toJson(a){let b=this.getType().runtime.json,c=b.makeWriteOptions(a);return b.writeMessage(this,c)}toJsonString(a){var b;return JSON.stringify(this.toJson(a),null,null!=(b=null==a?void 0:a.prettySpaces)?b:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function W(){let a=0,b=0;for(let c=0;c<28;c+=7){let d=this.buf[this.pos++];if(a|=(127&d)<<c,(128&d)==0)return this.assertBounds(),[a,b]}let c=this.buf[this.pos++];if(a|=(15&c)<<28,b=(112&c)>>4,(128&c)==0)return this.assertBounds(),[a,b];for(let c=3;c<=31;c+=7){let d=this.buf[this.pos++];if(b|=(127&d)<<c,(128&d)==0)return this.assertBounds(),[a,b]}throw Error("invalid varint")}function X(a,b,c){for(let d=0;d<28;d+=7){let e=a>>>d,f=e>>>7!=0||0!=b,g=(f?128|e:e)&255;if(c.push(g),!f)return}let d=a>>>28&15|(7&b)<<4,e=b>>3!=0;if(c.push((e?128|d:d)&255),e){for(let a=3;a<31;a+=7){let d=b>>>a,e=d>>>7!=0,f=(e?128|d:d)&255;if(c.push(f),!e)return}c.push(b>>>31&1)}}function Y(a){let b="-"===a[0];b&&(a=a.slice(1));let c=0,d=0;function e(b,e){let f=Number(a.slice(b,e));d*=1e6,(c=1e6*c+f)>=0x100000000&&(d+=c/0x100000000|0,c%=0x100000000)}return e(-24,-18),e(-18,-12),e(-12,-6),e(-6),b?_(c,d):$(c,d)}function Z(a,b){if({lo:a,hi:b}={lo:a>>>0,hi:b>>>0},b<=2097151)return String(0x100000000*b+a);let c=0xffffff&a,d=(a>>>24|b<<8)&0xffffff,e=b>>16&65535,f=c+6777216*d+6710656*e,g=d+8147497*e,h=2*e;return f>=1e7&&(g+=Math.floor(f/1e7),f%=1e7),g>=1e7&&(h+=Math.floor(g/1e7),g%=1e7),h.toString()+aa(g)+aa(f)}function $(a,b){return{lo:0|a,hi:0|b}}function _(a,b){return b=~b,a?a=~a+1:b+=1,$(a,b)}let aa=a=>{let b=String(a);return"0000000".slice(b.length)+b};function ab(a,b){if(a>=0){for(;a>127;)b.push(127&a|128),a>>>=7;b.push(a)}else{for(let c=0;c<9;c++)b.push(127&a|128),a>>=7;b.push(1)}}function ac(){let a=this.buf[this.pos++],b=127&a;if((128&a)==0||(b|=(127&(a=this.buf[this.pos++]))<<7,(128&a)==0)||(b|=(127&(a=this.buf[this.pos++]))<<14,(128&a)==0)||(b|=(127&(a=this.buf[this.pos++]))<<21,(128&a)==0))return this.assertBounds(),b;b|=(15&(a=this.buf[this.pos++]))<<28;for(let b=5;(128&a)!=0&&b<10;b++)a=this.buf[this.pos++];if((128&a)!=0)throw Error("invalid varint");return this.assertBounds(),b>>>0}let ad=function(){let a=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof a.getBigInt64&&"function"==typeof a.getBigUint64&&"function"==typeof a.setBigInt64&&"function"==typeof a.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){let b=BigInt("-9223372036854775808"),c=BigInt("9223372036854775807"),d=BigInt("0"),e=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(a){let d="bigint"==typeof a?a:BigInt(a);if(d>c||d<b)throw Error("int64 invalid: ".concat(a));return d},uParse(a){let b="bigint"==typeof a?a:BigInt(a);if(b>e||b<d)throw Error("uint64 invalid: ".concat(a));return b},enc(b){return a.setBigInt64(0,this.parse(b),!0),{lo:a.getInt32(0,!0),hi:a.getInt32(4,!0)}},uEnc(b){return a.setBigInt64(0,this.uParse(b),!0),{lo:a.getInt32(0,!0),hi:a.getInt32(4,!0)}},dec:(b,c)=>(a.setInt32(0,b,!0),a.setInt32(4,c,!0),a.getBigInt64(0,!0)),uDec:(b,c)=>(a.setInt32(0,b,!0),a.setInt32(4,c,!0),a.getBigUint64(0,!0))}}let b=a=>N(/^-?[0-9]+$/.test(a),"int64 invalid: ".concat(a)),c=a=>N(/^[0-9]+$/.test(a),"uint64 invalid: ".concat(a));return{zero:"0",supported:!1,parse:a=>("string"!=typeof a&&(a=a.toString()),b(a),a),uParse:a=>("string"!=typeof a&&(a=a.toString()),c(a),a),enc:a=>("string"!=typeof a&&(a=a.toString()),b(a),Y(a)),uEnc:a=>("string"!=typeof a&&(a=a.toString()),c(a),Y(a)),dec:(a,b)=>{let c,d,e;return(d=0x80000000&(c=$(a,b)).hi)&&(c=_(c.lo,c.hi)),e=Z(c.lo,c.hi),d?"-"+e:e},uDec:(a,b)=>Z(a,b)}}();function ae(a,b,c){if(b===c)return!0;if(a==hs.BYTES){if(!(b instanceof Uint8Array)||!(c instanceof Uint8Array)||b.length!==c.length)return!1;for(let a=0;a<b.length;a++)if(b[a]!==c[a])return!1;return!0}switch(a){case hs.UINT64:case hs.FIXED64:case hs.INT64:case hs.SFIXED64:case hs.SINT64:return b==c}return!1}function af(a,b){switch(a){case hs.BOOL:return!1;case hs.UINT64:case hs.FIXED64:case hs.INT64:case hs.SFIXED64:case hs.SINT64:return 0==b?ad.zero:"0";case hs.DOUBLE:case hs.FLOAT:return 0;case hs.BYTES:return new Uint8Array(0);case hs.STRING:return"";default:return 0}}function ag(a,b){switch(a){case hs.BOOL:return!1===b;case hs.STRING:return""===b;case hs.BYTES:return b instanceof Uint8Array&&!b.byteLength;default:return 0==b}}(gU=hs||(hs={}))[gU.DOUBLE=1]="DOUBLE",gU[gU.FLOAT=2]="FLOAT",gU[gU.INT64=3]="INT64",gU[gU.UINT64=4]="UINT64",gU[gU.INT32=5]="INT32",gU[gU.FIXED64=6]="FIXED64",gU[gU.FIXED32=7]="FIXED32",gU[gU.BOOL=8]="BOOL",gU[gU.STRING=9]="STRING",gU[gU.BYTES=12]="BYTES",gU[gU.UINT32=13]="UINT32",gU[gU.SFIXED32=15]="SFIXED32",gU[gU.SFIXED64=16]="SFIXED64",gU[gU.SINT32=17]="SINT32",gU[gU.SINT64=18]="SINT64",(gV=ht||(ht={}))[gV.BIGINT=0]="BIGINT",gV[gV.STRING=1]="STRING",(gW=hu||(hu={}))[gW.Varint=0]="Varint",gW[gW.Bit64=1]="Bit64",gW[gW.LengthDelimited=2]="LengthDelimited",gW[gW.StartGroup=3]="StartGroup",gW[gW.EndGroup=4]="EndGroup",gW[gW.Bit32=5]="Bit32";class ah{constructor(a){this.stack=[],this.textEncoder=null!=a?a:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let a=0;for(let b=0;b<this.chunks.length;b++)a+=this.chunks[b].length;let b=new Uint8Array(a),c=0;for(let a=0;a<this.chunks.length;a++)b.set(this.chunks[a],c),c+=this.chunks[a].length;return this.chunks=[],b}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let a=this.finish(),b=this.stack.pop();if(!b)throw Error("invalid state, fork stack empty");return this.chunks=b.chunks,this.buf=b.buf,this.uint32(a.byteLength),this.raw(a)}tag(a,b){return this.uint32((a<<3|b)>>>0)}raw(a){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(a),this}uint32(a){for(P(a);a>127;)this.buf.push(127&a|128),a>>>=7;return this.buf.push(a),this}int32(a){return O(a),ab(a,this.buf),this}bool(a){return this.buf.push(+!!a),this}bytes(a){return this.uint32(a.byteLength),this.raw(a)}string(a){let b=this.textEncoder.encode(a);return this.uint32(b.byteLength),this.raw(b)}float(a){Q(a);let b=new Uint8Array(4);return new DataView(b.buffer).setFloat32(0,a,!0),this.raw(b)}double(a){let b=new Uint8Array(8);return new DataView(b.buffer).setFloat64(0,a,!0),this.raw(b)}fixed32(a){P(a);let b=new Uint8Array(4);return new DataView(b.buffer).setUint32(0,a,!0),this.raw(b)}sfixed32(a){O(a);let b=new Uint8Array(4);return new DataView(b.buffer).setInt32(0,a,!0),this.raw(b)}sint32(a){return O(a),ab(a=(a<<1^a>>31)>>>0,this.buf),this}sfixed64(a){let b=new Uint8Array(8),c=new DataView(b.buffer),d=ad.enc(a);return c.setInt32(0,d.lo,!0),c.setInt32(4,d.hi,!0),this.raw(b)}fixed64(a){let b=new Uint8Array(8),c=new DataView(b.buffer),d=ad.uEnc(a);return c.setInt32(0,d.lo,!0),c.setInt32(4,d.hi,!0),this.raw(b)}int64(a){let b=ad.enc(a);return X(b.lo,b.hi,this.buf),this}sint64(a){let b=ad.enc(a),c=b.hi>>31;return X(b.lo<<1^c,(b.hi<<1|b.lo>>>31)^c,this.buf),this}uint64(a){let b=ad.uEnc(a);return X(b.lo,b.hi,this.buf),this}}class ai{constructor(a,b){this.varint64=W,this.uint32=ac,this.buf=a,this.len=a.length,this.pos=0,this.view=new DataView(a.buffer,a.byteOffset,a.byteLength),this.textDecoder=null!=b?b:new TextDecoder}tag(){let a=this.uint32(),b=a>>>3,c=7&a;if(b<=0||c<0||c>5)throw Error("illegal tag: field no "+b+" wire type "+c);return[b,c]}skip(a,b){let c=this.pos;switch(a){case hu.Varint:for(;128&this.buf[this.pos++];);break;case hu.Bit64:this.pos+=4;case hu.Bit32:this.pos+=4;break;case hu.LengthDelimited:let d=this.uint32();this.pos+=d;break;case hu.StartGroup:for(;;){let[a,c]=this.tag();if(c===hu.EndGroup){if(void 0!==b&&a!==b)throw Error("invalid end group tag");break}this.skip(c,a)}break;default:throw Error("cant skip wire type "+a)}return this.assertBounds(),this.buf.subarray(c,this.pos)}assertBounds(){if(this.pos>this.len)throw RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let a=this.uint32();return a>>>1^-(1&a)}int64(){return ad.dec(...this.varint64())}uint64(){return ad.uDec(...this.varint64())}sint64(){let[a,b]=this.varint64(),c=-(1&a);return a=(a>>>1|(1&b)<<31)^c,b=b>>>1^c,ad.dec(a,b)}bool(){let[a,b]=this.varint64();return 0!==a||0!==b}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return ad.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return ad.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let a=this.uint32(),b=this.pos;return this.pos+=a,this.assertBounds(),this.buf.subarray(b,b+a)}string(){return this.textDecoder.decode(this.bytes())}}function aj(a){let b=a.field.localName,c=Object.create(null);return c[b]=function(a){let b=a.field;if(b.repeated)return[];if(void 0!==b.default)return b.default;switch(b.kind){case"enum":return b.T.values[0].no;case"scalar":return af(b.T,b.L);case"message":let c=b.T,d=new c;return c.fieldWrapper?c.fieldWrapper.unwrapField(d):d;case"map":throw"map fields are not allowed to be extensions"}}(a),[c,()=>c[b]]}let ak="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),al=[];for(let a=0;a<ak.length;a++)al[ak[a].charCodeAt(0)]=a;al[45]=ak.indexOf("+"),al[95]=ak.indexOf("/");let am={dec(a){let b=3*a.length/4;"="==a[a.length-2]?b-=2:"="==a[a.length-1]&&(b-=1);let c=new Uint8Array(b),d=0,e=0,f,g=0;for(let b=0;b<a.length;b++){if(void 0===(f=al[a.charCodeAt(b)]))switch(a[b]){case"=":e=0;case"\n":case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(e){case 0:g=f,e=1;break;case 1:c[d++]=g<<2|(48&f)>>4,g=f,e=2;break;case 2:c[d++]=(15&g)<<4|(60&f)>>2,g=f,e=3;break;case 3:c[d++]=(3&g)<<6|f,e=0}}if(1==e)throw Error("invalid base64 string.");return c.subarray(0,d)},enc(a){let b="",c=0,d,e=0;for(let f=0;f<a.length;f++)switch(d=a[f],c){case 0:b+=ak[d>>2],e=(3&d)<<4,c=1;break;case 1:b+=ak[e|d>>4],e=(15&d)<<2,c=2;break;case 2:b+=ak[e|d>>6],b+=ak[63&d],c=0}return c&&(b+=ak[e],b+="=",1==c&&(b+="=")),b}};function an(a,b){let c=a.getType();return b.extendee.typeName===c.typeName&&!!c.runtime.bin.listUnknownFields(a).find(a=>a.no==b.field.no)}function ao(a,b){N(a.extendee.typeName==b.getType().typeName,"extension ".concat(a.typeName," can only be applied to message ").concat(a.extendee.typeName))}function ap(a,b){let c=a.localName;if(a.repeated)return b[c].length>0;if(a.oneof)return b[a.oneof.localName].case===c;switch(a.kind){case"enum":case"scalar":if(a.opt||a.req)return void 0!==b[c];if("enum"==a.kind)return b[c]!==a.T.values[0].no;return!ag(a.T,b[c]);case"message":return void 0!==b[c];case"map":return Object.keys(b[c]).length>0}}function aq(a,b){let c=a.localName,d=!a.opt&&!a.req;if(a.repeated)b[c]=[];else if(a.oneof)b[a.oneof.localName]={case:void 0};else switch(a.kind){case"map":b[c]={};break;case"enum":b[c]=d?a.T.values[0].no:void 0;break;case"scalar":b[c]=d?af(a.T,a.L):void 0;break;case"message":b[c]=void 0}}function ar(a,b){if(null===a||"object"!=typeof a||!Object.getOwnPropertyNames(V.prototype).every(b=>b in a&&"function"==typeof a[b]))return!1;let c=a.getType();return null!==c&&"function"==typeof c&&"typeName"in c&&"string"==typeof c.typeName&&(void 0===b||c.typeName==b.typeName)}function as(a,b){return ar(b)||!a.fieldWrapper?b:a.fieldWrapper.wrapField(b)}hs.DOUBLE,hs.FLOAT,hs.INT64,hs.UINT64,hs.INT32,hs.UINT32,hs.BOOL,hs.STRING,hs.BYTES;let at={ignoreUnknownFields:!1},au={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},av=Symbol(),aw=Symbol();function ax(a){if(null===a)return"null";switch(typeof a){case"object":return Array.isArray(a)?"array":"object";case"string":return a.length>100?"string":'"'.concat(a.split('"').join('\\"'),'"');default:return String(a)}}function ay(a,b,c,d,e){let f=c.localName;if(c.repeated){if(N("map"!=c.kind),null===b)return;if(!Array.isArray(b))throw Error("cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(b)));let g=a[f];for(let a of b){if(null===a)throw Error("cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(a)));switch(c.kind){case"message":g.push(c.T.fromJson(a,d));break;case"enum":let b=aA(c.T,a,d.ignoreUnknownFields,!0);b!==aw&&g.push(b);break;case"scalar":try{g.push(az(c.T,a,c.L,!0))}catch(d){let b="cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(a));throw d instanceof Error&&d.message.length>0&&(b+=": ".concat(d.message)),Error(b)}}}}else if("map"==c.kind){if(null===b)return;if("object"!=typeof b||Array.isArray(b))throw Error("cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(b)));let g=a[f];for(let[a,f]of Object.entries(b)){let h;if(null===f)throw Error("cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: map value null"));try{h=function(a,b){if(a===hs.BOOL)switch(b){case"true":b=!0;break;case"false":b=!1}return az(a,b,ht.BIGINT,!0).toString()}(c.K,a)}catch(d){let a="cannot decode map key for field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(b));throw d instanceof Error&&d.message.length>0&&(a+=": ".concat(d.message)),Error(a)}switch(c.V.kind){case"message":g[h]=c.V.T.fromJson(f,d);break;case"enum":let i=aA(c.V.T,f,d.ignoreUnknownFields,!0);i!==aw&&(g[h]=i);break;case"scalar":try{g[h]=az(c.V.T,f,ht.BIGINT,!0)}catch(d){let a="cannot decode map value for field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(b));throw d instanceof Error&&d.message.length>0&&(a+=": ".concat(d.message)),Error(a)}}}}else switch(c.oneof&&(a=a[c.oneof.localName]={case:f},f="value"),c.kind){case"message":let g=c.T;if(null===b&&"google.protobuf.Value"!=g.typeName)return;let h=a[f];ar(h)?h.fromJson(b,d):(a[f]=h=g.fromJson(b,d),g.fieldWrapper&&!c.oneof&&(a[f]=g.fieldWrapper.unwrapField(h)));break;case"enum":let i=aA(c.T,b,d.ignoreUnknownFields,!1);switch(i){case av:aq(c,a);break;case aw:break;default:a[f]=i}break;case"scalar":try{let d=az(c.T,b,c.L,!1);d===av?aq(c,a):a[f]=d}catch(d){let a="cannot decode field ".concat(e.typeName,".").concat(c.name," from JSON: ").concat(ax(b));throw d instanceof Error&&d.message.length>0&&(a+=": ".concat(d.message)),Error(a)}}}function az(a,b,c,d){if(null===b)return d?af(a,c):av;switch(a){case hs.DOUBLE:case hs.FLOAT:if("NaN"===b)return NaN;if("Infinity"===b)return 1/0;if("-Infinity"===b)return-1/0;if(""===b||"string"==typeof b&&b.trim().length!==b.length||"string"!=typeof b&&"number"!=typeof b)break;let e=Number(b);if(Number.isNaN(e)||!Number.isFinite(e))break;return a==hs.FLOAT&&Q(e),e;case hs.INT32:case hs.FIXED32:case hs.SFIXED32:case hs.SINT32:case hs.UINT32:let f;if("number"==typeof b?f=b:"string"==typeof b&&b.length>0&&b.trim().length===b.length&&(f=Number(b)),void 0===f)break;return a==hs.UINT32||a==hs.FIXED32?P(f):O(f),f;case hs.INT64:case hs.SFIXED64:case hs.SINT64:if("number"!=typeof b&&"string"!=typeof b)break;let g=ad.parse(b);return c?g.toString():g;case hs.FIXED64:case hs.UINT64:if("number"!=typeof b&&"string"!=typeof b)break;let h=ad.uParse(b);return c?h.toString():h;case hs.BOOL:if("boolean"!=typeof b)break;return b;case hs.STRING:if("string"!=typeof b)break;try{encodeURIComponent(b)}catch(a){throw Error("invalid UTF8")}return b;case hs.BYTES:if(""===b)return new Uint8Array(0);if("string"!=typeof b)break;return am.dec(b)}throw Error()}function aA(a,b,c,d){if(null===b)return"google.protobuf.NullValue"==a.typeName?0:d?a.values[0].no:av;switch(typeof b){case"number":if(Number.isInteger(b))return b;break;case"string":let e=a.findName(b);if(void 0!==e)return e.no;if(c)return aw}throw Error("cannot decode enum ".concat(a.typeName," from JSON: ").concat(ax(b)))}function aB(a,b,c){if("map"==a.kind){N("object"==typeof b&&null!=b);let d={},e=Object.entries(b);switch(a.V.kind){case"scalar":for(let[b,c]of e)d[b.toString()]=aD(a.V.T,c);break;case"message":for(let[a,b]of e)d[a.toString()]=b.toJson(c);break;case"enum":let f=a.V.T;for(let[a,b]of e)d[a.toString()]=aC(f,b,c.enumAsInteger)}return c.emitDefaultValues||e.length>0?d:void 0}if(a.repeated){N(Array.isArray(b));let d=[];switch(a.kind){case"scalar":for(let c=0;c<b.length;c++)d.push(aD(a.T,b[c]));break;case"enum":for(let e=0;e<b.length;e++)d.push(aC(a.T,b[e],c.enumAsInteger));break;case"message":for(let a=0;a<b.length;a++)d.push(b[a].toJson(c))}return c.emitDefaultValues||d.length>0?d:void 0}switch(a.kind){case"scalar":return aD(a.T,b);case"enum":return aC(a.T,b,c.enumAsInteger);case"message":return as(a.T,b).toJson(c)}}function aC(a,b,c){var d;if(N("number"==typeof b),"google.protobuf.NullValue"==a.typeName)return null;if(c)return b;let e=a.findNumber(b);return null!=(d=null==e?void 0:e.name)?d:b}function aD(a,b){switch(a){case hs.INT32:case hs.SFIXED32:case hs.SINT32:case hs.FIXED32:case hs.UINT32:return N("number"==typeof b),b;case hs.FLOAT:case hs.DOUBLE:if(N("number"==typeof b),Number.isNaN(b))return"NaN";if(b===1/0)return"Infinity";if(b===-1/0)return"-Infinity";return b;case hs.STRING:return N("string"==typeof b),b;case hs.BOOL:return N("boolean"==typeof b),b;case hs.UINT64:case hs.FIXED64:case hs.INT64:case hs.SFIXED64:case hs.SINT64:return N("bigint"==typeof b||"string"==typeof b||"number"==typeof b),b.toString();case hs.BYTES:return N(b instanceof Uint8Array),am.enc(b)}}let aE=Symbol("@bufbuild/protobuf/unknown-fields"),aF={readUnknownFields:!0,readerFactory:a=>new ai(a)},aG={writeUnknownFields:!0,writerFactory:()=>new ah};function aH(a,b,c,d,e){let{repeated:f,localName:g}=c;switch(c.oneof&&((a=a[c.oneof.localName]).case!=g&&delete a.value,a.case=g,g="value"),c.kind){case"scalar":case"enum":let h="enum"==c.kind?hs.INT32:c.T,i=aK;if("scalar"==c.kind&&c.L>0&&(i=aJ),f){let c=a[g];if(d==hu.LengthDelimited&&h!=hs.STRING&&h!=hs.BYTES){let a=b.uint32()+b.pos;for(;b.pos<a;)c.push(i(b,h))}else c.push(i(b,h))}else a[g]=i(b,h);break;case"message":let j=c.T;f?a[g].push(aI(b,new j,e,c)):ar(a[g])?aI(b,a[g],e,c):(a[g]=aI(b,new j,e,c),!j.fieldWrapper||c.oneof||c.repeated||(a[g]=j.fieldWrapper.unwrapField(a[g])));break;case"map":let[k,l]=function(a,b,c){let d,e,f=b.uint32(),g=b.pos+f;for(;b.pos<g;){let[f]=b.tag();switch(f){case 1:d=aK(b,a.K);break;case 2:switch(a.V.kind){case"scalar":e=aK(b,a.V.T);break;case"enum":e=b.int32();break;case"message":e=aI(b,new a.V.T,c,void 0)}}}if(void 0===d&&(d=af(a.K,ht.BIGINT)),"string"!=typeof d&&"number"!=typeof d&&(d=d.toString()),void 0===e)switch(a.V.kind){case"scalar":e=af(a.V.T,ht.BIGINT);break;case"enum":e=a.V.T.values[0].no;break;case"message":e=new a.V.T}return[d,e]}(c,b,e);a[g][k]=l}}function aI(a,b,c,d){let e=b.getType().runtime.bin,f=null==d?void 0:d.delimited;return e.readMessage(b,a,f?d.no:a.uint32(),c,f),b}function aJ(a,b){let c=aK(a,b);return"bigint"==typeof c?c.toString():c}function aK(a,b){switch(b){case hs.STRING:return a.string();case hs.BOOL:return a.bool();case hs.DOUBLE:return a.double();case hs.FLOAT:return a.float();case hs.INT32:return a.int32();case hs.INT64:return a.int64();case hs.UINT64:return a.uint64();case hs.FIXED64:return a.fixed64();case hs.BYTES:return a.bytes();case hs.FIXED32:return a.fixed32();case hs.SFIXED32:return a.sfixed32();case hs.SFIXED64:return a.sfixed64();case hs.SINT64:return a.sint64();case hs.UINT32:return a.uint32();case hs.SINT32:return a.sint32()}}function aL(a,b,c,d){N(void 0!==b);let e=a.repeated;switch(a.kind){case"scalar":case"enum":let f="enum"==a.kind?hs.INT32:a.T;if(e)if(N(Array.isArray(b)),a.packed)!function(a,b,c,d){if(!d.length)return;a.tag(c,hu.LengthDelimited).fork();let[,e]=aO(b);for(let b=0;b<d.length;b++)a[e](d[b]);a.join()}(c,f,a.no,b);else for(let d of b)aN(c,f,a.no,d);else aN(c,f,a.no,b);break;case"message":if(e)for(let e of(N(Array.isArray(b)),b))aM(c,d,a,e);else aM(c,d,a,b);break;case"map":for(let[e,f]of(N("object"==typeof b&&null!=b),Object.entries(b)))!function(a,b,c,d,e){a.tag(c.no,hu.LengthDelimited),a.fork();let f=d;switch(c.K){case hs.INT32:case hs.FIXED32:case hs.UINT32:case hs.SFIXED32:case hs.SINT32:f=Number.parseInt(d);break;case hs.BOOL:N("true"==d||"false"==d),f="true"==d}switch(aN(a,c.K,1,f),c.V.kind){case"scalar":aN(a,c.V.T,2,e);break;case"enum":aN(a,hs.INT32,2,e);break;case"message":N(void 0!==e),a.tag(2,hu.LengthDelimited).bytes(e.toBinary(b))}a.join()}(c,d,a,e,f)}}function aM(a,b,c,d){let e=as(c.T,d);c.delimited?a.tag(c.no,hu.StartGroup).raw(e.toBinary(b)).tag(c.no,hu.EndGroup):a.tag(c.no,hu.LengthDelimited).bytes(e.toBinary(b))}function aN(a,b,c,d){N(void 0!==d);let[e,f]=aO(b);a.tag(c,e)[f](d)}function aO(a){let b=hu.Varint;switch(a){case hs.BYTES:case hs.STRING:b=hu.LengthDelimited;break;case hs.DOUBLE:case hs.FIXED64:case hs.SFIXED64:b=hu.Bit64;break;case hs.FIXED32:case hs.SFIXED32:case hs.FLOAT:b=hu.Bit32}return[b,hs[a].toLowerCase()]}function aP(a){if(void 0===a)return a;if(ar(a))return a.clone();if(a instanceof Uint8Array){let b=new Uint8Array(a.byteLength);return b.set(a),b}return a}function aQ(a){return a instanceof Uint8Array?a:new Uint8Array(a)}class aR{constructor(a,b){this._fields=a,this._normalizer=b}findJsonName(a){if(!this.jsonNames){let a={};for(let b of this.list())a[b.jsonName]=a[b.name]=b;this.jsonNames=a}return this.jsonNames[a]}find(a){if(!this.numbers){let a={};for(let b of this.list())a[b.no]=b;this.numbers=a}return this.numbers[a]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((a,b)=>a.no-b.no)),this.numbersAsc}byMember(){if(!this.members){let a;this.members=[];let b=this.members;for(let c of this.list())c.oneof?c.oneof!==a&&(a=c.oneof,b.push(a)):b.push(c)}return this.members}}function aS(a,b){let c=aU(a);return b?c:aY(aX(c))}let aT=aU;function aU(a){let b=!1,c=[];for(let d=0;d<a.length;d++){let e=a.charAt(d);switch(e){case"_":b=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":c.push(e),b=!1;break;default:b&&(b=!1,e=e.toUpperCase()),c.push(e)}}return c.join("")}let aV=new Set(["constructor","toString","toJSON","valueOf"]),aW=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),aX=a=>{if(aW.has(a))return"".concat(a,"$");return a},aY=a=>{if(aV.has(a))return"".concat(a,"$");return a};class aZ{constructor(a){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=a,this.localName=aS(a,!1)}addField(a){N(a.oneof===this,"field ".concat(a.name," not one of ").concat(this.name)),this.fields.push(a)}findField(a){if(!this._lookup){this._lookup=Object.create(null);for(let a=0;a<this.fields.length;a++)this._lookup[this.fields[a].localName]=this.fields[a]}return this._lookup[a]}}let a$=(gX=a=>new aR(a,a=>(function(a,b){var c,d,e,f,g,h;let i,j=[];for(let b of"function"==typeof a?a():a){if(b.localName=aS(b.name,void 0!==b.oneof),b.jsonName=null!=(c=b.jsonName)?c:aT(b.name),b.repeated=null!=(d=b.repeated)&&d,"scalar"==b.kind&&(b.L=null!=(e=b.L)?e:ht.BIGINT),b.delimited=null!=(f=b.delimited)&&f,b.req=null!=(g=b.req)&&g,b.opt=null!=(h=b.opt)&&h,void 0===b.packed&&(b.packed="enum"==b.kind||"scalar"==b.kind&&b.T!=hs.BYTES&&b.T!=hs.STRING),void 0!==b.oneof){let a="string"==typeof b.oneof?b.oneof:b.oneof.name;i&&i.name==a||(i=new aZ(a)),b.oneof=i,i.addField(b)}j.push(b)}return j})(a)),gY=a=>{for(let b of a.getType().fields.byMember()){if(b.opt)continue;let c=b.localName;if(b.repeated){a[c]=[];continue}switch(b.kind){case"oneof":a[c]={case:void 0};break;case"enum":a[c]=0;break;case"map":a[c]={};break;case"scalar":a[c]=af(b.T,b.L)}}},{syntax:"proto3",json:{makeReadOptions:function(a){return a?Object.assign(Object.assign({},at),a):at},makeWriteOptions:function(a){return a?Object.assign(Object.assign({},au),a):au},readMessage(a,b,c,d){if(null==b||Array.isArray(b)||"object"!=typeof b)throw Error("cannot decode message ".concat(a.typeName," from JSON: ").concat(ax(b)));d=null!=d?d:new a;let e=new Map,f=c.typeRegistry;for(let[g,h]of Object.entries(b)){let b=a.fields.findJsonName(g);if(b){if(b.oneof){if(null===h&&"scalar"==b.kind)continue;let c=e.get(b.oneof);if(void 0!==c)throw Error("cannot decode message ".concat(a.typeName,' from JSON: multiple keys for oneof "').concat(b.oneof.name,'" present: "').concat(c,'", "').concat(g,'"'));e.set(b.oneof,g)}ay(d,h,b,c,a)}else{let b=!1;if((null==f?void 0:f.findExtension)&&g.startsWith("[")&&g.endsWith("]")){let e=f.findExtension(g.substring(1,g.length-1));if(e&&e.extendee.typeName==a.typeName){b=!0;let[a,f]=aj(e);ay(a,h,e.field,c,e),function(a,b,c,d){ao(b,a);let e=b.runtime.bin.makeReadOptions(d),f=b.runtime.bin.makeWriteOptions(d);if(an(a,b)){let c=a.getType().runtime.bin.listUnknownFields(a).filter(a=>a.no!=b.field.no);for(let b of(a.getType().runtime.bin.discardUnknownFields(a),c))a.getType().runtime.bin.onUnknownField(a,b.no,b.wireType,b.data)}let g=f.writerFactory(),h=b.field;h.opt||h.repeated||"enum"!=h.kind&&"scalar"!=h.kind||(h=Object.assign(Object.assign({},b.field),{opt:!0})),b.runtime.bin.writeField(h,c,g,f);let i=e.readerFactory(g.finish());for(;i.pos<i.len;){let[b,c]=i.tag(),d=i.skip(c,b);a.getType().runtime.bin.onUnknownField(a,b,c,d)}}(d,e,f(),c)}}if(!b&&!c.ignoreUnknownFields)throw Error("cannot decode message ".concat(a.typeName,' from JSON: key "').concat(g,'" is unknown'))}}return d},writeMessage(a,b){let c,d=a.getType(),e={};try{for(c of d.fields.byNumber()){if(!ap(c,a)){var f;if(c.req)throw"required field not set";if(!b.emitDefaultValues||!((f=c).repeated||"map"==f.kind||!f.oneof&&"message"!=f.kind&&!f.opt&&!f.req))continue}let d=c.oneof?a[c.oneof.localName].value:a[c.localName],g=aB(c,d,b);void 0!==g&&(e[b.useProtoFieldName?c.name:c.jsonName]=g)}let g=b.typeRegistry;if(null==g?void 0:g.findExtensionFor)for(let c of d.runtime.bin.listUnknownFields(a)){let f=g.findExtensionFor(d.typeName,c.no);if(f&&an(a,f)){let c=function(a,b,c){ao(b,a);let d=b.runtime.bin.makeReadOptions(c),e=function(a,b){if(!b.repeated&&("enum"==b.kind||"scalar"==b.kind)){for(let c=a.length-1;c>=0;--c)if(a[c].no==b.no)return[a[c]];return[]}return a.filter(a=>a.no===b.no)}(a.getType().runtime.bin.listUnknownFields(a),b.field),[f,g]=aj(b);for(let a of e)b.runtime.bin.readField(f,d.readerFactory(a.data),b.field,a.wireType,d);return g()}(a,f,b),d=aB(f.field,c,b);void 0!==d&&(e[f.field.jsonName]=d)}}}catch(e){let a=c?"cannot encode field ".concat(d.typeName,".").concat(c.name," to JSON"):"cannot encode message ".concat(d.typeName," to JSON"),b=e instanceof Error?e.message:String(e);throw Error(a+(b.length>0?": ".concat(b):""))}return e},readScalar:(a,b,c)=>az(a,b,null!=c?c:ht.BIGINT,!0),writeScalar(a,b,c){if(void 0!==b&&(c||ag(a,b)))return aD(a,b)},debug:ax},bin:{makeReadOptions:function(a){return a?Object.assign(Object.assign({},aF),a):aF},makeWriteOptions:function(a){return a?Object.assign(Object.assign({},aG),a):aG},listUnknownFields(a){var b;return null!=(b=a[aE])?b:[]},discardUnknownFields(a){delete a[aE]},writeUnknownFields(a,b){let c=a[aE];if(c)for(let a of c)b.tag(a.no,a.wireType).raw(a.data)},onUnknownField(a,b,c,d){Array.isArray(a[aE])||(a[aE]=[]),a[aE].push({no:b,wireType:c,data:d})},readMessage(a,b,c,d,e){let f,g,h=a.getType(),i=e?b.len:b.pos+c;for(;b.pos<i&&([f,g]=b.tag(),!0!==e||g!=hu.EndGroup);){let c=h.fields.find(f);if(!c){let c=b.skip(g,f);d.readUnknownFields&&this.onUnknownField(a,f,g,c);continue}aH(a,b,c,g,d)}if(e&&(g!=hu.EndGroup||f!==c))throw Error("invalid end group tag")},readField:aH,writeMessage(a,b,c){let d=a.getType();for(let e of d.fields.byNumber()){if(!ap(e,a)){if(e.req)throw Error("cannot encode field ".concat(d.typeName,".").concat(e.name," to binary: required field not set"));continue}let f=e.oneof?a[e.oneof.localName].value:a[e.localName];aL(e,f,b,c)}return c.writeUnknownFields&&this.writeUnknownFields(a,b),b},writeField(a,b,c,d){void 0!==b&&aL(a,b,c,d)}},util:Object.assign(Object.assign({},{setEnumType:S,initPartial(a,b){if(void 0!==a)for(let c of b.getType().fields.byMember()){let d=c.localName;if(null!=a[d])switch(c.kind){case"oneof":let e=a[d].case;if(void 0===e)continue;let f=c.findField(e),g=a[d].value;f&&"message"==f.kind&&!ar(g,f.T)?g=new f.T(g):f&&"scalar"===f.kind&&f.T===hs.BYTES&&(g=aQ(g)),b[d]={case:e,value:g};break;case"scalar":case"enum":let h=a[d];c.T===hs.BYTES&&(h=c.repeated?h.map(aQ):aQ(h)),b[d]=h;break;case"map":switch(c.V.kind){case"scalar":case"enum":if(c.V.T===hs.BYTES)for(let[c,e]of Object.entries(a[d]))b[d][c]=aQ(e);else Object.assign(b[d],a[d]);break;case"message":let i=c.V.T;for(let c of Object.keys(a[d])){let e=a[d][c];i.fieldWrapper||(e=new i(e)),b[d][c]=e}}break;case"message":let j=c.T;if(c.repeated)b[d]=a[d].map(a=>ar(a,j)?a:new j(a));else{let c=a[d];j.fieldWrapper?"google.protobuf.BytesValue"===j.typeName?b[d]=aQ(c):b[d]=c:b[d]=ar(c,j)?c:new j(c)}}}},equals:(a,b,c)=>b===c||!!b&&!!c&&a.fields.byMember().every(a=>{let d=b[a.localName],e=c[a.localName];if(a.repeated){if(d.length!==e.length)return!1;switch(a.kind){case"message":return d.every((b,c)=>a.T.equals(b,e[c]));case"scalar":return d.every((b,c)=>ae(a.T,b,e[c]));case"enum":return d.every((a,b)=>ae(hs.INT32,a,e[b]))}throw Error("repeated cannot contain ".concat(a.kind))}switch(a.kind){case"message":let f=d,g=e;return a.T.fieldWrapper&&(void 0===f||ar(f)||(f=a.T.fieldWrapper.wrapField(f)),void 0===g||ar(g)||(g=a.T.fieldWrapper.wrapField(g))),a.T.equals(f,g);case"enum":return ae(hs.INT32,d,e);case"scalar":return ae(a.T,d,e);case"oneof":if(d.case!==e.case)return!1;let h=a.findField(d.case);if(void 0===h)return!0;switch(h.kind){case"message":return h.T.equals(d.value,e.value);case"enum":return ae(hs.INT32,d.value,e.value);case"scalar":return ae(h.T,d.value,e.value)}throw Error("oneof cannot contain ".concat(h.kind));case"map":let i=Object.keys(d).concat(Object.keys(e));switch(a.V.kind){case"message":let j=a.V.T;return i.every(a=>j.equals(d[a],e[a]));case"enum":return i.every(a=>ae(hs.INT32,d[a],e[a]));case"scalar":let k=a.V.T;return i.every(a=>ae(k,d[a],e[a]))}}}),clone(a){let b=a.getType(),c=new b;for(let d of b.fields.byMember()){let b,e=a[d.localName];if(d.repeated)b=e.map(aP);else if("map"==d.kind)for(let[a,f]of(b=c[d.localName],Object.entries(e)))b[a]=aP(f);else b="oneof"==d.kind?d.findField(e.case)?{case:e.case,value:aP(e.value)}:{case:void 0}:aP(e);c[d.localName]=b}for(let d of b.runtime.bin.listUnknownFields(a))b.runtime.bin.onUnknownField(c,d.no,d.wireType,d.data);return c}}),{newFieldList:gX,initFields:gY}),makeMessageType(a,b,c){var d,e;let f,g;return d=this,Object.setPrototypeOf((g=({[f=null!=(e=null==c?void 0:c.localName)?e:a.substring(a.lastIndexOf(".")+1)]:function(a){d.util.initFields(this),d.util.initPartial(a,this)}})[f]).prototype,new V),Object.assign(g,{runtime:d,typeName:a,fields:d.util.newFieldList(b),fromBinary:(a,b)=>new g().fromBinary(a,b),fromJson:(a,b)=>new g().fromJson(a,b),fromJsonString:(a,b)=>new g().fromJsonString(a,b),equals:(a,b)=>d.util.equals(g,a,b)}),g},makeEnum:function(a,b,c){let d={};for(let a of b){let b=U(a);d[b.localName]=b.no,d[b.no]=b.localName}return S(d,a,b),d},makeEnumType:T,getEnumType:function(a){let b=a[R];return N(b,"missing enum type on enum object"),b},makeExtension(a,b,c){var d;let e;return d=this,{typeName:a,extendee:b,get field(){if(!e){let b="function"==typeof c?c():c;b.name=a.split(".").pop(),b.jsonName="[".concat(a,"]"),e=d.util.newFieldList([b]).list()[0]}return e},runtime:d}}});class a_ extends V{constructor(a){super(),this.seconds=ad.zero,this.nanos=0,a$.util.initPartial(a,this)}fromJson(a,b){if("string"!=typeof a)throw Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(a$.json.debug(a)));let c=a.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!c)throw Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");let d=Date.parse(c[1]+"-"+c[2]+"-"+c[3]+"T"+c[4]+":"+c[5]+":"+c[6]+(c[8]?c[8]:"Z"));if(Number.isNaN(d))throw Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(d<Date.parse("0001-01-01T00:00:00Z")||d>Date.parse("9999-12-31T23:59:59Z"))throw Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=ad.parse(d/1e3),this.nanos=0,c[7]&&(this.nanos=parseInt("1"+c[7]+"0".repeat(9-c[7].length))-1e9),this}toJson(a){let b=1e3*Number(this.seconds);if(b<Date.parse("0001-01-01T00:00:00Z")||b>Date.parse("9999-12-31T23:59:59Z"))throw Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let c="Z";if(this.nanos>0){let a=(this.nanos+1e9).toString().substring(1);c="000000"===a.substring(3)?"."+a.substring(0,3)+"Z":"000"===a.substring(6)?"."+a.substring(0,6)+"Z":"."+a+"Z"}return new Date(b).toISOString().replace(".000Z",c)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return a_.fromDate(new Date)}static fromDate(a){let b=a.getTime();return new a_({seconds:ad.parse(Math.floor(b/1e3)),nanos:b%1e3*1e6})}static fromBinary(a,b){return new a_().fromBinary(a,b)}static fromJson(a,b){return new a_().fromJson(a,b)}static fromJsonString(a,b){return new a_().fromJsonString(a,b)}static equals(a,b){return a$.util.equals(a_,a,b)}}a_.runtime=a$,a_.typeName="google.protobuf.Timestamp",a_.fields=a$.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);let a0=a$.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:a_},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:a1,repeated:!0},{no:5,name:"events",kind:"message",T:a3,repeated:!0}]),a1=a$.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:a2,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),a2=a$.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:a_},{no:3,name:"value",kind:"scalar",T:2}]),a3=a$.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:a_},{no:7,name:"normalized_end_timestamp",kind:"message",T:a_,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),a4=a$.makeEnum("livekit.AudioCodec",[{no:0,name:"DEFAULT_AC"},{no:1,name:"OPUS"},{no:2,name:"AAC"},{no:3,name:"AC_MP3"}]),a5=a$.makeEnum("livekit.VideoCodec",[{no:0,name:"DEFAULT_VC"},{no:1,name:"H264_BASELINE"},{no:2,name:"H264_MAIN"},{no:3,name:"H264_HIGH"},{no:4,name:"VP8"}]),a6=a$.makeEnum("livekit.ImageCodec",[{no:0,name:"IC_DEFAULT"},{no:1,name:"IC_JPEG"}]),a7=a$.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),a8=a$.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),a9=a$.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),ba=a$.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),bb=a$.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),bc=a$.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),bd=a$.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),be=a$.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),bf=a$.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),bg=a$.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),bh=a$.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:bi,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:bQ}]),bi=a$.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),bj=a$.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:a$.getEnumType(a9),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),bk=a$.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:a$.getEnumType(bl)},{no:4,name:"tracks",kind:"message",T:bq,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:bj},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:a$.getEnumType(bm)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:a$.getEnumType(bd)},{no:18,name:"kind_details",kind:"enum",T:a$.getEnumType(bn),repeated:!0}]),bl=a$.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),bm=a$.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),bn=a$.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),bo=a$.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),bp=a$.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:br,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:a$.getEnumType(bs)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),bq=a$.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:a$.getEnumType(a8)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:a$.getEnumType(a9)},{no:10,name:"layers",kind:"message",T:br,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:bp,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:a$.getEnumType(bo)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:bQ},{no:19,name:"audio_features",kind:"enum",T:a$.getEnumType(bg),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:a$.getEnumType(a7)}]),br=a$.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:a$.getEnumType(ba)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),bs=a$.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),bt=a$.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:a$.getEnumType(bu)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:bz,oneof:"value"},{no:3,name:"speaker",kind:"message",T:bx,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:bA,oneof:"value"},{no:7,name:"transcription",kind:"message",T:bB,oneof:"value"},{no:8,name:"metrics",kind:"message",T:a0,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:bD,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:bE,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:bF,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:bG,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:bU,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:bV,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:bW,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:bv,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),bu=a$.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),bv=a$.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:a$.getEnumType(bo)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),bw=a$.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:bz,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:bD,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:bE,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:bF,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:bG,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:bU,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:bV,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:bW,oneof:"value"}]),bx=a$.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:by,repeated:!0}]),by=a$.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),bz=a$.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),bA=a$.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),bB=a$.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:bC,repeated:!0}]),bC=a$.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),bD=a$.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),bE=a$.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),bF=a$.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),bG=a$.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:bH,oneof:"value"}]),bH=a$.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),bI=a$.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),bJ=a$.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:a$.getEnumType(bK)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),bK=a$.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),bL=a$.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:a$.getEnumType(bM)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),bM=a$.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),bN=a$.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:bO},{no:2,name:"screen",kind:"message",T:bO},{no:3,name:"resume_connection",kind:"enum",T:a$.getEnumType(bc)},{no:4,name:"disabled_codecs",kind:"message",T:bP},{no:5,name:"force_relay",kind:"enum",T:a$.getEnumType(bc)}]),bO=a$.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:a$.getEnumType(bc)}]),bP=a$.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:bi,repeated:!0},{no:2,name:"publish",kind:"message",T:bi,repeated:!0}]),bQ=a$.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),bR=a$.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),bS=a$.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:a$.getEnumType(bR)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),bT=a$.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),bU=a$.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:a$.getEnumType(bo)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:bS,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:bT,oneof:"content_header"}],{localName:"DataStream_Header"}),bV=a$.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),bW=a$.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),bX=a$.makeMessageType("livekit.FilterParams",()=>[{no:1,name:"include_events",kind:"scalar",T:9,repeated:!0},{no:2,name:"exclude_events",kind:"scalar",T:9,repeated:!0}]),bY=a$.makeMessageType("livekit.WebhookConfig",()=>[{no:1,name:"url",kind:"scalar",T:9},{no:2,name:"signing_key",kind:"scalar",T:9},{no:3,name:"filter_params",kind:"message",T:bX}]),bZ=a$.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),b$=a$.makeMessageType("livekit.RoomAgentDispatch",()=>[{no:1,name:"agent_name",kind:"scalar",T:9},{no:2,name:"metadata",kind:"scalar",T:9}]),b_=a$.makeEnum("livekit.EncodedFileType",[{no:0,name:"DEFAULT_FILETYPE"},{no:1,name:"MP4"},{no:2,name:"OGG"},{no:3,name:"MP3"}]),b0=a$.makeEnum("livekit.SegmentedFileProtocol",[{no:0,name:"DEFAULT_SEGMENTED_FILE_PROTOCOL"},{no:1,name:"HLS_PROTOCOL"}]),b1=a$.makeEnum("livekit.SegmentedFileSuffix",[{no:0,name:"INDEX"},{no:1,name:"TIMESTAMP"}]),b2=a$.makeEnum("livekit.ImageFileSuffix",[{no:0,name:"IMAGE_SUFFIX_INDEX"},{no:1,name:"IMAGE_SUFFIX_TIMESTAMP"},{no:2,name:"IMAGE_SUFFIX_NONE_OVERWRITE"}]),b3=a$.makeEnum("livekit.StreamProtocol",[{no:0,name:"DEFAULT_PROTOCOL"},{no:1,name:"RTMP"},{no:2,name:"SRT"}]),b4=a$.makeEnum("livekit.AudioMixing",[{no:0,name:"DEFAULT_MIXING"},{no:1,name:"DUAL_CHANNEL_AGENT"},{no:2,name:"DUAL_CHANNEL_ALTERNATE"}]),b5=a$.makeEnum("livekit.EncodingOptionsPreset",[{no:0,name:"H264_720P_30"},{no:1,name:"H264_720P_60"},{no:2,name:"H264_1080P_30"},{no:3,name:"H264_1080P_60"},{no:4,name:"PORTRAIT_H264_720P_30"},{no:5,name:"PORTRAIT_H264_720P_60"},{no:6,name:"PORTRAIT_H264_1080P_30"},{no:7,name:"PORTRAIT_H264_1080P_60"}]),b6=a$.makeMessageType("livekit.RoomCompositeEgressRequest",()=>[{no:1,name:"room_name",kind:"scalar",T:9},{no:2,name:"layout",kind:"scalar",T:9},{no:3,name:"audio_only",kind:"scalar",T:8},{no:15,name:"audio_mixing",kind:"enum",T:a$.getEnumType(b4)},{no:4,name:"video_only",kind:"scalar",T:8},{no:5,name:"custom_base_url",kind:"scalar",T:9},{no:6,name:"file",kind:"message",T:b7,oneof:"output"},{no:7,name:"stream",kind:"message",T:cf,oneof:"output"},{no:10,name:"segments",kind:"message",T:b8,oneof:"output"},{no:8,name:"preset",kind:"enum",T:a$.getEnumType(b5),oneof:"options"},{no:9,name:"advanced",kind:"message",T:cg,oneof:"options"},{no:11,name:"file_outputs",kind:"message",T:b7,repeated:!0},{no:12,name:"stream_outputs",kind:"message",T:cf,repeated:!0},{no:13,name:"segment_outputs",kind:"message",T:b8,repeated:!0},{no:14,name:"image_outputs",kind:"message",T:b9,repeated:!0},{no:16,name:"webhooks",kind:"message",T:bY,repeated:!0}]),b7=a$.makeMessageType("livekit.EncodedFileOutput",()=>[{no:1,name:"file_type",kind:"enum",T:a$.getEnumType(b_)},{no:2,name:"filepath",kind:"scalar",T:9},{no:6,name:"disable_manifest",kind:"scalar",T:8},{no:3,name:"s3",kind:"message",T:ca,oneof:"output"},{no:4,name:"gcp",kind:"message",T:cb,oneof:"output"},{no:5,name:"azure",kind:"message",T:cc,oneof:"output"},{no:7,name:"aliOSS",kind:"message",T:cd,oneof:"output"}]),b8=a$.makeMessageType("livekit.SegmentedFileOutput",()=>[{no:1,name:"protocol",kind:"enum",T:a$.getEnumType(b0)},{no:2,name:"filename_prefix",kind:"scalar",T:9},{no:3,name:"playlist_name",kind:"scalar",T:9},{no:11,name:"live_playlist_name",kind:"scalar",T:9},{no:4,name:"segment_duration",kind:"scalar",T:13},{no:10,name:"filename_suffix",kind:"enum",T:a$.getEnumType(b1)},{no:8,name:"disable_manifest",kind:"scalar",T:8},{no:5,name:"s3",kind:"message",T:ca,oneof:"output"},{no:6,name:"gcp",kind:"message",T:cb,oneof:"output"},{no:7,name:"azure",kind:"message",T:cc,oneof:"output"},{no:9,name:"aliOSS",kind:"message",T:cd,oneof:"output"}]),b9=a$.makeMessageType("livekit.ImageOutput",()=>[{no:1,name:"capture_interval",kind:"scalar",T:13},{no:2,name:"width",kind:"scalar",T:5},{no:3,name:"height",kind:"scalar",T:5},{no:4,name:"filename_prefix",kind:"scalar",T:9},{no:5,name:"filename_suffix",kind:"enum",T:a$.getEnumType(b2)},{no:6,name:"image_codec",kind:"enum",T:a$.getEnumType(a6)},{no:7,name:"disable_manifest",kind:"scalar",T:8},{no:8,name:"s3",kind:"message",T:ca,oneof:"output"},{no:9,name:"gcp",kind:"message",T:cb,oneof:"output"},{no:10,name:"azure",kind:"message",T:cc,oneof:"output"},{no:11,name:"aliOSS",kind:"message",T:cd,oneof:"output"}]),ca=a$.makeMessageType("livekit.S3Upload",()=>[{no:1,name:"access_key",kind:"scalar",T:9},{no:2,name:"secret",kind:"scalar",T:9},{no:11,name:"session_token",kind:"scalar",T:9},{no:12,name:"assume_role_arn",kind:"scalar",T:9},{no:13,name:"assume_role_external_id",kind:"scalar",T:9},{no:3,name:"region",kind:"scalar",T:9},{no:4,name:"endpoint",kind:"scalar",T:9},{no:5,name:"bucket",kind:"scalar",T:9},{no:6,name:"force_path_style",kind:"scalar",T:8},{no:7,name:"metadata",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:8,name:"tagging",kind:"scalar",T:9},{no:9,name:"content_disposition",kind:"scalar",T:9},{no:10,name:"proxy",kind:"message",T:ce}]),cb=a$.makeMessageType("livekit.GCPUpload",()=>[{no:1,name:"credentials",kind:"scalar",T:9},{no:2,name:"bucket",kind:"scalar",T:9},{no:3,name:"proxy",kind:"message",T:ce}]),cc=a$.makeMessageType("livekit.AzureBlobUpload",()=>[{no:1,name:"account_name",kind:"scalar",T:9},{no:2,name:"account_key",kind:"scalar",T:9},{no:3,name:"container_name",kind:"scalar",T:9}]),cd=a$.makeMessageType("livekit.AliOSSUpload",()=>[{no:1,name:"access_key",kind:"scalar",T:9},{no:2,name:"secret",kind:"scalar",T:9},{no:3,name:"region",kind:"scalar",T:9},{no:4,name:"endpoint",kind:"scalar",T:9},{no:5,name:"bucket",kind:"scalar",T:9}]),ce=a$.makeMessageType("livekit.ProxyConfig",()=>[{no:1,name:"url",kind:"scalar",T:9},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"password",kind:"scalar",T:9}]),cf=a$.makeMessageType("livekit.StreamOutput",()=>[{no:1,name:"protocol",kind:"enum",T:a$.getEnumType(b3)},{no:2,name:"urls",kind:"scalar",T:9,repeated:!0}]),cg=a$.makeMessageType("livekit.EncodingOptions",()=>[{no:1,name:"width",kind:"scalar",T:5},{no:2,name:"height",kind:"scalar",T:5},{no:3,name:"depth",kind:"scalar",T:5},{no:4,name:"framerate",kind:"scalar",T:5},{no:5,name:"audio_codec",kind:"enum",T:a$.getEnumType(a4)},{no:6,name:"audio_bitrate",kind:"scalar",T:5},{no:11,name:"audio_quality",kind:"scalar",T:5},{no:7,name:"audio_frequency",kind:"scalar",T:5},{no:8,name:"video_codec",kind:"enum",T:a$.getEnumType(a5)},{no:9,name:"video_bitrate",kind:"scalar",T:5},{no:12,name:"video_quality",kind:"scalar",T:5},{no:10,name:"key_frame_interval",kind:"scalar",T:1}]),ch=a$.makeMessageType("livekit.AutoParticipantEgress",()=>[{no:1,name:"preset",kind:"enum",T:a$.getEnumType(b5),oneof:"options"},{no:2,name:"advanced",kind:"message",T:cg,oneof:"options"},{no:3,name:"file_outputs",kind:"message",T:b7,repeated:!0},{no:4,name:"segment_outputs",kind:"message",T:b8,repeated:!0}]),ci=a$.makeMessageType("livekit.AutoTrackEgress",()=>[{no:1,name:"filepath",kind:"scalar",T:9},{no:5,name:"disable_manifest",kind:"scalar",T:8},{no:2,name:"s3",kind:"message",T:ca,oneof:"output"},{no:3,name:"gcp",kind:"message",T:cb,oneof:"output"},{no:4,name:"azure",kind:"message",T:cc,oneof:"output"},{no:6,name:"aliOSS",kind:"message",T:cd,oneof:"output"}]),cj=a$.makeMessageType("livekit.RoomEgress",()=>[{no:1,name:"room",kind:"message",T:b6},{no:3,name:"participant",kind:"message",T:ch},{no:2,name:"tracks",kind:"message",T:ci}]),ck=(()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"empty_timeout",kind:"scalar",T:13},{no:3,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:11,name:"metadata",kind:"scalar",T:9},{no:5,name:"egress",kind:"message",T:cj},{no:7,name:"min_playout_delay",kind:"scalar",T:13},{no:8,name:"max_playout_delay",kind:"scalar",T:13},{no:9,name:"sync_streams",kind:"scalar",T:8},{no:10,name:"agents",kind:"message",T:b$,repeated:!0}],a$.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}])),cl=a$.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),cm=a$.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),cn=a$.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:cx,oneof:"message"},{no:2,name:"answer",kind:"message",T:cx,oneof:"message"},{no:3,name:"trickle",kind:"message",T:cr,oneof:"message"},{no:4,name:"add_track",kind:"message",T:cq,oneof:"message"},{no:5,name:"mute",kind:"message",T:cs,oneof:"message"},{no:6,name:"subscription",kind:"message",T:cz,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:cA,oneof:"message"},{no:8,name:"leave",kind:"message",T:cD,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:cF,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:cT,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:cW,oneof:"message"},{no:13,name:"simulate",kind:"message",T:cZ,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:cG,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:c$,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:cB,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:cC,oneof:"message"}]),co=a$.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:ct,oneof:"message"},{no:2,name:"answer",kind:"message",T:cx,oneof:"message"},{no:3,name:"offer",kind:"message",T:cx,oneof:"message"},{no:4,name:"trickle",kind:"message",T:cr,oneof:"message"},{no:5,name:"update",kind:"message",T:cy,oneof:"message"},{no:6,name:"track_published",kind:"message",T:cv,oneof:"message"},{no:8,name:"leave",kind:"message",T:cD,oneof:"message"},{no:9,name:"mute",kind:"message",T:cs,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:cI,oneof:"message"},{no:11,name:"room_update",kind:"message",T:cJ,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:cL,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:cN,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:cQ,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:cU,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:cw,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:cu,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:c_,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:c2,oneof:"message"},{no:22,name:"request_response",kind:"message",T:c3,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:c5,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:cV,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:da,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:cR,oneof:"message"}]),cp=a$.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:br,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:a$.getEnumType(bs)}]),cq=a$.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:a$.getEnumType(a8)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:a$.getEnumType(a9)},{no:9,name:"layers",kind:"message",T:br,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:cp,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:a$.getEnumType(bo)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:a$.getEnumType(a7)},{no:17,name:"audio_features",kind:"enum",T:a$.getEnumType(bg),repeated:!0}]),cr=a$.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:a$.getEnumType(ck)},{no:3,name:"final",kind:"scalar",T:8}]),cs=a$.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),ct=a$.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:bh},{no:2,name:"participant",kind:"message",T:bk},{no:3,name:"other_participants",kind:"message",T:bk,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:cH,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:bN},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:bJ},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:bi,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),cu=a$.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:cH,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:bN},{no:3,name:"server_info",kind:"message",T:bJ},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),cv=a$.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:bq}]),cw=a$.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),cx=a$.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),cy=a$.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:bk,repeated:!0}]),cz=a$.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:bI,repeated:!0}]),cA=a$.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:a$.getEnumType(ba)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),cB=a$.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:a$.getEnumType(bg),repeated:!0}]),cC=a$.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),cD=a$.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:a$.getEnumType(bd)},{no:3,name:"action",kind:"enum",T:a$.getEnumType(cE)},{no:4,name:"regions",kind:"message",T:c0}]),cE=a$.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),cF=a$.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:br,repeated:!0}]),cG=a$.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),cH=a$.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),cI=a$.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:by,repeated:!0}]),cJ=a$.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:bh}]),cK=a$.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:a$.getEnumType(bb)},{no:3,name:"score",kind:"scalar",T:2}]),cL=a$.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:cK,repeated:!0}]),cM=a$.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:a$.getEnumType(cl)}]),cN=a$.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:cM,repeated:!0}]),cO=a$.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:a$.getEnumType(ba)},{no:2,name:"enabled",kind:"scalar",T:8}]),cP=a$.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:cO,repeated:!0}]),cQ=a$.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:cO,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:cP,repeated:!0}]),cR=a$.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:bZ,repeated:!0}]),cS=a$.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),cT=a$.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:cS,repeated:!0}]),cU=a$.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),cV=a$.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:bh},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:bk},{no:4,name:"other_participants",kind:"message",T:bk,repeated:!0}]),cW=a$.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:cx},{no:2,name:"subscription",kind:"message",T:cz},{no:3,name:"publish_tracks",kind:"message",T:cv,repeated:!0},{no:4,name:"data_channels",kind:"message",T:cY,repeated:!0},{no:5,name:"offer",kind:"message",T:cx},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:cX,repeated:!0}]),cX=a$.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),cY=a$.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:a$.getEnumType(ck)}]),cZ=a$.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:a$.getEnumType(cm),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),c$=a$.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),c_=a$.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),c0=a$.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:c1,repeated:!0}]),c1=a$.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),c2=a$.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:a$.getEnumType(bf)}]),c3=a$.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:a$.getEnumType(c4)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:cr,oneof:"request"},{no:5,name:"add_track",kind:"message",T:cq,oneof:"request"},{no:6,name:"mute",kind:"message",T:cs,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:cG,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:cB,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:cC,oneof:"request"}]),c4=a$.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),c5=a$.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),c6=a$.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),c7=a$.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:bL},{no:2,name:"connection_settings",kind:"message",T:c6},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:cq,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:cx},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:a$.getEnumType(be)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:cW}]),c8=a$.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:a$.getEnumType(c9)},{no:2,name:"join_request",kind:"scalar",T:12}]),c9=a$.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),da=a$.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);var db={exports:{}},dc=db.exports,dd=function(){var a;return hv?db.exports:(hv=1,a=function(){var a=function(){},b="undefined",c=["trace","debug","info","warn","error"],d={},e=null;function f(a,b){var c=a[b];if("function"==typeof c.bind)return c.bind(a);try{return Function.prototype.bind.call(c,a)}catch(b){return function(){return Function.prototype.apply.apply(c,[a,arguments])}}}function g(){for(var d=this.getLevel(),e=0;e<c.length;e++){var f=c[e];this[f]=e<d?a:this.methodFactory(f,d,this.name)}if(this.log=this.debug,typeof console===b&&d<this.levels.SILENT)return"No console available for logging"}function h(a){return function(){typeof console!==b&&(g.call(this),this[a].apply(this,arguments))}}function i(c,d,e){var g;return"debug"===(g=c)&&(g="log"),typeof console!==b&&(void 0!==console[g]?f(console,g):void 0!==console.log?f(console,"log"):a)||h.apply(this,arguments)}function j(a,b){var f,h,j,k=this;function l(){}function m(a){var b=a;if("string"==typeof b&&void 0!==k.levels[b.toUpperCase()]&&(b=k.levels[b.toUpperCase()]),"number"==typeof b&&b>=0&&b<=k.levels.SILENT)return b;throw TypeError("log.setLevel() called with invalid level: "+a)}k.name=a,k.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},k.methodFactory=b||i,k.getLevel=function(){return null!=j?j:null!=h?h:f},k.setLevel=function(a,b){return j=m(a),!1!==b&&(c[j]||"silent").toUpperCase(),g.call(k)},k.setDefaultLevel=function(a){h=m(a),l()||k.setLevel(a,!1)},k.resetLevel=function(){j=null,g.call(k)},k.enableAll=function(a){k.setLevel(k.levels.TRACE,a)},k.disableAll=function(a){k.setLevel(k.levels.SILENT,a)},k.rebuild=function(){if(e!==k&&(f=m(e.getLevel())),g.call(k),e===k)for(var a in d)d[a].rebuild()},f=m(e?e.getLevel():"WARN");var n=l();null!=n&&(j=m(n)),g.call(k)}return(e=new j).getLogger=function(a){if("symbol"!=typeof a&&"string"!=typeof a||""===a)throw TypeError("You must supply a name when creating a logger.");var b=d[a];return b||(b=d[a]=new j(a,e.methodFactory)),b},e.noConflict=function(){return e},e.getLoggers=function(){return d},e.default=e,e},db.exports?db.exports=a():dc.log=a(),db.exports)}();(gZ=hw||(hw={}))[gZ.trace=0]="trace",gZ[gZ.debug=1]="debug",gZ[gZ.info=2]="info",gZ[gZ.warn=3]="warn",gZ[gZ.error=4]="error",gZ[gZ.silent=5]="silent",(g$=hx||(hx={})).Default="livekit",g$.Room="livekit-room",g$.TokenSource="livekit-token-source",g$.Participant="livekit-participant",g$.Track="livekit-track",g$.Publication="livekit-track-publication",g$.Engine="livekit-engine",g$.Signal="livekit-signal",g$.PCManager="livekit-pc-manager",g$.PCTransport="livekit-pc-transport",g$.E2EE="lk-e2ee";let de=dd.getLogger("livekit");function df(a){let b=dd.getLogger(a);return b.setDefaultLevel(de.getLevel()),b}Object.values(hx).map(a=>dd.getLogger(a)),de.setDefaultLevel(hw.info);let dg=dd.getLogger("lk-e2ee"),dh=[0,300,1200,2700,4800,7e3,7e3,7e3,7e3,7e3];function di(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){var b;a.done?e(a.value):((b=a.value)instanceof c?b:new c(function(a){a(b)})).then(g,h)}i((d=d.apply(a,b||[])).next())})}function dj(a){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var b,c=a[Symbol.asyncIterator];return c?c.call(a):(a=function(a){var b="function"==typeof Symbol&&Symbol.iterator,c=b&&a[b],d=0;if(c)return c.call(a);if(a&&"number"==typeof a.length)return{next:function(){return a&&d>=a.length&&(a=void 0),{value:a&&a[d++],done:!a}}};throw TypeError(b?"Object is not iterable.":"Symbol.iterator is not defined.")}(a),b={},d("next"),d("throw"),d("return"),b[Symbol.asyncIterator]=function(){return this},b);function d(c){b[c]=a[c]&&function(b){return new Promise(function(d,e){var f,g,h;f=d,g=e,h=(b=a[c](b)).done,Promise.resolve(b.value).then(function(a){f({value:a,done:h})},g)})}}}"function"==typeof SuppressedError&&SuppressedError;var dk={exports:{}},dl=function(){if(hy)return dk.exports;hy=1;var a,b="object"==typeof Reflect?Reflect:null,c=b&&"function"==typeof b.apply?b.apply:function(a,b,c){return Function.prototype.apply.call(a,b,c)};a=b&&"function"==typeof b.ownKeys?b.ownKeys:Object.getOwnPropertySymbols?function(a){return Object.getOwnPropertyNames(a).concat(Object.getOwnPropertySymbols(a))}:function(a){return Object.getOwnPropertyNames(a)};var d=Number.isNaN||function(a){return a!=a};function e(){e.init.call(this)}dk.exports=e,dk.exports.once=function(a,b){return new Promise(function(c,d){var e,f,g;function h(c){a.removeListener(b,i),d(c)}function i(){"function"==typeof a.removeListener&&a.removeListener("error",h),c([].slice.call(arguments))}o(a,b,i,{once:!0}),"error"!==b&&(e=a,f=h,g={once:!0},"function"==typeof e.on&&o(e,"error",f,g))})},e.EventEmitter=e,e.prototype._events=void 0,e.prototype._eventsCount=0,e.prototype._maxListeners=void 0;var f=10;function g(a){if("function"!=typeof a)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof a)}function h(a){return void 0===a._maxListeners?e.defaultMaxListeners:a._maxListeners}function i(a,b,c,d){if(g(c),void 0===(f=a._events)?(f=a._events=Object.create(null),a._eventsCount=0):(void 0!==f.newListener&&(a.emit("newListener",b,c.listener?c.listener:c),f=a._events),i=f[b]),void 0===i)i=f[b]=c,++a._eventsCount;else if("function"==typeof i?i=f[b]=d?[c,i]:[i,c]:d?i.unshift(c):i.push(c),(e=h(a))>0&&i.length>e&&!i.warned){i.warned=!0;var e,f,i,j=Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(b)+" listeners added. Use emitter.setMaxListeners() to increase limit");j.name="MaxListenersExceededWarning",j.emitter=a,j.type=b,j.count=i.length,console&&console.warn&&console.warn(j)}return a}function j(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function k(a,b,c){var d={fired:!1,wrapFn:void 0,target:a,type:b,listener:c},e=j.bind(d);return e.listener=c,d.wrapFn=e,e}function l(a,b,c){var d=a._events;if(void 0===d)return[];var e=d[b];return void 0===e?[]:"function"==typeof e?c?[e.listener||e]:[e]:c?function(a){for(var b=Array(a.length),c=0;c<b.length;++c)b[c]=a[c].listener||a[c];return b}(e):n(e,e.length)}function m(a){var b=this._events;if(void 0!==b){var c=b[a];if("function"==typeof c)return 1;if(void 0!==c)return c.length}return 0}function n(a,b){for(var c=Array(b),d=0;d<b;++d)c[d]=a[d];return c}function o(a,b,c,d){if("function"==typeof a.on)d.once?a.once(b,c):a.on(b,c);else if("function"==typeof a.addEventListener)a.addEventListener(b,function e(f){d.once&&a.removeEventListener(b,e),c(f)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof a)}return Object.defineProperty(e,"defaultMaxListeners",{enumerable:!0,get:function(){return f},set:function(a){if("number"!=typeof a||a<0||d(a))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+a+".");f=a}}),e.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},e.prototype.setMaxListeners=function(a){if("number"!=typeof a||a<0||d(a))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+a+".");return this._maxListeners=a,this},e.prototype.getMaxListeners=function(){return h(this)},e.prototype.emit=function(a){for(var b=[],d=1;d<arguments.length;d++)b.push(arguments[d]);var e="error"===a,f=this._events;if(void 0!==f)e=e&&void 0===f.error;else if(!e)return!1;if(e){if(b.length>0&&(g=b[0]),g instanceof Error)throw g;var g,h=Error("Unhandled error."+(g?" ("+g.message+")":""));throw h.context=g,h}var i=f[a];if(void 0===i)return!1;if("function"==typeof i)c(i,this,b);else for(var j=i.length,k=n(i,j),d=0;d<j;++d)c(k[d],this,b);return!0},e.prototype.addListener=function(a,b){return i(this,a,b,!1)},e.prototype.on=e.prototype.addListener,e.prototype.prependListener=function(a,b){return i(this,a,b,!0)},e.prototype.once=function(a,b){return g(b),this.on(a,k(this,a,b)),this},e.prototype.prependOnceListener=function(a,b){return g(b),this.prependListener(a,k(this,a,b)),this},e.prototype.removeListener=function(a,b){var c,d,e,f,h;if(g(b),void 0===(d=this._events)||void 0===(c=d[a]))return this;if(c===b||c.listener===b)0==--this._eventsCount?this._events=Object.create(null):(delete d[a],d.removeListener&&this.emit("removeListener",a,c.listener||b));else if("function"!=typeof c){for(e=-1,f=c.length-1;f>=0;f--)if(c[f]===b||c[f].listener===b){h=c[f].listener,e=f;break}if(e<0)return this;0===e?c.shift():function(a,b){for(;b+1<a.length;b++)a[b]=a[b+1];a.pop()}(c,e),1===c.length&&(d[a]=c[0]),void 0!==d.removeListener&&this.emit("removeListener",a,h||b)}return this},e.prototype.off=e.prototype.removeListener,e.prototype.removeAllListeners=function(a){var b,c,d;if(void 0===(c=this._events))return this;if(void 0===c.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==c[a]&&(0==--this._eventsCount?this._events=Object.create(null):delete c[a]),this;if(0==arguments.length){var e,f=Object.keys(c);for(d=0;d<f.length;++d)"removeListener"!==(e=f[d])&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(b=c[a]))this.removeListener(a,b);else if(void 0!==b)for(d=b.length-1;d>=0;d--)this.removeListener(a,b[d]);return this},e.prototype.listeners=function(a){return l(this,a,!0)},e.prototype.rawListeners=function(a){return l(this,a,!1)},e.listenerCount=function(a,b){return"function"==typeof a.listenerCount?a.listenerCount(b):m.call(a,b)},e.prototype.listenerCount=m,e.prototype.eventNames=function(){return this._eventsCount>0?a(this._events):[]},dk.exports}();let dm=!0;function dn(a,b,c){let d=a.match(b);return d&&d.length>=c&&parseFloat(d[c],10)}function dp(a,b,c){if(!a.RTCPeerConnection)return;let d=a.RTCPeerConnection.prototype,e=d.addEventListener;d.addEventListener=function(a,d){if(a!==b)return e.apply(this,arguments);let f=a=>{let b=c(a);b&&(d.handleEvent?d.handleEvent(b):d(b))};return this._eventMap=this._eventMap||{},this._eventMap[b]||(this._eventMap[b]=new Map),this._eventMap[b].set(d,f),e.apply(this,[a,f])};let f=d.removeEventListener;d.removeEventListener=function(a,c){if(a!==b||!this._eventMap||!this._eventMap[b]||!this._eventMap[b].has(c))return f.apply(this,arguments);let d=this._eventMap[b].get(c);return this._eventMap[b].delete(c),0===this._eventMap[b].size&&delete this._eventMap[b],0===Object.keys(this._eventMap).length&&delete this._eventMap,f.apply(this,[a,d])},Object.defineProperty(d,"on"+b,{get(){return this["_on"+b]},set(a){this["_on"+b]&&(this.removeEventListener(b,this["_on"+b]),delete this["_on"+b]),a&&this.addEventListener(b,this["_on"+b]=a)},enumerable:!0,configurable:!0})}function dq(a){return"boolean"!=typeof a?Error("Argument type: "+typeof a+". Please use a boolean."):a?"adapter.js logging disabled":"adapter.js logging enabled"}function dr(a){return"boolean"!=typeof a?Error("Argument type: "+typeof a+". Please use a boolean."):(dm=!a,"adapter.js deprecation warnings "+(a?"disabled":"enabled"))}function ds(){}function dt(a,b){dm&&console.warn(a+" is deprecated, please use "+b+" instead.")}function du(a){return"[object Object]"===Object.prototype.toString.call(a)}function dv(a,b,c){let d=c?"outbound-rtp":"inbound-rtp",e=new Map;if(null===b)return e;let f=[];return a.forEach(a=>{"track"===a.type&&a.trackIdentifier===b.id&&f.push(a)}),f.forEach(b=>{a.forEach(c=>{c.type===d&&c.trackId===b.id&&function a(b,c,d){!c||d.has(c.id)||(d.set(c.id,c),Object.keys(c).forEach(e=>{e.endsWith("Id")?a(b,b.get(c[e]),d):e.endsWith("Ids")&&c[e].forEach(c=>{a(b,b.get(c),d)})}))}(a,c,e)})}),e}function dw(a,b){let c=a&&a.navigator;if(!c.mediaDevices)return;let d=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;let b={};return Object.keys(a).forEach(c=>{if("require"===c||"advanced"===c||"mediaSource"===c)return;let d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);let e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];let a={};"number"==typeof d.ideal?(a[e("min",c)]=d.ideal,b.optional.push(a),(a={})[e("max",c)]=d.ideal):a[e("",c)]=d.ideal,b.optional.push(a)}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(a=>{void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},e=function(a,e){if(b.version>=61)return e(a);if((a=JSON.parse(JSON.stringify(a)))&&"object"==typeof a.audio){let b=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])};b((a=JSON.parse(JSON.stringify(a))).audio,"autoGainControl","googAutoGainControl"),b(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=d(a.audio)}if(a&&"object"==typeof a.video){let f=a.video.facingMode;f=f&&("object"==typeof f?f:{ideal:f});let g=b.version<66;if(f&&("user"===f.exact||"environment"===f.exact||"user"===f.ideal||"environment"===f.ideal)&&!(c.mediaDevices.getSupportedConstraints&&c.mediaDevices.getSupportedConstraints().facingMode&&!g)){let b;if(delete a.video.facingMode,"environment"===f.exact||"environment"===f.ideal?b=["back","rear"]:("user"===f.exact||"user"===f.ideal)&&(b=["front"]),b)return c.mediaDevices.enumerateDevices().then(c=>{let g=(c=c.filter(a=>"videoinput"===a.kind)).find(a=>b.some(b=>a.label.toLowerCase().includes(b)));return!g&&c.length&&b.includes("back")&&(g=c[c.length-1]),g&&(a.video.deviceId=f.exact?{exact:g.deviceId}:{ideal:g.deviceId}),a.video=d(a.video),ds("chrome: "+JSON.stringify(a)),e(a)})}a.video=d(a.video)}return ds("chrome: "+JSON.stringify(a)),e(a)},f=function(a){return b.version>=64?a:{name:({PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"})[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(c.getUserMedia=(function(a,b,d){e(a,a=>{c.webkitGetUserMedia(a,b,a=>{d&&d(f(a))})})}).bind(c),c.mediaDevices.getUserMedia){let a=c.mediaDevices.getUserMedia.bind(c.mediaDevices);c.mediaDevices.getUserMedia=function(b){return e(b,b=>a(b).then(a=>{if(b.audio&&!a.getAudioTracks().length||b.video&&!a.getVideoTracks().length)throw a.getTracks().forEach(a=>{a.stop()}),new DOMException("","NotFoundError");return a},a=>Promise.reject(f(a))))}}}function dx(a){a.MediaStream=a.MediaStream||a.webkitMediaStream}function dy(a){if("object"!=typeof a||!a.RTCPeerConnection||"ontrack"in a.RTCPeerConnection.prototype)dp(a,"track",a=>(a.transceiver||Object.defineProperty(a,"transceiver",{value:{receiver:a.receiver}}),a));else{Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(a){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=a)},enumerable:!0,configurable:!0});let b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=b=>{b.stream.addEventListener("addtrack",c=>{let d;d=a.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===c.track.id):{track:c.track};let e=new Event("track");e.track=c.track,e.receiver=d,e.transceiver={receiver:d},e.streams=[b.stream],this.dispatchEvent(e)}),b.stream.getTracks().forEach(c=>{let d;d=a.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===c.id):{track:c};let e=new Event("track");e.track=c,e.receiver=d,e.transceiver={receiver:d},e.streams=[b.stream],this.dispatchEvent(e)})},this.addEventListener("addstream",this._ontrackpoly)),b.apply(this,arguments)}}}function dz(a){if("object"==typeof a&&a.RTCPeerConnection&&!("getSenders"in a.RTCPeerConnection.prototype)&&"createDTMFSender"in a.RTCPeerConnection.prototype){let b=function(a,b){return{track:b,get dtmf(){return void 0===this._dtmf&&("audio"===b.kind?this._dtmf=a.createDTMFSender(b):this._dtmf=null),this._dtmf},_pc:a}};if(!a.RTCPeerConnection.prototype.getSenders){a.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let c=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,d){let e=c.apply(this,arguments);return e||(e=b(this,a),this._senders.push(e)),e};let d=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){d.apply(this,arguments);let b=this._senders.indexOf(a);-1!==b&&this._senders.splice(b,1)}}let c=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){this._senders=this._senders||[],c.apply(this,[a]),a.getTracks().forEach(a=>{this._senders.push(b(this,a))})};let d=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){this._senders=this._senders||[],d.apply(this,[a]),a.getTracks().forEach(a=>{let b=this._senders.find(b=>b.track===a);b&&this._senders.splice(this._senders.indexOf(b),1)})}}else if("object"==typeof a&&a.RTCPeerConnection&&"getSenders"in a.RTCPeerConnection.prototype&&"createDTMFSender"in a.RTCPeerConnection.prototype&&a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)){let b=a.RTCPeerConnection.prototype.getSenders;a.RTCPeerConnection.prototype.getSenders=function(){let a=b.apply(this,[]);return a.forEach(a=>a._pc=this),a},Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function dA(a){if(!("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender&&a.RTCRtpReceiver))return;if(!("getStats"in a.RTCRtpSender.prototype)){let b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){let a=b.apply(this,[]);return a.forEach(a=>a._pc=this),a});let c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){let a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){let a=this;return this._pc.getStats().then(b=>dv(b,a.track,!0))}}if(!("getStats"in a.RTCRtpReceiver.prototype)){let b=a.RTCPeerConnection.prototype.getReceivers;b&&(a.RTCPeerConnection.prototype.getReceivers=function(){let a=b.apply(this,[]);return a.forEach(a=>a._pc=this),a}),dp(a,"track",a=>(a.receiver._pc=a.srcElement,a)),a.RTCRtpReceiver.prototype.getStats=function(){let a=this;return this._pc.getStats().then(b=>dv(b,a.track,!1))}}if(!("getStats"in a.RTCRtpSender.prototype&&"getStats"in a.RTCRtpReceiver.prototype))return;let b=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof a.MediaStreamTrack){let a,b,c,d=arguments[0];return(this.getSenders().forEach(b=>{b.track===d&&(a?c=!0:a=b)}),this.getReceivers().forEach(a=>(a.track===d&&(b?c=!0:b=a),a.track===d)),c||a&&b)?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):a?a.getStats():b?b.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return b.apply(this,arguments)}}function dB(a){a.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};let b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,c){if(!c)return b.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let d=b.apply(this,arguments);return this._shimmedLocalStreams[c.id]?-1===this._shimmedLocalStreams[c.id].indexOf(d)&&this._shimmedLocalStreams[c.id].push(d):this._shimmedLocalStreams[c.id]=[c,d],d};let c=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(a=>{if(this.getSenders().find(b=>b.track===a))throw new DOMException("Track already exists.","InvalidAccessError")});let b=this.getSenders();c.apply(this,arguments);let d=this.getSenders().filter(a=>-1===b.indexOf(a));this._shimmedLocalStreams[a.id]=[a].concat(d)};let d=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],d.apply(this,arguments)};let e=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(b=>{let c=this._shimmedLocalStreams[b].indexOf(a);-1!==c&&this._shimmedLocalStreams[b].splice(c,1),1===this._shimmedLocalStreams[b].length&&delete this._shimmedLocalStreams[b]}),e.apply(this,arguments)}}function dC(a,b){if(!a.RTCPeerConnection)return;if(a.RTCPeerConnection.prototype.addTrack&&b.version>=65)return dB(a);let c=a.RTCPeerConnection.prototype.getLocalStreams;a.RTCPeerConnection.prototype.getLocalStreams=function(){let a=c.apply(this);return this._reverseStreams=this._reverseStreams||{},a.map(a=>this._reverseStreams[a.id])};let d=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(b){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},b.getTracks().forEach(a=>{if(this.getSenders().find(b=>b.track===a))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[b.id]){let c=new a.MediaStream(b.getTracks());this._streams[b.id]=c,this._reverseStreams[c.id]=b,b=c}d.apply(this,[b])};let e=a.RTCPeerConnection.prototype.removeStream;function f(a,b){let c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(b=>{let d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(RegExp(e.id,"g"),d.id)}),new RTCSessionDescription({type:b.type,sdp:c})}a.RTCPeerConnection.prototype.removeStream=function(a){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.apply(this,[this._streams[a.id]||a]),delete this._reverseStreams[this._streams[a.id]?this._streams[a.id].id:a.id],delete this._streams[a.id]},a.RTCPeerConnection.prototype.addTrack=function(b,c){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let d=[].slice.call(arguments,1);if(1!==d.length||!d[0].getTracks().find(a=>a===b))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(a=>a.track===b))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let e=this._streams[c.id];if(e)e.addTrack(b),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let d=new a.MediaStream([b]);this._streams[c.id]=d,this._reverseStreams[d.id]=c,this.addStream(d)}return this.getSenders().find(a=>a.track===b)},["createOffer","createAnswer"].forEach(function(b){let c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=({[b](){let a=arguments,b=arguments.length&&"function"==typeof arguments[0];return b?c.apply(this,[b=>{let c=f(this,b);a[0].apply(null,[c])},b=>{a[1]&&a[1].apply(null,b)},arguments[2]]):c.apply(this,arguments).then(a=>f(this,a))}})[b]});let g=a.RTCPeerConnection.prototype.setLocalDescription;a.RTCPeerConnection.prototype.setLocalDescription=function(){var a,b;let c;return arguments.length&&arguments[0].type?(arguments[0]=(a=this,b=arguments[0],c=b.sdp,Object.keys(a._reverseStreams||[]).forEach(b=>{let d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(RegExp(d.id,"g"),e.id)}),new RTCSessionDescription({type:b.type,sdp:c})),g.apply(this,arguments)):g.apply(this,arguments)};let h=Object.getOwnPropertyDescriptor(a.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(a.RTCPeerConnection.prototype,"localDescription",{get(){let a=h.get.apply(this);return""===a.type?a:f(this,a)}}),a.RTCPeerConnection.prototype.removeTrack=function(a){let b;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(a._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{},Object.keys(this._streams).forEach(c=>{this._streams[c].getTracks().find(b=>a.track===b)&&(b=this._streams[c])}),b&&(1===b.getTracks().length?this.removeStream(this._reverseStreams[b.id]):b.removeTrack(a.track),this.dispatchEvent(new Event("negotiationneeded")))}}function dD(a,b){!a.RTCPeerConnection&&a.webkitRTCPeerConnection&&(a.RTCPeerConnection=a.webkitRTCPeerConnection),a.RTCPeerConnection&&b.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){let c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=({[b](){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}})[b]})}function dE(a,b){dp(a,"negotiationneeded",a=>{let c=a.target;if(!(b.version<72)&&(!c.getConfiguration||"plan-b"!==c.getConfiguration().sdpSemantics)||"stable"===c.signalingState)return a})}var dF=Object.freeze({__proto__:null,fixNegotiationNeeded:dE,shimAddTrackRemoveTrack:dC,shimAddTrackRemoveTrackWithNative:dB,shimGetSendersWithDtmf:dz,shimGetUserMedia:dw,shimMediaStream:dx,shimOnTrack:dy,shimPeerConnection:dD,shimSenderReceiverGetStats:dA});function dG(a,b){let c=a&&a.navigator,d=a&&a.MediaStreamTrack;if(c.getUserMedia=function(a,b,d){dt("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),c.mediaDevices.getUserMedia(a).then(b,d)},!(b.version>55&&"autoGainControl"in c.mediaDevices.getSupportedConstraints())){let a=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},b=c.mediaDevices.getUserMedia.bind(c.mediaDevices);if(c.mediaDevices.getUserMedia=function(c){return"object"==typeof c&&"object"==typeof c.audio&&(a((c=JSON.parse(JSON.stringify(c))).audio,"autoGainControl","mozAutoGainControl"),a(c.audio,"noiseSuppression","mozNoiseSuppression")),b(c)},d&&d.prototype.getSettings){let b=d.prototype.getSettings;d.prototype.getSettings=function(){let c=b.apply(this,arguments);return a(c,"mozAutoGainControl","autoGainControl"),a(c,"mozNoiseSuppression","noiseSuppression"),c}}if(d&&d.prototype.applyConstraints){let b=d.prototype.applyConstraints;d.prototype.applyConstraints=function(c){return"audio"===this.kind&&"object"==typeof c&&(a(c=JSON.parse(JSON.stringify(c)),"autoGainControl","mozAutoGainControl"),a(c,"noiseSuppression","mozNoiseSuppression")),b.apply(this,[c])}}}}function dH(a){"object"==typeof a&&a.RTCTrackEvent&&"receiver"in a.RTCTrackEvent.prototype&&!("transceiver"in a.RTCTrackEvent.prototype)&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function dI(a,b){if("object"!=typeof a||!(a.RTCPeerConnection||a.mozRTCPeerConnection))return;!a.RTCPeerConnection&&a.mozRTCPeerConnection&&(a.RTCPeerConnection=a.mozRTCPeerConnection),b.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){let c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=({[b](){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}})[b]});let c={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},d=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){let[a,e,f]=arguments;return d.apply(this,[a||null]).then(a=>{if(b.version<53&&!e)try{a.forEach(a=>{a.type=c[a.type]||a.type})}catch(b){if("TypeError"!==b.name)throw b;a.forEach((b,d)=>{a.set(d,Object.assign({},b,{type:c[b.type]||b.type}))})}return a}).then(e,f)}}function dJ(a){if(!("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender)||a.RTCRtpSender&&"getStats"in a.RTCRtpSender.prototype)return;let b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){let a=b.apply(this,[]);return a.forEach(a=>a._pc=this),a});let c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){let a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function dK(a){if(!("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender)||a.RTCRtpSender&&"getStats"in a.RTCRtpReceiver.prototype)return;let b=a.RTCPeerConnection.prototype.getReceivers;b&&(a.RTCPeerConnection.prototype.getReceivers=function(){let a=b.apply(this,[]);return a.forEach(a=>a._pc=this),a}),dp(a,"track",a=>(a.receiver._pc=a.srcElement,a)),a.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function dL(a){!a.RTCPeerConnection||"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){dt("removeStream","removeTrack"),this.getSenders().forEach(b=>{b.track&&a.getTracks().includes(b.track)&&this.removeTrack(b)})})}function dM(a){a.DataChannel&&!a.RTCDataChannel&&(a.RTCDataChannel=a.DataChannel)}function dN(a){if(!("object"==typeof a&&a.RTCPeerConnection))return;let b=a.RTCPeerConnection.prototype.addTransceiver;b&&(a.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let a=arguments[1]&&arguments[1].sendEncodings;void 0===a&&(a=[]);let c=(a=[...a]).length>0;c&&a.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw RangeError("max_framerate must be >= 0.0")});let d=b.apply(this,arguments);if(c){let{sender:b}=d,c=b.getParameters();"encodings"in c&&(1!==c.encodings.length||0!==Object.keys(c.encodings[0]).length)||(c.encodings=a,b.sendEncodings=a,this.setParametersPromises.push(b.setParameters(c).then(()=>{delete b.sendEncodings}).catch(()=>{delete b.sendEncodings})))}return d})}function dO(a){if(!("object"==typeof a&&a.RTCRtpSender))return;let b=a.RTCRtpSender.prototype.getParameters;b&&(a.RTCRtpSender.prototype.getParameters=function(){let a=b.apply(this,arguments);return"encodings"in a||(a.encodings=[].concat(this.sendEncodings||[{}])),a})}function dP(a){if(!("object"==typeof a&&a.RTCPeerConnection))return;let b=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>b.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):b.apply(this,arguments)}}function dQ(a){if(!("object"==typeof a&&a.RTCPeerConnection))return;let b=a.RTCPeerConnection.prototype.createAnswer;a.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>b.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):b.apply(this,arguments)}}var dR=Object.freeze({__proto__:null,shimAddTransceiver:dN,shimCreateAnswer:dQ,shimCreateOffer:dP,shimGetDisplayMedia:function(a,b){a.navigator.mediaDevices&&"getDisplayMedia"in a.navigator.mediaDevices||a.navigator.mediaDevices&&(a.navigator.mediaDevices.getDisplayMedia=function(c){if(!(c&&c.video)){let a=new DOMException("getDisplayMedia without video constraints is undefined");return a.name="NotFoundError",a.code=8,Promise.reject(a)}return!0===c.video?c.video={mediaSource:b}:c.video.mediaSource=b,a.navigator.mediaDevices.getUserMedia(c)})},shimGetParameters:dO,shimGetUserMedia:dG,shimOnTrack:dH,shimPeerConnection:dI,shimRTCDataChannel:dM,shimReceiverGetStats:dK,shimRemoveStream:dL,shimSenderGetStats:dJ});function dS(a){if("object"==typeof a&&a.RTCPeerConnection){if("getLocalStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in a.RTCPeerConnection.prototype)){let b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addStream=function(a){this._localStreams||(this._localStreams=[]),this._localStreams.includes(a)||this._localStreams.push(a),a.getAudioTracks().forEach(c=>b.call(this,c,a)),a.getVideoTracks().forEach(c=>b.call(this,c,a))},a.RTCPeerConnection.prototype.addTrack=function(a){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return d&&d.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),b.apply(this,arguments)}}"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){this._localStreams||(this._localStreams=[]);let b=this._localStreams.indexOf(a);if(-1===b)return;this._localStreams.splice(b,1);let c=a.getTracks();this.getSenders().forEach(a=>{c.includes(a.track)&&this.removeTrack(a)})})}}function dT(a){if("object"==typeof a&&a.RTCPeerConnection&&("getRemoteStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in a.RTCPeerConnection.prototype))){Object.defineProperty(a.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(a){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=a),this.addEventListener("track",this._onaddstreampoly=a=>{a.streams.forEach(a=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(a))return;this._remoteStreams.push(a);let b=new Event("addstream");b.stream=a,this.dispatchEvent(b)})})}});let b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){let a=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(b){b.streams.forEach(b=>{if(a._remoteStreams||(a._remoteStreams=[]),a._remoteStreams.indexOf(b)>=0)return;a._remoteStreams.push(b);let c=new Event("addstream");c.stream=b,a.dispatchEvent(c)})}),b.apply(a,arguments)}}}function dU(a){if("object"!=typeof a||!a.RTCPeerConnection)return;let b=a.RTCPeerConnection.prototype,c=b.createOffer,d=b.createAnswer,e=b.setLocalDescription,f=b.setRemoteDescription,g=b.addIceCandidate;b.createOffer=function(a,b){let d=arguments.length>=2?arguments[2]:arguments[0],e=c.apply(this,[d]);return b?(e.then(a,b),Promise.resolve()):e},b.createAnswer=function(a,b){let c=arguments.length>=2?arguments[2]:arguments[0],e=d.apply(this,[c]);return b?(e.then(a,b),Promise.resolve()):e};let h=function(a,b,c){let d=e.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d};b.setLocalDescription=h,b.setRemoteDescription=h=function(a,b,c){let d=f.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.addIceCandidate=function(a,b,c){let d=g.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d}}function dV(a){let b=a&&a.navigator;if(b.mediaDevices&&b.mediaDevices.getUserMedia){let a=b.mediaDevices,c=a.getUserMedia.bind(a);b.mediaDevices.getUserMedia=a=>c(dW(a))}!b.getUserMedia&&b.mediaDevices&&b.mediaDevices.getUserMedia&&(b.getUserMedia=(function(a,c,d){b.mediaDevices.getUserMedia(a).then(c,d)}).bind(b))}function dW(a){return a&&void 0!==a.video?Object.assign({},a,{video:function a(b){return du(b)?Object.keys(b).reduce(function(c,d){let e=du(b[d]),f=e?a(b[d]):b[d],g=e&&!Object.keys(f).length;return void 0===f||g?c:Object.assign(c,{[d]:f})},{}):b}(a.video)}):a}function dX(a){if(!a.RTCPeerConnection)return;let b=a.RTCPeerConnection;a.RTCPeerConnection=function(a,c){if(a&&a.iceServers){let b=[];for(let c=0;c<a.iceServers.length;c++){let d=a.iceServers[c];void 0===d.urls&&d.url?(dt("RTCIceServer.url","RTCIceServer.urls"),(d=JSON.parse(JSON.stringify(d))).urls=d.url,delete d.url,b.push(d)):b.push(a.iceServers[c])}a.iceServers=b}return new b(a,c)},a.RTCPeerConnection.prototype=b.prototype,"generateCertificate"in b&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:()=>b.generateCertificate})}function dY(a){"object"==typeof a&&a.RTCTrackEvent&&"receiver"in a.RTCTrackEvent.prototype&&!("transceiver"in a.RTCTrackEvent.prototype)&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function dZ(a){let b=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(a){if(a){void 0!==a.offerToReceiveAudio&&(a.offerToReceiveAudio=!!a.offerToReceiveAudio);let b=this.getTransceivers().find(a=>"audio"===a.receiver.track.kind);!1===a.offerToReceiveAudio&&b?"sendrecv"===b.direction?b.setDirection?b.setDirection("sendonly"):b.direction="sendonly":"recvonly"===b.direction&&(b.setDirection?b.setDirection("inactive"):b.direction="inactive"):!0!==a.offerToReceiveAudio||b||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==a.offerToReceiveVideo&&(a.offerToReceiveVideo=!!a.offerToReceiveVideo);let c=this.getTransceivers().find(a=>"video"===a.receiver.track.kind);!1===a.offerToReceiveVideo&&c?"sendrecv"===c.direction?c.setDirection?c.setDirection("sendonly"):c.direction="sendonly":"recvonly"===c.direction&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive"):!0!==a.offerToReceiveVideo||c||this.addTransceiver("video",{direction:"recvonly"})}return b.apply(this,arguments)}}function d$(a){"object"!=typeof a||a.AudioContext||(a.AudioContext=a.webkitAudioContext)}var d_=Object.freeze({__proto__:null,shimAudioContext:d$,shimCallbacksAPI:dU,shimConstraints:dW,shimCreateOfferLegacy:dZ,shimGetUserMedia:dV,shimLocalStreamsAPI:dS,shimRTCIceServerUrls:dX,shimRemoteStreamsAPI:dT,shimTrackEventTransceiver:dY}),d0={exports:{}},d1=function(){let a;return hz?d0.exports:(hz=1,(a={}).generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},a.localCName=a.generateIdentifier(),a.splitLines=function(a){return a.trim().split("\n").map(a=>a.trim())},a.splitSections=function(a){return a.split("\nm=").map((a,b)=>(b>0?"m="+a:a).trim()+"\r\n")},a.getDescription=function(b){let c=a.splitSections(b);return c&&c[0]},a.getMediaSections=function(b){let c=a.splitSections(b);return c.shift(),c},a.matchPrefix=function(b,c){return a.splitLines(b).filter(a=>0===a.indexOf(c))},a.parseCandidate=function(a){let b,c={foundation:(b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" "))[0],component:{1:"rtp",2:"rtcp"}[b[1]]||b[1],protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],address:b[4],port:parseInt(b[5],10),type:b[7]};for(let a=8;a<b.length;a+=2)switch(b[a]){case"raddr":c.relatedAddress=b[a+1];break;case"rport":c.relatedPort=parseInt(b[a+1],10);break;case"tcptype":c.tcpType=b[a+1];break;case"ufrag":c.ufrag=b[a+1],c.usernameFragment=b[a+1];break;default:void 0===c[b[a]]&&(c[b[a]]=b[a+1])}return c},a.writeCandidate=function(a){let b=[];b.push(a.foundation);let c=a.component;"rtp"===c?b.push(1):"rtcp"===c?b.push(2):b.push(c),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.address||a.ip),b.push(a.port);let d=a.type;return b.push("typ"),b.push(d),"host"!==d&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),(a.usernameFragment||a.ufrag)&&(b.push("ufrag"),b.push(a.usernameFragment||a.ufrag)),"candidate:"+b.join(" ")},a.parseIceOptions=function(a){return a.substring(14).split(" ")},a.parseRtpMap=function(a){let b=a.substring(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return c.name=(b=b[0].split("/"))[0],c.clockRate=parseInt(b[1],10),c.channels=3===b.length?parseInt(b[2],10):1,c.numChannels=c.channels,c},a.writeRtpMap=function(a){let b=a.payloadType;void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType);let c=a.channels||a.numChannels||1;return"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==c?"/"+c:"")+"\r\n"},a.parseExtmap=function(a){let b=a.substring(9).split(" ");return{id:parseInt(b[0],10),direction:b[0].indexOf("/")>0?b[0].split("/")[1]:"sendrecv",uri:b[1],attributes:b.slice(2).join(" ")}},a.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+a.uri+(a.attributes?" "+a.attributes:"")+"\r\n"},a.parseFmtp=function(a){let b,c={},d=a.substring(a.indexOf(" ")+1).split(";");for(let a=0;a<d.length;a++)c[(b=d[a].trim().split("="))[0].trim()]=b[1];return c},a.writeFmtp=function(a){let b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){let d=[];Object.keys(a.parameters).forEach(b=>{void 0!==a.parameters[b]?d.push(b+"="+a.parameters[b]):d.push(b)}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},a.parseRtcpFb=function(a){let b=a.substring(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},a.writeRtcpFb=function(a){let b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(a=>{b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},a.parseSsrcMedia=function(a){let b=a.indexOf(" "),c={ssrc:parseInt(a.substring(7,b),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substring(b+1,d),c.value=a.substring(d+1)):c.attribute=a.substring(b+1),c},a.parseSsrcGroup=function(a){let b=a.substring(13).split(" ");return{semantics:b.shift(),ssrcs:b.map(a=>parseInt(a,10))}},a.getMid=function(b){let c=a.matchPrefix(b,"a=mid:")[0];if(c)return c.substring(6)},a.parseFingerprint=function(a){let b=a.substring(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1].toUpperCase()}},a.getDtlsParameters=function(b,c){return{role:"auto",fingerprints:a.matchPrefix(b+c,"a=fingerprint:").map(a.parseFingerprint)}},a.writeDtlsParameters=function(a,b){let c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(a=>{c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},a.parseCryptoLine=function(a){let b=a.substring(9).split(" ");return{tag:parseInt(b[0],10),cryptoSuite:b[1],keyParams:b[2],sessionParams:b.slice(3)}},a.writeCryptoLine=function(b){return"a=crypto:"+b.tag+" "+b.cryptoSuite+" "+("object"==typeof b.keyParams?a.writeCryptoKeyParams(b.keyParams):b.keyParams)+(b.sessionParams?" "+b.sessionParams.join(" "):"")+"\r\n"},a.parseCryptoKeyParams=function(a){if(0!==a.indexOf("inline:"))return null;let b=a.substring(7).split("|");return{keyMethod:"inline",keySalt:b[0],lifeTime:b[1],mkiValue:b[2]?b[2].split(":")[0]:void 0,mkiLength:b[2]?b[2].split(":")[1]:void 0}},a.writeCryptoKeyParams=function(a){return a.keyMethod+":"+a.keySalt+(a.lifeTime?"|"+a.lifeTime:"")+(a.mkiValue&&a.mkiLength?"|"+a.mkiValue+":"+a.mkiLength:"")},a.getCryptoParameters=function(b,c){return a.matchPrefix(b+c,"a=crypto:").map(a.parseCryptoLine)},a.getIceParameters=function(b,c){let d=a.matchPrefix(b+c,"a=ice-ufrag:")[0],e=a.matchPrefix(b+c,"a=ice-pwd:")[0];return d&&e?{usernameFragment:d.substring(12),password:e.substring(10)}:null},a.writeIceParameters=function(a){let b="a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n";return a.iceLite&&(b+="a=ice-lite\r\n"),b},a.parseRtpParameters=function(b){let c={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},d=a.splitLines(b)[0].split(" ");c.profile=d[2];for(let e=3;e<d.length;e++){let f=d[e],g=a.matchPrefix(b,"a=rtpmap:"+f+" ")[0];if(g){let d=a.parseRtpMap(g),e=a.matchPrefix(b,"a=fmtp:"+f+" ");switch(d.parameters=e.length?a.parseFmtp(e[0]):{},d.rtcpFeedback=a.matchPrefix(b,"a=rtcp-fb:"+f+" ").map(a.parseRtcpFb),c.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":c.fecMechanisms.push(d.name.toUpperCase())}}}a.matchPrefix(b,"a=extmap:").forEach(b=>{c.headerExtensions.push(a.parseExtmap(b))});let e=a.matchPrefix(b,"a=rtcp-fb:* ").map(a.parseRtcpFb);return c.codecs.forEach(a=>{e.forEach(b=>{a.rtcpFeedback.find(a=>a.type===b.type&&a.parameter===b.parameter)||a.rtcpFeedback.push(b)})}),c},a.writeRtpDescription=function(b,c){let d="";d+="m="+b+" ",d+=c.codecs.length>0?"9":"0",d+=" "+(c.profile||"UDP/TLS/RTP/SAVPF")+" ",d+=c.codecs.map(a=>void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType).join(" ")+"\r\n",d+="c=IN IP4 0.0.0.0\r\n",d+="a=rtcp:9 IN IP4 0.0.0.0\r\n",c.codecs.forEach(b=>{d+=a.writeRtpMap(b),d+=a.writeFmtp(b),d+=a.writeRtcpFb(b)});let e=0;return c.codecs.forEach(a=>{a.maxptime>e&&(e=a.maxptime)}),e>0&&(d+="a=maxptime:"+e+"\r\n"),c.headerExtensions&&c.headerExtensions.forEach(b=>{d+=a.writeExtmap(b)}),d},a.parseRtpEncodingParameters=function(b){let c,d=[],e=a.parseRtpParameters(b),f=-1!==e.fecMechanisms.indexOf("RED"),g=-1!==e.fecMechanisms.indexOf("ULPFEC"),h=a.matchPrefix(b,"a=ssrc:").map(b=>a.parseSsrcMedia(b)).filter(a=>"cname"===a.attribute),i=h.length>0&&h[0].ssrc,j=a.matchPrefix(b,"a=ssrc-group:FID").map(a=>a.substring(17).split(" ").map(a=>parseInt(a,10)));j.length>0&&j[0].length>1&&j[0][0]===i&&(c=j[0][1]),e.codecs.forEach(a=>{if("RTX"===a.name.toUpperCase()&&a.parameters.apt){let b={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10)};i&&c&&(b.rtx={ssrc:c}),d.push(b),f&&((b=JSON.parse(JSON.stringify(b))).fec={ssrc:i,mechanism:g?"red+ulpfec":"red"},d.push(b))}}),0===d.length&&i&&d.push({ssrc:i});let k=a.matchPrefix(b,"b=");return k.length&&(k=0===k[0].indexOf("b=TIAS:")?parseInt(k[0].substring(7),10):0===k[0].indexOf("b=AS:")?1e3*parseInt(k[0].substring(5),10)*.95-16e3:void 0,d.forEach(a=>{a.maxBitrate=k})),d},a.parseRtcpParameters=function(b){let c={},d=a.matchPrefix(b,"a=ssrc:").map(b=>a.parseSsrcMedia(b)).filter(a=>"cname"===a.attribute)[0];d&&(c.cname=d.value,c.ssrc=d.ssrc);let e=a.matchPrefix(b,"a=rtcp-rsize");return c.reducedSize=e.length>0,c.compound=0===e.length,c.mux=a.matchPrefix(b,"a=rtcp-mux").length>0,c},a.writeRtcpParameters=function(a){let b="";return a.reducedSize&&(b+="a=rtcp-rsize\r\n"),a.mux&&(b+="a=rtcp-mux\r\n"),void 0!==a.ssrc&&a.cname&&(b+="a=ssrc:"+a.ssrc+" cname:"+a.cname+"\r\n"),b},a.parseMsid=function(b){let c,d=a.matchPrefix(b,"a=msid:");if(1===d.length)return{stream:(c=d[0].substring(7).split(" "))[0],track:c[1]};let e=a.matchPrefix(b,"a=ssrc:").map(b=>a.parseSsrcMedia(b)).filter(a=>"msid"===a.attribute);if(e.length>0)return{stream:(c=e[0].value.split(" "))[0],track:c[1]}},a.parseSctpDescription=function(b){let c,d=a.parseMLine(b),e=a.matchPrefix(b,"a=max-message-size:");e.length>0&&(c=parseInt(e[0].substring(19),10)),isNaN(c)&&(c=65536);let f=a.matchPrefix(b,"a=sctp-port:");if(f.length>0)return{port:parseInt(f[0].substring(12),10),protocol:d.fmt,maxMessageSize:c};let g=a.matchPrefix(b,"a=sctpmap:");if(g.length>0){let a=g[0].substring(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:c}}},a.writeSctpDescription=function(a,b){let c=[];return c="DTLS/SCTP"!==a.protocol?["m="+a.kind+" 9 "+a.protocol+" "+b.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+b.port+"\r\n"]:["m="+a.kind+" 9 "+a.protocol+" "+b.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+b.port+" "+b.protocol+" 65535\r\n"],void 0!==b.maxMessageSize&&c.push("a=max-message-size:"+b.maxMessageSize+"\r\n"),c.join("")},a.generateSessionId=function(){return Math.random().toString().substr(2,22)},a.writeSessionBoilerplate=function(b,c,d){return"v=0\r\no="+(d||"thisisadapterortc")+" "+(b||a.generateSessionId())+" "+(void 0!==c?c:2)+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},a.getDirection=function(b,c){let d=a.splitLines(b);for(let a=0;a<d.length;a++)switch(d[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return d[a].substring(2)}return c?a.getDirection(c):"sendrecv"},a.getKind=function(b){return a.splitLines(b)[0].split(" ")[0].substring(2)},a.isRejected=function(a){return"0"===a.split(" ",2)[1]},a.parseMLine=function(b){let c=a.splitLines(b)[0].substring(2).split(" ");return{kind:c[0],port:parseInt(c[1],10),protocol:c[2],fmt:c.slice(3).join(" ")}},a.parseOLine=function(b){let c=a.matchPrefix(b,"o=")[0].substring(2).split(" ");return{username:c[0],sessionId:c[1],sessionVersion:parseInt(c[2],10),netType:c[3],addressType:c[4],address:c[5]}},a.isValidSDP=function(b){if("string"!=typeof b||0===b.length)return!1;let c=a.splitLines(b);for(let a=0;a<c.length;a++)if(c[a].length<2||"="!==c[a].charAt(1))return!1;return!0},d0.exports=a,d0.exports)}(),d2=d1&&d1.__esModule&&Object.prototype.hasOwnProperty.call(d1,"default")?d1.default:d1,d3=(g_={__proto__:null,default:d2},[d1].forEach(function(a){a&&"string"!=typeof a&&!Array.isArray(a)&&Object.keys(a).forEach(function(b){if("default"!==b&&!(b in g_)){var c=Object.getOwnPropertyDescriptor(a,b);Object.defineProperty(g_,b,c.get?c:{enumerable:!0,get:function(){return a[b]}})}})}),Object.freeze(g_));function d4(a){if(!a.RTCIceCandidate||a.RTCIceCandidate&&"foundation"in a.RTCIceCandidate.prototype)return;let b=a.RTCIceCandidate;a.RTCIceCandidate=function(a){if("object"==typeof a&&a.candidate&&0===a.candidate.indexOf("a=")&&((a=JSON.parse(JSON.stringify(a))).candidate=a.candidate.substring(2)),a.candidate&&a.candidate.length){let c=new b(a),d=d2.parseCandidate(a.candidate);for(let a in d)a in c||Object.defineProperty(c,a,{value:d[a]});return c.toJSON=function(){return{candidate:c.candidate,sdpMid:c.sdpMid,sdpMLineIndex:c.sdpMLineIndex,usernameFragment:c.usernameFragment}},c}return new b(a)},a.RTCIceCandidate.prototype=b.prototype,dp(a,"icecandidate",b=>(b.candidate&&Object.defineProperty(b,"candidate",{value:new a.RTCIceCandidate(b.candidate),writable:"false"}),b))}function d5(a){!a.RTCIceCandidate||a.RTCIceCandidate&&"relayProtocol"in a.RTCIceCandidate.prototype||dp(a,"icecandidate",a=>{if(a.candidate){let b=d2.parseCandidate(a.candidate.candidate);"relay"===b.type&&(a.candidate.relayProtocol=({0:"tls",1:"tcp",2:"udp"})[b.priority>>24])}return a})}function d6(a,b){if(!a.RTCPeerConnection)return;"sctp"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});let c=function(a){if(!a||!a.sdp)return!1;let b=d2.splitSections(a.sdp);return b.shift(),b.some(a=>{let b=d2.parseMLine(a);return b&&"application"===b.kind&&-1!==b.protocol.indexOf("SCTP")})},d=function(a){let b=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===b||b.length<2)return -1;let c=parseInt(b[1],10);return c!=c?-1:c},e=function(a){let c=65536;return"firefox"===b.browser&&(c=b.version<57?-1===a?16384:0x7ffffff5:b.version<60?57===b.version?65535:65536:0x7ffffff5),c},f=function(a,c){let d=65536;"firefox"===b.browser&&57===b.version&&(d=65535);let e=d2.matchPrefix(a.sdp,"a=max-message-size:");return e.length>0?d=parseInt(e[0].substring(19),10):"firefox"===b.browser&&-1!==c&&(d=0x7ffffff5),d},g=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===b.browser&&b.version>=76){let{sdpSemantics:a}=this.getConfiguration();"plan-b"===a&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(c(arguments[0])){let a,b=d(arguments[0]),c=e(b),g=f(arguments[0],b);a=0===c&&0===g?1/0:0===c||0===g?Math.max(c,g):Math.min(c,g);let h={};Object.defineProperty(h,"maxMessageSize",{get:()=>a}),this._sctp=h}return g.apply(this,arguments)}}function d7(a){if(!(a.RTCPeerConnection&&"createDataChannel"in a.RTCPeerConnection.prototype))return;function b(a,b){let c=a.send;a.send=function(){let d=arguments[0],e=d.length||d.size||d.byteLength;if("open"===a.readyState&&b.sctp&&e>b.sctp.maxMessageSize)throw TypeError("Message too large (can send a maximum of "+b.sctp.maxMessageSize+" bytes)");return c.apply(a,arguments)}}let c=a.RTCPeerConnection.prototype.createDataChannel;a.RTCPeerConnection.prototype.createDataChannel=function(){let a=c.apply(this,arguments);return b(a,this),a},dp(a,"datachannel",a=>(b(a.channel,a.target),a))}function d8(a){if(!a.RTCPeerConnection||"connectionState"in a.RTCPeerConnection.prototype)return;let b=a.RTCPeerConnection.prototype;Object.defineProperty(b,"connectionState",{get(){return({completed:"connected",checking:"connecting"})[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(b,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(a){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),a&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=a)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(a=>{let c=b[a];b[a]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=a=>{let b=a.target;if(b._lastConnectionState!==b.connectionState){b._lastConnectionState=b.connectionState;let c=new Event("connectionstatechange",a);b.dispatchEvent(c)}return a},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),c.apply(this,arguments)}})}function d9(a,b){if(!a.RTCPeerConnection||"chrome"===b.browser&&b.version>=71||"safari"===b.browser&&b._safariVersion>=13.1)return;let c=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(b){if(b&&b.sdp&&-1!==b.sdp.indexOf("\na=extmap-allow-mixed")){let c=b.sdp.split("\n").filter(a=>"a=extmap-allow-mixed"!==a.trim()).join("\n");a.RTCSessionDescription&&b instanceof a.RTCSessionDescription?arguments[0]=new a.RTCSessionDescription({type:b.type,sdp:c}):b.sdp=c}return c.apply(this,arguments)}}function ea(a,b){if(!(a.RTCPeerConnection&&a.RTCPeerConnection.prototype))return;let c=a.RTCPeerConnection.prototype.addIceCandidate;c&&0!==c.length&&(a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===b.browser&&b.version<78||"firefox"===b.browser&&b.version<68||"safari"===b.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():c.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function eb(a,b){if(!(a.RTCPeerConnection&&a.RTCPeerConnection.prototype))return;let c=a.RTCPeerConnection.prototype.setLocalDescription;c&&0!==c.length&&(a.RTCPeerConnection.prototype.setLocalDescription=function(){let a=arguments[0]||{};if("object"!=typeof a||a.type&&a.sdp)return c.apply(this,arguments);if(!(a={type:a.type,sdp:a.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":a.type="offer";break;default:a.type="answer"}return a.sdp||"offer"!==a.type&&"answer"!==a.type?c.apply(this,[a]):("offer"===a.type?this.createOffer:this.createAnswer).apply(this).then(a=>c.apply(this,[a]))})}var ec=Object.freeze({__proto__:null,removeExtmapAllowMixed:d9,shimAddIceCandidateNullOrEmpty:ea,shimConnectionState:d8,shimMaxMessageSize:d6,shimParameterlessSetLocalDescription:eb,shimRTCIceCandidate:d4,shimRTCIceCandidateRelayProtocol:d5,shimSendThrowTypeError:d7});!function(){let{window:a}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},c=function(a){let b={browser:null,version:null};if(void 0===a||!a.navigator||!a.navigator.userAgent)return b.browser="Not a browser.",b;let{navigator:c}=a;if(c.userAgentData&&c.userAgentData.brands){let a=c.userAgentData.brands.find(a=>"Chromium"===a.brand);if(a)return{browser:"chrome",version:parseInt(a.version,10)}}return c.mozGetUserMedia?(b.browser="firefox",b.version=parseInt(dn(c.userAgent,/Firefox\/(\d+)\./,1))):c.webkitGetUserMedia||!1===a.isSecureContext&&a.webkitRTCPeerConnection?(b.browser="chrome",b.version=parseInt(dn(c.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):a.RTCPeerConnection&&c.userAgent.match(/AppleWebKit\/(\d+)\./)?(b.browser="safari",b.version=parseInt(dn(c.userAgent,/AppleWebKit\/(\d+)\./,1)),b.supportsUnifiedPlan=a.RTCRtpTransceiver&&"currentDirection"in a.RTCRtpTransceiver.prototype,b._safariVersion=dn(c.userAgent,/Version\/(\d+(\.?\d+))/,1)):b.browser="Not a supported browser.",b}(a),d={browserDetails:c,commonShim:ec,extractVersion:dn,disableLog:dq,disableWarnings:dr,sdp:d3};switch(c.browser){case"chrome":if(!dF||!dD||!b.shimChrome){ds("Chrome shim is not included in this adapter release.");break}if(null===c.version){ds("Chrome shim can not determine version, not shimming.");break}ds("adapter.js shimming chrome."),d.browserShim=dF,ea(a,c),eb(a),dw(a,c),dx(a),dD(a,c),dy(a),dC(a,c),dz(a),dA(a),dE(a,c),d4(a),d5(a),d8(a),d6(a,c),d7(a),d9(a,c);break;case"firefox":if(!dR||!dI||!b.shimFirefox){ds("Firefox shim is not included in this adapter release.");break}ds("adapter.js shimming firefox."),d.browserShim=dR,ea(a,c),eb(a),dG(a,c),dI(a,c),dH(a),dL(a),dJ(a),dK(a),dM(a),dN(a),dO(a),dP(a),dQ(a),d4(a),d8(a),d6(a,c),d7(a);break;case"safari":if(!d_||!b.shimSafari){ds("Safari shim is not included in this adapter release.");break}ds("adapter.js shimming safari."),d.browserShim=d_,ea(a,c),eb(a),dX(a),dZ(a),dU(a),dS(a),dT(a),dY(a),dV(a),d$(a),d4(a),d5(a),d6(a,c),d7(a),d9(a,c);break;default:ds("Unsupported browser!")}}({window:void 0});let ed=/version\/(\d+(\.?_?\d+)+)/i;function ee(a){let c=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(void 0===a&&"undefined"==typeof navigator)return;let d=(null!=a?a:navigator.userAgent).toLowerCase();if(void 0===b||c){let a=ef.find(a=>{let{test:b}=a;return b.test(d)});b=null==a?void 0:a.describe(d)}return b}let ef=[{test:/firefox|iceweasel|fxios/i,describe:a=>({name:"Firefox",version:eg(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,a),os:a.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:eh(a)})},{test:/chrom|crios|crmo/i,describe:a=>({name:"Chrome",version:eg(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,a),os:a.toLowerCase().includes("crios")?"iOS":void 0,osVersion:eh(a)})},{test:/safari|applewebkit/i,describe:a=>({name:"Safari",version:eg(ed,a),os:a.includes("mobile/")?"iOS":"macOS",osVersion:eh(a)})}];function eg(a,b){let c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,d=b.match(a);return d&&d.length>=c&&d[c]||""}function eh(a){return a.includes("mac os")?eg(/\(.+?(\d+_\d+(:?_\d+)?)/,a,1).replace(/_/g,"."):void 0}class ei extends Error{constructor(a,b){super(b||"an error has occured"),this.name="LiveKitError",this.code=a}}(g0=hA||(hA={}))[g0.NotAllowed=0]="NotAllowed",g0[g0.ServerUnreachable=1]="ServerUnreachable",g0[g0.InternalError=2]="InternalError",g0[g0.Cancelled=3]="Cancelled",g0[g0.LeaveRequest=4]="LeaveRequest",g0[g0.Timeout=5]="Timeout",g0[g0.WebSocket=6]="WebSocket";class ej extends ei{constructor(a,b,c,d){super(1,a),this.name="ConnectionError",this.status=c,this.reason=b,this.context=d,this.reasonName=hA[b]}static notAllowed(a,b,c){return new ej(a,hA.NotAllowed,b,c)}static timeout(a){return new ej(a,hA.Timeout)}static leaveRequest(a,b){return new ej(a,hA.LeaveRequest,void 0,b)}static internal(a,b){return new ej(a,hA.InternalError,void 0,b)}static cancelled(a){return new ej(a,hA.Cancelled)}static serverUnreachable(a,b){return new ej(a,hA.ServerUnreachable,b)}static websocket(a,b,c){return new ej(a,hA.WebSocket,b,c)}}class ek extends ei{constructor(a){super(21,null!=a?a:"device is unsupported"),this.name="DeviceUnsupportedError"}}class el extends ei{constructor(a){super(20,null!=a?a:"track is invalid"),this.name="TrackInvalidError"}}class em extends ei{constructor(a){super(10,null!=a?a:"unsupported server"),this.name="UnsupportedServer"}}class en extends ei{constructor(a){super(12,null!=a?a:"unexpected connection state"),this.name="UnexpectedConnectionState"}}class eo extends ei{constructor(a){super(13,null!=a?a:"unable to negotiate"),this.name="NegotiationError"}}class ep extends ei{constructor(a,b){super(15,a),this.name="PublishTrackError",this.status=b}}class eq extends ei{constructor(a,b){super(15,a),this.name="SignalRequestError",this.reason=b,this.reasonName="string"==typeof b?b:c4[b]}}(g1=hB||(hB={}))[g1.AlreadyOpened=0]="AlreadyOpened",g1[g1.AbnormalEnd=1]="AbnormalEnd",g1[g1.DecodeFailed=2]="DecodeFailed",g1[g1.LengthExceeded=3]="LengthExceeded",g1[g1.Incomplete=4]="Incomplete",g1[g1.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",g1[g1.EncryptionTypeMismatch=8]="EncryptionTypeMismatch";class er extends ei{constructor(a,b){super(16,a),this.name="DataStreamError",this.reason=b,this.reasonName=hB[b]}}class es extends ei{constructor(a){super(18,a),this.name="SignalReconnectError"}}(g2=hC||(hC={})).PermissionDenied="PermissionDenied",g2.NotFound="NotFound",g2.DeviceInUse="DeviceInUse",g2.Other="Other",(g3=hC||(hC={})).getFailure=function(a){if(a&&"name"in a)return"NotFoundError"===a.name||"DevicesNotFoundError"===a.name?g3.NotFound:"NotAllowedError"===a.name||"PermissionDeniedError"===a.name?g3.PermissionDenied:"NotReadableError"===a.name||"TrackStartError"===a.name?g3.DeviceInUse:g3.Other};class et{}et.setTimeout=function(){return setTimeout(...arguments)},et.setInterval=function(){return setInterval(...arguments)},et.clearTimeout=function(){return clearTimeout(...arguments)},et.clearInterval=function(){return clearInterval(...arguments)},(g4=hD||(hD={})).Connected="connected",g4.Reconnecting="reconnecting",g4.SignalReconnecting="signalReconnecting",g4.Reconnected="reconnected",g4.Disconnected="disconnected",g4.ConnectionStateChanged="connectionStateChanged",g4.Moved="moved",g4.MediaDevicesChanged="mediaDevicesChanged",g4.ParticipantConnected="participantConnected",g4.ParticipantDisconnected="participantDisconnected",g4.TrackPublished="trackPublished",g4.TrackSubscribed="trackSubscribed",g4.TrackSubscriptionFailed="trackSubscriptionFailed",g4.TrackUnpublished="trackUnpublished",g4.TrackUnsubscribed="trackUnsubscribed",g4.TrackMuted="trackMuted",g4.TrackUnmuted="trackUnmuted",g4.LocalTrackPublished="localTrackPublished",g4.LocalTrackUnpublished="localTrackUnpublished",g4.LocalAudioSilenceDetected="localAudioSilenceDetected",g4.ActiveSpeakersChanged="activeSpeakersChanged",g4.ParticipantMetadataChanged="participantMetadataChanged",g4.ParticipantNameChanged="participantNameChanged",g4.ParticipantAttributesChanged="participantAttributesChanged",g4.ParticipantActive="participantActive",g4.RoomMetadataChanged="roomMetadataChanged",g4.DataReceived="dataReceived",g4.SipDTMFReceived="sipDTMFReceived",g4.TranscriptionReceived="transcriptionReceived",g4.ConnectionQualityChanged="connectionQualityChanged",g4.TrackStreamStateChanged="trackStreamStateChanged",g4.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",g4.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",g4.AudioPlaybackStatusChanged="audioPlaybackChanged",g4.VideoPlaybackStatusChanged="videoPlaybackChanged",g4.MediaDevicesError="mediaDevicesError",g4.ParticipantPermissionsChanged="participantPermissionsChanged",g4.SignalConnected="signalConnected",g4.RecordingStatusChanged="recordingStatusChanged",g4.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",g4.EncryptionError="encryptionError",g4.DCBufferStatusChanged="dcBufferStatusChanged",g4.ActiveDeviceChanged="activeDeviceChanged",g4.ChatMessage="chatMessage",g4.LocalTrackSubscribed="localTrackSubscribed",g4.MetricsReceived="metricsReceived",(g5=hE||(hE={})).TrackPublished="trackPublished",g5.TrackSubscribed="trackSubscribed",g5.TrackSubscriptionFailed="trackSubscriptionFailed",g5.TrackUnpublished="trackUnpublished",g5.TrackUnsubscribed="trackUnsubscribed",g5.TrackMuted="trackMuted",g5.TrackUnmuted="trackUnmuted",g5.LocalTrackPublished="localTrackPublished",g5.LocalTrackUnpublished="localTrackUnpublished",g5.LocalTrackCpuConstrained="localTrackCpuConstrained",g5.LocalSenderCreated="localSenderCreated",g5.ParticipantMetadataChanged="participantMetadataChanged",g5.ParticipantNameChanged="participantNameChanged",g5.DataReceived="dataReceived",g5.SipDTMFReceived="sipDTMFReceived",g5.TranscriptionReceived="transcriptionReceived",g5.IsSpeakingChanged="isSpeakingChanged",g5.ConnectionQualityChanged="connectionQualityChanged",g5.TrackStreamStateChanged="trackStreamStateChanged",g5.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",g5.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",g5.TrackCpuConstrained="trackCpuConstrained",g5.MediaDevicesError="mediaDevicesError",g5.AudioStreamAcquired="audioStreamAcquired",g5.ParticipantPermissionsChanged="participantPermissionsChanged",g5.PCTrackAdded="pcTrackAdded",g5.AttributesChanged="attributesChanged",g5.LocalTrackSubscribed="localTrackSubscribed",g5.ChatMessage="chatMessage",g5.Active="active",(g6=hF||(hF={})).TransportsCreated="transportsCreated",g6.Connected="connected",g6.Disconnected="disconnected",g6.Resuming="resuming",g6.Resumed="resumed",g6.Restarting="restarting",g6.Restarted="restarted",g6.SignalResumed="signalResumed",g6.SignalRestarted="signalRestarted",g6.Closing="closing",g6.MediaTrackAdded="mediaTrackAdded",g6.ActiveSpeakersUpdate="activeSpeakersUpdate",g6.DataPacketReceived="dataPacketReceived",g6.RTPVideoMapUpdate="rtpVideoMapUpdate",g6.DCBufferStatusChanged="dcBufferStatusChanged",g6.ParticipantUpdate="participantUpdate",g6.RoomUpdate="roomUpdate",g6.SpeakersChanged="speakersChanged",g6.StreamStateChanged="streamStateChanged",g6.ConnectionQualityUpdate="connectionQualityUpdate",g6.SubscriptionError="subscriptionError",g6.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",g6.RemoteMute="remoteMute",g6.SubscribedQualityUpdate="subscribedQualityUpdate",g6.LocalTrackUnpublished="localTrackUnpublished",g6.LocalTrackSubscribed="localTrackSubscribed",g6.Offline="offline",g6.SignalRequestResponse="signalRequestResponse",g6.SignalConnected="signalConnected",g6.RoomMoved="roomMoved",(g7=hG||(hG={})).Message="message",g7.Muted="muted",g7.Unmuted="unmuted",g7.Restarted="restarted",g7.Ended="ended",g7.Subscribed="subscribed",g7.Unsubscribed="unsubscribed",g7.CpuConstrained="cpuConstrained",g7.UpdateSettings="updateSettings",g7.UpdateSubscription="updateSubscription",g7.AudioPlaybackStarted="audioPlaybackStarted",g7.AudioPlaybackFailed="audioPlaybackFailed",g7.AudioSilenceDetected="audioSilenceDetected",g7.VisibilityChanged="visibilityChanged",g7.VideoDimensionsChanged="videoDimensionsChanged",g7.VideoPlaybackStarted="videoPlaybackStarted",g7.VideoPlaybackFailed="videoPlaybackFailed",g7.ElementAttached="elementAttached",g7.ElementDetached="elementDetached",g7.UpstreamPaused="upstreamPaused",g7.UpstreamResumed="upstreamResumed",g7.SubscriptionPermissionChanged="subscriptionPermissionChanged",g7.SubscriptionStatusChanged="subscriptionStatusChanged",g7.SubscriptionFailed="subscriptionFailed",g7.TrackProcessorUpdate="trackProcessorUpdate",g7.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",g7.TranscriptionReceived="transcriptionReceived",g7.TimeSyncUpdate="timeSyncUpdate",g7.PreConnectBufferFlushed="preConnectBufferFlushed";class eu{constructor(a,b,c,d,e){if("object"==typeof a)this.width=a.width,this.height=a.height,this.aspectRatio=a.aspectRatio,this.encoding={maxBitrate:a.maxBitrate,maxFramerate:a.maxFramerate,priority:a.priority};else if(void 0!==b&&void 0!==c)this.width=a,this.height=b,this.aspectRatio=a/b,this.encoding={maxBitrate:c,maxFramerate:d,priority:e};else throw TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}let ev=["vp8","h264"],ew=["vp8","h264","vp9","av1","h265"],ex=function(a){return!!ev.find(b=>b===a)};(g8=hH||(hH={}))[g8.PREFER_REGRESSION=0]="PREFER_REGRESSION",g8[g8.SIMULCAST=1]="SIMULCAST",g8[g8.REGRESSION=2]="REGRESSION",(g9=hI||(hI={})).telephone={maxBitrate:12e3},g9.speech={maxBitrate:24e3},g9.music={maxBitrate:48e3},g9.musicStereo={maxBitrate:64e3},g9.musicHighQuality={maxBitrate:96e3},g9.musicHighQualityStereo={maxBitrate:128e3};let ey={h90:new eu(160,90,9e4,20),h180:new eu(320,180,16e4,20),h216:new eu(384,216,18e4,20),h360:new eu(640,360,45e4,20),h540:new eu(960,540,8e5,25),h720:new eu(1280,720,17e5,30),h1080:new eu(1920,1080,3e6,30),h1440:new eu(2560,1440,5e6,30),h2160:new eu(3840,2160,8e6,30)},ez={h120:new eu(160,120,7e4,20),h180:new eu(240,180,125e3,20),h240:new eu(320,240,14e4,20),h360:new eu(480,360,33e4,20),h480:new eu(640,480,5e5,20),h540:new eu(720,540,6e5,25),h720:new eu(960,720,13e5,30),h1080:new eu(1440,1080,23e5,30),h1440:new eu(1920,1440,38e5,30)},eA={h360fps3:new eu(640,360,2e5,3,"medium"),h360fps15:new eu(640,360,4e5,15,"medium"),h720fps5:new eu(1280,720,8e5,5,"medium"),h720fps15:new eu(1280,720,15e5,15,"medium"),h720fps30:new eu(1280,720,2e6,30,"medium"),h1080fps15:new eu(1920,1080,25e5,15,"medium"),h1080fps30:new eu(1920,1080,5e6,30,"medium"),original:new eu(0,0,7e6,30,"medium")};function eB(a,b,c){var d,e;let{optionsWithoutProcessor:f,audioProcessor:g,videoProcessor:h}=eJ(null!=a?a:{}),i=null==b?void 0:b.processor,j=null==c?void 0:c.processor,k=null!=f?f:{};return!0===k.audio&&(k.audio={}),!0===k.video&&(k.video={}),k.audio&&(eC(k.audio,b),null!=(d=k.audio).deviceId||(d.deviceId={ideal:"default"}),(g||i)&&(k.audio.processor=null!=g?g:i)),k.video&&(eC(k.video,c),null!=(e=k.video).deviceId||(e.deviceId={ideal:"default"}),(h||j)&&(k.video.processor=null!=h?h:j)),k}function eC(a,b){return Object.keys(b).forEach(c=>{void 0===a[c]&&(a[c]=b[c])}),a}function eD(a){var b,c;let d={};if(a.video)if("object"==typeof a.video){let c={},e=a.video;Object.keys(e).forEach(a=>{"resolution"===a?eC(c,e.resolution):c[a]=e[a]}),d.video=c,null!=(b=d.video).deviceId||(b.deviceId={ideal:"default"})}else d.video=!!a.video&&{deviceId:{ideal:"default"}};else d.video=!1;return a.audio?"object"==typeof a.audio?(d.audio=a.audio,null!=(c=d.audio).deviceId||(c.deviceId={ideal:"default"})):d.audio={deviceId:{ideal:"default"}}:d.audio=!1,d}function eE(a){return di(this,arguments,void 0,function(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function*(){let c=eF();if(c){let d=c.createAnalyser();d.fftSize=2048;let e=new Uint8Array(d.frequencyBinCount);c.createMediaStreamSource(new MediaStream([a.mediaStreamTrack])).connect(d),yield eQ(b),d.getByteTimeDomainData(e);let f=e.some(a=>128!==a&&0!==a);return c.close(),!f}return!1}()})}function eF(){}function eG(a){return a===eM.Source.Microphone?"audioinput":a===eM.Source.Camera?"videoinput":void 0}function eH(a){return a.split("/")[1].toLowerCase()}function eI(a){return"mediaStreamTrack"in a?{trackID:a.sid,source:a.source,muted:a.isMuted,enabled:a.mediaStreamTrack.enabled,kind:a.kind,streamID:a.mediaStreamID,streamTrackID:a.mediaStreamTrack.id}:{trackID:a.trackSid,enabled:a.isEnabled,muted:a.isMuted,trackInfo:Object.assign({mimeType:a.mimeType,name:a.trackName,encrypted:a.isEncrypted,kind:a.kind,source:a.source},a.track?eI(a.track):{})}}function eJ(a){let b,c,d=Object.assign({},a);return"object"==typeof d.audio&&d.audio.processor&&(b=d.audio.processor,d.audio=Object.assign(Object.assign({},d.audio),{processor:void 0})),"object"==typeof d.video&&d.video.processor&&(c=d.video.processor,d.video=Object.assign(Object.assign({},d.video),{processor:void 0})),{audioProcessor:b,videoProcessor:c,optionsWithoutProcessor:void 0===d?d:"function"!=typeof structuredClone?JSON.parse(JSON.stringify(d)):"object"==typeof d&&null!==d?structuredClone(Object.assign({},d)):structuredClone(d)}}function eK(a,b){return a.width*a.height<b.width*b.height}let eL=[];(ha=hJ||(hJ={}))[ha.LOW=0]="LOW",ha[ha.MEDIUM=1]="MEDIUM",ha[ha.HIGH=2]="HIGH";class eM extends dl.EventEmitter{get streamState(){return this._streamState}setStreamState(a){this._streamState=a}constructor(a,b){var c;let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.attachedElements=[],this.isMuted=!1,this._streamState=eM.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=de,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),"hidden"===document.visibilityState?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),5e3):this.handleAppVisibilityChanged()},this.log=df(null!=(c=d.loggerName)?c:hx.Track),this.loggerContextCb=d.loggerContextCb,this.setMaxListeners(100),this.kind=b,this._mediaStreamTrack=a,this._mediaStreamID=a.id,this.source=eM.Source.Unknown}get logContext(){var a;return Object.assign(Object.assign({},null==(a=this.loggerContextCb)?void 0:a.call(this)),eI(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(a){let b="audio";this.kind===eM.Kind.Video&&(b="video"),0===this.attachedElements.length&&this.kind===eM.Kind.Video&&this.addAppVisibilityListener(),!a&&("audio"===b&&(eL.forEach(b=>{null!==b.parentElement||a||(a=b)}),a&&eL.splice(eL.indexOf(a),1)),a||(a=document.createElement(b))),this.attachedElements.includes(a)||this.attachedElements.push(a),eN(this.mediaStreamTrack,a);let c=a.srcObject.getTracks(),d=c.some(a=>"audio"===a.kind);return a.play().then(()=>{this.emit(d?hG.AudioPlaybackStarted:hG.VideoPlaybackStarted)}).catch(b=>{"NotAllowedError"===b.name?this.emit(d?hG.AudioPlaybackFailed:hG.VideoPlaybackFailed,b):"AbortError"===b.name?de.debug("".concat(d?"audio":"video"," playback aborted, likely due to new play request")):de.warn("could not playback ".concat(d?"audio":"video"),b),d&&a&&c.some(a=>"video"===a.kind)&&"NotAllowedError"===b.name&&(a.muted=!0,a.play().catch(()=>{}))}),this.emit(hG.ElementAttached,a),a}detach(a){try{if(a){eO(this.mediaStreamTrack,a);let b=this.attachedElements.indexOf(a);return b>=0&&(this.attachedElements.splice(b,1),this.recycleElement(a),this.emit(hG.ElementDetached,a)),a}let b=[];return this.attachedElements.forEach(a=>{eO(this.mediaStreamTrack,a),b.push(a),this.recycleElement(a),this.emit(hG.ElementDetached,a)}),this.attachedElements=[],b}finally{0===this.attachedElements.length&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(a){a.loggerName&&(this.log=df(a.loggerName)),a.loggerContextCb&&(this.loggerContextCb=a.loggerContextCb)}recycleElement(a){if(a instanceof HTMLAudioElement){let b=!0;a.pause(),eL.forEach(a=>{a.parentElement||(b=!1)}),b&&eL.push(a)}}handleAppVisibilityChanged(){return di(this,void 0,void 0,function*(){this.isInBackground="hidden"===document.visibilityState,this.isInBackground||this.kind!==eM.Kind.Video||setTimeout(()=>this.attachedElements.forEach(a=>a.play().catch(()=>{})),0)})}addAppVisibilityListener(){e$()?(this.isInBackground="hidden"===document.visibilityState,document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){e$()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function eN(a,b){let c,d;c=b.srcObject instanceof MediaStream?b.srcObject:new MediaStream,(d="audio"===a.kind?c.getAudioTracks():c.getVideoTracks()).includes(a)||(d.forEach(a=>{c.removeTrack(a)}),c.addTrack(a)),eX()&&b instanceof HTMLVideoElement||(b.autoplay=!0),b.muted=0===c.getAudioTracks().length,b instanceof HTMLVideoElement&&(b.playsInline=!0),b.srcObject!==c&&(b.srcObject=c,(eX()||eV())&&b instanceof HTMLVideoElement&&setTimeout(()=>{b.srcObject=c,b.play().catch(()=>{})},0))}function eO(a,b){if(b.srcObject instanceof MediaStream){let c=b.srcObject;c.removeTrack(a),c.getTracks().length>0?b.srcObject=c:b.srcObject=null}}(hc=d=(hb=eM||(eM={})).Kind||(hb.Kind={})).Audio="audio",hc.Video="video",hc.Unknown="unknown",(hd=e=hb.Source||(hb.Source={})).Camera="camera",hd.Microphone="microphone",hd.ScreenShare="screen_share",hd.ScreenShareAudio="screen_share_audio",hd.Unknown="unknown",(he=f=hb.StreamState||(hb.StreamState={})).Active="active",he.Paused="paused",he.Unknown="unknown",hb.kindToProto=function(a){switch(a){case d.Audio:return a8.AUDIO;case d.Video:return a8.VIDEO;default:return a8.DATA}},hb.kindFromProto=function(a){switch(a){case a8.AUDIO:return d.Audio;case a8.VIDEO:return d.Video;default:return d.Unknown}},hb.sourceToProto=function(a){switch(a){case e.Camera:return a9.CAMERA;case e.Microphone:return a9.MICROPHONE;case e.ScreenShare:return a9.SCREEN_SHARE;case e.ScreenShareAudio:return a9.SCREEN_SHARE_AUDIO;default:return a9.UNKNOWN}},hb.sourceFromProto=function(a){switch(a){case a9.CAMERA:return e.Camera;case a9.MICROPHONE:return e.Microphone;case a9.SCREEN_SHARE:return e.ScreenShare;case a9.SCREEN_SHARE_AUDIO:return e.ScreenShareAudio;default:return e.Unknown}},hb.streamStateFromProto=function(a){switch(a){case cl.ACTIVE:return f.Active;case cl.PAUSED:return f.Paused;default:return f.Unknown}};let eP="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function eQ(a){return di(this,void 0,void 0,function*(){return new Promise(b=>et.setTimeout(b,a))})}function eR(){return"addTransceiver"in RTCPeerConnection.prototype}function eS(){return"addTrack"in RTCPeerConnection.prototype}function eT(a){return"av1"===a||"vp9"===a}function eU(a){return!(!document||eY())&&(a||(a=document.createElement("audio")),"setSinkId"in a)}function eV(){var a;return(null==(a=ee())?void 0:a.name)==="Firefox"}function eW(){let a=ee();return!!a&&"Chrome"===a.name&&"iOS"!==a.os}function eX(){var a;return(null==(a=ee())?void 0:a.name)==="Safari"}function eY(){let a=ee();return(null==a?void 0:a.name)==="Safari"||(null==a?void 0:a.os)==="iOS"}function eZ(){var a,b;return!!e$()&&(null!=(b=null==(a=navigator.userAgentData)?void 0:a.mobile)?b:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent))}function e$(){return"undefined"!=typeof document}function e_(){return"ReactNative"==navigator.product}function e0(a){return a.hostname.endsWith(".livekit.cloud")||a.hostname.endsWith(".livekit.run")}function e1(a){return e0(a)?a.hostname.split(".")[0]:null}function e2(){if(a.g&&a.g.LiveKitReactNativeGlobal)return a.g.LiveKitReactNativeGlobal}function e3(){if(!e_())return;let a=e2();if(a)return a.platform}function e4(){if(e$())return window.devicePixelRatio;if(e_()){let a=e2();if(a)return a.devicePixelRatio}return 1}function e5(a,b){let c=a.split("."),d=b.split("."),e=Math.min(c.length,d.length);for(let a=0;a<e;++a){let b=parseInt(c[a],10),f=parseInt(d[a],10);if(b>f)return 1;if(b<f)return -1;if(a===e-1&&b===f)return 0}return""===a&&""!==b?-1:""===b?1:c.length==d.length?0:c.length<d.length?-1:1}function e6(a){for(let b of a)b.target.handleResize(b)}function e7(a){for(let b of a)b.target.handleVisibilityChanged(b)}let e8=null,e9=()=>(e8||(e8=new ResizeObserver(e6)),e8),fa=null,fb=()=>(fa||(fa=new IntersectionObserver(e7,{root:null,rootMargin:"0px"})),fa);function fc(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],e=document.createElement("canvas");e.width=a,e.height=b;let f=e.getContext("2d");null==f||f.fillRect(0,0,e.width,e.height),d&&f&&(f.beginPath(),f.arc(a/2,b/2,50,0,2*Math.PI,!0),f.closePath(),f.fillStyle="grey",f.fill());let[g]=e.captureStream().getTracks();if(!g)throw Error("Could not get empty media stream video track");return g.enabled=c,g}function fd(){if(!c){let a=new AudioContext,b=a.createOscillator(),d=a.createGain();d.gain.setValueAtTime(0,0);let e=a.createMediaStreamDestination();if(b.connect(d),d.connect(e),b.start(),[c]=e.stream.getAudioTracks(),!c)throw Error("Could not get empty media stream audio track");c.enabled=!1}return c.clone()}class fe{get isResolved(){return this._isResolved}constructor(a,b){this._isResolved=!1,this.onFinally=b,this.promise=new Promise((b,c)=>di(this,void 0,void 0,function*(){this.resolve=b,this.reject=c,a&&(yield a(b,c))})).finally(()=>{var a;this._isResolved=!0,null==(a=this.onFinally)||a.call(this)})}}function ff(a){if("string"==typeof a||"number"==typeof a)return a;if(Array.isArray(a))return a[0];if(void 0!==a.exact)return Array.isArray(a.exact)?a.exact[0]:a.exact;if(void 0!==a.ideal)return Array.isArray(a.ideal)?a.ideal[0]:a.ideal;throw Error("could not unwrap constraint")}function fg(a){return a.startsWith("ws")?a.replace(/^(ws)/,"http"):a}function fh(a){switch(a.reason){case hA.LeaveRequest:return a.context;case hA.Cancelled:return bd.CLIENT_INITIATED;case hA.NotAllowed:return bd.USER_REJECTED;case hA.ServerUnreachable:return bd.JOIN_FAILURE;default:return bd.UNKNOWN_REASON}}function fi(a){return void 0!==a?Number(a):void 0}function fj(a){return void 0!==a?BigInt(a):void 0}function fk(a){return!!a&&!(a instanceof MediaStreamTrack)&&a.isLocal}function fl(a){return!!a&&a.kind==eM.Kind.Audio}function fm(a){return!!a&&a.kind==eM.Kind.Video}function fn(a){return fk(a)&&fm(a)}function fo(a){return fk(a)&&fl(a)}function fp(a){return!!a&&!a.isLocal}function fq(a){return fp(a)&&fm(a)}function fr(a){return a.endsWith("/")?a:"".concat(a,"/")}function fs(a,b){return a.pathname="".concat(fr(a.pathname)).concat(b),a.toString()}function ft(a){if("string"==typeof a)return co.fromJson(JSON.parse(a),{ignoreUnknownFields:!0});if(a instanceof ArrayBuffer)return co.fromBinary(new Uint8Array(a));throw Error("could not decode websocket message: ".concat(typeof a))}let fu="lk_e2ee";function fv(){return void 0!==window.RTCRtpScriptTransform}(hf=hK||(hK={})).SetKey="setKey",hf.RatchetRequest="ratchetRequest",hf.KeyRatcheted="keyRatcheted",(hL||(hL={})).KeyRatcheted="keyRatcheted",(hg=hM||(hM={})).ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",hg.EncryptionError="encryptionError",(hN||(hN={})).Error="cryptorError",dl.EventEmitter,(hh=hO||(hO={}))[hh.InvalidKey=0]="InvalidKey",hh[hh.MissingKey=1]="MissingKey",hh[hh.InternalError=2]="InternalError";class fw extends dl.EventEmitter{constructor(a,b){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=a=>{var b,c;let{kind:d,data:e}=a.data;switch(d){case"error":if(de.error(e.error.message),e.uuid){let a=this.decryptDataRequests.get(e.uuid);if(null==a?void 0:a.reject){a.reject(e.error);break}let b=this.encryptDataRequests.get(e.uuid);if(null==b?void 0:b.reject){b.reject(e.error);break}}this.emit(hM.EncryptionError,e.error,e.participantIdentity);break;case"initAck":e.enabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)});break;case"enable":if(e.enabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)}),this.encryptionEnabled!==e.enabled&&e.participantIdentity===(null==(b=this.room)?void 0:b.localParticipant.identity))this.emit(hM.ParticipantEncryptionStatusChanged,e.enabled,this.room.localParticipant),this.encryptionEnabled=e.enabled;else if(e.participantIdentity){let a=null==(c=this.room)?void 0:c.getParticipantByIdentity(e.participantIdentity);if(!a)throw TypeError("couldn't set encryption status, participant not found".concat(e.participantIdentity));this.emit(hM.ParticipantEncryptionStatusChanged,e.enabled,a)}break;case"ratchetKey":this.keyProvider.emit(hK.KeyRatcheted,e.ratchetResult,e.participantIdentity,e.keyIndex);break;case"decryptDataResponse":let f=this.decryptDataRequests.get(e.uuid);(null==f?void 0:f.resolve)&&f.resolve(e);break;case"encryptDataResponse":let g=this.encryptDataRequests.get(e.uuid);(null==g?void 0:g.resolve)&&g.resolve(e)}},this.onWorkerError=a=>{de.error("e2ee worker encountered an error:",{error:a.error}),this.emit(hM.EncryptionError,a.error,void 0)},this.keyProvider=a.keyProvider,this.worker=a.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=b}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(a){if(!(void 0!==window.RTCRtpSender&&void 0!==window.RTCRtpSender.prototype.createEncodedStreams||fv()))throw new ek("tried to setup end-to-end encryption on an unsupported browser");if(de.info("setting up e2ee"),a!==this.room){this.room=a,this.setupEventListeners(a,this.keyProvider);let b={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:dg.getLevel()}};this.worker&&(de.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(b))}}setParticipantCryptorEnabled(a,b){de.debug("set e2ee to ".concat(a," for participant ").concat(b)),this.postEnable(a,b)}setSifTrailer(a){a&&0!==a.length?this.postSifTrailer(a):de.warn("ignoring server sent trailer as it's empty")}setupEngine(a){a.on(hF.RTPVideoMapUpdate,a=>{this.postRTPMap(a)})}setupEventListeners(a,b){a.on(hD.TrackPublished,(a,b)=>this.setParticipantCryptorEnabled(a.trackInfo.encryption!==bo.NONE,b.identity)),a.on(hD.ConnectionStateChanged,b=>{b===hZ.Connected&&a.remoteParticipants.forEach(a=>{a.trackPublications.forEach(b=>{this.setParticipantCryptorEnabled(b.trackInfo.encryption!==bo.NONE,a.identity)})})}).on(hD.TrackUnsubscribed,(a,b,c)=>{var d;let e={kind:"removeTransform",data:{participantIdentity:c.identity,trackId:a.mediaStreamID}};null==(d=this.worker)||d.postMessage(e)}).on(hD.TrackSubscribed,(a,b,c)=>{this.setupE2EEReceiver(a,c.identity,b.trackInfo)}).on(hD.SignalConnected,()=>{if(!this.room)throw TypeError("expected room to be present on signal connect");b.getKeys().forEach(a=>{this.postKey(a)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),a.localParticipant.on(hE.LocalSenderCreated,(a,b)=>di(this,void 0,void 0,function*(){this.setupE2EESender(b,a)})),a.localParticipant.on(hE.LocalTrackPublished,a=>{if(!fm(a.track)||!eY())return;let b={kind:"updateCodec",data:{trackId:a.track.mediaStreamID,codec:eH(a.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(b)}),b.on(hK.SetKey,a=>this.postKey(a)).on(hK.RatchetRequest,(a,b)=>this.postRatchetRequest(a,b))}encryptData(a){return di(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");let b=crypto.randomUUID(),c={kind:"encryptDataRequest",data:{uuid:b,payload:a,participantIdentity:this.room.localParticipant.identity}},d=new fe;return d.onFinally=()=>{this.encryptDataRequests.delete(b)},this.encryptDataRequests.set(b,d),this.worker.postMessage(c),d.promise})}handleEncryptedData(a,b,c,d){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");let e=crypto.randomUUID(),f=new fe;return f.onFinally=()=>{this.decryptDataRequests.delete(e)},this.decryptDataRequests.set(e,f),this.worker.postMessage({kind:"decryptDataRequest",data:{uuid:e,payload:a,iv:b,participantIdentity:c,keyIndex:d}}),f.promise}postRatchetRequest(a,b){if(!this.worker)throw Error("could not ratchet key, worker is missing");this.worker.postMessage({kind:"ratchetRequest",data:{participantIdentity:a,keyIndex:b}})}postKey(a){var b;let{key:c,participantIdentity:d,keyIndex:e}=a;if(!this.worker)throw Error("could not set key, worker is missing");let f={kind:"setKey",data:{participantIdentity:d,isPublisher:d===(null==(b=this.room)?void 0:b.localParticipant.identity),key:c,keyIndex:e}};this.worker.postMessage(f)}postEnable(a,b){if(this.worker)this.worker.postMessage({kind:"enable",data:{enabled:a,participantIdentity:b}});else throw ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(a){var b;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(null==(b=this.room)?void 0:b.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");let c={kind:"setRTPMap",data:{map:a,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(c)}postSifTrailer(a){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");this.worker.postMessage({kind:"setSifTrailer",data:{trailer:a}})}setupE2EEReceiver(a,b,c){if(a.receiver){if(!(null==c?void 0:c.mimeType)||""===c.mimeType)throw TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(a.receiver,a.mediaStreamID,b,"video"===a.kind?eH(c.mimeType):void 0)}}setupE2EESender(a,b){if(!fk(a)||!b){b||de.warn("early return because sender is not ready");return}this.handleSender(b,a.mediaStreamID,void 0)}handleReceiver(a,b,c,d){return di(this,void 0,void 0,function*(){if(this.worker){if(fv()&&!eW())a.transform=new RTCRtpScriptTransform(this.worker,{kind:"decode",participantIdentity:c,trackId:b,codec:d});else{if(fu in a&&d)return void this.worker.postMessage({kind:"updateCodec",data:{trackId:b,codec:d,participantIdentity:c}});let e=a.writableStream,f=a.readableStream;if(!e||!f){let b=a.createEncodedStreams();a.writableStream=b.writable,e=b.writable,a.readableStream=b.readable,f=b.readable}let g={kind:"decode",data:{readableStream:f,writableStream:e,trackId:b,codec:d,participantIdentity:c,isReuse:fu in a}};this.worker.postMessage(g,[f,e])}a[fu]=!0}})}handleSender(a,b,c){var d;if(!(fu in a)&&this.worker){if(!(null==(d=this.room)?void 0:d.localParticipant.identity)||""===this.room.localParticipant.identity)throw TypeError("local identity needs to be known in order to set up encrypted sender");if(fv()&&!eW()){de.info("initialize script transform");let d={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:b,codec:c};a.transform=new RTCRtpScriptTransform(this.worker,d)}else{de.info("initialize encoded streams");let d=a.createEncodedStreams(),e={kind:"encode",data:{readableStream:d.readable,writableStream:d.writable,codec:c,trackId:b,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(e,[d.readable,d.writable])}a[fu]=!0}}}class fx{constructor(){this.failedConnectionAttempts=new Map,this.backOffPromises=new Map}static getInstance(){return this._instance||(this._instance=new fx),this._instance}addFailedConnectionAttempt(a){var b;let c=e1(new URL(a));if(!c)return;let d=null!=(b=this.failedConnectionAttempts.get(c))?b:0;this.failedConnectionAttempts.set(c,d+1),this.backOffPromises.set(c,eQ(Math.min(500*Math.pow(2,d),15e3)))}getBackOffPromise(a){let b=new URL(a),c=b&&e1(b);return c&&this.backOffPromises.get(c)||Promise.resolve()}resetFailedConnectionAttempts(a){let b=new URL(a),c=b&&e1(b);c&&(this.failedConnectionAttempts.set(c,0),this.backOffPromises.set(c,Promise.resolve()))}resetAll(){this.backOffPromises.clear(),this.failedConnectionAttempts.clear()}}fx._instance=null;let fy="default";class fz{constructor(){this._previousDevices=[]}static getInstance(){return void 0===this.instance&&(this.instance=new fz),this.instance}get previousDevices(){return this._previousDevices}getDevices(a){return di(this,arguments,void 0,function(a){var b=this;let c=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return function*(){var d;if((null==(d=fz.userMediaPromiseMap)?void 0:d.size)>0){de.debug("awaiting getUserMedia promise");try{a?yield fz.userMediaPromiseMap.get(a):yield Promise.all(fz.userMediaPromiseMap.values())}catch(a){de.warn("error waiting for media permissons")}}let e=yield navigator.mediaDevices.enumerateDevices();if(c&&!(eX()&&b.hasDeviceInUse(a))&&(0===e.filter(b=>b.kind===a).length||e.some(b=>{let c=""===b.label,d=!a||b.kind===a;return c&&d}))){let b=yield navigator.mediaDevices.getUserMedia({video:"audioinput"!==a&&"audiooutput"!==a,audio:"videoinput"!==a&&{deviceId:{ideal:"default"}}});e=yield navigator.mediaDevices.enumerateDevices(),b.getTracks().forEach(a=>{a.stop()})}return b._previousDevices=e,a&&(e=e.filter(b=>b.kind===a)),e}()})}normalizeDeviceId(a,b,c){return di(this,void 0,void 0,function*(){if(b!==fy)return b;let d=yield this.getDevices(a),e=d.find(a=>a.deviceId===fy);if(!e)return void de.warn("could not reliably determine default device");let f=d.find(a=>a.deviceId!==fy&&a.groupId===(null!=c?c:e.groupId));return f?null==f?void 0:f.deviceId:void de.warn("could not reliably determine default device")})}hasDeviceInUse(a){return a?fz.userMediaPromiseMap.has(a):fz.userMediaPromiseMap.size>0}}fz.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],fz.userMediaPromiseMap=new Map,(hi=hP||(hP={}))[hi.WAITING=0]="WAITING",hi[hi.RUNNING=1]="RUNNING",hi[hi.COMPLETED=2]="COMPLETED";class fA{constructor(){this.pendingTasks=new Map,this.taskMutex=new M,this.nextTaskIndex=0}run(a){return di(this,void 0,void 0,function*(){let b={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:hP.WAITING};this.pendingTasks.set(b.id,b);let c=yield this.taskMutex.lock();try{return b.executedAt=Date.now(),b.status=hP.RUNNING,yield a()}finally{b.status=hP.COMPLETED,this.pendingTasks.delete(b.id),c()}})}flush(){return di(this,void 0,void 0,function*(){return this.run(()=>di(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class fB{get readyState(){return this.ws.readyState}constructor(a){var b,c;let d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==(b=d.signal)?void 0:b.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=a;const e=new WebSocket(a,null!=(c=d.protocols)?c:[]);e.binaryType="arraybuffer",this.ws=e;const f=function(){let{closeCode:a,reason:b}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.close(a,b)};this.opened=new Promise((a,b)=>{e.onopen=()=>{a({readable:new ReadableStream({start(a){e.onmessage=b=>{let{data:c}=b;return a.enqueue(c)},e.onerror=b=>a.error(b)},cancel:f}),writable:new WritableStream({write(a){e.send(a)},abort(){e.close()},close:f}),protocol:e.protocol,extensions:e.extensions}),e.removeEventListener("error",b)},e.addEventListener("error",b)}),this.closed=new Promise((a,b)=>{let c=()=>di(this,void 0,void 0,function*(){let c=new Promise(a=>{e.readyState===WebSocket.CLOSED||e.addEventListener("close",b=>{a(b)},{once:!0})}),d=yield Promise.race([eQ(250),c]);d?a(d):b(Error("Encountered unspecified websocket error without a timely close event"))});e.onclose=b=>{let{code:d,reason:f}=b;a({closeCode:d,reason:f}),e.removeEventListener("error",c)},e.addEventListener("error",c)}),d.signal&&(d.signal.onabort=()=>e.close()),this.close=f}}let fC=["syncState","trickle","offer","answer","simulate","leave"];(hj=hQ||(hQ={}))[hj.CONNECTING=0]="CONNECTING",hj[hj.CONNECTED=1]="CONNECTED",hj[hj.RECONNECTING=2]="RECONNECTING",hj[hj.DISCONNECTING=3]="DISCONNECTING",hj[hj.DISCONNECTED=4]="DISCONNECTED";class fD{get currentState(){return this.state}get isDisconnected(){return this.state===hQ.DISCONNECTING||this.state===hQ.DISCONNECTED}get isEstablishingConnection(){return this.state===hQ.CONNECTING||this.state===hQ.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){var a;let b=arguments.length>0&&void 0!==arguments[0]&&arguments[0],c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.rtt=0,this.state=hQ.DISCONNECTED,this.log=de,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=df(null!=(a=c.loggerName)?a:hx.Signal),this.loggerContextCb=c.loggerContextCb,this.useJSON=b,this.requestQueue=new fA,this.queuedRequests=[],this.closingLock=new M,this.connectionLock=new M,this.state=hQ.DISCONNECTED}get logContext(){var a,b;return null!=(b=null==(a=this.loggerContextCb)?void 0:a.call(this))?b:{}}join(a,b,c,d){return di(this,void 0,void 0,function*(){return this.state=hQ.CONNECTING,this.options=c,yield this.connect(a,b,c,d)})}reconnect(a,b,c,d){return di(this,void 0,void 0,function*(){return this.options?(this.state=hQ.RECONNECTING,this.clearPingInterval(),yield this.connect(a,b,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:c,reconnectReason:d}))):void this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext)})}connect(a,b,c,d){return di(this,void 0,void 0,function*(){var e,f,g,h,i,j,k,l;let m,n,o,p,q,r,s=yield this.connectionLock.lock();this.connectOptions=c;let t=(q=new bL({sdk:bM.JS,protocol:16,version:"2.16.1"}),e_()&&(q.os=null!=(e=e3())?e:""),q),u=c.singlePeerConnection?(f=b,g=t,h=c,(m=new URLSearchParams).set("access_token",f),n=new c7({clientInfo:g,connectionSettings:new c6({autoSubscribe:!!h.autoSubscribe,adaptiveStream:!!h.adaptiveStream}),reconnect:!!h.reconnect,participantSid:h.sid?h.sid:void 0}),h.reconnectReason&&(n.reconnectReason=h.reconnectReason),o=new c8({joinRequest:n.toBinary()}),m.set("join_request",btoa(new TextDecoder("utf-8").decode(o.toBinary()))),m):(i=b,j=t,k=c,(p=new URLSearchParams).set("access_token",i),k.reconnect&&(p.set("reconnect","1"),k.sid&&p.set("sid",k.sid)),p.set("auto_subscribe",k.autoSubscribe?"1":"0"),p.set("sdk",e_()?"reactnative":"js"),p.set("version",j.version),p.set("protocol",j.protocol.toString()),j.deviceModel&&p.set("device_model",j.deviceModel),j.os&&p.set("os",j.os),j.osVersion&&p.set("os_version",j.osVersion),j.browser&&p.set("browser",j.browser),j.browserVersion&&p.set("browser_version",j.browserVersion),k.adaptiveStream&&p.set("adaptive_stream","1"),k.reconnectReason&&p.set("reconnect_reason",k.reconnectReason.toString()),(null==(l=navigator.connection)?void 0:l.type)&&p.set("network",navigator.connection.type),p),v=(r=new URL(a.startsWith("http")?a.replace(/^(http)/,"ws"):a),u.forEach((a,b)=>{r.searchParams.set(b,a)}),fs(r,"rtc")),w=fs(new URL(fg(v)),"validate");return new Promise((a,b)=>di(this,void 0,void 0,function*(){var e,f;try{let g=!1,h=a=>di(this,void 0,void 0,function*(){if(g)return;g=!0;let c=a instanceof Event?a.currentTarget:a,d=function(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unknown reason";if(!(a instanceof AbortSignal))return b;let c=a.reason;switch(typeof c){case"string":return c;case"object":return c instanceof Error?c.message:b;default:return"toString"in c?c.toString():b}}(c,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(d)).catch(a=>{this.log.error(a),this.close()}):this.close(),i(),b(ej.cancelled(d))});null==d||d.addEventListener("abort",h);let i=()=>{clearTimeout(j),null==d||d.removeEventListener("abort",h)},j=setTimeout(()=>{h(ej.timeout("room connection has timed out (signal)"))},c.websocketTimeout),k=(a,b)=>{this.handleSignalConnected(a,j,b)},l=new URL(v);l.searchParams.has("access_token")&&l.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(l),Object.assign({reconnect:c.reconnect,reconnectReason:c.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new fB(v);try{this.ws.closed.then(a=>{var c;this.isEstablishingConnection&&b(ej.internal("Websocket got closed during a (re)connection attempt: ".concat(a.reason))),1e3!==a.closeCode&&(this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:a.reason,code:a.closeCode,wasClean:1e3===a.closeCode,state:this.state})),this.state===hQ.CONNECTED&&this.handleOnClose(null!=(c=a.reason)?c:"Unexpected WS error"))}).catch(a=>{this.isEstablishingConnection&&b(ej.internal("Websocket error during a (re)connection attempt: ".concat(a)))});let d=yield this.ws.opened.catch(a=>di(this,void 0,void 0,function*(){if(this.state!==hQ.CONNECTED){this.state=hQ.DISCONNECTED,clearTimeout(j);let c=yield this.handleConnectionError(a,w);b(c);return}this.handleWSError(a),b(a)}));if(clearTimeout(j),!d)return;let g=d.readable.getReader();this.streamWriter=d.writable.getWriter();let h=yield g.read();if(g.releaseLock(),!h.value)throw ej.internal("no message received as first message");let i=ft(h.value),l=this.validateFirstMessage(i,null!=(e=c.reconnect)&&e);if(!l.isValid)return void b(l.error);(null==(f=i.message)?void 0:f.case)==="join"&&(this.pingTimeoutDuration=i.message.value.pingTimeout,this.pingIntervalDuration=i.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));let m=l.shouldProcessFirstMessage?i:void 0;k(d,m),a(l.response)}catch(a){b(a)}finally{i()}}finally{s()}}))})}startReadingLoop(a,b){return di(this,void 0,void 0,function*(){for(b&&this.handleSignalResponse(b);;){this.signalLatency&&(yield eQ(this.signalLatency));let{done:b,value:c}=yield a.read();if(b)break;let d=ft(c);this.handleSignalResponse(d)}})}close(){return di(this,arguments,void 0,function(){var a=this;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0],c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Close method called on signal client";return function*(){if([hQ.DISCONNECTING||hQ.DISCONNECTED].includes(a.state))return void a.log.debug("ignoring signal close as it's already in disconnecting state");let d=yield a.closingLock.lock();try{if(a.clearPingInterval(),b&&(a.state=hQ.DISCONNECTING),a.ws){a.ws.close({closeCode:1e3,reason:c});let b=a.ws.closed;a.ws=void 0,a.streamWriter=void 0,yield Promise.race([b,eQ(250)])}}catch(b){a.log.debug("websocket error while closing",Object.assign(Object.assign({},a.logContext),{error:b}))}finally{b&&(a.state=hQ.DISCONNECTED),d()}}()})}sendOffer(a,b){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:a.sdp})),this.sendRequest({case:"offer",value:fF(a,b)})}sendAnswer(a,b){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:a.sdp})),this.sendRequest({case:"answer",value:fF(a,b)})}sendIceCandidate(a,b){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:a})),this.sendRequest({case:"trickle",value:new cr({candidateInit:JSON.stringify(a),target:b})})}sendMuteTrack(a,b){return this.sendRequest({case:"mute",value:new cs({sid:a,muted:b})})}sendAddTrack(a){return this.sendRequest({case:"addTrack",value:a})}sendUpdateLocalMetadata(a,b){return di(this,arguments,void 0,function(a,b){var c=this;let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function*(){let e=c.getNextRequestId();return yield c.sendRequest({case:"updateMetadata",value:new cG({requestId:e,metadata:a,name:b,attributes:d})}),e}()})}sendUpdateTrackSettings(a){this.sendRequest({case:"trackSetting",value:a})}sendUpdateSubscription(a){return this.sendRequest({case:"subscription",value:a})}sendSyncState(a){return this.sendRequest({case:"syncState",value:a})}sendUpdateVideoLayers(a,b){return this.sendRequest({case:"updateLayers",value:new cF({trackSid:a,layers:b})})}sendUpdateSubscriptionPermissions(a,b){return this.sendRequest({case:"subscriptionPermission",value:new cT({allParticipants:a,trackPermissions:b})})}sendSimulateScenario(a){return this.sendRequest({case:"simulate",value:a})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:ad.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new c$({timestamp:ad.parse(Date.now()),rtt:ad.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(a,b){return this.sendRequest({case:"updateAudioTrack",value:new cB({trackSid:a,features:b})})}sendLeave(){return this.sendRequest({case:"leave",value:new cD({reason:bd.CLIENT_INITIATED,action:cE.DISCONNECT})})}sendRequest(a){return di(this,arguments,void 0,function(a){var b=this;let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function*(){let d;if(!c&&(d=fC.indexOf(a.case)>=0,de.trace("request allowed to bypass queue:",{canPass:d,req:a}),!d)&&b.state===hQ.RECONNECTING)return void b.queuedRequests.push(()=>di(b,void 0,void 0,function*(){yield this.sendRequest(a,!0)}));if(c||(yield b.requestQueue.flush()),b.signalLatency&&(yield eQ(b.signalLatency)),b.isDisconnected)return void b.log.debug("skipping signal request (type: ".concat(a.case,") - SignalClient disconnected"));if(!b.streamWriter)return void b.log.error("cannot send signal request before connected, type: ".concat(null==a?void 0:a.case),b.logContext);let e=new cn({message:a});try{b.useJSON?yield b.streamWriter.write(e.toJsonString()):yield b.streamWriter.write(e.toBinary())}catch(a){b.log.error("error sending signal message",Object.assign(Object.assign({},b.logContext),{error:a}))}}()})}handleSignalResponse(a){var b,c;let d=a.message;if(void 0==d)return void this.log.debug("received unsupported message",this.logContext);let e=!1;if("answer"===d.case){let a=fE(d.value);this.onAnswer&&this.onAnswer(a,d.value.id,d.value.midToTrackId)}else if("offer"===d.case){let a=fE(d.value);this.onOffer&&this.onOffer(a,d.value.id,d.value.midToTrackId)}else if("trickle"===d.case){let a=JSON.parse(d.value.candidateInit);this.onTrickle&&this.onTrickle(a,d.value.target)}else"update"===d.case?this.onParticipantUpdate&&this.onParticipantUpdate(null!=(b=d.value.participants)?b:[]):"trackPublished"===d.case?this.onLocalTrackPublished&&this.onLocalTrackPublished(d.value):"speakersChanged"===d.case?this.onSpeakersChanged&&this.onSpeakersChanged(null!=(c=d.value.speakers)?c:[]):"leave"===d.case?this.onLeave&&this.onLeave(d.value):"mute"===d.case?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(d.value.sid,d.value.muted):"roomUpdate"===d.case?this.onRoomUpdate&&d.value.room&&this.onRoomUpdate(d.value.room):"connectionQuality"===d.case?this.onConnectionQuality&&this.onConnectionQuality(d.value):"streamStateUpdate"===d.case?this.onStreamStateUpdate&&this.onStreamStateUpdate(d.value):"subscribedQualityUpdate"===d.case?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(d.value):"subscriptionPermissionUpdate"===d.case?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(d.value):"refreshToken"===d.case?this.onTokenRefresh&&this.onTokenRefresh(d.value):"trackUnpublished"===d.case?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(d.value):"subscriptionResponse"===d.case?this.onSubscriptionError&&this.onSubscriptionError(d.value):"pong"===d.case||("pongResp"===d.case?(this.rtt=Date.now()-Number.parseInt(d.value.lastPingTimestamp.toString()),this.resetPingTimeout(),e=!0):"requestResponse"===d.case?this.onRequestResponse&&this.onRequestResponse(d.value):"trackSubscribed"===d.case?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(d.value.trackSid):"roomMoved"===d.case?(this.onTokenRefresh&&this.onTokenRefresh(d.value.token),this.onRoomMoved&&this.onRoomMoved(d.value)):"mediaSectionsRequirement"===d.case?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(d.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:d.case})));e||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){let a=this.queuedRequests.shift();a&&this.requestQueue.run(a)}}handleOnClose(a){return di(this,void 0,void 0,function*(){if(this.state===hQ.DISCONNECTED)return;let b=this.onClose;yield this.close(void 0,a),this.log.debug("websocket connection closed: ".concat(a),Object.assign(Object.assign({},this.logContext),{reason:a})),b&&b(a)})}handleWSError(a){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:a}))}resetPingTimeout(){(this.clearPingTimeout(),this.pingTimeoutDuration)?this.pingTimeout=et.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-1e3*this.pingTimeoutDuration).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},1e3*this.pingTimeoutDuration):this.log.warn("ping timeout duration not set",this.logContext)}clearPingTimeout(){this.pingTimeout&&et.clearTimeout(this.pingTimeout)}startPingInterval(){(this.clearPingInterval(),this.resetPingTimeout(),this.pingIntervalDuration)?(this.log.debug("start ping interval",this.logContext),this.pingInterval=et.setInterval(()=>{this.sendPing()},1e3*this.pingIntervalDuration)):this.log.warn("ping interval duration not set",this.logContext)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&et.clearInterval(this.pingInterval)}handleSignalConnected(a,b,c){this.state=hQ.CONNECTED,clearTimeout(b),this.startPingInterval(),this.startReadingLoop(a.readable.getReader(),c)}validateFirstMessage(a,b){var c,d,e,f,g;if((null==(c=a.message)?void 0:c.case)==="join")return{isValid:!0,response:a.message.value};if(this.state===hQ.RECONNECTING&&(null==(d=a.message)?void 0:d.case)!=="leave")if((null==(e=a.message)?void 0:e.case)==="reconnect")return{isValid:!0,response:a.message.value};else return this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0};return this.isEstablishingConnection&&(null==(f=a.message)?void 0:f.case)==="leave"?{isValid:!1,error:ej.leaveRequest("Received leave request while trying to (re)connect",a.message.value.reason)}:b?{isValid:!1,error:ej.internal("Unexpected first message")}:{isValid:!1,error:ej.internal("did not receive join response, got ".concat(null==(g=a.message)?void 0:g.case," instead"))}}handleConnectionError(a,b){return di(this,void 0,void 0,function*(){try{let c=yield fetch(b);if(c.status.toFixed(0).startsWith("4")){let a=yield c.text();return ej.notAllowed(a,c.status)}if(a instanceof ej)return a;return ej.internal("Encountered unknown websocket error during connection: ".concat(a),{status:c.status,statusText:c.statusText})}catch(a){return a instanceof ej?a:ej.serverUnreachable(a instanceof Error?a.message:"server was not reachable")}})}}function fE(a){let b={type:"offer",sdp:a.sdp};switch(a.type){case"answer":case"offer":case"pranswer":case"rollback":b.type=a.type}return b}function fF(a,b){return new cx({sdp:a.sdp,type:a.type,id:b})}class fG{constructor(){this.buffer=[],this._totalSize=0}push(a){this.buffer.push(a),this._totalSize+=a.data.byteLength}pop(){let a=this.buffer.shift();return a&&(this._totalSize-=a.data.byteLength),a}getAll(){return this.buffer.slice()}popToSequence(a){for(;this.buffer.length>0;)if(this.buffer[0].sequence<=a)this.pop();else break}alignBufferedAmount(a){for(;this.buffer.length>0;){let b=this.buffer[0];if(this._totalSize-b.data.byteLength<=a)break;this.pop()}}get length(){return this.buffer.length}}class fH{constructor(a){this._map=new Map,this._lastCleanup=0,this.ttl=a}set(a,b){let c=Date.now();c-this._lastCleanup>this.ttl/2&&this.cleanup();let d=c+this.ttl;return this._map.set(a,{value:b,expiresAt:d}),this}get(a){let b=this._map.get(a);if(b)return b.expiresAt<Date.now()?void this._map.delete(a):b.value}has(a){let b=this._map.get(a);return!!b&&(!(b.expiresAt<Date.now())||(this._map.delete(a),!1))}delete(a){return this._map.delete(a)}clear(){this._map.clear()}cleanup(){let a=Date.now();for(let[b,c]of this._map.entries())c.expiresAt<a&&this._map.delete(b);this._lastCleanup=a}get size(){return this.cleanup(),this._map.size}forEach(a){for(let[b,c]of(this.cleanup(),this._map.entries()))c.expiresAt>=Date.now()&&a(c.value,b,this.asValueMap())}map(a){this.cleanup();let b=[],c=this.asValueMap();for(let[d,e]of c.entries())b.push(a(e,d,c));return b}asValueMap(){let a=new Map;for(let[b,c]of this._map.entries())c.expiresAt>=Date.now()&&a.set(b,c.value);return a}}var fI={},fJ={},fK={exports:{}};function fL(){if(hR)return fK.exports;hR=1;var a=fK.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(a){return a.encoding?"rtpmap:%d %s/%s/%s":a.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(a){return null!=a.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(a){return null!=a.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(a){return"extmap:%d"+(a.direction?"/%s":"%v")+(a["encrypt-uri"]?" %s":"%v")+" %s"+(a.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(a){return null!=a.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(a){var b="candidate:%s %d %s %d %s %d typ %s";return b+=(null!=a.raddr?" raddr %s rport %d":"%v%v")+(null!=a.tcptype?" tcptype %s":"%v"),null!=a.generation&&(b+=" generation %d"),b+=(null!=a["network-id"]?" network-id %d":"%v")+(null!=a["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(a){var b="ssrc:%d";return null!=a.attribute&&(b+=" %s",null!=a.value&&(b+=":%s")),b}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(a){return null!=a.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(a){return a.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(a){return"imageattr:%s %s %s"+(a.dir2?" %s %s":"")}},{name:"simulcast",reg:RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(a){return"simulcast:%s %s"+(a.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(a){return"ts-refclk:%s"+(null!=a.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(a){var b="mediaclk:";return b+((null!=a.id?"id=%s %s":"%v%s")+(null!=a.mediaClockValue?"=%s":"")+(null!=a.rateNumerator?" rate=%s":"")+(null!=a.rateDenominator?"/%s":""))}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(a).forEach(function(b){a[b].forEach(function(a){a.reg||(a.reg=/(.*)/),a.format||(a.format="%s")})}),fK.exports}var fM=function(){if(hV)return fI;hV=1;var a=function(){var a,b,c,d,e,f;return hS?fJ:(hS=1,a=function(a){return String(Number(a))===a?Number(a):a},b=function(b,c,d,e){if(e&&!d)c[e]=a(b[1]);else for(var f=0;f<d.length;f+=1)null!=b[f+1]&&(c[d[f]]=a(b[f+1]))},c=function(a,c,d){var e=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:e&&!c[a.name]&&(c[a.name]={});var f=a.push?{}:e?c[a.name]:c;b(d.match(a.reg),f,a.names,a.name),a.push&&c[a.push].push(f)},d=fL(),e=RegExp.prototype.test.bind(/^([a-z])=(.*)/),fJ.parse=function(a){var b={},f=[],g=b;return a.split(/(\r\n|\r|\n)/).filter(e).forEach(function(a){var b=a[0],e=a.slice(2);"m"===b&&(f.push({rtp:[],fmtp:[]}),g=f[f.length-1]);for(var h=0;h<(d[b]||[]).length;h+=1){var i=d[b][h];if(i.reg.test(e))return c(i,g,e)}}),b.media=f,b},f=function(b,c){var d=c.split(/=(.+)/,2);return 2===d.length?b[d[0]]=a(d[1]):1===d.length&&c.length>1&&(b[d[0]]=void 0),b},fJ.parseParams=function(a){return a.split(/;\s?/).reduce(f,{})},fJ.parseFmtpConfig=fJ.parseParams,fJ.parsePayloads=function(a){return a.toString().split(" ").map(Number)},fJ.parseRemoteCandidates=function(b){for(var c=[],d=b.split(" ").map(a),e=0;e<d.length;e+=3)c.push({component:d[e],ip:d[e+1],port:d[e+2]});return c},fJ.parseImageAttributes=function(a){return a.split(" ").map(function(a){return a.substring(1,a.length-1).split(",").reduce(f,{})})},fJ.parseSimulcastStreamList=function(b){return b.split(";").map(function(b){return b.split(",").map(function(b){var c,d=!1;return"~"!==b[0]?c=a(b):(c=a(b.substring(1,b.length)),d=!0),{scid:c,paused:d}})})},fJ)}(),b=function(){if(hU)return hT;hU=1;var a=fL(),b=/%[sdv%]/g,c=function(a){var c=1,d=arguments,e=d.length;return a.replace(b,function(a){if(c>=e)return a;var b=d[c];switch(c+=1,a){case"%%":return"%";case"%s":return String(b);case"%d":return Number(b);case"%v":return""}})},d=function(a,b,d){var e=[a+"="+(b.format instanceof Function?b.format(b.push?d:d[b.name]):b.format)];if(b.names)for(var f=0;f<b.names.length;f+=1){var g=b.names[f];b.name?e.push(d[b.name][g]):e.push(d[b.names[f]])}else e.push(d[b.name]);return c.apply(null,e)},e=["v","o","s","i","u","e","p","c","b","t","r","z","a"],f=["i","c","b","a"];return hT=function(b,c){c=c||{},null==b.version&&(b.version=0),null==b.name&&(b.name=" "),b.media.forEach(function(a){null==a.payloads&&(a.payloads="")});var g=c.outerOrder||e,h=c.innerOrder||f,i=[];return g.forEach(function(c){a[c].forEach(function(a){a.name in b&&null!=b[a.name]?i.push(d(c,a,b)):a.push in b&&null!=b[a.push]&&b[a.push].forEach(function(b){i.push(d(c,a,b))})})}),b.media.forEach(function(b){i.push(d("m",a.m[0],b)),h.forEach(function(c){a[c].forEach(function(a){a.name in b&&null!=b[a.name]?i.push(d(c,a,b)):a.push in b&&null!=b[a.push]&&b[a.push].forEach(function(b){i.push(d(c,a,b))})})})}),i.join("\r\n")+"\r\n"}}();return fI.grammar=fL(),fI.write=b,fI.parse=a.parse,fI.parseParams=a.parseParams,fI.parseFmtpConfig=a.parseFmtpConfig,fI.parsePayloads=a.parsePayloads,fI.parseRemoteCandidates=a.parseRemoteCandidates,fI.parseImageAttributes=a.parseImageAttributes,fI.parseSimulcastStreamList=a.parseSimulcastStreamList,fI}();function fN(a,b,c){void 0===b&&(b=50),void 0===c&&(c={});var d,e,f,g=null!=(d=c.isImmediate)&&d,h=null!=(e=c.callback)&&e,i=c.maxWait,j=Date.now(),k=[],l=function(){var c=[].slice.call(arguments),d=this;return new Promise(function(e,l){var m=g&&void 0===f;if(void 0!==f&&clearTimeout(f),f=setTimeout(function(){if(f=void 0,j=Date.now(),!g){var b=a.apply(d,c);h&&h(b),k.forEach(function(a){return(0,a.resolve)(b)}),k=[]}},function(){if(void 0!==i){var a=Date.now()-j;if(a+b>=i)return i-a}return b}()),m){var n=a.apply(d,c);return h&&h(n),e(n)}k.push({resolve:e,reject:l})})};return l.cancel=function(a){void 0!==f&&clearTimeout(f),k.forEach(function(b){return(0,b.reject)(a)}),k=[]},l}let fO="negotiationStarted",fP="negotiationComplete",fQ="rtpVideoPayloadTypes";class fR extends dl.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(a){var b;let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.log=de,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=fN(a=>di(this,void 0,void 0,function*(){this.emit(fO);try{yield this.createAndSendOffer()}catch(b){if(a)a(b);else throw b}}),20),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=df(null!=(b=c.loggerName)?b:hx.PCTransport),this.loggerOptions=c,this.config=a,this._pc=this.createPC(),this.offerLock=new M}createPC(){let a=new RTCPeerConnection(this.config);return a.onicecandidate=a=>{var b;a.candidate&&(null==(b=this.onIceCandidate)||b.call(this,a.candidate))},a.onicecandidateerror=a=>{var b;null==(b=this.onIceCandidateError)||b.call(this,a)},a.oniceconnectionstatechange=()=>{var b;null==(b=this.onIceConnectionStateChange)||b.call(this,a.iceConnectionState)},a.onsignalingstatechange=()=>{var b;null==(b=this.onSignalingStatechange)||b.call(this,a.signalingState)},a.onconnectionstatechange=()=>{var b;null==(b=this.onConnectionStateChange)||b.call(this,a.connectionState)},a.ondatachannel=a=>{var b;null==(b=this.onDataChannel)||b.call(this,a)},a.ontrack=a=>{var b;null==(b=this.onTrack)||b.call(this,a)},a}get logContext(){var a,b;return Object.assign({},null==(b=(a=this.loggerOptions).loggerContextCb)?void 0:b.call(a))}get isICEConnected(){return null!==this._pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}addIceCandidate(a){return di(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(a);this.pendingCandidates.push(a)})}setRemoteDescription(a,b){return di(this,void 0,void 0,function*(){var c,d,e;let f;if("answer"===a.type&&this.latestOfferId>0&&b>0&&b!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:b,latestOfferId:this.latestOfferId})),!1;if("offer"===a.type){let b,c,f,g,{stereoMids:h,nackMids:i}=(d=a,b=[],c=[],f=fM.parse(null!=(e=d.sdp)?e:""),g=0,f.media.forEach(a=>{var d;let e=fU(a.mid);"audio"===a.type&&(a.rtp.some(a=>"opus"===a.codec&&(g=a.payload,!0)),(null==(d=a.rtcpFb)?void 0:d.some(a=>a.payload===g&&"nack"===a.type))&&c.push(e),a.fmtp.some(a=>a.payload===g&&(a.config.includes("sprop-stereo=1")&&b.push(e),!0)))}),{stereoMids:b,nackMids:c});this.remoteStereoMids=h,this.remoteNackMids=i}else if("answer"===a.type){let b=fM.parse(null!=(c=a.sdp)?c:"");b.media.forEach(a=>{let b=fU(a.mid);"audio"===a.type&&this.trackBitrates.some(c=>{if(!c.transceiver||b!=c.transceiver.mid)return!1;let d=0;if(a.rtp.some(a=>a.codec.toUpperCase()===c.codec.toUpperCase()&&(d=a.payload,!0)),0===d)return!0;let e=!1;for(let b of a.fmtp)if(b.payload===d){b.config=b.config.split(";").filter(a=>!a.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(b.config+=";maxaveragebitrate=".concat(1e3*c.maxbr)),e=!0;break}return!e&&c.maxbr>0&&a.fmtp.push({payload:d,config:"maxaveragebitrate=".concat(1e3*c.maxbr)}),!0})}),f=fM.write(b)}return yield this.setMungedSDP(a,f,!0),this.pendingCandidates.forEach(a=>{this.pc.addIceCandidate(a)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):"answer"===a.type&&(this.emit(fP),a.sdp&&fM.parse(a.sdp).media.forEach(a=>{"video"===a.type&&this.emit(fQ,a.rtp)})),!0})}createAndSendOffer(a){return di(this,void 0,void 0,function*(){var b;let c=yield this.offerLock.lock();try{if(void 0===this.onOffer)return;if((null==a?void 0:a.iceRestart)&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&"have-local-offer"===this._pc.signalingState){let b=this._pc.remoteDescription;if((null==a?void 0:a.iceRestart)&&b)yield this._pc.setRemoteDescription(b);else{this.renegotiate=!0;return}}else if(!this._pc||"closed"===this._pc.signalingState)return void this.log.warn("could not createOffer with closed peer connection",this.logContext);this.log.debug("starting to negotiate",this.logContext);let c=this.latestOfferId+1;this.latestOfferId=c;let d=yield this.pc.createOffer(a);this.log.debug("original offer",Object.assign({sdp:d.sdp},this.logContext));let e=fM.parse(null!=(b=d.sdp)?b:"");if(e.media.forEach(a=>{fT(a),"audio"===a.type?fS(a,["all"],[]):"video"===a.type&&this.trackBitrates.some(b=>{if(!a.msid||!b.cid||!a.msid.includes(b.cid))return!1;let c=0;if(a.rtp.some(a=>a.codec.toUpperCase()===b.codec.toUpperCase()&&(c=a.payload,!0)),0===c||(eT(b.codec)&&!eX()&&this.ensureVideoDDExtensionForSVC(a,e),!eT(b.codec)))return!0;let d=Math.round(.7*b.maxbr);for(let b of a.fmtp)if(b.payload===c){b.config.includes("x-google-start-bitrate")||(b.config+=";x-google-start-bitrate=".concat(d));break}return!0})}),this.latestOfferId>c)return void this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:c}));yield this.setMungedSDP(d,fM.write(e)),this.onOffer(d,this.latestOfferId)}finally{c()}})}createAndSetAnswer(){return di(this,void 0,void 0,function*(){var a;let b=yield this.pc.createAnswer(),c=fM.parse(null!=(a=b.sdp)?a:"");return c.media.forEach(a=>{fT(a),"audio"===a.type&&fS(a,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(b,fM.write(c)),b})}createDataChannel(a,b){return this.pc.createDataChannel(a,b)}addTransceiver(a,b){return this.pc.addTransceiver(a,b)}addTransceiverOfKind(a,b){return this.pc.addTransceiver(a,b)}addTrack(a){if(!this._pc)throw new en("PC closed, cannot add track");return this._pc.addTrack(a)}setTrackCodecBitrate(a){this.trackBitrates.push(a)}setConfiguration(a){var b;if(!this._pc)throw new en("PC closed, cannot configure");return null==(b=this._pc)?void 0:b.setConfiguration(a)}canRemoveTrack(){var a;return!!(null==(a=this._pc)?void 0:a.removeTrack)}removeTrack(a){var b;return null==(b=this._pc)?void 0:b.removeTrack(a)}getConnectionState(){var a,b;return null!=(b=null==(a=this._pc)?void 0:a.connectionState)?b:"closed"}getICEConnectionState(){var a,b;return null!=(b=null==(a=this._pc)?void 0:a.iceConnectionState)?b:"closed"}getSignallingState(){var a,b;return null!=(b=null==(a=this._pc)?void 0:a.signalingState)?b:"closed"}getTransceivers(){var a,b;return null!=(b=null==(a=this._pc)?void 0:a.getTransceivers())?b:[]}getSenders(){var a,b;return null!=(b=null==(a=this._pc)?void 0:a.getSenders())?b:[]}getLocalDescription(){var a;return null==(a=this._pc)?void 0:a.localDescription}getRemoteDescription(){var a;return null==(a=this.pc)?void 0:a.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return di(this,void 0,void 0,function*(){var a;if(!this._pc)return;let b="",c=new Map,d=new Map;if((yield this._pc.getStats()).forEach(a=>{switch(a.type){case"transport":b=a.selectedCandidatePairId;break;case"candidate-pair":""===b&&a.selected&&(b=a.id),c.set(a.id,a);break;case"remote-candidate":d.set(a.id,"".concat(a.address,":").concat(a.port))}}),""===b)return;let e=null==(a=c.get(b))?void 0:a.remoteCandidateId;if(void 0!==e)return d.get(e)})}setMungedSDP(a,b,c){return di(this,void 0,void 0,function*(){if(b){let d=a.sdp;a.sdp=b;try{this.log.debug("setting munged ".concat(c?"remote":"local"," description"),this.logContext),c?yield this.pc.setRemoteDescription(a):yield this.pc.setLocalDescription(a);return}catch(c){this.log.warn("not able to set ".concat(a.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:c,sdp:b})),a.sdp=d}}try{c?yield this.pc.setRemoteDescription(a):yield this.pc.setLocalDescription(a)}catch(e){let b="unknown error";e instanceof Error?b=e.message:"string"==typeof e&&(b=e);let d={error:b,sdp:a.sdp};throw!c&&this.pc.remoteDescription&&(d.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(a.type),Object.assign(Object.assign({},this.logContext),{fields:d})),new eo(b)}})}ensureVideoDDExtensionForSVC(a,b){var c,d;if(!(null==(c=a.ext)?void 0:c.some(a=>a.uri===eP))){if(0===this.ddExtID){let a=0;b.media.forEach(b=>{var c;"video"===b.type&&(null==(c=b.ext)||c.forEach(b=>{b.value>a&&(a=b.value)}))}),this.ddExtID=a+1}null==(d=a.ext)||d.push({value:this.ddExtID,uri:eP})}}}function fS(a,b,c){let d=fU(a.mid),e=0;a.rtp.some(a=>"opus"===a.codec&&(e=a.payload,!0)),e>0&&(a.rtcpFb||(a.rtcpFb=[]),c.includes(d)&&!a.rtcpFb.some(a=>a.payload===e&&"nack"===a.type)&&a.rtcpFb.push({payload:e,type:"nack"}),(b.includes(d)||1===b.length&&"all"===b[0])&&a.fmtp.some(a=>a.payload===e&&(a.config.includes("stereo=1")||(a.config+=";stereo=1"),!0)))}function fT(a){if(a.connection){let b=a.connection.ip.indexOf(":")>=0;(4===a.connection.version&&b||6===a.connection.version&&!b)&&(a.connection.ip="0.0.0.0",a.connection.version=4)}}function fU(a){return"number"==typeof a?a.toFixed(0):a}let fV={audioPreset:hI.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:eA.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:"vp8",backupCodec:!0,preConnectBuffer:!1},fW={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},fX={deviceId:{ideal:"default"},resolution:ey.h720.resolution},fY={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new class{constructor(a){this._retryDelays=void 0!==a?[...a]:dh}nextRetryDelayInMs(a){if(a.retryCount>=this._retryDelays.length)return null;let b=this._retryDelays[a.retryCount];return a.retryCount<=1?b:b+1e3*Math.random()}},disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},fZ={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};(hk=hW||(hW={}))[hk.NEW=0]="NEW",hk[hk.CONNECTING=1]="CONNECTING",hk[hk.CONNECTED=2]="CONNECTED",hk[hk.FAILED=3]="FAILED",hk[hk.CLOSING=4]="CLOSING",hk[hk.CLOSED=5]="CLOSED";class f${get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(a,b,c){var d;this.peerConnectionTimeout=fZ.peerConnectionTimeout,this.log=de,this.updateState=()=>{var a,b;let c=this.state,d=this.requiredTransports.map(a=>a.getConnectionState());d.every(a=>"connected"===a)?this.state=hW.CONNECTED:d.some(a=>"failed"===a)?this.state=hW.FAILED:d.some(a=>"connecting"===a)?this.state=hW.CONNECTING:d.every(a=>"closed"===a)?this.state=hW.CLOSED:d.some(a=>"closed"===a)?this.state=hW.CLOSING:d.every(a=>"new"===a)&&(this.state=hW.NEW),c!==this.state&&(this.log.debug("pc state change: from ".concat(hW[c]," to ").concat(hW[this.state]),this.logContext),null==(a=this.onStateChange)||a.call(this,this.state,this.publisher.getConnectionState(),null==(b=this.subscriber)?void 0:b.getConnectionState()))},this.log=df(null!=(d=c.loggerName)?d:hx.PCManager),this.loggerOptions=c,this.isPublisherConnectionRequired="subscriber-primary"!==b,this.isSubscriberConnectionRequired="subscriber-primary"===b,this.publisher=new fR(a,c),"publisher-only"!==b&&(this.subscriber=new fR(a,c),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=a=>{var b;null==(b=this.onIceCandidate)||b.call(this,a,ck.SUBSCRIBER)},this.subscriber.onDataChannel=a=>{var b;null==(b=this.onDataChannel)||b.call(this,a)},this.subscriber.onTrack=a=>{var b;null==(b=this.onTrack)||b.call(this,a)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=a=>{var b;null==(b=this.onIceCandidate)||b.call(this,a,ck.PUBLISHER)},this.publisher.onTrack=a=>{var b;null==(b=this.onTrack)||b.call(this,a)},this.publisher.onOffer=(a,b)=>{var c;null==(c=this.onPublisherOffer)||c.call(this,a,b)},this.state=hW.NEW,this.connectionLock=new M,this.remoteOfferLock=new M}get logContext(){var a,b;return Object.assign({},null==(b=(a=this.loggerOptions).loggerContextCb)?void 0:b.call(a))}requirePublisher(){let a=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.isPublisherConnectionRequired=a,this.updateState()}createAndSendPublisherOffer(a){return this.publisher.createAndSendOffer(a)}setPublisherAnswer(a,b){return this.publisher.setRemoteDescription(a,b)}removeTrack(a){return this.publisher.removeTrack(a)}close(){return di(this,void 0,void 0,function*(){var a;if(this.publisher&&"closed"!==this.publisher.getSignallingState()){let a=this.publisher;for(let b of a.getSenders())try{a.canRemoveTrack()&&a.removeTrack(b)}catch(a){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:a}))}}yield Promise.all([this.publisher.close(),null==(a=this.subscriber)?void 0:a.close()]),this.updateState()})}triggerIceRestart(){return di(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(a,b){return di(this,void 0,void 0,function*(){var c;b===ck.PUBLISHER?yield this.publisher.addIceCandidate(a):yield null==(c=this.subscriber)?void 0:c.addIceCandidate(a)})}createSubscriberAnswerFromOffer(a,b){return di(this,void 0,void 0,function*(){var c,d,e;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:a.type,sdp:a.sdp,signalingState:null==(c=this.subscriber)?void 0:c.getSignallingState().toString()}));let f=yield this.remoteOfferLock.lock();try{if(!(yield null==(d=this.subscriber)?void 0:d.setRemoteDescription(a,b)))return;return yield null==(e=this.subscriber)?void 0:e.createAndSetAnswer()}finally{f()}})}updateConfiguration(a,b){var c;this.publisher.setConfiguration(a),null==(c=this.subscriber)||c.setConfiguration(a),b&&this.triggerIceRestart()}ensurePCTransportConnection(a,b){return di(this,void 0,void 0,function*(){var c;let d=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&"connected"!==this.publisher.getConnectionState()&&"connecting"!==this.publisher.getConnectionState()&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all(null==(c=this.requiredTransports)?void 0:c.map(c=>this.ensureTransportConnected(c,a,b)))}finally{d()}})}negotiate(a){return di(this,void 0,void 0,function*(){return new Promise((b,c)=>di(this,void 0,void 0,function*(){let d=setTimeout(()=>{c("negotiation timed out")},this.peerConnectionTimeout);a.signal.addEventListener("abort",()=>{clearTimeout(d),c("negotiation aborted")}),this.publisher.once(fO,()=>{a.signal.aborted||this.publisher.once(fP,()=>{clearTimeout(d),b()})}),yield this.publisher.negotiate(a=>{clearTimeout(d),c(a)})}))})}addPublisherTransceiver(a,b){return this.publisher.addTransceiver(a,b)}addPublisherTransceiverOfKind(a,b){return this.publisher.addTransceiverOfKind(a,b)}getMidForReceiver(a){let b=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(b=>b.receiver===a);return null==b?void 0:b.mid}addPublisherTrack(a){return this.publisher.addTrack(a)}createPublisherDataChannel(a,b){return this.publisher.createDataChannel(a,b)}getConnectedAddress(a){return a===ck.PUBLISHER||a===ck.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){let a=[];return this.isPublisherConnectionRequired&&a.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&a.push(this.subscriber),a}ensureTransportConnected(a,b){return di(this,arguments,void 0,function(a,b){var c=this;let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.peerConnectionTimeout;return function*(){if("connected"!==a.getConnectionState())return new Promise((a,e)=>di(c,void 0,void 0,function*(){let c=()=>{this.log.warn("abort transport connection",this.logContext),et.clearTimeout(f),e(ej.cancelled("room connection has been cancelled"))};(null==b?void 0:b.signal.aborted)&&c(),null==b||b.signal.addEventListener("abort",c);let f=et.setTimeout(()=>{null==b||b.signal.removeEventListener("abort",c),e(ej.internal("could not establish pc connection"))},d);for(;this.state!==hW.CONNECTED;)if(yield eQ(50),null==b?void 0:b.signal.aborted)return void e(ej.cancelled("room connection has been cancelled"));et.clearTimeout(f),null==b||b.signal.removeEventListener("abort",c),a()}))}()})}}class f_{static fetchRegionSettings(a,b,c){return di(this,void 0,void 0,function*(){let d=yield f_.fetchLock.lock();try{var e;let d=yield fetch("".concat((e=a,"".concat(e.protocol.replace("ws","http"),"//").concat(e.host,"/settings")),"/regions"),{headers:{authorization:"Bearer ".concat(b)},signal:c});if(d.ok){let a=function(a){var b;let c=a.get("Cache-Control");if(c){let a=null==(b=c.match(/(?:^|[,\s])max-age=(\d+)/))?void 0:b[1];if(a)return parseInt(a,10)}}(d.headers);return{regionSettings:yield d.json(),updatedAtInMs:Date.now(),maxAgeInMs:a?1e3*a:5e3}}if(401===d.status)throw ej.notAllowed("Could not fetch region settings: ".concat(d.statusText),d.status);throw ej.internal("Could not fetch region settings: ".concat(d.statusText))}catch(a){if(a instanceof ej)throw a;if(null==c?void 0:c.aborted)throw ej.cancelled("Region fetching was aborted");throw ej.serverUnreachable("Could not fetch region settings, ".concat(a instanceof Error?"".concat(a.name,": ").concat(a.message):a))}finally{d()}})}static scheduleRefetch(a,b,c){return di(this,void 0,void 0,function*(){clearTimeout(f_.settingsTimeouts.get(a.hostname)),f_.settingsTimeouts.set(a.hostname,setTimeout(()=>di(this,void 0,void 0,function*(){try{let c=yield f_.fetchRegionSettings(a,b);f_.updateCachedRegionSettings(a,b,c)}catch(d){if(d instanceof ej&&d.reason===hA.NotAllowed)return void de.debug("token is not valid, cancelling auto region refresh");de.debug("auto refetching of region settings failed",{error:d}),f_.scheduleRefetch(a,b,c)}}),c))})}static updateCachedRegionSettings(a,b,c){f_.cache.set(a.hostname,c),f_.scheduleRefetch(a,b,c.maxAgeInMs)}static stopRefetch(a){let b=f_.settingsTimeouts.get(a);b&&(clearTimeout(b),f_.settingsTimeouts.delete(a))}static scheduleCleanup(a){let b=f_.connectionTrackers.get(a);b&&(b.cleanupTimeout&&clearTimeout(b.cleanupTimeout),b.cleanupTimeout=setTimeout(()=>{let b=f_.connectionTrackers.get(a);b&&0===b.connectionCount&&(de.debug("stopping region refetch after disconnect delay",{hostname:a}),f_.stopRefetch(a)),b&&(b.cleanupTimeout=void 0)},3e4))}static cancelCleanup(a){let b=f_.connectionTrackers.get(a);(null==b?void 0:b.cleanupTimeout)&&(clearTimeout(b.cleanupTimeout),b.cleanupTimeout=void 0)}notifyConnected(){let a=this.serverUrl.hostname,b=f_.connectionTrackers.get(a);b||(b={connectionCount:0},f_.connectionTrackers.set(a,b)),b.connectionCount++,f_.cancelCleanup(a)}notifyDisconnected(){let a=this.serverUrl.hostname,b=f_.connectionTrackers.get(a);b&&(b.connectionCount=Math.max(0,b.connectionCount-1),0===b.connectionCount&&f_.scheduleCleanup(a))}constructor(a,b){this.attemptedRegions=[],this.serverUrl=new URL(a),this.token=b}updateToken(a){this.token=a}isCloud(){return e0(this.serverUrl)}getServerUrl(){return this.serverUrl}fetchRegionSettings(a){return di(this,void 0,void 0,function*(){return f_.fetchRegionSettings(this.serverUrl,this.token,a)})}getNextBestRegionUrl(a){return di(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");let b=f_.cache.get(this.serverUrl.hostname);(!b||Date.now()-b.updatedAtInMs>b.maxAgeInMs)&&(b=yield this.fetchRegionSettings(a),f_.updateCachedRegionSettings(this.serverUrl,this.token,b));let c=b.regionSettings.regions.filter(a=>!this.attemptedRegions.find(b=>b.url===a.url));if(!(c.length>0))return null;{let a=c[0];return this.attemptedRegions.push(a),de.debug("next region: ".concat(a.region)),a.url}})}resetAttempts(){this.attemptedRegions=[]}setServerReportedRegions(a){f_.updateCachedRegionSettings(this.serverUrl,this.token,a)}}f_.cache=new Map,f_.settingsTimeouts=new Map,f_.connectionTrackers=new Map,f_.fetchLock=new M;class f0 extends Error{constructor(a,b,c){super(b),this.code=a,this.message=f2(b,f0.MAX_MESSAGE_BYTES),this.data=c?f2(c,f0.MAX_DATA_BYTES):void 0}static fromProto(a){return new f0(a.code,a.message,a.data)}toProto(){return new bH({code:this.code,message:this.message,data:this.data})}static builtIn(a,b){return new f0(f0.ErrorCode[a],f0.ErrorMessage[a],b)}}function f1(a){return new TextEncoder().encode(a).length}function f2(a,b){if(f1(a)<=b)return a;let c=0,d=a.length,e=new TextEncoder;for(;c<d;){let f=Math.floor((c+d+1)/2);e.encode(a.slice(0,f)).length<=b?c=f:d=f-1}return a.slice(0,c)}function f3(a,b){let c,d;return b?("bytesReceived"in a?(c=a.bytesReceived,d=b.bytesReceived):"bytesSent"in a&&(c=a.bytesSent,d=b.bytesSent),void 0===c||void 0===d||void 0===a.timestamp||void 0===b.timestamp)?0:(c-d)*8e3/(a.timestamp-b.timestamp):0}f0.MAX_MESSAGE_BYTES=256,f0.MAX_DATA_BYTES=15360,f0.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},f0.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};let f4="undefined"!=typeof MediaRecorder,f5=f4?MediaRecorder:class{constructor(){throw Error("MediaRecorder is not available in this environment")}};class f6 extends f5{constructor(a,b){let c,d;if(!f4)throw Error("MediaRecorder is not available in this environment");super(new MediaStream([a.mediaStreamTrack]),b);const e=()=>{this.removeEventListener("dataavailable",c),this.removeEventListener("stop",e),this.removeEventListener("error",f),null==d||d.close(),d=void 0},f=a=>{null==d||d.error(a),this.removeEventListener("dataavailable",c),this.removeEventListener("stop",e),this.removeEventListener("error",f),d=void 0};this.byteStream=new ReadableStream({start:a=>{d=a,c=b=>di(this,void 0,void 0,function*(){let c;if(b.data.arrayBuffer)c=new Uint8Array((yield b.data.arrayBuffer()));else if(b.data.byteArray)c=b.data.byteArray;else throw Error("no data available!");void 0!==d&&a.enqueue(c)}),this.addEventListener("dataavailable",c)},cancel:()=>{e()}}),this.addEventListener("stop",e),this.addEventListener("error",f)}}class f7 extends eM{get sender(){return this._sender}set sender(a){this._sender=a}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(a,b,c){let d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],e=arguments.length>4?arguments[4]:void 0;super(a,b,e),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=fN(()=>di(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>di(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(hG.Ended,this)},this.reacquireTrack=!1,this.providedByUser=d,this.muteLock=new M,this.pauseUpstreamLock=new M,this.trackChangeLock=new M,this.trackChangeLock.lock().then(b=>di(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(a,!0)}finally{b()}})),this._constraints=a.getConstraints(),c&&(this._constraints=c)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==eM.Kind.Video)return;let{width:a,height:b}=this._mediaStreamTrack.getSettings();if(a&&b)return{width:a,height:b}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var a,b;return null!=(b=null==(a=this.processor)?void 0:a.processedTrack)?b:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(a,b){return di(this,void 0,void 0,function*(){var c;let d;if(a!==this._mediaStreamTrack||b){if(this._mediaStreamTrack&&(this.attachedElements.forEach(a=>{eO(this._mediaStreamTrack,a)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([a]),a&&(a.addEventListener("ended",this.handleEnded),a.addEventListener("mute",this.handleTrackMuteEvent),a.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=a.getConstraints()),this.processor&&a){if(this.log.debug("restarting processor",this.logContext),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(eN(a,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:a,kind:this.kind,element:this.processorElement}),d=this.processor.processedTrack}this.sender&&(null==(c=this.sender.transport)?void 0:c.state)!=="closed"&&(yield this.sender.replaceTrack(null!=d?d:a)),this.providedByUser||this._mediaStreamTrack===a||this._mediaStreamTrack.stop(),this._mediaStreamTrack=a,a&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(b=>{eN(null!=d?d:a,b)}))}})}waitForDimensions(){return di(this,arguments,void 0,function(){var a=this;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return function*(){var c;if(a.kind===eM.Kind.Audio)throw Error("cannot get dimensions for audio tracks");(null==(c=ee())?void 0:c.os)==="iOS"&&(yield eQ(10));let d=Date.now();for(;Date.now()-d<b;){let b=a.dimensions;if(b)return b;yield eQ(50)}throw new el("unable to get track dimensions after timeout")}()})}setDeviceId(a){return di(this,void 0,void 0,function*(){return this._constraints.deviceId===a&&this._mediaStreamTrack.getSettings().deviceId===ff(a)||(this._constraints.deviceId=a,!!this.isMuted||(yield this.restartTrack(),ff(a)===this._mediaStreamTrack.getSettings().deviceId))})}getDeviceId(){return di(this,arguments,void 0,function(){var a=this;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return function*(){if(a.source===eM.Source.ScreenShare)return;let{deviceId:c,groupId:d}=a._mediaStreamTrack.getSettings(),e=a.kind===eM.Kind.Audio?"audioinput":"videoinput";return b?fz.getInstance().normalizeDeviceId(e,c,d):c}()})}mute(){return di(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return di(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(a,b){return di(this,void 0,void 0,function*(){let c=yield this.trackChangeLock.lock();try{let c,d;if(!this.sender)throw new el("unable to replace an unpublished track");return"boolean"==typeof b?c=b:void 0!==b&&(c=b.userProvidedTrack,d=b.stopProcessor),this.providedByUser=null==c||c,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(a),d&&this.processor&&(yield this.internalStopProcessor()),this}finally{c()}})}restart(a){return di(this,void 0,void 0,function*(){this.manuallyStopped=!1;let b=yield this.trackChangeLock.lock();try{a||(a=this._constraints);let{deviceId:b,facingMode:c}=a,d=function(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&0>b.indexOf(d)&&(c[d]=a[d]);if(null!=a&&"function"==typeof Object.getOwnPropertySymbols)for(var e=0,d=Object.getOwnPropertySymbols(a);e<d.length;e++)0>b.indexOf(d[e])&&Object.prototype.propertyIsEnumerable.call(a,d[e])&&(c[d[e]]=a[d[e]]);return c}(a,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:a}));let e={audio:!1,video:!1};this.kind===eM.Kind.Video?e.video=!b&&!c||{deviceId:b,facingMode:c}:e.audio=!b||Object.assign({deviceId:b},d),this.attachedElements.forEach(a=>{eO(this.mediaStreamTrack,a)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();let f=(yield navigator.mediaDevices.getUserMedia(e)).getTracks()[0];return this.kind===eM.Kind.Video&&(yield f.applyConstraints(d)),f.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(f),this._constraints=a,this.emit(hG.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{b()}})}setTrackMuted(a){this.log.debug("setting ".concat(this.kind," track ").concat(a?"muted":"unmuted"),this.logContext),(this.isMuted!==a||this._mediaStreamTrack.enabled===a)&&(this.isMuted=a,this._mediaStreamTrack.enabled=!a,this.emit(a?hG.Muted:hG.Unmuted,this))}get needsReAcquisition(){return"live"!==this._mediaStreamTrack.readyState||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){let a=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return di(this,void 0,void 0,function*(){yield a.handleAppVisibilityChanged.call(this),eZ()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),this.isInBackground||!this.needsReAcquisition||this.isUserProvided||this.isMuted||(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var a;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),null==(a=this.processor)||a.destroy(),this.processor=void 0}pauseUpstream(){return di(this,void 0,void 0,function*(){var a;let b=yield this.pauseUpstreamLock.lock();try{if(!0===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to pause upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!0,this.emit(hG.UpstreamPaused,this);let b=ee();if((null==b?void 0:b.name)==="Safari"&&0>e5(b.version,"12.0"))throw new ek("pauseUpstream is not supported on Safari < 12.");(null==(a=this.sender.transport)?void 0:a.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{b()}})}resumeUpstream(){return di(this,void 0,void 0,function*(){var a;let b=yield this.pauseUpstreamLock.lock();try{if(!1===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to resume upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!1,this.emit(hG.UpstreamResumed,this),(null==(a=this.sender.transport)?void 0:a.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{b()}})}getRTCStatsReport(){return di(this,void 0,void 0,function*(){var a;if(null==(a=this.sender)?void 0:a.getStats)return yield this.sender.getStats()})}setProcessor(a){return di(this,arguments,void 0,function(a){var b=this;let c=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return function*(){var d;let e=yield b.trackChangeLock.lock();try{b.log.debug("setting up processor",b.logContext);let e=document.createElement(b.kind),f={kind:b.kind,track:b._mediaStreamTrack,element:e,audioContext:b.audioContext};if(yield a.init(f),b.log.debug("processor initialized",b.logContext),b.processor&&(yield b.internalStopProcessor()),"unknown"===b.kind)throw TypeError("cannot set processor on track of unknown kind");if(eN(b._mediaStreamTrack,e),e.muted=!0,e.play().catch(a=>{a instanceof DOMException&&"AbortError"===a.name?(b.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},b.logContext),{error:a})),setTimeout(()=>{e.play().catch(a=>{b.log.error("failed to play processor element",Object.assign(Object.assign({},b.logContext),{err:a}))})},100)):b.log.error("failed to play processor element",Object.assign(Object.assign({},b.logContext),{error:a}))}),b.processor=a,b.processorElement=e,b.processor.processedTrack){for(let a of b.attachedElements)a!==b.processorElement&&c&&(eO(b._mediaStreamTrack,a),eN(b.processor.processedTrack,a));yield null==(d=b.sender)?void 0:d.replaceTrack(b.processor.processedTrack)}b.emit(hG.TrackProcessorUpdate,b.processor)}finally{e()}}()})}getProcessor(){return this.processor}stopProcessor(){return di(this,arguments,void 0,function(){var a=this;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return function*(){let c=yield a.trackChangeLock.lock();try{yield a.internalStopProcessor(b)}finally{c()}}()})}internalStopProcessor(){return di(this,arguments,void 0,function(){var a=this;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return function*(){var c,d;a.processor&&(a.log.debug("stopping processor",a.logContext),null==(c=a.processor.processedTrack)||c.stop(),yield a.processor.destroy(),a.processor=void 0,b||(null==(d=a.processorElement)||d.remove(),a.processorElement=void 0),yield a._mediaStreamTrack.applyConstraints(a._constraints),yield a.setMediaStreamTrack(a._mediaStreamTrack,!0),a.emit(hG.TrackProcessorUpdate))}()})}startPreConnectBuffer(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;if(!f4)return void this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);if(this.localTrackRecorder)return void this.log.warn("preconnect buffer already started");{let a="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(a)||(a="video/mp4"),this.localTrackRecorder=new f6(this,{mimeType:a})}this.localTrackRecorder.start(a),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},1e4)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var a;return null==(a=this.localTrackRecorder)?void 0:a.byteStream}getPreConnectBufferMimeType(){var a;return null==(a=this.localTrackRecorder)?void 0:a.mimeType}}class f8 extends f7{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(a,b){let c=!(arguments.length>2)||void 0===arguments[2]||arguments[2],d=arguments.length>3?arguments[3]:void 0,e=arguments.length>4?arguments[4]:void 0;super(a,eM.Kind.Audio,b,c,e),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>di(this,void 0,void 0,function*(){let a;if(!this.sender){this._currentBitrate=0;return}try{a=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}a&&this.prevStats&&(this._currentBitrate=f3(a,this.prevStats)),this.prevStats=a}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(hG.AudioTrackFeatureUpdate,this,bg.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(hG.AudioTrackFeatureUpdate,this,bg.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=d,this.checkForSilence()}mute(){let a=Object.create(null,{mute:{get:()=>super.mute}});return di(this,void 0,void 0,function*(){let b=yield this.muteLock.lock();try{if(this.isMuted)return this.log.debug("Track already muted",this.logContext),this;return this.source===eM.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield a.mute.call(this),this}finally{b()}})}unmute(){let a=Object.create(null,{unmute:{get:()=>super.unmute}});return di(this,void 0,void 0,function*(){let b=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;let b=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==ff(this._constraints.deviceId);return this.source===eM.Source.Microphone&&(this.stopOnMute||"ended"===this._mediaStreamTrack.readyState||b)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield a.unmute.call(this),this}finally{b()}})}restartTrack(a){return di(this,void 0,void 0,function*(){let b;if(a){let c=eD({audio:a});"boolean"!=typeof c.audio&&(b=c.audio)}yield this.restart(b)})}restart(a){let b=Object.create(null,{restart:{get:()=>super.restart}});return di(this,void 0,void 0,function*(){let c=yield b.restart.call(this,a);return this.checkForSilence(),c})}startMonitor(){!e$()||this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},2e3))}setProcessor(a){return di(this,void 0,void 0,function*(){var b;let c=yield this.trackChangeLock.lock();try{if(!e_()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());let c={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(a.name),this.logContext),yield a.init(c),this.processor=a,this.processor.processedTrack&&(yield null==(b=this.sender)?void 0:b.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(hG.TrackProcessorUpdate,this.processor)}finally{c()}})}setAudioContext(a){this.audioContext=a}getSenderStats(){return di(this,void 0,void 0,function*(){var a;let b;if(null==(a=this.sender)?void 0:a.getStats)return(yield this.sender.getStats()).forEach(a=>{"outbound-rtp"===a.type&&(b={type:"audio",streamId:a.id,packetsSent:a.packetsSent,packetsLost:a.packetsLost,bytesSent:a.bytesSent,timestamp:a.timestamp,roundTripTime:a.roundTripTime,jitter:a.jitter})}),b})}checkForSilence(){return di(this,void 0,void 0,function*(){let a=yield eE(this);return a&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(hG.AudioSilenceDetected)),a})}}let f9=Object.values(ey),ga=Object.values(ez),gb=Object.values(eA),gc=[ey.h180,ey.h360],gd=[ez.h180,ez.h360],ge=["q","h","f"];function gf(a,b,c,d){var e,f,g;let h,i=null==d?void 0:d.videoEncoding;a&&(i=null==d?void 0:d.screenShareEncoding);let j=null==d?void 0:d.simulcast,k=null==d?void 0:d.scalabilityMode,l=null==d?void 0:d.videoCodec;if(!i&&!j&&!k||!b||!c)return[{}];i||(i=function(a,b,c,d){let e=function(a,b,c){if(a)return gb;let d=b>c?b/c:c/b;return Math.abs(d-16/9)<Math.abs(d-4/3)?f9:ga}(a,b,c),{encoding:f}=e[0],g=Math.max(b,c);for(let a=0;a<e.length;a+=1){let b=e[a];if(f=b.encoding,b.width>=g)break}if(d)switch(d){case"av1":case"h265":(f=Object.assign({},f)).maxBitrate=.7*f.maxBitrate;break;case"vp9":(f=Object.assign({},f)).maxBitrate=.85*f.maxBitrate}return f}(a,b,c,l),de.debug("using video encoding",i));let m=i.maxFramerate,n=new eu(b,c,i.maxBitrate,i.maxFramerate,i.priority);if(k&&eT(l)){let a=new gj(k),b=[];if(a.spatial>3)throw Error("unsupported scalabilityMode: ".concat(k));let c=ee();if(eY()||e_()||(null==c?void 0:c.name)==="Chrome"&&0>e5(null==c?void 0:c.version,"113")){let d="h"==a.suffix?2:3,e=((g=c)||(g=ee()),(null==g?void 0:g.name)==="Safari"&&e5(g.version,"18.3")>0||(null==g?void 0:g.os)==="iOS"&&!!(null==g?void 0:g.osVersion)&&e5(g.osVersion,"18.3")>0);for(let c=0;c<a.spatial;c+=1)b.push({rid:ge[2-c],maxBitrate:i.maxBitrate/Math.pow(d,c),maxFramerate:n.encoding.maxFramerate,scaleResolutionDownBy:e?Math.pow(2,c):void 0});b[0].scalabilityMode=k}else b.push({maxBitrate:i.maxBitrate,maxFramerate:n.encoding.maxFramerate,scalabilityMode:k});return n.encoding.priority&&(b[0].priority=n.encoding.priority,b[0].networkPriority=n.encoding.priority),de.debug("using svc encoding",{encodings:b}),b}if(!j)return[i];let o=[];if((o=a?null!=(e=gi(null==d?void 0:d.screenShareSimulcastLayers))?e:gg(a,n):null!=(f=gi(null==d?void 0:d.videoSimulcastLayers))?f:gg(a,n)).length>0){let a=o[0];o.length>1&&([,h]=o);let d=Math.max(b,c);if(d>=960&&h)return gh(b,c,[a,h,n],m);if(d>=480)return gh(b,c,[a,n],m)}return gh(b,c,[n])}function gg(a,b){if(a)return[{scaleResolutionDownBy:2,fps:b.encoding.maxFramerate}].map(a=>{var c,d;return new eu(Math.floor(b.width/a.scaleResolutionDownBy),Math.floor(b.height/a.scaleResolutionDownBy),Math.max(15e4,Math.floor(b.encoding.maxBitrate/(Math.pow(a.scaleResolutionDownBy,2)*((null!=(c=b.encoding.maxFramerate)?c:30)/(null!=(d=a.fps)?d:30))))),a.fps,b.encoding.priority)});let{width:c,height:d}=b,e=c>d?c/d:d/c;return Math.abs(e-16/9)<Math.abs(e-4/3)?gc:gd}function gh(a,b,c,d){let e=[];if(c.forEach((c,f)=>{if(f>=ge.length)return;let g=Math.min(a,b),h={rid:ge[f],scaleResolutionDownBy:Math.max(1,g/Math.min(c.width,c.height)),maxBitrate:c.encoding.maxBitrate},i=d&&c.encoding.maxFramerate?Math.min(d,c.encoding.maxFramerate):c.encoding.maxFramerate;i&&(h.maxFramerate=i);let j=eV()||0===f;c.encoding.priority&&j&&(h.priority=c.encoding.priority,h.networkPriority=c.encoding.priority),e.push(h)}),e_()&&"ios"===e3()){let a;e.forEach(b=>{a?b.maxFramerate&&b.maxFramerate>a&&(a=b.maxFramerate):a=b.maxFramerate});let b=!0;e.forEach(c=>{var d;c.maxFramerate!=a&&(b&&(b=!1,de.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),de.info('Setting framerate of encoding "'.concat(null!=(d=c.rid)?d:"",'" to ').concat(a)),c.maxFramerate=a)})}return e}function gi(a){if(a)return a.sort((a,b)=>{let{encoding:c}=a,{encoding:d}=b;return c.maxBitrate>d.maxBitrate?1:c.maxBitrate<d.maxBitrate?-1:c.maxBitrate===d.maxBitrate&&c.maxFramerate&&d.maxFramerate?c.maxFramerate>d.maxFramerate?1:-1:0})}class gj{constructor(a){const b=a.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!b)throw Error("invalid scalability mode");if(this.spatial=parseInt(b[1]),this.temporal=parseInt(b[2]),b.length>3)switch(b[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=b[3]}}toString(){var a;return"L".concat(this.spatial,"T").concat(this.temporal).concat(null!=(a=this.suffix)?a:"")}}class gk extends f7{get sender(){return this._sender}set sender(a){this._sender=a,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(a,b){let c=!(arguments.length>2)||void 0===arguments[2]||arguments[2],d=arguments.length>3?arguments[3]:void 0;super(a,eM.Kind.Video,b,c,d),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>di(this,void 0,void 0,function*(){let a;if(!this.sender){this._currentBitrate=0;return}try{a=yield this.getSenderStats()}catch(a){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}let b=new Map(a.map(a=>[a.rid,a])),c=a.some(a=>"cpu"===a.qualityLimitationReason);if(c!==this.isCpuConstrained&&(this.isCpuConstrained=c,this.isCpuConstrained&&this.emit(hG.CpuConstrained)),this.prevStats){let a=0;b.forEach((b,c)=>{var d;let e=null==(d=this.prevStats)?void 0:d.get(c);a+=f3(b,e)}),this._currentBitrate=a}this.prevStats=b}),this.senderLock=new M}get isSimulcast(){return!!this.sender&&!!(this.sender.getParameters().encodings.length>1)}startMonitor(a){var b;if(this.signalClient=a,!e$())return;let c=null==(b=this.sender)?void 0:b.getParameters();c&&(this.encodings=c.encodings),this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},2e3))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(a=>{a.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){let a=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return di(this,void 0,void 0,function*(){yield a.pauseUpstream.call(this);try{for(var b,c,d,e,f,g,h=!0,i=dj(this.simulcastCodecs.values());!(b=(g=yield i.next()).done);h=!0)e=g.value,h=!1,yield null==(f=e.sender)?void 0:f.replaceTrack(null)}catch(a){c={error:a}}finally{try{!h&&!b&&(d=i.return)&&(yield d.call(i))}finally{if(c)throw c.error}}})}resumeUpstream(){let a=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return di(this,void 0,void 0,function*(){yield a.resumeUpstream.call(this);try{for(var b,c,d,e,f,g,h=!0,i=dj(this.simulcastCodecs.values());!(b=(g=yield i.next()).done);h=!0)e=g.value,h=!1,yield null==(f=e.sender)?void 0:f.replaceTrack(e.mediaStreamTrack)}catch(a){c={error:a}}finally{try{!h&&!b&&(d=i.return)&&(yield d.call(i))}finally{if(c)throw c.error}}})}mute(){let a=Object.create(null,{mute:{get:()=>super.mute}});return di(this,void 0,void 0,function*(){let b=yield this.muteLock.lock();try{if(this.isMuted)return this.log.debug("Track already muted",this.logContext),this;return this.source!==eM.Source.Camera||this.isUserProvided||(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield a.mute.call(this),this}finally{b()}})}unmute(){let a=Object.create(null,{unmute:{get:()=>super.unmute}});return di(this,void 0,void 0,function*(){let b=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;return this.source!==eM.Source.Camera||this.isUserProvided||(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield a.unmute.call(this),this}finally{b()}})}setTrackMuted(a){for(let b of(super.setTrackMuted(a),this.simulcastCodecs.values()))b.mediaStreamTrack.enabled=!a}getSenderStats(){return di(this,void 0,void 0,function*(){var a;if(!(null==(a=this.sender)?void 0:a.getStats))return[];let b=[],c=yield this.sender.getStats();return c.forEach(a=>{var d;if("outbound-rtp"===a.type){let e={type:"video",streamId:a.id,frameHeight:a.frameHeight,frameWidth:a.frameWidth,framesPerSecond:a.framesPerSecond,framesSent:a.framesSent,firCount:a.firCount,pliCount:a.pliCount,nackCount:a.nackCount,packetsSent:a.packetsSent,bytesSent:a.bytesSent,qualityLimitationReason:a.qualityLimitationReason,qualityLimitationDurations:a.qualityLimitationDurations,qualityLimitationResolutionChanges:a.qualityLimitationResolutionChanges,rid:null!=(d=a.rid)?d:a.id,retransmittedPacketsSent:a.retransmittedPacketsSent,targetBitrate:a.targetBitrate,timestamp:a.timestamp},f=c.get(a.remoteId);f&&(e.jitter=f.jitter,e.packetsLost=f.packetsLost,e.roundTripTime=f.roundTripTime),b.push(e)}}),b.sort((a,b)=>{var c,d;return(null!=(c=b.frameWidth)?c:0)-(null!=(d=a.frameWidth)?d:0)}),b})}setPublishingQuality(a){let b=[];for(let c=hJ.LOW;c<=hJ.HIGH;c+=1)b.push(new cO({quality:c,enabled:c<=a}));this.log.debug("setting publishing quality. max quality ".concat(a),this.logContext),this.setPublishingLayers(eT(this.codec),b)}restartTrack(a){return di(this,void 0,void 0,function*(){let b;if(a){let c=eD({video:a});"boolean"!=typeof c.video&&(b=c.video)}yield this.restart(b),this.isCpuConstrained=!1;try{for(var c,d,e,f,g,h,i=!0,j=dj(this.simulcastCodecs.values());!(c=(h=yield j.next()).done);i=!0)f=h.value,i=!1,f.sender&&(null==(g=f.sender.transport)?void 0:g.state)!=="closed"&&(f.mediaStreamTrack=this.mediaStreamTrack.clone(),yield f.sender.replaceTrack(f.mediaStreamTrack))}catch(a){d={error:a}}finally{try{!i&&!c&&(e=j.return)&&(yield e.call(j))}finally{if(d)throw d.error}}})}setProcessor(a){let b=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return di(this,arguments,void 0,function(a){var c=this;let d=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return function*(){if(yield b.setProcessor.call(c,a,d),null==(i=c.processor)?void 0:i.processedTrack)try{for(var e,f,g,h,i,j,k,l=!0,m=dj(c.simulcastCodecs.values());!(e=(k=yield m.next()).done);l=!0)h=k.value,l=!1,yield null==(j=h.sender)?void 0:j.replaceTrack(c.processor.processedTrack)}catch(a){f={error:a}}finally{try{!l&&!e&&(g=m.return)&&(yield g.call(m))}finally{if(f)throw f.error}}}()})}setDegradationPreference(a){return di(this,void 0,void 0,function*(){if(this.degradationPreference=a,this.sender)try{this.log.debug("setting degradationPreference to ".concat(a),this.logContext);let b=this.sender.getParameters();b.degradationPreference=a,this.sender.setParameters(b)}catch(a){this.log.warn("failed to set degradationPreference",Object.assign({error:a},this.logContext))}})}addSimulcastTrack(a,b){if(this.simulcastCodecs.has(a))return void this.log.error("".concat(a," already added, skipping adding simulcast codec"),this.logContext);let c={codec:a,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:b};return this.simulcastCodecs.set(a,c),c}setSimulcastTrackSender(a,b){let c=this.simulcastCodecs.get(a);c&&(c.sender=b,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},5e3))}setPublishingCodecs(a){return di(this,void 0,void 0,function*(){var b,c,d,e,f,g,h;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:a,currentCodec:this.codec})),!this.codec&&a.length>0)return yield this.setPublishingLayers(eT(a[0].codec),a[0].qualities),[];this.subscribedCodecs=a;let i=[];try{for(b=!0,c=dj(a);!(e=(d=yield c.next()).done);b=!0)if(h=d.value,b=!1,this.codec&&this.codec!==h.codec){let a=this.simulcastCodecs.get(h.codec);if(this.log.debug("try setPublishingCodec for ".concat(h.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:a})),a&&a.sender)a.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(h.codec),this.logContext),yield gl(a.sender,a.encodings,h.qualities,this.senderLock,eT(h.codec),this.log,this.logContext));else for(let a of h.qualities)if(a.enabled){i.push(h.codec);break}}else yield this.setPublishingLayers(eT(h.codec),h.qualities)}catch(a){f={error:a}}finally{try{!b&&!e&&(g=c.return)&&(yield g.call(c))}finally{if(f)throw f.error}}return i})}setPublishingLayers(a,b){return di(this,void 0,void 0,function*(){this.optimizeForPerformance?this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:b})):(this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:b})),this.sender&&this.encodings&&(yield gl(this.sender,this.encodings,b,this.senderLock,a,this.log,this.logContext)))})}prioritizePerformance(){return di(this,void 0,void 0,function*(){if(!this.sender)throw Error("sender not found");let a=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;let a=this.sender.getParameters();a.encodings=a.encodings.map((a,b)=>{var c;return Object.assign(Object.assign({},a),{active:0===b,scaleResolutionDownBy:Math.max(1,Math.ceil((null!=(c=this.mediaStreamTrack.getSettings().height)?c:360)/360)),scalabilityMode:0===b&&eT(this.codec)?"L1T3":void 0,maxFramerate:15*(0===b),maxBitrate:0===b?a.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:a.encodings})),this.encodings=a.encodings,yield this.sender.setParameters(a)}catch(a){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:a})),this.optimizeForPerformance=!1}finally{a()}})}handleAppVisibilityChanged(){let a=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return di(this,void 0,void 0,function*(){yield a.handleAppVisibilityChanged.call(this),eZ()&&this.isInBackground&&this.source===eM.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function gl(a,b,c,d,e,f,g){return di(this,void 0,void 0,function*(){let h=yield d.lock();f.debug("setPublishingLayersForSender",Object.assign(Object.assign({},g),{sender:a,qualities:c,senderEncodings:b}));try{let d=a.getParameters(),{encodings:h}=d;if(!h)return;if(h.length!==b.length)return void f.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},g),{encodings:h,senderEncodings:b}));let i=!1;e&&c.some(a=>a.enabled)&&c.forEach(a=>a.enabled=!0),h.forEach((a,d)=>{var e;let h=null!=(e=a.rid)?e:"";""===h&&(h="q");let j=gm(h),k=c.find(a=>a.quality===j);k&&a.active!==k.enabled&&(i=!0,a.active=k.enabled,f.debug("setting layer ".concat(k.quality," to ").concat(a.active?"enabled":"disabled"),g),eV()&&(k.enabled?(a.scaleResolutionDownBy=b[d].scaleResolutionDownBy,a.maxBitrate=b[d].maxBitrate,a.maxFrameRate=b[d].maxFrameRate):(a.scaleResolutionDownBy=4,a.maxBitrate=10,a.maxFrameRate=2)))}),i&&(d.encodings=h,f.debug("setting encodings",Object.assign(Object.assign({},g),{encodings:d.encodings})),yield a.setParameters(d))}finally{h()}})}function gm(a){switch(a){case"f":default:return hJ.HIGH;case"h":return hJ.MEDIUM;case"q":return hJ.LOW}}function gn(a,b,c,d){if(!c)return[new br({quality:hJ.HIGH,width:a,height:b,bitrate:0,ssrc:0})];if(d){let d=new gj(c[0].scalabilityMode),e=[],f="h"==d.suffix?1.5:2,g="h"==d.suffix?2:3;for(let h=0;h<d.spatial;h+=1)e.push(new br({quality:Math.min(hJ.HIGH,d.spatial-1)-h,width:Math.ceil(a/Math.pow(f,h)),height:Math.ceil(b/Math.pow(f,h)),bitrate:c[0].maxBitrate?Math.ceil(c[0].maxBitrate/Math.pow(g,h)):0,ssrc:0}));return e}return c.map(c=>{var d,e,f;let g=null!=(d=c.scaleResolutionDownBy)?d:1;return new br({quality:gm(null!=(e=c.rid)?e:""),width:Math.ceil(a/g),height:Math.ceil(b/g),bitrate:null!=(f=c.maxBitrate)?f:0,ssrc:0})})}let go="_lossy",gp="_reliable",gq="leave-reconnect";(hl=hX||(hX={}))[hl.New=0]="New",hl[hl.Connected=1]="Connected",hl[hl.Disconnected=2]="Disconnected",hl[hl.Reconnecting=3]="Reconnecting",hl[hl.Closed=4]="Closed";class gr extends dl.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(a){var b;super(),this.options=a,this.rtcConfig={},this.peerConnectionTimeout=fZ.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=hX.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=de,this.reliableDataSequence=1,this.reliableMessageBuffer=new fG,this.reliableReceivedState=new fH(3e4),this.lossyDataStatCurrentBytes=0,this.lossyDataStatByterate=0,this.lossyDataDropCount=0,this.midToTrackId={},this.isWaitingForNetworkReconnect=!1,this.handleDataChannel=a=>di(this,[a],void 0,function(a){var b=this;let{channel:c}=a;return function*(){if(c){if(c.label===gp)b.reliableDCSub=c;else{if(c.label!==go)return;b.lossyDCSub=c}b.log.debug("on data channel ".concat(c.id,", ").concat(c.label),b.logContext),c.onmessage=b.handleDataMessage}}()}),this.handleDataMessage=a=>di(this,void 0,void 0,function*(){var b,c,d,e,f;let g=yield this.dataProcessLock.lock();try{let g;if(a.data instanceof ArrayBuffer)g=a.data;else{if(!(a.data instanceof Blob))return void this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:a.data}));g=yield a.data.arrayBuffer()}let h=bt.fromBinary(new Uint8Array(g));if(h.sequence>0&&""!==h.participantSid){let a=this.reliableReceivedState.get(h.participantSid);if(a&&h.sequence<=a)return;this.reliableReceivedState.set(h.participantSid,h.sequence)}if((null==(b=h.value)?void 0:b.case)==="speaker")this.emit(hF.ActiveSpeakersUpdate,h.value.value.speakers);else if((null==(c=h.value)?void 0:c.case)==="encryptedPacket"){if(!this.e2eeManager)return void this.log.error("Received encrypted packet but E2EE not set up",this.logContext);let a=yield null==(d=this.e2eeManager)?void 0:d.handleEncryptedData(h.value.value.encryptedValue,h.value.value.iv,h.participantIdentity,h.value.value.keyIndex),b=bw.fromBinary(a.payload),c=new bt({value:b.value,participantIdentity:h.participantIdentity,participantSid:h.participantSid});(null==(e=c.value)?void 0:e.case)==="user"&&gs(c,c.value.value),this.emit(hF.DataPacketReceived,c,h.value.value.encryptionType)}else(null==(f=h.value)?void 0:f.case)==="user"&&gs(h,h.value.value),this.emit(hF.DataPacketReceived,h,bo.NONE)}finally{g()}}),this.handleDataError=a=>{let b=0===a.currentTarget.maxRetransmits?"lossy":"reliable";if(a instanceof ErrorEvent&&a.error){let{error:c}=a.error;this.log.error("DataChannel error on ".concat(b,": ").concat(a.message),Object.assign(Object.assign({},this.logContext),{error:c}))}else this.log.error("Unknown DataChannel error on ".concat(b),Object.assign(Object.assign({},this.logContext),{event:a}))},this.handleBufferedAmountLow=a=>{let b=0===a.currentTarget.maxRetransmits?bu.LOSSY:bu.RELIABLE;this.updateAndEmitDCBufferStatus(b)},this.handleDisconnect=(a,b)=>{if(this._isClosed)return;this.log.warn("".concat(a," disconnected"),this.logContext),0===this.reconnectAttempts&&(this.reconnectStart=Date.now());let c=a=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(a,"ms. giving up"),this.logContext),this.emit(hF.Disconnected),this.close()},d=Date.now()-this.reconnectStart,e=this.getNextRetryDelay({elapsedMs:d,retryCount:this.reconnectAttempts});null===e?c(d):(a===gq&&(e=0),this.log.debug("reconnecting in ".concat(e,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=et.setTimeout(()=>this.attemptReconnect(b).finally(()=>this.reconnectTimeout=void 0),e))},this.waitForRestarted=()=>new Promise((a,b)=>{this.pcState===hX.Connected&&a();let c=()=>{this.off(hF.Disconnected,d),a()},d=()=>{this.off(hF.Restarted,c),b()};this.once(hF.Restarted,c),this.once(hF.Disconnected,d)}),this.updateAndEmitDCBufferStatus=a=>{if(a===bu.RELIABLE){let b=this.dataChannelForKind(a);b&&this.reliableMessageBuffer.alignBufferedAmount(b.bufferedAmount)}let b=this.isBufferStatusLow(a);void 0!==b&&b!==this.dcBufferStatus.get(a)&&(this.dcBufferStatus.set(a,b),this.emit(hF.DCBufferStatusChanged,b,a))},this.isBufferStatusLow=a=>{let b=this.dataChannelForKind(a);if(b)return b.bufferedAmount<=b.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>di(this,void 0,void 0,function*(){!this.url||(yield fetch(fg(this.url),{method:"HEAD"}).then(a=>a.ok).catch(()=>!1))&&(this.log.info("detected network reconnected"),(this.client.currentState===hQ.RECONNECTING||this.isWaitingForNetworkReconnect&&this.client.currentState===hQ.CONNECTED)&&(this.clearReconnectTimeout(),this.attemptReconnect(be.RR_SIGNAL_DISCONNECTED),this.isWaitingForNetworkReconnect=!1))}),this.handleBrowserOffline=()=>di(this,void 0,void 0,function*(){if(this.url)try{yield Promise.race([fetch(fg(this.url),{method:"HEAD"}),eQ(4e3).then(()=>Promise.reject())])}catch(a){!1===window.navigator.onLine&&(this.log.info("detected network interruption"),this.isWaitingForNetworkReconnect=!0)}}),this.log=df(null!=(b=a.loggerName)?b:hx.Engine),this.loggerOptions={loggerName:a.loggerName,loggerContextCb:()=>this.logContext},this.client=new fD(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new M,this.dataProcessLock=new M,this.dcBufferStatus=new Map([[bu.LOSSY,!0],[bu.RELIABLE,!0]]),this.client.onParticipantUpdate=a=>this.emit(hF.ParticipantUpdate,a),this.client.onConnectionQuality=a=>this.emit(hF.ConnectionQualityUpdate,a),this.client.onRoomUpdate=a=>this.emit(hF.RoomUpdate,a),this.client.onSubscriptionError=a=>this.emit(hF.SubscriptionError,a),this.client.onSubscriptionPermissionUpdate=a=>this.emit(hF.SubscriptionPermissionUpdate,a),this.client.onSpeakersChanged=a=>this.emit(hF.SpeakersChanged,a),this.client.onStreamStateUpdate=a=>this.emit(hF.StreamStateChanged,a),this.client.onRequestResponse=a=>this.emit(hF.SignalRequestResponse,a)}get logContext(){var a,b,c,d,e,f;return{room:null==(b=null==(a=this.latestJoinResponse)?void 0:a.room)?void 0:b.name,roomID:null==(d=null==(c=this.latestJoinResponse)?void 0:c.room)?void 0:d.sid,participant:null==(f=null==(e=this.latestJoinResponse)?void 0:e.participant)?void 0:f.identity,pID:this.participantSid}}join(a,b,c,d){return di(this,void 0,void 0,function*(){this.url=a,this.token=b,this.signalOpts=c,this.maxJoinAttempts=c.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();let e=yield this.client.join(a,b,c,d);return this._isClosed=!1,this.latestJoinResponse=e,this.subscriberPrimary=e.subscriberPrimary,this.pcManager||(yield this.configure(e)),(!this.subscriberPrimary||e.fastPublish)&&this.negotiate().catch(a=>{de.error(a,this.logContext)}),this.registerOnLineListener(),this.clientConfiguration=e.clientConfiguration,this.emit(hF.SignalConnected,e),e}catch(e){if(e instanceof ej&&e.reason===hA.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(a,b,c,d);throw e}})}close(){return di(this,void 0,void 0,function*(){let a=yield this.closingLock.lock();if(this.isClosed)return void a();try{this._isClosed=!0,this.joinAttempts=0,this.emit(hF.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),this.cleanupLossyDataStats(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{a()}})}cleanupPeerConnections(){return di(this,void 0,void 0,function*(){var a;yield null==(a=this.pcManager)?void 0:a.close(),this.pcManager=void 0;let b=a=>{a&&(a.close(),a.onbufferedamountlow=null,a.onclose=null,a.onclosing=null,a.onerror=null,a.onmessage=null,a.onopen=null)};b(this.lossyDC),b(this.lossyDCSub),b(this.reliableDC),b(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new fG,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupLossyDataStats(){this.lossyDataStatByterate=0,this.lossyDataStatCurrentBytes=0,this.lossyDataStatInterval&&(clearInterval(this.lossyDataStatInterval),this.lossyDataStatInterval=void 0),this.lossyDataDropCount=0}cleanupClient(){return di(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(a){if(this.pendingTrackResolvers[a.cid])throw new el("a track with the same ID has already been published");return new Promise((b,c)=>{let d=setTimeout(()=>{delete this.pendingTrackResolvers[a.cid],c(ej.timeout("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[a.cid]={resolve:a=>{clearTimeout(d),b(a)},reject:()=>{clearTimeout(d),c(Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(a)})}removeTrack(a){if(a.track&&this.pendingTrackResolvers[a.track.id]){let{reject:b}=this.pendingTrackResolvers[a.track.id];b&&b(),delete this.pendingTrackResolvers[a.track.id]}try{return this.pcManager.removeTrack(a),!0}catch(a){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:a}))}return!1}updateMuteStatus(a,b){this.client.sendMuteTrack(a,b)}get dataSubscriberReadyState(){var a;return null==(a=this.reliableDCSub)?void 0:a.readyState}getConnectedServerAddress(){return di(this,void 0,void 0,function*(){var a;return null==(a=this.pcManager)?void 0:a.getConnectedAddress()})}setRegionUrlProvider(a){this.regionUrlProvider=a}configure(a){return di(this,void 0,void 0,function*(){var b,c,d;if(this.pcManager&&this.pcManager.currentState!==hW.NEW)return;this.participantSid=null==(b=a.participant)?void 0:b.sid;let e=this.makeRTCConfiguration(a);this.pcManager=new f$(e,this.options.singlePeerConnection?"publisher-only":a.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(hF.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(a,b)=>{this.client.sendIceCandidate(a,b)},this.pcManager.onPublisherOffer=(a,b)=>{this.client.sendOffer(a,b)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(b,c,d)=>di(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(b),this.logContext),["closed","disconnected","failed"].includes(c)&&(this.publisherConnectionPromise=void 0),b===hW.CONNECTED){let b=this.pcState===hX.New;this.pcState=hX.Connected,b&&this.emit(hF.Connected,a)}else b===hW.FAILED&&(this.pcState===hX.Connected||this.pcState===hX.Reconnecting)&&(this.pcState=hX.Disconnected,this.handleDisconnect("peerconnection failed","failed"===d?be.RR_SUBSCRIBER_FAILED:be.RR_PUBLISHER_FAILED));let e=this.client.isDisconnected||this.client.currentState===hQ.RECONNECTING,f=[hW.FAILED,hW.CLOSING,hW.CLOSED].includes(b);e&&f&&!this._isClosed&&this.emit(hF.Offline)}),this.pcManager.onTrack=a=>{0!==a.streams.length&&this.emit(hF.MediaTrackAdded,a.track,a.streams[0],a.receiver)},void 0!==(d=null==(c=a.serverInfo)?void 0:c.protocol)&&d>13||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(a,b,c)=>di(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:a.type,sdp:a.sdp,midToTrackId:c})),this.midToTrackId=c,yield this.pcManager.setPublisherAnswer(a,b))}),this.client.onTrickle=(a,b)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:a,target:b})),this.pcManager.addIceCandidate(a,b))},this.client.onOffer=(a,b,c)=>di(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=b,!this.pcManager)return;this.midToTrackId=c;let d=yield this.pcManager.createSubscriberAnswerFromOffer(a,b);d&&this.client.sendAnswer(d,b)}),this.client.onLocalTrackPublished=a=>{var b;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:a.cid,track:null==(b=a.track)?void 0:b.sid})),!this.pendingTrackResolvers[a.cid])return void this.log.error("missing track resolver for ".concat(a.cid),Object.assign(Object.assign({},this.logContext),{cid:a.cid}));let{resolve:c}=this.pendingTrackResolvers[a.cid];delete this.pendingTrackResolvers[a.cid],c(a.track)},this.client.onLocalTrackUnpublished=a=>{this.emit(hF.LocalTrackUnpublished,a)},this.client.onLocalTrackSubscribed=a=>{this.emit(hF.LocalTrackSubscribed,a)},this.client.onTokenRefresh=a=>{var b;this.token=a,null==(b=this.regionUrlProvider)||b.updateToken(a)},this.client.onRemoteMuteChanged=(a,b)=>{this.emit(hF.RemoteMute,a,b)},this.client.onSubscribedQualityUpdate=a=>{this.emit(hF.SubscribedQualityUpdate,a)},this.client.onRoomMoved=a=>{var b;this.participantSid=null==(b=a.participant)?void 0:b.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=a.room),this.emit(hF.RoomMoved,a)},this.client.onMediaSectionsRequirement=a=>{var b,c;let d={direction:"recvonly"};for(let c=0;c<a.numAudios;c++)null==(b=this.pcManager)||b.addPublisherTransceiverOfKind("audio",d);for(let b=0;b<a.numVideos;b++)null==(c=this.pcManager)||c.addPublisherTransceiverOfKind("video",d);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",be.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=a=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:null==a?void 0:a.reason})),a.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions({updatedAtInMs:Date.now(),maxAgeInMs:5e3,regionSettings:a.regions})),a.action){case cE.DISCONNECT:this.emit(hF.Disconnected,null==a?void 0:a.reason),this.close();break;case cE.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(gq);break;case cE.RESUME:this.handleDisconnect(gq)}}}makeRTCConfiguration(a){var b;let c=Object.assign({},this.rtcConfig);if((null==(b=this.signalOpts)?void 0:b.e2eeEnabled)&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),c.encodedInsertableStreams=!0),a.iceServers&&!c.iceServers){let b=[];a.iceServers.forEach(a=>{let c={urls:a.urls};a.username&&(c.username=a.username),a.credential&&(c.credential=a.credential),b.push(c)}),c.iceServers=b}return a.clientConfiguration&&a.clientConfiguration.forceRelay===bc.ENABLED&&(c.iceTransportPolicy="relay"),c.sdpSemantics="unified-plan",c.continualGatheringPolicy="gather_continually",c}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(go,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(gp,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow,this.cleanupLossyDataStats(),this.lossyDataStatInterval=setInterval(()=>{this.lossyDataStatByterate=this.lossyDataStatCurrentBytes,this.lossyDataStatCurrentBytes=0;let a=this.dataChannelForKind(bu.LOSSY);a&&(a.bufferedAmountLowThreshold=Math.min(Math.max(this.lossyDataStatByterate/10,8192),262144))},1e3))}createSender(a,b,c){return di(this,void 0,void 0,function*(){if(eR())return yield this.createTransceiverRTCRtpSender(a,b,c);if(eS())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(a.mediaStreamTrack);throw new en("Required webRTC APIs not supported on this device")})}createSimulcastSender(a,b,c,d){return di(this,void 0,void 0,function*(){if(eR())return this.createSimulcastTransceiverSender(a,b,c,d);if(eS())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(a.mediaStreamTrack);throw new en("Cannot stream on this device")})}createTransceiverRTCRtpSender(a,b,c){return di(this,void 0,void 0,function*(){if(!this.pcManager)throw new en("publisher is closed");let d=[];a.mediaStream&&d.push(a.mediaStream),fm(a)&&(a.codec=b.videoCodec);let e={direction:"sendonly",streams:d};return c&&(e.sendEncodings=c),(yield this.pcManager.addPublisherTransceiver(a.mediaStreamTrack,e)).sender})}createSimulcastTransceiverSender(a,b,c,d){return di(this,void 0,void 0,function*(){if(!this.pcManager)throw new en("publisher is closed");let e={direction:"sendonly"};d&&(e.sendEncodings=d);let f=yield this.pcManager.addPublisherTransceiver(b.mediaStreamTrack,e);if(c.videoCodec)return a.setSimulcastTrackSender(c.videoCodec,f.sender),f.sender})}createRTCRtpSender(a){return di(this,void 0,void 0,function*(){if(!this.pcManager)throw new en("publisher is closed");return this.pcManager.addPublisherTrack(a)})}attemptReconnect(a){return di(this,void 0,void 0,function*(){var b,c,d;if(!this._isClosed){if(this.attemptingReconnect)return void de.warn("already attempting reconnect, returning early",this.logContext);((null==(b=this.clientConfiguration)?void 0:b.resumeConnection)===bc.DISABLED||(null!=(d=null==(c=this.pcManager)?void 0:c.currentState)?d:hW.NEW)===hW.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(a),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(b){this.reconnectAttempts+=1;let a=!0;b instanceof en?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:b})),a=!1):b instanceof es||(this.fullReconnectOnNext=!0),a?this.handleDisconnect("reconnect",be.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(hF.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(a){try{return this.reconnectPolicy.nextRetryDelayInMs(a)}catch(a){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:a}))}return null}restartConnection(a){return di(this,void 0,void 0,function*(){var b,c,d;try{let c;if(!this.url||!this.token)throw new en("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(hF.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new es;c=yield this.join(null!=a?a:this.url,this.token,this.signalOpts)}catch(a){if(a instanceof ej&&a.reason===hA.NotAllowed)throw new en("could not reconnect, token might be expired");throw new es}if(this.shouldFailNext)throw this.shouldFailNext=!1,Error("simulated failure");if(this.client.setReconnected(),this.emit(hF.SignalRestarted,c),yield this.waitForPCReconnected(),this.client.currentState!==hQ.CONNECTED)throw new es("Signal connection got severed during reconnect");null==(b=this.regionUrlProvider)||b.resetAttempts(),this.emit(hF.Restarted)}catch(b){let a=yield null==(c=this.regionUrlProvider)?void 0:c.getNextBestRegionUrl();if(a)return void(yield this.restartConnection(a));throw null==(d=this.regionUrlProvider)||d.resetAttempts(),b}})}resumeConnection(a){return di(this,void 0,void 0,function*(){var b;let c;if(!this.url||!this.token)throw new en("could not reconnect, url or token not saved");if(!this.pcManager)throw new en("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(hF.Resuming);try{this.setupSignalClientCallbacks(),c=yield this.client.reconnect(this.url,this.token,this.participantSid,a)}catch(b){let a="";if(b instanceof Error&&(a=b.message,this.log.error(b.message,Object.assign(Object.assign({},this.logContext),{error:b}))),b instanceof ej&&b.reason===hA.NotAllowed)throw new en("could not reconnect, token might be expired");if(b instanceof ej&&b.reason===hA.LeaveRequest)throw b;throw new es(a)}if(this.emit(hF.SignalResumed),c){let a=this.makeRTCConfiguration(c);this.pcManager.updateConfiguration(a),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=c.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==hQ.CONNECTED)throw new es("Signal connection got severed during reconnect");this.client.setReconnected(),(null==(b=this.reliableDC)?void 0:b.readyState)==="open"&&null===this.reliableDC.id&&this.createDataChannels(),(null==c?void 0:c.lastMessageSeq)&&this.resendReliableMessagesForResume(c.lastMessageSeq),this.emit(hF.Resumed)})}waitForPCInitialConnection(a,b){return di(this,void 0,void 0,function*(){if(!this.pcManager)throw new en("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(b,a)})}waitForPCReconnected(){return di(this,void 0,void 0,function*(){this.pcState=hX.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield eQ(2e3),!this.pcManager)throw new en("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=hX.Connected}catch(a){throw this.pcState=hX.Disconnected,ej.internal("could not establish PC connection, ".concat(a.message))}})}publishRpcResponse(a,b,c,d){return di(this,void 0,void 0,function*(){let e=new bt({destinationIdentities:[a],kind:bu.RELIABLE,value:{case:"rpcResponse",value:new bG({requestId:b,value:d?{case:"error",value:d.toProto()}:{case:"payload",value:null!=c?c:""}})}});yield this.sendDataPacket(e,bu.RELIABLE)})}publishRpcAck(a,b){return di(this,void 0,void 0,function*(){let c=new bt({destinationIdentities:[a],kind:bu.RELIABLE,value:{case:"rpcAck",value:new bF({requestId:b})}});yield this.sendDataPacket(c,bu.RELIABLE)})}sendDataPacket(a,b){return di(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(b),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){let b=function(a){var b,c,d,e,f;if((null==(b=a.value)?void 0:b.case)!=="sipDtmf"&&(null==(c=a.value)?void 0:c.case)!=="metrics"&&(null==(d=a.value)?void 0:d.case)!=="speaker"&&(null==(e=a.value)?void 0:e.case)!=="transcription"&&(null==(f=a.value)?void 0:f.case)!=="encryptedPacket")return new bw({value:a.value})}(a);if(b){let c=yield this.e2eeManager.encryptData(b.toBinary());a.value={case:"encryptedPacket",value:new bv({encryptedValue:c.payload,iv:c.iv,keyIndex:c.keyIndex})}}}b===bu.RELIABLE&&(a.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);let c=a.toBinary(),d=this.dataChannelForKind(b);if(d){if(b===bu.RELIABLE)yield this.waitForBufferStatusLow(b),this.reliableMessageBuffer.push({data:c,sequence:a.sequence});else{if(!this.isBufferStatusLow(b)){this.lossyDataDropCount+=1,this.lossyDataDropCount%100==0&&this.log.warn("dropping lossy data channel messages, total dropped: ".concat(this.lossyDataDropCount),this.logContext);return}this.lossyDataStatCurrentBytes+=c.byteLength}if(this.attemptingReconnect)return;d.send(c)}this.updateAndEmitDCBufferStatus(b)})}resendReliableMessagesForResume(a){return di(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(bu.RELIABLE);let b=this.dataChannelForKind(bu.RELIABLE);b&&(this.reliableMessageBuffer.popToSequence(a),this.reliableMessageBuffer.getAll().forEach(a=>{b.send(a.data)})),this.updateAndEmitDCBufferStatus(bu.RELIABLE)})}waitForBufferStatusLow(a){return new Promise((b,c)=>di(this,void 0,void 0,function*(){if(this.isBufferStatusLow(a))b();else{let d=()=>c("Engine closed");for(this.once(hF.Closing,d);!this.dcBufferStatus.get(a);)yield eQ(10);this.off(hF.Closing,d),b()}}))}ensureDataTransportConnected(a){return di(this,arguments,void 0,function(a){var b=this;let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscriberPrimary;return function*(){var d;if(!b.pcManager)throw new en("PC manager is closed");let e=c?b.pcManager.subscriber:b.pcManager.publisher,f=c?"Subscriber":"Publisher";if(!e)throw ej.internal("".concat(f," connection not set"));let g=!1;c||b.dataChannelForKind(a,c)||(b.createDataChannels(),g=!0),g||c||b.pcManager.publisher.isICEConnected||"checking"===b.pcManager.publisher.getICEConnectionState()||(g=!0),g&&b.negotiate().catch(a=>{de.error(a,b.logContext)});let h=b.dataChannelForKind(a,c);if((null==h?void 0:h.readyState)==="open")return;let i=new Date().getTime()+b.peerConnectionTimeout;for(;new Date().getTime()<i;){if(e.isICEConnected&&(null==(d=b.dataChannelForKind(a,c))?void 0:d.readyState)==="open")return;yield eQ(50)}throw ej.internal("could not establish ".concat(f," connection, state: ").concat(e.getICEConnectionState()))}()})}ensurePublisherConnected(a){return di(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(a,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!!this.pcManager&&this.pcManager.currentState===hW.CONNECTED&&!!this.client.ws&&this.client.ws.readyState!==WebSocket.CLOSED}negotiate(){return di(this,void 0,void 0,function*(){return new Promise((a,b)=>di(this,void 0,void 0,function*(){if(!this.pcManager)return void b(new eo("PC manager is closed"));this.pcManager.requirePublisher(),0!=this.pcManager.publisher.getTransceivers().length||this.lossyDC||this.reliableDC||this.createDataChannels();let c=new AbortController,d=()=>{c.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),a()};this.isClosed&&b("cannot negotiate on closed engine"),this.on(hF.Closing,d),this.pcManager.publisher.once(fQ,a=>{let b=new Map;a.forEach(a=>{let c=a.codec.toLowerCase();ew.includes(c)&&b.set(a.payload,c)}),this.emit(hF.RTPVideoMapUpdate,b)});try{yield this.pcManager.negotiate(c),a()}catch(a){a instanceof eo&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",be.RR_UNKNOWN),b(a)}finally{this.off(hF.Closing,d)}}))})}dataChannelForKind(a,b){if(b){if(a===bu.LOSSY)return this.lossyDCSub;if(a===bu.RELIABLE)return this.reliableDCSub}else{if(a===bu.LOSSY)return this.lossyDC;if(a===bu.RELIABLE)return this.reliableDC}}sendSyncState(a,b){var c,d,e,f;let g;if(!this.pcManager)return void this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);let h=this.pcManager.publisher.getLocalDescription(),i=this.pcManager.publisher.getRemoteDescription(),j=null==(c=this.pcManager.subscriber)?void 0:c.getRemoteDescription(),k=null==(d=this.pcManager.subscriber)?void 0:d.getLocalDescription(),l=null==(f=null==(e=this.signalOpts)?void 0:e.autoSubscribe)||f,m=[],n=[];a.forEach(a=>{a.isDesired!==l&&m.push(a.trackSid),a.isEnabled||n.push(a.trackSid)}),this.client.sendSyncState(new cW({answer:this.options.singlePeerConnection?i?fF({sdp:i.sdp,type:i.type}):void 0:k?fF({sdp:k.sdp,type:k.type}):void 0,offer:this.options.singlePeerConnection?h?fF({sdp:h.sdp,type:h.type}):void 0:j?fF({sdp:j.sdp,type:j.type}):void 0,subscription:new cz({trackSids:m,subscribe:!l,participantTracks:[]}),publishTracks:(g=[],b.forEach(a=>{void 0!==a.track&&g.push(new cv({cid:a.track.mediaStreamID,track:a.trackInfo}))}),g),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:n,datachannelReceiveStates:this.reliableReceivedState.map((a,b)=>new cX({publisherSid:b,lastSeq:a}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){let a=[],b=(b,c)=>{(null==b?void 0:b.id)!==void 0&&null!==b.id&&a.push(new cY({label:b.label,id:b.id,target:c}))};return b(this.dataChannelForKind(bu.LOSSY),ck.PUBLISHER),b(this.dataChannelForKind(bu.RELIABLE),ck.PUBLISHER),b(this.dataChannelForKind(bu.LOSSY,!0),ck.SUBSCRIBER),b(this.dataChannelForKind(bu.RELIABLE,!0),ck.SUBSCRIBER),a}clearReconnectTimeout(){this.reconnectTimeout&&et.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){e$()&&(window.addEventListener("online",this.handleBrowserOnLine),window.addEventListener("offline",this.handleBrowserOffline))}deregisterOnLineListener(){e$()&&(window.removeEventListener("online",this.handleBrowserOnLine),window.removeEventListener("offline",this.handleBrowserOffline))}getTrackIdForReceiver(a){var b;let c=null==(b=this.pcManager)?void 0:b.getMidForReceiver(a);if(c){let a=Object.entries(this.midToTrackId).find(a=>{let[b]=a;return b===c});if(a)return a[1]}}}function gs(a,b){let c=a.participantIdentity?a.participantIdentity:b.participantIdentity;a.participantIdentity=c,b.participantIdentity=c;let d=0!==a.destinationIdentities.length?a.destinationIdentities:b.destinationIdentities;a.destinationIdentities=d,b.destinationIdentities=d}class gt{get info(){return this._info}validateBytesReceived(){let a=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if("number"==typeof this.totalByteSize&&0!==this.totalByteSize){if(a&&this.bytesReceived<this.totalByteSize)throw new er("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),hB.Incomplete);else if(this.bytesReceived>this.totalByteSize)throw new er("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),hB.LengthExceeded)}}constructor(a,b,c,d){this.reader=b,this.totalByteSize=c,this._info=a,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=d}}class gu extends gt{handleChunkReceived(a){var b;this.bytesReceived+=a.content.byteLength,this.validateBytesReceived();let c=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null==(b=this.onProgress)||b.call(this,c)}[Symbol.asyncIterator](){let a=this.reader.getReader(),b=new fe,c=null,d=null;if(this.signal){let a=this.signal;d=()=>{var c;null==(c=b.reject)||c.call(b,a.reason)},a.addEventListener("abort",d),c=a}let e=()=>{a.releaseLock(),c&&d&&c.removeEventListener("abort",d),this.signal=void 0};return{next:()=>di(this,void 0,void 0,function*(){var c,d;try{let{done:e,value:f}=yield Promise.race([a.read(),b.promise,null!=(d=null==(c=this.outOfBandFailureRejectingFuture)?void 0:c.promise)?d:new Promise(()=>{})]);if(e)return this.validateBytesReceived(!0),{done:!0,value:void 0};return this.handleChunkReceived(f),{done:!1,value:f.content}}catch(a){throw e(),a}}),return(){return di(this,void 0,void 0,function*(){return e(),{done:!0,value:void 0}})}}}withAbortSignal(a){return this.signal=a,this}readAll(){return di(this,arguments,void 0,function(){var a=this;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var c,d,e,f;let g=new Set,h=b.signal?a.withAbortSignal(b.signal):a;try{for(var i,j=!0,k=dj(h);!(c=(i=yield k.next()).done);j=!0)f=i.value,j=!1,g.add(f)}catch(a){d={error:a}}finally{try{!j&&!c&&(e=k.return)&&(yield e.call(k))}finally{if(d)throw d.error}}return Array.from(g)}()})}}class gv extends gt{constructor(a,b,c,d){super(a,b,c,d),this.receivedChunks=new Map}handleChunkReceived(a){var b;let c=fi(a.chunkIndex),d=this.receivedChunks.get(c);if(d&&d.version>a.version)return;this.receivedChunks.set(c,a),this.bytesReceived+=a.content.byteLength,this.validateBytesReceived();let e=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null==(b=this.onProgress)||b.call(this,e)}[Symbol.asyncIterator](){let a=this.reader.getReader(),b=new TextDecoder("utf-8",{fatal:!0}),c=new fe,d=null,e=null;if(this.signal){let a=this.signal;e=()=>{var b;null==(b=c.reject)||b.call(c,a.reason)},a.addEventListener("abort",e),d=a}let f=()=>{a.releaseLock(),d&&e&&d.removeEventListener("abort",e),this.signal=void 0};return{next:()=>di(this,void 0,void 0,function*(){var d,e;try{let{done:f,value:g}=yield Promise.race([a.read(),c.promise,null!=(e=null==(d=this.outOfBandFailureRejectingFuture)?void 0:d.promise)?e:new Promise(()=>{})]);if(f)return this.validateBytesReceived(!0),{done:!0,value:void 0};{let a;this.handleChunkReceived(g);try{a=b.decode(g.content)}catch(a){throw new er("Cannot decode datastream chunk ".concat(g.chunkIndex," as text: ").concat(a),hB.DecodeFailed)}return{done:!1,value:a}}}catch(a){throw f(),a}}),return(){return di(this,void 0,void 0,function*(){return f(),{done:!0,value:void 0}})}}}withAbortSignal(a){return this.signal=a,this}readAll(){return di(this,arguments,void 0,function(){var a=this;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var c,d,e,f;let g="",h=b.signal?a.withAbortSignal(b.signal):a;try{for(var i,j=!0,k=dj(h);!(c=(i=yield k.next()).done);j=!0)f=i.value,j=!1,g+=f}catch(a){d={error:a}}finally{try{!j&&!c&&(e=k.return)&&(yield e.call(k))}finally{if(d)throw d.error}}return g}()})}}class gw{constructor(){this.log=de,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(a,b){if(this.textStreamHandlers.has(a))throw new er('A text stream handler for topic "'.concat(a,'" has already been set.'),hB.HandlerAlreadyRegistered);this.textStreamHandlers.set(a,b)}unregisterTextStreamHandler(a){this.textStreamHandlers.delete(a)}registerByteStreamHandler(a,b){if(this.byteStreamHandlers.has(a))throw new er('A byte stream handler for topic "'.concat(a,'" has already been set.'),hB.HandlerAlreadyRegistered);this.byteStreamHandlers.set(a,b)}unregisterByteStreamHandler(a){this.byteStreamHandlers.delete(a)}clearControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear()}validateParticipantHasNoActiveDataStreams(a){var b,c,d,e;let f=Array.from(this.textStreamControllers.entries()).filter(b=>b[1].sendingParticipantIdentity===a),g=Array.from(this.byteStreamControllers.entries()).filter(b=>b[1].sendingParticipantIdentity===a);if(f.length>0||g.length>0){let h=new er("Participant ".concat(a," unexpectedly disconnected in the middle of sending data"),hB.AbnormalEnd);for(let[a,d]of g)null==(c=(b=d.outOfBandFailureRejectingFuture).reject)||c.call(b,h),this.byteStreamControllers.delete(a);for(let[a,b]of f)null==(e=(d=b.outOfBandFailureRejectingFuture).reject)||e.call(d,h),this.textStreamControllers.delete(a)}}handleDataStreamPacket(a,b){return di(this,void 0,void 0,function*(){switch(a.value.case){case"streamHeader":return this.handleStreamHeader(a.value.value,a.participantIdentity,b);case"streamChunk":return this.handleStreamChunk(a.value.value,b);case"streamTrailer":return this.handleStreamTrailer(a.value.value,b);default:throw Error('DataPacket of value "'.concat(a.value.case,'" is not data stream related!'))}})}handleStreamHeader(a,b,c){return di(this,void 0,void 0,function*(){var d;if("byteHeader"===a.contentHeader.case){let e,f=this.byteStreamHandlers.get(a.topic);if(!f)return void this.log.debug("ignoring incoming byte stream due to no handler for topic",a.topic);let g=new fe;g.promise.catch(a=>{this.log.error(a)});let h={id:a.streamId,name:null!=(d=a.contentHeader.value.name)?d:"unknown",mimeType:a.mimeType,size:a.totalLength?Number(a.totalLength):void 0,topic:a.topic,timestamp:fi(a.timestamp),attributes:a.attributes,encryptionType:c},i=new ReadableStream({start:c=>{if(e=c,this.textStreamControllers.has(a.streamId))throw new er("A data stream read is already in progress for a stream with id ".concat(a.streamId,"."),hB.AlreadyOpened);this.byteStreamControllers.set(a.streamId,{info:h,controller:e,startTime:Date.now(),sendingParticipantIdentity:b,outOfBandFailureRejectingFuture:g})}});f(new gu(h,i,fi(a.totalLength),g),{identity:b})}else if("textHeader"===a.contentHeader.case){let d,e=this.textStreamHandlers.get(a.topic);if(!e)return void this.log.debug("ignoring incoming text stream due to no handler for topic",a.topic);let f=new fe;f.promise.catch(a=>{this.log.error(a)});let g={id:a.streamId,mimeType:a.mimeType,size:a.totalLength?Number(a.totalLength):void 0,topic:a.topic,timestamp:Number(a.timestamp),attributes:a.attributes,encryptionType:c},h=new ReadableStream({start:c=>{if(d=c,this.textStreamControllers.has(a.streamId))throw new er("A data stream read is already in progress for a stream with id ".concat(a.streamId,"."),hB.AlreadyOpened);this.textStreamControllers.set(a.streamId,{info:g,controller:d,startTime:Date.now(),sendingParticipantIdentity:b,outOfBandFailureRejectingFuture:f})}});e(new gv(g,h,fi(a.totalLength),f),{identity:b})}})}handleStreamChunk(a,b){let c=this.byteStreamControllers.get(a.streamId);c&&(c.info.encryptionType!==b?(c.controller.error(new er("Encryption type mismatch for stream ".concat(a.streamId,". Expected ").concat(b,", got ").concat(c.info.encryptionType),hB.EncryptionTypeMismatch)),this.byteStreamControllers.delete(a.streamId)):a.content.length>0&&c.controller.enqueue(a));let d=this.textStreamControllers.get(a.streamId);d&&(d.info.encryptionType!==b?(d.controller.error(new er("Encryption type mismatch for stream ".concat(a.streamId,". Expected ").concat(b,", got ").concat(d.info.encryptionType),hB.EncryptionTypeMismatch)),this.textStreamControllers.delete(a.streamId)):a.content.length>0&&d.controller.enqueue(a))}handleStreamTrailer(a,b){let c=this.textStreamControllers.get(a.streamId);c&&(c.info.encryptionType!==b?c.controller.error(new er("Encryption type mismatch for stream ".concat(a.streamId,". Expected ").concat(b,", got ").concat(c.info.encryptionType),hB.EncryptionTypeMismatch)):(c.info.attributes=Object.assign(Object.assign({},c.info.attributes),a.attributes),c.controller.close(),this.textStreamControllers.delete(a.streamId)));let d=this.byteStreamControllers.get(a.streamId);d&&(d.info.encryptionType!==b?d.controller.error(new er("Encryption type mismatch for stream ".concat(a.streamId,". Expected ").concat(b,", got ").concat(d.info.encryptionType),hB.EncryptionTypeMismatch)):(d.info.attributes=Object.assign(Object.assign({},d.info.attributes),a.attributes),d.controller.close()),this.byteStreamControllers.delete(a.streamId))}}class gx{constructor(a,b,c){this.writableStream=a,this.defaultWriter=a.getWriter(),this.onClose=c,this.info=b}write(a){return this.defaultWriter.write(a)}close(){return di(this,void 0,void 0,function*(){var a;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),null==(a=this.onClose)||a.call(this)})}}class gy extends gx{}class gz extends gx{}class gA{constructor(a,b){this.engine=a,this.log=b}setupEngine(a){this.engine=a}sendText(a,b){return di(this,void 0,void 0,function*(){var c;let d=crypto.randomUUID(),e=new TextEncoder().encode(a).byteLength,f=null==(c=null==b?void 0:b.attachments)?void 0:c.map(()=>crypto.randomUUID()),g=Array(f?f.length+1:1).fill(0),h=(a,c)=>{var d;g[c]=a;let e=g.reduce((a,b)=>a+b,0);null==(d=null==b?void 0:b.onProgress)||d.call(b,e)},i=yield this.streamText({streamId:d,totalSize:e,destinationIdentities:null==b?void 0:b.destinationIdentities,topic:null==b?void 0:b.topic,attachedStreamIds:f,attributes:null==b?void 0:b.attributes});return yield i.write(a),h(1,0),yield i.close(),(null==b?void 0:b.attachments)&&f&&(yield Promise.all(b.attachments.map((a,c)=>di(this,void 0,void 0,function*(){return this._sendFile(f[c],a,{topic:b.topic,mimeType:a.type,onProgress:a=>{h(a,c+1)}})})))),i.info})}streamText(a){return di(this,void 0,void 0,function*(){var b,c,d;let e=null!=(b=null==a?void 0:a.streamId)?b:crypto.randomUUID(),f={id:e,mimeType:"text/plain",timestamp:Date.now(),topic:null!=(c=null==a?void 0:a.topic)?c:"",size:null==a?void 0:a.totalSize,attributes:null==a?void 0:a.attributes,encryptionType:(null==(d=this.engine.e2eeManager)?void 0:d.isDataChannelEncryptionEnabled)?bo.GCM:bo.NONE},g=new bU({streamId:e,mimeType:f.mimeType,topic:f.topic,timestamp:fj(f.timestamp),totalLength:fj(null==a?void 0:a.totalSize),attributes:f.attributes,contentHeader:{case:"textHeader",value:new bS({version:null==a?void 0:a.version,attachedStreamIds:null==a?void 0:a.attachedStreamIds,replyToStreamId:null==a?void 0:a.replyToStreamId,operationType:(null==a?void 0:a.type)==="update"?bR.UPDATE:bR.CREATE})}}),h=null==a?void 0:a.destinationIdentities,i=new bt({destinationIdentities:h,value:{case:"streamHeader",value:g}});yield this.engine.sendDataPacket(i,bu.RELIABLE);let j=0,k=this.engine,l=new WritableStream({write(a){return di(this,void 0,void 0,function*(){for(let b of function(a,b){let c=[],d=new TextEncoder().encode(a);for(;d.length>15e3;){let a=15e3;for(;a>0;){let b=d[a];if(void 0!==b&&(192&b)!=128)break;a--}c.push(d.slice(0,a)),d=d.slice(a)}return d.length>0&&c.push(d),c}(a,0)){let a=new bt({destinationIdentities:h,value:{case:"streamChunk",value:new bV({content:b,streamId:e,chunkIndex:fj(j)})}});yield k.sendDataPacket(a,bu.RELIABLE),j+=1}})},close(){return di(this,void 0,void 0,function*(){let a=new bt({destinationIdentities:h,value:{case:"streamTrailer",value:new bW({streamId:e})}});yield k.sendDataPacket(a,bu.RELIABLE)})},abort(a){console.log("Sink error:",a)}}),m=()=>di(this,void 0,void 0,function*(){yield n.close()});k.once(hF.Closing,m);let n=new gy(l,f,()=>this.engine.off(hF.Closing,m));return n})}sendFile(a,b){return di(this,void 0,void 0,function*(){let c=crypto.randomUUID();return yield this._sendFile(c,a,b),{id:c}})}_sendFile(a,b,c){return di(this,void 0,void 0,function*(){var d;let e=yield this.streamBytes({streamId:a,totalSize:b.size,name:b.name,mimeType:null!=(d=null==c?void 0:c.mimeType)?d:b.type,topic:null==c?void 0:c.topic,destinationIdentities:null==c?void 0:c.destinationIdentities}),f=b.stream().getReader();for(;;){let{done:a,value:b}=yield f.read();if(a)break;yield e.write(b)}return yield e.close(),e.info})}streamBytes(a){return di(this,void 0,void 0,function*(){var b,c,d,e,f,g;let h=null!=(b=null==a?void 0:a.streamId)?b:crypto.randomUUID(),i=null==a?void 0:a.destinationIdentities,j={id:h,mimeType:null!=(c=null==a?void 0:a.mimeType)?c:"application/octet-stream",topic:null!=(d=null==a?void 0:a.topic)?d:"",timestamp:Date.now(),attributes:null==a?void 0:a.attributes,size:null==a?void 0:a.totalSize,name:null!=(e=null==a?void 0:a.name)?e:"unknown",encryptionType:(null==(f=this.engine.e2eeManager)?void 0:f.isDataChannelEncryptionEnabled)?bo.GCM:bo.NONE},k=new bt({destinationIdentities:i,value:{case:"streamHeader",value:new bU({totalLength:fj(null!=(g=j.size)?g:0),mimeType:j.mimeType,streamId:h,topic:j.topic,timestamp:fj(Date.now()),attributes:j.attributes,contentHeader:{case:"byteHeader",value:new bT({name:j.name})}})}});yield this.engine.sendDataPacket(k,bu.RELIABLE);let l=0,m=new M,n=this.engine,o=this.log;return new gz(new WritableStream({write(a){return di(this,void 0,void 0,function*(){let b=yield m.lock(),c=0;try{for(;c<a.byteLength;){let b=a.slice(c,c+15e3),d=new bt({destinationIdentities:i,value:{case:"streamChunk",value:new bV({content:b,streamId:h,chunkIndex:fj(l)})}});yield n.sendDataPacket(d,bu.RELIABLE),l+=1,c+=b.byteLength}}finally{b()}})},close(){return di(this,void 0,void 0,function*(){let a=new bt({destinationIdentities:i,value:{case:"streamTrailer",value:new bW({streamId:h})}});yield n.sendDataPacket(a,bu.RELIABLE)})},abort(a){o.error("Sink error:",a)}}),j)})}}class gB extends eM{constructor(a,b,c,d,e){super(a,c,e),this.sid=b,this.receiver=d}get isLocal(){return!1}setMuted(a){this.isMuted!==a&&(this.isMuted=a,this._mediaStreamTrack.enabled=!a,this.emit(a?hG.Muted:hG.Unmuted,this))}setMediaStream(a){this.mediaStream=a;let b=c=>{c.track===this._mediaStreamTrack&&(a.removeEventListener("removetrack",b),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(hG.Ended,this))};a.addEventListener("removetrack",b)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return di(this,void 0,void 0,function*(){var a;if(null==(a=this.receiver)?void 0:a.getStats)return yield this.receiver.getStats()})}setPlayoutDelay(a){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=a:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver)if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;else this.log.warn("Playout delay not supported in this browser");else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),2e3)),"undefined"!=typeof RTCRtpReceiver&&"getSynchronizationSources"in RTCRtpReceiver&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){let a=()=>{var b;this.timeSyncHandle=requestAnimationFrame(()=>a());let c=null==(b=this.receiver)?void 0:b.getSynchronizationSources()[0];if(c){let{timestamp:a,rtpTimestamp:b}=c;b&&this.rtpTimestamp!==b&&(this.emit(hG.TimeSyncUpdate,{timestamp:a,rtpTimestamp:b}),this.rtpTimestamp=b)}};a()}}class gC extends gB{constructor(a,b,c,d,e,f){super(a,b,eM.Kind.Audio,c,f),this.monitorReceiver=()=>di(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}let a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=f3(a,this.prevStats)),this.prevStats=a}),this.audioContext=d,this.webAudioPluginNodes=[],e&&(this.sinkId=e.deviceId)}setVolume(a){var b;for(let c of this.attachedElements)this.audioContext?null==(b=this.gainNode)||b.gain.setTargetAtTime(a,0,.1):c.volume=a;e_()&&this._mediaStreamTrack._setVolume(a),this.elementVolume=a}getVolume(){if(this.elementVolume)return this.elementVolume;if(e_())return 1;let a=0;return this.attachedElements.forEach(b=>{b.volume>a&&(a=b.volume)}),a}setSinkId(a){return di(this,void 0,void 0,function*(){this.sinkId=a,yield Promise.all(this.attachedElements.map(b=>{if(eU(b))return b.setSinkId(a)}))})}attach(a){let b=0===this.attachedElements.length;return a?super.attach(a):a=super.attach(),this.sinkId&&eU(a)&&a.setSinkId(this.sinkId).catch(a=>{this.log.error("Failed to set sink id on remote audio track",a,this.logContext)}),this.audioContext&&b&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,a),a.volume=0,a.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),a}detach(a){let b;return a?(b=super.detach(a),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(b=super.detach(),this.disconnectWebAudio()),b}setAudioContext(a){this.audioContext=a,a&&this.attachedElements.length>0?this.connectWebAudio(a,this.attachedElements[0]):a||this.disconnectWebAudio()}setWebAudioPlugins(a){this.webAudioPluginNodes=a,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(a,b){this.disconnectWebAudio(),this.sourceNode=a.createMediaStreamSource(b.srcObject);let c=this.sourceNode;this.webAudioPluginNodes.forEach(a=>{c.connect(a),c=a}),this.gainNode=a.createGain(),c.connect(this.gainNode),this.gainNode.connect(a.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),"running"!==a.state&&a.resume().then(()=>{"running"!==a.state&&this.emit(hG.AudioPlaybackFailed,Error("Audio Context couldn't be started automatically"))}).catch(a=>{this.emit(hG.AudioPlaybackFailed,a)})}disconnectWebAudio(){var a,b;null==(a=this.gainNode)||a.disconnect(),null==(b=this.sourceNode)||b.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return di(this,void 0,void 0,function*(){let a;if(this.receiver&&this.receiver.getStats)return(yield this.receiver.getStats()).forEach(b=>{"inbound-rtp"===b.type&&(a={type:"audio",streamId:b.id,timestamp:b.timestamp,jitter:b.jitter,bytesReceived:b.bytesReceived,concealedSamples:b.concealedSamples,concealmentEvents:b.concealmentEvents,silentConcealedSamples:b.silentConcealedSamples,silentConcealmentEvents:b.silentConcealmentEvents,totalAudioEnergy:b.totalAudioEnergy,totalSamplesDuration:b.totalSamplesDuration})}),a})}}class gD extends gB{constructor(a,b,c,d,e){super(a,b,eM.Kind.Video,c,e),this.elementInfos=[],this.monitorReceiver=()=>di(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}let a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=f3(a,this.prevStats)),this.prevStats=a}),this.debouncedHandleResize=fN(()=>{this.updateDimensions()},100),this.adaptiveStreamSettings=d}get isAdaptiveStream(){return void 0!==this.adaptiveStreamSettings}setStreamState(a){super.setStreamState(a),this.log.debug("setStreamState",a),this.isAdaptiveStream&&a===eM.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(a){super.setMuted(a),this.attachedElements.forEach(b=>{a?eO(this._mediaStreamTrack,b):eN(this._mediaStreamTrack,b)})}attach(a){if(a?super.attach(a):a=super.attach(),this.adaptiveStreamSettings&&void 0===this.elementInfos.find(b=>b.element===a)){let b=new gE(a);this.observeElementInfo(b)}return a}observeElementInfo(a){this.adaptiveStreamSettings&&void 0===this.elementInfos.find(b=>b===a)?(a.handleResize=()=>{this.debouncedHandleResize()},a.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(a),a.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(a){if(!this.isAdaptiveStream)return void this.log.warn("stopObservingElementInfo ignored",this.logContext);for(let b of this.elementInfos.filter(b=>b===a))b.stopObserving();this.elementInfos=this.elementInfos.filter(b=>b!==a),this.updateVisibility(),this.debouncedHandleResize()}detach(a){let b=[];if(a)return this.stopObservingElement(a),super.detach(a);for(let a of b=super.detach())this.stopObservingElement(a);return b}getDecoderImplementation(){var a;return null==(a=this.prevStats)?void 0:a.decoderImplementation}getReceiverStats(){return di(this,void 0,void 0,function*(){let a;if(!this.receiver||!this.receiver.getStats)return;let b=yield this.receiver.getStats(),c="",d=new Map;return b.forEach(b=>{"inbound-rtp"===b.type?(c=b.codecId,a={type:"video",streamId:b.id,framesDecoded:b.framesDecoded,framesDropped:b.framesDropped,framesReceived:b.framesReceived,packetsReceived:b.packetsReceived,packetsLost:b.packetsLost,frameWidth:b.frameWidth,frameHeight:b.frameHeight,pliCount:b.pliCount,firCount:b.firCount,nackCount:b.nackCount,jitter:b.jitter,timestamp:b.timestamp,bytesReceived:b.bytesReceived,decoderImplementation:b.decoderImplementation}):"codec"===b.type&&d.set(b.id,b)}),a&&""!==c&&d.get(c)&&(a.mimeType=d.get(c).mimeType),a})}stopObservingElement(a){for(let b of this.elementInfos.filter(b=>b.element===a))this.stopObservingElementInfo(b)}handleAppVisibilityChanged(){let a=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return di(this,void 0,void 0,function*(){yield a.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(a){var b,c;let d=this.elementInfos.reduce((a,b)=>Math.max(a,b.visibilityChangedAt||0),0),e=(null==(c=null==(b=this.adaptiveStreamSettings)?void 0:b.pauseVideoInBackground)||!!c)&&this.isInBackground,f=this.elementInfos.some(a=>a.pictureInPicture),g=this.elementInfos.some(a=>a.visible)&&!e||f;if(this.lastVisible!==g||a){if(!g&&Date.now()-d<100)return void et.setTimeout(()=>{this.updateVisibility()},100);this.lastVisible=g,this.emit(hG.VisibilityChanged,g,this)}}updateDimensions(){var a,b;let c=0,d=0,e=this.getPixelDensity();for(let a of this.elementInfos){let b=a.width()*e,f=a.height()*e;b+f>c+d&&(c=b,d=f)}((null==(a=this.lastDimensions)?void 0:a.width)!==c||(null==(b=this.lastDimensions)?void 0:b.height)!==d)&&(this.lastDimensions={width:c,height:d},this.emit(hG.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var a;let b=null==(a=this.adaptiveStreamSettings)?void 0:a.pixelDensity;return"screen"===b?e4():b?b:e4()>2?2:1}}class gE{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(a,b){this.onVisibilityChanged=a=>{var b;let{target:c,isIntersecting:d}=a;c===this.element&&(this.isIntersecting=d,this.isPiP=gF(this.element),this.visibilityChangedAt=Date.now(),null==(b=this.handleVisibilityChanged)||b.call(this))},this.onEnterPiP=()=>{var a,b,c;null==(b=null==(a=window.documentPictureInPicture)?void 0:a.window)||b.addEventListener("pagehide",this.onLeavePiP),this.isPiP=gF(this.element),null==(c=this.handleVisibilityChanged)||c.call(this)},this.onLeavePiP=()=>{var a;this.isPiP=gF(this.element),null==(a=this.handleVisibilityChanged)||a.call(this)},this.element=a,this.isIntersecting=null!=b?b:gG(a),this.isPiP=e$()&&gF(a),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var a,b,c;this.isIntersecting=gG(this.element),this.isPiP=gF(this.element),this.element.handleResize=()=>{var a;null==(a=this.handleResize)||a.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,fb().observe(this.element),e9().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),null==(a=window.documentPictureInPicture)||a.addEventListener("enter",this.onEnterPiP),null==(c=null==(b=window.documentPictureInPicture)?void 0:b.window)||c.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var a,b,c,d,e;null==(a=fb())||a.unobserve(this.element),null==(b=e9())||b.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),null==(c=window.documentPictureInPicture)||c.removeEventListener("enter",this.onEnterPiP),null==(e=null==(d=window.documentPictureInPicture)?void 0:d.window)||e.removeEventListener("pagehide",this.onLeavePiP)}}function gF(a){var b,c;return document.pictureInPictureElement===a||null!=(b=window.documentPictureInPicture)&&!!b.window&&gG(a,null==(c=window.documentPictureInPicture)?void 0:c.window)}function gG(a,b){let c=b||window,d=a.offsetTop,e=a.offsetLeft,f=a.offsetWidth,g=a.offsetHeight,{hidden:h}=a,{display:i}=getComputedStyle(a);for(;a.offsetParent;)d+=(a=a.offsetParent).offsetTop,e+=a.offsetLeft;return d<c.pageYOffset+c.innerHeight&&e<c.pageXOffset+c.innerWidth&&d+g>c.pageYOffset&&e+f>c.pageXOffset&&!h&&"none"!==i}class gH extends dl.EventEmitter{constructor(a,b,c,d){var e;super(),this.metadataMuted=!1,this.encryption=bo.NONE,this.log=de,this.handleMuted=()=>{this.emit(hG.Muted)},this.handleUnmuted=()=>{this.emit(hG.Unmuted)},this.log=df(null!=(e=null==d?void 0:d.loggerName)?e:hx.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=a,this.trackSid=b,this.trackName=c,this.source=eM.Source.Unknown}setTrack(a){this.track&&(this.track.off(hG.Muted,this.handleMuted),this.track.off(hG.Unmuted,this.handleUnmuted)),this.track=a,a&&(a.on(hG.Muted,this.handleMuted),a.on(hG.Unmuted,this.handleUnmuted))}get logContext(){var a;return Object.assign(Object.assign({},null==(a=this.loggerContextCb)?void 0:a.call(this)),eI(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return void 0!==this.track}get isEncrypted(){return this.encryption!==bo.NONE}get audioTrack(){if(fl(this.track))return this.track}get videoTrack(){if(fm(this.track))return this.track}updateInfo(a){this.trackSid=a.sid,this.trackName=a.name,this.source=eM.sourceFromProto(a.source),this.mimeType=a.mimeType,this.kind===eM.Kind.Video&&a.width>0&&(this.dimensions={width:a.width,height:a.height},this.simulcasted=a.simulcast),this.encryption=a.encryption,this.trackInfo=a,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:a}))}}(hn=(hm=gH||(gH={})).SubscriptionStatus||(hm.SubscriptionStatus={})).Desired="desired",hn.Subscribed="subscribed",hn.Unsubscribed="unsubscribed",(ho=hm.PermissionStatus||(hm.PermissionStatus={})).Allowed="allowed",ho.NotAllowed="not_allowed";class gI extends gH{get isUpstreamPaused(){var a;return null==(a=this.track)?void 0:a.isUpstreamPaused}constructor(a,b,c,d){super(a,b.sid,b.name,d),this.track=void 0,this.handleTrackEnded=()=>{this.emit(hG.Ended)},this.handleCpuConstrained=()=>{this.track&&fm(this.track)&&this.emit(hG.CpuConstrained,this.track)},this.updateInfo(b),this.setTrack(c)}setTrack(a){this.track&&(this.track.off(hG.Ended,this.handleTrackEnded),this.track.off(hG.CpuConstrained,this.handleCpuConstrained)),super.setTrack(a),a&&(a.on(hG.Ended,this.handleTrackEnded),a.on(hG.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return di(this,void 0,void 0,function*(){var a;return null==(a=this.track)?void 0:a.mute()})}unmute(){return di(this,void 0,void 0,function*(){var a;return null==(a=this.track)?void 0:a.unmute()})}pauseUpstream(){return di(this,void 0,void 0,function*(){var a;yield null==(a=this.track)?void 0:a.pauseUpstream()})}resumeUpstream(){return di(this,void 0,void 0,function*(){var a;yield null==(a=this.track)?void 0:a.resumeUpstream()})}getTrackFeatures(){var a;if(!fl(this.track))return[];{let b=this.track.getSourceTrackSettings(),c=new Set;return b.autoGainControl&&c.add(bg.TF_AUTO_GAIN_CONTROL),b.echoCancellation&&c.add(bg.TF_ECHO_CANCELLATION),b.noiseSuppression&&c.add(bg.TF_NOISE_SUPPRESSION),b.channelCount&&b.channelCount>1&&c.add(bg.TF_STEREO),(null==(a=this.options)?void 0:a.dtx)||c.add(bg.TF_NO_DTX),this.track.enhancedNoiseCancellation&&c.add(bg.TF_ENHANCED_NOISE_CANCELLATION),Array.from(c.values())}}}function gJ(a,b){return di(this,void 0,void 0,function*(){null!=a||(a={});let c=!1,{audioProcessor:d,videoProcessor:e,optionsWithoutProcessor:f}=eJ(a),g=f.audio,h=f.video;if(d&&"object"==typeof f.audio&&(f.audio.processor=d),e&&"object"==typeof f.video&&(f.video.processor=e),a.audio&&"object"==typeof f.audio&&"string"==typeof f.audio.deviceId){let a=f.audio.deviceId;f.audio.deviceId={exact:a},c=!0,g=Object.assign(Object.assign({},f.audio),{deviceId:{ideal:a}})}if(f.video&&"object"==typeof f.video&&"string"==typeof f.video.deviceId){let a=f.video.deviceId;f.video.deviceId={exact:a},c=!0,h=Object.assign(Object.assign({},f.video),{deviceId:{ideal:a}})}!0===f.audio?f.audio={deviceId:"default"}:"object"==typeof f.audio&&null!==f.audio&&(f.audio=Object.assign(Object.assign({},f.audio),{deviceId:f.audio.deviceId||"default"})),!0===f.video?f.video={deviceId:"default"}:"object"!=typeof f.video||f.video.deviceId||(f.video.deviceId="default");let i=eB(f,fW,fX),j=eD(i),k=navigator.mediaDevices.getUserMedia(j);f.audio&&(fz.userMediaPromiseMap.set("audioinput",k),k.catch(()=>fz.userMediaPromiseMap.delete("audioinput"))),f.video&&(fz.userMediaPromiseMap.set("videoinput",k),k.catch(()=>fz.userMediaPromiseMap.delete("videoinput")));try{let a=yield k;return yield Promise.all(a.getTracks().map(c=>di(this,void 0,void 0,function*(){let f,g="audio"===c.kind,h=g?i.audio:i.video;"boolean"!=typeof h&&h||(h={});let k=g?j.audio:j.video;"boolean"!=typeof k&&(f=k);let l=c.getSettings().deviceId;(null==f?void 0:f.deviceId)&&ff(f.deviceId)!==l?f.deviceId=l:f||(f={deviceId:l});let m=function(a,b,c){switch(a.kind){case"audio":return new f8(a,b,!1,void 0,c);case"video":return new gk(a,b,!1,c);default:throw new el("unsupported track type: ".concat(a.kind))}}(c,f,b);return m.kind===eM.Kind.Video?m.source=eM.Source.Camera:m.kind===eM.Kind.Audio&&(m.source=eM.Source.Microphone),m.mediaStream=a,fl(m)&&d?yield m.setProcessor(d):fm(m)&&e&&(yield m.setProcessor(e)),m})))}catch(d){if(!c)throw d;return gJ(Object.assign(Object.assign({},a),{audio:g,video:h}),b)}})}(hp=hY||(hY={})).Excellent="excellent",hp.Good="good",hp.Poor="poor",hp.Lost="lost",hp.Unknown="unknown";class gK extends dl.EventEmitter{get logContext(){var a,b;return Object.assign({},null==(b=null==(a=this.loggerOptions)?void 0:a.loggerContextCb)?void 0:b.call(a))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(a=>a.isEncrypted)}get isAgent(){var a;return(null==(a=this.permissions)?void 0:a.agent)||this.kind===bm.AGENT}get isActive(){var a;return(null==(a=this.participantInfo)?void 0:a.state)===bl.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(a,b,c,d,e,f){var g;let h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:bm.STANDARD;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=hY.Unknown,this.log=de,this.log=df(null!=(g=null==f?void 0:f.loggerName)?g:hx.Participant),this.loggerOptions=f,this.setMaxListeners(100),this.sid=a,this.identity=b,this.name=c,this.metadata=d,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=h,this._attributes=null!=e?e:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(a){for(let[,b]of this.trackPublications)if(b.source===a)return b}getTrackPublicationByName(a){for(let[,b]of this.trackPublications)if(b.trackName===a)return b}waitUntilActive(){return this.isActive?Promise.resolve():(this.activeFuture||(this.activeFuture=new fe,this.once(hE.Active,()=>{var a,b;null==(b=null==(a=this.activeFuture)?void 0:a.resolve)||b.call(a),this.activeFuture=void 0})),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var a;let b=this.getTrackPublication(eM.Source.Camera);return!(null==(a=null==b?void 0:b.isMuted)||a)}get isMicrophoneEnabled(){var a;let b=this.getTrackPublication(eM.Source.Microphone);return!(null==(a=null==b?void 0:b.isMuted)||a)}get isScreenShareEnabled(){return!!this.getTrackPublication(eM.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(1e3*Number.parseInt(this.participantInfo.joinedAt.toString())):new Date}updateInfo(a){var b;return(!this.participantInfo||this.participantInfo.sid!==a.sid||!(this.participantInfo.version>a.version))&&(this.identity=a.identity,this.sid=a.sid,this._setName(a.name),this._setMetadata(a.metadata),this._setAttributes(a.attributes),a.state===bl.ACTIVE&&(null==(b=this.participantInfo)?void 0:b.state)!==bl.ACTIVE&&this.emit(hE.Active),a.permission&&this.setPermissions(a.permission),this.participantInfo=a,!0)}_setMetadata(a){let b=this.metadata!==a,c=this.metadata;this.metadata=a,b&&this.emit(hE.ParticipantMetadataChanged,c)}_setName(a){let b=this.name!==a;this.name=a,b&&this.emit(hE.ParticipantNameChanged,a)}_setAttributes(a){let b=function(a,b){var c;void 0===a&&(a={}),void 0===b&&(b={});let d=[...Object.keys(b),...Object.keys(a)],e={};for(let f of d)a[f]!==b[f]&&(e[f]=null!=(c=b[f])?c:"");return e}(this.attributes,a);this._attributes=a,Object.keys(b).length>0&&this.emit(hE.AttributesChanged,b)}setPermissions(a){var b,c,d,e,f,g;let h=this.permissions,i=a.canPublish!==(null==(b=this.permissions)?void 0:b.canPublish)||a.canSubscribe!==(null==(c=this.permissions)?void 0:c.canSubscribe)||a.canPublishData!==(null==(d=this.permissions)?void 0:d.canPublishData)||a.hidden!==(null==(e=this.permissions)?void 0:e.hidden)||a.recorder!==(null==(f=this.permissions)?void 0:f.recorder)||a.canPublishSources.length!==this.permissions.canPublishSources.length||a.canPublishSources.some((a,b)=>{var c;return a!==(null==(c=this.permissions)?void 0:c.canPublishSources[b])})||a.canSubscribeMetrics!==(null==(g=this.permissions)?void 0:g.canSubscribeMetrics);return this.permissions=a,i&&this.emit(hE.ParticipantPermissionsChanged,h),i}setIsSpeaking(a){a!==this.isSpeaking&&(this.isSpeaking=a,a&&(this.lastSpokeAt=new Date),this.emit(hE.IsSpeakingChanged,a))}setConnectionQuality(a){let b=this._connectionQuality;this._connectionQuality=function(a){switch(a){case bb.EXCELLENT:return hY.Excellent;case bb.GOOD:return hY.Good;case bb.POOR:return hY.Poor;case bb.LOST:return hY.Lost;default:return hY.Unknown}}(a),b!==this._connectionQuality&&this.emit(hE.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var a,b;this.activeFuture&&(null==(b=(a=this.activeFuture).reject)||b.call(a,Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(a){this.audioContext=a,this.audioTrackPublications.forEach(b=>fl(b.track)&&b.track.setAudioContext(a))}addTrackPublication(a){switch(a.on(hG.Muted,()=>{this.emit(hE.TrackMuted,a)}),a.on(hG.Unmuted,()=>{this.emit(hE.TrackUnmuted,a)}),a.track&&(a.track.sid=a.trackSid),this.trackPublications.set(a.trackSid,a),a.kind){case eM.Kind.Audio:this.audioTrackPublications.set(a.trackSid,a);break;case eM.Kind.Video:this.videoTrackPublications.set(a.trackSid,a)}}}class gL extends gK{constructor(a,b,c,d,e,f){super(a,b,void 0,void 0,void 0,{loggerName:d.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=bo.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new fe)},this.handleReconnected=()=>{var a,b;null==(b=null==(a=this.reconnectFuture)?void 0:a.resolve)||b.call(a),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var a,b,c,d,e,f;this.reconnectFuture&&(this.reconnectFuture.promise.catch(a=>this.log.warn(a.message,this.logContext)),null==(b=null==(a=this.reconnectFuture)?void 0:a.reject)||b.call(a,Error("Got disconnected during reconnection attempt")),this.reconnectFuture=void 0),this.signalConnectedFuture&&(null==(d=(c=this.signalConnectedFuture).reject)||d.call(c,Error("Got disconnected without signal connected")),this.signalConnectedFuture=void 0),null==(f=null==(e=this.activeAgentFuture)?void 0:e.reject)||f.call(e,Error("Got disconnected without active agent present")),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=a=>{var b,c;a.participant&&this.updateInfo(a.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new fe),null==(c=(b=this.signalConnectedFuture).resolve)||c.call(b)},this.handleSignalRequestResponse=a=>{let{requestId:b,reason:c,message:d}=a,e=this.pendingSignalRequests.get(b);e&&(c!==c4.OK&&e.reject(new eq(d,c)),this.pendingSignalRequests.delete(b))},this.handleDataPacket=a=>{switch(a.value.case){case"rpcResponse":let b=a.value.value,c=null,d=null;"payload"===b.value.case?c=b.value.value:"error"===b.value.case&&(d=f0.fromProto(b.value.value)),this.handleIncomingRpcResponse(b.requestId,c,d);break;case"rpcAck":let e=a.value.value;this.handleIncomingRpcAck(e.requestId)}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(a=>(function(a){var b,c,d;if(!a.participantSid&&!a.participantIdentity)throw Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new cS({participantIdentity:null!=(b=a.participantIdentity)?b:"",participantSid:null!=(c=a.participantSid)?c:"",allTracks:null!=(d=a.allowAll)&&d,trackSids:a.allowedTrackSids||[]})})(a)))},this.onTrackUnmuted=a=>{this.onTrackMuted(a,a.isUpstreamPaused)},this.onTrackMuted=(a,b)=>{(void 0===b&&(b=!0),a.sid)?this.engine.updateMuteStatus(a.sid,b):this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),eI(a)))},this.onTrackUpstreamPaused=a=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),eI(a))),this.onTrackMuted(a,!0)},this.onTrackUpstreamResumed=a=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),eI(a))),this.onTrackMuted(a,a.isMuted)},this.onTrackFeatureUpdate=a=>{let b=this.audioTrackPublications.get(a.sid);b?this.engine.client.sendUpdateLocalAudioTrack(b.trackSid,b.getTrackFeatures()):this.log.warn("Could not update local audio track settings, missing publication for track ".concat(a.sid),this.logContext)},this.onTrackCpuConstrained=(a,b)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),eI(b))),this.emit(hE.LocalTrackCpuConstrained,a,b)},this.handleSubscribedQualityUpdate=a=>di(this,void 0,void 0,function*(){if(!(null==(h=this.roomOptions)?void 0:h.dynacast))return;let b=this.videoTrackPublications.get(a.trackSid);if(!b)return void this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));if(!b.videoTrack)return;let c=yield b.videoTrack.setPublishingCodecs(a.subscribedCodecs);try{for(var d,e,f,g,h,i,j=!0,k=dj(c);!(d=(i=yield k.next()).done);j=!0)g=i.value,j=!1,ex(g)&&(this.log.debug("publish ".concat(g," for ").concat(b.videoTrack.sid),Object.assign(Object.assign({},this.logContext),eI(b))),yield this.publishAdditionalCodecForTrack(b.videoTrack,g,b.options))}catch(a){e={error:a}}finally{try{!j&&!d&&(f=k.return)&&(yield f.call(k))}finally{if(e)throw e.error}}}),this.handleLocalTrackUnpublished=a=>{let b=this.trackPublications.get(a.trackSid);b?this.unpublishTrack(b.track):this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}))},this.handleTrackEnded=a=>di(this,void 0,void 0,function*(){if(a.source===eM.Source.ScreenShare||a.source===eM.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),eI(a))),this.unpublishTrack(a);else if(a.isUserProvided)yield a.mute();else if(fo(a)||fn(a))try{if(e$())try{let b=yield null==navigator?void 0:navigator.permissions.query({name:a.source===eM.Source.Camera?"camera":"microphone"});if(b&&"denied"===b.state)throw this.log.warn("user has revoked access to ".concat(a.source),Object.assign(Object.assign({},this.logContext),eI(a))),b.onchange=()=>{"denied"!==b.state&&(a.isMuted||a.restartTrack(),b.onchange=null)},Error("GetUserMedia Permission denied")}catch(a){}a.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),eI(a))),fo(a)?yield a.restartTrack({deviceId:"default"}):yield a.restartTrack())}catch(b){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),eI(a))),yield a.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=c,this.roomOptions=d,this.setupEngine(c),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=e,this.roomOutgoingDataStreamManager=f}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==bo.NONE}getTrackPublication(a){let b=super.getTrackPublication(a);if(b)return b}getTrackPublicationByName(a){let b=super.getTrackPublicationByName(a);if(b)return b}setupEngine(a){var b;this.engine=a,this.engine.on(hF.RemoteMute,(a,b)=>{let c=this.trackPublications.get(a);c&&c.track&&(b?c.mute():c.unmute())}),(null==(b=this.signalConnectedFuture)?void 0:b.isResolved)&&(this.signalConnectedFuture=void 0),this.engine.on(hF.Connected,this.handleReconnected).on(hF.SignalConnected,this.handleSignalConnected).on(hF.SignalRestarted,this.handleReconnected).on(hF.SignalResumed,this.handleReconnected).on(hF.Restarting,this.handleReconnecting).on(hF.Resuming,this.handleReconnecting).on(hF.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(hF.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(hF.Closing,this.handleClosing).on(hF.SignalRequestResponse,this.handleSignalRequestResponse).on(hF.DataPacketReceived,this.handleDataPacket)}setMetadata(a){return di(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:a})})}setName(a){return di(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:a})})}setAttributes(a){return di(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:a})})}requestMetadataUpdate(a){return di(this,arguments,void 0,function(a){var b=this;let{metadata:c,name:d,attributes:e}=a;return function*(){return new Promise((a,f)=>di(b,void 0,void 0,function*(){var b,g;try{let h=!1,i=yield this.engine.client.sendUpdateLocalMetadata(null!=(b=null!=c?c:this.metadata)?b:"",null!=(g=null!=d?d:this.name)?g:"",e),j=performance.now();for(this.pendingSignalRequests.set(i,{resolve:a,reject:a=>{f(a),h=!0},values:{name:d,metadata:c,attributes:e}});performance.now()-j<5e3&&!h;){if((!d||this.name===d)&&(!c||this.metadata===c)&&(!e||Object.entries(e).every(a=>{let[b,c]=a;return this.attributes[b]===c||""===c&&!this.attributes[b]}))){this.pendingSignalRequests.delete(i),a();return}yield eQ(50)}f(new eq("Request to update local metadata timed out","TimeoutError"))}catch(a){a instanceof Error&&f(a)}}))}()})}setCameraEnabled(a,b,c){return this.setTrackEnabled(eM.Source.Camera,a,b,c)}setMicrophoneEnabled(a,b,c){return this.setTrackEnabled(eM.Source.Microphone,a,b,c)}setScreenShareEnabled(a,b,c){return this.setTrackEnabled(eM.Source.ScreenShare,a,b,c)}setE2EEEnabled(a){return di(this,void 0,void 0,function*(){this.encryptionType=a?bo.GCM:bo.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(a,b,c,d){return di(this,void 0,void 0,function*(){this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:a,enabled:b})),this.republishPromise&&(yield this.republishPromise);let e=this.getTrackPublication(a);if(b)if(e)yield e.unmute();else{let b;if(this.pendingPublishing.has(a)){let b=yield this.waitForPendingPublicationOfSource(a);return b||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:a})),yield null==b?void 0:b.unmute(),b}this.pendingPublishing.add(a);try{switch(a){case eM.Source.Camera:b=yield this.createTracks({video:null==c||c});break;case eM.Source.Microphone:b=yield this.createTracks({audio:null==c||c});break;case eM.Source.ScreenShare:b=yield this.createScreenTracks(Object.assign({},c));break;default:throw new el(a)}}catch(c){throw null==b||b.forEach(a=>{a.stop()}),c instanceof Error&&this.emit(hE.MediaDevicesError,c,eG(a)),this.pendingPublishing.delete(a),c}for(let d of b){let b=Object.assign(Object.assign({},this.roomOptions.publishDefaults),c);a===eM.Source.Microphone&&fl(d)&&b.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),d.startPreConnectBuffer())}try{let a=[];for(let c of b)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),eI(c))),a.push(this.publishTrack(c,d));let c=yield Promise.all(a);[e]=c}catch(a){throw null==b||b.forEach(a=>{a.stop()}),a}finally{this.pendingPublishing.delete(a)}}else if(!(null==e?void 0:e.track)&&this.pendingPublishing.has(a)&&((e=yield this.waitForPendingPublicationOfSource(a))||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:a}))),e&&e.track)if(a===eM.Source.ScreenShare){e=yield this.unpublishTrack(e.track);let a=this.getTrackPublication(eM.Source.ScreenShareAudio);a&&a.track&&this.unpublishTrack(a.track)}else yield e.mute();return e})}enableCameraAndMicrophone(){return di(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(eM.Source.Camera)||this.pendingPublishing.has(eM.Source.Microphone))){this.pendingPublishing.add(eM.Source.Camera),this.pendingPublishing.add(eM.Source.Microphone);try{let a=yield this.createTracks({audio:!0,video:!0});yield Promise.all(a.map(a=>this.publishTrack(a)))}finally{this.pendingPublishing.delete(eM.Source.Camera),this.pendingPublishing.delete(eM.Source.Microphone)}}})}createTracks(a){return di(this,void 0,void 0,function*(){var b,c;null!=a||(a={});let d=eB(a,null==(b=this.roomOptions)?void 0:b.audioCaptureDefaults,null==(c=this.roomOptions)?void 0:c.videoCaptureDefaults);try{return(yield gJ(d,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(a=>(fl(a)&&(this.microphoneError=void 0,a.setAudioContext(this.audioContext),a.source=eM.Source.Microphone,this.emit(hE.AudioStreamAcquired)),fm(a)&&(this.cameraError=void 0,a.source=eM.Source.Camera),a))}catch(b){throw b instanceof Error&&(a.audio&&(this.microphoneError=b),a.video&&(this.cameraError=b)),b}})}createScreenTracks(a){return di(this,void 0,void 0,function*(){var b,c,d;let e,f;if(void 0===a&&(a={}),void 0===navigator.mediaDevices.getDisplayMedia)throw new ek("getDisplayMedia not supported");void 0!==a.resolution||(null==(e=ee())?void 0:e.name)==="Safari"&&e.version.startsWith("17.")||(null==e?void 0:e.os)==="iOS"&&(null==e?void 0:e.osVersion)&&e5(e.osVersion,"17")>=0||(a.resolution=eA.h1080fps30.resolution);let g=(f=null==(c=(b=a).video)||c,b.resolution&&b.resolution.width>0&&b.resolution.height>0&&(f="boolean"==typeof f?{}:f,f=eX()?Object.assign(Object.assign({},f),{width:{max:b.resolution.width},height:{max:b.resolution.height},frameRate:b.resolution.frameRate}):Object.assign(Object.assign({},f),{width:{ideal:b.resolution.width},height:{ideal:b.resolution.height},frameRate:b.resolution.frameRate})),{audio:null!=(d=b.audio)&&d,video:f,controller:b.controller,selfBrowserSurface:b.selfBrowserSurface,surfaceSwitching:b.surfaceSwitching,systemAudio:b.systemAudio,preferCurrentTab:b.preferCurrentTab}),h=yield navigator.mediaDevices.getDisplayMedia(g),i=h.getVideoTracks();if(0===i.length)throw new el("no video track found");let j=new gk(i[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});j.source=eM.Source.ScreenShare,a.contentHint&&(j.mediaStreamTrack.contentHint=a.contentHint);let k=[j];if(h.getAudioTracks().length>0){this.emit(hE.AudioStreamAcquired);let a=new f8(h.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=eM.Source.ScreenShareAudio,k.push(a)}return k})}publishTrack(a,b){return di(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(a,b)})}publishOrRepublishTrack(a,b){return di(this,arguments,void 0,function(a,b){var c=this;let d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function*(){var e,f;let g,h;if(fo(a)&&a.setAudioContext(c.audioContext),yield null==(e=c.reconnectFuture)?void 0:e.promise,c.republishPromise&&!d&&(yield c.republishPromise),fk(a)&&c.pendingPublishPromises.has(a)&&(yield c.pendingPublishPromises.get(a)),a instanceof MediaStreamTrack)g=a.getConstraints();else{let b;switch(g=a.constraints,a.source){case eM.Source.Microphone:b="audioinput";break;case eM.Source.Camera:b="videoinput"}b&&c.activeDeviceMap.has(b)&&(g=Object.assign(Object.assign({},g),{deviceId:c.activeDeviceMap.get(b)}))}if(a instanceof MediaStreamTrack)switch(a.kind){case"audio":a=new f8(a,g,!0,c.audioContext,{loggerName:c.roomOptions.loggerName,loggerContextCb:()=>c.logContext});break;case"video":a=new gk(a,g,!0,{loggerName:c.roomOptions.loggerName,loggerContextCb:()=>c.logContext});break;default:throw new el("unsupported MediaStreamTrack kind ".concat(a.kind))}else a.updateLoggerOptions({loggerName:c.roomOptions.loggerName,loggerContextCb:()=>c.logContext});if(c.trackPublications.forEach(b=>{b.track&&b.track===a&&(h=b)}),h)return c.log.warn("track has already been published, skipping",Object.assign(Object.assign({},c.logContext),eI(h))),h;let i=Object.assign(Object.assign({},c.roomOptions.publishDefaults),b),j="channelCount"in a.mediaStreamTrack.getSettings()&&2===a.mediaStreamTrack.getSettings().channelCount||2===a.mediaStreamTrack.getConstraints().channelCount,k=null!=(f=i.forceStereo)?f:j;k&&(void 0===i.dtx&&c.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},c.logContext),eI(a))),void 0===i.red&&c.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),null!=i.dtx||(i.dtx=!1),null!=i.red||(i.red=!1)),!function(){let a=ee(),b="17.2";if(a)if("Safari"!==a.name&&"iOS"!==a.os)return!0;else if("iOS"===a.os&&a.osVersion&&e5(a.osVersion,b)>=0)return!0;else if("Safari"===a.name&&e5(a.version,b)>=0)return!0;else return!1}()&&c.roomOptions.e2ee&&(c.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},c.logContext)),i.simulcast=!1),i.source&&(a.source=i.source);let l=new Promise((b,d)=>di(c,void 0,void 0,function*(){try{if(this.engine.client.currentState!==hQ.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:eI(a)}));let c=!1,e=setTimeout(()=>{c=!0,a.stop(),d(new ep("publishing rejected as engine not connected within timeout",408))},15e3);if(yield this.waitUntilEngineConnected(),clearTimeout(e),c)return;let f=yield this.publish(a,i,k);b(f)}else try{let c=yield this.publish(a,i,k);b(c)}catch(a){d(a)}}catch(a){d(a)}}));c.pendingPublishPromises.set(a,l);try{return yield l}catch(a){throw a}finally{c.pendingPublishPromises.delete(a)}}()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new fe),this.signalConnectedFuture.promise}hasPermissionsToPublish(a){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),eI(a))),!1;let{canPublish:b,canPublishSources:c}=this.permissions;return!!(b&&(0===c.length||c.map(a=>(function(a){switch(a){case a9.CAMERA:return eM.Source.Camera;case a9.MICROPHONE:return eM.Source.Microphone;case a9.SCREEN_SHARE:return eM.Source.ScreenShare;case a9.SCREEN_SHARE_AUDIO:return eM.Source.ScreenShareAudio;default:return eM.Source.Unknown}})(a)).includes(a.source)))||(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),eI(a))),!1)}publish(a,b,c){return di(this,void 0,void 0,function*(){var d,e,f,g,h,i,j,k,l,m;let n,o;if(!this.hasPermissionsToPublish(a))throw new ep("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(b=>fk(a)&&b.source===a.source)&&a.source!==eM.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(a.source),Object.assign(Object.assign({},this.logContext),eI(a))),b.stopMicTrackOnMute&&fl(a)&&(a.stopOnMute=!0),a.source===eM.Source.ScreenShare&&eV()&&(b.simulcast=!1),"av1"===b.videoCodec&&!function(){if(!("getCapabilities"in RTCRtpSender)||eX()||eV())return!1;let a=RTCRtpSender.getCapabilities("video"),b=!1;if(a){for(let c of a.codecs)if("video/av1"===c.mimeType.toLowerCase()){b=!0;break}}return b}()&&(b.videoCodec=void 0),"vp9"===b.videoCodec&&!function(){if(!("getCapabilities"in RTCRtpSender)||eV())return!1;if(eX()){let a=ee();if((null==a?void 0:a.version)&&0>e5(a.version,"16")||(null==a?void 0:a.os)==="iOS"&&(null==a?void 0:a.osVersion)&&0>e5(a.osVersion,"16"))return!1}let a=RTCRtpSender.getCapabilities("video"),b=!1;if(a){for(let c of a.codecs)if("video/vp9"===c.mimeType.toLowerCase()){b=!0;break}}return b}()&&(b.videoCodec=void 0),void 0===b.videoCodec&&(b.videoCodec="vp8"),this.enabledPublishVideoCodecs.length>0&&!this.enabledPublishVideoCodecs.some(a=>b.videoCodec===eH(a.mime))&&(b.videoCodec=eH(this.enabledPublishVideoCodecs[0].mime));let p=b.videoCodec;a.on(hG.Muted,this.onTrackMuted),a.on(hG.Unmuted,this.onTrackUnmuted),a.on(hG.Ended,this.handleTrackEnded),a.on(hG.UpstreamPaused,this.onTrackUpstreamPaused),a.on(hG.UpstreamResumed,this.onTrackUpstreamResumed),a.on(hG.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);let q=[],r=!(null==(d=b.dtx)||d),s=a.getSourceTrackSettings();s.autoGainControl&&q.push(bg.TF_AUTO_GAIN_CONTROL),s.echoCancellation&&q.push(bg.TF_ECHO_CANCELLATION),s.noiseSuppression&&q.push(bg.TF_NOISE_SUPPRESSION),s.channelCount&&s.channelCount>1&&q.push(bg.TF_STEREO),r&&q.push(bg.TF_NO_DTX),fo(a)&&a.hasPreConnectBuffer&&q.push(bg.TF_PRECONNECT_BUFFER);let t=new cq({cid:a.mediaStreamTrack.id,name:b.name,type:eM.kindToProto(a.kind),muted:a.isMuted,source:eM.sourceToProto(a.source),disableDtx:r,encryption:this.encryptionType,stereo:c,disableRed:this.isE2EEEnabled||!(null==(e=b.red)||e),stream:null==b?void 0:b.stream,backupCodecPolicy:null==b?void 0:b.backupCodecPolicy,audioFeatures:q});if(a.kind===eM.Kind.Video){let c={width:0,height:0};try{c=yield a.waitForDimensions()}catch(d){let b=null!=(g=null==(f=this.roomOptions.videoCaptureDefaults)?void 0:f.resolution)?g:ey.h720.resolution;c={width:b.width,height:b.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),eI(a)),{dims:c}))}t.width=c.width,t.height=c.height,fn(a)&&(eT(p)&&(a.source===eM.Source.ScreenShare&&(b.scalabilityMode="L1T3","contentHint"in a.mediaStreamTrack&&(a.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),eI(a))))),b.scalabilityMode=null!=(h=b.scalabilityMode)?h:"L3T3_KEY"),t.simulcastCodecs=[new cp({codec:p,cid:a.mediaStreamTrack.id})],!0===b.backupCodec&&(b.backupCodec={codec:"vp8"}),b.backupCodec&&p!==b.backupCodec.codec&&t.encryption===bo.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),t.simulcastCodecs.push(new cp({codec:b.backupCodec.codec,cid:""})))),n=gf(a.source===eM.Source.ScreenShare,t.width,t.height,b),t.layers=gn(t.width,t.height,n,eT(b.videoCodec))}else a.kind===eM.Kind.Audio&&(n=[{maxBitrate:null==(i=b.audioPreset)?void 0:i.maxBitrate,priority:null!=(k=null==(j=b.audioPreset)?void 0:j.priority)?k:"high",networkPriority:null!=(m=null==(l=b.audioPreset)?void 0:l.priority)?m:"high"}]);if(!this.engine||this.engine.isClosed)throw new en("cannot publish track when not connected");let u=()=>di(this,void 0,void 0,function*(){var c,d;if(!this.engine.pcManager)throw new en("pcManager is not ready");if(a.sender=yield this.engine.createSender(a,b,n),this.emit(hE.LocalSenderCreated,a.sender,a),fn(a)&&(null!=b.degradationPreference||(b.degradationPreference=a.source===eM.Source.ScreenShare||a.constraints.height&&ff(a.constraints.height)>=1080?"maintain-resolution":"balanced"),a.setDegradationPreference(b.degradationPreference)),n)if(eV()&&a.kind===eM.Kind.Audio){let b;for(let c of this.engine.pcManager.publisher.getTransceivers())if(c.sender===a.sender){b=c;break}b&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:b,codec:"opus",maxbr:(null==(c=n[0])?void 0:c.maxBitrate)?n[0].maxBitrate/1e3:0})}else a.codec&&eT(a.codec)&&(null==(d=n[0])?void 0:d.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:t.cid,codec:a.codec,maxbr:n[0].maxBitrate/1e3});yield this.engine.negotiate()}),v=new Promise((b,c)=>di(this,void 0,void 0,function*(){var d;try{o=yield this.engine.addTrack(t),b(o)}catch(b){a.sender&&(null==(d=this.engine.pcManager)?void 0:d.publisher)&&(this.engine.pcManager.publisher.removeTrack(a.sender),yield this.engine.negotiate().catch(b=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),eI(a)),{error:b}))})),c(b)}}));if(this.enabledPublishVideoCodecs.length>0)o=(yield Promise.all([v,u()]))[0];else{let c;if((o=yield v).codecs.forEach(a=>{void 0===c&&(c=a.mimeType)}),c&&a.kind===eM.Kind.Video){let d=eH(c);d!==p&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),eI(a)),{codec:d})),b.videoCodec=d,n=gf(a.source===eM.Source.ScreenShare,t.width,t.height,b))}yield u()}let w=new gI(a.kind,o,a,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(w.on(hG.CpuConstrained,a=>this.onTrackCpuConstrained(a,w)),w.options=b,a.sid=o.sid,this.log.debug("publishing ".concat(a.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:n,trackInfo:o})),fn(a)?a.startMonitor(this.engine.client):fo(a)&&a.startMonitor(),this.addTrackPublication(w),this.emit(hE.LocalTrackPublished,w),fo(a)&&o.audioFeatures.includes(bg.TF_PRECONNECT_BUFFER)){let b=a.getPreConnectBuffer(),c=a.getPreConnectBufferMimeType();this.on(hE.LocalTrackSubscribed,b=>{if(b.trackSid===o.sid){if(!a.hasPreConnectBuffer)return void this.log.warn("subscribe event came to late, buffer already closed",this.logContext);this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),eI(a))),a.stopPreConnectBuffer()}}),b&&new Promise((d,e)=>di(this,void 0,void 0,function*(){try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),eI(a)));let o=setTimeout(()=>{e(Error("agent not active within 10 seconds"))},1e4),p=yield this.waitUntilActiveAgentPresent();clearTimeout(o),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),eI(a)));let q=yield this.streamBytes({name:"preconnect-buffer",mimeType:c,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[p.identity],attributes:{trackId:w.trackSid,sampleRate:String(null!=(j=s.sampleRate)?j:"48000"),channels:String(null!=(k=s.channelCount)?k:"1")}});try{for(var f,g,h,i,j,k,l,m=!0,n=dj(b);!(f=(l=yield n.next()).done);m=!0)i=l.value,m=!1,yield q.write(i)}catch(a){g={error:a}}finally{try{!m&&!f&&(h=n.return)&&(yield h.call(n))}finally{if(g)throw g.error}}yield q.close(),d()}catch(a){e(a)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),eI(a)))}).catch(b=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),eI(a)),{error:b}))})}return w})}get isLocal(){return!0}publishAdditionalCodecForTrack(a,b,c){return di(this,void 0,void 0,function*(){var d;let e;if(this.encryptionType!==bo.NONE)return;if(this.trackPublications.forEach(b=>{b.track&&b.track===a&&(e=b)}),!e)throw new el("track is not published");if(!fn(a))throw new el("track is not a video track");let f=Object.assign(Object.assign({},null==(d=this.roomOptions)?void 0:d.publishDefaults),c),g=function(a,b,c){var d,e,f,g;if(!c.backupCodec||!0===c.backupCodec||c.backupCodec.codec===c.videoCodec)return;b!==c.backupCodec.codec&&de.warn("requested a different codec than specified as backup",{serverRequested:b,backup:c.backupCodec.codec}),c.videoCodec=b,c.videoEncoding=c.backupCodec.encoding;let h=a.mediaStreamTrack.getSettings(),i=null!=(d=h.width)?d:null==(e=a.dimensions)?void 0:e.width,j=null!=(f=h.height)?f:null==(g=a.dimensions)?void 0:g.height;return a.source===eM.Source.ScreenShare&&c.simulcast&&(c.simulcast=!1),gf(a.source===eM.Source.ScreenShare,i,j,c)}(a,b,f);if(!g)return void this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),eI(a)));let h=a.addSimulcastTrack(b,g);if(!h)return;let i=new cq({cid:h.mediaStreamTrack.id,type:eM.kindToProto(a.kind),muted:a.isMuted,source:eM.sourceToProto(a.source),sid:a.sid,simulcastCodecs:[{codec:f.videoCodec,cid:h.mediaStreamTrack.id}]});if(i.layers=gn(i.width,i.height,g),!this.engine||this.engine.isClosed)throw new en("cannot publish track when not connected");let j=()=>di(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(a,h,f,g),yield this.engine.negotiate()}),k=(yield Promise.all([this.engine.addTrack(i),j()]))[0];this.log.debug("published ".concat(b," for track ").concat(a.sid),Object.assign(Object.assign({},this.logContext),{encodings:g,trackInfo:k}))})}unpublishTrack(a,b){return di(this,void 0,void 0,function*(){var c,d;if(fk(a)){let b=this.pendingPublishPromises.get(a);b&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),eI(a))),yield b)}let e=this.getPublicationForTrack(a),f=e?eI(e):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),f)),!e||!e.track)return void this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),f));(a=e.track).off(hG.Muted,this.onTrackMuted),a.off(hG.Unmuted,this.onTrackUnmuted),a.off(hG.Ended,this.handleTrackEnded),a.off(hG.UpstreamPaused,this.onTrackUpstreamPaused),a.off(hG.UpstreamResumed,this.onTrackUpstreamResumed),a.off(hG.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),void 0===b&&(b=null==(d=null==(c=this.roomOptions)?void 0:c.stopLocalTrackOnUnpublish)||d),b?a.stop():a.stopMonitor();let g=!1,h=a.sender;if(a.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<hW.FAILED&&h)try{for(let a of this.engine.pcManager.publisher.getTransceivers())a.sender===h&&(a.direction="inactive",g=!0);if(this.engine.removeTrack(h)&&(g=!0),fn(a)){for(let[,b]of a.simulcastCodecs)b.sender&&(this.engine.removeTrack(b.sender)&&(g=!0),b.sender=void 0);a.simulcastCodecs.clear()}}catch(a){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),f),{error:a}))}switch(this.trackPublications.delete(e.trackSid),e.kind){case eM.Kind.Audio:this.audioTrackPublications.delete(e.trackSid);break;case eM.Kind.Video:this.videoTrackPublications.delete(e.trackSid)}return this.emit(hE.LocalTrackUnpublished,e),e.setTrack(void 0),g&&(yield this.engine.negotiate()),e})}unpublishTracks(a){return di(this,void 0,void 0,function*(){return(yield Promise.all(a.map(a=>this.unpublishTrack(a)))).filter(a=>!!a)})}republishAllTracks(a){return di(this,arguments,void 0,function(a){var b=this;let c=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return function*(){b.republishPromise&&(yield b.republishPromise),b.republishPromise=new Promise((d,e)=>di(b,void 0,void 0,function*(){try{let b=[];this.trackPublications.forEach(c=>{c.track&&(a&&(c.options=Object.assign(Object.assign({},c.options),a)),b.push(c))}),yield Promise.all(b.map(a=>di(this,void 0,void 0,function*(){let b=a.track;yield this.unpublishTrack(b,!1),c&&!b.isMuted&&b.source!==eM.Source.ScreenShare&&b.source!==eM.Source.ScreenShareAudio&&(fo(b)||fn(b))&&!b.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:a.trackSid})),yield b.restartTrack()),yield this.publishOrRepublishTrack(b,a.options,!0)}))),d()}catch(a){e(a)}finally{this.republishPromise=void 0}})),yield b.republishPromise}()})}publishData(a){return di(this,arguments,void 0,function(a){var b=this;let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){let d=c.reliable?bu.RELIABLE:bu.LOSSY,e=c.destinationIdentities,f=c.topic,g=new bt({kind:d,value:{case:"user",value:new bz({participantIdentity:b.identity,payload:a,destinationIdentities:e,topic:f})}});yield b.engine.sendDataPacket(g,d)}()})}publishDtmf(a,b){return di(this,void 0,void 0,function*(){let c=new bt({kind:bu.RELIABLE,value:{case:"sipDtmf",value:new bA({code:a,digit:b})}});yield this.engine.sendDataPacket(c,bu.RELIABLE)})}sendChatMessage(a,b){return di(this,void 0,void 0,function*(){let c={id:crypto.randomUUID(),message:a,timestamp:Date.now(),attachedFiles:null==b?void 0:b.attachments},d=new bt({value:{case:"chatMessage",value:new bD(Object.assign(Object.assign({},c),{timestamp:ad.parse(c.timestamp)}))}});return yield this.engine.sendDataPacket(d,bu.RELIABLE),this.emit(hE.ChatMessage,c),c})}editChatMessage(a,b){return di(this,void 0,void 0,function*(){let c=Object.assign(Object.assign({},b),{message:a,editTimestamp:Date.now()}),d=new bt({value:{case:"chatMessage",value:new bD(Object.assign(Object.assign({},c),{timestamp:ad.parse(c.timestamp),editTimestamp:ad.parse(c.editTimestamp)}))}});return yield this.engine.sendDataPacket(d,bu.RELIABLE),this.emit(hE.ChatMessage,c),c})}sendText(a,b){return di(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(a,b)})}streamText(a){return di(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(a)})}sendFile(a,b){return di(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(a,b)})}streamBytes(a){return di(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(a)})}performRpc(a){return di(this,arguments,void 0,function(a){var b=this;let{destinationIdentity:c,method:d,payload:e,responseTimeout:f=15e3}=a;return function*(){return new Promise((a,g)=>di(b,void 0,void 0,function*(){var b,h,i,j;if(f1(e)>15360)return void g(f0.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));if((null==(h=null==(b=this.engine.latestJoinResponse)?void 0:b.serverInfo)?void 0:h.version)&&0>e5(null==(j=null==(i=this.engine.latestJoinResponse)?void 0:i.serverInfo)?void 0:j.version,"1.8.0"))return void g(f0.builtIn("UNSUPPORTED_SERVER"));let k=Math.max(f,8e3),l=crypto.randomUUID();yield this.publishRpcRequest(c,l,d,e,k);let m=setTimeout(()=>{this.pendingAcks.delete(l),g(f0.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(l),clearTimeout(n)},7e3);this.pendingAcks.set(l,{resolve:()=>{clearTimeout(m)},participantIdentity:c});let n=setTimeout(()=>{this.pendingResponses.delete(l),g(f0.builtIn("RESPONSE_TIMEOUT"))},f);this.pendingResponses.set(l,{resolve:(b,c)=>{clearTimeout(n),this.pendingAcks.has(l)&&(this.log.warn("RPC response received before ack",l),this.pendingAcks.delete(l),clearTimeout(m)),c?g(c):a(null!=b?b:"")},participantIdentity:c})}))}()})}registerRpcMethod(a,b){this.rpcHandlers.has(a)&&this.log.warn("you're overriding the RPC handler for method ".concat(a,", in the future this will throw an error")),this.rpcHandlers.set(a,b)}unregisterRpcMethod(a){this.rpcHandlers.delete(a)}setTrackSubscriptionPermissions(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.participantTrackPermissions=b,this.allParticipantsAllowedToSubscribe=a,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(a){let b=this.pendingAcks.get(a);b?(b.resolve(),this.pendingAcks.delete(a)):console.error("Ack received for unexpected RPC request",a)}handleIncomingRpcResponse(a,b,c){let d=this.pendingResponses.get(a);d?(d.resolve(b,c),this.pendingResponses.delete(a)):console.error("Response received for unexpected RPC request",a)}publishRpcRequest(a,b,c,d,e){return di(this,void 0,void 0,function*(){let f=new bt({destinationIdentities:[a],kind:bu.RELIABLE,value:{case:"rpcRequest",value:new bE({id:b,method:c,payload:d,responseTimeoutMs:e,version:1})}});yield this.engine.sendDataPacket(f,bu.RELIABLE)})}handleParticipantDisconnected(a){for(let[b,{participantIdentity:c}]of this.pendingAcks)c===a&&this.pendingAcks.delete(b);for(let[b,{participantIdentity:c,resolve:d}]of this.pendingResponses)c===a&&(d(null,f0.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(b))}setEnabledPublishCodecs(a){this.enabledPublishVideoCodecs=a.filter(a=>"video"===a.mime.split("/")[0].toLowerCase())}updateInfo(a){return!!super.updateInfo(a)&&(a.tracks.forEach(a=>{var b,c;let d=this.trackPublications.get(a.sid);if(d){let e=d.isMuted||null!=(c=null==(b=d.track)?void 0:b.isUpstreamPaused)&&c;e!==a.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),eI(d)),{mutedOnServer:e})),this.engine.client.sendMuteTrack(a.sid,e))}}),!0)}setActiveAgent(a){var b,c,d,e;this.firstActiveAgent=a,a&&!this.firstActiveAgent&&(this.firstActiveAgent=a),a?null==(c=null==(b=this.activeAgentFuture)?void 0:b.resolve)||c.call(b,a):null==(e=null==(d=this.activeAgentFuture)?void 0:d.reject)||e.call(d,Error("Agent disconnected")),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new fe),this.activeAgentFuture.promise)}getPublicationForTrack(a){let b;return this.trackPublications.forEach(c=>{let d=c.track;d&&(a instanceof MediaStreamTrack?(fo(d)||fn(d))&&d.mediaStreamTrack===a&&(b=c):a===d&&(b=c))}),b}waitForPendingPublicationOfSource(a){return di(this,void 0,void 0,function*(){let b=Date.now();for(;Date.now()<b+1e4;){let b=Array.from(this.pendingPublishPromises.entries()).find(b=>{let[c]=b;return c.source===a});if(b)return b[1];yield eQ(20)}})}}class gM extends gH{constructor(a,b,c,d){super(a,b.sid,b.name,d),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=a=>{this.setTrack(void 0),this.emit(hG.Ended,a)},this.handleVisibilityChange=a=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(a),this.logContext),this.visible=a,this.emitTrackUpdate()},this.handleVideoDimensionsChange=a=>{this.log.debug("adaptivestream video dimensions ".concat(a.width,"x").concat(a.height),this.logContext),this.videoDimensionsAdaptiveStream=a,this.emitTrackUpdate()},this.subscribed=c,this.updateInfo(b)}setSubscribed(a){let b=this.subscriptionStatus,c=this.permissionStatus;this.subscribed=a,a&&(this.allowed=!0);let d=new cz({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new bI({participantSid:"",trackSids:[this.trackSid]})]});this.emit(hG.UpdateSubscription,d),this.emitSubscriptionUpdateIfChanged(b),this.emitPermissionUpdateIfChanged(c)}get subscriptionStatus(){return!1===this.subscribed?gH.SubscriptionStatus.Unsubscribed:super.isSubscribed?gH.SubscriptionStatus.Subscribed:gH.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?gH.PermissionStatus.Allowed:gH.PermissionStatus.NotAllowed}get isSubscribed(){return!1!==this.subscribed&&super.isSubscribed}get isDesired(){return!1!==this.subscribed}get isEnabled(){return void 0!==this.requestedDisabled?!this.requestedDisabled:!this.isAdaptiveStream||this.visible}get isLocal(){return!1}setEnabled(a){this.isManualOperationAllowed()&&!a!==this.requestedDisabled&&(this.requestedDisabled=!a,this.emitTrackUpdate())}setVideoQuality(a){this.isManualOperationAllowed()&&this.requestedMaxQuality!==a&&(this.requestedMaxQuality=a,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(a){var b,c;this.isManualOperationAllowed()&&((null==(b=this.requestedVideoDimensions)?void 0:b.width)!==a.width||(null==(c=this.requestedVideoDimensions)?void 0:c.height)!==a.height)&&(fq(this.track)&&(this.requestedVideoDimensions=a),this.requestedMaxQuality=void 0,this.emitTrackUpdate())}setVideoFPS(a){this.isManualOperationAllowed()&&fq(this.track)&&this.fps!==a&&(this.fps=a,this.emitTrackUpdate())}get videoQuality(){var a;return null!=(a=this.requestedMaxQuality)?a:hJ.HIGH}setTrack(a){let b=this.subscriptionStatus,c=this.permissionStatus,d=this.track;d!==a&&(d&&(d.off(hG.VideoDimensionsChanged,this.handleVideoDimensionsChange),d.off(hG.VisibilityChanged,this.handleVisibilityChange),d.off(hG.Ended,this.handleEnded),d.detach(),d.stopMonitor(),this.emit(hG.Unsubscribed,d)),super.setTrack(a),a&&(a.sid=this.trackSid,a.on(hG.VideoDimensionsChanged,this.handleVideoDimensionsChange),a.on(hG.VisibilityChanged,this.handleVisibilityChange),a.on(hG.Ended,this.handleEnded),this.emit(hG.Subscribed,a)),this.emitPermissionUpdateIfChanged(c),this.emitSubscriptionUpdateIfChanged(b))}setAllowed(a){let b=this.subscriptionStatus,c=this.permissionStatus;this.allowed=a,this.emitPermissionUpdateIfChanged(c),this.emitSubscriptionUpdateIfChanged(b)}setSubscriptionError(a){this.emit(hG.SubscriptionFailed,a)}updateInfo(a){super.updateInfo(a);let b=this.metadataMuted;this.metadataMuted=a.muted,this.track?this.track.setMuted(a.muted):b!==a.muted&&this.emit(a.muted?hG.Muted:hG.Unmuted)}emitSubscriptionUpdateIfChanged(a){let b=this.subscriptionStatus;a!==b&&this.emit(hG.SubscriptionStatusChanged,b,a)}emitPermissionUpdateIfChanged(a){this.permissionStatus!==a&&this.emit(hG.SubscriptionPermissionChanged,this.permissionStatus,a)}isManualOperationAllowed(){return!!this.isDesired||(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return fq(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){let a=new cA({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===eM.Kind.Video){let e=this.requestedVideoDimensions;if(void 0!==this.videoDimensionsAdaptiveStream)if(e)eK(this.videoDimensionsAdaptiveStream,e)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),e=this.videoDimensionsAdaptiveStream);else if(void 0!==this.requestedMaxQuality&&this.trackInfo){var b,c,d;let a=(b=this.trackInfo,c=this.requestedMaxQuality,null==(d=b.layers)?void 0:d.find(a=>a.quality===c));a&&eK(this.videoDimensionsAdaptiveStream,a)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),e=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),e=this.videoDimensionsAdaptiveStream;e?(a.width=Math.ceil(e.width),a.height=Math.ceil(e.height)):void 0!==this.requestedMaxQuality?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),a.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:hJ.HIGH})),a.quality=hJ.HIGH)}this.emit(hG.UpdateSettings,a)}}class gN extends gK{static fromParticipantInfo(a,b,c){return new gN(a,b.sid,b.identity,b.name,b.metadata,b.attributes,c,b.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(a,b,c,d,e,f,g){let h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:bm.STANDARD;super(b,c||"",d,e,f,g,h),this.signalClient=a,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(a){super.addTrackPublication(a),a.on(hG.UpdateSettings,b=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),eI(a)),{settings:b})),this.signalClient.sendUpdateTrackSettings(b)}),a.on(hG.UpdateSubscription,a=>{a.participantTracks.forEach(a=>{a.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(a)}),a.on(hG.SubscriptionPermissionChanged,b=>{this.emit(hE.TrackSubscriptionPermissionChanged,a,b)}),a.on(hG.SubscriptionStatusChanged,b=>{this.emit(hE.TrackSubscriptionStatusChanged,a,b)}),a.on(hG.Subscribed,b=>{this.emit(hE.TrackSubscribed,b,a)}),a.on(hG.Unsubscribed,b=>{this.emit(hE.TrackUnsubscribed,b,a)}),a.on(hG.SubscriptionFailed,b=>{this.emit(hE.TrackSubscriptionFailed,a.trackSid,b)})}getTrackPublication(a){let b=super.getTrackPublication(a);if(b)return b}getTrackPublicationByName(a){let b=super.getTrackPublicationByName(a);if(b)return b}setVolume(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:eM.Source.Microphone;this.volumeMap.set(b,a);let c=this.getTrackPublication(b);c&&c.track&&c.track.setVolume(a)}getVolume(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:eM.Source.Microphone,b=this.getTrackPublication(a);return b&&b.track?b.track.getVolume():this.volumeMap.get(a)}addSubscribedMediaTrack(a,b,c,d,e,f){let g,h=this.getTrackPublicationBySid(b);if(h||b.startsWith("TR")||this.trackPublications.forEach(b=>{h||a.kind!==b.kind.toString()||(h=b)}),!h){if(0===f){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:b})),this.emit(hE.TrackSubscriptionFailed,b);return}void 0===f&&(f=20),setTimeout(()=>{this.addSubscribedMediaTrack(a,b,c,d,e,f-1)},150);return}if("ended"===a.readyState){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),eI(h))),this.emit(hE.TrackSubscriptionFailed,b);return}return(g="video"===a.kind?new gD(a,b,d,e):new gC(a,b,d,this.audioContext,this.audioOutput)).source=h.source,g.isMuted=h.isMuted,g.setMediaStream(c),g.start(),h.setTrack(g),this.volumeMap.has(h.source)&&fp(g)&&fl(g)&&g.setVolume(this.volumeMap.get(h.source)),h}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(a){return this.trackPublications.get(a)}updateInfo(a){if(!super.updateInfo(a))return!1;let b=new Map,c=new Map;return a.tracks.forEach(a=>{var d,e;let f=this.getTrackPublicationBySid(a.sid);if(f)f.updateInfo(a);else{let b=eM.kindFromProto(a.type);if(!b)return;(f=new gM(b,a,null==(d=this.signalClient.connectOptions)?void 0:d.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:null==(e=this.loggerOptions)?void 0:e.loggerName})).updateInfo(a),c.set(a.sid,f);let g=Array.from(this.trackPublications.values()).find(a=>a.source===(null==f?void 0:f.source));g&&f.source!==eM.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(f.source),Object.assign(Object.assign({},this.logContext),{oldTrack:eI(g),newTrack:eI(f)})),this.addTrackPublication(f)}b.set(a.sid,f)}),this.trackPublications.forEach(a=>{b.has(a.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),eI(a))),this.unpublishTrack(a.trackSid,!0))}),c.forEach(a=>{this.emit(hE.TrackPublished,a)}),!0}unpublishTrack(a,b){let c=this.trackPublications.get(a);if(!c)return;let{track:d}=c;switch(d&&(d.stop(),c.setTrack(void 0)),this.trackPublications.delete(a),c.kind){case eM.Kind.Audio:this.audioTrackPublications.delete(a);break;case eM.Kind.Video:this.videoTrackPublications.delete(a)}b&&this.emit(hE.TrackUnpublished,c)}setAudioOutput(a){return di(this,void 0,void 0,function*(){this.audioOutput=a;let b=[];this.audioTrackPublications.forEach(c=>{var d;fl(c.track)&&fp(c.track)&&b.push(c.track.setSinkId(null!=(d=a.deviceId)?d:"default"))}),yield Promise.all(b)})}emit(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:a,args:c})),super.emit(a,...c)}}(hq=hZ||(hZ={})).Disconnected="disconnected",hq.Connecting="connecting",hq.Connected="connected",hq.Reconnecting="reconnecting",hq.SignalReconnecting="signalReconnecting";class gO extends dl.EventEmitter{get hasE2EESetup(){return void 0!==this.e2eeManager}constructor(a){var b,c,d,e;if(super(),b=this,this.state=hZ.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=de,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(a,b,c)=>di(this,void 0,void 0,function*(){var d;if(!("undefined"!=typeof RTCPeerConnection&&(eR()||eS())))if(e_())throw Error("WebRTC isn't detected, have you called registerGlobals?");else throw Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");let e=yield this.disconnectLock.lock();if(this.state===hZ.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),e(),Promise.resolve();if(this.connectFuture)return e(),this.connectFuture.promise;this.setAndEmitConnectionState(hZ.Connecting),(null==(d=this.regionUrlProvider)?void 0:d.getServerUrl().toString())!==fr(a)&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),e0(new URL(a))&&(void 0===this.regionUrlProvider?this.regionUrlProvider=new f_(a,b):this.regionUrlProvider.updateToken(b),this.regionUrlProvider.fetchRegionSettings().then(a=>{var b;null==(b=this.regionUrlProvider)||b.setServerReportedRegions(a)}).catch(a=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:a}))}));let f=(d,g,h)=>di(this,void 0,void 0,function*(){var i,j;this.abortController&&this.abortController.abort();let k=new AbortController;this.abortController=k,null==e||e();try{if(yield fx.getInstance().getBackOffPromise(a),k.signal.aborted)throw ej.cancelled("Connection attempt aborted");yield this.attemptConnection(null!=h?h:a,b,c,k),this.abortController=void 0,d()}catch(b){if(this.regionUrlProvider&&b instanceof ej&&b.reason!==hA.Cancelled&&b.reason!==hA.NotAllowed){let c=null;try{this.log.debug("Fetching next region"),c=yield this.regionUrlProvider.getNextBestRegionUrl(null==(i=this.abortController)?void 0:i.signal)}catch(a){if(a instanceof ej&&(401===a.status||a.reason===hA.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),g(a);return}}[hA.InternalError,hA.ServerUnreachable,hA.Timeout].includes(b.reason)&&(this.log.debug("Adding failed connection attempt to back off"),fx.getInstance().addFailedConnectionAttempt(a)),!c||(null==(j=this.abortController)?void 0:j.signal.aborted)?(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,fh(b)),g(b)):(this.log.info("Initial connection failed with ConnectionError: ".concat(b.message,". Retrying with another region: ").concat(c),this.logContext),this.recreateEngine(),yield f(d,g,c))}else{let a=bd.UNKNOWN_REASON;b instanceof ej&&(a=fh(b)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,a),g(b)}}}),g=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new fe((a,b)=>{f(a,b,g)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(a,b,c,d,e,f)=>di(this,void 0,void 0,function*(){var g,h,i;let j=yield c.join(a,b,{autoSubscribe:d.autoSubscribe,adaptiveStream:"object"==typeof e.adaptiveStream||e.adaptiveStream,maxRetries:d.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:d.websocketTimeout,singlePeerConnection:e.singlePeerConnection},f.signal),k=j.serverInfo;if(k||(k={version:j.serverVersion,region:j.serverRegion}),this.serverInfo=k,this.log.debug("connected to Livekit Server ".concat(Object.entries(k).map(a=>{let[b,c]=a;return"".concat(b,": ").concat(c)}).join(", ")),{room:null==(g=j.room)?void 0:g.name,roomSid:null==(h=j.room)?void 0:h.sid,identity:null==(i=j.participant)?void 0:i.identity}),!k.version)throw new em("unknown server version");return"0.15.1"===k.version&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),e.dynacast=!1),j}),this.applyJoinResponse=a=>{let b=a.participant;if(this.localParticipant.sid=b.sid,this.localParticipant.identity=b.identity,this.localParticipant.setEnabledPublishCodecs(a.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(a.sifTrailer)}catch(a){this.log.error(a instanceof Error?a.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:a}))}this.handleParticipantUpdates([b,...a.otherParticipants]),a.room&&this.handleRoomUpdate(a.room)},this.attemptConnection=(a,b,c,d)=>di(this,void 0,void 0,function*(){var e,f;this.state===hZ.Reconnecting||this.isResuming||(null==(e=this.engine)?void 0:e.pendingReconnect)?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),(null==(f=this.regionUrlProvider)?void 0:f.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},fZ),c),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{let c=yield this.connectSignal(a,b,this.engine,this.connOptions,this.options,d);this.applyJoinResponse(c),this.setupLocalParticipantEvents(),this.emit(hD.SignalConnected)}catch(b){yield this.engine.close(),this.recreateEngine();let a=d.signal.aborted?ej.cancelled("Signal connection aborted"):ej.serverUnreachable("could not establish signal connection");throw b instanceof Error&&(a.message="".concat(a.message,": ").concat(b.message)),b instanceof ej&&(a.reason=b.reason,a.status=b.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:b})),a}if(d.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),ej.cancelled("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,d)}catch(a){throw yield this.engine.close(),this.recreateEngine(),a}e$()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),e$()&&window.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(hZ.Connected),this.emit(hD.Connected),fx.getInstance().resetFailedConnectionAttempts(a),this.registerConnectionReconcile(),this.regionUrlProvider&&this.regionUrlProvider.notifyConnected()}),this.disconnect=function(){for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];return di(b,[...c],void 0,function(){var a=this;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return function*(){var c,d,e;let f=yield a.disconnectLock.lock();try{if(a.state===hZ.Disconnected)return void a.log.debug("already disconnected",a.logContext);if(a.log.info("disconnect from room",Object.assign({},a.logContext)),a.state===hZ.Connecting||a.state===hZ.Reconnecting||a.isResuming){let b="Abort connection attempt due to user initiated disconnect";a.log.warn(b,a.logContext),null==(c=a.abortController)||c.abort(b),null==(e=null==(d=a.connectFuture)?void 0:d.reject)||e.call(d,ej.cancelled("Client initiated disconnect")),a.connectFuture=void 0}a.engine&&(a.engine.client.isDisconnected||(yield a.engine.client.sendLeave()),yield a.engine.close()),a.handleDisconnect(b,bd.CLIENT_INITIATED),a.engine=void 0}finally{f()}}()})},this.onPageLeave=()=>di(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>di(this,void 0,void 0,function*(){let a=[],b=ee();if(b&&"iOS"===b.os){let b="livekit-dummy-audio-el",c=document.getElementById(b);if(!c){(c=document.createElement("audio")).id=b,c.autoplay=!0,c.hidden=!0;let a=fd();a.enabled=!0;let d=new MediaStream([a]);c.srcObject=d,document.addEventListener("visibilitychange",()=>{c&&(c.srcObject=document.hidden?null:d,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(c),this.once(hD.Disconnected,()=>{null==c||c.remove(),c=null})}a.push(c)}this.remoteParticipants.forEach(b=>{b.audioTrackPublications.forEach(b=>{b.track&&b.track.attachedElements.forEach(b=>{a.push(b)})})});try{yield Promise.all([this.acquireAudioContext(),...a.map(a=>(a.muted=!1,a.play()))]),this.handleAudioPlaybackStarted()}catch(a){throw this.handleAudioPlaybackFailed(a),a}}),this.startVideo=()=>di(this,void 0,void 0,function*(){let a=[];for(let b of this.remoteParticipants.values())b.videoTrackPublications.forEach(b=>{var c;null==(c=b.track)||c.attachedElements.forEach(b=>{a.includes(b)||a.push(b)})});yield Promise.all(a.map(a=>a.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(a=>{"NotAllowedError"===a.name?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{for(let a of(this.clearConnectionReconcile(),this.isResuming=!1,this.remoteParticipants.values()))this.handleParticipantDisconnected(a.identity,a);this.setAndEmitConnectionState(hZ.Reconnecting)&&this.emit(hD.Reconnecting)},this.handleSignalRestarted=a=>di(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(a.serverRegion),Object.assign(Object.assign({},this.logContext),{region:a.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(a);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(a){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:a}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:a.serverRegion}))}catch(a){return}this.setAndEmitConnectionState(hZ.Connected),this.emit(hD.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=a=>{a.forEach(a=>{var b;if(a.identity===this.localParticipant.identity)return void this.localParticipant.updateInfo(a);""===a.identity&&(a.identity=null!=(b=this.sidToIdentity.get(a.sid))?b:"");let c=this.remoteParticipants.get(a.identity);a.state===bl.DISCONNECTED?this.handleParticipantDisconnected(a.identity,c):c=this.getOrCreateParticipant(a.identity,a)})},this.handleActiveSpeakersUpdate=a=>{let b=[],c={};a.forEach(a=>{if(c[a.sid]=!0,a.sid===this.localParticipant.sid)this.localParticipant.audioLevel=a.level,this.localParticipant.setIsSpeaking(!0),b.push(this.localParticipant);else{let c=this.getRemoteParticipantBySid(a.sid);c&&(c.audioLevel=a.level,c.setIsSpeaking(!0),b.push(c))}}),c[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(a=>{c[a.sid]||(a.audioLevel=0,a.setIsSpeaking(!1))}),this.activeSpeakers=b,this.emitWhenConnected(hD.ActiveSpeakersChanged,b)},this.handleSpeakersChanged=a=>{let b=new Map;this.activeSpeakers.forEach(a=>{let c=this.remoteParticipants.get(a.identity);c&&c.sid!==a.sid||b.set(a.sid,a)}),a.forEach(a=>{let c=this.getRemoteParticipantBySid(a.sid);a.sid===this.localParticipant.sid&&(c=this.localParticipant),c&&(c.audioLevel=a.level,c.setIsSpeaking(a.active),a.active?b.set(a.sid,c):b.delete(a.sid))});let c=Array.from(b.values());c.sort((a,b)=>b.audioLevel-a.audioLevel),this.activeSpeakers=c,this.emitWhenConnected(hD.ActiveSpeakersChanged,c)},this.handleStreamStateUpdate=a=>{a.streamStates.forEach(a=>{let b=this.getRemoteParticipantBySid(a.participantSid);if(!b)return;let c=b.getTrackPublicationBySid(a.trackSid);if(!c||!c.track)return;let d=eM.streamStateFromProto(a.state);c.track.setStreamState(d),d!==c.track.streamState&&(b.emit(hE.TrackStreamStateChanged,c,c.track.streamState),this.emitWhenConnected(hD.TrackStreamStateChanged,c,c.track.streamState,b))})},this.handleSubscriptionPermissionUpdate=a=>{let b=this.getRemoteParticipantBySid(a.participantSid);if(!b)return;let c=b.getTrackPublicationBySid(a.trackSid);c&&c.setAllowed(a.allowed)},this.handleSubscriptionError=a=>{let b=Array.from(this.remoteParticipants.values()).find(b=>b.trackPublications.has(a.trackSid));if(!b)return;let c=b.getTrackPublicationBySid(a.trackSid);c&&c.setSubscriptionError(a.err)},this.handleDataPacket=(a,b)=>{let c=this.remoteParticipants.get(a.participantIdentity);if("user"===a.value.case)this.handleUserPacket(c,a.value.value,a.kind,b);else if("transcription"===a.value.case)this.handleTranscription(c,a.value.value);else if("sipDtmf"===a.value.case)this.handleSipDtmf(c,a.value.value);else if("chatMessage"===a.value.case)this.handleChatMessage(c,a.value.value);else if("metrics"===a.value.case)this.handleMetrics(a.value.value,c);else if("streamHeader"===a.value.case||"streamChunk"===a.value.case||"streamTrailer"===a.value.case)this.handleDataStream(a,b);else if("rpcRequest"===a.value.case){let b=a.value.value;this.handleIncomingRpcRequest(a.participantIdentity,b.id,b.method,b.payload,b.responseTimeoutMs,b.version)}},this.handleUserPacket=(a,b,c,d)=>{this.emit(hD.DataReceived,b.payload,a,c,b.topic,d),null==a||a.emit(hE.DataReceived,b.payload,c,d)},this.handleSipDtmf=(a,b)=>{this.emit(hD.SipDTMFReceived,b,a),null==a||a.emit(hE.SipDTMFReceived,b)},this.handleTranscription=(a,b)=>{var c;let d=b.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(b.transcribedParticipantIdentity),e=null==d?void 0:d.trackPublications.get(b.trackId),f=(c=this.transcriptionReceivedTimes,b.segments.map(a=>{var b;let{id:d,text:e,language:f,startTime:g,endTime:h,final:i}=a,j=null!=(b=c.get(d))?b:Date.now(),k=Date.now();return i?c.delete(d):c.set(d,j),{id:d,text:e,startTime:Number.parseInt(g.toString()),endTime:Number.parseInt(h.toString()),final:i,language:f,firstReceivedTime:j,lastReceivedTime:k}}));null==e||e.emit(hG.TranscriptionReceived,f),null==d||d.emit(hE.TranscriptionReceived,f,e),this.emit(hD.TranscriptionReceived,f,d,e)},this.handleChatMessage=(a,b)=>{let c=function(a){let{id:b,timestamp:c,message:d,editTimestamp:e}=a;return{id:b,timestamp:Number.parseInt(c.toString()),editTimestamp:e?Number.parseInt(e.toString()):void 0,message:d}}(b);this.emit(hD.ChatMessage,c,a)},this.handleMetrics=(a,b)=>{this.emit(hD.MetricsReceived,a,b)},this.handleDataStream=(a,b)=>{this.incomingDataStreamManager.handleDataStreamPacket(a,b)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(hD.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=a=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:a})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(hD.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(hD.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(hD.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>di(this,void 0,void 0,function*(){var a;(null==(a=ee())?void 0:a.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(hD.MediaDevicesChanged)}),this.handleRoomUpdate=a=>{let b=this.roomInfo;this.roomInfo=a,b&&b.metadata!==a.metadata&&this.emitWhenConnected(hD.RoomMetadataChanged,a.metadata),(null==b?void 0:b.activeRecording)!==a.activeRecording&&this.emitWhenConnected(hD.RecordingStatusChanged,a.activeRecording)},this.handleConnectionQualityUpdate=a=>{a.updates.forEach(a=>{if(a.participantSid===this.localParticipant.sid)return void this.localParticipant.setConnectionQuality(a.quality);let b=this.getRemoteParticipantBySid(a.participantSid);b&&b.setConnectionQuality(a.quality)})},this.onLocalParticipantMetadataChanged=a=>{this.emit(hD.ParticipantMetadataChanged,a,this.localParticipant)},this.onLocalParticipantNameChanged=a=>{this.emit(hD.ParticipantNameChanged,a,this.localParticipant)},this.onLocalAttributesChanged=a=>{this.emit(hD.ParticipantAttributesChanged,a,this.localParticipant)},this.onLocalTrackMuted=a=>{this.emit(hD.TrackMuted,a,this.localParticipant)},this.onLocalTrackUnmuted=a=>{this.emit(hD.TrackUnmuted,a,this.localParticipant)},this.onTrackProcessorUpdate=a=>{var b;null==(b=null==a?void 0:a.onPublish)||b.call(a,this)},this.onLocalTrackPublished=a=>di(this,void 0,void 0,function*(){var b,c,d,e,f,g;null==(b=a.track)||b.on(hG.TrackProcessorUpdate,this.onTrackProcessorUpdate),null==(c=a.track)||c.on(hG.Restarted,this.onLocalTrackRestarted),null==(f=null==(e=null==(d=a.track)?void 0:d.getProcessor())?void 0:e.onPublish)||f.call(e,this),this.emit(hD.LocalTrackPublished,a,this.localParticipant),fo(a.track)&&(yield a.track.checkForSilence())&&this.emit(hD.LocalAudioSilenceDetected,a);let h=yield null==(g=a.track)?void 0:g.getDeviceId(!1),i=eG(a.source);i&&h&&h!==this.localParticipant.activeDeviceMap.get(i)&&(this.localParticipant.activeDeviceMap.set(i,h),this.emit(hD.ActiveDeviceChanged,i,h))}),this.onLocalTrackUnpublished=a=>{var b,c;null==(b=a.track)||b.off(hG.TrackProcessorUpdate,this.onTrackProcessorUpdate),null==(c=a.track)||c.off(hG.Restarted,this.onLocalTrackRestarted),this.emit(hD.LocalTrackUnpublished,a,this.localParticipant)},this.onLocalTrackRestarted=a=>di(this,void 0,void 0,function*(){let b=yield a.getDeviceId(!1),c=eG(a.source);c&&b&&b!==this.localParticipant.activeDeviceMap.get(c)&&(this.log.debug("local track restarted, setting ".concat(c," ").concat(b," active"),this.logContext),this.localParticipant.activeDeviceMap.set(c,b),this.emit(hD.ActiveDeviceChanged,c,b))}),this.onLocalConnectionQualityChanged=a=>{this.emit(hD.ConnectionQualityChanged,a,this.localParticipant)},this.onMediaDevicesError=(a,b)=>{this.emit(hD.MediaDevicesError,a,b)},this.onLocalParticipantPermissionsChanged=a=>{this.emit(hD.ParticipantPermissionsChanged,a,this.localParticipant)},this.onLocalChatMessageSent=a=>{this.emit(hD.ChatMessage,a,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},fY),a),this.log=df(null!=(c=this.options.loggerName)?c:hx.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},fW),null==a?void 0:a.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},fX),null==a?void 0:a.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},fV),null==a?void 0:a.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new gw,this.outgoingDataStreamManager=new gA(this.engine,this.log),this.disconnectLock=new M,this.localParticipant=new gL("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",ff(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",ff(this.options.audioCaptureDefaults.deviceId)),(null==(d=this.options.audioOutput)?void 0:d.deviceId)&&this.switchActiveDevice("audiooutput",ff(this.options.audioOutput.deviceId)).catch(a=>this.log.warn("Could not set audio output: ".concat(a.message),this.logContext)),e$()){const a=new AbortController;null==(e=navigator.mediaDevices)||e.addEventListener("devicechange",this.handleDeviceChange,{signal:a.signal}),gO.cleanupRegistry&&gO.cleanupRegistry.register(this,()=>{a.abort()})}}registerTextStreamHandler(a,b){return this.incomingDataStreamManager.registerTextStreamHandler(a,b)}unregisterTextStreamHandler(a){return this.incomingDataStreamManager.unregisterTextStreamHandler(a)}registerByteStreamHandler(a,b){return this.incomingDataStreamManager.registerByteStreamHandler(a,b)}unregisterByteStreamHandler(a){return this.incomingDataStreamManager.unregisterByteStreamHandler(a)}registerRpcMethod(a,b){if(this.rpcHandlers.has(a))throw Error("RPC handler already registered for method ".concat(a,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(a,b)}unregisterRpcMethod(a){this.rpcHandlers.delete(a)}setE2EEEnabled(a){return di(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(a)]),""!==this.localParticipant.identity&&this.e2eeManager.setParticipantCryptorEnabled(a,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var a;let b=!!this.options.encryption,c=this.options.encryption||this.options.e2ee;c&&("e2eeManager"in c?(this.e2eeManager=c.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=b):this.e2eeManager=new fw(c,b),this.e2eeManager.on(hM.ParticipantEncryptionStatusChanged,(a,b)=>{b.isLocal&&(this.isE2EEEnabled=a),this.emit(hD.ParticipantEncryptionStatusChanged,a,b)}),this.e2eeManager.on(hM.EncryptionError,(a,b)=>{let c=b?this.getParticipantByIdentity(b):void 0;this.emit(hD.EncryptionError,a,c)}),null==(a=this.e2eeManager)||a.setup(this))}get logContext(){var a;return{room:this.name,roomID:null==(a=this.roomInfo)?void 0:a.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var a,b;return null!=(b=null==(a=this.roomInfo)?void 0:a.activeRecording)&&b}getSid(){return di(this,void 0,void 0,function*(){return this.state===hZ.Disconnected?"":this.roomInfo&&""!==this.roomInfo.sid?this.roomInfo.sid:new Promise((a,b)=>{let c=b=>{""!==b.sid&&(this.engine.off(hF.RoomUpdate,c),a(b.sid))};this.engine.on(hF.RoomUpdate,c),this.once(hD.Disconnected,()=>{this.engine.off(hF.RoomUpdate,c),b("Room disconnected before room server id was available")})})})}get name(){var a,b;return null!=(b=null==(a=this.roomInfo)?void 0:a.name)?b:""}get metadata(){var a;return null==(a=this.roomInfo)?void 0:a.metadata}get numParticipants(){var a,b;return null!=(b=null==(a=this.roomInfo)?void 0:a.numParticipants)?b:0}get numPublishers(){var a,b;return null!=(b=null==(a=this.roomInfo)?void 0:a.numPublishers)?b:0}maybeCreateEngine(){(!this.engine||this.engine.isClosed)&&(this.engine=new gr(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(hF.ParticipantUpdate,this.handleParticipantUpdates).on(hF.RoomUpdate,this.handleRoomUpdate).on(hF.SpeakersChanged,this.handleSpeakersChanged).on(hF.StreamStateChanged,this.handleStreamStateUpdate).on(hF.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(hF.SubscriptionError,this.handleSubscriptionError).on(hF.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(hF.MediaTrackAdded,(a,b,c)=>{this.onTrackAdded(a,b,c)}).on(hF.Disconnected,a=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,a)}).on(hF.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(hF.DataPacketReceived,this.handleDataPacket).on(hF.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(hZ.SignalReconnecting)&&this.emit(hD.SignalReconnecting)}).on(hF.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(hZ.Connected)&&this.emit(hD.Reconnected)}).on(hF.SignalResumed,()=>{this.bufferedEvents=[],(this.state===hZ.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(hF.Restarting,this.handleRestarting).on(hF.SignalRestarted,this.handleSignalRestarted).on(hF.Offline,()=>{this.setAndEmitConnectionState(hZ.Reconnecting)&&this.emit(hD.Reconnecting)}).on(hF.DCBufferStatusChanged,(a,b)=>{this.emit(hD.DCBufferStatusChanged,a,b)}).on(hF.LocalTrackSubscribed,a=>{let b=this.localParticipant.getTrackPublications().find(b=>{let{trackSid:c}=b;return c===a});b?(this.localParticipant.emit(hE.LocalTrackSubscribed,b),this.emitWhenConnected(hD.LocalTrackSubscribed,b,this.localParticipant)):this.log.warn("could not find local track subscription for subscribed event",this.logContext)}).on(hF.RoomMoved,a=>{this.log.debug("room moved",a),a.room&&this.handleRoomUpdate(a.room),this.remoteParticipants.forEach((a,b)=>{this.handleParticipantDisconnected(b,a)}),this.emit(hD.Moved,a.room.name),a.participant?this.handleParticipantUpdates([a.participant,...a.otherParticipants]):this.handleParticipantUpdates(a.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(a){let b=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return fz.getInstance().getDevices(a,b)}prepareConnection(a,b){return di(this,void 0,void 0,function*(){if(this.state===hZ.Disconnected){this.log.debug("prepareConnection to ".concat(a),this.logContext);try{if(e0(new URL(a))&&b){this.regionUrlProvider=new f_(a,b);let c=yield this.regionUrlProvider.getNextBestRegionUrl();c&&this.state===hZ.Disconnected&&(this.regionUrl=c,yield fetch(fg(c),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(c),this.logContext))}else yield fetch(fg(a),{method:"HEAD"})}catch(a){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:a}))}}})}getParticipantByIdentity(a){return this.localParticipant.identity===a?this.localParticipant:this.remoteParticipants.get(a)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(a,b){return di(this,void 0,void 0,function*(){let c,d=()=>di(this,void 0,void 0,function*(){});switch(a){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":c=new cZ({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":c=new cZ({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":c=new cZ({scenario:{case:"serverLeave",value:!0}});break;case"migration":c=new cZ({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":d=()=>di(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),c=new cZ({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":d=()=>di(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),c=new cZ({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":c=new cZ({scenario:{case:"switchCandidateProtocol",value:"force-tls"===a?2:1}}),d=()=>di(this,void 0,void 0,function*(){let a=this.engine.client.onLeave;a&&a(new cD({reason:bd.CLIENT_INITIATED,action:cE.RECONNECT}))});break;case"subscriber-bandwidth":if(void 0===b||"number"!=typeof b)throw Error("subscriber-bandwidth requires a number as argument");c=new cZ({scenario:{case:"subscriberBandwidth",value:fj(b)}});break;case"leave-full-reconnect":c=new cZ({scenario:{case:"leaveRequestFullReconnect",value:!0}})}c&&(yield this.engine.client.sendSimulateScenario(c),yield d())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(a){return this.localParticipant.activeDeviceMap.get(a)}switchActiveDevice(a,b){return di(this,arguments,void 0,function(a,b){var c=this;let d=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return function*(){var e,f,g,h,i,j;let k=!0,l=!1,m=d?{exact:b}:b;if("audioinput"===a){l=0===c.localParticipant.audioTrackPublications.size;let b=null!=(e=c.getActiveDevice(a))?e:c.options.audioCaptureDefaults.deviceId;c.options.audioCaptureDefaults.deviceId=m;let d=Array.from(c.localParticipant.audioTrackPublications.values()).filter(a=>a.source===eM.Source.Microphone);try{k=(yield Promise.all(d.map(a=>{var b;return null==(b=a.audioTrack)?void 0:b.setDeviceId(m)}))).every(a=>!0===a)}catch(a){throw c.options.audioCaptureDefaults.deviceId=b,a}let f=d.some(a=>{var b,c;return null!=(c=null==(b=a.track)?void 0:b.isMuted)&&c});k&&f&&(l=!0)}else if("videoinput"===a){l=0===c.localParticipant.videoTrackPublications.size;let b=null!=(f=c.getActiveDevice(a))?f:c.options.videoCaptureDefaults.deviceId;c.options.videoCaptureDefaults.deviceId=m;let d=Array.from(c.localParticipant.videoTrackPublications.values()).filter(a=>a.source===eM.Source.Camera);try{k=(yield Promise.all(d.map(a=>{var b;return null==(b=a.videoTrack)?void 0:b.setDeviceId(m)}))).every(a=>!0===a)}catch(a){throw c.options.videoCaptureDefaults.deviceId=b,a}let e=d.some(a=>{var b,c;return null!=(c=null==(b=a.track)?void 0:b.isMuted)&&c});k&&e&&(l=!0)}else if("audiooutput"===a){if(l=!0,!eU()&&!c.options.webAudioMix||c.options.webAudioMix&&c.audioContext&&!("setSinkId"in c.audioContext))throw Error("cannot switch audio output, the current browser does not support it");c.options.webAudioMix&&(b=null!=(g=yield fz.getInstance().normalizeDeviceId("audiooutput",b))?g:""),null!=(j=c.options).audioOutput||(j.audioOutput={});let d=null!=(h=c.getActiveDevice(a))?h:c.options.audioOutput.deviceId;c.options.audioOutput.deviceId=b;try{c.options.webAudioMix&&(null==(i=c.audioContext)||i.setSinkId(b)),yield Promise.all(Array.from(c.remoteParticipants.values()).map(a=>a.setAudioOutput({deviceId:b})))}catch(a){throw c.options.audioOutput.deviceId=d,a}}return l&&(c.localParticipant.activeDeviceMap.set(a,b),c.emit(hD.ActiveDeviceChanged,a,b)),k}()})}setupLocalParticipantEvents(){this.localParticipant.on(hE.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(hE.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(hE.AttributesChanged,this.onLocalAttributesChanged).on(hE.TrackMuted,this.onLocalTrackMuted).on(hE.TrackUnmuted,this.onLocalTrackUnmuted).on(hE.LocalTrackPublished,this.onLocalTrackPublished).on(hE.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(hE.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(hE.MediaDevicesError,this.onMediaDevicesError).on(hE.AudioStreamAcquired,this.startAudio).on(hE.ChatMessage,this.onLocalChatMessageSent).on(hE.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var a;null==(a=this.engine)||a.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(a,b,c){var d;let e,f;if(this.state===hZ.Connecting||this.state===hZ.Reconnecting){let d=()=>{this.log.debug("deferring on track for later",{mediaTrackId:a.id,mediaStreamId:b.id,tracksInStream:b.getTracks().map(a=>a.id)}),this.onTrackAdded(a,b,c),e()},e=()=>{this.off(hD.Reconnected,d),this.off(hD.Connected,d),this.off(hD.Disconnected,e)};this.once(hD.Reconnected,d),this.once(hD.Connected,d),this.once(hD.Disconnected,e);return}if(this.state===hZ.Disconnected)return void this.log.warn("skipping incoming track after Room disconnected",this.logContext);if("ended"===a.readyState)return void this.log.info("skipping incoming track as it already ended",this.logContext);let g=(f=(d=b.id).split("|")).length>1?[f[0],d.substr(f[0].length+1)]:[d,""],h=g[0],i=g[1],j=a.id;if(i&&i.startsWith("TR")&&(j=i),h===this.localParticipant.sid)return void this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);let k=Array.from(this.remoteParticipants.values()).find(a=>a.sid===h);if(!k)return void this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(h),this.logContext);if(!j.startsWith("TR")){let a=this.engine.getTrackIdForReceiver(c);if(!a)return void this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(h),this.logContext);j=a}j.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(h,", streamId: ").concat(i,", trackId: ").concat(j),Object.assign(Object.assign({},this.logContext),{rpID:h,streamId:i,trackId:j})),this.options.adaptiveStream&&(e="object"==typeof this.options.adaptiveStream?this.options.adaptiveStream:{});let l=k.addSubscribedMediaTrack(a,j,b,c,e);(null==l?void 0:l.isEncrypted)&&!this.e2eeManager&&this.emit(hD.EncryptionError,Error("Encrypted ".concat(l.source," track received from participant ").concat(k.sid,", but room does not have encryption enabled!")))}handleDisconnect(){var a;let b=!(arguments.length>0)||void 0===arguments[0]||arguments[0],c=arguments.length>1?arguments[1]:void 0;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearControllers(),this.state!==hZ.Disconnected){this.regionUrl=void 0,this.regionUrlProvider&&this.regionUrlProvider.notifyDisconnected();try{this.remoteParticipants.forEach(a=>{a.trackPublications.forEach(b=>{a.unpublishTrack(b.trackSid)})}),this.localParticipant.trackPublications.forEach(a=>{var c,d,e;a.track&&this.localParticipant.unpublishTrack(a.track,b),b?(null==(c=a.track)||c.detach(),null==(d=a.track)||d.stop()):null==(e=a.track)||e.stopMonitor()}),this.localParticipant.off(hE.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(hE.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(hE.AttributesChanged,this.onLocalAttributesChanged).off(hE.TrackMuted,this.onLocalTrackMuted).off(hE.TrackUnmuted,this.onLocalTrackUnmuted).off(hE.LocalTrackPublished,this.onLocalTrackPublished).off(hE.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(hE.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(hE.MediaDevicesError,this.onMediaDevicesError).off(hE.AudioStreamAcquired,this.startAudio).off(hE.ChatMessage,this.onLocalChatMessageSent).off(hE.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&"boolean"==typeof this.options.webAudioMix&&(this.audioContext.close(),this.audioContext=void 0),e$()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),null==(a=navigator.mediaDevices)||a.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(hZ.Disconnected),this.emit(hD.Disconnected,c)}}}handleParticipantDisconnected(a,b){var c;this.remoteParticipants.delete(a),b&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(a),b.trackPublications.forEach(a=>{b.unpublishTrack(a.trackSid,!0)}),this.emit(hD.ParticipantDisconnected,b),b.setDisconnected(),null==(c=this.localParticipant)||c.handleParticipantDisconnected(b.identity))}handleIncomingRpcRequest(a,b,c,d,e,f){return di(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(a,b),1!==f)return void(yield this.engine.publishRpcResponse(a,b,null,f0.builtIn("UNSUPPORTED_VERSION")));let g=this.rpcHandlers.get(c);if(!g)return void(yield this.engine.publishRpcResponse(a,b,null,f0.builtIn("UNSUPPORTED_METHOD")));let h=null,i=null;try{let f=yield g({requestId:b,callerIdentity:a,payload:d,responseTimeout:e});f1(f)>15360?(h=f0.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),this.log.warn("RPC Response payload too large for ".concat(c))):i=f}catch(a){a instanceof f0?h=a:(this.log.warn("Uncaught error returned by RPC handler for ".concat(c,". Returning APPLICATION_ERROR instead."),a),h=f0.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(a,b,i,h)})}selectDefaultDevices(){return di(this,void 0,void 0,function*(){var a,b,c;let d=fz.getInstance().previousDevices,e=yield fz.getInstance().getDevices(void 0,!1),f=ee();if((null==f?void 0:f.name)==="Chrome"&&"iOS"!==f.os)for(let a of e){let b=d.find(b=>b.deviceId===a.deviceId);b&&""!==b.label&&b.kind===a.kind&&b.label!==a.label&&"default"===this.getActiveDevice(a.kind)&&this.emit(hD.ActiveDeviceChanged,a.kind,a.deviceId)}for(let f of["audiooutput","audioinput","videoinput"]){let g="audioinput"===f?eM.Source.Microphone:"videoinput"===f?eM.Source.Camera:eM.Source.Unknown,h=this.localParticipant.getTrackPublication(g);if(h&&(null==(a=h.track)?void 0:a.isUserProvided))continue;let i=e.filter(a=>a.kind===f),j=this.getActiveDevice(f);if(j===(null==(b=d.filter(a=>a.kind===f)[0])?void 0:b.deviceId)&&i.length>0&&(null==(c=i[0])?void 0:c.deviceId)!==j){yield this.switchActiveDevice(f,i[0].deviceId);continue}("audioinput"!==f||eY())&&"videoinput"!==f&&(!(i.length>0)||i.find(a=>a.deviceId===this.getActiveDevice(f))||"audiooutput"===f&&eY()||(yield this.switchActiveDevice(f,i[0].deviceId)))}})}acquireAudioContext(){return di(this,void 0,void 0,function*(){var a,b;if("boolean"!=typeof this.options.webAudioMix&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=null!=(a=eF())?a:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(a=>a.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&"suspended"===this.audioContext.state)try{yield Promise.race([this.audioContext.resume(),eQ(200)])}catch(a){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:a}))}let c=(null==(b=this.audioContext)?void 0:b.state)==="running";c!==this.canPlaybackAudio&&(this.audioEnabled=c,this.emit(hD.AudioPlaybackStatusChanged,c))})}createParticipant(a,b){var c;let d;return d=b?gN.fromParticipantInfo(this.engine.client,b,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):new gN(this.engine.client,"",a,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&d.setAudioContext(this.audioContext),(null==(c=this.options.audioOutput)?void 0:c.deviceId)&&d.setAudioOutput(this.options.audioOutput).catch(a=>this.log.warn("Could not set audio output: ".concat(a.message),this.logContext)),d}getOrCreateParticipant(a,b){if(this.remoteParticipants.has(a)){let c=this.remoteParticipants.get(a);return b&&c.updateInfo(b)&&this.sidToIdentity.set(b.sid,b.identity),c}let c=this.createParticipant(a,b);return this.remoteParticipants.set(a,c),this.sidToIdentity.set(b.sid,b.identity),this.emitWhenConnected(hD.ParticipantConnected,c),c.on(hE.TrackPublished,a=>{this.emitWhenConnected(hD.TrackPublished,a,c)}).on(hE.TrackSubscribed,(a,b)=>{a.kind===eM.Kind.Audio?(a.on(hG.AudioPlaybackStarted,this.handleAudioPlaybackStarted),a.on(hG.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):a.kind===eM.Kind.Video&&(a.on(hG.VideoPlaybackFailed,this.handleVideoPlaybackFailed),a.on(hG.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(hD.TrackSubscribed,a,b,c)}).on(hE.TrackUnpublished,a=>{this.emit(hD.TrackUnpublished,a,c)}).on(hE.TrackUnsubscribed,(a,b)=>{this.emit(hD.TrackUnsubscribed,a,b,c)}).on(hE.TrackMuted,a=>{this.emitWhenConnected(hD.TrackMuted,a,c)}).on(hE.TrackUnmuted,a=>{this.emitWhenConnected(hD.TrackUnmuted,a,c)}).on(hE.ParticipantMetadataChanged,a=>{this.emitWhenConnected(hD.ParticipantMetadataChanged,a,c)}).on(hE.ParticipantNameChanged,a=>{this.emitWhenConnected(hD.ParticipantNameChanged,a,c)}).on(hE.AttributesChanged,a=>{this.emitWhenConnected(hD.ParticipantAttributesChanged,a,c)}).on(hE.ConnectionQualityChanged,a=>{this.emitWhenConnected(hD.ConnectionQualityChanged,a,c)}).on(hE.ParticipantPermissionsChanged,a=>{this.emitWhenConnected(hD.ParticipantPermissionsChanged,a,c)}).on(hE.TrackSubscriptionStatusChanged,(a,b)=>{this.emitWhenConnected(hD.TrackSubscriptionStatusChanged,a,b,c)}).on(hE.TrackSubscriptionFailed,(a,b)=>{this.emit(hD.TrackSubscriptionFailed,a,c,b)}).on(hE.TrackSubscriptionPermissionChanged,(a,b)=>{this.emitWhenConnected(hD.TrackSubscriptionPermissionChanged,a,b,c)}).on(hE.Active,()=>{this.emitWhenConnected(hD.ParticipantActive,c),c.kind===bm.AGENT&&this.localParticipant.setActiveAgent(c)}),b&&c.updateInfo(b),c}sendSyncState(){let a=Array.from(this.remoteParticipants.values()).reduce((a,b)=>(a.push(...b.getTrackPublications()),a),[]),b=this.localParticipant.getTrackPublications();this.engine.sendSyncState(a,b)}updateSubscriptions(){for(let b of this.remoteParticipants.values())for(let c of b.videoTrackPublications.values()){var a;c.isSubscribed&&(a=c)&&!a.isLocal&&c.emitTrackUpdate()}}getRemoteParticipantBySid(a){let b=this.sidToIdentity.get(a);if(b)return this.remoteParticipants.get(b)}registerConnectionReconcile(){this.clearConnectionReconcile();let a=0;this.connectionReconcileInterval=et.setInterval(()=>{this.engine&&!this.engine.isClosed&&this.engine.verifyTransport()?a=0:(a++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:a,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),a>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,bd.STATE_MISMATCH)))},4e3)}clearConnectionReconcile(){this.connectionReconcileInterval&&et.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(a){return a!==this.state&&(this.state=a,this.emit(hD.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(a=>{let[b,c]=a;this.emit(b,...c)}),this.bufferedEvents=[]}emitWhenConnected(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];if(this.state===hZ.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([a,c]);else if(this.state===hZ.Connected)return this.emit(a,...c);return!1}simulateParticipants(a){return di(this,void 0,void 0,function*(){var b,c;let d=Object.assign({audio:!0,video:!0,useRealTracks:!1},a.publish),e=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},a.participants);if(this.handleDisconnect(),this.roomInfo=new bh({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:ad.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new bk({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(hD.SignalConnected),this.emit(hD.Connected),this.setAndEmitConnectionState(hZ.Connected),d.video){let a=new gI(eM.Kind.Video,new bq({source:a9.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:a8.AUDIO,name:"video-dummy"}),new gk(d.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:fc(160*(null!=(b=e.aspectRatios[0])?b:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(a),this.localParticipant.emit(hE.LocalTrackPublished,a)}if(d.audio){let a=new gI(eM.Kind.Audio,new bq({source:a9.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:a8.AUDIO}),new f8(d.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:fd(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(a),this.localParticipant.emit(hE.LocalTrackPublished,a)}for(let a=0;a<e.count-1;a+=1){let b=new bk({sid:Math.floor(1e4*Math.random()).toString(),identity:"simulated-".concat(a),state:bl.ACTIVE,tracks:[],joinedAt:ad.parse(Date.now())}),d=this.getOrCreateParticipant(b.identity,b);if(e.video){let f=fc(160*(null!=(c=e.aspectRatios[a%e.aspectRatios.length])?c:1),160,!1,!0),g=new bq({source:a9.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:a8.AUDIO});d.addSubscribedMediaTrack(f,g.sid,new MediaStream([f]),new RTCRtpReceiver),b.tracks=[...b.tracks,g]}if(e.audio){let a=fd(),c=new bq({source:a9.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:a8.AUDIO});d.addSubscribedMediaTrack(a,c.sid,new MediaStream([a]),new RTCRtpReceiver),b.tracks=[...b.tracks,c]}d.updateInfo(b)}})}emit(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];if(a!==hD.ActiveSpeakersChanged&&a!==hD.TranscriptionReceived){let b=(function a(b){return b.map(b=>{if(b)return Array.isArray(b)?a(b):"object"==typeof b?"logContext"in b?b.logContext:void 0:b})})(c).filter(a=>void 0!==a);(a===hD.TrackSubscribed||a===hD.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(a),Object.assign(Object.assign({},this.logContext),{event:a,args:b})),this.log.debug("room event ".concat(a),Object.assign(Object.assign({},this.logContext),{event:a,args:b}))}return super.emit(a,...c)}}gO.cleanupRegistry="undefined"!=typeof FinalizationRegistry&&new FinalizationRegistry(a=>{a()}),(hr=h$||(h$={}))[hr.IDLE=0]="IDLE",hr[hr.RUNNING=1]="RUNNING",hr[hr.SKIPPED=2]="SKIPPED",hr[hr.SUCCESS=3]="SUCCESS",hr[hr.FAILED=4]="FAILED";class gP extends dl.EventEmitter{constructor(a,b){let c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.status=h$.IDLE,this.logs=[],this.options={},this.url=a,this.token=b,this.name=this.constructor.name,this.room=new gO(c.roomOptions),this.connectOptions=c.connectOptions,this.options=c}run(a){return di(this,void 0,void 0,function*(){if(this.status!==h$.IDLE)throw Error("check is running already");this.setStatus(h$.RUNNING);try{yield this.perform()}catch(a){a instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(a.message):this.appendError(a.message))}return yield this.disconnect(),yield new Promise(a=>setTimeout(a,500)),this.status!==h$.SKIPPED&&this.setStatus(this.isSuccess()?h$.SUCCESS:h$.FAILED),a&&a(),this.getInfo()})}isSuccess(){return!this.logs.some(a=>"error"===a.level)}connect(a){return di(this,void 0,void 0,function*(){return this.room.state===hZ.Connected||(a||(a=this.url),yield this.room.connect(a,this.token,this.connectOptions)),this.room})}disconnect(){return di(this,void 0,void 0,function*(){this.room&&this.room.state!==hZ.Disconnected&&(yield this.room.disconnect(),yield new Promise(a=>setTimeout(a,500)))})}skip(){this.setStatus(h$.SKIPPED)}switchProtocol(a){return di(this,void 0,void 0,function*(){let b=!1,c=!1;if(this.room.on(hD.Reconnecting,()=>{b=!0}),this.room.once(hD.Reconnected,()=>{c=!0}),this.room.simulateScenario("force-".concat(a)),yield new Promise(a=>setTimeout(a,1e3)),!b)return;let d=Date.now()+1e4;for(;Date.now()<d;){if(c)return;yield eQ(100)}throw Error("Could not reconnect using ".concat(a," protocol after 10 seconds"))})}appendMessage(a){this.logs.push({level:"info",message:a}),this.emit("update",this.getInfo())}appendWarning(a){this.logs.push({level:"warning",message:a}),this.emit("update",this.getInfo())}appendError(a){this.logs.push({level:"error",message:a}),this.emit("update",this.getInfo())}setStatus(a){this.status=a,this.emit("update",this.getInfo())}get engine(){var a;return null==(a=this.room)?void 0:a.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}function gQ(a,b,c){var d;return(b="symbol"==typeof(d=function(a,b){if("object"!=typeof a||!a)return a;var c=a[Symbol.toPrimitive];if(void 0!==c){var d=c.call(a,b);if("object"!=typeof d)return d;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===b?String:Number)(a)}(b,"string"))?d:d+"")in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}dl.EventEmitter,new TextEncoder,new TextDecoder;class gR extends Error{constructor(a,b){var c;super(a,b),gQ(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,null==(c=Error.captureStackTrace)||c.call(Error,this,this.constructor)}}gQ(gR,"code","ERR_JOSE_GENERIC"),gQ(class extends gR{constructor(a,b){let c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(a,{cause:{claim:c,reason:d,payload:b}}),gQ(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),gQ(this,"claim",void 0),gQ(this,"reason",void 0),gQ(this,"payload",void 0),this.claim=c,this.reason=d,this.payload=b}},"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),gQ(class extends gR{constructor(a,b){let c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(a,{cause:{claim:c,reason:d,payload:b}}),gQ(this,"code","ERR_JWT_EXPIRED"),gQ(this,"claim",void 0),gQ(this,"reason",void 0),gQ(this,"payload",void 0),this.claim=c,this.reason=d,this.payload=b}},"code","ERR_JWT_EXPIRED"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}},"code","ERR_JOSE_ALG_NOT_ALLOWED"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JOSE_NOT_SUPPORTED")}},"code","ERR_JOSE_NOT_SUPPORTED"),gQ(class extends gR{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"decryption operation failed",b=arguments.length>1?arguments[1]:void 0;super(a,b),gQ(this,"code","ERR_JWE_DECRYPTION_FAILED")}},"code","ERR_JWE_DECRYPTION_FAILED"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JWE_INVALID")}},"code","ERR_JWE_INVALID"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JWS_INVALID")}},"code","ERR_JWS_INVALID"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JWT_INVALID")}},"code","ERR_JWT_INVALID"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JWK_INVALID")}},"code","ERR_JWK_INVALID"),gQ(class extends gR{constructor(){super(...arguments),gQ(this,"code","ERR_JWKS_INVALID")}},"code","ERR_JWKS_INVALID"),gQ(class extends gR{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no applicable key found in the JSON Web Key Set",b=arguments.length>1?arguments[1]:void 0;super(a,b),gQ(this,"code","ERR_JWKS_NO_MATCHING_KEY")}},"code","ERR_JWKS_NO_MATCHING_KEY"),gQ(class extends gR{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"multiple matching keys found in the JSON Web Key Set",b=arguments.length>1?arguments[1]:void 0;super(a,b),gQ(this,Symbol.asyncIterator,void 0),gQ(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}},"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS"),gQ(class extends gR{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"request timed out",b=arguments.length>1?arguments[1]:void 0;super(a,b),gQ(this,"code","ERR_JWKS_TIMEOUT")}},"code","ERR_JWKS_TIMEOUT"),gQ(class extends gR{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"signature verification failed",b=arguments.length>1?arguments[1]:void 0;super(a,b),gQ(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}},"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");var gS="u">typeof globalThis?globalThis:a.g;function gT(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var gU,gV,gW,gX,gY,gZ,g$,g_,g0,g1,g2,g3,g4,g5,g6,g7,g8,g9,ha,hb,hc,hd,he,hf,hg,hh,hi,hj,hk,hl,hm,hn,ho,hp,hq,hr,hs,ht,hu,hv,hw,hx,hy,hz,hA,hB,hC,hD,hE,hF,hG,hH,hI,hJ,hK,hL,hM,hN,hO,hP,hQ,hR,hS,hT,hU,hV,hW,hX,hY,hZ,h$,h_,h0={exports:{}},h1=h0.exports;let h2=gT((h_||(h_=1,jx=function(){var a=function(){},b="undefined",c=["trace","debug","info","warn","error"],d={},e=null;function f(a,b){var c=a[b];if("function"==typeof c.bind)return c.bind(a);try{return Function.prototype.bind.call(c,a)}catch{return function(){return Function.prototype.apply.apply(c,[a,arguments])}}}function g(){for(var d=this.getLevel(),e=0;e<c.length;e++){var f=c[e];this[f]=e<d?a:this.methodFactory(f,d,this.name)}if(this.log=this.debug,typeof console===b&&d<this.levels.SILENT)return"No console available for logging"}function h(a){return function(){typeof console!==b&&(g.call(this),this[a].apply(this,arguments))}}function i(c,d,e){var g;return"debug"===(g=c)&&(g="log"),typeof console!==b&&(void 0!==console[g]?f(console,g):void 0!==console.log?f(console,"log"):a)||h.apply(this,arguments)}function j(a,b){var f,h,j,k=this;function l(){}function m(a){var b=a;if("string"==typeof b&&void 0!==k.levels[b.toUpperCase()]&&(b=k.levels[b.toUpperCase()]),"number"==typeof b&&b>=0&&b<=k.levels.SILENT)return b;throw TypeError("log.setLevel() called with invalid level: "+a)}k.name=a,k.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},k.methodFactory=b||i,k.getLevel=function(){return j??h??f},k.setLevel=function(a,b){return j=m(a),!1!==b&&(c[j]||"silent").toUpperCase(),g.call(k)},k.setDefaultLevel=function(a){h=m(a),l()||k.setLevel(a,!1)},k.resetLevel=function(){j=null,g.call(k)},k.enableAll=function(a){k.setLevel(k.levels.TRACE,a)},k.disableAll=function(a){k.setLevel(k.levels.SILENT,a)},k.rebuild=function(){if(e!==k&&(f=m(e.getLevel())),g.call(k),e===k)for(var a in d)d[a].rebuild()},f=m(e?e.getLevel():"WARN");var n=l();null!=n&&(j=m(n)),g.call(k)}return(e=new j).getLogger=function(a){if("symbol"!=typeof a&&"string"!=typeof a||""===a)throw TypeError("You must supply a name when creating a logger.");var b=d[a];return b||(b=d[a]=new j(a,e.methodFactory)),b},e.noConflict=function(){return e},e.getLoggers=function(){return d},e.default=e,e},h0.exports?h0.exports=jx():h1.log=jx()),h0.exports));var h3=function(a,b){return(h3=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])})(a,b)};function h4(a,b){if("function"!=typeof b&&null!==b)throw TypeError("Class extends value "+String(b)+" is not a constructor or null");function c(){this.constructor=a}h3(a,b),a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)}function h5(a,b){var c,d,e,f={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]},g=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return g.next=h(0),g.throw=h(1),g.return=h(2),"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function h(h){return function(i){var j=[h,i];if(c)throw TypeError("Generator is already executing.");for(;g&&(g=0,j[0]&&(f=0)),f;)try{if(c=1,d&&(e=2&j[0]?d.return:j[0]?d.throw||((e=d.return)&&e.call(d),0):d.next)&&!(e=e.call(d,j[1])).done)return e;switch(d=0,e&&(j=[2&j[0],e.value]),j[0]){case 0:case 1:e=j;break;case 4:return f.label++,{value:j[1],done:!1};case 5:f.label++,d=j[1],j=[0];continue;case 7:j=f.ops.pop(),f.trys.pop();continue;default:if(!(e=(e=f.trys).length>0&&e[e.length-1])&&(6===j[0]||2===j[0])){f=0;continue}if(3===j[0]&&(!e||j[1]>e[0]&&j[1]<e[3])){f.label=j[1];break}if(6===j[0]&&f.label<e[1]){f.label=e[1],e=j;break}if(e&&f.label<e[2]){f.label=e[2],f.ops.push(j);break}e[2]&&f.ops.pop(),f.trys.pop();continue}j=b.call(a,f)}catch(a){j=[6,a],d=0}finally{c=e=0}if(5&j[0])throw j[1];return{value:j[0]?j[1]:void 0,done:!0}}}}function h6(a){var b="function"==typeof Symbol&&Symbol.iterator,c=b&&a[b],d=0;if(c)return c.call(a);if(a&&"number"==typeof a.length)return{next:function(){return a&&d>=a.length&&(a=void 0),{value:a&&a[d++],done:!a}}};throw TypeError(b?"Object is not iterable.":"Symbol.iterator is not defined.")}function h7(a,b){var c="function"==typeof Symbol&&a[Symbol.iterator];if(!c)return a;var d,e,f=c.call(a),g=[];try{for(;(void 0===b||b-- >0)&&!(d=f.next()).done;)g.push(d.value)}catch(a){e={error:a}}finally{try{d&&!d.done&&(c=f.return)&&c.call(f)}finally{if(e)throw e.error}}return g}function h8(a,b,c){if(c||2==arguments.length)for(var d,e=0,f=b.length;e<f;e++)!d&&e in b||(d||(d=Array.prototype.slice.call(b,0,e)),d[e]=b[e]);return a.concat(d||Array.prototype.slice.call(b))}function h9(a){return this instanceof h9?(this.v=a,this):new h9(a)}function ia(a){return"function"==typeof a}function ib(a){var b=a(function(a){Error.call(a),a.stack=Error().stack});return b.prototype=Object.create(Error.prototype),b.prototype.constructor=b,b}var ic=ib(function(a){return function(b){a(this),this.message=b?b.length+` errors occurred during unsubscription:
`+b.map(function(a,b){return b+1+") "+a.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=b}});function id(a,b){if(a){var c=a.indexOf(b);0<=c&&a.splice(c,1)}}var ie=function(){var a;function b(a){this.initialTeardown=a,this.closed=!1,this._parentage=null,this._finalizers=null}return b.prototype.unsubscribe=function(){var a,b,c,d,e;if(!this.closed){this.closed=!0;var f=this._parentage;if(f)if(this._parentage=null,Array.isArray(f))try{for(var g=h6(f),h=g.next();!h.done;h=g.next())h.value.remove(this)}catch(b){a={error:b}}finally{try{h&&!h.done&&(b=g.return)&&b.call(g)}finally{if(a)throw a.error}}else f.remove(this);var i=this.initialTeardown;if(ia(i))try{i()}catch(a){e=a instanceof ic?a.errors:[a]}var j=this._finalizers;if(j){this._finalizers=null;try{for(var k=h6(j),l=k.next();!l.done;l=k.next()){var m=l.value;try{ii(m)}catch(a){e=e??[],a instanceof ic?e=h8(h8([],h7(e)),h7(a.errors)):e.push(a)}}}catch(a){c={error:a}}finally{try{l&&!l.done&&(d=k.return)&&d.call(k)}finally{if(c)throw c.error}}}if(e)throw new ic(e)}},b.prototype.add=function(a){var c;if(a&&a!==this)if(this.closed)ii(a);else{if(a instanceof b){if(a.closed||a._hasParent(this))return;a._addParent(this)}(this._finalizers=null!=(c=this._finalizers)?c:[]).push(a)}},b.prototype._hasParent=function(a){var b=this._parentage;return b===a||Array.isArray(b)&&b.includes(a)},b.prototype._addParent=function(a){var b=this._parentage;this._parentage=Array.isArray(b)?(b.push(a),b):b?[b,a]:a},b.prototype._removeParent=function(a){var b=this._parentage;b===a?this._parentage=null:Array.isArray(b)&&id(b,a)},b.prototype.remove=function(a){var c=this._finalizers;c&&id(c,a),a instanceof b&&a._removeParent(this)},(a=new b).closed=!0,b.EMPTY=a,b}(),ig=ie.EMPTY;function ih(a){return a instanceof ie||a&&"closed"in a&&ia(a.remove)&&ia(a.add)&&ia(a.unsubscribe)}function ii(a){ia(a)?a():a.unsubscribe()}var ij=void 0,ik=function(a,b){for(var c=[],d=2;d<arguments.length;d++)c[d-2]=arguments[d];return setTimeout.apply(void 0,h8([a,b],h7(c)))};function il(a){ik(function(){throw a})}function im(){}var io=function(a){function b(b){var c=a.call(this)||this;return c.isStopped=!1,b?(c.destination=b,ih(b)&&b.add(c)):c.destination=ir,c}return h4(b,a),b.create=function(a,b,c){return new iq(a,b,c)},b.prototype.next=function(a){this.isStopped||this._next(a)},b.prototype.error=function(a){this.isStopped||(this.isStopped=!0,this._error(a))},b.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},b.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,a.prototype.unsubscribe.call(this),this.destination=null)},b.prototype._next=function(a){this.destination.next(a)},b.prototype._error=function(a){try{this.destination.error(a)}finally{this.unsubscribe()}},b.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},b}(ie),ip=function(){function a(a){this.partialObserver=a}return a.prototype.next=function(a){var b=this.partialObserver;if(b.next)try{b.next(a)}catch(a){il(a)}},a.prototype.error=function(a){var b=this.partialObserver;if(b.error)try{b.error(a)}catch(a){il(a)}else il(a)},a.prototype.complete=function(){var a=this.partialObserver;if(a.complete)try{a.complete()}catch(a){il(a)}},a}(),iq=function(a){function b(b,c,d){var e=a.call(this)||this;return e.destination=new ip(ia(b)||!b?{next:b??void 0,error:c??void 0,complete:d??void 0}:b),e}return h4(b,a),b}(io),ir={closed:!0,next:im,error:function(a){throw a},complete:im},is="function"==typeof Symbol&&Symbol.observable||"@@observable";function it(a){return a}var iu=function(){function a(a){a&&(this._subscribe=a)}return a.prototype.lift=function(b){var c=new a;return c.source=this,c.operator=b,c},a.prototype.subscribe=function(a,b,c){var d,e,f=this,g=!function(a){return a&&a instanceof io||a&&ia(a.next)&&ia(a.error)&&ia(a.complete)&&ih(a)}(a)?new iq(a,b,c):a;return d=f.operator,e=f.source,g.add(d?d.call(g,e):e?f._subscribe(g):f._trySubscribe(g)),g},a.prototype._trySubscribe=function(a){try{return this._subscribe(a)}catch(b){a.error(b)}},a.prototype.forEach=function(a,b){var c=this;return new(b=iv(b))(function(b,d){var e=new iq({next:function(b){try{a(b)}catch(a){d(a),e.unsubscribe()}},error:d,complete:b});c.subscribe(e)})},a.prototype._subscribe=function(a){var b;return null==(b=this.source)?void 0:b.subscribe(a)},a.prototype[is]=function(){return this},a.prototype.pipe=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return(0===a.length?it:1===a.length?a[0]:function(b){return a.reduce(function(a,b){return b(a)},b)})(this)},a.prototype.toPromise=function(a){var b=this;return new(a=iv(a))(function(a,c){var d;b.subscribe(function(a){return d=a},function(a){return c(a)},function(){return a(d)})})},a.create=function(b){return new a(b)},a}();function iv(a){var b;return null!=(b=a??ij)?b:Promise}function iw(a){return function(b){if(ia(null==b?void 0:b.lift))return b.lift(function(b){try{return a(b,this)}catch(a){this.error(a)}});throw TypeError("Unable to lift unknown Observable type")}}function ix(a,b,c,d,e){return new iy(a,b,c,d,e)}var iy=function(a){function b(b,c,d,e,f,g){var h=a.call(this,b)||this;return h.onFinalize=f,h.shouldUnsubscribe=g,h._next=c?function(a){try{c(a)}catch(a){b.error(a)}}:a.prototype._next,h._error=e?function(a){try{e(a)}catch(a){b.error(a)}finally{this.unsubscribe()}}:a.prototype._error,h._complete=d?function(){try{d()}catch(a){b.error(a)}finally{this.unsubscribe()}}:a.prototype._complete,h}return h4(b,a),b.prototype.unsubscribe=function(){var b;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var c=this.closed;a.prototype.unsubscribe.call(this),c||null==(b=this.onFinalize)||b.call(this)}},b}(io),iz=ib(function(a){return function(){a(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),iA=function(a){function b(){var b=a.call(this)||this;return b.closed=!1,b.currentObservers=null,b.observers=[],b.isStopped=!1,b.hasError=!1,b.thrownError=null,b}return h4(b,a),b.prototype.lift=function(a){var b=new iB(this,this);return b.operator=a,b},b.prototype._throwIfClosed=function(){if(this.closed)throw new iz},b.prototype.next=function(a){var b,c;if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));try{for(var d=h6(this.currentObservers),e=d.next();!e.done;e=d.next())e.value.next(a)}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}}},b.prototype.error=function(a){if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=a;for(var b=this.observers;b.length;)b.shift().error(a)}},b.prototype.complete=function(){if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;for(var a=this.observers;a.length;)a.shift().complete()}},b.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(b.prototype,"observed",{get:function(){var a;return(null==(a=this.observers)?void 0:a.length)>0},enumerable:!1,configurable:!0}),b.prototype._trySubscribe=function(b){return this._throwIfClosed(),a.prototype._trySubscribe.call(this,b)},b.prototype._subscribe=function(a){return this._throwIfClosed(),this._checkFinalizedStatuses(a),this._innerSubscribe(a)},b.prototype._innerSubscribe=function(a){var b=this,c=this.hasError,d=this.isStopped,e=this.observers;return c||d?ig:(this.currentObservers=null,e.push(a),new ie(function(){b.currentObservers=null,id(e,a)}))},b.prototype._checkFinalizedStatuses=function(a){var b=this.hasError,c=this.thrownError,d=this.isStopped;b?a.error(c):d&&a.complete()},b.prototype.asObservable=function(){var a=new iu;return a.source=this,a},b.create=function(a,b){return new iB(a,b)},b}(iu),iB=function(a){function b(b,c){var d=a.call(this)||this;return d.destination=b,d.source=c,d}return h4(b,a),b.prototype.next=function(a){var b,c;null==(c=null==(b=this.destination)?void 0:b.next)||c.call(b,a)},b.prototype.error=function(a){var b,c;null==(c=null==(b=this.destination)?void 0:b.error)||c.call(b,a)},b.prototype.complete=function(){var a,b;null==(b=null==(a=this.destination)?void 0:a.complete)||b.call(a)},b.prototype._subscribe=function(a){var b,c;return null!=(c=null==(b=this.source)?void 0:b.subscribe(a))?c:ig},b}(iA),iC=(function(a){function b(b){var c=a.call(this)||this;return c._value=b,c}h4(b,a),Object.defineProperty(b.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),b.prototype._subscribe=function(b){var c=a.prototype._subscribe.call(this,b);return c.closed||b.next(this._value),c},b.prototype.getValue=function(){var a=this.hasError,b=this.thrownError,c=this._value;if(a)throw b;return this._throwIfClosed(),c},b.prototype.next=function(b){a.prototype.next.call(this,this._value=b)}}(iA),function(){return Date.now()}),iD=function(a){function b(b,c){return a.call(this)||this}return h4(b,a),b.prototype.schedule=function(a,b){return this},b}(ie),iE=function(a,b){for(var c=[],d=2;d<arguments.length;d++)c[d-2]=arguments[d];return setInterval.apply(void 0,h8([a,b],h7(c)))},iF=function(a){function b(b,c){var d=a.call(this,b,c)||this;return d.scheduler=b,d.work=c,d.pending=!1,d}return h4(b,a),b.prototype.schedule=function(a,b){if(void 0===b&&(b=0),this.closed)return this;this.state=a;var c,d=this.id,e=this.scheduler;return null!=d&&(this.id=this.recycleAsyncId(e,d,b)),this.pending=!0,this.delay=b,this.id=null!=(c=this.id)?c:this.requestAsyncId(e,this.id,b),this},b.prototype.requestAsyncId=function(a,b,c){return void 0===c&&(c=0),iE(a.flush.bind(a,this),c)},b.prototype.recycleAsyncId=function(a,b,c){if(void 0===c&&(c=0),null!=c&&this.delay===c&&!1===this.pending)return b;null!=b&&clearInterval(b)},b.prototype.execute=function(a,b){if(this.closed)return Error("executing a cancelled action");this.pending=!1;var c=this._execute(a,b);if(c)return c;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},b.prototype._execute=function(a,b){var c,d=!1;try{this.work(a)}catch(a){d=!0,c=a||Error("Scheduled action threw falsy error")}if(d)return this.unsubscribe(),c},b.prototype.unsubscribe=function(){if(!this.closed){var b=this.id,c=this.scheduler,d=c.actions;this.work=this.state=this.scheduler=null,this.pending=!1,id(d,this),null!=b&&(this.id=this.recycleAsyncId(c,b,null)),this.delay=null,a.prototype.unsubscribe.call(this)}},b}(iD),iG=function(){function a(b,c){void 0===c&&(c=a.now),this.schedulerActionCtor=b,this.now=c}return a.prototype.schedule=function(a,b,c){return void 0===b&&(b=0),new this.schedulerActionCtor(this,a).schedule(c,b)},a.now=iC,a}();function iH(a){var b;return(b=a[a.length-1])&&ia(b.schedule)?a.pop():void 0}new(function(a){function b(b,c){void 0===c&&(c=iG.now);var d=a.call(this,b,c)||this;return d.actions=[],d._active=!1,d}return h4(b,a),b.prototype.flush=function(a){var b,c=this.actions;if(this._active)return void c.push(a);this._active=!0;do if(b=a.execute(a.state,a.delay))break;while(a=c.shift())if(this._active=!1,b){for(;a=c.shift();)a.unsubscribe();throw b}},b}(iG))(iF);var iI=function(a){return a&&"number"==typeof a.length&&"function"!=typeof a};function iJ(a){return ia(null==a?void 0:a.then)}function iK(a){return Symbol.asyncIterator&&ia(null==a?void 0:a[Symbol.asyncIterator])}function iL(a){return TypeError("You provided "+(null!==a&&"object"==typeof a?"an invalid object":"'"+a+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var iM="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function iN(a){return ia(null==a?void 0:a[iM])}function iO(a){return function(a,b,c){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var d,e=c.apply(a,b||[]),f=[];return d=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),g("next"),g("throw"),g("return",function(a){return function(b){return Promise.resolve(b).then(a,j)}}),d[Symbol.asyncIterator]=function(){return this},d;function g(a,b){e[a]&&(d[a]=function(b){return new Promise(function(c,d){f.push([a,b,c,d])>1||h(a,b)})},b&&(d[a]=b(d[a])))}function h(a,b){try{var c;(c=e[a](b)).value instanceof h9?Promise.resolve(c.value.v).then(i,j):k(f[0][2],c)}catch(a){k(f[0][3],a)}}function i(a){h("next",a)}function j(a){h("throw",a)}function k(a,b){a(b),f.shift(),f.length&&h(f[0][0],f[0][1])}}(this,arguments,function(){var b,c,d;return h5(this,function(e){switch(e.label){case 0:b=a.getReader(),e.label=1;case 1:e.trys.push([1,,9,10]),e.label=2;case 2:return[4,h9(b.read())];case 3:return d=(c=e.sent()).value,c.done?[4,h9(void 0)]:[3,5];case 4:return[2,e.sent()];case 5:return[4,h9(d)];case 6:return[4,e.sent()];case 7:return e.sent(),[3,2];case 8:return[3,10];case 9:return b.releaseLock(),[7];case 10:return[2]}})})}function iP(a){return ia(null==a?void 0:a.getReader)}function iQ(a){if(a instanceof iu)return a;if(null!=a){var b,c,d,e;if(ia(a[is])){return b=a,new iu(function(a){var c=b[is]();if(ia(c.subscribe))return c.subscribe(a);throw TypeError("Provided object does not correctly implement Symbol.observable")})}if(iI(a)){return c=a,new iu(function(a){for(var b=0;b<c.length&&!a.closed;b++)a.next(c[b]);a.complete()})}if(iJ(a)){return d=a,new iu(function(a){d.then(function(b){a.closed||(a.next(b),a.complete())},function(b){return a.error(b)}).then(null,il)})}if(iK(a))return iR(a);if(iN(a)){return e=a,new iu(function(a){var b,c;try{for(var d=h6(e),f=d.next();!f.done;f=d.next()){var g=f.value;if(a.next(g),a.closed)return}}catch(a){b={error:a}}finally{try{f&&!f.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}a.complete()})}if(iP(a))return iR(iO(a))}throw iL(a)}function iR(a){return new iu(function(b){(function(a,b){var c,d,e,f,g,h,i,j;return g=this,h=void 0,i=void 0,j=function(){var g;return h5(this,function(h){switch(h.label){case 0:h.trys.push([0,5,6,11]),c=function(a){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var b,c=a[Symbol.asyncIterator];return c?c.call(a):(a=h6(a),b={},d("next"),d("throw"),d("return"),b[Symbol.asyncIterator]=function(){return this},b);function d(c){b[c]=a[c]&&function(b){return new Promise(function(d,e){var f,g,h;f=d,g=e,h=(b=a[c](b)).done,Promise.resolve(b.value).then(function(a){f({value:a,done:h})},g)})}}}(a),h.label=1;case 1:return[4,c.next()];case 2:if((d=h.sent()).done)return[3,4];if(g=d.value,b.next(g),b.closed)return[2];h.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return e={error:h.sent()},[3,11];case 6:return h.trys.push([6,,9,10]),d&&!d.done&&(f=c.return)?[4,f.call(c)]:[3,8];case 7:h.sent(),h.label=8;case 8:return[3,10];case 9:if(e)throw e.error;return[7];case 10:return[7];case 11:return b.complete(),[2]}})},new(i||(i=Promise))(function(a,b){function c(a){try{e(j.next(a))}catch(a){b(a)}}function d(a){try{e(j.throw(a))}catch(a){b(a)}}function e(b){var e;b.done?a(b.value):((e=b.value)instanceof i?e:new i(function(a){a(e)})).then(c,d)}e((j=j.apply(g,h||[])).next())})})(a,b).catch(function(a){return b.error(a)})})}function iS(a,b,c,d,e){void 0===d&&(d=0),void 0===e&&(e=!1);var f=b.schedule(function(){c(),e?a.add(this.schedule(null,d)):this.unsubscribe()},d);if(a.add(f),!e)return f}function iT(a,b){return void 0===b&&(b=0),iw(function(c,d){c.subscribe(ix(d,function(c){return iS(d,a,function(){return d.next(c)},b)},function(){return iS(d,a,function(){return d.complete()},b)},function(c){return iS(d,a,function(){return d.error(c)},b)}))})}function iU(a,b){return void 0===b&&(b=0),iw(function(c,d){d.add(a.schedule(function(){return c.subscribe(d)},b))})}function iV(a,b){if(!a)throw Error("Iterable cannot be null");return new iu(function(c){iS(c,b,function(){var d=a[Symbol.asyncIterator]();iS(c,b,function(){d.next().then(function(a){a.done?c.complete():c.next(a.value)})},0,!0)})})}function iW(a,b){return iw(function(c,d){var e=0;c.subscribe(ix(d,function(c){d.next(a.call(b,c,e++))}))})}function iX(){for(var a,b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];return(function a(b,c,d){return void 0===d&&(d=1/0),ia(c)?a(function(a,d){return iW(function(b,e){return c(a,b,d,e)})(iQ(b(a,d)))},d):("number"==typeof c&&(d=c),iw(function(a,c){var e,f,g,h,i,j,k;return e=d,f=[],g=0,h=0,i=!1,j=function(){!i||f.length||g||c.complete()},k=function(a){g++;var d=!1;iQ(b(a,h++)).subscribe(ix(c,function(a){c.next(a)},function(){d=!0},void 0,function(){if(d)try{for(g--;f.length&&g<e;)!function(){var a=f.shift();k(a)}();j()}catch(a){c.error(a)}}))},a.subscribe(ix(c,function(a){return g<e?k(a):f.push(a)},function(){i=!0,j()})),function(){}}))})(it,1)((a=iH(b))?function(a,b){if(null!=a){if(ia(a[is]))return iQ(a).pipe(iU(b),iT(b));if(iI(a))return new iu(function(c){var d=0;return b.schedule(function(){d===a.length?c.complete():(c.next(a[d++]),c.closed||this.schedule())})});if(iJ(a))return iQ(a).pipe(iU(b),iT(b));if(iK(a))return iV(a,b);if(iN(a))return new iu(function(c){var d;return iS(c,b,function(){d=a[iM](),iS(c,b,function(){var a,b,e;try{b=(a=d.next()).value,e=a.done}catch(a){c.error(a);return}e?c.complete():c.next(b)},0,!0)}),function(){return ia(null==d?void 0:d.return)&&d.return()}});if(iP(a))return iV(iO(a),b)}throw iL(a)}(b,a):iQ(b))}ib(function(a){return function(b){void 0===b&&(b=null),a(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=b}});function iY(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];var c=iH(a);return iw(function(b,d){(c?iX(a,b,c):iX(a,b)).subscribe(d)})}Object.prototype.hasOwnProperty,Object.prototype.propertyIsEnumerable;var iZ=(a,b,c)=>new Promise((d,e)=>{var f=a=>{try{h(c.next(a))}catch(a){e(a)}},g=a=>{try{h(c.throw(a))}catch(a){e(a)}},h=a=>a.done?d(a.value):Promise.resolve(a.value).then(f,g);h((c=c.apply(a,b)).next())});function i$(a){var b,c,d;return!(typeof a>"u")&&(!!(b=a)&&b.hasOwnProperty("participant")&&b.hasOwnProperty("source")&&b.hasOwnProperty("track")&&"u">typeof(null==(c=b.publication)?void 0:c.track)||!!(d=a)&&d.hasOwnProperty("participant")&&d.hasOwnProperty("source")&&d.hasOwnProperty("publication")&&"u">typeof d.publication)}function i_(a){var b;if("string"==typeof a||"number"==typeof a)return`${a}`;if((b=a)&&b.hasOwnProperty("participant")&&b.hasOwnProperty("source")&&typeof b.publication>"u")return`${a.participant.identity}_${a.source}_placeholder`;if(i$(a))return`${a.participant.identity}_${a.publication.source}_${a.publication.trackSid}`;throw Error(`Can't generate a id for the given track reference: ${a}`)}var i0=[hD.ConnectionStateChanged,hD.RoomMetadataChanged,hD.ActiveSpeakersChanged,hD.ConnectionQualityChanged,hD.ParticipantConnected,hD.ParticipantDisconnected,hD.ParticipantPermissionsChanged,hD.ParticipantMetadataChanged,hD.ParticipantNameChanged,hD.ParticipantAttributesChanged,hD.TrackMuted,hD.TrackUnmuted,hD.TrackPublished,hD.TrackUnpublished,hD.TrackStreamStateChanged,hD.TrackSubscriptionFailed,hD.TrackSubscriptionPermissionChanged,hD.TrackSubscriptionStatusChanged,hD.LocalTrackPublished,hD.LocalTrackUnpublished],i1=([...(hE.TrackPublished,hE.TrackUnpublished,hE.TrackMuted,hE.TrackUnmuted,hE.TrackStreamStateChanged,hE.TrackSubscribed,hE.TrackUnsubscribed,hE.TrackSubscriptionPermissionChanged,hE.TrackSubscriptionFailed,hE.LocalTrackPublished,hE.LocalTrackUnpublished,[hE.ConnectionQualityChanged,hE.IsSpeakingChanged,hE.ParticipantMetadataChanged,hE.ParticipantPermissionsChanged,hE.TrackMuted,hE.TrackUnmuted,hE.TrackPublished,hE.TrackUnpublished,hE.TrackStreamStateChanged,hE.TrackSubscriptionFailed,hE.TrackSubscriptionPermissionChanged,hE.TrackSubscriptionStatusChanged]),hE.LocalTrackPublished,hE.LocalTrackUnpublished],h2.getLogger("lk-components-js"));i1.setDefaultLevel("WARN");var i2=((g=i2||{}).AgentState="lk.agent.state",g.PublishOnBehalf="lk.publish_on_behalf",g.TranscriptionFinal="lk.transcription_final",g.TranscriptionSegmentId="lk.segment_id",g.TranscribedTrackId="lk.transcribed_track_id",g);function i3(a){return"object"==typeof a}function i4(a){return Array.isArray(a)&&a.filter(i3).length>0}function i5(a){return`lk-${a}`}function i6(a){if(i$(a))return a.publication;{let{source:b,name:c,participant:d}=a;if(b&&c)return d.getTrackPublications().find(a=>a.source===b&&a.trackName===c);if(c)return d.getTrackPublicationByName(c);if(b)return d.getTrackPublication(b);throw Error("At least one of source and name needs to be defined")}}function i7(a,...b){return new iu(c=>{let d=()=>{c.next(a)};return b.forEach(b=>{a.on(b,d)}),()=>{b.forEach(b=>{a.off(b,d)})}}).pipe(iY(a))}function i8(a,...b){return new iu(c=>{let d=()=>{c.next(a)};return b.forEach(b=>{a.on(b,d)}),()=>{b.forEach(b=>{a.off(b,d)})}}).pipe(iY(a))}function i9(a){return i8(a,hE.TrackMuted,hE.TrackUnmuted,hE.ParticipantPermissionsChanged,hE.TrackPublished,hE.TrackUnpublished,hE.LocalTrackPublished,hE.LocalTrackUnpublished,hE.MediaDevicesError,hE.TrackSubscriptionStatusChanged).pipe(iW(a=>{let{isMicrophoneEnabled:b,isCameraEnabled:c,isScreenShareEnabled:d}=a,e=a.getTrackPublication(eM.Source.Microphone);return{isCameraEnabled:c,isMicrophoneEnabled:b,isScreenShareEnabled:d,cameraTrack:a.getTrackPublication(eM.Source.Camera),microphoneTrack:e,participant:a}}))}function ja(a){var b,c,d,e;return i8(a.participant,hE.TrackMuted,hE.TrackUnmuted,hE.TrackSubscribed,hE.TrackUnsubscribed,hE.LocalTrackPublished,hE.LocalTrackUnpublished).pipe(iW(b=>{var c,d;let e=null!=(c=a.publication)?c:b.getTrackPublication(a.source);return null==(d=null==e?void 0:e.isMuted)||d}),iY(null==(e=null!=(d=null==(b=a.publication)?void 0:b.isMuted)?d:null==(c=a.participant.getTrackPublication(a.source))?void 0:c.isMuted)||e))}function jb(a,b,c=!0){let d=[a.localParticipant,...Array.from(a.remoteParticipants.values())],e=[];return d.forEach(a=>{b.forEach(b=>{let d=Array.from(a.trackPublications.values()).filter(a=>a.source===b&&(!c||a.track)).map(b=>({participant:a,publication:b,source:b.source}));e.push(...d)})}),{trackReferences:e,participants:d}}var{load:jc,save:jd}=(jy="lk-user-choices",{load:()=>(function(a){if(typeof localStorage>"u")return void i1.error("Local storage is not available.");try{let b=localStorage.getItem(a);if(!b)return void i1.warn(`Item with key ${a} does not exist in local storage.`);return JSON.parse(b)}catch(a){i1.error(`Error getting item from local storage: ${a}`);return}})(jy),save:a=>(function(a,b){if(typeof localStorage>"u")return void i1.error("Local storage is not available.");try{if(b){let c=Object.fromEntries(Object.entries(b).filter(([,a])=>""!==a));localStorage.setItem(a,JSON.stringify(c))}}catch(a){i1.error(`Error setting item to local storage: ${a}`)}})(jy,a)});n.createContext(void 0);let je=n.createContext(void 0);function jf(){return n.useContext(je)}function jg(a){let b=jf(),c=a??b;if(!c)throw Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return c}let jh=n.createContext(void 0);function ji(a){let b=n.useContext(jh),c=jf(),d=a??b??(null==c?void 0:c.participant);if(!d)throw Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return d}let jj=n.createContext(void 0);function jk(){return n.useContext(jj)}function jl(a){let b=jk(),c=a??b;if(!c)throw Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return c}n.createContext(void 0);let jm=n.createContext(void 0);function jn(){for(var a,b,c=0,d="",e=arguments.length;c<e;c++)(a=arguments[c])&&(b=function a(b){var c,d,e="";if("string"==typeof b||"number"==typeof b)e+=b;else if("object"==typeof b)if(Array.isArray(b)){var f=b.length;for(c=0;c<f;c++)b[c]&&(d=a(b[c]))&&(e&&(e+=" "),e+=d)}else for(d in b)b[d]&&(e&&(e+=" "),e+=d);return e}(a))&&(d&&(d+=" "),d+=b);return d}function jo(...a){let b={...a[0]};for(let c=1;c<a.length;c++){let d=a[c];for(let a in d){let c=b[a],e=d[a];"function"==typeof c&&"function"==typeof e&&"o"===a[0]&&"n"===a[1]&&a.charCodeAt(2)>=65&&90>=a.charCodeAt(2)?b[a]=function(...a){return(...b)=>{for(let c of a)if("function"==typeof c)try{c(...b)}catch(a){console.error(a)}}}(c,e):("className"===a||"UNSAFE_className"===a)&&"string"==typeof c&&"string"==typeof e?b[a]=jn(c,e):b[a]=void 0!==e?e:c}}return b}function jp(a){return void 0!==a}function jq(...a){return jo(...a.filter(jp))}function jr(a,b){return"processor"===a&&b&&"object"==typeof b&&"name"in b?b.name:"e2ee"===a&&b?"e2ee-enabled":b}let js={connect:!0,audio:!1,video:!1},jt=n.forwardRef(function(a,b){let{room:c,htmlProps:d}=function(a){let{token:b,serverUrl:c,options:d,room:e,connectOptions:f,connect:g,audio:h,video:i,screen:j,onConnected:k,onDisconnected:l,onError:m,onMediaDeviceFailure:o,onEncryptionError:p,simulateParticipants:q,...r}={...js,...a};d&&e&&i1.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");let[s,t]=n.useState(),u=n.useRef(g);n.useEffect(()=>{t(e??new gO(d))},[e,JSON.stringify(d,jr)]);let v=n.useMemo(()=>{let{className:a}={className:"lk-room-container"};return jo(r,{className:a})},[r]);return n.useEffect(()=>{if(!s)return;let a=()=>{let a=s.localParticipant;i1.debug("trying to publish local tracks"),Promise.all([a.setMicrophoneEnabled(!!h,"boolean"!=typeof h?h:void 0),a.setCameraEnabled(!!i,"boolean"!=typeof i?i:void 0),a.setScreenShareEnabled(!!j,"boolean"!=typeof j?j:void 0)]).catch(a=>{i1.warn(a),null==m||m(a)})},b=(a,b)=>{let c=hC.getFailure(a);null==o||o(c,b)},c=a=>{null==p||p(a)},d=a=>{null==l||l(a)},e=()=>{null==k||k()};return s.on(hD.SignalConnected,a).on(hD.MediaDevicesError,b).on(hD.EncryptionError,c).on(hD.Disconnected,d).on(hD.Connected,e),()=>{s.off(hD.SignalConnected,a).off(hD.MediaDevicesError,b).off(hD.EncryptionError,c).off(hD.Disconnected,d).off(hD.Connected,e)}},[s,h,i,j,m,p,o,k,l]),n.useEffect(()=>{if(s){if(q)return void s.simulateParticipants({participants:{count:q},publish:{audio:!0,useRealTracks:!0}});if(g){if(u.current=!0,i1.debug("connecting"),!b)return void i1.debug("no token yet");if(!c){i1.warn("no livekit url provided"),null==m||m(Error("no livekit url provided"));return}s.connect(c,b,f).catch(a=>{i1.warn(a),!0===u.current&&(null==m||m(a))})}else i1.debug("disconnecting because connect is false"),u.current=!1,s.disconnect()}},[g,b,JSON.stringify(f),s,m,c,q]),n.useEffect(()=>{if(s)return()=>{i1.info("disconnecting on onmount"),s.disconnect()}},[s]),{room:s,htmlProps:v}}(a);return n.createElement("div",{ref:b,...d},c&&n.createElement(jj.Provider,{value:c},n.createElement(jm.Provider,{value:a.featureFlags},a.children)))});function ju(a,b,c=!0){let[d,e]=n.useState(b);return n.useEffect(()=>{c&&e(b)},[a,c]),d}function jv(a=[eM.Source.Camera,eM.Source.Microphone,eM.Source.ScreenShare,eM.Source.ScreenShareAudio,eM.Source.Unknown],b={}){let c=jl(b.room),[d,e]=n.useState([]),[f,g]=n.useState([]),h=n.useMemo(()=>a.map(a=>i3(a)?a.source:a),[JSON.stringify(a)]);return n.useEffect(()=>{var a,d,f;let i,j,k=(i=null!=(d=(a={additionalRoomEvents:b.updateOnlyOn,onlySubscribed:b.onlySubscribed}).additionalRoomEvents)?d:i0,j=null==(f=a.onlySubscribed)||f,i7(c,...Array.from(new Set([hD.ParticipantConnected,hD.ParticipantDisconnected,hD.ConnectionStateChanged,hD.LocalTrackPublished,hD.LocalTrackUnpublished,hD.TrackPublished,hD.TrackUnpublished,hD.TrackSubscriptionStatusChanged,...i]).values())).pipe(iW(a=>{let b=jb(a,h,j);return i1.debug(`TrackReference[] was updated. (length ${b.trackReferences.length})`,b),b}),iY(jb(c,h,j)))).subscribe(({trackReferences:a,participants:b})=>{i1.debug("setting track bundles",a,b),e(a),g(b)});return()=>k.unsubscribe()},[c,JSON.stringify(b.onlySubscribed),JSON.stringify(b.updateOnlyOn),JSON.stringify(a)]),n.useMemo(()=>{if(!i4(a))return d;{let b=function(a,b){let c=new Map;if(i4(a)){let d=a.filter(a=>a.withPlaceholder).map(a=>a.source);b.forEach(a=>{let b=a.getTrackPublications().map(a=>{var b;return null==(b=a.track)?void 0:b.source}).filter(a=>void 0!==a),e=Array.from(function(a,b){let c=new Set(a);for(let a of b)c.delete(a);return c}(new Set(d),new Set(b)));e.length>0&&c.set(a.identity,e)})}return c}(a,f),c=Array.from(d);return f.forEach(a=>{b.has(a.identity)&&(b.get(a.identity)??[]).forEach(b=>{d.find(({participant:c,publication:d})=>a.identity===c.identity&&d.source===b)||(i1.debug(`Add ${b} placeholder for participant ${a.identity}.`),c.push({participant:a,source:b}))})}),c}},[d,f,a])}let jw={bands:5,loPass:100,hiPass:600,updateInterval:32,analyserOptions:{fftSize:2048}};i2.AgentState;var jx,jy,jz,jA={exports:{}};!function(){if(jz)return jA.exports;jz=1;var a,b="object"==typeof Reflect?Reflect:null,c=b&&"function"==typeof b.apply?b.apply:function(a,b,c){return Function.prototype.apply.call(a,b,c)};a=b&&"function"==typeof b.ownKeys?b.ownKeys:Object.getOwnPropertySymbols?function(a){return Object.getOwnPropertyNames(a).concat(Object.getOwnPropertySymbols(a))}:function(a){return Object.getOwnPropertyNames(a)};var d=Number.isNaN||function(a){return a!=a};function e(){e.init.call(this)}jA.exports=e,jA.exports.once=function(a,b){return new Promise(function(c,d){var e,f,g;function h(c){a.removeListener(b,i),d(c)}function i(){"function"==typeof a.removeListener&&a.removeListener("error",h),c([].slice.call(arguments))}o(a,b,i,{once:!0}),"error"!==b&&(e=a,f=h,g={once:!0},"function"==typeof e.on&&o(e,"error",f,g))})},e.EventEmitter=e,e.prototype._events=void 0,e.prototype._eventsCount=0,e.prototype._maxListeners=void 0;var f=10;function g(a){if("function"!=typeof a)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof a)}function h(a){return void 0===a._maxListeners?e.defaultMaxListeners:a._maxListeners}function i(a,b,c,d){var e,f,i;if(g(c),void 0===(f=a._events)?(f=a._events=Object.create(null),a._eventsCount=0):(void 0!==f.newListener&&(a.emit("newListener",b,c.listener?c.listener:c),f=a._events),i=f[b]),void 0===i)i=f[b]=c,++a._eventsCount;else if("function"==typeof i?i=f[b]=d?[c,i]:[i,c]:d?i.unshift(c):i.push(c),(e=h(a))>0&&i.length>e&&!i.warned){i.warned=!0;var j=Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(b)+" listeners added. Use emitter.setMaxListeners() to increase limit");j.name="MaxListenersExceededWarning",j.emitter=a,j.type=b,j.count=i.length,console&&console.warn&&console.warn(j)}return a}function j(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function k(a,b,c){var d={fired:!1,wrapFn:void 0,target:a,type:b,listener:c},e=j.bind(d);return e.listener=c,d.wrapFn=e,e}function l(a,b,c){var d=a._events;if(void 0===d)return[];var e=d[b];return void 0===e?[]:"function"==typeof e?c?[e.listener||e]:[e]:c?function(a){for(var b=Array(a.length),c=0;c<b.length;++c)b[c]=a[c].listener||a[c];return b}(e):n(e,e.length)}function m(a){var b=this._events;if(void 0!==b){var c=b[a];if("function"==typeof c)return 1;if(void 0!==c)return c.length}return 0}function n(a,b){for(var c=Array(b),d=0;d<b;++d)c[d]=a[d];return c}function o(a,b,c,d){if("function"==typeof a.on)d.once?a.once(b,c):a.on(b,c);else if("function"==typeof a.addEventListener)a.addEventListener(b,function e(f){d.once&&a.removeEventListener(b,e),c(f)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof a)}Object.defineProperty(e,"defaultMaxListeners",{enumerable:!0,get:function(){return f},set:function(a){if("number"!=typeof a||a<0||d(a))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+a+".");f=a}}),e.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},e.prototype.setMaxListeners=function(a){if("number"!=typeof a||a<0||d(a))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+a+".");return this._maxListeners=a,this},e.prototype.getMaxListeners=function(){return h(this)},e.prototype.emit=function(a){for(var b=[],d=1;d<arguments.length;d++)b.push(arguments[d]);var e="error"===a,f=this._events;if(void 0!==f)e=e&&void 0===f.error;else if(!e)return!1;if(e){if(b.length>0&&(g=b[0]),g instanceof Error)throw g;var g,h=Error("Unhandled error."+(g?" ("+g.message+")":""));throw h.context=g,h}var i=f[a];if(void 0===i)return!1;if("function"==typeof i)c(i,this,b);else for(var j=i.length,k=n(i,j),d=0;d<j;++d)c(k[d],this,b);return!0},e.prototype.addListener=function(a,b){return i(this,a,b,!1)},e.prototype.on=e.prototype.addListener,e.prototype.prependListener=function(a,b){return i(this,a,b,!0)},e.prototype.once=function(a,b){return g(b),this.on(a,k(this,a,b)),this},e.prototype.prependOnceListener=function(a,b){return g(b),this.prependListener(a,k(this,a,b)),this},e.prototype.removeListener=function(a,b){var c,d,e,f,h;if(g(b),void 0===(d=this._events)||void 0===(c=d[a]))return this;if(c===b||c.listener===b)0==--this._eventsCount?this._events=Object.create(null):(delete d[a],d.removeListener&&this.emit("removeListener",a,c.listener||b));else if("function"!=typeof c){for(e=-1,f=c.length-1;f>=0;f--)if(c[f]===b||c[f].listener===b){h=c[f].listener,e=f;break}if(e<0)return this;0===e?c.shift():function(a,b){for(;b+1<a.length;b++)a[b]=a[b+1];a.pop()}(c,e),1===c.length&&(d[a]=c[0]),void 0!==d.removeListener&&this.emit("removeListener",a,h||b)}return this},e.prototype.off=e.prototype.removeListener,e.prototype.removeAllListeners=function(a){var b,c,d;if(void 0===(c=this._events))return this;if(void 0===c.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==c[a]&&(0==--this._eventsCount?this._events=Object.create(null):delete c[a]),this;if(0==arguments.length){var e,f=Object.keys(c);for(d=0;d<f.length;++d)"removeListener"!==(e=f[d])&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(b=c[a]))this.removeListener(a,b);else if(void 0!==b)for(d=b.length-1;d>=0;d--)this.removeListener(a,b[d]);return this},e.prototype.listeners=function(a){return l(this,a,!0)},e.prototype.rawListeners=function(a){return l(this,a,!1)},e.listenerCount=function(a,b){return"function"==typeof a.listenerCount?a.listenerCount(b):m.call(a,b)},e.prototype.listenerCount=m,e.prototype.eventNames=function(){return this._eventsCount>0?a(this._events):[]},jA.exports}();var jB=((h=jB||{}).CameraChanged="cameraChanged",h.MicrophoneChanged="microphoneChanged",h.StateChanged="stateChanged",h),jC=((i=jC||{}).ConnectionStateChanged="connectionStateChanged",i.MediaDevicesError="mediaDevicesError",i.EncryptionError="encryptionError",i),jD=((j=jD||{}).MessageReceived="messageReceived",j);let jE=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...a},n.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),n.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),jF=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...a},n.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),jG=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...a},n.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),n.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),jH=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...a},n.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),n.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),jI=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...a},n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),jJ=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...a},n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("g",{opacity:.25},n.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),jK=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...a},n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("g",{opacity:.25},n.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),n.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),jL=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...a},n.createElement("g",{opacity:.25},n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),n.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),jM=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...a},n.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),n.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),jN=a=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...a},n.createElement("g",{fill:"currentColor"},n.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),n.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"})));function jO(a,b){switch(a){case eM.Source.Microphone:return b?n.createElement(jH,null):n.createElement(jG,null);case eM.Source.Camera:return b?n.createElement(jF,null):n.createElement(jE,null);case eM.Source.ScreenShare:return b?n.createElement(jN,null):n.createElement(jM,null);default:return}}let jP=n.forwardRef(function({showIcon:a,...b},c){let{buttonProps:d,enabled:e}=function({source:a,onChange:b,initialState:c,captureOptions:d,publishOptions:e,onDeviceError:f,room:g,...h}){var i;let j=jk(),k=n.useMemo(()=>g??j,[g,j]),l=null==(i=null==k?void 0:k.localParticipant)?void 0:i.getTrackPublication(a),m=n.useRef(!1),{toggle:o,className:p,pendingObserver:q,enabledObserver:r}=n.useMemo(()=>k?function(a,b,c,d,e){let{localParticipant:f}=b,g=(a,b)=>{let c=!1;switch(a){case eM.Source.Camera:c=b.isCameraEnabled;break;case eM.Source.Microphone:c=b.isMicrophoneEnabled;break;case eM.Source.ScreenShare:c=b.isScreenShareEnabled}return c},h=i9(f).pipe(iW(b=>g(a,b.participant)),iY(g(a,f))),i=new iA,j=(b,g)=>iZ(this,null,function*(){try{switch(g??(g=c),i.next(!0),a){case eM.Source.Camera:return yield f.setCameraEnabled(b??!f.isCameraEnabled,g,d),f.isCameraEnabled;case eM.Source.Microphone:return yield f.setMicrophoneEnabled(b??!f.isMicrophoneEnabled,g,d),f.isMicrophoneEnabled;case eM.Source.ScreenShare:return yield f.setScreenShareEnabled(b??!f.isScreenShareEnabled,g,d),f.isScreenShareEnabled;default:throw TypeError("Tried to toggle unsupported source")}}catch(a){if(e&&a instanceof Error){null==e||e(a);return}throw a}finally{i.next(!1)}});return{className:i5("button"),toggle:j,enabledObserver:h,pendingObserver:i.asObservable()}}(a,k,d,e,f):function(){let a=!1,b=new iA,c=new iA,d=d=>iZ(this,null,function*(){c.next(!0),a=d??!a,b.next(a),c.next(!1)});return{className:i5("button"),toggle:d,enabledObserver:b.asObservable(),pendingObserver:c.asObservable()}}(),[k,a,JSON.stringify(d),e]),s=ju(q,!1),t=ju(r,c??!!(null!=l&&l.isEnabled));n.useEffect(()=>{null==b||b(t,m.current),m.current=!1},[t,b]),n.useEffect(()=>{void 0!==c&&(i1.debug("forcing initial toggle state",a,c),o(c))},[]);let u=n.useMemo(()=>jo(h,{className:p}),[h,p]),v=n.useCallback(a=>{var b;m.current=!0,o().catch(()=>m.current=!1),null==(b=h.onClick)||b.call(h,a)},[h,o]);return{toggle:o,enabled:t,pending:s,track:l,buttonProps:{...u,"aria-pressed":t,"data-lk-source":a,"data-lk-enabled":t,disabled:s,onClick:v}}}(b),[f,g]=n.useState(!1);return n.useEffect(()=>{g(!0)},[]),f&&n.createElement("button",{ref:c,...d},(a??!0)&&jO(b.source,e),b.children)});function jQ(a,b={}){let[c,d]=n.useState(i6(a)),[e,f]=n.useState(null==c?void 0:c.isMuted),[g,h]=n.useState(null==c?void 0:c.isSubscribed),[i,j]=n.useState(null==c?void 0:c.track),[k,l]=n.useState("landscape"),m=n.useRef(),{className:o,trackObserver:p}=n.useMemo(()=>{let b,c;return b=i6(a),c=i9(a.participant).pipe(iW(()=>i6(a)),iY(b)),{className:i5(a.source===eM.Source.Camera||a.source===eM.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:c}},[a.participant.sid??a.participant.identity,a.source,i$(a)&&a.publication.trackSid]);return n.useEffect(()=>{let a=p.subscribe(a=>{i1.debug("update track",a),d(a),f(null==a?void 0:a.isMuted),h(null==a?void 0:a.isSubscribed),j(null==a?void 0:a.track)});return()=>null==a?void 0:a.unsubscribe()},[p]),n.useEffect(()=>{var c,d;return i&&(m.current&&i.detach(m.current),null!=(c=b.element)&&c.current&&!(a.participant.isLocal&&(null==i?void 0:i.kind)==="audio")&&i.attach(b.element.current)),m.current=null==(d=b.element)?void 0:d.current,()=>{m.current&&(null==i||i.detach(m.current))}},[i,b.element]),n.useEffect(()=>{var a,b;"number"==typeof(null==(a=null==c?void 0:c.dimensions)?void 0:a.width)&&"number"==typeof(null==(b=null==c?void 0:c.dimensions)?void 0:b.height)&&l(c.dimensions.width>c.dimensions.height?"landscape":"portrait")},[c]),{publication:c,isMuted:e,isSubscribed:g,track:i,elementProps:jq(b.props,{className:o,"data-lk-local-participant":a.participant.isLocal,"data-lk-source":null==c?void 0:c.source,...(null==c?void 0:c.kind)==="video"&&{"data-lk-orientation":k}})}}let jR=gT(function(){if(l)return k;l=1;var a=NaN,b=/^\s+|\s+$/g,c=/^[-+]0x[0-9a-f]+$/i,d=/^0b[01]+$/i,e=/^0o[0-7]+$/i,f=parseInt,g="object"==typeof gS&&gS&&gS.Object===Object&&gS,h="object"==typeof self&&self&&self.Object===Object&&self,i=g||h||Function("return this")(),j=Object.prototype.toString,m=Math.max,n=Math.min,o=function(){return i.Date.now()};function p(a){var b=typeof a;return!!a&&("object"==b||"function"==b)}function q(g){if("number"==typeof g)return g;if("symbol"==typeof(h=g)||h&&"object"==typeof h&&"[object Symbol]"==j.call(h))return a;if(p(g)){var h,i="function"==typeof g.valueOf?g.valueOf():g;g=p(i)?i+"":i}if("string"!=typeof g)return 0===g?g:+g;g=g.replace(b,"");var k=d.test(g);return k||e.test(g)?f(g.slice(2),k?2:8):c.test(g)?a:+g}return k=function(a,b,c){var d,e,f,g,h,i,j=0,k=!1,l=!1,r=!0;if("function"!=typeof a)throw TypeError("Expected a function");function s(b){var c=d,f=e;return d=e=void 0,j=b,g=a.apply(f,c)}function t(a){var c=a-i,d=a-j;return void 0===i||c>=b||c<0||l&&d>=f}function u(){var a,c,d,e=o();if(t(e))return v(e);h=setTimeout(u,(a=e-i,c=e-j,d=b-a,l?n(d,f-c):d))}function v(a){return h=void 0,r&&d?s(a):(d=e=void 0,g)}function w(){var a,c=o(),f=t(c);if(d=arguments,e=this,i=c,f){if(void 0===h)return j=a=i,h=setTimeout(u,b),k?s(a):g;if(l)return h=setTimeout(u,b),s(i)}return void 0===h&&(h=setTimeout(u,b)),g}return b=q(b)||0,p(c)&&(k=!!c.leading,f=(l="maxWait"in c)?m(q(c.maxWait)||0,b):f,r="trailing"in c?!!c.trailing:r),w.cancel=function(){void 0!==h&&clearTimeout(h),j=0,d=i=e=h=void 0},w.flush=function(){return void 0===h?g:v(o())},w}}()),jS=n.forwardRef(function({onTrackClick:a,onClick:b,onSubscriptionStatusChanged:c,trackRef:d,manageSubscription:e,...f},g){let h=jg(d),i=n.useRef(null);n.useImperativeHandle(g,()=>i.current);let j=function({threshold:a=0,root:b=null,rootMargin:c="0%",freezeOnceVisible:d=!1,initialIsIntersecting:e=!1,onChange:f}={}){var g;let[h,i]=(0,n.useState)(null),[j,k]=(0,n.useState)(()=>({isIntersecting:e,entry:void 0})),l=(0,n.useRef)();l.current=f;let m=(null==(g=j.entry)?void 0:g.isIntersecting)&&d;(0,n.useEffect)(()=>{if(!h||!("IntersectionObserver"in window)||m)return;let d=new IntersectionObserver(a=>{let b=Array.isArray(d.thresholds)?d.thresholds:[d.thresholds];a.forEach(a=>{let c=a.isIntersecting&&b.some(b=>a.intersectionRatio>=b);k({isIntersecting:c,entry:a}),l.current&&l.current(c,a)})},{threshold:a,root:b,rootMargin:c});return d.observe(h),()=>{d.disconnect()}},[h,JSON.stringify(a),b,c,m,d]);let o=(0,n.useRef)(null);(0,n.useEffect)(()=>{var a;h||null==(a=j.entry)||!a.target||d||m||o.current===j.entry.target||(o.current=j.entry.target,k({isIntersecting:e,entry:void 0}))},[h,j.entry,d,m,e]);let p=[i,!!j.isIntersecting,j.entry];return p.ref=p[0],p.isIntersecting=p[1],p.entry=p[2],p}({root:i.current}),[k]=function(a,b,c){let d=a instanceof Function?a():a,[e,f]=(0,n.useState)(d),g=(0,n.useRef)(d),h=function(a,b=500,c){var d;let e,f=(0,n.useRef)();d=()=>{f.current&&f.current.cancel()},(e=(0,n.useRef)(d)).current=d,(0,n.useEffect)(()=>()=>{e.current()},[]);let g=(0,n.useMemo)(()=>{let d=jR(a,b,c),e=(...a)=>d(...a);return e.cancel=()=>{d.cancel()},e.isPending=()=>!!f.current,e.flush=()=>d.flush(),e},[a,b,c]);return(0,n.useEffect)(()=>{f.current=jR(a,b,c)},[a,b,c]),g}(f,3e3,void 0);return g.current===d||(h(d),g.current=d),[e,h]}(j,0);n.useEffect(()=>{e&&h.publication instanceof gM&&(null==k?void 0:k.isIntersecting)===!1&&(null==j?void 0:j.isIntersecting)===!1&&h.publication.setSubscribed(!1)},[k,h,e]),n.useEffect(()=>{e&&h.publication instanceof gM&&(null==j?void 0:j.isIntersecting)===!0&&h.publication.setSubscribed(!0)},[j,h,e]);let{elementProps:l,publication:m,isSubscribed:o}=jQ(h,{element:i,props:f});return n.useEffect(()=>{null==c||c(!!o)},[o,c]),n.createElement("video",{ref:i,...l,muted:!0,onClick:c=>{null==b||b(c),null==a||a({participant:null==h?void 0:h.participant,track:m})}})}),jT=n.forwardRef(function({trackRef:a,onSubscriptionStatusChanged:b,volume:c,...d},e){let f=jg(a),g=n.useRef(null);n.useImperativeHandle(e,()=>g.current);let{elementProps:h,isSubscribed:i,track:j,publication:k}=jQ(f,{element:g,props:d});return n.useEffect(()=>{null==b||b(!!i)},[i,b]),n.useEffect(()=>{void 0===j||void 0===c||(j instanceof gC?j.setVolume(c):i1.warn("Volume can only be set on remote audio tracks."))},[c,j]),n.useEffect(()=>{void 0===k||void 0===d.muted||(k instanceof gM?k.setEnabled(!d.muted):i1.warn("Can only call setEnabled on remote track publications."))},[d.muted,k,j]),n.createElement("audio",{ref:g,...h})});function jU({room:a,volume:b,muted:c}){let d=jv([eM.Source.Microphone,eM.Source.ScreenShareAudio,eM.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0,room:a}).filter(a=>!a.participant.isLocal&&a.publication.kind===eM.Kind.Audio);return n.createElement("div",{style:{display:"none"}},d.map(a=>n.createElement(jT,{key:i_(a),trackRef:a,volume:b,muted:c})))}let jV=a=>[[Math.floor(a/2)],[-1]],jW=new Map([["connecting",2e3],["initializing",2e3],["listening",500],["thinking",150]]);var jX=a.i(8560);function jY({trackRef:a,title:b,avatarUrl:c,offMinHeight:d,cover:e,contain:f,callMode:g}){let h=function(a,b={}){var c,d;let e=ji("string"==typeof a?b.participant:a.participant),f="string"==typeof a?{participant:e,source:a}:a,[g,h]=n.useState(!!(null!=(c=f.publication)&&c.isMuted||null!=(d=e.getTrackPublication(f.source))&&d.isMuted));return n.useEffect(()=>{let a=ja(f).subscribe(h);return()=>a.unsubscribe()},[i_(f)]),g}(a),i=a?.publication,j=!!(i&&!1!==i.isEnabled&&!1!==i.isSubscribed&&!h),[k,l]=n.default.useState(!1),o=b??(a?.participant?.name||a?.participant?.identity||"");return(0,m.jsxs)("div",{className:"relative w-full  h-full bg-black overflow-hidden rounded-md",children:[j?(0,m.jsx)(jS,{trackRef:a,className:f?"w-full h-full object-contain":e||!k?"w-full h-full object-cover":"w-full h-full object-contain",onLoadedMetadata:a=>{let b=a.currentTarget,c=b.videoWidth||0,d=b.videoHeight||0;l(c>0&&d>0&&d>c)},muted:!0,playsInline:!0,autoPlay:!0}):(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-black",children:c?(0,m.jsx)(p.default,{src:c,alt:b||"avatar",width:240,height:240,className:"w-14 h-14 rounded-full object-cover"}):(0,m.jsx)("div",{className:"w-14 h-14 rounded-full bg-white/10"})}),(0,m.jsx)("div",{className:"absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded",children:o})]})}function jZ({titleName:a,avatarUrl:b,offMinHeight:c,myName:d,myAvatarUrl:e,callMode:f,mini:g}){let h=jv([eM.Source.Camera]),i=h.filter(a=>!a.participant?.isLocal),j=h.find(a=>a.participant?.isLocal),k=n.default.useMemo(()=>i.map(a=>String((a?.participant?.identity||"").trim())).filter(a=>!!a),[i]),[l,o]=n.default.useState(null);n.default.useEffect(()=>{!g||(0===k.length?o(null):l&&k.includes(l)||o(k[Math.floor(Math.random()*k.length)]))},[g,k,l]);let q=h.length>=3,r=q?h:i,[s,t]=n.default.useState({}),[u,v]=n.default.useState(!1),[w,x]=n.default.useState(null);n.default.useEffect(()=>{let a=r.map(a=>String((a?.participant?.identity||"").trim())).filter(a=>!!a&&!s[a]);0===a.length||(async()=>{try{let b=await Promise.all(a.map(async a=>{let b=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:String(a)})}),c=await b.json(),d=c&&(c.row||(Array.isArray(c?.data)?c.data[0]:null))||null,e="string"==typeof d?.avatar?d.avatar:"";return{id:a,avatar:e}})),c={...s};b.forEach(({id:a,avatar:b})=>{b&&(c[a]=b)}),t(c)}catch{}})()},[r,s]);let y=n.default.useMemo(()=>{if(!w)return r;let a=r.slice(),b=a.findIndex(a=>String((a?.participant?.identity||"").trim())===w);if(b>0){let[c]=a.splice(b,1);a.unshift(c)}return a},[r,w]),z=y.length,A=y.slice(0,z>9?8:9),B=Math.max(0,z-A.length),C=A.length+ +(B>0),D=C<=1?1:C<=4?2:C<=9?3:4,E=Math.ceil(C/D);if(g){let d=(l?i.find(a=>String((a?.participant?.identity||"").trim())===l):void 0)||j;return"voice"===f?(0,m.jsx)("div",{className:`relative w-full h-full overflow-hidden ${"voice"===f?"bg-blue-500":"bg-black"}`,style:{minHeight:c??120},children:(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[b?(0,m.jsx)(p.default,{src:b,alt:a||"avatar",width:96,height:96,className:"w-16 h-16 rounded-full object-cover"}):(0,m.jsx)("div",{className:"w-16 h-16 rounded-full bg-white/10"}),(0,m.jsx)("div",{className:"text-white/90 text-sm",children:a||""})]})})}):(0,m.jsx)("div",{className:"relative w-full h-full overflow-hidden bg-black",style:{minHeight:c??120},children:d?(0,m.jsx)(jY,{trackRef:d,offMinHeight:c,avatarUrl:d?.participant?.isLocal?e:b,contain:!0}):(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsx)("div",{className:"text-white/80 text-xs",children:"Đang chờ camera..."})})})}return(0,m.jsxs)("div",{className:`relative w-full h-full overflow-hidden max-md:h-[100vh]  ${"voice"===f?"bg-blue-500":"bg-black"}`,style:{minHeight:c??240},children:[(0,m.jsx)("div",{className:"md:block hidden rounded-lg w-full h-full",children:"voice"===f?(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsxs)("div",{className:"flex flex-col items-center gap-4 mt-20",children:[b?(0,m.jsx)(p.default,{src:b,alt:a||"avatar",width:160,height:160,className:"w-32 h-32 rounded-full object-cover"}):(0,m.jsx)("div",{className:"w-32 h-32 rounded-full bg-white/10"}),(0,m.jsx)("div",{className:"text-white/90 text-lg",children:a||""})]})}):A.length>0?(0,m.jsxs)("div",{className:"grid w-full h-full gap-2 p-2",style:{gridTemplateColumns:`repeat(${D}, minmax(0, 1fr))`,gridTemplateRows:`repeat(${E}, minmax(0, 1fr))`},children:[A.map((a,d)=>(0,m.jsx)("div",{className:"relative",children:(0,m.jsx)(jY,{trackRef:a,offMinHeight:c,avatarUrl:(a?.participant?.isLocal?e:s[String((a?.participant?.identity||"").trim())])||(q?void 0:b)})},`${String(a?.participant?.identity||"")}-${d}`)),B>0&&(0,m.jsxs)("button",{onClick:()=>v(!0),className:"flex items-center justify-center bg-white/10 hover:bg-white/20 text-white text-lg font-semibold rounded-md",title:"Xem thêm",children:["+",B]})]}):j?(0,m.jsx)("div",{className:"w-full h-full",children:(0,m.jsx)(jY,{trackRef:j,title:d,avatarUrl:e,offMinHeight:c})}):(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsx)("div",{className:"text-white/80 text-sm",children:"Đang chờ đối phương bật camera..."})})}),(0,m.jsx)("div",{className:"md:hidden  w-full h-full flex items-center justify-center",children:"voice"===f?(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsxs)("div",{className:"flex flex-col items-center gap-4 mt-40 max-md:mt-0",children:[b?(0,m.jsx)(p.default,{src:b,alt:a||"avatar",width:128,height:128,className:"w-28 h-28 rounded-full object-cover"}):(0,m.jsx)("div",{className:"w-28 h-28 rounded-full bg-white/10"}),(0,m.jsx)("div",{className:"text-white/90 text-xl font-bold",children:a||""})]})}):A.length>0?(0,m.jsxs)("div",{className:"grid w-full h-full",style:{gridTemplateColumns:`repeat(${D}, minmax(0, 1fr))`,gridTemplateRows:`repeat(${E}, minmax(0, 1fr))`},children:[A.map((a,d)=>(0,m.jsx)("div",{className:"relative",children:(0,m.jsx)(jY,{trackRef:a,offMinHeight:c,contain:!0,avatarUrl:(a?.participant?.isLocal?e:s[String((a?.participant?.identity||"").trim())])||(q?void 0:b)})},`${String(a?.participant?.identity||"")}-${d}`)),B>0&&(0,m.jsxs)("button",{onClick:()=>v(!0),className:"flex items-center justify-center bg-white/10 hover:bg-white/20 text-white text-lg font-semibold rounded-md",title:"Xem thêm",children:["+",B]})]}):j?(0,m.jsx)("div",{className:"w-full h-[85vh] mt-4",children:(0,m.jsx)(jY,{trackRef:j,title:d,avatarUrl:e,offMinHeight:c,contain:!0})}):(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsx)("div",{className:"text-white/80 text-sm",children:"Đang chờ đối phương bật camera..."})})}),u&&"video"===f&&(0,m.jsxs)("div",{className:"absolute inset-0 bg-black/80 z-50 flex flex-col",children:[(0,m.jsxs)("div",{className:"flex items-center justify-between px-4 py-3",children:[(0,m.jsx)("div",{className:"text-white text-sm",children:"Người tham gia khác"}),(0,m.jsx)("button",{className:"px-3 py-1 rounded bg-white/10 text-white hover:bg-white/20",onClick:()=>v(!1),title:"Đóng",children:"Đóng"})]}),(0,m.jsx)("div",{className:"flex-1 overflow-auto p-3",children:(0,m.jsx)("div",{className:"grid gap-3",style:{gridTemplateColumns:"repeat(3, minmax(0, 1fr))"},children:y.slice(A.length).map((a,c)=>{let d=String((a?.participant?.identity||"").trim());return(0,m.jsx)("button",{className:"relative rounded-md overflow-hidden bg-black",onClick:()=>{x(d),v(!1)},title:"Đẩy lên giao diện chính",children:(0,m.jsx)(jY,{trackRef:a,offMinHeight:120,contain:!0,avatarUrl:(a?.participant?.isLocal?e:s[d])||b})},`${d}-${c}`)})})})]})]})}function j$(a){if(!a)return"00:00";let b=Math.max(0,Math.floor((Date.now()-a)/1e3)),c=Math.floor(b/60).toString().padStart(2,"0"),d=(b%60).toString().padStart(2,"0");return`${c}:${d}`}function j_({serverUrl:a,token:b,onDisconnected:c,onRequestEnd:d,className:e,titleName:f,callStartAt:g,avatarUrl:h,myName:i,myAvatarUrl:j,localPreviewSize:k,offMinHeight:l,onParticipantsChanged:o,callMode:p="video",uiVariant:q="full"}){let r="mini"===q,[s,t]=n.default.useState(!0),[u,v]=n.default.useState(!1),[w,x]=n.default.useState(0),y=n.default.useMemo(()=>({w:k?.w??80,h:k?.h??50}),[k]);return n.default.useEffect(()=>{if(!g)return void x(0);x(0);let a=window.setInterval(()=>x(a=>a+1),1e3);return()=>window.clearInterval(a)},[g]),(0,m.jsx)("div",{className:e||"",children:(0,m.jsxs)(jt,{serverUrl:a,token:b,connect:!0,video:"video"===p,audio:!0,onDisconnected:c,children:[(0,m.jsx)(jU,{}),(0,m.jsxs)("div",{className:`relative w-full h-full ${r?"":"group"}`,onClick:r?void 0:()=>{v(a=>!a)},children:[(0,m.jsx)(jZ,{titleName:f,avatarUrl:h,offMinHeight:l,myName:i,myAvatarUrl:j,callMode:p,mini:r}),!r&&(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("div",{className:"absolute md:block hidden top-3 left-3 text-xs font-semibold bg-green-600 text-white px-2 py-1 rounded",children:j$(g)}),(0,m.jsx)("div",{className:"absolute md:hidden block top-3 left-1/2 -translate-x-1/2 text-xs font-semibold  text-white px-2 py-1 rounded",children:(0,m.jsx)("p",{className:"text-green-500 text-[1rem]",children:j$(g)})}),(0,m.jsx)("div",{className:"absolute top-3 left-3 md:hidden",children:(0,m.jsx)("button",{className:"w-9 h-9 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition z-50",onClick:a=>{a.preventDefault(),a.stopPropagation();try{window.dispatchEvent(new CustomEvent("minimizeCallOverlay")),window.dispatchEvent(new CustomEvent("hideCallOverlay"))}catch{}},title:"Quay lại",children:(0,m.jsx)(C.HiChevronLeft,{className:"w-5 h-5"})})})]}),(0,m.jsx)(function({onChanged:a}){let b=jv([eM.Source.Camera]),c=n.default.useMemo(()=>b.filter(a=>!a.participant?.isLocal).map(a=>({id:String((a?.participant?.identity||"").trim()),name:String((a?.participant?.name||a?.participant?.identity||"").trim())})).filter(a=>!!a.id),[b]),d=n.default.useRef([]);return n.default.useEffect(()=>{let b=d.current;(b.length!==c.length||b.some((a,b)=>a.id!==c[b]?.id))&&(d.current=c,a&&a(c))},[c,a]),null},{onChanged:o}),!r&&s&&"video"===p&&(0,m.jsx)(j0,{myName:i,myAvatarUrl:j,size:y}),!r&&(0,m.jsx)("div",{className:"absolute left-0 right-0 bottom-4 md:flex hidden justify-center",children:(0,m.jsxs)("div",{className:"flex items-center gap-3 bg-black/40 text-white px-4 py-2 rounded-full backdrop-blur-md transition-opacity duration-300 opacity-0 group-hover:opacity-100",children:["video"===p&&(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(jP,{source:eM.Source.ScreenShare,className:"cursor-pointer p-2 rounded-full bg-white/10 hover:bg-white/20 transition"}),(0,m.jsx)(jP,{source:eM.Source.Camera,className:"cursor-pointer p-2 rounded-full bg-white/10 hover:bg-white/20 transition"})]}),(0,m.jsx)("button",{className:"cursor-pointer p-2 rounded-full bg-red-600 hover:bg-red-700 transition text-white",onClick:()=>{d&&d()},title:"Kết thúc",children:(0,m.jsx)(jX.CiPhone,{className:"w-5 h-5"})}),(0,m.jsx)(jP,{source:eM.Source.Microphone,className:"cursor-pointer p-2 rounded-full bg-white/10 hover:bg-white/20 transition"}),"video"===p&&(0,m.jsx)("button",{className:"cursor-pointer p-2 rounded-full bg-white/10 hover:bg-white/20 transition",onClick:()=>t(a=>!a),title:s?"Ẩn cam của tôi":"Hiện cam của tôi",children:s?(0,m.jsx)(C.HiEyeSlash,{className:"w-5 h-5"}):(0,m.jsx)(C.HiEye,{className:"w-5 h-5"})})]})}),!r&&(0,m.jsxs)("div",{className:`fixed bottom-6 left-0 right-0 md:hidden flex justify-center gap-6 transition-opacity duration-300 ${u?"opacity-100":"opacity-0"}`,children:[(0,m.jsx)("div",{className:"flex flex-col items-center gap-2",children:"video"===p&&(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(jP,{source:eM.Source.Camera,className:"w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition"}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Camera"})]})}),(0,m.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,m.jsx)(jP,{source:eM.Source.Microphone,className:"w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition"}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Mic"})]}),(0,m.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,m.jsx)("button",{className:"w-12 h-12 flex items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-700 transition",onClick:()=>{d&&d()},title:"Kết thúc",children:(0,m.jsx)(jX.CiPhone,{className:"w-6 h-6"})}),(0,m.jsx)("span",{className:"text-white text-xs",children:"Kết thúc"})]}),(0,m.jsx)("div",{className:"flex flex-col items-center gap-2",children:"video"===p&&(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("button",{className:"w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition",onClick:()=>t(a=>!a),title:s?"Ẩn cam của tôi":"Hiện cam của tôi",children:s?(0,m.jsx)(C.HiEyeSlash,{className:"w-6 h-6"}):(0,m.jsx)(C.HiEye,{className:"w-6 h-6"})}),(0,m.jsx)("span",{className:"text-white text-xs",children:s?"Ẩn cam tôi":"Hiện cam tôi"})]})})]})]})]})})}function j0({myName:a,myAvatarUrl:b,size:c}){let d=jv([eM.Source.Camera]),e=d.find(a=>a.participant?.isLocal),[f,g]=n.default.useState(!1),[h,i]=n.default.useState({x:12,y:12});n.default.useEffect(()=>{let a=()=>{};return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[c.w]);let j={width:c.w,height:c.h};return(f||(j.left=h.x,j.top=h.y),d.length>=3)?null:(0,m.jsx)("div",{className:`${f?"absolute top-2 right-2":"absolute"} rounded-lg overflow-hidden bg-black ${f?"":"cursor-move"}`,style:j,onMouseDown:a=>{if(f)return;let b={sx:a.clientX,sy:a.clientY,ox:h.x,oy:h.y},d=a=>{let d=a.clientX-b.sx,e=a.clientY-b.sy;i({x:Math.min(Math.max(8,b.ox+d),Math.max(8,(window.innerWidth||360)-c.w-8)),y:Math.min(Math.max(8,b.oy+e),Math.max(8,(window.innerHeight||640)-c.h-8))})},e=()=>{window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",e)};window.addEventListener("mousemove",d),window.addEventListener("mouseup",e)},onTouchStart:a=>{if(f)return;let b=a.touches[0],d={sx:b.clientX,sy:b.clientY,ox:h.x,oy:h.y},e=a=>{let b=a.touches[0],e=b.clientX-d.sx,f=b.clientY-d.sy;i({x:Math.min(Math.max(8,d.ox+e),Math.max(8,(window.innerWidth||360)-c.w-8)),y:Math.min(Math.max(8,d.oy+f),Math.max(8,(window.innerHeight||640)-c.h-8))})},g=()=>{window.removeEventListener("touchmove",e),window.removeEventListener("touchend",g)};window.addEventListener("touchmove",e,{passive:!1}),window.addEventListener("touchend",g,{passive:!1})},children:e?(0,m.jsx)(jY,{trackRef:e,title:a,avatarUrl:b}):(0,m.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,m.jsx)("div",{className:"text-white/70 text-xs px-2 py-1",children:"Không có camera"})})})}var j1=a.i(24137),j2=a.i(86402),j3=a.i(54840);let j4=({children:a})=>{let b,[c,d]=(0,n.useState)(!1),[e,f]=(0,n.useState)(!1),[g,h]=(0,n.useState)(!1),[i,j]=(0,n.useState)(null),[k,l]=(0,n.useState)(0),[p,q]=(0,n.useState)(0),[r,s]=(0,n.useState)(0),[u,v]=(0,n.useState)(null),w=(0,n.useRef)(null),x=(0,n.useRef)(new Map),y=(0,n.useRef)(new Map);(0,n.useRef)(new Set);let[z,A]=(0,n.useState)(!1),B=(0,n.useRef)(null),[H,I]=(0,n.useState)(!1),K=(0,n.useRef)(null);(0,n.useEffect)(()=>{let a=K.current;if(H)try{a&&"function"==typeof a.requestFullscreen&&a.requestFullscreen()}catch{}else try{document.fullscreenElement&&document.exitFullscreen()}catch{}},[H]),(0,n.useEffect)(()=>{let a=()=>{!document.fullscreenElement&&H&&I(!1)};return document.addEventListener("fullscreenchange",a),()=>document.removeEventListener("fullscreenchange",a)},[H]);let{playMessageSound:L,flashTabTitle:M}=(0,j3.useChatNotifications)({}),N=(0,o.useRouter)(),O=(0,o.usePathname)(),P="/profile"===O||"/me"===O||O?.startsWith("/profile")||O?.startsWith("/me"),Q=(0,n.useRef)(O);(0,n.useEffect)(()=>{Q.current=O},[O]),(0,n.useEffect)(()=>{let a=!0;return(async()=>{try{if((await fetch("/api/auth/refresh",{credentials:"include"})).ok){let b=await fetch("/api/users/me",{credentials:"include"}),c=await b.json();a&&(d(!!c?.success),c?.success&&c?.user&&v(c.user))}else{let b=await fetch("/api/users/me",{credentials:"include"}),c=await b.json();a&&(d(!!c?.success),c?.success&&c?.user&&v(c.user))}}catch{try{let b=localStorage.getItem("info_user"),c=b?JSON.parse(b):null;a&&(d(!!c&&!!c._id),c&&c._id&&v(c))}catch{a&&d(!1)}}finally{a&&f(!0)}})(),()=>{a=!1}},[]),(0,n.useEffect)(()=>{let a=async()=>{try{let a=await fetch("/api/users/me",{credentials:"include"}),b=await a.json(),c=String(b?.data?._id||"").trim();if(c)return void j(c)}catch{}try{let a=localStorage.getItem("info_user"),b=a?JSON.parse(a):null,c=String(b?._id||b?.username||"").trim();c&&j(c)}catch{}};c&&e&&a()},[c,e]);let R=(0,n.useCallback)(async()=>{if(i)try{let[a,b]=await Promise.all([fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"read",currentUserId:i})}),fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:i})})]),c=await a.json(),d=await b.json(),e=Array.isArray(c)?c:c.data||[],f=Array.isArray(d)?d:d.data||[],g=e.reduce((a,b)=>a+Number(b?.unreadCount||0),0),h=f.reduce((a,b)=>a+Number(b?.unreadCount||0),0);l(g+h),s(g),q(h)}catch{}},[i]);(0,n.useEffect)(()=>{R()},[R]),(0,n.useEffect)(()=>{let a=a=>{h(!!a.detail?.hidden)};return window.addEventListener("mobile-footer",a),()=>window.removeEventListener("mobile-footer",a)},[]),(0,n.useEffect)(()=>{let a=window.fetch,b=null,c=async(c,d)=>{let e,f="string"==typeof c?c:c instanceof URL?c.toString():c instanceof Request?c.url:"";try{e=await a(c,d)}catch(a){return new Response(null,{status:502,statusText:"Network Error"})}if(!f.includes("/api/")||f.includes("/api/auth/refresh"))return 401===e.status&&f.includes("/api/auth/refresh")&&"/login"!==O&&N.push("/login"),e;if(401!==e.status)return e;b||(b=a("/api/auth/refresh",{credentials:"include"}).finally(()=>{b=null}));try{if((await b).ok)return await a(c,d)}catch{}return"/login"!==O&&N.push("/login"),e};return window.fetch=c,()=>{window.fetch=a}},[N,O]),(0,n.useEffect)(()=>{e&&!c&&"/login"!==O&&N.push("/login")},[e,c,O,N]),(0,n.useEffect)(()=>{if(!e||!c||!u||w.current?.connected)return;let a=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1});w.current=a,a.emit("join_user",{userId:String(u._id)});let b=async()=>{try{let b=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:String(u._id)})}),c=await b.json(),d=c?.data||[],e=new Map;d.forEach(b=>{let c=String(b._id),d=Array.isArray(b.members)?b.members:[];e.set(c,d),y.current.set(c,{name:b.name,avatar:b.avatar}),a.emit("join_room",c)}),x.current=e}catch{}};return b(),a.on("connect",()=>{b()}),a.on("update_sidebar",a=>{if(a.sender!==String(u._id)&&(u?.notifications?.soundEnabled!==!1&&L(),M(),("text"===a.type||"image"===a.type||"file"===a.type||"sticker"===a.type||"video"===a.type||"notify"===a.type)&&(R(),A(!0),B.current&&(window.clearTimeout(B.current),B.current=null),B.current=window.setTimeout(()=>{A(!1),B.current=null},5e3)),"notify"===a.type&&"string"==typeof a.content)){let b=String(a.roomId||"");if(b&&a.content.toLowerCase().includes("cuộc gọi nhóm đã kết thúc")){let a=new Map(aN);if(a.has(b)){a.set(b,{active:!1,type:a.get(b)?.type||null,participants:[],startAt:null}),aO(a);let c=Array.from(a.entries()).filter(([,a])=>a.active).map(([a])=>a);try{localStorage.setItem("ACTIVE_GROUP_CALL_ROOMS",JSON.stringify(c))}catch{}let d=new CustomEvent("activeGroupCallsUpdated",{detail:{rooms:c}});window.dispatchEvent(d)}}}}),a.on("call_state",a=>{try{let b=String(a.roomId||"");if(!b)return;let c=aP.current.get(b)||{active:!1,type:null,participants:[],startAt:null},d=!!c.active,e=Array.isArray(c.participants)?c.participants.map(a=>String(a)):[],f=!!a.active,g=Array.isArray(a.participants)?a.participants.map(a=>String(a)):[],h=2!==b.split("_").filter(Boolean).length&&d&&!f&&e.length<=1&&e.includes(String(u?._id||"")),i=new Map(aN);i.set(b,{active:f,type:a.type||null,participants:g,startAt:"number"==typeof a.startAt?a.startAt:null}),aO(i);let j=Array.from(i.entries()).filter(([,a])=>a.active).map(([a])=>a);try{localStorage.setItem("ACTIVE_GROUP_CALL_ROOMS",JSON.stringify(j))}catch{}let k=new CustomEvent("activeGroupCallsUpdated",{detail:{rooms:j}});if(window.dispatchEvent(k),h){let a=x.current.get(b)||[];w.current?.emit("send_message",{roomId:b,sender:String(u?._id||""),senderName:String(u?.name||"Hệ thống"),isGroup:!0,members:a,type:"notify",content:"Cuộc gọi nhóm đã kết thúc"})}}catch{}}),a.on("call_end",a=>{try{let b=String(a.roomId||"");if(!b)return;let c=aP.current.get(b)||{active:!1,type:null,participants:[],startAt:null},d=!!c.active,e=Array.isArray(c.participants)?c.participants:[],f=2!==b.split("_").filter(Boolean).length,g=new Map(aN);g.set(b,{active:!1,type:g.get(b)?.type||null,participants:[],startAt:null}),aO(g);let h=Array.from(g.entries()).filter(([,a])=>a.active).map(([a])=>a);try{localStorage.setItem("ACTIVE_GROUP_CALL_ROOMS",JSON.stringify(h))}catch{}let i=new CustomEvent("activeGroupCallsUpdated",{detail:{rooms:h}});window.dispatchEvent(i);let j=String(a?.from||"");if(f&&d&&e.length<=1&&e.includes(String(u?._id||""))&&j&&String(u?._id||"")===j){let a=x.current.get(b)||[];w.current?.emit("send_message",{roomId:b,sender:String(u?._id||""),senderName:String(u?.name||"Hệ thống"),isGroup:!0,members:a,type:"notify",content:"Cuộc gọi nhóm đã kết thúc"})}}catch{}}),(async()=>{try{let b=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:String(u?._id||"")})}),c=await b.json();(c?.data||[]).forEach(b=>{let c=String(b._id);a.emit("join_room",c)})}catch{}})(),a.on("call_notify",async()=>{}),()=>{try{w.current?.disconnect()}catch{}w.current=null}},[e,c,u,L,M,R]);let S=[{key:"home",label:"Tin nhắn",paths:["/home","/chat","/"],icon:C.HiChatBubbleLeftRight},{key:"group",label:"Nhóm",paths:["/group"],icon:C.HiRectangleGroup},{key:"directory",label:"Danh bạ",paths:["/directory"],icon:C.HiUserGroup},{key:"moments",label:"Tường",paths:["/moments","/timeline"],icon:C.HiPhoto},{key:"profile",label:"Cá nhân",paths:["/profile","/me"],icon:C.HiUserCircle}],T="/chat-iframe"===O||O?.startsWith("/chat-iframe"),[U,V]=(0,n.useState)(""),[W,X]=(0,n.useState)(!1),[Y,Z]=(0,n.useState)(null),[$,_]=(0,n.useState)(""),aa=String((U||$||"").trim()),ab=!!W,{callActive:ac,callType:ad,callConnecting:ae,incomingCall:af,startCall:ag,acceptIncomingCall:ah,endCall:ai,callStartAt:aj,counterpartId:ak,activeRoomId:al,livekitToken:am,livekitUrl:an,roomCallActive:ao,roomCallType:ap,roomParticipants:aq,setIncomingCall:ar,joinActiveGroupCall:as}=function({socketRef:a,roomId:b,currentUserId:c,currentUser:d,isGroup:e,selectedChat:f}){let[g,h]=(0,n.useState)(null),[i,j]=(0,n.useState)(!1),[k,l]=(0,n.useState)(null),[m,o]=(0,n.useState)(null),[p,q]=(0,n.useState)(!1),[r,s]=(0,n.useState)(!1),[u,v]=(0,n.useState)(null),[w,x]=(0,n.useState)([]),[y,z]=(0,n.useState)(b),[A,B]=(0,n.useState)(null),[C,D]=(0,n.useState)(null),[F,G]=(0,n.useState)(null),H=(0,n.useRef)([]),I=(0,n.useRef)(null),J=(0,n.useRef)(!1),K=(0,n.useRef)(!1),L=(0,n.useRef)(""),M=(0,n.useRef)(""),N=(0,n.useRef)(0),O=(0,n.useRef)([]),P=(0,n.useRef)(null);(0,n.useEffect)(()=>{J.current=i},[i]),(0,n.useEffect)(()=>{P.current=k},[k]),(0,n.useEffect)(()=>{K.current=p},[p]),(0,n.useEffect)(()=>{M.current=String(y||"")},[y]),(0,n.useEffect)(()=>{O.current=w},[w]),(0,n.useEffect)(()=>{(async()=>{try{if(!c)return;a.current&&a.current.connected||(a.current=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),await new Promise(b=>{a.current.on("connect",()=>b())})),a.current.emit("join_user",{userId:String(c)})}catch{}})()},[c]),(0,n.useEffect)(()=>{if(i||p){N.current=Date.now()+5e3;return}z(b)},[b,i,p]),(0,n.useEffect)(()=>{if(!String(b||"")){s(!1),v(null),x([]);return}J.current||K.current||(s(!1),v(null),x([]))},[b]),(0,n.useEffect)(()=>{let d=String(b||"");d&&(async()=>{try{if(i||p)return;a.current&&a.current.connected||(a.current=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),await new Promise(b=>{a.current.on("connect",()=>b())}),a.current.emit("join_user",{userId:String(c)})),L.current!==d&&(a.current?.emit("join_room",d),L.current=d)}catch{}})()},[b,c,a,i,p]);let Q=(0,n.useCallback)(()=>{if(e)return(f?.members||[]).map(a=>"object"==typeof a?String(a._id):String(a)).filter(a=>a!==String(c));let a=String(f?._id||"");return a?[a]:[]},[e,f,c]),R=(0,n.useCallback)(async a=>{let b=await fetch(`/api/livekit/token?room=${encodeURIComponent(a)}`,{method:"GET"});if(!b.ok)throw Error("token failed");let c=await b.json();D(String(c.token||"")),G(String(c.serverUrl||""))},[]),S=(0,n.useCallback)(async g=>{if(!b||!c)return;let h=d?.name||"Bạn",i={roomId:b,sender:c,type:"notify",content:g,timestamp:Date.now()};try{let c=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",data:i})}),d=await c.json();if(d.success&&d._id){let c=[];f&&String(f._id)===String(b)&&e&&(c=f.members||[]),a.current?.emit("send_message",{...i,_id:d._id,senderName:h,isGroup:e,receiver:null,members:c})}}catch(a){console.error("Failed to send notify",a)}},[b,c,d,e,f,a]),T=(0,n.useCallback)(async()=>{try{if(!e||!r)return;let f=String(b);a.current&&a.current.connected||(a.current=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),await new Promise(b=>{a.current.on("connect",()=>b())}),a.current.emit("join_user",{userId:String(c)})),a.current?.emit("join_room",f);let g=(Array.isArray(w)?w:[]).find(a=>String(a)!==String(c));g&&a.current?.emit("call_answer",{roomId:f,target:String(g),from:String(c),sdp:null}),z(f),l(u||"voice"),q(!1),await R(f),j(!0);let h=d?.name||"Bạn";S(`${h} đ\xe3 tham gia cuộc gọi video`)}catch{}},[e,r,w,b,c,u,R,d,S]),U=(0,n.useCallback)(async(f,g)=>{try{a.current&&a.current.connected||(a.current=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),await new Promise(b=>{a.current.on("connect",()=>b())}),a.current.emit("join_room",b),a.current.emit("join_user",{userId:String(c)}))}catch{}let h=!e&&g?[String(g)]:e&&r&&w&&w.length>0?w.filter(a=>String(a)!==String(c)):Q();if(H.current=h,0!==h.length){if(e){let a=d?.name||"Bạn";S(`${a} đ\xe3 tham gia cuộc gọi video`)}l(f),o(null),q(!0),D(null),G(null),z(b),B((()=>{if(e)return null;if(g)return String(g);if(h.length>0)return String(h[0]);let a=String(b).split("_").filter(Boolean),d=String(c),f=2===a.length?a.find(a=>String(a)!==d):void 0;return f?String(f):null})()),I.current&&(window.clearTimeout(I.current),I.current=null),(0,j1.playGlobalRingTone)(),I.current=window.setTimeout(()=>{!J.current&&K.current&&((0,j1.stopGlobalRingTone)(),V("local"))},3e4);try{for(let d of h)a.current?.emit("call_offer",{roomId:b,target:d,from:String(c),type:f,sdp:null})}catch{q(!1)}}},[Q,b,c,e,r,w,d,S]),V=(0,n.useCallback)((f="local")=>{if((0,j1.stopGlobalRingTone)(),j(!1),l(null),o(null),q(!1),h(null),B(null),z(""),D(null),G(null),I.current&&(window.clearTimeout(I.current),I.current=null),"local"===f&&a.current?.connected)if(e){a.current.emit("call_leave",{roomId:b,userId:String(c)});let e=d?.name||"Bạn";if(S(`${e} đ\xe3 rời cuộc gọi video`),"video"===P.current&&0===(O.current||[]).filter(a=>String(a)!==String(c)).length){let a=new Date().toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});S(`Cuộc gọi video đ\xe3 kết th\xfac l\xfac ${a}`)}x(a=>{let b=(a||[]).filter(a=>String(a)!==String(c));return 0===b.length&&(s(!1),v(null)),b})}else{let d=H.current;if(!d||0===d.length){let a,e,f,g=A?String(A):(a=String(b).split("_").filter(Boolean),e=String(c),(f=2===a.length?a.find(a=>String(a)!==e):void 0)?String(f):void 0);d=g?[g]:[]}a.current.emit("call_end",{roomId:b,from:String(c),targets:d})}},[b,c,A,e,k,d,S]),W=(0,n.useCallback)(async()=>{if(g){(0,j1.stopGlobalRingTone)(),l(g.type),z(g.roomId),q(!1);try{a.current&&a.current.connected||(a.current=(0,E.default)((0,t.resolveSocketUrl)(),{transports:["websocket"],withCredentials:!1}),await new Promise(b=>{a.current.on("connect",()=>b())}),a.current.emit("join_user",{userId:String(c)})),a.current?.emit("join_room",g.roomId),a.current?.emit("call_answer",{roomId:g.roomId,target:String(g.from),from:String(c),sdp:null});let b=String(g.roomId).split("_").filter(Boolean);2===b.length?B(String(g.from)):B(null),j(!0),await R(g.roomId),h(null),o(a=>a&&a>0?a:Date.now())}catch{j(!0)}}},[g,R,c]);return(0,n.useEffect)(()=>{let d=a.current;if(!d)return;d.off("call_offer"),d.off("call_answer"),d.off("call_end"),d.off("call_reject"),d.off("call_leave"),d.off("call_state");let e=a=>{if(String(a.target)===String(c)){if(J.current||K.current)return void d.emit("call_candidate",{roomId:a.roomId,target:a.from,from:c,candidate:"busy-signal"});h({from:String(a.from),type:a.type,roomId:a.roomId}),(0,j1.playGlobalRingTone)()}},f=a=>{if((!a.target||String(a.target)===String(c))&&"busy-signal"===a.candidate){let b=new CustomEvent("callBusy",{detail:{roomId:a.roomId,from:a.from}});window.dispatchEvent(b)}},g=async a=>{String(a.target)===String(c)&&((0,j1.stopGlobalRingTone)(),q(!1),z(a.roomId),o(a=>a&&a>0?a:Date.now()),await R(a.roomId),j(!0))},i=a=>{(0,j1.stopGlobalRingTone)(),h(null);let d=2===String(a.roomId).split("_").filter(Boolean).length;if("string"==typeof a.from&&String(a.from)!==String(c)||Array.isArray(a.targets)&&a.targets.length,d){if(String(a.roomId)!==String(M.current))return;V("remote"),String(a.roomId)===String(b)&&(s(!1),v(null),x([]));return}String(a.roomId)===String(M.current)&&(V("remote"),String(a.roomId)===String(b)&&(s(!1),v(null),x([])))},k=a=>{(0,j1.stopGlobalRingTone)(),h(null),2===String(a.roomId).split("_").filter(Boolean).length&&String(a.roomId)===String(M.current)&&(V("remote"),String(a.roomId)===String(b)&&(s(!1),v(null),x([])))},l=a=>{String(a.roomId)===String(b)&&x(b=>{let c=(b||[]).filter(b=>String(b)!==String(a.userId));return 0===c.length&&(s(!1),v(null)),c})},m=a=>{String(a.roomId)!==String(b)||2!==String(a.roomId).split("_").filter(Boolean).length&&(s(!!a.active),v(a.type),x(Array.isArray(a.participants)?a.participants.map(a=>String(a)):[]),o("number"==typeof a.startAt?a.startAt:null))};return d.on("call_offer",e),d.on("call_answer",g),d.on("call_end",i),d.on("call_reject",k),d.on("call_leave",l),d.on("call_state",m),d.on("call_candidate",f),()=>{d.off("call_offer",e),d.off("call_answer",g),d.off("call_end",i),d.off("call_reject",k),d.off("call_leave",l),d.off("call_state",m),d.off("call_candidate",f)}},[c,a,V,b,R]),(0,n.useEffect)(()=>{!p&&((0,j1.stopGlobalRingTone)(),I.current&&(window.clearTimeout(I.current),I.current=null))},[p]),(0,n.useEffect)(()=>{!g&&((0,j1.stopGlobalRingTone)(),I.current&&(window.clearTimeout(I.current),I.current=null))},[g]),{callActive:i,callType:k,callStartAt:m,callConnecting:p,incomingCall:g,startCall:U,endCall:V,acceptIncomingCall:W,setIncomingCall:h,roomCallActive:r,roomCallType:u,roomParticipants:w,activeRoomId:y,counterpartId:A,livekitToken:C,livekitUrl:F,joinActiveGroupCall:T}}({socketRef:w,roomId:aa,currentUserId:String(u?._id||""),currentUser:u,isGroup:ab,selectedChat:Y}),at=(0,j2.useToast)(),au=n.default.useRef("");(0,n.useEffect)(()=>{al&&(au.current=String(al))},[al]);let av=n.default.useRef(null);(0,n.useEffect)(()=>{av.current="number"==typeof aj?aj:null},[aj]),(0,n.useEffect)(()=>{try{let a=localStorage.getItem("CURRENT_ROOM_ID");_(String(a||""))}catch{}let a=a=>{let b=a.detail;b&&_(String(b.roomId||""))};return window.addEventListener("currentRoomChanged",a),()=>window.removeEventListener("currentRoomChanged",a)},[]),(0,n.useEffect)(()=>{!("/"===O||"/home"===O||O?.startsWith("/chat"))||!$||af||ac||ae||String(U)===String($)||(V(String($)),X(2!==String($).split("_").filter(Boolean).length))},[$,O,U,af,ac,ae]),(0,n.useEffect)(()=>{if(!af)return;let a=String(af.roomId||"");if(!a)return;let b=2!==a.split("_").filter(Boolean).length;if(V(a),X(b),b){let b=y.current.get(a),c=a=>{a&&(aI(String(a.name||"")),aK(a.avatar?String(a.avatar):void 0))};b?c(b):(async()=>{try{let b=await fetch("/api/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readGroups",_id:String(u?._id||"")})}),d=await b.json(),e=d?.data||[],f=new Map;e.forEach(a=>{let b=String(a._id),c=Array.isArray(a.members)?a.members:[];f.set(b,c),y.current.set(b,{name:a.name,avatar:a.avatar})}),x.current=f,c(y.current.get(a))}catch{}})()}},[af]),(0,n.useEffect)(()=>{try{let a=af?"1":"";a?localStorage.setItem("GLOBAL_INCOMING_CALL",a):localStorage.removeItem("GLOBAL_INCOMING_CALL");let b=ac?"1":"",c=ae?"1":"";b?localStorage.setItem("GLOBAL_CALL_ACTIVE",b):localStorage.removeItem("GLOBAL_CALL_ACTIVE"),c?localStorage.setItem("GLOBAL_CALL_CONNECTING",c):localStorage.removeItem("GLOBAL_CALL_CONNECTING");let d=new CustomEvent("globalCallStatusChanged",{detail:{active:!!ac,connecting:!!ae,incoming:!!af}});window.dispatchEvent(d)}catch{}},[af,ac,ae]);let[aw,ax]=(0,n.useState)({x:24,y:24}),[ay,az]=(0,n.useState)({w:560}),[aA,aB]=(0,n.useState)(!1),aC=n.default.useRef(null),[aD,aE]=(0,n.useState)(!1),[aF,aG]=(0,n.useState)(!1),[aH,aI]=(0,n.useState)(""),[aJ,aK]=(0,n.useState)(void 0),[aL,aM]=(0,n.useState)(0),[aN,aO]=(0,n.useState)(new Map),aP=n.default.useRef(new Map);(0,n.useEffect)(()=>{aP.current=new Map(aN)},[aN]);let aQ=n.default.useRef(null),aR=n.default.useRef(null);(0,n.useEffect)(()=>{let a=()=>aG(!1);return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);let[aS,aT]=(0,n.useState)({x:24,y:24}),aU=(0,n.useRef)(null),aV=(0,n.useRef)(!1);(0,n.useEffect)(()=>{try{aT({x:220,y:560})}catch{}},[]),n.default.useEffect(()=>{let a=()=>{aE(!1),aC.current={...ay};let a=Math.max(280,Math.min(360,ay.w));az({w:a});try{let b=Math.max(8,360-a-16);ax({x:b,y:16})}catch{}aB(!0)};return window.addEventListener("minimizeCallOverlay",a),()=>{window.removeEventListener("minimizeCallOverlay",a)}},[ay.w]),n.default.useEffect(()=>{let a=()=>{aB(!1),aE(!0)};return window.addEventListener("hideCallOverlay",a),()=>window.removeEventListener("hideCallOverlay",a)},[]),(0,n.useEffect)(()=>{let a=String(aa||"");if(!a||!ab)return;let b=!!ac||!!ao,c=new Map(aN),d=c.get(a)||{active:!1,type:null,participants:[],startAt:null},e=Array.isArray(aq)?aq.map(a=>String(a)):[],f=e.length>0?e:b?[String(u?._id||"")]:[],g=ad||d.type||null,h="number"==typeof aj?aj:d.startAt;if(d.active!==b||String(d.type||"")!==String(g||"")||(d.startAt||null)!==(h||null)){c.set(a,{active:b,type:g,participants:f,startAt:h||null}),aO(c);let d=Array.from(c.entries()).filter(([,a])=>a.active).map(([a])=>a);try{localStorage.setItem("ACTIVE_GROUP_CALL_ROOMS",JSON.stringify(d))}catch{}let e=new CustomEvent("activeGroupCallsUpdated",{detail:{rooms:d}});window.dispatchEvent(e)}},[ac,ao,ab,aa,ad,aq,aj,aN,u]),n.default.useEffect(()=>{let a=a=>{let b=a.detail,c=String(b?.roomId||"");c&&(V(c),X(!0),as())};return window.addEventListener("joinActiveGroupCallRequest",a),()=>window.removeEventListener("joinActiveGroupCallRequest",a)},[as]);let aW=a=>{let b={startX:a.clientX,startY:a.clientY,originX:aw.x,originY:aw.y},c=a=>{let c=a.clientX-b.startX,d=a.clientY-b.startY,e=b.originX+c,f=b.originY+d;ax({x:Math.min(Math.max(8,e),Math.max(8,window.innerWidth-(ay.w+24))),y:Math.min(Math.max(8,f),Math.max(8,window.innerHeight-344))})},d=()=>{window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",d)};window.addEventListener("mousemove",c),window.addEventListener("mouseup",d)},aX=a=>{a.preventDefault();let b=a.touches[0],c={startX:b.clientX,startY:b.clientY,originX:aw.x,originY:aw.y},d=a=>{let b=a.touches[0],d=b.clientX-c.startX,e=b.clientY-c.startY,f=c.originX+d,g=c.originY+e;ax({x:Math.min(Math.max(8,f),Math.max(8,window.innerWidth-(ay.w+24))),y:Math.min(Math.max(8,g),Math.max(8,window.innerHeight-344))})},e=()=>{window.removeEventListener("touchmove",d),window.removeEventListener("touchend",e)};window.addEventListener("touchmove",d,{passive:!1}),window.addEventListener("touchend",e,{passive:!1})},aY=a=>{let b="touches"in a?a.touches[0].clientX:a.clientX,c=ay.w,d=a=>{az({w:Math.min(Math.max(280,c+(("touches"in a?a.touches[0].clientX:a.clientX)-b)),Math.floor(.9*window.innerWidth))})},e=()=>{window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",e),window.removeEventListener("touchmove",d),window.removeEventListener("touchend",e)};window.addEventListener("mousemove",d),window.addEventListener("mouseup",e),window.addEventListener("touchmove",d),window.addEventListener("touchend",e)};(0,n.useEffect)(()=>{},[]),(0,n.useEffect)(()=>{let a=String(al||"")||aa||String(af?.roomId||"")||String(U||"");if(2!==a.split("_").filter(Boolean).length){let b=a?y.current.get(String(a)):void 0;if(b){aI(String(b.name||"")),aK(b.avatar?String(b.avatar):void 0);return}let c=String(Y?.name||"").trim(),d=Y?.avatar?String(Y.avatar):void 0;aI(c||""),aK(d);return}let b=ak?String(ak):af?.from?String(af.from):Y?._id?String(Y._id):"";if(Y?._id&&String(Y._id)===String(b)?(aI(String(Y?.name||"")),aK(Y?.avatar?String(Y?.avatar):void 0)):(aI(""),aK(void 0)),!b){aI(""),aK(void 0);return}(async()=>{try{let a=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getById",_id:String(b)})}),c=await a.json(),d=c?.row||c?.user||c;aI(String(d?.name||"")),aK(d?.avatar?String(d.avatar):void 0)}catch{aI(""),aK(void 0)}})()},[ak,af,Y,W,al,aa,U]);let aZ=n.default.useRef(null);(0,n.useEffect)(()=>(aZ.current&&(window.clearInterval(aZ.current),aZ.current=null),ac&&aj)?(aM(0),aZ.current=window.setInterval(()=>{aM(Math.max(0,Math.floor((Date.now()-Number(aj))/1e3)))},1e3),()=>{aZ.current&&(window.clearInterval(aZ.current),aZ.current=null)}):void aM(0),[ac,aj]);let a$=async a=>{try{let b,c=String(al||au.current||aa||$||"");if(!c||!u?._id)return;let d=c.split("_").filter(Boolean),e=2===d.length;if("ended"===a){let a="number"==typeof av.current&&av.current>0?String(av.current):"number"==typeof aj&&aj>0?String(aj):"unknown",b=`${c}:${a}`,d=a$.endedSentBag||new Set;if(a$.endedSentBag=d,d.has(b))return;d.add(b)}let f="ended"===a?(b="number"==typeof av.current&&av.current>0?av.current:"number"==typeof aj&&aj>0?aj:void 0,"number"==typeof b&&b>0?Math.max(0,Math.floor((Date.now()-Number(b))/1e3)):Math.max(0,Math.floor(aL))):Math.max(0,Math.floor(aL)),g=(()=>{if(e){if("ended"!==a)return"";let b="video"===ad?"video":"thoại",c=a_.current?"đi":"đến",d=Math.floor(f/60),e=f%60;return`Cuộc gọi ${b} ${c} – ${d} ph\xfat ${e} gi\xe2y`}return""})();if(!g)return;let h=Date.now(),i=await (0,F.createMessageApi)({roomId:c,type:"notify",sender:String(u._id),content:g,timestamp:h,callerId:String(u._id),calleeId:String(ak||""),callType:ad||"voice",callStatus:"ended"===a?"answered":a,callDurationSec:f,callStartedAt:"number"==typeof aj?aj:void 0,callEndedAt:h});if(i?.success&&"string"==typeof i._id){let b=c.split("_").filter(Boolean),d=2===b.length,e=!d,j=d?b[0]===String(u._id)?b[1]:b[0]:null,k=e&&x.current.get(c)||[];w.current?.emit("send_message",{roomId:c,sender:String(u._id),senderName:u.name,isGroup:e,receiver:j,members:k,_id:i._id,type:"notify",content:g,timestamp:h,callerId:String(u._id),calleeId:String(ak||""),callType:ad||"voice",callStatus:"ended"===a?"answered":a,callDurationSec:f})}}catch{}};(0,n.useEffect)(()=>{let a=a=>{try{if(ac||af||ae)return void at({type:"warning",message:"Người này đang có cuộc gọi"});let b=a.detail||{},c=!!b?.isGroup,d=c||b?.type==="video"?"video":"voice",e=String(b?.roomId||""),f=b?.selectedChat;V(e),X(c);let g=(()=>{if(!f)return c?{_id:"",members:[]}:{_id:""};let a=String(f._id||"");if(c){let b=Array.isArray(f.members)?f.members.map(a=>"object"==typeof a?{_id:String(a._id)}:String(a)):[];return{_id:a,members:b,name:f.name,avatar:f.avatar}}return{_id:a,name:f.name,avatar:f.avatar}})();Z(g),f?.name?aI(String(f.name)):aI(""),f?.avatar?aK(String(f.avatar)):aK(void 0),aM(0),a_.current=!0;let h=!c&&g&&"string"==typeof g._id&&g._id?String(g._id):void 0;ag(d,h)}catch{}};return window.addEventListener("startCall",a),()=>window.removeEventListener("startCall",a)},[ag,O]),(0,n.useEffect)(()=>{let a=a=>{at({type:"warning",message:"Người này đang có cuộc gọi"}),ai("local")};return window.addEventListener("callBusy",a),()=>window.removeEventListener("callBusy",a)},[ai]);let a_=n.default.useRef(!1),a0=n.default.useRef(!1),a1=n.default.useRef(!1);return(0,n.useEffect)(()=>{a0.current&&!ac&&!a1.current&&a_.current&&(a1.current=!0,a$("ended")),a0.current=ac,ac&&(a1.current=!1,aR.current=null)},[ac]),(0,m.jsxs)("div",{className:"flex h-screen w-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 overflow-hidden",children:[c&&(0,m.jsx)("div",{className:"hidden md:block",children:(0,m.jsx)(D,{totalUnread:k,unreadGroups:p,unreadContacts:r})}),!c&&e&&P&&(0,m.jsxs)("div",{className:"w-1/3 flex items-center justify-center p-6",children:[(0,m.jsx)("div",{className:"absolute "}),(0,m.jsx)("div",{className:"relative z-10 w-full max-w-md",children:(0,m.jsx)("div",{className:"bg-white/95 backdrop-blur-2xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden",children:(0,m.jsxs)("div",{className:"p-10 text-center",children:[(0,m.jsx)("div",{className:"w-28 h-28 mx-auto mb-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-2xl",children:(0,m.jsx)(C.HiSparkles,{className:"w-16 h-16 text-white"})}),(0,m.jsx)("h1",{className:"text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-4",children:"Hupuna"}),(0,m.jsx)("p",{className:"text-xl text-gray-700 mb-10 leading-relaxed",children:"Chào mừng bạn đến với thế hệ chat mới"}),(0,m.jsxs)("div",{className:"space-y-4",children:[(0,m.jsxs)("button",{onClick:()=>N.push("/login"),className:"w-full cursor-pointer py-5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-lg rounded-2xl shadow-xl transition-all duration-300 active:scale-95 flex items-center justify-center gap-3",children:[(0,m.jsx)(C.HiUserCircle,{className:"w-7 h-7"}),"Đăng nhập ngay"]}),(0,m.jsxs)("button",{onClick:()=>N.push("/login?mode=register"),className:"w-full cursor-pointer py-5 bg-white border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold text-lg rounded-2xl shadow-lg transition-all duration-300 active:scale-95 flex items-center justify-center gap-3",children:[(0,m.jsx)(C.HiSparkles,{className:"w-7 h-7"}),"Tạo tài khoản mới"]})]}),(0,m.jsx)("p",{className:"mt-8 text-sm text-gray-500",children:"Bắt đầu hành trình kết nối không giới hạn"})]})})})]}),(0,m.jsxs)("main",{className:`flex-1 overflow-hidden ${c&&!(g||T)?"pb-20 md:pb-0":""}`,children:[z&&(0,m.jsx)("div",{className:"fixed top-3 left-1/2 -translate-x-1/2 z-[200] pointer-events-auto",children:(0,m.jsxs)("div",{className:"flex items-center gap-2 px-4 py-2 rounded-full bg-indigo-600 text-white shadow-xl animate-pulse",children:[(0,m.jsx)("span",{className:"text-sm font-semibold",children:"Bạn có tin nhắn mới"}),(0,m.jsx)("button",{onClick:()=>A(!1),className:"ml-2 text-white/80 hover:text-white",children:"×"})]})}),a]}),c&&e&&u&&(0,m.jsx)(m.Fragment,{children:(af||ae||ac)&&(0,m.jsx)("div",{ref:aD&&("video"===ad||"voice"===ad)?aU:K,className:`fixed z-[2000] ${aD&&("video"===ad||"voice"===ad)?"rounded-xl overflow-hidden shadow-2xl ring-1 ring-black/20 bg-black cursor-move":H?"inset-0 w-screen h-screen":aF||aA?"":"inset-0 w-full h-full"}`,style:aD?"video"===ad?{left:aS.x,top:aS.y,width:240,height:160,display:"block"}:{left:aS.x,top:aS.y,width:200,height:80,display:"block"}:H?{display:"block"}:aF?{left:aw.x,top:aw.y,width:ay.w,display:"block"}:aA?{left:aw.x,top:aw.y,width:ay.w,height:"video"===ad?180:200,display:"block"}:{display:"block"},onClick:aF||!aA||aD?void 0:()=>{let a=aC.current;a&&az(a),aB(!1)},onMouseDown:aD&&("video"===ad||"voice"===ad)?a=>{a.preventDefault();let b=aU.current?.getBoundingClientRect(),c=b?.width??140,d=b?.height??48,e={sx:a.clientX,sy:a.clientY,ox:aS.x,oy:aS.y},f=a=>{aV.current=!0;let b=a.clientX-e.sx,f=a.clientY-e.sy;aT({x:Math.min(Math.max(8,e.ox+b),Math.max(8,(window.innerWidth||360)-c-8)),y:Math.min(Math.max(8,e.oy+f),Math.max(8,(window.innerHeight||640)-d-8))})},g=()=>{setTimeout(()=>aV.current=!1,0),window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",g)};window.addEventListener("mousemove",f),window.addEventListener("mouseup",g)}:!aF&&aA?aW:void 0,onTouchStart:aD&&("video"===ad||"voice"===ad)?a=>{a.preventDefault();let b=aU.current?.getBoundingClientRect(),c=b?.width??140,d=b?.height??48,e=a.touches[0],f={sx:e.clientX,sy:e.clientY,ox:aS.x,oy:aS.y},g=a=>{aV.current=!0;let b=a.touches[0],e=b.clientX-f.sx,g=b.clientY-f.sy;aT({x:Math.min(Math.max(8,f.ox+e),Math.max(8,(window.innerWidth||360)-c-8)),y:Math.min(Math.max(8,f.oy+g),Math.max(8,(window.innerHeight||640)-d-8))})},h=()=>{setTimeout(()=>aV.current=!1,0),window.removeEventListener("touchmove",g),window.removeEventListener("touchend",h)};window.addEventListener("touchmove",g,{passive:!1}),window.addEventListener("touchend",h,{passive:!1})}:!aF&&aA?aX:void 0,children:(0,m.jsxs)("div",{className:`absolute h-auto ${aD&&("video"===ad||"voice"===ad)?"inset-0 w-full h-full p-0 rounded-xl overflow-hidden":aA?"":H?"inset-0 w-full h-full":aF?"w-full md:w-[44rem] lg:w-[50rem] h-[23rem]":"inset-0 w-full h-full"} ${aD&&("video"===ad||"voice"===ad)?"bg-black":"md:rounded-xl rounded-none p-0 shadow-2xl ring-1 ring-black/10 bg-white/5 backdrop-blur"}`,children:[!aD&&(0,m.jsxs)("div",{className:"md:flex hidden items-center justify-between px-3 py-2 bg-black/70 text-white rounded-t-xl select-none",onMouseDown:H?void 0:aW,onTouchStart:H?void 0:aX,children:[(0,m.jsx)("span",{className:"text-sm",children:ac?aH||y.current.get(String(aa||U||""))?.name||"Đang gọi":af?(b=W?y.current.get(String(af?.roomId||U||aa||""))?.name:void 0,`Cuộc gọi từ ${b||aH||"Cuộc gọi đến"}`):"Đang kết nối..."}),(0,m.jsxs)("span",{className:"text-xs flex items-center",children:["video"===ad?"Video":"Thoại",ac&&aL>0?` • ${Math.floor(aL/60).toString().padStart(2,"0")}:${(aL%60).toString().padStart(2,"0")}`:"",(0,m.jsx)("button",{className:"ml-3 p-1 rounded hover:bg-white/20 cursor-pointer transition-colors",onClick:()=>I(a=>!a),title:H?"Thu nhỏ":"Phóng to",children:H?(0,m.jsx)(C.HiArrowsPointingIn,{className:"w-5 h-5"}):(0,m.jsx)(C.HiArrowsPointingOut,{className:"w-5 h-5"})}),(0,m.jsx)("button",{className:"ml-2 p-1 rounded hover:bg-white/20 cursor-pointer transition-colors",onClick:()=>aE(!0),title:"Ẩn cửa sổ gọi",children:(0,m.jsx)(C.HiMinus,{className:"w-5 h-5"})}),(0,m.jsx)("button",{className:"ml-2 p-1 rounded bg-red-600 hover:bg-red-500 text-white cursor-pointer transition-colors",onClick:()=>ai("local"),title:"Kết thúc cuộc gọi",children:(0,m.jsx)(C.HiXMark,{className:"w-5 h-5"})})]})]}),(0,m.jsxs)("div",{className:`${aD&&("video"===ad||"voice"===ad)?"w-full h-full bg-black":aA?"rounded-lg overflow-hidden bg-black":aF?"md:rounded-b-xl rounded-none md:pt-2 md:p-2 p-0 relative bg-black/20":`rounded-none p-0 h-full ${"voice"===ad?"bg-blue-500":"bg-black"}`}`,children:[aD&&("video"===ad||"voice"===ad)&&(0,m.jsxs)("div",{className:"absolute top-1 right-1 z-[2100] flex items-center gap-1",children:[(0,m.jsx)("button",{className:"p-1 rounded bg-white/20 hover:bg-white/30 text-white cursor-pointer transition-colors",onClick:a=>{a.preventDefault(),a.stopPropagation(),aV.current||aE(!1)},title:"Mở cửa sổ cuộc gọi",children:(0,m.jsx)(C.HiArrowsPointingOut,{className:"w-5 h-5"})}),(0,m.jsx)("button",{className:"p-1 rounded bg-red-600 hover:bg-red-500 text-white cursor-pointer transition-colors",onClick:a=>{a.preventDefault(),a.stopPropagation(),aV.current||ai("local")},title:"Kết thúc cuộc gọi",children:(0,m.jsx)(C.HiXMark,{className:"w-5 h-5"})})]}),af&&!ac&&!ae&&(0,m.jsx)(G.default,{avatar:W&&y.current.get(String(af?.roomId||U||aa||""))?.avatar||aJ||"/logo/avata.webp",name:W&&y.current.get(String(af?.roomId||U||aa||""))?.name||aH||"Cuộc gọi đến",callType:af.type,onAccept:async()=>{a_.current=!1,await ah()},onReject:()=>{w.current?.emit("call_reject",{roomId:String(af.roomId),targets:[String(af.from)]});try{ar(null)}catch{}a$("rejected")}}),!af&&ae&&(0,m.jsx)(J,{avatar:aJ||"/logo/avata.webp",name:aH||"Đang kết nối...",mode:"connecting",callType:"video"===ad?"video":"voice",onEndCall:()=>{ai("local"),a$("timeout")}}),ac&&am&&an&&(0,m.jsx)(j_,{serverUrl:an,token:am,onDisconnected:()=>{ai("remote")},onRequestEnd:()=>{ai("local")},onParticipantsChanged:a=>{try{let b=aR.current;if(null!==b){let c=new Set(a.map(a=>a.id)),d=new Set(b.map(a=>a.id));a.forEach(a=>{d.has(a.id)||at({type:"info",message:`${a.name||"Ai đó"} đ\xe3 tham gia cuộc gọi`})}),b.forEach(a=>{c.has(a.id)||at({type:"info",message:`${a.name||"Ai đó"} đ\xe3 rời cuộc gọi`})})}aR.current=a,aQ.current&&(window.clearTimeout(aQ.current),aQ.current=null);let c=!!ak,d="video"===ad,e=Array.isArray(a)?a.length:0;c&&d&&0===e&&(aQ.current=window.setTimeout(()=>{ai("local")},800)),!c&&d&&e+1>20&&(at({type:"warning",message:"Cuộc gọi nhóm đã đủ 20 người (tối đa 20)"}),ai("local"))}catch{}},className:`${aD&&"video"===ad?"w-full h-full":aA?"":aF?"md:rounded-xl rounded-none overflow-hidden min-h-[46vh] md:min-h-[20rem] md:max-h-[100vh]":"rounded-none overflow-hidden h-full min-h-[46vh]"}`,titleName:aH||"",callStartAt:aj,avatarUrl:aJ||"/logo/avata.webp",myName:u.name,myAvatarUrl:u.avatar,callMode:"video"===ad?"video":"voice",localPreviewSize:aA?{w:Math.max(120,Math.min(160,Math.floor(ay.w/3))),h:90}:{w:Math.max(240,Math.min(300,Math.floor(ay.w/2))),h:160},offMinHeight:aD&&("video"===ad||"voice"===ad)?120:320,uiVariant:aD&&("video"===ad||"voice"===ad)?"mini":"full"}),!af&&!ac&&!ae&&ab&&ao&&!(aq||[]).includes(String(u?._id||""))&&(0,m.jsx)("div",{className:"absolute top-3 right-3 z-50",children:(0,m.jsx)("button",{className:"px-3 py-1 rounded-full bg-green-600 text-white text-xs shadow cursor-pointer hover:bg-green-700",onClick:()=>{(Array.isArray(aq)?aq.length:0)>=20?at({type:"warning",message:"Cuộc gọi nhóm đã đủ 20 người (tối đa 20)"}):as()},title:"Tham gia cuộc gọi nhóm",children:"Tham gia"})}),!H&&!aD&&(0,m.jsx)("div",{className:"absolute bottom-1 right-1 w-4 h-4 cursor-se-resize bg-white/30 hover:bg-white/50 rounded-sm",onMouseDown:aY,onTouchStart:aY})]})]})})}),!ac&&!ae&&ab&&ao&&String($||"")===String(aa||"")&&!(aq||[]).includes(String(u?._id||""))&&(0,m.jsx)("div",{className:"fixed z-50 bottom-25 right-4 md:bottom-30 md:right-6",children:(0,m.jsx)("button",{className:"px-2 py-2 rounded-full bg-green-600 text-white shadow cursor-pointer hover:bg-green-700",onClick:()=>{(Array.isArray(aq)?aq.length:0)>=20?at({type:"warning",message:"Cuộc gọi nhóm đã đủ 20 người (tối đa 20)"}):as()},title:"Tham gia lại cuộc gọi nhóm",children:"Tham gia cuộc gọi"})}),c&&!(g||T)&&(0,m.jsx)("div",{className:"md:hidden fixed bottom-0 left-0 right-0 z-[100] pointer-events-none",children:(0,m.jsx)("div",{className:"relative pointer-events-auto bg-white border-t border-gray-200 shadow-lg",children:(0,m.jsx)("div",{className:"flex",children:S.map(a=>{let b=a.paths.some(a=>O===a||O?.startsWith(a+"/")||"/home"===a&&("/"===O||O?.startsWith("/chat"))),c=a.icon;return(0,m.jsxs)("button",{onClick:()=>{if("profile"===a.key)try{let a=String("").trim();N.push(a?`/profile/${a}`:"/profile")}catch{N.push("/profile")}else N.push(a.paths[0])},className:"cursor-pointer flex-1 py-3 flex flex-col items-center gap-1 relative",children:[(0,m.jsxs)("div",{className:"relative",children:[(0,m.jsx)(c,{className:`w-6 h-6 ${b?"text-indigo-600":"text-gray-500"}`}),"home"===a.key&&k>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-3 min-w-[1.5rem] px-1.5 h-5 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center",children:k>99?"99+":k}),"group"===a.key&&p>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-3 min-w-[1.5rem] px-1.5 h-5 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center",children:p>99?"99+":p}),"directory"===a.key&&r>0&&(0,m.jsx)("span",{className:"absolute -top-2 -right-3 min-w-[1.5rem] px-1.5 h-5 rounded-full bg-red-600 text-white text-[10px] font-bold flex items-center justify-center",children:r>99?"99+":r})]}),(0,m.jsx)("span",{className:`text-xs font-medium ${b?"text-indigo-600":"text-gray-500"}`,children:a.label}),b&&(0,m.jsx)("div",{className:"absolute bottom-0 w-10 h-0.5 bg-indigo-600 rounded-full"})]},a.key)})})})})]})};function j5({children:a}){return(0,m.jsx)(j4,{children:a})}a.s(["default",()=>j5],21328)}];

//# sourceMappingURL=src_app_%28zalo%29_layout_tsx_beb87568._.js.map