{"version":3,"sources":["../../../../src/app/%28zalo%29/invite/%5Bcode%5D/page.tsx","../../../../src/components/%28chatPopup%29/JoinGroupModal.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useRouter, useParams } from 'next/navigation';\r\nimport JoinGroupModal from '@/components/(chatPopup)/JoinGroupModal';\r\nimport { User } from '@/types/User';\r\nimport { resolveSocketUrl } from '@/utils/utils';\r\nimport { io } from 'socket.io-client';\r\n\r\nexport default function InvitePage() {\r\n  const router = useRouter();\r\n  const params = useParams();\r\n  const inviteCode = params?.code as string;\r\n  const [showModal, setShowModal] = useState(false);\r\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\r\n\r\n  useEffect(() => {\r\n    // Check if user is logged in\r\n    try {\r\n      const user = JSON.parse(localStorage.getItem('info_user') || '{}');\r\n      if (user && user._id) {\r\n        setCurrentUser(user);\r\n        setShowModal(true);\r\n      } else {\r\n        // Redirect to login with return URL\r\n        router.push(`/?redirect=/invite/${inviteCode}`);\r\n      }\r\n    } catch {\r\n      router.push(`/?redirect=/invite/${inviteCode}`);\r\n    }\r\n  }, [inviteCode, router]);\r\n\r\n  const handleJoin = async () => {\r\n    if (!currentUser || !inviteCode) return;\r\n\r\n    const prevInfoRes = await fetch(`/api/groups/invite/${inviteCode}`);\r\n    const prevInfo = await prevInfoRes.json();\r\n    const prevMembersRaw: Array<string | { _id: string; role?: string; name?: string; avatar?: string }> =\r\n      prevInfo?.group?.members || [];\r\n\r\n    const res = await fetch('/api/groups/join', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        inviteCode,\r\n        userId: currentUser._id,\r\n        userName: currentUser.name,\r\n      }),\r\n    });\r\n\r\n    const data = await res.json();\r\n\r\n    if (!res.ok || !data.success) {\r\n        throw new Error(data.message || 'Tham gia nhóm thất bại');    \r\n      }\r\n      if (data.notifyId && data.notifyContent && data.groupId) {\r\n    const socket = io(resolveSocketUrl(), { \r\n      transports: ['websocket'], \r\n      withCredentials: false \r\n    });\r\n\r\n    socket.on('connect', () => {\r\n      const prevMembers = prevMembersRaw.map((m) =>\r\n        typeof m === 'string'\r\n          ? { _id: String(m) }\r\n          : { _id: String(m._id), role: m.role, name: m.name, avatar: m.avatar },\r\n      );\r\n      const newMember = {\r\n        _id: String(currentUser._id),\r\n        role: 'MEMBER',\r\n        name: currentUser.name,\r\n        avatar: currentUser.avatar,\r\n        joinedAt: Date.now(),\r\n      };\r\n      const nextMembers = [...prevMembers, newMember];\r\n\r\n      socket.emit('group_members_updated', {\r\n        roomId: String(data.groupId),\r\n        members: nextMembers,\r\n        prevMembers,\r\n        sender: String(currentUser._id),\r\n        senderName: currentUser.name,\r\n      });\r\n\r\n      // Emit thông báo vào room\r\n      socket.emit('send_message', {\r\n        _id: data.notifyId,\r\n        roomId: data.groupId,\r\n        sender: currentUser._id,\r\n        senderName: currentUser.name || 'Thành viên mới',\r\n        type: 'notify',\r\n        content: data.notifyContent,\r\n        timestamp: Date.now(),\r\n        isGroup: true,\r\n        members: nextMembers.map((m) => m._id),\r\n      });\r\n\r\n      setTimeout(() => socket.disconnect(), 500);\r\n    });\r\n}\r\n\r\n    // Redirect to home/chat\r\n    router.push('/home');\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setShowModal(false);\r\n    router.push('/home');\r\n  };\r\n\r\n  return (\r\n    <JoinGroupModal\r\n      isOpen={showModal}\r\n      inviteCode={inviteCode}\r\n      onClose={handleClose}\r\n      onJoin={handleJoin}\r\n    />\r\n  );\r\n}\r\n","'use client';\r\n\r\nimport { getProxyUrl } from '@/utils/utils';\r\nimport Image from 'next/image';\r\nimport React, { useState, useEffect } from 'react';\r\nimport { HiX } from 'react-icons/hi';\r\nimport { PiUserCircleGearDuotone } from 'react-icons/pi';\r\n\r\n// ✅ ĐỊNH NGHĨA INTERFACE RÕ RÀNG\r\ninterface GroupInfo {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n  description?: string;\r\n  members: Array<{ _id: string; role?: string } | string>;\r\n}\r\n\r\ninterface JoinGroupModalProps {\r\n  isOpen: boolean;\r\n  inviteCode: string;\r\n  onClose: () => void;\r\n  onJoin: () => Promise<void>;\r\n}\r\n\r\nexport default function JoinGroupModal({ isOpen, inviteCode, onClose, onJoin }: JoinGroupModalProps) {\r\n  const [groupInfo, setGroupInfo] = useState<GroupInfo | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isJoining, setIsJoining] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!isOpen || !inviteCode) return;\r\n\r\n    const fetchGroupInfo = async () => {\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      try {\r\n        const res = await fetch(`/api/groups/invite/${inviteCode}`);\r\n        const data = await res.json();\r\n\r\n        if (!res.ok || !data.success) {\r\n          throw new Error(data.message || 'Link không hợp lệ hoặc đã hết hạn');\r\n        }\r\n\r\n        setGroupInfo(data.group);\r\n      } catch (err: unknown) {\r\n        const errorMessage = err instanceof Error ? err.message : 'Không thể tải thông tin nhóm';\r\n        setError(errorMessage);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    void fetchGroupInfo();\r\n  }, [isOpen, inviteCode]);\r\n\r\n  const handleJoin = async () => {\r\n    setIsJoining(true);\r\n    try {\r\n      await onJoin();\r\n      onClose();\r\n    } catch (err: unknown) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Tham gia nhóm thất bại';\r\n      alert(errorMessage);\r\n    } finally {\r\n      setIsJoining(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n      <div className=\"w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden\">\r\n        {/* Header */}\r\n        <div className=\"bg-gradient-to-br from-blue-600 to-indigo-700 text-white px-6 py-4 flex items-center justify-between\">\r\n          <h3 className=\"text-lg font-semibold\">Tham gia nhóm</h3>\r\n          <button onClick={onClose} className=\"p-1 hover:cursor-pointer hover:bg-white/20 rounded-full transition\">\r\n            <HiX className=\"w-5 h-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"p-6\">\r\n          {isLoading ? (\r\n            // Loading state\r\n            <div className=\"flex flex-col items-center justify-center py-8\">\r\n              <div className=\"w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4\" />\r\n              <p className=\"text-gray-600\">Đang tải thông tin nhóm...</p>\r\n            </div>\r\n          ) : error ? (\r\n            // Error state\r\n            <div className=\"text-center py-8\">\r\n              <div className=\"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4\">X</div>\r\n              <p className=\"text-red-600 mb-4\">{error}</p>\r\n              <button\r\n                onClick={onClose}\r\n                className=\"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition\"\r\n              >\r\n                Đóng\r\n              </button>\r\n            </div>\r\n          ) : groupInfo ? (\r\n            // Success state\r\n            <div className=\"space-y-6\">\r\n              {/* Group Info */}\r\n              <div className=\"flex flex-col items-center \">\r\n                {groupInfo.avatar ? (\r\n                  <Image\r\n                    src={getProxyUrl(groupInfo.avatar)}\r\n                    alt=\"\"\r\n                    width={36}\r\n                    height={36}\r\n                    className=\"w-20 h-20 object-cover rounded-full\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"w-[1.25rem] h-[1.25rem] bg-gradient-to-br rounded-full from-indigo-500 to-purple-600 text-white font-bold text-sm flex items-center justify-center\">\r\n                    {groupInfo.name?.charAt(0).toUpperCase()}\r\n                  </div>\r\n                )}\r\n\r\n                <h4 className=\"text-xl font-bold text-gray-800 mb-2\">{groupInfo.name}</h4>\r\n\r\n                <div className=\"flex items-center gap-2 text-gray-600\">\r\n                  <PiUserCircleGearDuotone className=\"w-4 h-4\" />\r\n                  <span className=\"text-sm\">{groupInfo.members?.length || 0} thành viên</span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Description (if exists) */}\r\n              {groupInfo.description && (\r\n                <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                  <p className=\"text-sm text-gray-700\">{groupInfo.description}</p>\r\n                </div>\r\n              )}\r\n\r\n              {/* Actions */}\r\n              <div className=\"flex gap-3\">\r\n                <button\r\n                  onClick={onClose}\r\n                  className=\"flex-1 px-4 hover:cursor-pointer py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition\"\r\n                  disabled={isJoining}\r\n                >\r\n                  Hủy\r\n                </button>\r\n                <button\r\n                  onClick={handleJoin}\r\n                  disabled={isJoining}\r\n                  className=\"flex-1 px-4 py-3 hover:cursor-pointer bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isJoining ? 'Đang tham gia...' : 'Tham gia nhóm'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ) : null}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}