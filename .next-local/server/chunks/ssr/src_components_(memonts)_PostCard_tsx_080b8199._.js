module.exports=[70579,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(71987),e=a.i(15404),f=a.i(17256);function g({images:a}){return a?.length?(0,b.jsx)("div",{className:"grid  gap-2",children:a.slice(0,4).map((a,c)=>(0,b.jsx)(d.default,{alt:`Image ${c}`,width:200,height:200,src:a,className:"w-full h-64 rounded-2xl object-cover",unoptimized:a.includes("mega.nz")},c))}):null}function h({videos:a}){return a?.length?(0,b.jsx)("div",{className:"grid  gap-2",children:a.slice(0,4).map((a,c)=>(0,b.jsx)("video",{src:a,controls:!0,className:"w-full h-64 rounded-2xl object-cover"},c))}):null}var i=a.i(99111),j=a.i(64151),k=a.i(79544);function l(a){return a.startsWith("https://mega.nz/")?`/api/mega-stream?url=${encodeURIComponent(a)}`:a}function m({post:a,onLike:m}){let n,o,p=(0,c.useMemo)(()=>(0,e.formatTimeAgo)(a.createdAt),[a.createdAt]),q=(0,c.useMemo)(()=>`/moments/${a.id}`,[a.id]),{currentUser:r,currentId:s}=(0,i.useCurrentUser)(),t=(0,c.useMemo)(()=>String(a.author.id)===String(s),[a.author.id,s]),[u,v]=(0,c.useState)(!1),[w,x]=(0,c.useState)(!1),[y,z]=(0,c.useState)(a.content||""),[A,B]=(0,c.useState)(null),[C,D]=(0,c.useState)(!1),[E,F]=(0,c.useState)([]),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(""),[K,L]=(0,c.useState)(a.comments),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)("post"),[Q,R]=(0,c.useState)(a.images||[]),[S,T]=(0,c.useState)(a.videos||[]),[U,V]=(0,c.useState)(a.files||[]),W=(0,c.useRef)(null),X=(0,c.useRef)(null),[Y,Z]=(0,c.useState)(!1),[$,_]=(0,c.useState)(0),[aa,ab]=(0,c.useState)("");(0,c.useEffect)(()=>{L(a.comments)},[a.comments]),(0,c.useEffect)(()=>{R(a.images||[]),T(a.videos||[]),V(a.files||[])},[a.images,a.videos,a.files]);let ac=async()=>{H(!0);try{let b=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"readComments",postId:a.id,limit:50}),cache:"no-store"}),c=await b.json(),d=(Array.isArray(c?.data)?c.data:[]).map(a=>({id:String(a._id??a.id??""),userId:String(a.userId||""),username:a.username?String(a.username):void 0,avatar:a.avatar?String(a.avatar):void 0,content:String(a.content||""),createdAt:Number(a.createdAt||Date.now()),parentId:a.parentId?String(a.parentId):void 0,reactions:a.reactions||{}}));F(d)}catch{}H(!1)},ad=async()=>{try{navigator.share?await navigator.share({title:"Chia sẻ bài viết",url:q}):navigator.clipboard&&(await navigator.clipboard.writeText(q),alert("Đã sao chép liên kết bài viết"))}catch{}},ae=async()=>{let a=!C;D(a),a&&0===E.length&&await ac()},[af,ag]=(0,c.useState)(null),ah=async()=>{let b=I.trim();if(b&&s)try{let c=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"addComment",postId:a.id,data:{userId:s,username:r?.name,avatar:r?.avatar,content:b,parentId:af||void 0}})}),d=await c.json(),e=String(d?._id||""),f=Date.now(),g={id:e||`${a.id}-${f}`,userId:String(s),username:String(r?.name||""),avatar:r?.avatar?String(r.avatar):void 0,content:b,createdAt:f,parentId:af||void 0,reactions:{}};F(a=>[...a,g]),L(a=>a+1),J(""),ag(null)}catch{}},ai=async(a,b)=>{let c=E.find(b=>b.id===a);if(!c||!s)return;let d=(c.reactions?.[b]||[]).includes(s);try{await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"toggleCommentReaction",commentId:a,userId:s,emoji:b,like:!d})}),F(c=>c.map(c=>{if(c.id!==a)return c;let e=c.reactions?.[b]||[],f=new Set(e);return d?f.delete(s):f.add(s),{...c,reactions:{...c.reactions||{},[b]:Array.from(f)}}}))}catch{}},aj=async a=>{if(!a)return;let b=Array.from(a).slice(0,6),c=b.length||1,d=0;for(let a of(ab("Ảnh/video"),Z(!0),_(0),b)){let b=`up_${Date.now()}_${Math.random().toString(36).slice(2)}`,e=new FormData;e.append("file",a),e.append("roomId","moments-feed"),e.append("sender","system"),e.append("type","file"),e.append("folderName","moments-feed");let f=await (0,k.uploadFileWithProgress)(`/api/upload?uploadId=${b}`,e,a=>{_(Math.min(100,d+a/c))});if(f&&"success"in f&&f.success){let b=f.link;a.type.startsWith("image/")?R(a=>[...a,b]):a.type.startsWith("video/")&&T(a=>[...a,b])}_(d=Math.min(100,d+100/c))}Z(!1)},ak=async a=>{if(!a)return;let b=Array.from(a).slice(0,6),c=b.length||1,d=0;for(let a of(ab("Tập tin"),Z(!0),_(0),b)){let b=`up_${Date.now()}_${Math.random().toString(36).slice(2)}`,e=new FormData;e.append("file",a),e.append("roomId","moments-feed"),e.append("sender","system"),e.append("type","file"),e.append("folderName","moments-feed");let f=await (0,k.uploadFileWithProgress)(`/api/upload?uploadId=${b}`,e,a=>{_(Math.min(100,d+a/c))});if(f&&"success"in f&&f.success){let a=f.link;V(b=>[...b,a])}_(d=Math.min(100,d+100/c))}Z(!1)},al=async()=>{if(t&&a.id)try{await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",field:"_id",value:a.id,data:{images:Q,videos:S,files:U}})}),N(!1)}catch{}},am=async()=>{if(t&&a.id)try{await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"delete",postId:a.id})}),v(!0)}catch{}},an=async()=>{let b=y.trim();if(!t||!b)return void x(!1);try{await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",field:"_id",value:a.id,data:{content:b}})}),B(b)}catch{}x(!1)};return(0,b.jsxs)("div",{className:"bg-white rounded-3xl border shadow-sm",children:[(0,b.jsxs)("div",{className:"p-4 flex gap-3 flex-col",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 justify-between",children:[(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)(d.default,{src:a.author.avatar?l(a.author.avatar):"",width:44,height:44,alt:"avatar",className:"rounded-full",unoptimized:!0}),(0,b.jsxs)("div",{className:"flex flex-col",children:[(0,b.jsx)("p",{className:"font-bold text-sm",children:a.author.name}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:p})]})]}),(0,b.jsx)("div",{className:"relative",children:t&&!u&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("button",{onClick:()=>N(a=>!a),className:"p-2 rounded-lg hover:bg-gray-100",children:(0,b.jsx)(f.HiEllipsisVertical,{})}),M&&(0,b.jsxs)("div",{className:"absolute right-0 top-8 bg-white border rounded-2xl shadow-xl w-64 z-10",children:[(0,b.jsxs)("div",{className:"flex border-b",children:[(0,b.jsx)("button",{onClick:()=>P("post"),className:`flex-1 py-2 text-sm ${"post"===O?"text-indigo-600 border-b-2 border-indigo-600":"text-gray-600"}`,children:"Bài viết"}),(0,b.jsx)("button",{onClick:()=>P("media"),className:`flex-1 py-2 text-sm ${"media"===O?"text-indigo-600 border-b-2 border-indigo-600":"text-gray-600"}`,children:"Media"})]}),"post"===O?(0,b.jsxs)("div",{className:"p-2",children:[(0,b.jsx)("button",{onClick:()=>{N(!1),t&&(z(A??a.content??""),x(!0))},className:"w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm",children:"Sửa nội dung"}),(0,b.jsx)("button",{onClick:()=>{N(!1),am()},className:"w-full text-left px-3 py-2 rounded-lg hover:bg-red-50 text-sm text-red-600",children:"Xóa bài viết"})]}):(0,b.jsxs)("div",{className:"p-2 space-y-2 max-h-72 overflow-y-auto",children:[Y&&(0,b.jsxs)("div",{className:"px-3 py-2 rounded-xl bg-indigo-50 border border-indigo-100",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between text-xs text-indigo-700",children:[(0,b.jsxs)("span",{children:["Đang tải lên ",aa]}),(0,b.jsxs)("span",{children:[Math.round($),"%"]})]}),(0,b.jsx)("div",{className:"mt-1 h-2 bg-gray-200 rounded-full",children:(0,b.jsx)("div",{className:"h-2 bg-indigo-600 rounded-full",style:{width:`${Math.round($)}%`}})})]}),(0,b.jsx)("input",{ref:W,type:"file",multiple:!0,accept:"image/*,video/*",className:"hidden",onChange:a=>aj(a.target.files)}),(0,b.jsx)("input",{ref:X,type:"file",multiple:!0,className:"hidden",onChange:a=>ak(a.target.files)}),Q.length>0&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"text-xs text-gray-500 mb-1",children:["Ảnh (",Q.length,")"]}),Q.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between px-3 py-1 rounded-lg hover:bg-gray-100",children:[(0,b.jsxs)("span",{className:"text-xs",children:["Ảnh ",c+1]}),(0,b.jsx)("button",{onClick:()=>{R(a=>a.filter((a,b)=>b!==c))},className:"text-xs text-red-600",children:"Xóa"})]},c))]}),S.length>0&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"text-xs text-gray-500 mb-1",children:["Video (",S.length,")"]}),S.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between px-3 py-1 rounded-lg hover:bg-gray-100",children:[(0,b.jsxs)("span",{className:"text-xs",children:["Video ",c+1]}),(0,b.jsx)("button",{onClick:()=>{T(a=>a.filter((a,b)=>b!==c))},className:"text-xs text-red-600",children:"Xóa"})]},c))]}),U.length>0&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"text-xs text-gray-500 mb-1",children:["File (",U.length,")"]}),U.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between px-3 py-1 rounded-lg hover:bg-gray-100",children:[(0,b.jsxs)("span",{className:"text-xs",children:["File ",c+1]}),(0,b.jsx)("button",{onClick:()=>{V(a=>a.filter((a,b)=>b!==c))},className:"text-xs text-red-600",children:"Xóa"})]},c))]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 pt-1",children:[(0,b.jsx)("button",{disabled:Y,onClick:()=>W.current?.click(),className:`px-3 py-1 rounded-lg text-sm ${Y?"bg-gray-200 text-gray-400":"bg-gray-100"}`,children:"Thêm ảnh/video"}),(0,b.jsx)("button",{disabled:Y,onClick:()=>X.current?.click(),className:`px-3 py-1 rounded-lg text-sm ${Y?"bg-gray-200 text-gray-400":"bg-gray-100"}`,children:"Thêm file"})]}),(0,b.jsx)("div",{className:"pt-2",children:(0,b.jsx)("button",{onClick:al,className:"w-full px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm",children:"Lưu thay đổi media"})})]})]})]})})]}),w&&(0,b.jsxs)("div",{className:"px-4",children:[(0,b.jsx)("textarea",{value:y,onChange:a=>z(a.target.value),className:"w-full rounded-xl border p-2 text-sm",rows:3}),(0,b.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,b.jsx)("button",{onClick:an,className:"px-3 py-1 rounded-xl bg-indigo-600 text-white text-sm",children:"Lưu"}),(0,b.jsx)("button",{onClick:()=>x(!1),className:"px-3 py-1 rounded-xl bg-gray-200 text-sm",children:"Huỷ"})]})]}),(0,b.jsxs)("div",{className:"flex-1",children:[!u&&(A??a.content)?(0,b.jsx)("p",{className:"mt-2 px-4 text-sm whitespace-pre-line",children:A??a.content}):null,Q.length&&!u?(0,b.jsx)(g,{images:Q}):null,S.length?(0,b.jsx)(h,{videos:S}):null,U.length?(0,b.jsx)("div",{className:"mt-2 space-y-2",children:U.map((a,c)=>(0,b.jsxs)("a",{href:l(a),className:"block bg-gray-100 px-3 py-2 rounded-xl text-sm",target:"_blank",children:["File ",c+1]},c))}):null]})]}),(0,b.jsxs)("div",{className:"px-4 pb-3 flex justify-between text-xs text-gray-500",children:[(0,b.jsxs)("div",{className:"flex gap-1 items-center",children:[(0,b.jsx)(f.HiHandThumbUp,{className:"text-indigo-600"}),a.likes]}),(0,b.jsxs)("span",{children:[K," bình luận"]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-2 px-2 pb-3",children:[(0,b.jsxs)("button",{onClick:()=>m(a.id),className:"bg-gray-100 py-2 rounded-2xl flex items-center justify-center gap-2",children:[(0,b.jsx)(f.HiHandThumbUp,{})," Thích"]}),(0,b.jsxs)("button",{onClick:ae,className:"bg-gray-100 py-2 rounded-2xl flex items-center justify-center gap-2",children:[(0,b.jsx)(f.HiChatBubbleLeftRight,{})," Bình luận"]}),(0,b.jsxs)("a",{href:q,className:"bg-gray-100 py-2 rounded-2xl flex items-center justify-center gap-2",onClick:a=>{a.preventDefault(),ad()},children:[(0,b.jsx)(f.HiArrowUpTray,{})," Chia sẻ"]})]}),C&&(0,b.jsxs)("div",{className:"px-4 pb-4",children:[(0,b.jsx)("div",{className:"space-y-3",children:G?(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"Đang tải bình luận..."}):0===E.length?(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"Chưa có bình luận"}):(n={},E.forEach(a=>{let b=a.parentId||"__root__";(n[b]||=[]).push(a)}),o=(a,c)=>(0,b.jsxs)("div",{className:`flex items-start gap-2 ${c>0?"pl-10":""}`,children:[(0,b.jsx)(d.default,{src:a.avatar?l(a.avatar):"",width:c>0?24:28,height:c>0?24:28,alt:"avatar",className:"rounded-full",unoptimized:!0}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("p",{className:"text-xs font-semibold",children:a.username||"Người dùng"}),(0,b.jsx)("span",{className:"text-[10px] text-gray-500",children:(0,e.formatTimeAgo)(a.createdAt)})]}),(0,b.jsx)("p",{className:"text-sm",children:a.content}),(0,b.jsxs)("div",{className:"mt-2 flex items-center gap-2 relative",children:[(0,b.jsx)("div",{className:"relative",children:(0,b.jsx)(j.default,{isMine:String(a.userId)===String(s),visible:!0,className:"static translate-y-0 top-auto",onPick:b=>ai(a.id,b)})}),(0,b.jsx)("button",{onClick:()=>{let b;return ag(a.id),b=a.username?`@${a.username} `:"",void J(a=>a||b)},className:"text-xs text-indigo-600",children:"Trả lời"})]}),a.reactions&&Object.keys(a.reactions).length>0&&(0,b.jsx)("div",{className:"mt-1 flex flex-wrap gap-1 text-xs",children:Object.entries(a.reactions).map(([a,c])=>(0,b.jsxs)("span",{className:"px-2 py-0.5 rounded-full bg-gray-100",children:[a," ",c.length]},a))}),(n[a.id]||[]).map(a=>o(a,c+1))]})]},a.id),(n.__root__||[]).map(a=>(0,b.jsx)("div",{className:"space-y-2",children:o(a,0)},a.id)))}),(0,b.jsxs)("div",{className:"mt-3 flex items-center gap-2",children:[(0,b.jsx)("input",{value:I,onChange:a=>J(a.target.value),placeholder:s?"Viết bình luận...":"Đăng nhập để bình luận",className:"flex-1 px-3 py-2 rounded-xl border",disabled:!s}),(0,b.jsx)("button",{onClick:ah,disabled:!s||!I.trim(),className:"px-3 py-2 rounded-xl bg-indigo-600 text-white",children:"Gửi"})]})]})]})}a.s(["default",()=>m],70579)}];

//# sourceMappingURL=src_components_%28memonts%29_PostCard_tsx_080b8199._.js.map