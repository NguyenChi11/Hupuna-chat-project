module.exports=[36884,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),a=e.i(61916),s=e.i(14444),o=e.i(37092),l=e.i(69741),d=e.i(16795),u=e.i(87718),p=e.i(95169),m=e.i(47587),c=e.i(66012),g=e.i(70101),f=e.i(26937),h=e.i(10372),y=e.i(93695);e.i(52474);var S=e.i(220),w=e.i(89171),R=e.i(58632),N=e.i(538),v=e.i(22437),_=e.i(81769);let I=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/Ä‘/g,"d").replace(/Ä/g,"D").toLowerCase();async function A(e){let t="12119819-aca3-4965-86fe-633ab89cd21a",r=process.env.ONESIGNAL_REST_API_KEY||"";if(!t||!r)return;let n=String(e.roomId),i=String(e.senderId),a=[],s="Tin nháº¯n má»›i",o=e.content||"Báº¡n cÃ³ tin nháº¯n má»›i";try{let e=await (0,R.getAllRows)(v.USERS_COLLECTION_NAME,{filters:{_id:_.ObjectId.isValid(i)?new _.ObjectId(i):i},limit:1}),t=e.data?.[0];t&&t.name&&(s=t.name)}catch(e){console.warn("sendPushOnMessage:getSender",e)}if(n.includes("_")){let e=n.split("_");a=[String(e.find(e=>String(e)!==i)||e[0])]}else try{let e=await (0,R.getAllRows)("Groups",{filters:{_id:_.ObjectId.isValid(n)?new _.ObjectId(n):n},limit:1}),t=e.data?.[0];if(t){s=t.name||s;let e=(Array.isArray(t.members)?t.members:[]).map(e=>"string"==typeof e?String(e):e._id?String(e._id):e.id?String(e.id):"").filter(e=>e&&e!==i);a=Array.from(new Set(e))}}catch(e){console.warn("sendPushOnMessage:getGroup",e)}let l=Array.from(new Set([...a,i])).filter(Boolean);if(0===l.length)return;let d=[];try{let e=await (0,R.getAllRows)(v.USERS_COLLECTION_NAME,{filters:{_id:{$in:l.map(e=>_.ObjectId.isValid(e)?new _.ObjectId(e):e)}},limit:9999});d=Array.from(new Set((e.data||[]).map(e=>Array.isArray(e.onesignalSubs)?e.onesignalSubs:[]).flat().filter(e=>"string"==typeof e&&e.trim().length>0)))}catch(e){console.warn("sendPushOnMessage:getSubscriptions",e)}let u=d.length>0?{app_id:t,include_subscription_ids:d,target_channel:"push",contents:{en:o,vi:o},headings:{en:s,vi:s},isAnyWeb:!0}:{app_id:t,include_aliases:{external_id:l},target_channel:"push",contents:{en:o,vi:o},headings:{en:s,vi:s},isAnyWeb:!0};try{let e=async e=>{let t=0,n=null;for(;t<3&&!(n=await fetch("https://api.onesignal.com/notifications",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`key ${r}`},body:JSON.stringify(e)})).ok;)++t<3&&await new Promise(e=>setTimeout(e,300*Math.pow(2,t-1)));return n};if(!(await e(u)).ok){let r={app_id:t,target_channel:"push",isAnyWeb:!0,filters:l.map(e=>({field:"tag",relation:"=",key:"userId",value:e})).flatMap((e,t)=>0===t?[e]:[{operator:"OR"},e]),contents:{en:o,vi:o},headings:{en:s,vi:s}},n=await e(r);if(!n.ok){let e=await n.text().catch(()=>"");console.error("sendPushOnMessage:onesignal",n.status,e)}}}catch(e){console.error("sendPushOnMessage:send",e)}}async function b(e){let{action:t,collectionName:r=N.MESSAGES_COLLECTION_NAME,data:n,filters:i,field:a,value:s,skip:o,limit:l,_id:d,code:u,sort:p,roomId:m,userId:c,messageId:g,assetType:f,beforeTs:h}=await e.json();try{switch(t){case"create":{let e=String(n?.type||"").toLowerCase(),t={...n,timestamp:Date.now(),readBy:[String(n.sender)]};if("poll"===e){let e=String(n?.pollQuestion??n?.content??"").trim(),r=(Array.isArray(n.pollOptions)?n.pollOptions:[]).map(e=>String(e||"").trim()).filter(e=>e),i=Array.from(new Set(r.map(e=>e.toLowerCase()))).map(e=>r.find(t=>t.toLowerCase()===e));if(!e||i.length<2)return w.NextResponse.json({error:"Invalid poll"},{status:400});t={...t,type:"poll",content:e,pollQuestion:e,pollOptions:i,pollVotes:{},isPollLocked:!!n.isPollLocked}}t._id&&delete t._id,t.id&&delete t.id;let i=await (0,R.addRow)(r,t);return Promise.resolve().then(()=>A({roomId:String(t.roomId),senderId:String(t.sender),content:String(t.content||"")})).catch(e=>{console.error("messages.create:push",e)}),w.NextResponse.json({success:!0,_id:i})}case"read":{let{roomId:e,isPinned:t,searchQuery:n,...a}=i||{},s={};if(e){let t=[e],r=Number(e);Number.isNaN(r)||t.push(r),_.ObjectId.isValid(String(e))&&t.push(new _.ObjectId(String(e))),s.roomId={$in:t}}void 0!==t&&(s.isPinned=t);let d={...s};for(let[e,t]of Object.entries(a||{}))"timestamp"!==e&&(d[e]=t);n&&"string"==typeof n&&n.trim()&&(!a||!Object.keys(a).includes("type"))&&(d.type={$ne:"notify"});let u=(a||{}).timestamp;if(u&&"object"==typeof u){let e=["$lt","$lte","$gt","$gte"].find(e=>e in u);if(e){let t=u[e];d.$or=[{timestamp:u},{$expr:{[e]:[{$toDouble:"$timestamp"},t]}}]}}let m=await (0,R.getAllRows)(r,{search:void 0,skip:o,limit:l,filters:d,sort:p,collation:{locale:"vi",strength:1,normalization:!0}}),c=m.data||[];if(n&&"string"==typeof n&&n.trim()){let e=I(n);c=c.filter(t=>{let r="file"===t.type?String(t.fileName||""):"sticker"===t.type?"":String(t.content||"");return I(r).includes(e)})}let g=[...new Set(c.map(e=>{let t=e.sender;return t&&"object"==typeof t&&null!==t&&"_id"in t?String(t._id):String(e.sender)}))].map(e=>{if(_.ObjectId.isValid(e))return new _.ObjectId(e);let t=Number(e);return Number.isNaN(t)?e:t}),f=await (0,R.getAllRows)(v.USERS_COLLECTION_NAME,{filters:{_id:{$in:g}},limit:999999}),h=new Map;(f.data||[]).forEach(e=>h.set(String(e._id),e));let y=c.map(e=>{let t=h.get(String(e.sender));return{...e,sender:t?{_id:String(t._id),name:t.name,avatar:t.avatar}:{_id:String(e.sender),name:"Unknown",avatar:null}}}),S=Array.from(new Map(y.map(e=>[String(e._id),e])).values());return w.NextResponse.json({total:m.total,data:S})}case"readAssets":{if(!m)return w.NextResponse.json({error:"Missing roomId"},{status:400});let e=String(f||"").toLowerCase(),t="number"==typeof l&&l>0?Math.min(l,5e3):6,n=/\.(mp4|mov|mkv|webm|avi|m4v)$/i,i=/(https?:\/\/|www\.)\S+/i,a={roomId:m,isRecalled:{$ne:!0}};"number"==typeof h&&h>0&&(a.timestamp={$lte:h});let s={...a};if("media"===e)s={...a,$or:[{type:"image"},{type:"video"},{$and:[{type:"file"},{$or:[{fileUrl:{$regex:n}},{fileName:{$regex:n}}]}]}]};else if("file"===e)s={...a,type:"file",$nor:[{fileUrl:{$regex:n}},{fileName:{$regex:n}}]};else{if("link"!==e)return w.NextResponse.json({error:"Invalid assetType"},{status:400});s={...a,type:"text",content:{$regex:i}}}let o=await (0,R.getAllRows)(r,{filters:s,limit:t,sort:{field:"timestamp",order:"desc"}}),d=(o.data||[]).map(t=>{if("media"===e){let e="video"===t.type||n.test(String(t.fileUrl||t.fileName||""));return{id:String(t._id),url:String(t.fileUrl||""),fileName:t.fileName,type:e?"video":"image",timestamp:Number(t.timestamp)||Date.now()}}if("file"===e)return{id:String(t._id),url:String(t.fileUrl||t.content||""),fileName:t.fileName||"TÃ i liá»‡u",timestamp:Number(t.timestamp)||Date.now()};{let e=String(t.content||"").match(i),r=e?String(e[0]):"";return{id:String(t._id),url:r,timestamp:Number(t.timestamp)||Date.now()}}}),u=new Map;d.forEach(e=>{var t,r;let n,i,a,s,o,l,d,p,m=(t=e.timestamp,i=(n=new Date(t)).getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0"),`${i}-${a}-${s}`);u.has(m)||u.set(m,{dateKey:m,dateLabel:(r=e.timestamp,o=new Date(r),l=new Date,(d=new Date).setDate(d.getDate()-1),(p=(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())(o,l)?"HÃ´m nay":p(o,d)?"HÃ´m qua":o.toLocaleDateString("vi-VN")),items:[]}),u.get(m).items.push(e)});let p=Array.from(u.values());p.sort((e,t)=>e.dateKey<t.dateKey?1:e.dateKey>t.dateKey?-1:0),p.forEach(e=>e.items.sort((e,t)=>t.timestamp-e.timestamp));let c=(o.data||[]).length>0?Math.min(...(o.data||[]).map(e=>e.timestamp)):null;return w.NextResponse.json({success:!0,total:o.total||d.length,groups:p,nextCursor:c})}case"recall":{if(!g)return w.NextResponse.json({error:"Missing messageId"},{status:400});let e=await (0,R.updateByField)(r,"_id",g,{isRecalled:!0});return w.NextResponse.json({success:!0,result:e})}case"markAsRead":{if(!m||!c)return w.NextResponse.json({error:"Missing roomId or userId"},{status:400});let e=String(c),t=[e,Number.isNaN(Number(e))?void 0:Number(e)].filter(e=>void 0!==e),n={roomId:String(m),readBy:{$nin:t}},i=await (0,R.updateMany)(r,n,{$addToSet:{readBy:e}});return w.NextResponse.json({success:!0,result:i})}case"togglePin":{if(!g||!n||"boolean"!=typeof n.isPinned)return w.NextResponse.json({error:"Missing messageId or invalid data/isPinned status"},{status:400});let e=n.isPinned,t=n.pinnedTitle,i={isPinned:e,pinnedAt:e?Date.now():null};null!=t&&(i.pinnedTitle=String(t));let a=await (0,R.updateByField)(r,"_id",g,i);return w.NextResponse.json({success:!0,result:a})}case"getById":return w.NextResponse.json(await (0,R.getRowByIdOrCode)(r,{_id:d,code:u}));case"update":{if(!a||void 0===s)return w.NextResponse.json({error:"Missing field or value"},{status:400});let e=String(a),t="string"==typeof s||"number"==typeof s?s:String(s),i=await (0,R.updateByField)(r,e,t,n);return w.NextResponse.json({success:i})}case"updateMany":{if(!i||!n)return w.NextResponse.json({error:"Missing filters or data"},{status:400});let e={...i};e._id&&"string"==typeof e._id&&(_.ObjectId.isValid(e._id)?e._id=new _.ObjectId(e._id):isNaN(Number(e._id))||(e._id=Number(e._id)));let t=await (0,R.updateMany)(r,e,{$set:n});return w.NextResponse.json({success:!0,matchedCount:t.matchedCount,modifiedCount:t.modifiedCount})}case"delete":{if(!a||void 0===s)return w.NextResponse.json({error:"Missing field or value"},{status:400});let e="_id"===String(a),t=!1;if(e)t=await (0,R.deleteById)(r,String(s));else{let e=String(a),n="string"==typeof s||"number"==typeof s?s:String(s);t=await (0,R.deleteByField)(r,e,n)}return w.NextResponse.json({success:t})}case"clearHistory":{if(!m)return w.NextResponse.json({error:"Missing roomId"},{status:400});let e=await (0,R.deleteManyRows)(r,{roomId:String(m)});return w.NextResponse.json({success:!0,deletedCount:e?.deletedCount??void 0})}case"globalSearch":{let e=n?.searchTerm,t=n?.userId;if(!e||!t)return w.NextResponse.json({error:"Missing userId or searchTerm"},{status:400});let i=[],a=new Map;try{let e=await (0,R.getAllRows)("Groups",{filters:{},limit:9999}),r=e=>{if(!e)return null;if("string"==typeof e)return e;if("object"==typeof e){if("_id"in e&&e._id)return String(e._id);if("id"in e&&e.id)return String(e.id)}return null};(e.data||[]).filter(e=>!!(e.members&&Array.isArray(e.members)&&e.members.some(e=>{let n=r(e);return String(n)===String(t)}))||!1).forEach(e=>{let t=String(e._id);i.push(t);let n=[];e.members&&Array.isArray(e.members)&&(n=e.members.map(e=>r(e)||String(e))),a.set(t,{_id:t,name:e.name||"NhÃ³m",avatar:e.avatar,isGroup:!0,members:n})})}catch(e){console.error("âŒ [API] Error fetching groups:",e)}let s=I(String(e||"")),o=[],l=new Map;try{let e=await (0,R.getAllRows)(v.USERS_COLLECTION_NAME,{filters:{},limit:9999});(e.data||[]).forEach(e=>{l.set(String(e._id),e)}),(e.data?.filter(e=>String(e._id)!==String(t))||[]).forEach(e=>{let r=[t,String(e._id)].sort(),n=`${r[0]}_${r[1]}`;o.push(n)})}catch(e){console.error("âŒ [API] Error generating 1-1 rooms:",e)}let d=[...i,...o],u=await (0,R.getAllRows)(r,{filters:{$and:[{roomId:{$in:d}},{isDeleted:{$ne:!0}},{isRecalled:{$ne:!0}},{type:{$ne:"notify"}}]},limit:n.limit||100,sort:{field:"timestamp",order:"desc"},collation:{locale:"vi",strength:1,normalization:!0}}),p=u.data||[];if(s&&(p=p.filter(e=>{let t="file"===e.type?String(e.fileName||""):"sticker"===e.type?"":String(e.content||"");return I(t).includes(s)})),!p.length)return w.NextResponse.json({success:!0,data:[],total:0});let m=p.map(e=>{let r=String(e.sender),n=l.get(r),i=r===t,s={roomId:e.roomId,roomName:"Cuá»™c trÃ² chuyá»‡n",roomAvatar:null,isGroupChat:!1,partnerId:null,partnerName:"NgÆ°á»i dÃ¹ng",partnerAvatar:null};if(a.has(e.roomId)){let t=a.get(e.roomId);s.isGroupChat=!0,s.roomId=e.roomId,s.roomName=t?.name||"NhÃ³m",s.roomAvatar=t?.avatar||null,s.partnerId=null}else{s.isGroupChat=!1;let n=null;if(e.roomId&&e.roomId.includes("_")){let r=e.roomId.split("_");n=r[0]===t?r[1]:r[0]}else i&&e.receiver?n=String(e.receiver):i||(n=r);if(n){let e=l.get(n);s.partnerId=n,s.partnerName=e?.name||"NgÆ°á»i dÃ¹ng",s.partnerAvatar=e?.avatar||null,s.roomName=s.partnerName,s.roomAvatar=s.partnerAvatar;let r=[t,n].sort();s.roomId=`${r[0]}_${r[1]}`}}let o="";o="file"===e.type&&e.fileName?`ðŸ“Ž ${e.fileName}`:"image"===e.type?"ðŸ–¼ï¸ HÃ¬nh áº£nh":"sticker"===e.type?"ðŸ˜Š Sticker":"video"===e.type?"ðŸŽ¥ Video":e.content||"Tin nháº¯n";let d=i?"Báº¡n":n?.name||`User ${r.slice(0,8)}`,u=s.isGroupChat?s.roomName:s.partnerName;return{_id:String(e._id),type:e.type,content:e.content,fileName:e.fileName,fileUrl:e.fileUrl,timestamp:e.timestamp,sender:r,senderName:d,senderAvatar:n?.avatar||null,isMyMessage:i,receiver:e.receiver?String(e.receiver):null,...s,displaySenderName:d,displayRoomName:u,contentPreview:o,replyToMessageId:e.replyToMessageId,replyToMessageName:e.replyToMessageName}}),c={text:m.filter(e=>"text"===e.type),file:m.filter(e=>"file"===e.type),image:m.filter(e=>"image"===e.type),video:m.filter(e=>"video"===e.type),sticker:m.filter(e=>"sticker"===e.type),reminder:m.filter(e=>"reminder"===e.type),all:m},g={group:m.filter(e=>e.isGroupChat),oneToOne:m.filter(e=>!e.isGroupChat),all:m};return w.NextResponse.json({success:!0,data:m,total:u.total||m.length,metadata:{searchTerm:e,totalResults:m.length,byType:{text:c.text.length,file:c.file.length,image:c.image.length,video:c.video.length,sticker:c.sticker.length,reminder:c.reminder.length},bySource:{group:g.group.length,oneToOne:g.oneToOne.length}}})}case"readReminders":{let e=n?.userId,t="number"==typeof n?.untilTs?n.untilTs:void 0,i="number"==typeof n?.fromTs?n.fromTs:void 0;if(!e)return w.NextResponse.json({error:"Missing userId"},{status:400});let a=[];try{((await (0,R.getAllRows)("Groups",{filters:{},limit:9999})).data||[]).filter(t=>!!(t.members&&Array.isArray(t.members))&&t.members.some(t=>String((e=>{if(!e)return null;if("string"==typeof e)return e;if("object"==typeof e){if("_id"in e&&e._id)return String(e._id);if("id"in e&&e.id)return String(e.id)}return null})(t))===String(e))).forEach(e=>a.push(String(e._id)))}catch(e){console.error("messages.searchReminders:getGroups",e)}let s=[];try{((await (0,R.getAllRows)(v.USERS_COLLECTION_NAME,{filters:{},limit:9999})).data||[]).filter(t=>String(t._id)!==String(e)).forEach(t=>{let r=[e,String(t._id)].sort(),n=`${r[0]}_${r[1]}`;s.push(n)})}catch(e){console.error("messages.searchReminders:getUsers",e)}let o=[...a,...s],l={type:"reminder",isDeleted:{$ne:!0},isRecalled:{$ne:!0},reminderFired:{$ne:!0},$or:[{roomId:{$in:o}},{sender:String(e)}]};("number"==typeof i||"number"==typeof t)&&(l.reminderAt={..."number"==typeof i?{$gte:i}:{},..."number"==typeof t?{$lte:t}:{}});let d=await (0,R.getAllRows)(r,{filters:l,limit:n?.limit||5e3,sort:{field:"reminderAt",order:"asc"}});return w.NextResponse.json({success:!0,data:d.data||[],total:d.total||0})}case"fireReminder":{if(!g||!c)return w.NextResponse.json({error:"Missing messageId or userId"},{status:400});let e=await (0,R.getRowByIdOrCode)(r,{_id:g}),t=e?.row??null;if(!t||"reminder"!==t.type)return w.NextResponse.json({success:!1,updated:!1});let n=t.reminderAt||t.timestamp||Date.now();if(n>Date.now()+6e4)return w.NextResponse.json({success:!0,updated:!1,message:"Reminder is in the future"});let i=t.reminderRepeat||"none",a=null;if("daily"===i)a=n+864e5;else if("weekly"===i)a=n+6048e5;else if("monthly"===i){let e=new Date(n);e.setMonth(e.getMonth()+1),a=e.getTime()}let s=a?{reminderAt:a,reminderFired:!1,editedAt:Date.now()}:{reminderFired:!0},o={_id:_.ObjectId.isValid(String(g))?new _.ObjectId(String(g)):String(g),type:"reminder",reminderFired:{$ne:!0},reminderAt:n},l=await (0,R.updateMany)(r,o,{$set:s});if(!l?.modifiedCount)return w.NextResponse.json({success:!0,updated:!1});let d=new Date(n).toLocaleString("vi-VN"),u=`Äáº¿n giá» lá»‹ch háº¹n: "${String(t.content||"")}" l\xfac ${d}`,p=await (0,R.addRow)(r,{roomId:String(t.roomId),sender:String(c),type:"notify",content:u,timestamp:Date.now(),replyToMessageId:String(t._id)});try{let e=function(){throw Error("Socket.IO instance not initialized")}(),r=String(t.roomId);e.in(r).emit("receive_message",{_id:p,roomId:r,sender:String(c),type:"notify",content:u,timestamp:Date.now(),replyToMessageId:String(t._id)}),a&&e.in(r).emit("edit_message",{_id:String(t._id),roomId:r,reminderAt:a,editedAt:Date.now()})}catch(e){console.error("âŒ Socket emit error:",e)}return Promise.resolve().then(()=>A({roomId:String(t.roomId),senderId:String(c),content:u})).catch(e=>{console.error("messages.fireReminder:push",e)}),w.NextResponse.json({success:!0,updated:!0,notifyId:p,nextAt:a})}case"editMessage":{let{messageId:e,newContent:t}=n,i=await (0,R.getRowByIdOrCode)(r,{_id:e}),a=i?.row.originalContent||i?.row.content;if(!e||!t||"string"!=typeof t||!i)return w.NextResponse.json({error:"Invalid data or message not found"},{status:400});let s={content:t,editedAt:Date.now(),originalContent:a},o=await (0,R.updateByField)(r,"_id",e,s);return w.NextResponse.json({success:!0,result:o})}default:return w.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("MongoDB API Error:",e),w.NextResponse.json({error:"Server error"},{status:500})}}e.s(["POST",()=>b],69230);var x=e.i(69230);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/messages/route",pathname:"/api/messages",filename:"route",bundlePath:""},distDir:".next-local",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/messages/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:C,workUnitAsyncStorage:O,serverHooks:M}=E;function j(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:O})}async function $(e,t,n){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/messages/route";w=w.replace(/\/index$/,"")||"/";let R=await E.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:N,params:v,nextConfig:_,parsedUrl:I,isDraftMode:A,prerenderManifest:b,routerServerContext:x,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,resolvedPathname:M,clientReferenceManifest:j,serverActionsManifest:$}=R,T=(0,l.normalizeAppPath)(w),P=!!(b.dynamicRoutes[T]||b.routes[M]),D=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,I,!1):t.end("This page could not be found"),null);if(P&&!A){let e=!!b.routes[M],t=b.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(_.experimental.adapterPath)return await D();throw new y.NoFallbackError}}let k=null;!P||E.isDev||A||(k="/index"===(k=M)?"/":k);let U=!0===E.isDev||!P,L=P&&!U;$&&j&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:j,serverActionsManifest:$,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:$})});let B=e.method||"GET",F=(0,a.getTracer)(),H=F.getActiveScopeSpan(),G={params:v,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!_.experimental.authInterrupts},cacheComponents:!!_.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:_.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>E.onRequestError(e,t,n,x)},sharedContext:{buildId:N}},q=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(q,(0,u.signalFromNodeResponse)(t));try{let s=async e=>E.handle(V,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${B} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${w}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&C&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=G.renderOpts.collectedTags;if(!P)return await (0,c.sendResponse)(q,K,a,G.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,n=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:S.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})},x),t}},u=await E.handleResponse({req:e,nextConfig:_,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!P)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==S.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&P||p.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,c.sendResponse)(q,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};H?await l(H):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${B} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})}),P)throw t;return await (0,c.sendResponse)(q,K,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>j,"routeModule",()=>E,"serverHooks",()=>M,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>O],36884)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_89a6ba80.js.map