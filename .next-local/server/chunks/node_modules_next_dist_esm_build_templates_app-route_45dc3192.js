module.exports=[53105,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),s=e.i(59756),a=e.i(61916),i=e.i(14444),o=e.i(37092),d=e.i(69741),l=e.i(16795),u=e.i(87718),c=e.i(95169),p=e.i(47587),m=e.i(66012),N=e.i(70101),f=e.i(26937),g=e.i(10372),b=e.i(93695);e.i(52474);var R=e.i(220),w=e.i(89171),h=e.i(58632);let _="Groups";var O=e.i(81769),j=e.i(22437),y=e.i(538),E=e.i(4559);function x(e){if(!e)return null;if("string"==typeof e)return e;if("object"==typeof e){if("_id"in e&&e._id)return String(e._id);if("id"in e&&e.id)return String(e.id)}return null}function S(e){let t=[{_id:e}];return isNaN(Number(e))||t.push({_id:Number(e)}),O.ObjectId.isValid(e)&&t.push({_id:new O.ObjectId(e)}),t}async function A(e){let{action:t,data:r,_id:n,conversationId:s,newMembers:a,targetUserId:i,roomId:o}=await e.json();try{let e=await (0,h.getCollection)(_);switch(t){case"createGroup":{if(!r||!r.name||!Array.isArray(r.members)||r.members.length<2)return w.NextResponse.json({error:"Missing data or not enough members"},{status:400});let e=r.members.map(e=>({_id:e,role:e===r.createdBy?"OWNER":"MEMBER",joinedAt:Date.now(),addedBy:r.createdBy})),t={name:r.name,members:e,isGroup:!0,createdBy:r.createdBy,createdAt:Date.now(),avatar:r.avatar},n=await (0,h.addRow)(_,t);return w.NextResponse.json({success:!0,group:{...t,_id:n}})}case"readGroups":{if(!n)return w.NextResponse.json({error:"Missing _id"},{status:400});let e=String(n),t=[e];isNaN(Number(e))||t.push(Number(e));let r=S(e).map(e=>({"members._id":e._id})),s=await (0,h.getAllRows)(_,{filters:{isGroup:!0,$or:r}}),a=s.data||[];if(!a.length)return w.NextResponse.json(s);let i=Array.from(new Set(a.flatMap(e=>(e.members||[]).map(x).filter(e=>!!e)))),o=[];i.forEach(e=>{o.push({_id:e}),isNaN(Number(e))||o.push({_id:Number(e)}),O.ObjectId.isValid(e)&&o.push({_id:new O.ObjectId(e)})});let d=await (0,h.getAllRows)(j.USERS_COLLECTION_NAME,{filters:o.length>0?{$or:o}:{}}),l=new Map;(d.data||[]).forEach(e=>{if(e._id){let t=String(e._id);l.set(t,e),isNaN(Number(t))||l.set(String(Number(t)),e)}});let u=a.map(e=>{let t=Array.isArray(e.members)?e.members:[],r=t.some(e=>e&&"object"==typeof e&&"OWNER"===e.role),n=null,s=e.createdBy?String(e.createdBy):null;!r&&t.length>0&&(n=s&&t.some(e=>x(e)===s)?s:x(t[0]));let a=t.map(e=>{let t,r=x(e),s="object"==typeof e?{...e}:{_id:r??""};return(s.role&&["OWNER","ADMIN","MEMBER"].includes(s.role)||(n&&r===n?s.role="OWNER":s.role="MEMBER"),r&&((t=l.get(r))||isNaN(Number(r))||(t=l.get(String(Number(r))))),t)?{...s,_id:r??"",name:t.name,avatar:t.avatar}:{...s,_id:r??"",name:s.name??"Unknown User"}});return{...e,_id:e._id.toString(),members:a}}),c=await (0,h.getCollection)(y.MESSAGES_COLLECTION_NAME),p=(await Promise.allSettled(u.map(async r=>{let n=await c.countDocuments({roomId:r._id,readBy:{$nin:t}}),s=(await c.find({roomId:r._id}).sort({timestamp:-1}).limit(1).toArray())[0],a=r.isPinnedBy?.[e]===!0,i=r.isHiddenBy?.[e]===!0,o="";if(s){let t="",n=String(s.sender);if(n===e)t="Bạn";else{let e=Array.isArray(r.members)?r.members:[],s=e.find(e=>String(e._id)===n)||e.find(e=>!isNaN(Number(String(e._id)))&&!isNaN(Number(n))&&Number(String(e._id))===Number(n)),a=s&&(s.nickname||"").trim();if(a)t=a;else{let e=l.get(n)||l.get(String(Number(n)));t=e?e.name:"Người lạ"}}if(s.isRecalled)o=`${t}: đ\xe3 thu hồi tin nhắn`;else{let e="text"===s.type||"notify"===s.type?s.content:`[${s.type}]`;o=`${t}: ${e}`}}let d="number"==typeof r.createdAt?r.createdAt:Date.now();return{...r,unreadCount:n,lastMessage:o,lastMessageAt:s?s.timestamp:d,isRecall:!!s&&(s.isRecalled||!1),isPinned:a,isHidden:i,categories:Array.isArray(r.categoriesBy?.[e])?r.categoriesBy?.[e]:[]}}))).filter(e=>"fulfilled"===e.status).map(e=>e.value);return w.NextResponse.json({total:p.length,data:p})}case"addMembers":{if(!s||!a||!Array.isArray(a))return w.NextResponse.json({error:"Missing conversationId or newMembers"},{status:400});let t={_id:new O.ObjectId(s)},r=a.map(e=>({_id:e,role:"MEMBER",joinedAt:Date.now(),addedBy:n})),i=await e.updateOne(t,{$push:{members:{$each:r}}});try{let e="Ai đó";if(n){let t=await (0,h.getAllRows)(j.USERS_COLLECTION_NAME,{filters:S(String(n)).length>0?{$or:S(String(n))}:{},limit:1}),r=t.data?.[0];r&&(e=r.name||r.username||"Người dùng")}let t=[];for(let e of a){let r=await (0,h.getAllRows)(j.USERS_COLLECTION_NAME,{filters:S(String(e)).length>0?{$or:S(String(e))}:{},limit:1}),n=r.data?.[0];n?t.push(n.name||n.username||"Người dùng"):t.push("Người dùng")}if(t.length>0){let r=t.join(", "),a=`${e} đ\xe3 th\xeam ${r} v\xe0o nh\xf3m.`;await (0,h.addRow)(y.MESSAGES_COLLECTION_NAME,{roomId:String(s),sender:String(n||"system"),type:"notify",content:a,timestamp:Date.now()})}}catch(e){console.error("Failed to create notify message:",e)}return w.NextResponse.json({success:!0,result:i})}case"updateAvatar":{if(!s||!r?.avatar)return w.NextResponse.json({error:"Missing info"},{status:400});let t=await e.updateOne({_id:new O.ObjectId(s)},{$set:{avatar:r.avatar}});return w.NextResponse.json({success:!0,result:t})}case"renameGroup":{if(!s||!r?.name)return w.NextResponse.json({error:"Missing info"},{status:400});let t=await e.updateOne({_id:new O.ObjectId(s)},{$set:{name:r.name}});return w.NextResponse.json({success:!0,result:t})}case"changeRole":{if(!s||!i||!r?.role||!n)return w.NextResponse.json({error:"Missing info"},{status:400});let t=await e.findOne({_id:new O.ObjectId(s)});if(!t)return w.NextResponse.json({error:"Group not found"},{status:404});let a=Array.isArray(t.members)?t.members:[],o=a.find(e=>e&&"object"==typeof e&&"OWNER"===e.role&&"_id"in e&&e._id),d=o?String(o._id):null,l=String(n);if(!d||d!==l)return w.NextResponse.json({error:"Only owner can change roles"},{status:403});let u=String(r.role);if(!["ADMIN","MEMBER"].includes(u))return w.NextResponse.json({error:"Invalid role"},{status:400});let c=String(i),p=-1;for(let e=0;e<a.length;e++){let t=a[e],r=x(t);if(r===c||!isNaN(Number(r))&&!isNaN(Number(c))&&Number(r)===Number(c)){p=e;break}}if(-1===p)return w.NextResponse.json({error:"Member not found in group"},{status:404});let m=`members.${p}.role`,N=await e.updateOne({_id:new O.ObjectId(s)},{$set:{[m]:u}});if(0===N.modifiedCount)return w.NextResponse.json({error:"Failed to update role"},{status:500});return w.NextResponse.json({success:!0,result:N})}case"updateMemberNickname":{if(!s||!i||r?.nickname===void 0)return w.NextResponse.json({error:"Missing info"},{status:400});let t=await e.findOne({_id:new O.ObjectId(s)});if(!t)return w.NextResponse.json({error:"Group not found"},{status:404});let n=Array.isArray(t.members)?t.members:[],a=String(i),o=-1;for(let e=0;e<n.length;e++){let t=n[e],r=x(t);if(r===a||!isNaN(Number(r))&&!isNaN(Number(a))&&Number(r)===Number(a)){o=e;break}}if(-1===o)return w.NextResponse.json({error:"Member not found in group"},{status:404});let d=String(r.nickname).trim(),l=`members.${o}.nickname`,u=await e.updateOne({_id:new O.ObjectId(s)},d?{$set:{[l]:d}}:{$unset:{[l]:""}});return w.NextResponse.json({success:!0,result:u})}case"kickMember":{if(!s||!i)return w.NextResponse.json({error:"Missing info"},{status:400});let t=String(i),r=[{_id:t}];isNaN(Number(t))||r.push({_id:Number(t)}),O.ObjectId.isValid(t)&&r.push({_id:new O.ObjectId(t)});let n=await e.updateOne({_id:new O.ObjectId(s)},{$pull:{members:{$or:r}}});return w.NextResponse.json({success:!0,result:n})}case"leaveGroup":{if(!s||!n)return w.NextResponse.json({error:"Missing info"},{status:400});let t=String(n),r=await e.findOne({_id:new O.ObjectId(s)});if(!r)return w.NextResponse.json({error:"Group not found"},{status:404});let a=Array.isArray(r.members)?r.members:[];if(!a.find(e=>!!e&&"string"!=typeof e&&x(e)===t&&"OWNER"===e.role)){let r=[{_id:t}];isNaN(Number(t))||r.push({_id:Number(t)}),O.ObjectId.isValid(t)&&r.push({_id:new O.ObjectId(t)});let n=await e.updateOne({_id:new O.ObjectId(s)},{$pull:{members:{$or:r}}});return w.NextResponse.json({success:!0,result:n})}let i=a.filter(e=>e&&"object"==typeof e&&"_id"in e&&x(e)!==t);if(0===i.length){await e.deleteOne({_id:new O.ObjectId(s)});let t=await (0,h.getCollection)(y.MESSAGES_COLLECTION_NAME);return await t.deleteMany({roomId:String(s)}),w.NextResponse.json({success:!0})}let o=i.find(e=>"object"==typeof e&&"ADMIN"===e.role)||i[Math.floor(Math.random()*i.length)],d=x(o)||"",l=[{"members._id":d}];isNaN(Number(d))||l.push({"members._id":Number(d)}),O.ObjectId.isValid(d)&&l.push({"members._id":new O.ObjectId(d)}),await e.updateOne({_id:new O.ObjectId(s),$or:l},{$set:{"members.$.role":"OWNER"}});let u=[{_id:t}];isNaN(Number(t))||u.push({_id:Number(t)}),O.ObjectId.isValid(t)&&u.push({_id:new O.ObjectId(t)});let c=await e.updateOne({_id:new O.ObjectId(s)},{$pull:{members:{$or:u}}});return w.NextResponse.json({success:!0,result:c})}case"disbandGroup":{if(!s||!n)return w.NextResponse.json({error:"Missing info"},{status:400});let t=await e.findOne({_id:new O.ObjectId(s)});if(!t)return w.NextResponse.json({error:"Group not found"},{status:404});let r=String(n),a=Array.isArray(t.members)?t.members.find(e=>e&&"object"==typeof e&&"OWNER"===e.role&&"_id"in e):null,i=a?x(a):null;if(!i||i!==r)return w.NextResponse.json({error:"Only owner can disband group"},{status:403});await e.deleteOne({_id:new O.ObjectId(s)});let o=await (0,h.getCollection)(y.MESSAGES_COLLECTION_NAME);return await o.deleteMany({roomId:String(s)}),w.NextResponse.json({success:!0})}case"toggleChatStatus":{let t=s||o;if(!t||!n||!r)return w.NextResponse.json({error:"Missing ID/Data"},{status:400});let a=(0,E.buildToggleChatStatusFields)(String(n),{isPinned:"boolean"==typeof r.isPinned?r.isPinned:void 0,isHidden:"boolean"==typeof r.isHidden?r.isHidden:void 0});if(!a)return w.NextResponse.json({error:"No status provided"},{status:400});let i=await e.updateOne({_id:new O.ObjectId(t)},{$set:a});return w.NextResponse.json({success:!0,result:i})}case"updateCategories":{let t=s||o;if(!t||!n||!r)return w.NextResponse.json({error:"Missing ID/Data"},{status:400});let a=(0,E.buildUpdateCategoriesFields)(String(n),r.categories),i=await e.updateOne({_id:new O.ObjectId(t)},{$set:a});return w.NextResponse.json({success:!0,result:i})}case"updateTags":{let t=s||o;if(!t||!n||!r)return w.NextResponse.json({error:"Missing ID/Data"},{status:400});let a=(0,E.buildUpdateTagsFields)(String(n),r.tags),i=await e.updateOne({_id:new O.ObjectId(t)},{$set:a});return w.NextResponse.json({success:!0,result:i})}default:return w.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("Conversations API Error:",e),w.NextResponse.json({error:"Server error"},{status:500})}}e.s(["POST",()=>A],40705);var v=e.i(40705);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/groups/route",pathname:"/api/groups",filename:"route",bundlePath:""},distDir:".next-local",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/groups/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:M,workUnitAsyncStorage:C,serverHooks:$}=I;function T(){return(0,n.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:C})}async function P(e,t,n){I.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/groups/route";w=w.replace(/\/index$/,"")||"/";let h=await I.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:_,params:O,nextConfig:j,parsedUrl:y,isDraftMode:E,prerenderManifest:x,routerServerContext:S,isOnDemandRevalidate:A,revalidateOnlyGenerated:v,resolvedPathname:M,clientReferenceManifest:C,serverActionsManifest:$}=h,T=(0,d.normalizeAppPath)(w),P=!!(x.dynamicRoutes[T]||x.routes[M]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,y,!1):t.end("This page could not be found"),null);if(P&&!E){let e=!!x.routes[M],t=x.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(j.experimental.adapterPath)return await D();throw new b.NoFallbackError}}let B=null;!P||I.isDev||E||(B="/index"===(B=M)?"/":B);let k=!0===I.isDev||!P,U=P&&!k;$&&C&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:C,serverActionsManifest:$,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:$})});let H=e.method||"GET",G=(0,a.getTracer)(),L=G.getActiveScopeSpan(),q={params:O,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!j.experimental.authInterrupts},cacheComponents:!!j.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:j.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>I.onRequestError(e,t,n,S)},sharedContext:{buildId:_}},F=new l.NodeNextRequest(e),W=new l.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let i=async e=>I.handle(V,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=G.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var a,d;let l=async({previousCacheEntry:r})=>{try{if(!o&&A&&v&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(s);e.fetchMetrics=q.renderOpts.fetchMetrics;let d=q.renderOpts.pendingWaitUntil;d&&n.waitUntil&&(n.waitUntil(d),d=void 0);let l=q.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(F,W,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,N.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,n=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},S),t}},u=await I.handleResponse({req:e,nextConfig:j,cacheKey:B,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:v,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:o});if(!P)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,N.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&P||c.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(F,W,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};L?await d(L):await G.withPropagatedContext(e.headers,()=>G.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof b.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})}),P)throw t;return await (0,m.sendResponse)(F,W,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>T,"routeModule",()=>I,"serverHooks",()=>$,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>C],53105)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_45dc3192.js.map