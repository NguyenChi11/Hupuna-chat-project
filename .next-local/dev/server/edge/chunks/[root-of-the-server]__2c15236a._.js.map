{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/lib/auth.ts"],"sourcesContent":["import { cookies } from 'next/headers';\r\n\r\nconst SECRET_KEY = process.env.SECRET_KEY || '';\r\nconst ALG = 'HS256';\r\n\r\nfunction toBase64(input: Uint8Array | string): string {\r\n  if (typeof Buffer !== 'undefined') {\r\n    return typeof input === 'string' ? Buffer.from(input).toString('base64') : Buffer.from(input).toString('base64');\r\n  }\r\n  const bytes = typeof input === 'string' ? new TextEncoder().encode(input) : input;\r\n  let binary = '';\r\n  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);\r\n  return btoa(binary);\r\n}\r\n\r\nfunction base64urlEncode(input: Uint8Array | string): string {\r\n  return toBase64(input).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\r\n\r\nfunction base64urlDecodeToBytes(str: string): Uint8Array {\r\n  let b64 = str.replace(/-/g, '+').replace(/_/g, '/');\r\n  const pad = b64.length % 4;\r\n  if (pad) b64 += '='.repeat(4 - pad);\r\n  if (typeof Buffer !== 'undefined') return new Uint8Array(Buffer.from(b64, 'base64'));\r\n  const binary = atob(b64);\r\n  const arr = new Uint8Array(binary.length);\r\n  for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);\r\n  return arr;\r\n}\r\n\r\nfunction bytesToUtf8(bytes: Uint8Array): string {\r\n  if (typeof Buffer !== 'undefined') return Buffer.from(bytes).toString('utf8');\r\n  return new TextDecoder().decode(bytes);\r\n}\r\n\r\nasync function hmacSha256(data: string, secret: string): Promise<Uint8Array> {\r\n  const hasSubtle =\r\n    typeof globalThis.crypto !== 'undefined' && !!(globalThis.crypto as { subtle?: SubtleCrypto }).subtle;\r\n  if (!hasSubtle) {\r\n    throw new Error('Web Crypto API is not available in this runtime');\r\n  }\r\n  const enc = new TextEncoder();\r\n  const key = await (globalThis.crypto as Crypto).subtle.importKey(\r\n    'raw',\r\n    enc.encode(secret),\r\n    { name: 'HMAC', hash: { name: 'SHA-256' } },\r\n    false,\r\n    ['sign'],\r\n  );\r\n  const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(data));\r\n  return new Uint8Array(sig);\r\n}\r\n\r\nexport async function signJWT<T extends Record<string, unknown>>(payload: T): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + 30 * 24 * 3600;\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function signEphemeralJWT<T extends Record<string, unknown>>(\r\n  payload: T,\r\n  ttlSeconds: number,\r\n): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + Math.max(1, Math.floor(ttlSeconds));\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function verifyJWT(token: string): Promise<Record<string, unknown> | null> {\r\n  try {\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) return null;\r\n    const [h, p, s] = parts;\r\n    const headerJson = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(h))) as Record<string, unknown>;\r\n    if (headerJson['alg'] !== ALG) return null;\r\n    const data = `${h}.${p}`;\r\n    const expectedBytes = await hmacSha256(data, SECRET_KEY);\r\n    const expected = base64urlEncode(expectedBytes);\r\n    if (s !== expected) return null;\r\n    const payload = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(p))) as Record<string, unknown>;\r\n    const exp = typeof payload['exp'] === 'number' ? (payload['exp'] as number) : undefined;\r\n    if (typeof exp === 'number' && Math.floor(Date.now() / 1000) > exp) return null;\r\n    return payload;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserFromCookie() {\r\n  const cookieStore = await cookies();\r\n  const token = cookieStore.get('session_token')?.value;\r\n  if (!token) return null;\r\n  return await verifyJWT(token);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport type { NextRequest } from 'next/server';\r\nimport { verifyJWT, signJWT, signEphemeralJWT } from '@/lib/auth';\r\n\r\n// Danh sách các trang cần bảo vệ\r\nconst protectedRoutes = ['/home'];\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // 1. Kiểm tra trang cần bảo vệ\r\n  if (protectedRoutes.some((route) => pathname.startsWith(route))) {\r\n    const token = request.cookies.get('session_token')?.value;\r\n\r\n    // Nếu không có token hoặc token sai -> Đá về trang login (/)\r\n    if (!token || !(await verifyJWT(token))) {\r\n      const refresh = request.cookies.get('refresh_token')?.value || '';\r\n      if (refresh) {\r\n        const payload = await verifyJWT(refresh);\r\n        if (payload && payload['purpose'] === 'refresh') {\r\n          const enc = new TextEncoder();\r\n          const ua = request.headers.get('user-agent') || '';\r\n          const al = request.headers.get('accept-language') || '';\r\n          const data = enc.encode(`${ua}|${al}`);\r\n          const digest = await crypto.subtle.digest('SHA-256', data);\r\n          const hex = Array.from(new Uint8Array(digest))\r\n            .map((b) => b.toString(16).padStart(2, '0'))\r\n            .join('');\r\n          const tfp = typeof payload['fp'] === 'string' ? (payload['fp'] as string) : '';\r\n          const userId = typeof payload['sub'] === 'string' ? (payload['sub'] as string) : '';\r\n          const username = typeof payload['username'] === 'string' ? (payload['username'] as string) : '';\r\n          const name = typeof payload['name'] === 'string' ? (payload['name'] as string) : '';\r\n          if (userId && tfp && tfp === hex) {\r\n            const accessToken = await signJWT({ _id: userId, username, name, fp: hex });\r\n            const res = NextResponse.next();\r\n            res.cookies.set('session_token', accessToken, {\r\n              httpOnly: true,\r\n              secure: process.env.NODE_ENV === 'production',\r\n              path: '/',\r\n              sameSite: 'lax',\r\n              maxAge: 30 * 24 * 3600,\r\n            });\r\n            const rotateRefresh = await signEphemeralJWT(\r\n              { purpose: 'refresh', sub: userId, username, name, fp: hex },\r\n              3650 * 24 * 3600,\r\n            );\r\n            res.cookies.set('refresh_token', rotateRefresh, {\r\n              httpOnly: true,\r\n              secure: process.env.NODE_ENV === 'production',\r\n              path: '/',\r\n              sameSite: 'lax',\r\n              maxAge: 3650 * 24 * 3600,\r\n            });\r\n            return res;\r\n          }\r\n        }\r\n      }\r\n      return NextResponse.redirect(new URL('/', request.url));\r\n    }\r\n  }\r\n\r\n  // 2. Nếu đã đăng nhập mà vào trang Login (/) -> Đá vào trang chủ\r\n  if (pathname === '/') {\r\n    const token = request.cookies.get('session_token')?.value;\r\n    if (token && (await verifyJWT(token))) {\r\n      return NextResponse.redirect(new URL('/home', request.url));\r\n    }\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: ['/', '/home/:path*', '/api/conversations/:path*', '/api/message/:path*'],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;;;AAEA,iCAAiC;AACjC,MAAM,kBAAkB;IAAC;CAAQ;AAE1B,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,+BAA+B;IAC/B,IAAI,gBAAgB,IAAI,CAAC,CAAC,QAAU,SAAS,UAAU,CAAC,SAAS;QAC/D,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB;QAEpD,6DAA6D;QAC7D,IAAI,CAAC,SAAS,CAAE,MAAM,IAAA,uIAAS,EAAC,QAAS;YACvC,MAAM,UAAU,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB,SAAS;YAC/D,IAAI,SAAS;gBACX,MAAM,UAAU,MAAM,IAAA,uIAAS,EAAC;gBAChC,IAAI,WAAW,OAAO,CAAC,UAAU,KAAK,WAAW;oBAC/C,MAAM,MAAM,IAAI;oBAChB,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;oBAChD,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;oBACrD,MAAM,OAAO,IAAI,MAAM,CAAC,GAAG,GAAG,CAAC,EAAE,IAAI;oBACrC,MAAM,SAAS,MAAM,OAAO,MAAM,CAAC,MAAM,CAAC,WAAW;oBACrD,MAAM,MAAM,MAAM,IAAI,CAAC,IAAI,WAAW,SACnC,GAAG,CAAC,CAAC,IAAM,EAAE,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG,MACtC,IAAI,CAAC;oBACR,MAAM,MAAM,OAAO,OAAO,CAAC,KAAK,KAAK,WAAY,OAAO,CAAC,KAAK,GAAc;oBAC5E,MAAM,SAAS,OAAO,OAAO,CAAC,MAAM,KAAK,WAAY,OAAO,CAAC,MAAM,GAAc;oBACjF,MAAM,WAAW,OAAO,OAAO,CAAC,WAAW,KAAK,WAAY,OAAO,CAAC,WAAW,GAAc;oBAC7F,MAAM,OAAO,OAAO,OAAO,CAAC,OAAO,KAAK,WAAY,OAAO,CAAC,OAAO,GAAc;oBACjF,IAAI,UAAU,OAAO,QAAQ,KAAK;wBAChC,MAAM,cAAc,MAAM,IAAA,qIAAO,EAAC;4BAAE,KAAK;4BAAQ;4BAAU;4BAAM,IAAI;wBAAI;wBACzE,MAAM,MAAM,gMAAY,CAAC,IAAI;wBAC7B,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,aAAa;4BAC5C,UAAU;4BACV,QAAQ,oDAAyB;4BACjC,MAAM;4BACN,UAAU;4BACV,QAAQ,KAAK,KAAK;wBACpB;wBACA,MAAM,gBAAgB,MAAM,IAAA,8IAAgB,EAC1C;4BAAE,SAAS;4BAAW,KAAK;4BAAQ;4BAAU;4BAAM,IAAI;wBAAI,GAC3D,OAAO,KAAK;wBAEd,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,eAAe;4BAC9C,UAAU;4BACV,QAAQ,oDAAyB;4BACjC,MAAM;4BACN,UAAU;4BACV,QAAQ,OAAO,KAAK;wBACtB;wBACA,OAAO;oBACT;gBACF;YACF;YACA,OAAO,gMAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,KAAK,QAAQ,GAAG;QACvD;IACF;IAEA,iEAAiE;IACjE,IAAI,aAAa,KAAK;QACpB,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB;QACpD,IAAI,SAAU,MAAM,IAAA,uIAAS,EAAC,QAAS;YACrC,OAAO,gMAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,SAAS,QAAQ,GAAG;QAC3D;IACF;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAK;QAAgB;QAA6B;KAAsB;AACpF"}}]
}