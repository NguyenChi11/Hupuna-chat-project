{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/components/%28mongodb%29/connectToDatabase.tsx"],"sourcesContent":["// app\\lib\\monggodb\\connectToDatabase.tsx\r\n\r\nimport { MongoClient, Db } from 'mongodb';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/';\r\nconst MONGODB_DB = process.env.MONGODB_DB || 'hupuna-price';\r\n\r\n// Cache client khi hot-reload (Next.js dev mode)\r\nlet cachedClient: MongoClient | null = null;\r\nlet cachedDb: Db | null = null;\r\n\r\nexport async function connectToDatabase(): Promise<{ client: MongoClient; db: Db }> {\r\n  if (cachedClient && cachedDb) {\r\n    return { client: cachedClient, db: cachedDb };\r\n  }\r\n\r\n  if (process.env.NODE_ENV === 'production' && (MONGODB_URI.includes('localhost') || MONGODB_URI.includes('127.0.0.1'))) {\r\n    console.error('‚ùå ERROR: You are using a localhost MongoDB URI in production. Please set MONGODB_URI in your Vercel project settings to a remote database (e.g., MongoDB Atlas).');\r\n  }\r\n\r\n  const client = new MongoClient(MONGODB_URI);\r\n  await client.connect();\r\n\r\n  const db = client.db(MONGODB_DB);\r\n\r\n  cachedClient = client;\r\n  cachedDb = db;\r\n\r\n  return { client, db };\r\n}\r\n"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AAEzC;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAC/C,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,iDAAiD;AACjD,IAAI,eAAmC;AACvC,IAAI,WAAsB;AAEnB,eAAe;IACpB,IAAI,gBAAgB,UAAU;QAC5B,OAAO;YAAE,QAAQ;YAAc,IAAI;QAAS;IAC9C;IAEA,IAAI,oDAAyB,gBAAgB,CAAC,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,YAAY;;IAIpH,MAAM,SAAS,IAAI,sHAAW,CAAC;IAC/B,MAAM,OAAO,OAAO;IAEpB,MAAM,KAAK,OAAO,EAAE,CAAC;IAErB,eAAe;IACf,WAAW;IAEX,OAAO;QAAE;QAAQ;IAAG;AACtB"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/mongoDBCRUD.ts"],"sourcesContent":["// app\\lib\\monggodb\\mongoDBCRUD.ts\r\n\r\nimport { Collection, Filter, ObjectId, OptionalUnlessRequiredId, UpdateFilter, type CollationOptions } from 'mongodb';\r\nimport { connectToDatabase } from '../components/(mongodb)/connectToDatabase';\r\n\r\n// ========== Helper ====================\r\nexport function safeParse(value: unknown): unknown {\r\n  if (typeof value !== 'string') return value;\r\n  const firstChar = value.trim().charAt(0);\r\n  if (firstChar !== '[' && firstChar !== '{') return value;\r\n  try {\r\n    return JSON.parse(value);\r\n  } catch {\r\n    return value;\r\n  }\r\n}\r\n\r\n// ========== READ HEADERS (Mongo ko c√≥ headers n√™n tr·∫£ key t·ª´ document) ==========\r\nexport const getHeaders = async (collectionName: string): Promise<string[]> => {\r\n  const { db } = await connectToDatabase();\r\n  const doc = await db.collection(collectionName).findOne({});\r\n  return doc ? Object.keys(doc) : [];\r\n};\r\n\r\n// ========== FIND BY FIELD ==========\r\nexport const findByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<{ data: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const item = await db\r\n    .collection(collectionName)\r\n    .find({ [field]: value })\r\n    .toArray();\r\n  if (!item) return null;\r\n\r\n  return { data: item as unknown as T };\r\n};\r\n\r\n// ========== GET BY ID OR CODE ==========\r\nexport const getRowByIdOrCode = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  { id, code, _id }: { id?: string | number; code?: string; _id?: string },\r\n): Promise<{ rowIndex: number; row: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const filter: Record<string, unknown> = {};\r\n\r\n  if (_id) {\r\n    if (ObjectId.isValid(_id)) {\r\n      filter['_id'] = new ObjectId(_id);\r\n    } else if (!isNaN(Number(_id))) {\r\n      filter['_id'] = Number(_id);\r\n    }\r\n\r\n  }\r\n\r\n  if (id) filter['id'] = id;\r\n  if (code) filter['code'] = code;\r\n\r\n  const row = await db.collection(collectionName).findOne(filter);\r\n  return row ? { rowIndex: 0, row: row as unknown as T } : null;\r\n};\r\n\r\n// ========== GET ALL (search, filter, sort, pagination) ==========\r\nexport const getAllRows = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  {\r\n    search,\r\n    skip = 0,\r\n    limit,\r\n    field,\r\n    value,\r\n    filters,\r\n    sort,\r\n    collation,\r\n  }: {\r\n    search?: string;\r\n    skip?: number;\r\n    limit?: number;\r\n    field?: keyof T;\r\n    value?: unknown;\r\n    filters?: Record<string, unknown>;\r\n    sort?: { field: keyof T; order?: 'asc' | 'desc' } | Array<{ field: keyof T; order?: 'asc' | 'desc' }>;\r\n    collation?: CollationOptions;\r\n  } = {},\r\n): Promise<{ total: number; data: T[] }> => {\r\n  const { db } = await connectToDatabase();\r\n  const collection = db.collection(collectionName);\r\n\r\n  const query: Record<string, unknown> = {};\r\n\r\n  // Filter field=value\r\n  if (field && value !== undefined) {\r\n    query[field as string] = value;\r\n  }\r\n\r\n  // ====== 2. Filter n√¢ng cao ======\r\n  if (filters && Object.keys(filters).length > 0) {\r\n    for (const [key, rawVal] of Object.entries(filters)) {\r\n      if (rawVal === undefined || rawVal === null) continue;\r\n\r\n      // --- N·∫øu l√† m·ªánh ƒë·ªÅ $or ho·∫∑c $and ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán k·∫øt h·ª£p\r\n      if (key === '$or' || key === '$and') {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† object c√≥ $gte / $lte (l·ªçc kho·∫£ng th·ªùi gian ho·∫∑c kho·∫£ng s·ªë) ---\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        ('$gte' in (rawVal as Record<string, unknown>) || '$lte' in (rawVal as Record<string, unknown>))\r\n      ) {\r\n        (query as Record<string, unknown>)[key] = rawVal;\r\n        continue;\r\n      }\r\n      // --- N·∫øu l√† object c√≥ to√°n t·ª≠ MongoDB ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán\r\n      // $in ‚Äì ch·ª©a trong danh s√°ch gi√° tr·ªã (gi·ªëng WHERE field IN (...))\r\n      // $nin ‚Äì kh√¥ng ch·ª©a trong danh s√°ch gi√° tr·ªã\r\n      // $gte ‚Äì l·ªõn h∆°n ho·∫∑c b·∫±ng (>=)\r\n      // $lte ‚Äì nh·ªè h∆°n ho·∫∑c b·∫±ng (<=)\r\n      // $gt ‚Äì l·ªõn h∆°n (>)\r\n      // $lt ‚Äì nh·ªè h∆°n (<)\r\n      // $ne ‚Äì kh√°c (!=)\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        Object.keys(rawVal as Record<string, unknown>).some((k) =>\r\n          ['$in', '$nin', '$gte', '$lte', '$gt', '$lt', '$ne'].includes(k),\r\n        )\r\n      ) {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† chu·ªói b·∫Øt ƒë·∫ßu b·∫±ng \"#\" => regex ---\r\n      if (typeof rawVal === 'string' && rawVal.trim().startsWith('#')) {\r\n        // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm g·∫ßn ƒë√∫ng (regex)\r\n        query[key] = {\r\n          $regex: rawVal.trim().slice(1),\r\n          $options: 'i',\r\n        };\r\n        continue;\r\n      }\r\n\r\n      // Tr∆∞·ªùng h·ª£p so s√°nh ch√≠nh x√°c (exact match)\r\n      query[key] = rawVal;\r\n    }\r\n  }\r\n\r\n  // Search to√†n b·ªô text - c√°ch c≈© - ch·ªâ l·∫•y key 1 c·∫•p\r\n  // if (search) {\r\n  //     const sampleDoc = await collection.findOne();\r\n  //     if (sampleDoc) {\r\n  //         const textFields = Object.keys(sampleDoc).filter(\r\n  //             (k) => typeof sampleDoc[k] === \"string\"\r\n  //         );\r\n\r\n  //         if (textFields.length > 0) {\r\n  //             query[\"$or\"] = textFields.map((key) => ({\r\n  //                 [key]: { $regex: search, $options: \"i\" },\r\n  //             }));\r\n  //         }\r\n  //     }\r\n  // }\r\n\r\n  // Search to√†n b·ªô text - c·∫£i ti·∫øn ƒë·ªÉ l·∫•y c·∫£ c√°c key trong object con - nhi·ªÅu c·∫•p\r\n  if (search) {\r\n    const sampleDoc = await collection.findOne();\r\n    if (sampleDoc) {\r\n      // üëâ H√†m ƒë·ªá quy l·∫•y t·∫•t c·∫£ key string (k·ªÉ c·∫£ nested)\r\n      const getStringPaths = (obj: unknown, prefix = ''): string[] => {\r\n        let keys: string[] = [];\r\n        for (const [k, v] of Object.entries(obj as Record<string, unknown>)) {\r\n          const path = prefix ? `${prefix}.${k}` : k;\r\n          if (typeof v === 'string') keys.push(path);\r\n          else if (v && typeof v === 'object' && !Array.isArray(v)) keys = keys.concat(getStringPaths(v, path));\r\n        }\r\n        return keys;\r\n      };\r\n\r\n      const textFields = getStringPaths(sampleDoc);\r\n\r\n      if (textFields.length > 0) {\r\n        query['$or'] = textFields.map((path) => ({\r\n          [path]: { $regex: search, $options: 'i' },\r\n        }));\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sort\r\n  let sortOption: Record<string, 1 | -1> = {};\r\n  if (sort) {\r\n    const sortArr = Array.isArray(sort) ? sort : [sort];\r\n    sortOption = sortArr.reduce(\r\n      (acc, s) => {\r\n        acc[s.field as string] = s.order === 'desc' ? -1 : 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, 1 | -1>,\r\n    );\r\n  }\r\n\r\n  const total = await collection.countDocuments(query, collation ? { collation } : undefined);\r\n\r\n  let cursor = collection.find(query);\r\n  if (collation) {\r\n    cursor = cursor.collation(collation);\r\n  }\r\n  const data = await cursor.sort(sortOption).skip(skip).limit(limit ?? 0).toArray();\r\n\r\n  return { total, data: data as unknown as T[] };\r\n};\r\n\r\n// ========== CREATE ==========\r\nexport const addRow = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  newData: T,\r\n): Promise<string> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).insertOne(newData);\r\n  return result.insertedId.toString();\r\n};\r\nexport async function getCollection<T extends Record<string, unknown>>(name: string): Promise<Collection<T>> {\r\n  const { db } = await connectToDatabase();\r\n  return db.collection<T>(name);\r\n}\r\n// CREATE MANY\r\nexport async function createMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  docs: OptionalUnlessRequiredId<T>[],\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.insertMany(docs);\r\n}\r\n\r\n\r\n// UPDATE BY FIELD\r\nexport const updateByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n  updateData: Partial<T>,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  if ('_id' in updateData) delete updateData._id;\r\n\r\n  let queryValue: string | number | ObjectId = value;\r\n\r\n  if (field === '_id' && typeof value === 'string') {\r\n    if (ObjectId.isValid(value)) {\r\n      // N·∫øu l√† ObjectId h·ª£p l·ªá\r\n      queryValue = new ObjectId(value);\r\n    } else if (!isNaN(Number(value))) {\r\n      // N·∫øu l√† s·ªë\r\n      queryValue = Number(value);\r\n    }\r\n    // N·∫øu l√† string kh√¥ng ph·∫£i ObjectId v√† kh√¥ng ph·∫£i s·ªë, queryValue v·∫´n l√† string\r\n  }\r\n  const result = await db.collection(collectionName).updateOne({ [field]: queryValue }, { $set: updateData });\r\n\r\n  return result.modifiedCount > 0;\r\n};\r\n\r\n// UPDATE MANY\r\nexport async function updateMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  filter: Filter<T>, // ch√≠nh l√† Filter<T>, kh√¥ng ph·∫£i Filter<Document>\r\n  update: UpdateFilter<T> | Partial<T>,\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  const isOperatorUpdate =\r\n    typeof update === 'object' &&\r\n    update !== null &&\r\n    Object.keys(update as Record<string, unknown>).some((key) => key.startsWith('$'));\r\n\r\n  const updateDoc: UpdateFilter<T> = isOperatorUpdate\r\n    ? (update as UpdateFilter<T>) // n·∫øu ƒë√£ c√≥ $set, $inc,... th√¨ gi·ªØ nguy√™n\r\n    : ({ $set: update as Partial<T> } as UpdateFilter<T>);\r\n\r\n  return collection.updateMany(filter, updateDoc);\r\n}\r\n\r\n// ========== DELETE BY FIELD ==========\r\nexport const deleteByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ [field]: value });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// ========== DELETE BY ID ==========\r\nexport const deleteById = async (collectionName: string, id: string): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ _id: new ObjectId(id) });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// DELETE MANY\r\nexport async function deleteManyRows<T extends Record<string, unknown>>(collectionName: string, filter: Filter<T>) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.deleteMany(filter);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 347, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/User.ts"],"sourcesContent":["export const USERS_COLLECTION_NAME = 'Users';\r\n\r\nexport interface User {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  name: string;\r\n  username: string;\r\n  password?: string;\r\n  unreadCount?: number;\r\n  lastMessage?: string;\r\n  lastMessageAt?: number;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n  online?: boolean;\r\n  lastSeen?: number | null;\r\n  // C√°c field tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c t√≠nh s·∫µn t·ª´ server (ti·ªán cho FE s·ª≠ d·ª•ng)\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n  isPinnedBy?: Record<string, boolean>;\r\n  isHiddenBy?: Record<string, boolean>;\r\n  isRecall?: boolean;\r\n  onesignalSubs?: string[];\r\n  nicknames?: Record<string, string>;\r\n  categoryTags?: { id: string; label: string; color: string }[];\r\n  userTags?: { id: string; label: string; color: string }[];\r\n  categoriesBy?: Record<string, string[]>;\r\n  tagsBy?: Record<string, string[]>;\r\n}\r\nexport interface UserCreate {\r\n  [key: string]: unknown;\r\n  name: string;\r\n  username: string;\r\n  password: string;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,wBAAwB"}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/Message.ts"],"sourcesContent":["import { User } from '@/types/User';\r\n\r\nexport const MESSAGES_COLLECTION_NAME = 'Messages';\r\n\r\nexport type MessageType = 'text' | 'image' | 'file' | 'notify' | 'sticker' | 'video' | 'reminder' | 'poll' | 'contact';\r\n\r\nexport interface Message {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  roomId: string;\r\n  sender: string | User;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  pinnedAt?: number | null;\r\n  readBy?: (string | number)[];\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  mentions?: string[];\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\nexport interface MessageCreate {\r\n  [key: string]: unknown;\r\n  roomId: string;\r\n  sender: string;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEO,MAAM,2BAA2B"}},
    {"offset": {"line": 365, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/auth.ts"],"sourcesContent":["import { cookies } from 'next/headers';\r\n\r\nconst SECRET_KEY = process.env.SECRET_KEY || '';\r\nconst ALG = 'HS256';\r\n\r\nfunction toBase64(input: Uint8Array | string): string {\r\n  if (typeof Buffer !== 'undefined') {\r\n    return typeof input === 'string' ? Buffer.from(input).toString('base64') : Buffer.from(input).toString('base64');\r\n  }\r\n  const bytes = typeof input === 'string' ? new TextEncoder().encode(input) : input;\r\n  let binary = '';\r\n  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);\r\n  return btoa(binary);\r\n}\r\n\r\nfunction base64urlEncode(input: Uint8Array | string): string {\r\n  return toBase64(input).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\r\n\r\nfunction base64urlDecodeToBytes(str: string): Uint8Array {\r\n  let b64 = str.replace(/-/g, '+').replace(/_/g, '/');\r\n  const pad = b64.length % 4;\r\n  if (pad) b64 += '='.repeat(4 - pad);\r\n  if (typeof Buffer !== 'undefined') return new Uint8Array(Buffer.from(b64, 'base64'));\r\n  const binary = atob(b64);\r\n  const arr = new Uint8Array(binary.length);\r\n  for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);\r\n  return arr;\r\n}\r\n\r\nfunction bytesToUtf8(bytes: Uint8Array): string {\r\n  if (typeof Buffer !== 'undefined') return Buffer.from(bytes).toString('utf8');\r\n  return new TextDecoder().decode(bytes);\r\n}\r\n\r\nasync function hmacSha256(data: string, secret: string): Promise<Uint8Array> {\r\n  const hasSubtle =\r\n    typeof globalThis.crypto !== 'undefined' && !!(globalThis.crypto as { subtle?: SubtleCrypto }).subtle;\r\n  if (!hasSubtle) {\r\n    throw new Error('Web Crypto API is not available in this runtime');\r\n  }\r\n  const enc = new TextEncoder();\r\n  const key = await (globalThis.crypto as Crypto).subtle.importKey(\r\n    'raw',\r\n    enc.encode(secret),\r\n    { name: 'HMAC', hash: { name: 'SHA-256' } },\r\n    false,\r\n    ['sign'],\r\n  );\r\n  const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(data));\r\n  return new Uint8Array(sig);\r\n}\r\n\r\nexport async function signJWT<T extends Record<string, unknown>>(payload: T): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + 30 * 24 * 3600;\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function signEphemeralJWT<T extends Record<string, unknown>>(\r\n  payload: T,\r\n  ttlSeconds: number,\r\n): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + Math.max(1, Math.floor(ttlSeconds));\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function verifyJWT(token: string): Promise<Record<string, unknown> | null> {\r\n  try {\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) return null;\r\n    const [h, p, s] = parts;\r\n    const headerJson = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(h))) as Record<string, unknown>;\r\n    if (headerJson['alg'] !== ALG) return null;\r\n    const data = `${h}.${p}`;\r\n    const expectedBytes = await hmacSha256(data, SECRET_KEY);\r\n    const expected = base64urlEncode(expectedBytes);\r\n    if (s !== expected) return null;\r\n    const payload = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(p))) as Record<string, unknown>;\r\n    const exp = typeof payload['exp'] === 'number' ? (payload['exp'] as number) : undefined;\r\n    if (typeof exp === 'number' && Math.floor(Date.now() / 1000) > exp) return null;\r\n    return payload;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserFromCookie() {\r\n  const cookieStore = await cookies();\r\n  const token = cookieStore.get('session_token')?.value;\r\n  if (!token) return null;\r\n  return await verifyJWT(token);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 495, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/session.ts"],"sourcesContent":["// app\\lib\\session.ts\r\n\r\nimport crypto from 'crypto';\r\nimport { connectToDatabase } from '../components/(mongodb)/connectToDatabase';\r\n\r\nexport interface Session {\r\n  _id: string;\r\n  userId: string;\r\n  deviceName?: string;\r\n  deviceFingerprint?: string;\r\n  ip?: string;\r\n  createdAt: Date;\r\n  lastSeenAt: Date;\r\n  expiresAt: Date;\r\n  isRevoked: boolean;\r\n}\r\n\r\n/**\r\n * T·∫°o session m·ªõi\r\n */\r\nexport async function createSession(params: {\r\n  userId: string;\r\n  deviceName?: string;\r\n  ip?: string;\r\n  headers?: Record<string, string>;\r\n  ttlDays?: number;\r\n}): Promise<string> {\r\n  const { db } = await connectToDatabase();\r\n  const { userId, deviceName = 'web', ip = '', headers = {}, ttlDays = 7 } = params;\r\n\r\n  const sid = crypto.randomBytes(32).toString('hex');\r\n  const fingerprint = crypto\r\n    .createHash('sha256')\r\n    .update((headers['user-agent'] || '') + '|' + (headers['accept-language'] || ''))\r\n    .digest('hex');\r\n\r\n  const now = new Date();\r\n  const expiresAt = new Date(Date.now() + ttlDays * 24 * 3600 * 1000);\r\n\r\n  const session: Session = {\r\n    _id: sid,\r\n    userId,\r\n    deviceName,\r\n    deviceFingerprint: fingerprint,\r\n    ip,\r\n    createdAt: now,\r\n    lastSeenAt: now,\r\n    expiresAt,\r\n    isRevoked: false,\r\n  };\r\n\r\n  await db.collection<Session>('sessions').insertOne(session);\r\n  return sid;\r\n}\r\n\r\n/**\r\n * L·∫•y session theo sid\r\n */\r\nexport async function getSession(sid: string): Promise<Session | null> {\r\n  const { db } = await connectToDatabase();\r\n  if (!sid) return null;\r\n  const session = await db.collection<Session>('sessions').findOne({ _id: sid });\r\n  if (!session || session.isRevoked || session.expiresAt < new Date()) return null;\r\n  return session;\r\n}\r\n\r\n/**\r\n * C·∫≠p nh·∫≠t lastSeenAt\r\n */\r\nexport async function touchSession(sid: string): Promise<void> {\r\n  const { db } = await connectToDatabase();\r\n  await db.collection<Session>('sessions').updateOne({ _id: sid }, { $set: { lastSeenAt: new Date() } });\r\n}\r\n\r\n/**\r\n * Revoke session\r\n */\r\nexport async function revokeSession(sid: string): Promise<void> {\r\n  const { db } = await connectToDatabase();\r\n  await db.collection<Session>('sessions').updateOne({ _id: sid }, { $set: { isRevoked: true } });\r\n}\r\n\r\n/**\r\n * L·∫•y t·∫•t c·∫£ session c·ªßa user\r\n */\r\nexport async function listUserSessions(userId: string): Promise<Session[]> {\r\n  const { db } = await connectToDatabase();\r\n  return db.collection<Session>('sessions').find({ userId, isRevoked: false }).sort({ lastSeenAt: -1 }).toArray();\r\n}\r\n\r\n/**\r\n * T·∫°o fingerprint t·ª´ headers\r\n */\r\nexport function fingerprintFromHeaders(headers: Record<string, string>): string {\r\n  return crypto\r\n    .createHash('sha256')\r\n    .update((headers['user-agent'] || '') + '|' + (headers['accept-language'] || ''))\r\n    .digest('hex');\r\n}\r\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;;;;;;;;;;;AAErB;AACA;;;AAiBO,eAAe,cAAc,MAMnC;IACC,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,EAAE,MAAM,EAAE,aAAa,KAAK,EAAE,KAAK,EAAE,EAAE,UAAU,CAAC,CAAC,EAAE,UAAU,CAAC,EAAE,GAAG;IAE3E,MAAM,MAAM,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC5C,MAAM,cAAc,gHAAM,CACvB,UAAU,CAAC,UACX,MAAM,CAAC,CAAC,OAAO,CAAC,aAAa,IAAI,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,kBAAkB,IAAI,EAAE,GAC9E,MAAM,CAAC;IAEV,MAAM,MAAM,IAAI;IAChB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,UAAU,KAAK,OAAO;IAE9D,MAAM,UAAmB;QACvB,KAAK;QACL;QACA;QACA,mBAAmB;QACnB;QACA,WAAW;QACX,YAAY;QACZ;QACA,WAAW;IACb;IAEA,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;IACnD,OAAO;AACT;AAKO,eAAe,WAAW,GAAW;IAC1C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,UAAU,MAAM,GAAG,UAAU,CAAU,YAAY,OAAO,CAAC;QAAE,KAAK;IAAI;IAC5E,IAAI,CAAC,WAAW,QAAQ,SAAS,IAAI,QAAQ,SAAS,GAAG,IAAI,QAAQ,OAAO;IAC5E,OAAO;AACT;AAKO,eAAe,aAAa,GAAW;IAC5C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;QAAE,KAAK;IAAI,GAAG;QAAE,MAAM;YAAE,YAAY,IAAI;QAAO;IAAE;AACtG;AAKO,eAAe,cAAc,GAAW;IAC7C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;QAAE,KAAK;IAAI,GAAG;QAAE,MAAM;YAAE,WAAW;QAAK;IAAE;AAC/F;AAKO,eAAe,iBAAiB,MAAc;IACnD,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,OAAO,GAAG,UAAU,CAAU,YAAY,IAAI,CAAC;QAAE;QAAQ,WAAW;IAAM,GAAG,IAAI,CAAC;QAAE,YAAY,CAAC;IAAE,GAAG,OAAO;AAC/G;AAKO,SAAS,uBAAuB,OAA+B;IACpE,OAAO,gHAAM,CACV,UAAU,CAAC,UACX,MAAM,CAAC,CAAC,OAAO,CAAC,aAAa,IAAI,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,kBAAkB,IAAI,EAAE,GAC9E,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 580, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/authCookies.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst defaultCookieOptions = {\r\n  httpOnly: true,\r\n  secure: process.env.NODE_ENV === 'production',\r\n  path: '/',\r\n  sameSite: 'lax' as const,\r\n};\r\n\r\nexport function setAuthCookies(\r\n  res: NextResponse,\r\n  params: {\r\n    accessToken?: string;\r\n    refreshToken?: string;\r\n    sid?: string;\r\n    accessMaxAge?: number;\r\n    refreshMaxAge?: number;\r\n    sidMaxAge?: number;\r\n  },\r\n) {\r\n  const {\r\n    accessToken,\r\n    refreshToken,\r\n    sid,\r\n    accessMaxAge = 30 * 24 * 3600,\r\n    refreshMaxAge = 3650 * 24 * 3600,\r\n    sidMaxAge = 3650 * 24 * 3600,\r\n  } = params;\r\n\r\n  if (accessToken) {\r\n    res.cookies.set('session_token', accessToken, { ...defaultCookieOptions, maxAge: accessMaxAge });\r\n  }\r\n  if (sid) {\r\n    res.cookies.set('sid', sid, { ...defaultCookieOptions, maxAge: sidMaxAge });\r\n  }\r\n  if (refreshToken) {\r\n    res.cookies.set('refresh_token', refreshToken, { ...defaultCookieOptions, maxAge: refreshMaxAge });\r\n  }\r\n  return res;\r\n}\r\n\r\nexport function clearAuthCookies(res: NextResponse) {\r\n  res.cookies.set('session_token', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  res.cookies.set('sid', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  res.cookies.set('refresh_token', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  return res;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAEA,MAAM,uBAAuB;IAC3B,UAAU;IACV,QAAQ,oDAAyB;IACjC,MAAM;IACN,UAAU;AACZ;AAEO,SAAS,eACd,GAAiB,EACjB,MAOC;IAED,MAAM,EACJ,WAAW,EACX,YAAY,EACZ,GAAG,EACH,eAAe,KAAK,KAAK,IAAI,EAC7B,gBAAgB,OAAO,KAAK,IAAI,EAChC,YAAY,OAAO,KAAK,IAAI,EAC7B,GAAG;IAEJ,IAAI,aAAa;QACf,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,aAAa;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAa;IAChG;IACA,IAAI,KAAK;QACP,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,KAAK;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAU;IAC3E;IACA,IAAI,cAAc;QAChB,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,cAAc;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAc;IAClG;IACA,OAAO;AACT;AAEO,SAAS,iBAAiB,GAAiB;IAChD,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAC1E,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAChE,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAC1E,OAAO;AACT"}},
    {"offset": {"line": 633, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/chatUpdateFields.ts"],"sourcesContent":["export interface ToggleChatStatusPayload {\r\n  isPinned?: boolean\r\n  isHidden?: boolean\r\n}\r\n\r\nexport function buildToggleChatStatusFields(\r\n  currentUserId: string,\r\n  payload: ToggleChatStatusPayload,\r\n): Record<string, boolean> | null {\r\n  const fields: Record<string, boolean> = {}\r\n  if (typeof payload.isPinned === 'boolean') {\r\n    fields[`isPinnedBy.${currentUserId}`] = payload.isPinned\r\n  }\r\n  if (typeof payload.isHidden === 'boolean') {\r\n    fields[`isHiddenBy.${currentUserId}`] = payload.isHidden\r\n  }\r\n  if (Object.keys(fields).length === 0) return null\r\n  return fields\r\n}\r\n\r\nexport function normalizeStringArray(input: unknown): string[] {\r\n  if (!Array.isArray(input)) return []\r\n  return (input as unknown[]).filter((x): x is string => typeof x === 'string')\r\n}\r\n\r\nexport function buildUpdateCategoriesFields(currentUserId: string, categories: unknown): Record<string, string[]> {\r\n  const arr = normalizeStringArray(categories)\r\n  return { [`categoriesBy.${currentUserId}`]: arr }\r\n}\r\n\r\nexport function buildUpdateTagsFields(currentUserId: string, tags: unknown): Record<string, string[]> {\r\n  const arr = normalizeStringArray(tags)\r\n  return { [`tagsBy.${currentUserId}`]: arr }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;;;;;AAKO,SAAS,4BACd,aAAqB,EACrB,OAAgC;IAEhC,MAAM,SAAkC,CAAC;IACzC,IAAI,OAAO,QAAQ,QAAQ,KAAK,WAAW;QACzC,MAAM,CAAC,CAAC,WAAW,EAAE,eAAe,CAAC,GAAG,QAAQ,QAAQ;IAC1D;IACA,IAAI,OAAO,QAAQ,QAAQ,KAAK,WAAW;QACzC,MAAM,CAAC,CAAC,WAAW,EAAE,eAAe,CAAC,GAAG,QAAQ,QAAQ;IAC1D;IACA,IAAI,OAAO,IAAI,CAAC,QAAQ,MAAM,KAAK,GAAG,OAAO;IAC7C,OAAO;AACT;AAEO,SAAS,qBAAqB,KAAc;IACjD,IAAI,CAAC,MAAM,OAAO,CAAC,QAAQ,OAAO,EAAE;IACpC,OAAO,AAAC,MAAoB,MAAM,CAAC,CAAC,IAAmB,OAAO,MAAM;AACtE;AAEO,SAAS,4BAA4B,aAAqB,EAAE,UAAmB;IACpF,MAAM,MAAM,qBAAqB;IACjC,OAAO;QAAE,CAAC,CAAC,aAAa,EAAE,eAAe,CAAC,EAAE;IAAI;AAClD;AAEO,SAAS,sBAAsB,aAAqB,EAAE,IAAa;IACxE,MAAM,MAAM,qBAAqB;IACjC,OAAO;QAAE,CAAC,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE;IAAI;AAC5C"}},
    {"offset": {"line": 674, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/api/users/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { addRow, deleteByField, getAllRows, getCollection, getRowByIdOrCode, updateByField } from '@/lib/mongoDBCRUD';\r\nimport { Filter, ObjectId } from 'mongodb';\r\nimport { User, USERS_COLLECTION_NAME } from '@/types/User';\r\nimport { Message, MESSAGES_COLLECTION_NAME } from '@/types/Message';\r\nimport { signJWT, signEphemeralJWT } from '@/lib/auth';\r\nimport { createSession, fingerprintFromHeaders } from '@/lib/session';\r\nimport { setAuthCookies, clearAuthCookies } from '@/lib/authCookies';\r\nimport {\r\n  buildToggleChatStatusFields,\r\n  buildUpdateCategoriesFields,\r\n  buildUpdateTagsFields,\r\n} from '@/lib/chatUpdateFields';\r\nimport bcrypt from 'bcryptjs';\r\n\r\nexport const runtime = 'nodejs';\r\n\r\ntype UserSort = { field: keyof User; order?: 'asc' | 'desc' } | Array<{ field: keyof User; order?: 'asc' | 'desc' }>;\r\n\r\ninterface ToggleChatStatusPayload {\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n}\r\ninterface UpdateCategoriesPayload {\r\n  categories?: string[];\r\n}\r\n\r\ninterface LoginPayload {\r\n  username?: string;\r\n  password?: string;\r\n}\r\n\r\ntype UsersRequestData = Partial<User> & ToggleChatStatusPayload & LoginPayload & Record<string, unknown>;\r\n\r\ninterface UsersRequestBody {\r\n  action?:\r\n    | 'create'\r\n    | 'read'\r\n    | 'getById'\r\n    | 'update'\r\n    | 'delete'\r\n    | 'toggleChatStatus'\r\n    | 'updateCategories'\r\n    | 'login'\r\n    | 'logout'\r\n    | 'changePassword'\r\n    | 'updateNickname'\r\n    | 'updateTags';\r\n  collectionName?: string;\r\n  data?: UsersRequestData;\r\n  field?: keyof User;\r\n  value?: unknown;\r\n  filters?: Record<string, unknown>;\r\n  search?: string;\r\n  skip?: number;\r\n  limit?: number;\r\n  _id?: string;\r\n  code?: string;\r\n  sort?: UserSort;\r\n  currentUserId?: string;\r\n  roomId?: string;\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n}\r\n\r\n// üî• Helper function ƒë·ªÉ t·∫°o query filter cho _id\r\nfunction createIdFilter(id: string | number): ObjectId | number {\r\n  if (typeof id === 'number') {\r\n    return id;\r\n  }\r\n\r\n  const idStr = String(id);\r\n\r\n  // Ki·ªÉm tra n·∫øu l√† ObjectId h·ª£p l·ªá\r\n  if (ObjectId.isValid(idStr) && idStr.length === 24) {\r\n    return new ObjectId(idStr);\r\n  }\r\n\r\n  // Ki·ªÉm tra n·∫øu l√† s·ªë\r\n  if (!isNaN(Number(idStr))) {\r\n    return Number(idStr);\r\n  }\r\n\r\n  // M·∫∑c ƒë·ªãnh tr·∫£ v·ªÅ string (tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát)\r\n  return idStr as unknown as number;\r\n}\r\n\r\n// üî• Type-safe filter cho User v·ªõi _id\r\ntype UserIdFilter = Filter<User> & { _id: ObjectId | number };\r\n\r\nexport async function POST(req: NextRequest) {\r\n  let body: UsersRequestBody = {};\r\n  try {\r\n    const contentType = req.headers.get('content-type') || '';\r\n    if (contentType.includes('application/json')) {\r\n      body = (await req.json()) as UsersRequestBody;\r\n    }\r\n  } catch (err) {\r\n    console.warn('Invalid JSON body in /api/users:', err);\r\n    body = {};\r\n  }\r\n\r\n  const {\r\n    action,\r\n    collectionName = USERS_COLLECTION_NAME,\r\n    data,\r\n    field,\r\n    value,\r\n    filters,\r\n    search,\r\n    skip,\r\n    limit,\r\n    _id: requestId,\r\n    code,\r\n    sort,\r\n    currentUserId,\r\n    roomId,\r\n  } = body;\r\n\r\n  try {\r\n    switch (action) {\r\n      case 'create': {\r\n        if (!data || !data.password) {\r\n          return NextResponse.json({ error: 'Missing data or password' }, { status: 400 });\r\n        }\r\n\r\n        const hashed = await bcrypt.hash(String(data.password), 5);\r\n        const newData = { ...data, password: hashed };\r\n\r\n        const _id = await addRow<User>(collectionName, newData as User);\r\n        return NextResponse.json({ success: true, _id });\r\n      }\r\n\r\n      case 'read': {\r\n        const result = await getAllRows<User>(collectionName, {\r\n          search,\r\n          skip,\r\n          limit,\r\n          field,\r\n          value,\r\n          filters,\r\n          sort,\r\n        });\r\n\r\n        const users = result.data || [];\r\n\r\n        if (!currentUserId) {\r\n          return NextResponse.json(result);\r\n        }\r\n        const userIdStr = String(currentUserId);\r\n        const variants: (string | number)[] = [userIdStr];\r\n        if (!isNaN(Number(userIdStr))) {\r\n          variants.push(Number(userIdStr));\r\n        }\r\n        const msgCollection = await getCollection<Message>(MESSAGES_COLLECTION_NAME);\r\n\r\n        const usersWithData = await Promise.all(\r\n          users.map(async (u: User) => {\r\n            if (String(u._id) === userIdStr) return u;\r\n\r\n            const roomId = [userIdStr, String(u._id)].sort().join('_');\r\n\r\n            const unreadCount = await msgCollection.countDocuments({\r\n              roomId,\r\n              readBy: { $nin: variants as unknown as string[] },\r\n            });\r\n\r\n            const lastMsgs = await msgCollection.find({ roomId }).sort({ timestamp: -1 }).limit(1).toArray();\r\n\r\n            let lastMessagePreview = '';\r\n            const lastMsgObj = lastMsgs[0];\r\n\r\n            if (lastMsgObj) {\r\n              if (lastMsgObj.isRecalled) {\r\n                const isMySender = String(lastMsgObj.sender) === userIdStr;\r\n                const senderName = isMySender ? 'B·∫°n' : u.name || 'Ng∆∞·ªùi d√πng';\r\n                lastMessagePreview = `${senderName}: ƒë√£ thu h·ªìi tin nh·∫Øn`;\r\n              } else {\r\n                const content =\r\n                  lastMsgObj.type === 'text' || lastMsgObj.type === 'notify'\r\n                    ? lastMsgObj.content\r\n                    : `[${lastMsgObj.type}]`;\r\n\r\n                if (String(lastMsgObj.sender) === userIdStr) {\r\n                  lastMessagePreview = `B·∫°n: ${content}`;\r\n                } else {\r\n                  lastMessagePreview = content || '';\r\n                }\r\n              }\r\n            } else {\r\n              lastMessagePreview = 'C√°c b·∫°n ƒë√£ k·∫øt n·ªëi v·ªõi nhau tr√™n Hupuna Chat';\r\n            }\r\n\r\n            const isPinned = u.isPinnedBy?.[userIdStr] === true;\r\n            const isHidden = u.isHiddenBy?.[userIdStr] === true;\r\n            const categories = Array.isArray(\r\n              (u as unknown as { categoriesBy?: Record<string, string[]> }).categoriesBy?.[userIdStr],\r\n            )\r\n              ? ((u as unknown as { categoriesBy?: Record<string, string[]> }).categoriesBy?.[userIdStr] as string[])\r\n              : [];\r\n            return {\r\n              ...u,\r\n              unreadCount,\r\n              lastMessage: lastMessagePreview,\r\n              lastMessageAt: lastMsgObj ? lastMsgObj.timestamp : null,\r\n              isGroup: false,\r\n              isRecall: lastMsgObj ? lastMsgObj.isRecalled || false : false,\r\n              isPinned,\r\n              isHidden,\r\n              categories,\r\n            };\r\n          }),\r\n        );\r\n        return NextResponse.json({ total: usersWithData.length, data: usersWithData });\r\n      }\r\n\r\n      case 'getById': {\r\n        const idStr = requestId ? String(requestId) : '';\r\n        const isObjId = idStr ? ObjectId.isValid(idStr) && idStr.length === 24 : false;\r\n        const isNumeric = idStr ? !isNaN(Number(idStr)) : false;\r\n\r\n        if (isObjId || isNumeric || code) {\r\n          return NextResponse.json(await getRowByIdOrCode<User>(collectionName, { _id: idStr, code }));\r\n        }\r\n\r\n        if (!idStr) return NextResponse.json(null);\r\n\r\n        const result = await getAllRows<User>(collectionName, {\r\n          filters: { $or: [{ username: idStr }, { _id: idStr }] },\r\n          limit: 1,\r\n        });\r\n        const row = (result.data || [])[0];\r\n        return NextResponse.json(row ? { rowIndex: 0, row } : null);\r\n      }\r\n\r\n      case 'update':\r\n        if (!field || value === undefined) {\r\n          return NextResponse.json({ error: 'Missing field or value for update' }, { status: 400 });\r\n        }\r\n        try {\r\n          if (field === '_id') {\r\n            const userCollection = await getCollection<User>(collectionName);\r\n            const idStr = String(value);\r\n\r\n            const orFilters: Array<Record<string, unknown>> = [{ _id: idStr }];\r\n            if (!isNaN(Number(idStr))) {\r\n              orFilters.push({ _id: Number(idStr) });\r\n            }\r\n            if (ObjectId.isValid(idStr) && idStr.length === 24) {\r\n              orFilters.push({ _id: new ObjectId(idStr) });\r\n            }\r\n\r\n            const result = await userCollection.updateOne({ $or: orFilters } as Filter<User>, { $set: data || {} });\r\n\r\n            if (result.matchedCount === 0) {\r\n              return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n            }\r\n\r\n            return NextResponse.json({ success: true, modified: result.modifiedCount });\r\n          } else {\r\n            await updateByField<User>(collectionName, field, value as string | number, (data || {}) as Partial<User>);\r\n            return NextResponse.json({ success: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('Update error:', error);\r\n          return NextResponse.json({ error: 'Invalid ID format or update failed' }, { status: 400 });\r\n        }\r\n\r\n      case 'delete':\r\n        if (!field || value === undefined) {\r\n          return NextResponse.json({ error: 'Missing field or value for delete' }, { status: 400 });\r\n        }\r\n        const deleteValue =\r\n          field === '_id' && typeof value === 'string' && ObjectId.isValid(value)\r\n            ? new ObjectId(value)\r\n            : (value as string | number);\r\n        await deleteByField<User>(collectionName, field, deleteValue as string | number);\r\n        return NextResponse.json({ success: true });\r\n\r\n      case 'toggleChatStatus': {\r\n        if (!currentUserId || !data || !roomId) {\r\n          return NextResponse.json({ error: 'Missing currentUserId, roomId or data' }, { status: 400 });\r\n        }\r\n        const statusData = data as ToggleChatStatusPayload;\r\n        const partnerId = roomId;\r\n        const updateFields = buildToggleChatStatusFields(String(currentUserId), statusData);\r\n        if (!updateFields) {\r\n          return NextResponse.json({ error: 'No status provided' }, { status: 400 });\r\n        }\r\n\r\n        const result = await updateByField<User>(collectionName, '_id', partnerId, updateFields);\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateNickname': {\r\n        if (!currentUserId || !data || !roomId) {\r\n          return NextResponse.json({ error: 'Missing currentUserId, roomId or data' }, { status: 400 });\r\n        }\r\n        const nicknameData = data as { nickname: string };\r\n        const partnerId = roomId;\r\n\r\n        const updateFields: Record<string, string> = {};\r\n        updateFields[`nicknames.${currentUserId}`] = nicknameData.nickname;\r\n\r\n        const result = await updateByField<User>(collectionName, '_id', partnerId, updateFields);\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateCategories': {\r\n        if (!currentUserId || !data || !roomId) {\r\n          return NextResponse.json({ error: 'Missing currentUserId, roomId or data' }, { status: 400 });\r\n        }\r\n        const payload = data as UpdateCategoriesPayload;\r\n        const partnerId = roomId;\r\n        const updateFields = buildUpdateCategoriesFields(String(currentUserId), payload.categories);\r\n        const result = await updateByField<User>(collectionName, '_id', partnerId, updateFields);\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateTags': {\r\n        if (!currentUserId || !data || !roomId) {\r\n          return NextResponse.json({ error: 'Missing currentUserId, roomId or data' }, { status: 400 });\r\n        }\r\n        const payload = data as { tags?: string[] };\r\n        const partnerId = roomId;\r\n        const updateFields = buildUpdateTagsFields(String(currentUserId), payload.tags);\r\n        const result = await updateByField<User>(collectionName, '_id', partnerId, updateFields);\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'login': {\r\n        const loginData = (data || {}) as LoginPayload;\r\n        const { username, password } = loginData;\r\n\r\n        if (!username || !password) {\r\n          return NextResponse.json({ success: false, message: 'Thi·∫øu t√™n ng∆∞·ªùi d√πng ho·∫∑c m·∫≠t kh·∫©u!' }, { status: 400 });\r\n        }\r\n\r\n        const queryResult = await getAllRows<User>(collectionName, { filters: { username }, limit: 1 });\r\n\r\n        const found = queryResult.data?.[0];\r\n\r\n        if (!found) {\r\n          return NextResponse.json({ success: false, message: 'Username ho·∫∑c Password kh√¥ng ƒë√∫ng!' }, { status: 401 });\r\n        }\r\n        let ok = await bcrypt.compare(String(password), String(found.password || ''));\r\n        if (!ok && String(found.password || '') === String(password)) {\r\n          try {\r\n            const userCollection = await getCollection<User>(collectionName);\r\n            const idStr = String(found._id);\r\n            const orFilters: Array<Record<string, unknown>> = [{ _id: idStr }];\r\n            if (!isNaN(Number(idStr))) {\r\n              orFilters.push({ _id: Number(idStr) });\r\n            }\r\n            if (ObjectId.isValid(idStr) && idStr.length === 24) {\r\n              orFilters.push({ _id: new ObjectId(idStr) });\r\n            }\r\n            const hashed = await bcrypt.hash(String(password), 12);\r\n            await userCollection.updateOne({ $or: orFilters } as Filter<User>, { $set: { password: hashed } });\r\n            ok = true;\r\n          } catch {}\r\n        }\r\n        if (!ok) {\r\n          return NextResponse.json({ success: false, message: 'Username ho·∫∑c Password kh√¥ng ƒë√∫ng!' }, { status: 401 });\r\n        }\r\n\r\n        const fp = fingerprintFromHeaders({\r\n          'user-agent': req.headers.get('user-agent') || '',\r\n          'accept-language': req.headers.get('accept-language') || '',\r\n        });\r\n        const sid = await createSession({\r\n          userId: String(found._id),\r\n          deviceName: 'web',\r\n          headers: {\r\n            'user-agent': req.headers.get('user-agent') || '',\r\n            'accept-language': req.headers.get('accept-language') || '',\r\n          },\r\n          ttlDays: 3650,\r\n        });\r\n        const token = await signJWT({\r\n          _id: String(found._id),\r\n          username: String(found.username || ''),\r\n          name: String(found.name || ''),\r\n          sid,\r\n          fp,\r\n        });\r\n\r\n        const res = NextResponse.json({\r\n          success: true,\r\n          token,\r\n          user: {\r\n            _id: String(found._id),\r\n            name: String(found.name || ''),\r\n            username: String(found.username || ''),\r\n            avatar: found.avatar,\r\n            role: found.role,\r\n            department: found.department,\r\n            status: found.status,\r\n            phone: found['phone'],\r\n            gender: found['gender'],\r\n            birthday: found['birthday'],\r\n            email: found['email'],\r\n            address: found['address'],\r\n            title: found['title'],\r\n            background: found['background'],\r\n            bio: found['bio'],\r\n            nicknames: found.nicknames,\r\n            categoryTags: Array.isArray(found.categoryTags) ? found.categoryTags : [],\r\n          },\r\n        });\r\n\r\n        const refreshToken = await signEphemeralJWT(\r\n          {\r\n            purpose: 'refresh',\r\n            sub: String(found._id),\r\n            username: String(found.username || ''),\r\n            name: String(found.name || ''),\r\n            fp,\r\n          },\r\n          3650 * 24 * 3600,\r\n        );\r\n        setAuthCookies(res, { accessToken: token, sid, refreshToken });\r\n\r\n        return res;\r\n      }\r\n\r\n      case 'logout': {\r\n        const res = NextResponse.json({ success: true });\r\n        clearAuthCookies(res);\r\n        return res;\r\n      }\r\n\r\n      case 'changePassword': {\r\n        const changeData = data as { userId?: string; currentPassword?: string; newPassword?: string };\r\n        const { userId, currentPassword, newPassword } = changeData;\r\n\r\n        if (!userId || !currentPassword || !newPassword) {\r\n          return NextResponse.json({ success: false, message: 'Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc' }, { status: 400 });\r\n        }\r\n\r\n        // üî• FIX: X·ª≠ l√Ω c·∫£ ObjectId v√† number\r\n        const userCollection = await getCollection<User>(collectionName);\r\n        const queryId = createIdFilter(userId);\r\n\r\n        // üî• Type-safe filter\r\n        const filter: UserIdFilter = { _id: queryId } as UserIdFilter;\r\n\r\n        const userDoc = await userCollection.findOne(filter);\r\n\r\n        if (!userDoc || !userDoc.password) {\r\n          return NextResponse.json({ success: false, message: 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n' }, { status: 404 });\r\n        }\r\n\r\n        const ok = await bcrypt.compare(String(currentPassword), String(userDoc.password || ''));\r\n        if (!ok) {\r\n          return NextResponse.json({ success: false, message: 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng' }, { status: 401 });\r\n        }\r\n\r\n        const hashed = await bcrypt.hash(String(newPassword), 12);\r\n        await userCollection.updateOne(filter, { $set: { password: hashed } });\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng',\r\n        });\r\n      }\r\n\r\n      default:\r\n        return NextResponse.json({ error: 'Invalid action' }, { status: 400 });\r\n    }\r\n  } catch (error) {\r\n    console.error('API Error:', error);\r\n    return NextResponse.json({ error: 'Server error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;;;;;;;;;;;AAEO,MAAM,UAAU;AAkDvB,iDAAiD;AACjD,SAAS,eAAe,EAAmB;IACzC,IAAI,OAAO,OAAO,UAAU;QAC1B,OAAO;IACT;IAEA,MAAM,QAAQ,OAAO;IAErB,kCAAkC;IAClC,IAAI,mHAAQ,CAAC,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,IAAI;QAClD,OAAO,IAAI,mHAAQ,CAAC;IACtB;IAEA,qBAAqB;IACrB,IAAI,CAAC,MAAM,OAAO,SAAS;QACzB,OAAO,OAAO;IAChB;IAEA,+CAA+C;IAC/C,OAAO;AACT;AAKO,eAAe,KAAK,GAAgB;IACzC,IAAI,OAAyB,CAAC;IAC9B,IAAI;QACF,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACvD,IAAI,YAAY,QAAQ,CAAC,qBAAqB;YAC5C,OAAQ,MAAM,IAAI,IAAI;QACxB;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,oCAAoC;QACjD,OAAO,CAAC;IACV;IAEA,MAAM,EACJ,MAAM,EACN,iBAAiB,+IAAqB,EACtC,IAAI,EACJ,KAAK,EACL,KAAK,EACL,OAAO,EACP,MAAM,EACN,IAAI,EACJ,KAAK,EACL,KAAK,SAAS,EACd,IAAI,EACJ,IAAI,EACJ,aAAa,EACb,MAAM,EACP,GAAG;IAEJ,IAAI;QACF,OAAQ;YACN,KAAK;gBAAU;oBACb,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;wBAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAA2B,GAAG;4BAAE,QAAQ;wBAAI;oBAChF;oBAEA,MAAM,SAAS,MAAM,8IAAM,CAAC,IAAI,CAAC,OAAO,KAAK,QAAQ,GAAG;oBACxD,MAAM,UAAU;wBAAE,GAAG,IAAI;wBAAE,UAAU;oBAAO;oBAE5C,MAAM,MAAM,MAAM,IAAA,qIAAM,EAAO,gBAAgB;oBAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAM;oBAAI;gBAChD;YAEA,KAAK;gBAAQ;oBACX,MAAM,SAAS,MAAM,IAAA,yIAAU,EAAO,gBAAgB;wBACpD;wBACA;wBACA;wBACA;wBACA;wBACA;wBACA;oBACF;oBAEA,MAAM,QAAQ,OAAO,IAAI,IAAI,EAAE;oBAE/B,IAAI,CAAC,eAAe;wBAClB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAC3B;oBACA,MAAM,YAAY,OAAO;oBACzB,MAAM,WAAgC;wBAAC;qBAAU;oBACjD,IAAI,CAAC,MAAM,OAAO,aAAa;wBAC7B,SAAS,IAAI,CAAC,OAAO;oBACvB;oBACA,MAAM,gBAAgB,MAAM,IAAA,4IAAa,EAAU,qJAAwB;oBAE3E,MAAM,gBAAgB,MAAM,QAAQ,GAAG,CACrC,MAAM,GAAG,CAAC,OAAO;wBACf,IAAI,OAAO,EAAE,GAAG,MAAM,WAAW,OAAO;wBAExC,MAAM,SAAS;4BAAC;4BAAW,OAAO,EAAE,GAAG;yBAAE,CAAC,IAAI,GAAG,IAAI,CAAC;wBAEtD,MAAM,cAAc,MAAM,cAAc,cAAc,CAAC;4BACrD;4BACA,QAAQ;gCAAE,MAAM;4BAAgC;wBAClD;wBAEA,MAAM,WAAW,MAAM,cAAc,IAAI,CAAC;4BAAE;wBAAO,GAAG,IAAI,CAAC;4BAAE,WAAW,CAAC;wBAAE,GAAG,KAAK,CAAC,GAAG,OAAO;wBAE9F,IAAI,qBAAqB;wBACzB,MAAM,aAAa,QAAQ,CAAC,EAAE;wBAE9B,IAAI,YAAY;4BACd,IAAI,WAAW,UAAU,EAAE;gCACzB,MAAM,aAAa,OAAO,WAAW,MAAM,MAAM;gCACjD,MAAM,aAAa,aAAa,QAAQ,EAAE,IAAI,IAAI;gCAClD,qBAAqB,GAAG,WAAW,qBAAqB,CAAC;4BAC3D,OAAO;gCACL,MAAM,UACJ,WAAW,IAAI,KAAK,UAAU,WAAW,IAAI,KAAK,WAC9C,WAAW,OAAO,GAClB,CAAC,CAAC,EAAE,WAAW,IAAI,CAAC,CAAC,CAAC;gCAE5B,IAAI,OAAO,WAAW,MAAM,MAAM,WAAW;oCAC3C,qBAAqB,CAAC,KAAK,EAAE,SAAS;gCACxC,OAAO;oCACL,qBAAqB,WAAW;gCAClC;4BACF;wBACF,OAAO;4BACL,qBAAqB;wBACvB;wBAEA,MAAM,WAAW,EAAE,UAAU,EAAE,CAAC,UAAU,KAAK;wBAC/C,MAAM,WAAW,EAAE,UAAU,EAAE,CAAC,UAAU,KAAK;wBAC/C,MAAM,aAAa,MAAM,OAAO,CAC9B,AAAC,EAA6D,YAAY,EAAE,CAAC,UAAU,IAEpF,AAAC,EAA6D,YAAY,EAAE,CAAC,UAAU,GACxF,EAAE;wBACN,OAAO;4BACL,GAAG,CAAC;4BACJ;4BACA,aAAa;4BACb,eAAe,aAAa,WAAW,SAAS,GAAG;4BACnD,SAAS;4BACT,UAAU,aAAa,WAAW,UAAU,IAAI,QAAQ;4BACxD;4BACA;4BACA;wBACF;oBACF;oBAEF,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,OAAO,cAAc,MAAM;wBAAE,MAAM;oBAAc;gBAC9E;YAEA,KAAK;gBAAW;oBACd,MAAM,QAAQ,YAAY,OAAO,aAAa;oBAC9C,MAAM,UAAU,QAAQ,mHAAQ,CAAC,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,KAAK;oBACzE,MAAM,YAAY,QAAQ,CAAC,MAAM,OAAO,UAAU;oBAElD,IAAI,WAAW,aAAa,MAAM;wBAChC,OAAO,gJAAY,CAAC,IAAI,CAAC,MAAM,IAAA,+IAAgB,EAAO,gBAAgB;4BAAE,KAAK;4BAAO;wBAAK;oBAC3F;oBAEA,IAAI,CAAC,OAAO,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAErC,MAAM,SAAS,MAAM,IAAA,yIAAU,EAAO,gBAAgB;wBACpD,SAAS;4BAAE,KAAK;gCAAC;oCAAE,UAAU;gCAAM;gCAAG;oCAAE,KAAK;gCAAM;6BAAE;wBAAC;wBACtD,OAAO;oBACT;oBACA,MAAM,MAAM,CAAC,OAAO,IAAI,IAAI,EAAE,CAAC,CAAC,EAAE;oBAClC,OAAO,gJAAY,CAAC,IAAI,CAAC,MAAM;wBAAE,UAAU;wBAAG;oBAAI,IAAI;gBACxD;YAEA,KAAK;gBACH,IAAI,CAAC,SAAS,UAAU,WAAW;oBACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAoC,GAAG;wBAAE,QAAQ;oBAAI;gBACzF;gBACA,IAAI;oBACF,IAAI,UAAU,OAAO;wBACnB,MAAM,iBAAiB,MAAM,IAAA,4IAAa,EAAO;wBACjD,MAAM,QAAQ,OAAO;wBAErB,MAAM,YAA4C;4BAAC;gCAAE,KAAK;4BAAM;yBAAE;wBAClE,IAAI,CAAC,MAAM,OAAO,SAAS;4BACzB,UAAU,IAAI,CAAC;gCAAE,KAAK,OAAO;4BAAO;wBACtC;wBACA,IAAI,mHAAQ,CAAC,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,IAAI;4BAClD,UAAU,IAAI,CAAC;gCAAE,KAAK,IAAI,mHAAQ,CAAC;4BAAO;wBAC5C;wBAEA,MAAM,SAAS,MAAM,eAAe,SAAS,CAAC;4BAAE,KAAK;wBAAU,GAAmB;4BAAE,MAAM,QAAQ,CAAC;wBAAE;wBAErG,IAAI,OAAO,YAAY,KAAK,GAAG;4BAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;gCAAE,OAAO;4BAAiB,GAAG;gCAAE,QAAQ;4BAAI;wBACtE;wBAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAM,UAAU,OAAO,aAAa;wBAAC;oBAC3E,OAAO;wBACL,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO,OAA2B,QAAQ,CAAC;wBACrF,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;wBAAK;oBAC3C;gBACF,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,iBAAiB;oBAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAqC,GAAG;wBAAE,QAAQ;oBAAI;gBAC1F;YAEF,KAAK;gBACH,IAAI,CAAC,SAAS,UAAU,WAAW;oBACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAoC,GAAG;wBAAE,QAAQ;oBAAI;gBACzF;gBACA,MAAM,cACJ,UAAU,SAAS,OAAO,UAAU,YAAY,mHAAQ,CAAC,OAAO,CAAC,SAC7D,IAAI,mHAAQ,CAAC,SACZ;gBACP,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO;gBACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,SAAS;gBAAK;YAE3C,KAAK;gBAAoB;oBACvB,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,QAAQ;wBACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAAwC,GAAG;4BAAE,QAAQ;wBAAI;oBAC7F;oBACA,MAAM,aAAa;oBACnB,MAAM,YAAY;oBAClB,MAAM,eAAe,IAAA,+JAA2B,EAAC,OAAO,gBAAgB;oBACxE,IAAI,CAAC,cAAc;wBACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAAqB,GAAG;4BAAE,QAAQ;wBAAI;oBAC1E;oBAEA,MAAM,SAAS,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO,WAAW;oBAC3E,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAM;oBAAO;gBACnD;YAEA,KAAK;gBAAkB;oBACrB,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,QAAQ;wBACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAAwC,GAAG;4BAAE,QAAQ;wBAAI;oBAC7F;oBACA,MAAM,eAAe;oBACrB,MAAM,YAAY;oBAElB,MAAM,eAAuC,CAAC;oBAC9C,YAAY,CAAC,CAAC,UAAU,EAAE,eAAe,CAAC,GAAG,aAAa,QAAQ;oBAElE,MAAM,SAAS,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO,WAAW;oBAC3E,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAM;oBAAO;gBACnD;YAEA,KAAK;gBAAoB;oBACvB,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,QAAQ;wBACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAAwC,GAAG;4BAAE,QAAQ;wBAAI;oBAC7F;oBACA,MAAM,UAAU;oBAChB,MAAM,YAAY;oBAClB,MAAM,eAAe,IAAA,+JAA2B,EAAC,OAAO,gBAAgB,QAAQ,UAAU;oBAC1F,MAAM,SAAS,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO,WAAW;oBAC3E,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAM;oBAAO;gBACnD;YAEA,KAAK;gBAAc;oBACjB,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,QAAQ;wBACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;wBAAwC,GAAG;4BAAE,QAAQ;wBAAI;oBAC7F;oBACA,MAAM,UAAU;oBAChB,MAAM,YAAY;oBAClB,MAAM,eAAe,IAAA,yJAAqB,EAAC,OAAO,gBAAgB,QAAQ,IAAI;oBAC9E,MAAM,SAAS,MAAM,IAAA,4IAAa,EAAO,gBAAgB,OAAO,WAAW;oBAC3E,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAM;oBAAO;gBACnD;YAEA,KAAK;gBAAS;oBACZ,MAAM,YAAa,QAAQ,CAAC;oBAC5B,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;oBAE/B,IAAI,CAAC,YAAY,CAAC,UAAU;wBAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAAsC,GAAG;4BAAE,QAAQ;wBAAI;oBAC7G;oBAEA,MAAM,cAAc,MAAM,IAAA,yIAAU,EAAO,gBAAgB;wBAAE,SAAS;4BAAE;wBAAS;wBAAG,OAAO;oBAAE;oBAE7F,MAAM,QAAQ,YAAY,IAAI,EAAE,CAAC,EAAE;oBAEnC,IAAI,CAAC,OAAO;wBACV,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAAqC,GAAG;4BAAE,QAAQ;wBAAI;oBAC5G;oBACA,IAAI,KAAK,MAAM,8IAAM,CAAC,OAAO,CAAC,OAAO,WAAW,OAAO,MAAM,QAAQ,IAAI;oBACzE,IAAI,CAAC,MAAM,OAAO,MAAM,QAAQ,IAAI,QAAQ,OAAO,WAAW;wBAC5D,IAAI;4BACF,MAAM,iBAAiB,MAAM,IAAA,4IAAa,EAAO;4BACjD,MAAM,QAAQ,OAAO,MAAM,GAAG;4BAC9B,MAAM,YAA4C;gCAAC;oCAAE,KAAK;gCAAM;6BAAE;4BAClE,IAAI,CAAC,MAAM,OAAO,SAAS;gCACzB,UAAU,IAAI,CAAC;oCAAE,KAAK,OAAO;gCAAO;4BACtC;4BACA,IAAI,mHAAQ,CAAC,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,IAAI;gCAClD,UAAU,IAAI,CAAC;oCAAE,KAAK,IAAI,mHAAQ,CAAC;gCAAO;4BAC5C;4BACA,MAAM,SAAS,MAAM,8IAAM,CAAC,IAAI,CAAC,OAAO,WAAW;4BACnD,MAAM,eAAe,SAAS,CAAC;gCAAE,KAAK;4BAAU,GAAmB;gCAAE,MAAM;oCAAE,UAAU;gCAAO;4BAAE;4BAChG,KAAK;wBACP,EAAE,OAAM,CAAC;oBACX;oBACA,IAAI,CAAC,IAAI;wBACP,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAAqC,GAAG;4BAAE,QAAQ;wBAAI;oBAC5G;oBAEA,MAAM,KAAK,IAAA,iJAAsB,EAAC;wBAChC,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB;wBAC/C,mBAAmB,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;oBAC3D;oBACA,MAAM,MAAM,MAAM,IAAA,wIAAa,EAAC;wBAC9B,QAAQ,OAAO,MAAM,GAAG;wBACxB,YAAY;wBACZ,SAAS;4BACP,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB;4BAC/C,mBAAmB,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;wBAC3D;wBACA,SAAS;oBACX;oBACA,MAAM,QAAQ,MAAM,IAAA,+HAAO,EAAC;wBAC1B,KAAK,OAAO,MAAM,GAAG;wBACrB,UAAU,OAAO,MAAM,QAAQ,IAAI;wBACnC,MAAM,OAAO,MAAM,IAAI,IAAI;wBAC3B;wBACA;oBACF;oBAEA,MAAM,MAAM,gJAAY,CAAC,IAAI,CAAC;wBAC5B,SAAS;wBACT;wBACA,MAAM;4BACJ,KAAK,OAAO,MAAM,GAAG;4BACrB,MAAM,OAAO,MAAM,IAAI,IAAI;4BAC3B,UAAU,OAAO,MAAM,QAAQ,IAAI;4BACnC,QAAQ,MAAM,MAAM;4BACpB,MAAM,MAAM,IAAI;4BAChB,YAAY,MAAM,UAAU;4BAC5B,QAAQ,MAAM,MAAM;4BACpB,OAAO,KAAK,CAAC,QAAQ;4BACrB,QAAQ,KAAK,CAAC,SAAS;4BACvB,UAAU,KAAK,CAAC,WAAW;4BAC3B,OAAO,KAAK,CAAC,QAAQ;4BACrB,SAAS,KAAK,CAAC,UAAU;4BACzB,OAAO,KAAK,CAAC,QAAQ;4BACrB,YAAY,KAAK,CAAC,aAAa;4BAC/B,KAAK,KAAK,CAAC,MAAM;4BACjB,WAAW,MAAM,SAAS;4BAC1B,cAAc,MAAM,OAAO,CAAC,MAAM,YAAY,IAAI,MAAM,YAAY,GAAG,EAAE;wBAC3E;oBACF;oBAEA,MAAM,eAAe,MAAM,IAAA,wIAAgB,EACzC;wBACE,SAAS;wBACT,KAAK,OAAO,MAAM,GAAG;wBACrB,UAAU,OAAO,MAAM,QAAQ,IAAI;wBACnC,MAAM,OAAO,MAAM,IAAI,IAAI;wBAC3B;oBACF,GACA,OAAO,KAAK;oBAEd,IAAA,6IAAc,EAAC,KAAK;wBAAE,aAAa;wBAAO;wBAAK;oBAAa;oBAE5D,OAAO;gBACT;YAEA,KAAK;gBAAU;oBACb,MAAM,MAAM,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;oBAAK;oBAC9C,IAAA,+IAAgB,EAAC;oBACjB,OAAO;gBACT;YAEA,KAAK;gBAAkB;oBACrB,MAAM,aAAa;oBACnB,MAAM,EAAE,MAAM,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG;oBAEjD,IAAI,CAAC,UAAU,CAAC,mBAAmB,CAAC,aAAa;wBAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAA2B,GAAG;4BAAE,QAAQ;wBAAI;oBAClG;oBAEA,sCAAsC;oBACtC,MAAM,iBAAiB,MAAM,IAAA,4IAAa,EAAO;oBACjD,MAAM,UAAU,eAAe;oBAE/B,sBAAsB;oBACtB,MAAM,SAAuB;wBAAE,KAAK;oBAAQ;oBAE5C,MAAM,UAAU,MAAM,eAAe,OAAO,CAAC;oBAE7C,IAAI,CAAC,WAAW,CAAC,QAAQ,QAAQ,EAAE;wBACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAA2B,GAAG;4BAAE,QAAQ;wBAAI;oBAClG;oBAEA,MAAM,KAAK,MAAM,8IAAM,CAAC,OAAO,CAAC,OAAO,kBAAkB,OAAO,QAAQ,QAAQ,IAAI;oBACpF,IAAI,CAAC,IAAI;wBACP,OAAO,gJAAY,CAAC,IAAI,CAAC;4BAAE,SAAS;4BAAO,SAAS;wBAA+B,GAAG;4BAAE,QAAQ;wBAAI;oBACtG;oBAEA,MAAM,SAAS,MAAM,8IAAM,CAAC,IAAI,CAAC,OAAO,cAAc;oBACtD,MAAM,eAAe,SAAS,CAAC,QAAQ;wBAAE,MAAM;4BAAE,UAAU;wBAAO;oBAAE;oBACpE,OAAO,gJAAY,CAAC,IAAI,CAAC;wBACvB,SAAS;wBACT,SAAS;oBACX;gBACF;YAEA;gBACE,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAiB,GAAG;oBAAE,QAAQ;gBAAI;QACxE;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}