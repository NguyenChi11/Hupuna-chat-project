{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/auth.ts"],"sourcesContent":["import { cookies } from 'next/headers';\r\n\r\nconst SECRET_KEY = process.env.SECRET_KEY || '';\r\nconst ALG = 'HS256';\r\n\r\nfunction toBase64(input: Uint8Array | string): string {\r\n  if (typeof Buffer !== 'undefined') {\r\n    return typeof input === 'string' ? Buffer.from(input).toString('base64') : Buffer.from(input).toString('base64');\r\n  }\r\n  const bytes = typeof input === 'string' ? new TextEncoder().encode(input) : input;\r\n  let binary = '';\r\n  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);\r\n  return btoa(binary);\r\n}\r\n\r\nfunction base64urlEncode(input: Uint8Array | string): string {\r\n  return toBase64(input).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\r\n\r\nfunction base64urlDecodeToBytes(str: string): Uint8Array {\r\n  let b64 = str.replace(/-/g, '+').replace(/_/g, '/');\r\n  const pad = b64.length % 4;\r\n  if (pad) b64 += '='.repeat(4 - pad);\r\n  if (typeof Buffer !== 'undefined') return new Uint8Array(Buffer.from(b64, 'base64'));\r\n  const binary = atob(b64);\r\n  const arr = new Uint8Array(binary.length);\r\n  for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);\r\n  return arr;\r\n}\r\n\r\nfunction bytesToUtf8(bytes: Uint8Array): string {\r\n  if (typeof Buffer !== 'undefined') return Buffer.from(bytes).toString('utf8');\r\n  return new TextDecoder().decode(bytes);\r\n}\r\n\r\nasync function hmacSha256(data: string, secret: string): Promise<Uint8Array> {\r\n  const hasSubtle =\r\n    typeof globalThis.crypto !== 'undefined' && !!(globalThis.crypto as { subtle?: SubtleCrypto }).subtle;\r\n  if (!hasSubtle) {\r\n    throw new Error('Web Crypto API is not available in this runtime');\r\n  }\r\n  const enc = new TextEncoder();\r\n  const key = await (globalThis.crypto as Crypto).subtle.importKey(\r\n    'raw',\r\n    enc.encode(secret),\r\n    { name: 'HMAC', hash: { name: 'SHA-256' } },\r\n    false,\r\n    ['sign'],\r\n  );\r\n  const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(data));\r\n  return new Uint8Array(sig);\r\n}\r\n\r\nexport async function signJWT<T extends Record<string, unknown>>(payload: T): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + 30 * 24 * 3600;\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function signEphemeralJWT<T extends Record<string, unknown>>(\r\n  payload: T,\r\n  ttlSeconds: number,\r\n): Promise<string> {\r\n  const header = { alg: ALG, typ: 'JWT' };\r\n  const iat = Math.floor(Date.now() / 1000);\r\n  const exp = iat + Math.max(1, Math.floor(ttlSeconds));\r\n  const body = { ...payload, iat, exp };\r\n  const encodedHeader = base64urlEncode(JSON.stringify(header));\r\n  const encodedPayload = base64urlEncode(JSON.stringify(body));\r\n  const data = `${encodedHeader}.${encodedPayload}`;\r\n  const sig = await hmacSha256(data, SECRET_KEY);\r\n  const signature = base64urlEncode(sig);\r\n  return `${data}.${signature}`;\r\n}\r\n\r\nexport async function verifyJWT(token: string): Promise<Record<string, unknown> | null> {\r\n  try {\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) return null;\r\n    const [h, p, s] = parts;\r\n    const headerJson = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(h))) as Record<string, unknown>;\r\n    if (headerJson['alg'] !== ALG) return null;\r\n    const data = `${h}.${p}`;\r\n    const expectedBytes = await hmacSha256(data, SECRET_KEY);\r\n    const expected = base64urlEncode(expectedBytes);\r\n    if (s !== expected) return null;\r\n    const payload = JSON.parse(bytesToUtf8(base64urlDecodeToBytes(p))) as Record<string, unknown>;\r\n    const exp = typeof payload['exp'] === 'number' ? (payload['exp'] as number) : undefined;\r\n    if (typeof exp === 'number' && Math.floor(Date.now() / 1000) > exp) return null;\r\n    return payload;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserFromCookie() {\r\n  const cookieStore = await cookies();\r\n  const token = cookieStore.get('session_token')?.value;\r\n  if (!token) return null;\r\n  return await verifyJWT(token);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/components/%28mongodb%29/connectToDatabase.tsx"],"sourcesContent":["// app\\lib\\monggodb\\connectToDatabase.tsx\r\n\r\nimport { MongoClient, Db } from 'mongodb';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/';\r\nconst MONGODB_DB = process.env.MONGODB_DB || 'hupuna-price';\r\n\r\n// Cache client khi hot-reload (Next.js dev mode)\r\nlet cachedClient: MongoClient | null = null;\r\nlet cachedDb: Db | null = null;\r\n\r\nexport async function connectToDatabase(): Promise<{ client: MongoClient; db: Db }> {\r\n  if (cachedClient && cachedDb) {\r\n    return { client: cachedClient, db: cachedDb };\r\n  }\r\n\r\n  if (process.env.NODE_ENV === 'production' && (MONGODB_URI.includes('localhost') || MONGODB_URI.includes('127.0.0.1'))) {\r\n    console.error('❌ ERROR: You are using a localhost MongoDB URI in production. Please set MONGODB_URI in your Vercel project settings to a remote database (e.g., MongoDB Atlas).');\r\n  }\r\n\r\n  const client = new MongoClient(MONGODB_URI);\r\n  await client.connect();\r\n\r\n  const db = client.db(MONGODB_DB);\r\n\r\n  cachedClient = client;\r\n  cachedDb = db;\r\n\r\n  return { client, db };\r\n}\r\n"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AAEzC;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAC/C,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,iDAAiD;AACjD,IAAI,eAAmC;AACvC,IAAI,WAAsB;AAEnB,eAAe;IACpB,IAAI,gBAAgB,UAAU;QAC5B,OAAO;YAAE,QAAQ;YAAc,IAAI;QAAS;IAC9C;IAEA,IAAI,oDAAyB,gBAAgB,CAAC,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,YAAY;;IAIpH,MAAM,SAAS,IAAI,sHAAW,CAAC;IAC/B,MAAM,OAAO,OAAO;IAEpB,MAAM,KAAK,OAAO,EAAE,CAAC;IAErB,eAAe;IACf,WAAW;IAEX,OAAO;QAAE;QAAQ;IAAG;AACtB"}},
    {"offset": {"line": 217, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/session.ts"],"sourcesContent":["// app\\lib\\session.ts\r\n\r\nimport crypto from 'crypto';\r\nimport { connectToDatabase } from '../components/(mongodb)/connectToDatabase';\r\n\r\nexport interface Session {\r\n  _id: string;\r\n  userId: string;\r\n  deviceName?: string;\r\n  deviceFingerprint?: string;\r\n  ip?: string;\r\n  createdAt: Date;\r\n  lastSeenAt: Date;\r\n  expiresAt: Date;\r\n  isRevoked: boolean;\r\n}\r\n\r\n/**\r\n * Tạo session mới\r\n */\r\nexport async function createSession(params: {\r\n  userId: string;\r\n  deviceName?: string;\r\n  ip?: string;\r\n  headers?: Record<string, string>;\r\n  ttlDays?: number;\r\n}): Promise<string> {\r\n  const { db } = await connectToDatabase();\r\n  const { userId, deviceName = 'web', ip = '', headers = {}, ttlDays = 7 } = params;\r\n\r\n  const sid = crypto.randomBytes(32).toString('hex');\r\n  const fingerprint = crypto\r\n    .createHash('sha256')\r\n    .update((headers['user-agent'] || '') + '|' + (headers['accept-language'] || ''))\r\n    .digest('hex');\r\n\r\n  const now = new Date();\r\n  const expiresAt = new Date(Date.now() + ttlDays * 24 * 3600 * 1000);\r\n\r\n  const session: Session = {\r\n    _id: sid,\r\n    userId,\r\n    deviceName,\r\n    deviceFingerprint: fingerprint,\r\n    ip,\r\n    createdAt: now,\r\n    lastSeenAt: now,\r\n    expiresAt,\r\n    isRevoked: false,\r\n  };\r\n\r\n  await db.collection<Session>('sessions').insertOne(session);\r\n  return sid;\r\n}\r\n\r\n/**\r\n * Lấy session theo sid\r\n */\r\nexport async function getSession(sid: string): Promise<Session | null> {\r\n  const { db } = await connectToDatabase();\r\n  if (!sid) return null;\r\n  const session = await db.collection<Session>('sessions').findOne({ _id: sid });\r\n  if (!session || session.isRevoked || session.expiresAt < new Date()) return null;\r\n  return session;\r\n}\r\n\r\n/**\r\n * Cập nhật lastSeenAt\r\n */\r\nexport async function touchSession(sid: string): Promise<void> {\r\n  const { db } = await connectToDatabase();\r\n  await db.collection<Session>('sessions').updateOne({ _id: sid }, { $set: { lastSeenAt: new Date() } });\r\n}\r\n\r\n/**\r\n * Revoke session\r\n */\r\nexport async function revokeSession(sid: string): Promise<void> {\r\n  const { db } = await connectToDatabase();\r\n  await db.collection<Session>('sessions').updateOne({ _id: sid }, { $set: { isRevoked: true } });\r\n}\r\n\r\n/**\r\n * Lấy tất cả session của user\r\n */\r\nexport async function listUserSessions(userId: string): Promise<Session[]> {\r\n  const { db } = await connectToDatabase();\r\n  return db.collection<Session>('sessions').find({ userId, isRevoked: false }).sort({ lastSeenAt: -1 }).toArray();\r\n}\r\n\r\n/**\r\n * Tạo fingerprint từ headers\r\n */\r\nexport function fingerprintFromHeaders(headers: Record<string, string>): string {\r\n  return crypto\r\n    .createHash('sha256')\r\n    .update((headers['user-agent'] || '') + '|' + (headers['accept-language'] || ''))\r\n    .digest('hex');\r\n}\r\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;;;;;;;;;;;AAErB;AACA;;;AAiBO,eAAe,cAAc,MAMnC;IACC,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,EAAE,MAAM,EAAE,aAAa,KAAK,EAAE,KAAK,EAAE,EAAE,UAAU,CAAC,CAAC,EAAE,UAAU,CAAC,EAAE,GAAG;IAE3E,MAAM,MAAM,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC5C,MAAM,cAAc,gHAAM,CACvB,UAAU,CAAC,UACX,MAAM,CAAC,CAAC,OAAO,CAAC,aAAa,IAAI,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,kBAAkB,IAAI,EAAE,GAC9E,MAAM,CAAC;IAEV,MAAM,MAAM,IAAI;IAChB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,UAAU,KAAK,OAAO;IAE9D,MAAM,UAAmB;QACvB,KAAK;QACL;QACA;QACA,mBAAmB;QACnB;QACA,WAAW;QACX,YAAY;QACZ;QACA,WAAW;IACb;IAEA,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;IACnD,OAAO;AACT;AAKO,eAAe,WAAW,GAAW;IAC1C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,UAAU,MAAM,GAAG,UAAU,CAAU,YAAY,OAAO,CAAC;QAAE,KAAK;IAAI;IAC5E,IAAI,CAAC,WAAW,QAAQ,SAAS,IAAI,QAAQ,SAAS,GAAG,IAAI,QAAQ,OAAO;IAC5E,OAAO;AACT;AAKO,eAAe,aAAa,GAAW;IAC5C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;QAAE,KAAK;IAAI,GAAG;QAAE,MAAM;YAAE,YAAY,IAAI;QAAO;IAAE;AACtG;AAKO,eAAe,cAAc,GAAW;IAC7C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,MAAM,GAAG,UAAU,CAAU,YAAY,SAAS,CAAC;QAAE,KAAK;IAAI,GAAG;QAAE,MAAM;YAAE,WAAW;QAAK;IAAE;AAC/F;AAKO,eAAe,iBAAiB,MAAc;IACnD,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAA,6KAAiB;IACtC,OAAO,GAAG,UAAU,CAAU,YAAY,IAAI,CAAC;QAAE;QAAQ,WAAW;IAAM,GAAG,IAAI,CAAC;QAAE,YAAY,CAAC;IAAE,GAAG,OAAO;AAC/G;AAKO,SAAS,uBAAuB,OAA+B;IACpE,OAAO,gHAAM,CACV,UAAU,CAAC,UACX,MAAM,CAAC,CAAC,OAAO,CAAC,aAAa,IAAI,EAAE,IAAI,MAAM,CAAC,OAAO,CAAC,kBAAkB,IAAI,EAAE,GAC9E,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/authCookies.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst defaultCookieOptions = {\r\n  httpOnly: true,\r\n  secure: process.env.NODE_ENV === 'production',\r\n  path: '/',\r\n  sameSite: 'lax' as const,\r\n};\r\n\r\nexport function setAuthCookies(\r\n  res: NextResponse,\r\n  params: {\r\n    accessToken?: string;\r\n    refreshToken?: string;\r\n    sid?: string;\r\n    accessMaxAge?: number;\r\n    refreshMaxAge?: number;\r\n    sidMaxAge?: number;\r\n  },\r\n) {\r\n  const {\r\n    accessToken,\r\n    refreshToken,\r\n    sid,\r\n    accessMaxAge = 30 * 24 * 3600,\r\n    refreshMaxAge = 3650 * 24 * 3600,\r\n    sidMaxAge = 3650 * 24 * 3600,\r\n  } = params;\r\n\r\n  if (accessToken) {\r\n    res.cookies.set('session_token', accessToken, { ...defaultCookieOptions, maxAge: accessMaxAge });\r\n  }\r\n  if (sid) {\r\n    res.cookies.set('sid', sid, { ...defaultCookieOptions, maxAge: sidMaxAge });\r\n  }\r\n  if (refreshToken) {\r\n    res.cookies.set('refresh_token', refreshToken, { ...defaultCookieOptions, maxAge: refreshMaxAge });\r\n  }\r\n  return res;\r\n}\r\n\r\nexport function clearAuthCookies(res: NextResponse) {\r\n  res.cookies.set('session_token', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  res.cookies.set('sid', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  res.cookies.set('refresh_token', '', { ...defaultCookieOptions, maxAge: 0 });\r\n  return res;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAEA,MAAM,uBAAuB;IAC3B,UAAU;IACV,QAAQ,oDAAyB;IACjC,MAAM;IACN,UAAU;AACZ;AAEO,SAAS,eACd,GAAiB,EACjB,MAOC;IAED,MAAM,EACJ,WAAW,EACX,YAAY,EACZ,GAAG,EACH,eAAe,KAAK,KAAK,IAAI,EAC7B,gBAAgB,OAAO,KAAK,IAAI,EAChC,YAAY,OAAO,KAAK,IAAI,EAC7B,GAAG;IAEJ,IAAI,aAAa;QACf,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,aAAa;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAa;IAChG;IACA,IAAI,KAAK;QACP,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,KAAK;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAU;IAC3E;IACA,IAAI,cAAc;QAChB,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,cAAc;YAAE,GAAG,oBAAoB;YAAE,QAAQ;QAAc;IAClG;IACA,OAAO;AACT;AAEO,SAAS,iBAAiB,GAAiB;IAChD,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAC1E,IAAI,OAAO,CAAC,GAAG,CAAC,OAAO,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAChE,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI;QAAE,GAAG,oBAAoB;QAAE,QAAQ;IAAE;IAC1E,OAAO;AACT"}},
    {"offset": {"line": 355, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/api/auth/refresh/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyJWT, signJWT, signEphemeralJWT } from '@/lib/auth';\r\nimport { fingerprintFromHeaders, getSession } from '@/lib/session';\r\nimport { setAuthCookies } from '@/lib/authCookies';\r\n\r\nexport const runtime = 'nodejs';\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const refresh = req.cookies.get('refresh_token')?.value || '';\r\n  if (!refresh) return NextResponse.json({ success: false }, { status: 401 });\r\n  const payload = await verifyJWT(refresh);\r\n  if (!payload || payload['purpose'] !== 'refresh') return NextResponse.json({ success: false }, { status: 401 });\r\n  const fp = fingerprintFromHeaders({\r\n    'user-agent': req.headers.get('user-agent') || '',\r\n    'accept-language': req.headers.get('accept-language') || '',\r\n  });\r\n  const tfp = typeof payload['fp'] === 'string' ? (payload['fp'] as string) : '';\r\n  const userId = typeof payload['sub'] === 'string' ? (payload['sub'] as string) : '';\r\n  const username = typeof payload['username'] === 'string' ? (payload['username'] as string) : '';\r\n  const name = typeof payload['name'] === 'string' ? (payload['name'] as string) : '';\r\n  if (!userId) return NextResponse.json({ success: false }, { status: 401 });\r\n\r\n  // Nếu fingerprint không khớp (trình duyệt cập nhật hoặc thay đổi ngôn ngữ),\r\n  // thử fallback bằng sid hợp lệ để giữ đăng nhập.\r\n  if (!tfp || tfp !== fp) {\r\n    const sid = req.cookies.get('sid')?.value || '';\r\n    if (!sid) return NextResponse.json({ success: false }, { status: 401 });\r\n    const session = await getSession(sid);\r\n    if (!session || String(session.userId) !== userId) return NextResponse.json({ success: false }, { status: 401 });\r\n  }\r\n\r\n  const accessToken = await signJWT({ _id: userId, username, name, fp });\r\n  const res = NextResponse.json({ success: true });\r\n  setAuthCookies(res, { accessToken });\r\n\r\n  const rotateRefresh = await signEphemeralJWT({ purpose: 'refresh', sub: userId, username, name, fp }, 3650 * 24 * 3600);\r\n  setAuthCookies(res, { refreshToken: rotateRefresh });\r\n\r\n  return res;\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEO,MAAM,UAAU;AAEhB,eAAe,IAAI,GAAgB;IACxC,MAAM,UAAU,IAAI,OAAO,CAAC,GAAG,CAAC,kBAAkB,SAAS;IAC3D,IAAI,CAAC,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;IAAM,GAAG;QAAE,QAAQ;IAAI;IACzE,MAAM,UAAU,MAAM,IAAA,iIAAS,EAAC;IAChC,IAAI,CAAC,WAAW,OAAO,CAAC,UAAU,KAAK,WAAW,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;IAAM,GAAG;QAAE,QAAQ;IAAI;IAC7G,MAAM,KAAK,IAAA,iJAAsB,EAAC;QAChC,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB;QAC/C,mBAAmB,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAC3D;IACA,MAAM,MAAM,OAAO,OAAO,CAAC,KAAK,KAAK,WAAY,OAAO,CAAC,KAAK,GAAc;IAC5E,MAAM,SAAS,OAAO,OAAO,CAAC,MAAM,KAAK,WAAY,OAAO,CAAC,MAAM,GAAc;IACjF,MAAM,WAAW,OAAO,OAAO,CAAC,WAAW,KAAK,WAAY,OAAO,CAAC,WAAW,GAAc;IAC7F,MAAM,OAAO,OAAO,OAAO,CAAC,OAAO,KAAK,WAAY,OAAO,CAAC,OAAO,GAAc;IACjF,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;IAAM,GAAG;QAAE,QAAQ;IAAI;IAExE,4EAA4E;IAC5E,iDAAiD;IACjD,IAAI,CAAC,OAAO,QAAQ,IAAI;QACtB,MAAM,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,SAAS;QAC7C,IAAI,CAAC,KAAK,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAM,GAAG;YAAE,QAAQ;QAAI;QACrE,MAAM,UAAU,MAAM,IAAA,qIAAU,EAAC;QACjC,IAAI,CAAC,WAAW,OAAO,QAAQ,MAAM,MAAM,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAM,GAAG;YAAE,QAAQ;QAAI;IAChH;IAEA,MAAM,cAAc,MAAM,IAAA,+HAAO,EAAC;QAAE,KAAK;QAAQ;QAAU;QAAM;IAAG;IACpE,MAAM,MAAM,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;IAAK;IAC9C,IAAA,6IAAc,EAAC,KAAK;QAAE;IAAY;IAElC,MAAM,gBAAgB,MAAM,IAAA,wIAAgB,EAAC;QAAE,SAAS;QAAW,KAAK;QAAQ;QAAU;QAAM;IAAG,GAAG,OAAO,KAAK;IAClH,IAAA,6IAAc,EAAC,KAAK;QAAE,cAAc;IAAc;IAElD,OAAO;AACT"}}]
}