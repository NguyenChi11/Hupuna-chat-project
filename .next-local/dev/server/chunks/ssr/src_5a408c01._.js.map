{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/dateUtils.ts"],"sourcesContent":["export const formatTimeAgo = (timestamp?: number | null): string => {\r\n  if (!timestamp) return '';\r\n\r\n  const now = Date.now();\r\n  const diff = now - timestamp;\r\n\r\n  // Quy ƒë·ªïi ra gi√¢y, ph√∫t, gi·ªù, ng√†y\r\n  const seconds = Math.floor(diff / 1000);\r\n  const minutes = Math.floor(seconds / 60);\r\n  const hours = Math.floor(minutes / 60);\r\n  const days = Math.floor(hours / 24);\r\n\r\n  if (seconds < 60) {\r\n    return 'V·ª´a xong';\r\n  } else if (minutes < 60) {\r\n    return `${minutes} ph√∫t`;\r\n  } else if (hours < 24) {\r\n    return `${hours} gi·ªù`;\r\n  } else if (days < 7) {\r\n    return `${days} ng√†y`;\r\n  } else {\r\n    // N·∫øu qu√° 7 ng√†y th√¨ hi·ªán ng√†y th√°ng (VD: 20/11)\r\n    const date = new Date(timestamp);\r\n    return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,gBAAgB,CAAC;IAC5B,IAAI,CAAC,WAAW,OAAO;IAEvB,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,OAAO,MAAM;IAEnB,mCAAmC;IACnC,MAAM,UAAU,KAAK,KAAK,CAAC,OAAO;IAClC,MAAM,UAAU,KAAK,KAAK,CAAC,UAAU;IACrC,MAAM,QAAQ,KAAK,KAAK,CAAC,UAAU;IACnC,MAAM,OAAO,KAAK,KAAK,CAAC,QAAQ;IAEhC,IAAI,UAAU,IAAI;QAChB,OAAO;IACT,OAAO,IAAI,UAAU,IAAI;QACvB,OAAO,GAAG,QAAQ,KAAK,CAAC;IAC1B,OAAO,IAAI,QAAQ,IAAI;QACrB,OAAO,GAAG,MAAM,IAAI,CAAC;IACvB,OAAO,IAAI,OAAO,GAAG;QACnB,OAAO,GAAG,KAAK,KAAK,CAAC;IACvB,OAAO;QACL,iDAAiD;QACjD,MAAM,OAAO,IAAI,KAAK;QACtB,OAAO,GAAG,KAAK,OAAO,GAAG,QAAQ,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,CAAC,KAAK,QAAQ,KAAK,CAAC,EAAE,QAAQ,GAAG,QAAQ,CAAC,GAAG,MAAM;IAC7G;AACF"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/getFbEmojiUrl.ts"],"sourcesContent":["export function getEmojiUrl(unicode: string) {\r\n  return `https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/${unicode}.png`;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,YAAY,OAAe;IACzC,OAAO,CAAC,yDAAyD,EAAE,QAAQ,IAAI,CAAC;AAClF"}},
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/uploadHelper.ts"],"sourcesContent":["/**\r\n * Upload file s·ª≠ d·ª•ng XMLHttpRequest ƒë·ªÉ theo d√µi ti·∫øn tr√¨nh (Progress)\r\n * @param url ƒê∆∞·ªùng d·∫´n API (v√≠ d·ª•: /api/upload)\r\n * @param formData D·ªØ li·ªáu form ch·ª©a file\r\n * @param onProgress Callback nh·∫≠n % ho√†n th√†nh (0 -> 100)\r\n */\r\nimport type { MessageCreate } from '@/types/Message';\r\n\r\nexport interface UploadSuccessResponse {\r\n  success: true;\r\n  link: string;\r\n  data: MessageCreate;\r\n  _id?: string;\r\n  saved?: boolean;\r\n}\r\n\r\nexport interface UploadErrorResponse {\r\n  success: false;\r\n  message: string;\r\n}\r\n\r\nexport type UploadResponse = UploadSuccessResponse | UploadErrorResponse;\r\n\r\nexport const uploadFileWithProgress = (\r\n  url: string,\r\n  formData: FormData,\r\n  onProgress: (percent: number) => void,\r\n): Promise<UploadResponse> => {\r\n  return new Promise((resolve) => {\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    // 1. L·∫Øng nghe s·ª± ki·ªán ti·∫øn tr√¨nh upload (quan tr·ªçng nh·∫•t)\r\n    xhr.upload.onprogress = (event) => {\r\n      if (event.lengthComputable) {\r\n        const percentComplete = (event.loaded / event.total) * 100;\r\n        onProgress(percentComplete); // G·ªçi callback ƒë·ªÉ c·∫≠p nh·∫≠t UI\r\n      }\r\n    };\r\n\r\n    // 2. M·ªü k·∫øt n·ªëi POST\r\n    xhr.open('POST', url);\r\n\r\n    // 3. X·ª≠ l√Ω khi ho√†n t·∫•t\r\n    xhr.onload = () => {\r\n      if (xhr.status >= 200 && xhr.status < 300) {\r\n        try {\r\n          // Parse k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ server (JSON)\r\n          const response = JSON.parse(xhr.responseText) as UploadResponse;\r\n          resolve(response);\r\n        } catch {\r\n          resolve({ success: false, message: 'Ph·∫£n h·ªìi t·ª´ server kh√¥ng ph·∫£i JSON h·ª£p l·ªá' });\r\n        }\r\n      } else {\r\n        try {\r\n          const parsed = JSON.parse(xhr.responseText) as { message?: string };\r\n          const msg =\r\n            typeof parsed?.message === 'string' && parsed.message.trim()\r\n              ? parsed.message\r\n              : xhr.statusText || `Upload th·∫•t b·∫°i (${xhr.status})`;\r\n          resolve({ success: false, message: msg });\r\n        } catch {\r\n          const msg = xhr.statusText || `Upload th·∫•t b·∫°i (${xhr.status})`;\r\n          resolve({ success: false, message: msg });\r\n        }\r\n      }\r\n    };\r\n\r\n    // 4. X·ª≠ l√Ω l·ªói m·∫°ng\r\n    xhr.onerror = () => {\r\n      resolve({ success: false, message: 'L·ªói m·∫°ng (Network Error)' });\r\n    };\r\n\r\n    // 5. G·ª≠i d·ªØ li·ªáu ƒëi\r\n    xhr.send(formData);\r\n  });\r\n};\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAkBM,MAAM,yBAAyB,CACpC,KACA,UACA;IAEA,OAAO,IAAI,QAAQ,CAAC;QAClB,MAAM,MAAM,IAAI;QAEhB,2DAA2D;QAC3D,IAAI,MAAM,CAAC,UAAU,GAAG,CAAC;YACvB,IAAI,MAAM,gBAAgB,EAAE;gBAC1B,MAAM,kBAAkB,AAAC,MAAM,MAAM,GAAG,MAAM,KAAK,GAAI;gBACvD,WAAW,kBAAkB,8BAA8B;YAC7D;QACF;QAEA,qBAAqB;QACrB,IAAI,IAAI,CAAC,QAAQ;QAEjB,wBAAwB;QACxB,IAAI,MAAM,GAAG;YACX,IAAI,IAAI,MAAM,IAAI,OAAO,IAAI,MAAM,GAAG,KAAK;gBACzC,IAAI;oBACF,wCAAwC;oBACxC,MAAM,WAAW,KAAK,KAAK,CAAC,IAAI,YAAY;oBAC5C,QAAQ;gBACV,EAAE,OAAM;oBACN,QAAQ;wBAAE,SAAS;wBAAO,SAAS;oBAA4C;gBACjF;YACF,OAAO;gBACL,IAAI;oBACF,MAAM,SAAS,KAAK,KAAK,CAAC,IAAI,YAAY;oBAC1C,MAAM,MACJ,OAAO,QAAQ,YAAY,YAAY,OAAO,OAAO,CAAC,IAAI,KACtD,OAAO,OAAO,GACd,IAAI,UAAU,IAAI,CAAC,iBAAiB,EAAE,IAAI,MAAM,CAAC,CAAC,CAAC;oBACzD,QAAQ;wBAAE,SAAS;wBAAO,SAAS;oBAAI;gBACzC,EAAE,OAAM;oBACN,MAAM,MAAM,IAAI,UAAU,IAAI,CAAC,iBAAiB,EAAE,IAAI,MAAM,CAAC,CAAC,CAAC;oBAC/D,QAAQ;wBAAE,SAAS;wBAAO,SAAS;oBAAI;gBACzC;YACF;QACF;QAEA,oBAAoB;QACpB,IAAI,OAAO,GAAG;YACZ,QAAQ;gBAAE,SAAS;gBAAO,SAAS;YAA2B;QAChE;QAEA,oBAAoB;QACpB,IAAI,IAAI,CAAC;IACX;AACF"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/chatInput.ts"],"sourcesContent":["export const insertTextAtCursor = (editable: HTMLDivElement, text: string) => {\r\n  const selection = window.getSelection();\r\n  if (!selection || selection.rangeCount === 0) {\r\n    editable.appendChild(document.createTextNode(text));\r\n    return;\r\n  }\r\n\r\n  const range = selection.getRangeAt(0);\r\n\r\n  // ƒê·∫£m b·∫£o range n·∫±m b√™n trong editable\r\n  let current: Node | null = range.commonAncestorContainer;\r\n  let isInside = false;\r\n  while (current) {\r\n    if (current === editable) {\r\n      isInside = true;\r\n      break;\r\n    }\r\n    current = current.parentNode;\r\n  }\r\n\r\n  if (!isInside) {\r\n    editable.appendChild(document.createTextNode(text));\r\n    return;\r\n  }\r\n\r\n  range.deleteContents();\r\n  const textNode = document.createTextNode(text);\r\n  range.insertNode(textNode);\r\n\r\n  // Di chuy·ªÉn caret sau emoji v·ª´a ch√®n\r\n  range.setStartAfter(textNode);\r\n  range.collapse(true);\r\n  selection.removeAllRanges();\r\n  selection.addRange(range);\r\n};\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,qBAAqB,CAAC,UAA0B;IAC3D,MAAM,YAAY,OAAO,YAAY;IACrC,IAAI,CAAC,aAAa,UAAU,UAAU,KAAK,GAAG;QAC5C,SAAS,WAAW,CAAC,SAAS,cAAc,CAAC;QAC7C;IACF;IAEA,MAAM,QAAQ,UAAU,UAAU,CAAC;IAEnC,uCAAuC;IACvC,IAAI,UAAuB,MAAM,uBAAuB;IACxD,IAAI,WAAW;IACf,MAAO,QAAS;QACd,IAAI,YAAY,UAAU;YACxB,WAAW;YACX;QACF;QACA,UAAU,QAAQ,UAAU;IAC9B;IAEA,IAAI,CAAC,UAAU;QACb,SAAS,WAAW,CAAC,SAAS,cAAc,CAAC;QAC7C;IACF;IAEA,MAAM,cAAc;IACpB,MAAM,WAAW,SAAS,cAAc,CAAC;IACzC,MAAM,UAAU,CAAC;IAEjB,qCAAqC;IACrC,MAAM,aAAa,CAAC;IACpB,MAAM,QAAQ,CAAC;IACf,UAAU,eAAe;IACzB,UAAU,QAAQ,CAAC;AACrB"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/chatMessages.ts"],"sourcesContent":["import type { Message } from '@/types/Message';\r\n\r\nexport const groupMessagesByDate = (msgs: Message[]) => {\r\n  const groups = new Map<string, Message[]>();\r\n  const seen = new Set<string>();\r\n  msgs.forEach((msg) => {\r\n    const id = String(msg._id);\r\n    if (seen.has(id)) return;\r\n    seen.add(id);\r\n    const ts =\r\n      Number((msg as unknown as { serverTimestamp?: number }).serverTimestamp ?? msg.timestamp) || 0;\r\n    const dateKey = new Date(ts).toLocaleDateString('vi-VN', {\r\n      year: 'numeric',\r\n      month: 'long',\r\n      day: 'numeric',\r\n    });\r\n    if (!groups.has(dateKey)) {\r\n      groups.set(dateKey, []);\r\n    }\r\n    groups.get(dateKey)!.push(msg);\r\n  });\r\n  const safeNum = (t: unknown) => {\r\n    const n = Number(t);\r\n    return Number.isFinite(n) ? n : 0;\r\n  };\r\n  const cmp = (a: Message, b: Message) => {\r\n    const ta = safeNum((a as unknown as { serverTimestamp?: number }).serverTimestamp ?? a.timestamp);\r\n    const tb = safeNum((b as unknown as { serverTimestamp?: number }).serverTimestamp ?? b.timestamp);\r\n    if (ta !== tb) return ta - tb;\r\n    const ia = String(a._id || '');\r\n    const ib = String(b._id || '');\r\n    if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n    if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n    return ia.localeCompare(ib);\r\n  };\r\n  Array.from(groups.values()).forEach((arr) => arr.sort(cmp));\r\n  return groups;\r\n};\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAEO,MAAM,sBAAsB,CAAC;IAClC,MAAM,SAAS,IAAI;IACnB,MAAM,OAAO,IAAI;IACjB,KAAK,OAAO,CAAC,CAAC;QACZ,MAAM,KAAK,OAAO,IAAI,GAAG;QACzB,IAAI,KAAK,GAAG,CAAC,KAAK;QAClB,KAAK,GAAG,CAAC;QACT,MAAM,KACJ,OAAO,AAAC,IAAgD,eAAe,IAAI,IAAI,SAAS,KAAK;QAC/F,MAAM,UAAU,IAAI,KAAK,IAAI,kBAAkB,CAAC,SAAS;YACvD,MAAM;YACN,OAAO;YACP,KAAK;QACP;QACA,IAAI,CAAC,OAAO,GAAG,CAAC,UAAU;YACxB,OAAO,GAAG,CAAC,SAAS,EAAE;QACxB;QACA,OAAO,GAAG,CAAC,SAAU,IAAI,CAAC;IAC5B;IACA,MAAM,UAAU,CAAC;QACf,MAAM,IAAI,OAAO;QACjB,OAAO,OAAO,QAAQ,CAAC,KAAK,IAAI;IAClC;IACA,MAAM,MAAM,CAAC,GAAY;QACvB,MAAM,KAAK,QAAQ,AAAC,EAA8C,eAAe,IAAI,EAAE,SAAS;QAChG,MAAM,KAAK,QAAQ,AAAC,EAA8C,eAAe,IAAI,EAAE,SAAS;QAChG,IAAI,OAAO,IAAI,OAAO,KAAK;QAC3B,MAAM,KAAK,OAAO,EAAE,GAAG,IAAI;QAC3B,MAAM,KAAK,OAAO,EAAE,GAAG,IAAI;QAC3B,IAAI,GAAG,UAAU,CAAC,YAAY,CAAC,GAAG,UAAU,CAAC,UAAU,OAAO;QAC9D,IAAI,CAAC,GAAG,UAAU,CAAC,YAAY,GAAG,UAAU,CAAC,UAAU,OAAO,CAAC;QAC/D,OAAO,GAAG,aAAa,CAAC;IAC1B;IACA,MAAM,IAAI,CAAC,OAAO,MAAM,IAAI,OAAO,CAAC,CAAC,MAAQ,IAAI,IAAI,CAAC;IACtD,OAAO;AACT"}},
    {"offset": {"line": 193, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useCreateGroupModal.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useMemo, useState } from 'react';\r\nimport io from 'socket.io-client';\r\nimport { resolveSocketUrl, normalizeNoAccent } from '@/utils/utils';\r\nimport type { User } from '@/types/User';\r\nimport type { GroupConversation } from '@/types/Group';\r\n\r\ninterface UseCreateGroupModalParams {\r\n  currentUser: User;\r\n  allUsers: User[];\r\n  mode: 'create' | 'add';\r\n  conversationId?: string;\r\n  existingMemberIds?: string[];\r\n  reLoad?: () => void;\r\n  onMembersAdded?: (users: User[]) => void;\r\n  /**\r\n   * ƒê∆∞·ª£c g·ªçi sau khi t·∫°o nh√≥m / th√™m th√†nh vi√™n th√†nh c√¥ng.\r\n   * - V·ªõi mode \"create\": nh·∫≠n v·ªÅ group v·ª´a t·∫°o ƒë·ªÉ FE c√≥ th·ªÉ auto m·ªü khung chat.\r\n   * - V·ªõi mode \"add\": kh√¥ng c·∫ßn tham s·ªë.\r\n   */\r\n  onGroupCreated: (group?: GroupConversation) => void;\r\n  onClose: () => void;\r\n}\r\n\r\nexport function useCreateGroupModal({\r\n  currentUser,\r\n  allUsers,\r\n  mode,\r\n  conversationId,\r\n  existingMemberIds = [],\r\n  reLoad,\r\n  onMembersAdded,\r\n  onGroupCreated,\r\n  onClose,\r\n}: UseCreateGroupModalParams) {\r\n  const [groupName, setGroupName] = useState('');\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [avatarFile, setAvatarFile] = useState<File | null>(null);\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);\r\n\r\n  const [selectedMembers, setSelectedMembers] = useState<string[]>(() => {\r\n    const currentUserId = String(currentUser._id);\r\n    const initialSet = new Set<string>([...existingMemberIds.map(String), currentUserId]);\r\n    return Array.from(initialSet);\r\n  });\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n\r\n  const handleMemberToggle = (_id: string) => {\r\n    if (mode === 'add' && existingMemberIds.includes(_id)) return;\r\n    setSelectedMembers((prev) => (prev.includes(_id) ? prev.filter((id) => id !== _id) : [...prev, _id]));\r\n  };\r\n\r\n  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    if (!file.type.startsWith('image/')) {\r\n      setError('Vui l√≤ng ch·ªçn file ·∫£nh');\r\n      return;\r\n    }\r\n\r\n    // Remove size limit\r\n    // const MAX = 5 * 1024 * 1024; // 5MB\r\n    // if (file.size > MAX) { ... }\r\n\r\n    setAvatarFile(file);\r\n    setAvatarPreview(URL.createObjectURL(file));\r\n    setError('');\r\n  };\r\n\r\n  const groupedUsers = useMemo(() => {\r\n    let filtered = allUsers;\r\n    if (searchTerm.trim()) {\r\n      const norm = normalizeNoAccent(searchTerm);\r\n      filtered = allUsers.filter((u) => normalizeNoAccent(u.name || '').includes(norm));\r\n    }\r\n\r\n    const sortedUsers = [...filtered].sort((a, b) => (a.name || '').localeCompare(b.name || ''));\r\n\r\n    const groups: Record<string, User[]> = {};\r\n    sortedUsers.forEach((user) => {\r\n      const firstLetter = (user.name?.charAt(0) || '#').toUpperCase();\r\n      const key = /^[A-Z]$/.test(firstLetter) ? firstLetter : '#';\r\n      if (!groups[key]) groups[key] = [];\r\n      groups[key].push(user);\r\n    });\r\n\r\n    return groups;\r\n  }, [allUsers, searchTerm]);\r\n\r\n  const sortedGroupKeys = useMemo(() => {\r\n    return Object.keys(groupedUsers).sort((a, b) => {\r\n      if (a === '#') return 1;\r\n      if (b === '#') return -1;\r\n      return a.localeCompare(b);\r\n    });\r\n  }, [groupedUsers]);\r\n\r\n  const handleSubmit = async () => {\r\n    if (mode === 'create' && !groupName.trim()) {\r\n      setError('Vui l√≤ng nh·∫≠p t√™n nh√≥m');\r\n      return;\r\n    }\r\n\r\n    const newMembersOnly = selectedMembers.filter((_id) => !existingMemberIds.includes(_id));\r\n\r\n    if (mode === 'add' && newMembersOnly.length === 0) {\r\n      setError('B·∫°n ch∆∞a ch·ªçn th√™m th√†nh vi√™n m·ªõi n√†o');\r\n      return;\r\n    }\r\n    if (mode === 'create' && selectedMembers.length < 3) {\r\n      setError('Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 3 th√†nh vi√™n (bao g·ªìm b·∫°n)');\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError('');\r\n\r\n    try {\r\n      let avatarUrl = '';\r\n      if (mode === 'create' && avatarFile) {\r\n        const uploadId = `group_avatar_${Date.now()}`;\r\n        const formData = new FormData();\r\n        formData.append('file', avatarFile);\r\n        formData.append('roomId', 'new_group');\r\n        formData.append('sender', String(currentUser._id));\r\n        formData.append('type', 'image');\r\n        formData.append('folderName', 'GroupAvatars');\r\n\r\n        const uploadRes = await fetch(`/api/upload?uploadId=${uploadId}`, {\r\n          method: 'POST',\r\n          body: formData,\r\n        });\r\n        const uploadJson = await uploadRes.json();\r\n        if (uploadJson.success && uploadJson.link) {\r\n          avatarUrl = uploadJson.link;\r\n        }\r\n      }\r\n\r\n      type CreateGroupBody = {\r\n        action: 'createGroup';\r\n        data: {\r\n          name: string;\r\n          members: string[];\r\n          createdBy: string;\r\n          avatar?: string;\r\n        };\r\n      };\r\n\r\n      type AddMembersBody = {\r\n        action: 'addMembers';\r\n        conversationId: string | undefined;\r\n        newMembers: string[];\r\n        _id: string;\r\n      };\r\n\r\n      let bodyData: CreateGroupBody | AddMembersBody;\r\n\r\n      if (mode === 'create') {\r\n        bodyData = {\r\n          action: 'createGroup',\r\n          data: {\r\n            name: groupName,\r\n            members: selectedMembers,\r\n            createdBy: currentUser._id,\r\n            avatar: avatarUrl || undefined,\r\n          },\r\n        };\r\n      } else {\r\n        bodyData = {\r\n          action: 'addMembers',\r\n          conversationId,\r\n          newMembers: newMembersOnly,\r\n          _id: String(currentUser._id),\r\n        };\r\n      }\r\n\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(bodyData),\r\n      });\r\n\r\n      const result = await res.json();\r\n\r\n      if (result.success) {\r\n        // Ch·ªâ reload l·∫°i d·ªØ li·ªáu khi thao t√°c th√†nh c√¥ng\r\n        reLoad?.();\r\n\r\n        if (mode === 'add' && onMembersAdded) {\r\n          const addedUsersFullInfo = allUsers.filter((u) => newMembersOnly.includes(String(u._id)));\r\n          onMembersAdded(addedUsersFullInfo);\r\n          try {\r\n            const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n            const prevMembersPayload = (existingMemberIds || []).map((id) => ({ _id: String(id) }));\r\n            const nextMembersPayload = newMembersOnly.map((id) => ({\r\n              _id: id,\r\n              role: 'MEMBER',\r\n              joinedAt: Date.now(),\r\n              addedBy: String(currentUser._id),\r\n            }));\r\n            sock.emit('group_members_updated', {\r\n              conversationId,\r\n              members: [...prevMembersPayload, ...nextMembersPayload],\r\n              action: 'add',\r\n            });\r\n            setTimeout(() => sock.disconnect(), 500);\r\n          } catch {}\r\n          onGroupCreated();\r\n        } else if (mode === 'create') {\r\n          const createdGroup = result.group as GroupConversation | undefined;\r\n          onGroupCreated(createdGroup);\r\n\r\n          // üî• Emit socket ƒë·ªÉ t·∫•t c·∫£ th√†nh vi√™n th·∫•y nh√≥m m·ªõi ngay tr√™n sidebar\r\n          try {\r\n            const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n            const roomIdStr = String(createdGroup?._id || result?.groupId || '');\r\n            const membersRaw = createdGroup?.members || selectedMembers;\r\n            const membersPayload = Array.isArray(membersRaw)\r\n              ? membersRaw.map((m) => (typeof m === 'object' && m?._id ? { _id: String(m._id) } : String(m)))\r\n              : [];\r\n\r\n            sock.emit('group_created', {\r\n              roomId: roomIdStr,\r\n              members: membersPayload,\r\n              sender: currentUser._id,\r\n              senderName: currentUser.name,\r\n              groupName: createdGroup?.name || groupName,\r\n            });\r\n            setTimeout(() => sock.disconnect(), 500);\r\n          } catch {}\r\n        }\r\n\r\n        onClose();\r\n      } else {\r\n        setError(result.error || 'Th·ª±c hi·ªán th·∫•t b·∫°i');\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError('L·ªói k·∫øt n·ªëi server');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return {\r\n    groupName,\r\n    setGroupName,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    selectedMembers,\r\n    loading,\r\n    error,\r\n    groupedUsers,\r\n    sortedGroupKeys,\r\n    handleMemberToggle,\r\n    handleSubmit,\r\n    avatarFile,\r\n    avatarPreview,\r\n    handleAvatarChange,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 423, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatInfoPopup.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState, useCallback, useRef } from 'react';\r\nimport type { ChatItem } from '@/types/Group';\r\nimport type { User } from '@/types/User';\r\nimport type { Message } from '@/types/Message';\r\n\r\ninterface UseChatInfoPopupParams {\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  messages: Message[];\r\n  currentUser: User;\r\n  onChatAction: (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroup: boolean) => void;\r\n}\r\n\r\nexport function useChatInfoPopup({ selectedChat, isGroup, messages, currentUser, onChatAction }: UseChatInfoPopupParams) {\r\n  const getId = (u: unknown): string => {\r\n    if (!u) return '';\r\n    if (typeof u === 'string') return u;\r\n    if (typeof u === 'number') return String(u);\r\n    if (typeof u === 'object' && u !== null) {\r\n      if ('_id' in (u as Record<string, unknown>) && (u as Record<string, unknown>)._id != null)\r\n        return String((u as Record<string, unknown>)._id);\r\n      if ('id' in (u as Record<string, unknown>) && (u as Record<string, unknown>).id != null)\r\n        return String((u as Record<string, unknown>).id);\r\n    }\r\n    return '';\r\n  };\r\n  const getOneToOneRoomId = (user1Id: string | number, user2Id: string | number) => {\r\n    return [user1Id, user2Id].sort().join('_');\r\n  };\r\n  const currentRoomId = isGroup ? getId(selectedChat) : getOneToOneRoomId(getId(currentUser), getId(selectedChat));\r\n  const { isPinned: initialIsPinned, isHidden: initialIsHidden } = selectedChat;\r\n\r\n  // Tr·∫°ng th√°i ghim / ·∫©n c·ª•c b·ªô (optimistic UI)\r\n  const [localIsPinned, setLocalIsPinned] = useState(initialIsPinned === true);\r\n  const [localIsHidden, setLocalIsHidden] = useState(initialIsHidden === true);\r\n\r\n  // Accordion tr·∫°ng th√°i m·ªü/ƒë√≥ng cho t·ª´ng m·ª•c\r\n  const [openItems, setOpenItems] = useState<Record<string, boolean>>({});\r\n\r\n  // Id c·ªßa item ƒëang m·ªü menu \"...\"\r\n  const [activeMenuId, setActiveMenuId] = useState<string | null>(null);\r\n\r\n  // C·∫≠p nh·∫≠t state c·ª•c b·ªô khi props thay ƒë·ªïi (theo ph√≤ng hi·ªán t·∫°i)\r\n  useEffect(() => {\r\n    setLocalIsPinned(initialIsPinned === true);\r\n    setLocalIsHidden(initialIsHidden === true);\r\n  }, [currentRoomId, initialIsPinned, initialIsHidden]);\r\n\r\n  const handleChatActionClick = (actionType: 'pin' | 'hide') => {\r\n    const targetId = isGroup ? currentRoomId : getId(selectedChat);\r\n    if (actionType === 'pin') {\r\n      const newState = !localIsPinned;\r\n      setLocalIsPinned(newState);\r\n      onChatAction(targetId, 'pin', newState, isGroup);\r\n    } else if (actionType === 'hide') {\r\n      const newState = !localIsHidden;\r\n      setLocalIsHidden(newState);\r\n      onChatAction(targetId, 'hide', newState, isGroup);\r\n    }\r\n  };\r\n\r\n  const toggleItem = (item: string) => {\r\n    setOpenItems((prev) => ({\r\n      ...prev,\r\n      [item]: !prev[item],\r\n    }));\r\n  };\r\n\r\n  const closeMenu = () => setActiveMenuId(null);\r\n\r\n  const [mediaList, setMediaList] = useState<{\r\n    id: string;\r\n    type: 'image' | 'video' | 'file';\r\n    url: string;\r\n    fileName?: string;\r\n    timestamp?: number;\r\n  }[]>([]);\r\n  const [mediaGroups, setMediaGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; fileName?: string; type: 'image' | 'video'; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [fileList, setFileList] = useState<{ id: string; url: string; fileName: string; timestamp?: number }[]>([]);\r\n  const [fileGroups, setFileGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; fileName: string; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [linkList, setLinkList] = useState<{ id: string; url: string; timestamp?: number }[]>([]);\r\n  const [linkGroups, setLinkGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [mediaTotal, setMediaTotal] = useState(0);\r\n  const [fileTotal, setFileTotal] = useState(0);\r\n  const [linkTotal, setLinkTotal] = useState(0);\r\n  const [isMediaExpanded, setIsMediaExpanded] = useState(false);\r\n  const [isFileExpanded, setIsFileExpanded] = useState(false);\r\n  const [isLinkExpanded, setIsLinkExpanded] = useState(false);\r\n  const assetsReqKeyRef = useRef(0);\r\n\r\n  const flattenGroups = useCallback(<T,>(groups: { items: T[] }[]) => groups.flatMap((g) => g.items ?? []), []);\r\n\r\n  const fetchAssets = useCallback(\r\n    async (assetType: 'media' | 'file' | 'link', needAll: boolean) => {\r\n      const reqKey = assetsReqKeyRef.current;\r\n      const postBody = {\r\n        action: 'readAssets',\r\n        roomId: currentRoomId,\r\n        assetType,\r\n        limit: needAll ? 5000 : 6,\r\n      };\r\n      try {\r\n        const res = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(postBody),\r\n        });\r\n        const json = await res.json();\r\n        if (assetsReqKeyRef.current !== reqKey) return;\r\n        const groups = Array.isArray(json.groups) ? json.groups : [];\r\n        if (assetType === 'media') {\r\n          const items = flattenGroups<{ id: string; url: string; fileName?: string; type: 'image' | 'video'; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setMediaList(items.map((it) => ({ id: it.id, url: it.url, fileName: it.fileName, type: it.type, timestamp: it.timestamp })));\r\n          setMediaGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, fileName: it.fileName, type: it.type, timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setMediaTotal(total);\r\n          setIsMediaExpanded(needAll);\r\n        } else if (assetType === 'file') {\r\n          const items = flattenGroups<{ id: string; url: string; fileName?: string; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setFileList(items.map((it) => ({ id: it.id, url: it.url, fileName: it.fileName || 'T√†i li·ªáu', timestamp: it.timestamp })));\r\n          setFileGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, fileName: it.fileName || 'T√†i li·ªáu', timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setFileTotal(total);\r\n          setIsFileExpanded(needAll);\r\n        } else {\r\n          const items = flattenGroups<{ id: string; url: string; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setLinkList(items);\r\n          setLinkGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setLinkTotal(total);\r\n          setIsLinkExpanded(needAll);\r\n        }\r\n      } catch {}\r\n    },\r\n    [currentRoomId, flattenGroups],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!Array.isArray(messages) || messages.length === 0) return;\r\n    const latest = messages[messages.length - 1];\r\n    const videoRegex = /(\\.mp4|\\.mov|\\.mkv|\\.webm|\\.avi|\\.m4v)$/i;\r\n    const linkRegex = /(https?:\\/\\/|www\\.)\\S+/i;\r\n\r\n    const isMediaMsg =\r\n      latest.type === 'image' ||\r\n      latest.type === 'video' ||\r\n      (latest.type === 'file' && (videoRegex.test(String(latest.fileUrl || '')) || videoRegex.test(String(latest.fileName || ''))));\r\n    const isFileMsg = latest.type === 'file' && !(videoRegex.test(String(latest.fileUrl || '')) || videoRegex.test(String(latest.fileName || '')));\r\n    const isLinkMsg = latest.type === 'text' && linkRegex.test(String(latest.content || ''));\r\n\r\n    if (isMediaMsg && openItems['·∫¢nh/Video']) void fetchAssets('media', isMediaExpanded);\r\n    if (isFileMsg && openItems['File']) void fetchAssets('file', isFileExpanded);\r\n    if (isLinkMsg && openItems['Link']) void fetchAssets('link', isLinkExpanded);\r\n  }, [messages, openItems, isMediaExpanded, isFileExpanded, isLinkExpanded, fetchAssets]);\r\n\r\n  useEffect(() => {\r\n    if (openItems['·∫¢nh/Video'] && mediaList.length === 0) void fetchAssets('media', false);\r\n  }, [openItems, mediaList.length, fetchAssets]);\r\n  useEffect(() => {\r\n    if (openItems['File'] && fileList.length === 0) void fetchAssets('file', false);\r\n  }, [openItems, fileList.length, fetchAssets]);\r\n  useEffect(() => {\r\n    if (openItems['Link'] && linkList.length === 0) void fetchAssets('link', false);\r\n  }, [openItems, linkList.length, fetchAssets]);\r\n\r\n  useEffect(() => {\r\n    assetsReqKeyRef.current += 1;\r\n    setOpenItems({});\r\n    setActiveMenuId(null);\r\n    setMediaList([]);\r\n    setMediaGroups([]);\r\n    setFileList([]);\r\n    setFileGroups([]);\r\n    setLinkList([]);\r\n    setLinkGroups([]);\r\n    setMediaTotal(0);\r\n    setFileTotal(0);\r\n    setLinkTotal(0);\r\n    setIsMediaExpanded(false);\r\n    setIsFileExpanded(false);\r\n    setIsLinkExpanded(false);\r\n  }, [currentRoomId]);\r\n\r\n  return {\r\n    currentRoomId,\r\n    localIsPinned,\r\n    localIsHidden,\r\n    openItems,\r\n    activeMenuId,\r\n    setActiveMenuId,\r\n    handleChatActionClick,\r\n    toggleItem,\r\n    closeMenu,\r\n    mediaList,\r\n    mediaGroups,\r\n    fileList,\r\n    fileGroups,\r\n    linkList,\r\n    linkGroups,\r\n    mediaTotal,\r\n    fileTotal,\r\n    linkTotal,\r\n    isMediaExpanded,\r\n    isFileExpanded,\r\n    isLinkExpanded,\r\n    fetchAssets,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AAFA;;AAeO,SAAS,iBAAiB,EAAE,YAAY,EAAE,OAAO,EAAE,QAAQ,EAAE,WAAW,EAAE,YAAY,EAA0B;IACrH,MAAM,QAAQ,CAAC;QACb,IAAI,CAAC,GAAG,OAAO;QACf,IAAI,OAAO,MAAM,UAAU,OAAO;QAClC,IAAI,OAAO,MAAM,UAAU,OAAO,OAAO;QACzC,IAAI,OAAO,MAAM,YAAY,MAAM,MAAM;YACvC,IAAI,SAAU,KAAiC,AAAC,EAA8B,GAAG,IAAI,MACnF,OAAO,OAAO,AAAC,EAA8B,GAAG;YAClD,IAAI,QAAS,KAAiC,AAAC,EAA8B,EAAE,IAAI,MACjF,OAAO,OAAO,AAAC,EAA8B,EAAE;QACnD;QACA,OAAO;IACT;IACA,MAAM,oBAAoB,CAAC,SAA0B;QACnD,OAAO;YAAC;YAAS;SAAQ,CAAC,IAAI,GAAG,IAAI,CAAC;IACxC;IACA,MAAM,gBAAgB,UAAU,MAAM,gBAAgB,kBAAkB,MAAM,cAAc,MAAM;IAClG,MAAM,EAAE,UAAU,eAAe,EAAE,UAAU,eAAe,EAAE,GAAG;IAEjE,8CAA8C;IAC9C,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAC,oBAAoB;IACvE,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAC,oBAAoB;IAEvE,4CAA4C;IAC5C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAA0B,CAAC;IAErE,iCAAiC;IACjC,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,iNAAQ,EAAgB;IAEhE,iEAAiE;IACjE,IAAA,kNAAS,EAAC;QACR,iBAAiB,oBAAoB;QACrC,iBAAiB,oBAAoB;IACvC,GAAG;QAAC;QAAe;QAAiB;KAAgB;IAEpD,MAAM,wBAAwB,CAAC;QAC7B,MAAM,WAAW,UAAU,gBAAgB,MAAM;QACjD,IAAI,eAAe,OAAO;YACxB,MAAM,WAAW,CAAC;YAClB,iBAAiB;YACjB,aAAa,UAAU,OAAO,UAAU;QAC1C,OAAO,IAAI,eAAe,QAAQ;YAChC,MAAM,WAAW,CAAC;YAClB,iBAAiB;YACjB,aAAa,UAAU,QAAQ,UAAU;QAC3C;IACF;IAEA,MAAM,aAAa,CAAC;QAClB,aAAa,CAAC,OAAS,CAAC;gBACtB,GAAG,IAAI;gBACP,CAAC,KAAK,EAAE,CAAC,IAAI,CAAC,KAAK;YACrB,CAAC;IACH;IAEA,MAAM,YAAY,IAAM,gBAAgB;IAExC,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAMrC,EAAE;IACP,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAE5C,EAAE;IACJ,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAsE,EAAE;IAChH,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAE1C,EAAE;IACJ,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAoD,EAAE;IAC9F,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAE1C,EAAE;IACJ,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAC7C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,iNAAQ,EAAC;IACvD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAC;IACrD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAC;IACrD,MAAM,kBAAkB,IAAA,+MAAM,EAAC;IAE/B,MAAM,gBAAgB,IAAA,oNAAW,EAAC,CAAK,SAA6B,OAAO,OAAO,CAAC,CAAC,IAAM,EAAE,KAAK,IAAI,EAAE,GAAG,EAAE;IAE5G,MAAM,cAAc,IAAA,oNAAW,EAC7B,OAAO,WAAsC;QAC3C,MAAM,SAAS,gBAAgB,OAAO;QACtC,MAAM,WAAW;YACf,QAAQ;YACR,QAAQ;YACR;YACA,OAAO,UAAU,OAAO;QAC1B;QACA,IAAI;YACF,MAAM,MAAM,MAAM,MAAM,iBAAiB;gBACvC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,IAAI,gBAAgB,OAAO,KAAK,QAAQ;YACxC,MAAM,SAAS,MAAM,OAAO,CAAC,KAAK,MAAM,IAAI,KAAK,MAAM,GAAG,EAAE;YAC5D,IAAI,cAAc,SAAS;gBACzB,MAAM,QAAQ,cAA2G;gBACzH,MAAM,QAAQ,OAAO,KAAK,KAAK,KAAK,WAAW,KAAK,KAAK,GAAG,MAAM,MAAM;gBACxE,aAAa,MAAM,GAAG,CAAC,CAAC,KAAO,CAAC;wBAAE,IAAI,GAAG,EAAE;wBAAE,KAAK,GAAG,GAAG;wBAAE,UAAU,GAAG,QAAQ;wBAAE,MAAM,GAAG,IAAI;wBAAE,WAAW,GAAG,SAAS;oBAAC,CAAC;gBACzH,eACE,OAAO,GAAG,CAAC,CAAC,IAAmD,CAAC;wBAC9D,WAAW,OAAO,EAAE,SAAS,IAAI;wBACjC,OAAO,CAAC,EAAE,KAAK,IAAI,EAAE,EAAE,GAAG,CAAC,CAAC,KAAO,CAAC;gCAAE,IAAI,GAAG,EAAE;gCAAE,KAAK,GAAG,GAAG;gCAAE,UAAU,GAAG,QAAQ;gCAAE,MAAM,GAAG,IAAI;gCAAE,WAAW,GAAG,SAAS;4BAAC,CAAC;oBAC/H,CAAC;gBAEH,cAAc;gBACd,mBAAmB;YACrB,OAAO,IAAI,cAAc,QAAQ;gBAC/B,MAAM,QAAQ,cAAkF;gBAChG,MAAM,QAAQ,OAAO,KAAK,KAAK,KAAK,WAAW,KAAK,KAAK,GAAG,MAAM,MAAM;gBACxE,YAAY,MAAM,GAAG,CAAC,CAAC,KAAO,CAAC;wBAAE,IAAI,GAAG,EAAE;wBAAE,KAAK,GAAG,GAAG;wBAAE,UAAU,GAAG,QAAQ,IAAI;wBAAY,WAAW,GAAG,SAAS;oBAAC,CAAC;gBACvH,cACE,OAAO,GAAG,CAAC,CAAC,IAAmD,CAAC;wBAC9D,WAAW,OAAO,EAAE,SAAS,IAAI;wBACjC,OAAO,CAAC,EAAE,KAAK,IAAI,EAAE,EAAE,GAAG,CAAC,CAAC,KAAO,CAAC;gCAAE,IAAI,GAAG,EAAE;gCAAE,KAAK,GAAG,GAAG;gCAAE,UAAU,GAAG,QAAQ,IAAI;gCAAY,WAAW,GAAG,SAAS;4BAAC,CAAC;oBAC9H,CAAC;gBAEH,aAAa;gBACb,kBAAkB;YACpB,OAAO;gBACL,MAAM,QAAQ,cAA+D;gBAC7E,MAAM,QAAQ,OAAO,KAAK,KAAK,KAAK,WAAW,KAAK,KAAK,GAAG,MAAM,MAAM;gBACxE,YAAY;gBACZ,cACE,OAAO,GAAG,CAAC,CAAC,IAAmD,CAAC;wBAC9D,WAAW,OAAO,EAAE,SAAS,IAAI;wBACjC,OAAO,CAAC,EAAE,KAAK,IAAI,EAAE,EAAE,GAAG,CAAC,CAAC,KAAO,CAAC;gCAAE,IAAI,GAAG,EAAE;gCAAE,KAAK,GAAG,GAAG;gCAAE,WAAW,GAAG,SAAS;4BAAC,CAAC;oBACzF,CAAC;gBAEH,aAAa;gBACb,kBAAkB;YACpB;QACF,EAAE,OAAM,CAAC;IACX,GACA;QAAC;QAAe;KAAc;IAGhC,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,SAAS,MAAM,KAAK,GAAG;QACvD,MAAM,SAAS,QAAQ,CAAC,SAAS,MAAM,GAAG,EAAE;QAC5C,MAAM,aAAa;QACnB,MAAM,YAAY;QAElB,MAAM,aACJ,OAAO,IAAI,KAAK,WAChB,OAAO,IAAI,KAAK,WACf,OAAO,IAAI,KAAK,UAAU,CAAC,WAAW,IAAI,CAAC,OAAO,OAAO,OAAO,IAAI,QAAQ,WAAW,IAAI,CAAC,OAAO,OAAO,QAAQ,IAAI,IAAI;QAC7H,MAAM,YAAY,OAAO,IAAI,KAAK,UAAU,CAAC,CAAC,WAAW,IAAI,CAAC,OAAO,OAAO,OAAO,IAAI,QAAQ,WAAW,IAAI,CAAC,OAAO,OAAO,QAAQ,IAAI,IAAI;QAC7I,MAAM,YAAY,OAAO,IAAI,KAAK,UAAU,UAAU,IAAI,CAAC,OAAO,OAAO,OAAO,IAAI;QAEpF,IAAI,cAAc,SAAS,CAAC,YAAY,EAAE,KAAK,YAAY,SAAS;QACpE,IAAI,aAAa,SAAS,CAAC,OAAO,EAAE,KAAK,YAAY,QAAQ;QAC7D,IAAI,aAAa,SAAS,CAAC,OAAO,EAAE,KAAK,YAAY,QAAQ;IAC/D,GAAG;QAAC;QAAU;QAAW;QAAiB;QAAgB;QAAgB;KAAY;IAEtF,IAAA,kNAAS,EAAC;QACR,IAAI,SAAS,CAAC,YAAY,IAAI,UAAU,MAAM,KAAK,GAAG,KAAK,YAAY,SAAS;IAClF,GAAG;QAAC;QAAW,UAAU,MAAM;QAAE;KAAY;IAC7C,IAAA,kNAAS,EAAC;QACR,IAAI,SAAS,CAAC,OAAO,IAAI,SAAS,MAAM,KAAK,GAAG,KAAK,YAAY,QAAQ;IAC3E,GAAG;QAAC;QAAW,SAAS,MAAM;QAAE;KAAY;IAC5C,IAAA,kNAAS,EAAC;QACR,IAAI,SAAS,CAAC,OAAO,IAAI,SAAS,MAAM,KAAK,GAAG,KAAK,YAAY,QAAQ;IAC3E,GAAG;QAAC;QAAW,SAAS,MAAM;QAAE;KAAY;IAE5C,IAAA,kNAAS,EAAC;QACR,gBAAgB,OAAO,IAAI;QAC3B,aAAa,CAAC;QACd,gBAAgB;QAChB,aAAa,EAAE;QACf,eAAe,EAAE;QACjB,YAAY,EAAE;QACd,cAAc,EAAE;QAChB,YAAY,EAAE;QACd,cAAc,EAAE;QAChB,cAAc;QACd,aAAa;QACb,aAAa;QACb,mBAAmB;QACnB,kBAAkB;QAClB,kBAAkB;IACpB,GAAG;QAAC;KAAc;IAElB,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 667, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatMentions.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useMemo, useRef, useState } from 'react';\r\nimport { normalizeNoAccent, hasDiacritics, accentAwareIncludes } from '@/utils/utils';\r\n\r\nimport type { User } from '@/types/User';\r\nimport type { MemberInfo } from '@/types/Group';\r\n\r\ninterface UseChatMentionsParams {\r\n  allUsers: User[];\r\n  activeMembers: MemberInfo[];\r\n  currentUser: User;\r\n  allUsersMap?: Map<string, string>;\r\n}\r\n\r\nexport function useChatMentions({ allUsers, activeMembers, currentUser, allUsersMap }: UseChatMentionsParams) {\r\n  const [showMentionMenu, setShowMentionMenu] = useState(false);\r\n  const [mentionQuery, setMentionQuery] = useState('');\r\n  const [mentionStartPos, setMentionStartPos] = useState<number | null>(null);\r\n  const [selectedMentionIndex, setSelectedMentionIndex] = useState(0);\r\n  const mentionMenuRef = useRef<HTMLDivElement | null>(null);\r\n  const editableRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  const getPlainTextFromEditable = useCallback((): string => {\r\n    if (!editableRef.current) return '';\r\n\r\n    const BLOCK_TAGS = new Set(['DIV', 'P', 'LI', 'UL', 'OL', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6']);\r\n\r\n    const traverse = (node: Node): string => {\r\n      if (node.nodeType === Node.TEXT_NODE) {\r\n        return node.textContent || '';\r\n      }\r\n\r\n      if (node.nodeType === Node.ELEMENT_NODE) {\r\n        const el = node as HTMLElement;\r\n\r\n        if (el.dataset && el.dataset.mention) {\r\n          const userId = el.dataset.userId as string;\r\n          const userName = el.dataset.userName as string;\r\n          return `@[${userName}](${userId})`;\r\n        }\r\n\r\n        if (el.tagName === 'BR') {\r\n          return '\\n';\r\n        }\r\n\r\n        let out = '';\r\n        el.childNodes.forEach((child) => {\r\n          out += traverse(child);\r\n        });\r\n\r\n        if (BLOCK_TAGS.has(el.tagName)) {\r\n          if (out && !out.endsWith('\\n')) out += '\\n';\r\n        }\r\n\r\n        return out;\r\n      }\r\n\r\n      return '';\r\n    };\r\n\r\n    const text = traverse(editableRef.current);\r\n    return text;\r\n  }, []);\r\n\r\n  const getCursorPosition = (): number => {\r\n    const selection = window.getSelection();\r\n    if (!selection || !editableRef.current || selection.rangeCount === 0) return 0;\r\n\r\n    const range = selection.getRangeAt(0);\r\n\r\n    // Ensure the selection is actually inside our editable element\r\n    if (!editableRef.current.contains(range.commonAncestorContainer)) {\r\n      return 0;\r\n    }\r\n\r\n    try {\r\n      const preCaretRange = range.cloneRange();\r\n      preCaretRange.selectNodeContents(editableRef.current);\r\n      preCaretRange.setEnd(range.endContainer, range.endOffset);\r\n\r\n      return preCaretRange.toString().length;\r\n    } catch (error) {\r\n      console.error('Error getting cursor position:', error);\r\n      return 0;\r\n    }\r\n  };\r\n\r\n  const parseMentions = (text: string): { mentions: string[]; displayText: string } => {\r\n    const mentionRegex = /@\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\r\n    const mentions: string[] = [];\r\n    let match;\r\n\r\n    while ((match = mentionRegex.exec(text)) !== null) {\r\n      mentions.push(match[2]); // userId\r\n    }\r\n\r\n    return { mentions, displayText: text };\r\n  };\r\n\r\n  const mentionSuggestions = useMemo(() => {\r\n    const getName = (u: User | MemberInfo) => {\r\n      if (allUsersMap) {\r\n        const id = u._id || (u as unknown as { id: string }).id;\r\n        const name = allUsersMap.get(String(id));\r\n        if (name) return name;\r\n      }\r\n      return (u as unknown as User).name || (u as unknown as MemberInfo).name;\r\n    };\r\n\r\n    const usersList = activeMembers.length > 0 ? (activeMembers as unknown as User[]) : allUsers;\r\n\r\n    // Ensure current user is in the list\r\n    const currentUserId = currentUser._id;\r\n    const hasCurrentUser = usersList.some((u) => {\r\n      const id = u._id || (u as unknown as { id: string }).id;\r\n      return String(id) === String(currentUserId);\r\n    });\r\n\r\n    const finalUsersList = hasCurrentUser ? usersList : [...usersList, currentUser];\r\n\r\n    if (!mentionQuery) return finalUsersList;\r\n\r\n    const query = normalizeNoAccent(mentionQuery);\r\n    const hasDia = hasDiacritics(mentionQuery);\r\n    return finalUsersList.filter((user) => accentAwareIncludes(getName(user) || '', mentionQuery));\r\n  }, [mentionQuery, activeMembers, allUsers, currentUser, allUsersMap]);\r\n\r\n  const handleInputChangeEditable = () => {\r\n    if (!editableRef.current) return;\r\n\r\n    const text = editableRef.current.textContent || '';\r\n    const cursorPos = getCursorPosition();\r\n\r\n    const textBeforeCursor = text.slice(0, cursorPos);\r\n    const lastAtIndex = textBeforeCursor.lastIndexOf('@');\r\n\r\n    if (lastAtIndex !== -1) {\r\n      const textAfterAt = textBeforeCursor.slice(lastAtIndex + 1);\r\n\r\n      if (textAfterAt.includes(' ') || textAfterAt.includes('\\n')) {\r\n        setShowMentionMenu(false);\r\n        setMentionStartPos(null);\r\n      } else {\r\n        setShowMentionMenu(true);\r\n        setMentionQuery(textAfterAt);\r\n        setMentionStartPos(lastAtIndex);\r\n        setSelectedMentionIndex(0);\r\n      }\r\n    } else {\r\n      setShowMentionMenu(false);\r\n      setMentionStartPos(null);\r\n    }\r\n  };\r\n\r\n  const selectMention = (user: User | MemberInfo) => {\r\n    if (mentionStartPos === null || !editableRef.current) return;\r\n\r\n    const editable = editableRef.current;\r\n    const userId = user._id;\r\n    const userName = allUsersMap?.get(String(userId)) || user.name || 'User';\r\n\r\n    const cursorPos = getCursorPosition();\r\n\r\n    // T·∫°o span mention m·ªõi\r\n    const mentionSpan = document.createElement('span');\r\n    mentionSpan.contentEditable = 'false';\r\n    mentionSpan.className =\r\n      'inline-flex items-center bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-sm font-medium mx-0.5';\r\n    mentionSpan.dataset.mention = 'true';\r\n    mentionSpan.dataset.userId = userId;\r\n    mentionSpan.dataset.userName = userName;\r\n    mentionSpan.textContent = `@${userName}`;\r\n\r\n    // Helper: T·∫°o range theo v·ªã tr√≠ text (d·ª±a tr√™n textContent)\r\n    const createRangeFromOffsets = (start: number, end: number): Range | null => {\r\n      const range = document.createRange();\r\n      let current = 0;\r\n      let startNode: Node | null = null;\r\n      let startOffset = 0;\r\n      let endNode: Node | null = null;\r\n      let endOffset = 0;\r\n\r\n      const walker = (node: Node): boolean => {\r\n        if (node.nodeType === Node.TEXT_NODE) {\r\n          const text = node.textContent || '';\r\n          const next = current + text.length;\r\n\r\n          if (!startNode && start >= current && start <= next) {\r\n            startNode = node;\r\n            startOffset = start - current;\r\n          }\r\n          if (!endNode && end >= current && end <= next) {\r\n            endNode = node;\r\n            endOffset = end - current;\r\n          }\r\n\r\n          current = next;\r\n        } else {\r\n          node.childNodes.forEach((child) => {\r\n            if (!endNode) {\r\n              const done = walker(child);\r\n              if (done) return;\r\n            }\r\n          });\r\n        }\r\n\r\n        return !!endNode;\r\n      };\r\n\r\n      walker(editable);\r\n\r\n      if (!startNode || !endNode) return null;\r\n\r\n      range.setStart(startNode, startOffset);\r\n      range.setEnd(endNode, endOffset);\r\n      return range;\r\n    };\r\n\r\n    const range = createRangeFromOffsets(mentionStartPos, cursorPos);\r\n    if (!range) {\r\n      // Fallback: ch√®n mention ·ªü cu·ªëi n·∫øu kh√¥ng t√≠nh ƒë∆∞·ª£c range\r\n      editable.appendChild(mentionSpan);\r\n      const spaceNode = document.createTextNode(' ');\r\n      editable.appendChild(spaceNode);\r\n\r\n      const sel = window.getSelection();\r\n      if (sel) {\r\n        const caretRange = document.createRange();\r\n        caretRange.setStartAfter(spaceNode);\r\n        caretRange.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(caretRange);\r\n      }\r\n    } else {\r\n      // Xo√° ƒëo·∫°n @typing hi·ªán t·∫°i v√† thay b·∫±ng span mention\r\n      range.deleteContents();\r\n\r\n      const spaceNode = document.createTextNode(' ');\r\n      range.insertNode(mentionSpan);\r\n      mentionSpan.after(spaceNode);\r\n\r\n      const sel = window.getSelection();\r\n      if (sel) {\r\n        const caretRange = document.createRange();\r\n        caretRange.setStartAfter(spaceNode);\r\n        caretRange.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(caretRange);\r\n      }\r\n    }\r\n\r\n    setShowMentionMenu(false);\r\n    setMentionStartPos(null);\r\n    setMentionQuery('');\r\n\r\n    // ƒê·∫£m b·∫£o focus l·∫°i v√†o √¥ nh·∫≠p\r\n    setTimeout(() => {\r\n      editable.focus();\r\n    }, 0);\r\n  };\r\n\r\n  const handleKeyDownEditable = (e: React.KeyboardEvent<HTMLDivElement>) => {\r\n    if (showMentionMenu) {\r\n      if (e.key === 'ArrowDown') {\r\n        e.preventDefault();\r\n        setSelectedMentionIndex((prev) => Math.min(prev + 1, mentionSuggestions.length - 1));\r\n      } else if (e.key === 'ArrowUp') {\r\n        e.preventDefault();\r\n        setSelectedMentionIndex((prev) => Math.max(prev - 1, 0));\r\n      } else if (e.key === 'Enter') {\r\n        e.preventDefault();\r\n        if (mentionSuggestions[selectedMentionIndex]) {\r\n          selectMention(mentionSuggestions[selectedMentionIndex] as User | MemberInfo);\r\n        }\r\n      } else if (e.key === 'Escape') {\r\n        setShowMentionMenu(false);\r\n        setMentionStartPos(null);\r\n      }\r\n    }\r\n  };\r\n\r\n  return {\r\n    showMentionMenu,\r\n    mentionSuggestions,\r\n    selectedMentionIndex,\r\n    mentionMenuRef,\r\n    editableRef,\r\n    getPlainTextFromEditable,\r\n    parseMentions,\r\n    handleInputChangeEditable,\r\n    handleKeyDownEditable,\r\n    selectMention,\r\n    setShowMentionMenu,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 934, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatUpload.ts"],"sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\r\n'use client';\r\n\r\nimport { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { Message, MessageCreate, MessageType } from '@/types/Message';\r\nimport { ChatItem, GroupConversation } from '@/types/Group';\r\nimport { User } from '@/types/User';\r\nimport { uploadFileWithProgress, type UploadResponse } from '@/utils/uploadHelper';\r\nimport { readMessagesApi } from '@/fetch/messages';\r\nimport { setProgress, getProgress, clearProgress } from '@/lib/uploadStore';\r\n\r\nlet swReadyPromise: Promise<ServiceWorkerRegistration> | null = null;\r\nlet swListenerAttached = false;\r\nconst pendingUploads = new Map<\r\n  string,\r\n  {\r\n    resolve: (res: UploadResponse) => void;\r\n    reject: (err: unknown) => void;\r\n  }\r\n>();\r\n\r\nasync function ensureServiceWorker() {\r\n  if (typeof window === 'undefined') return null;\r\n  if (!('serviceWorker' in navigator)) return null;\r\n  if (!swReadyPromise) {\r\n    swReadyPromise = navigator.serviceWorker\r\n      .register('/sw-upload.js', { scope: '/' })\r\n      .then(() => navigator.serviceWorker.ready);\r\n  }\r\n  const reg = await swReadyPromise.catch(() => null);\r\n  if (reg && !swListenerAttached) {\r\n    swListenerAttached = true;\r\n    navigator.serviceWorker.addEventListener('message', (e: MessageEvent) => {\r\n      const data = e.data as { type?: string; uploadId?: string; response?: UploadResponse; message?: string };\r\n      if (!data || !data.type) return;\r\n      const id = String(data.uploadId || '');\r\n      const entry = pendingUploads.get(id);\r\n      if (!entry) return;\r\n      if (data.type === 'UPLOAD_COMPLETE' && data.response) {\r\n        entry.resolve(data.response);\r\n        pendingUploads.delete(id);\r\n      } else if (data.type === 'UPLOAD_FAILED') {\r\n        entry.reject(new Error(data.message || 'Upload failed'));\r\n        pendingUploads.delete(id);\r\n      }\r\n    });\r\n  }\r\n  return reg;\r\n}\r\n\r\ninterface UseChatUploadParams {\r\n  roomId: string;\r\n  currentUser: User;\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  sendMessageProcess: (msgData: MessageCreate) => Promise<void>;\r\n  setMessages: React.Dispatch<React.SetStateAction<Message[]>>;\r\n  onScrollBottom?: () => void;\r\n}\r\n\r\nexport function useChatUpload({\r\n  roomId,\r\n  currentUser,\r\n  selectedChat,\r\n  isGroup,\r\n  sendMessageProcess,\r\n  setMessages,\r\n  onScrollBottom,\r\n}: UseChatUploadParams) {\r\n  const sortMessagesAsc = (list: Message[]) => {\r\n    const safeNum = (t: unknown) => {\r\n      const n = Number(t);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n    const cmp = (a: Message, b: Message) => {\r\n      const ta = safeNum(a.timestamp);\r\n      const tb = safeNum(b.timestamp);\r\n      if (ta !== tb) return ta - tb;\r\n      const ia = String(a._id || '');\r\n      const ib = String(b._id || '');\r\n      if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n      if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n      return ia.localeCompare(ib);\r\n    };\r\n    return list.slice().sort(cmp);\r\n  };\r\n  const [uploadingFiles, setUploadingFiles] = useState<Record<string, number>>({});\r\n  const activeSourcesRef = useRef<Record<string, EventSource>>({});\r\n\r\n  type PendingItem = {\r\n    tempId: string;\r\n    uploadId: string;\r\n    type: MessageType;\r\n    fileName: string;\r\n    caption?: string;\r\n    fileUrl: string;\r\n    percent?: number;\r\n  };\r\n  const pendingKey = `pendingUploads:${roomId}`;\r\n  const readPending = (): PendingItem[] => {\r\n    try {\r\n      const raw = localStorage.getItem(pendingKey);\r\n      return raw ? (JSON.parse(raw) as PendingItem[]) : [];\r\n    } catch {\r\n      return [];\r\n    }\r\n  };\r\n  const writePending = (arr: PendingItem[]) => {\r\n    try {\r\n      localStorage.setItem(pendingKey, JSON.stringify(arr));\r\n    } catch {}\r\n  };\r\n  const addPending = (item: PendingItem) => {\r\n    const arr = readPending();\r\n    const exists = arr.some((x) => x.tempId === item.tempId);\r\n    const next = exists ? arr.map((x) => (x.tempId === item.tempId ? item : x)) : [...arr, item];\r\n    writePending(next);\r\n  };\r\n  const setPendingPercent = (tempId: string, percent: number) => {\r\n    const arr = readPending();\r\n    const next = arr.map((x) => (x.tempId === tempId ? { ...x, percent } : x));\r\n    writePending(next);\r\n  };\r\n  const removePending = (tempId: string) => {\r\n    const arr = readPending();\r\n    const next = arr.filter((x) => x.tempId !== tempId);\r\n    writePending(next);\r\n  };\r\n\r\n  const handleUploadAndSend = useCallback(\r\n    async (\r\n      file: File,\r\n      type: MessageType,\r\n      caption?: string,\r\n      replyToMessageId?: string,\r\n      mentions?: string[],\r\n      senderName?: string,\r\n      batchId?: string,\r\n      videoCropConfig?: Message['videoCropConfig'] | null,\r\n    ) => {\r\n      const sanitizeName = (name: string) => {\r\n        return name\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n          .replace(/\\s+/g, '_')\r\n          .replace(/[^a-zA-Z0-9_]/g, '');\r\n      };\r\n\r\n      const uploadId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n      const tempId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\r\n\r\n      const formData = new FormData();\r\n      formData.append('file', file);\r\n      formData.append('roomId', roomId);\r\n      formData.append('sender', currentUser._id);\r\n      if (!isGroup && '_id' in selectedChat) {\r\n        formData.append('receiver', selectedChat._id);\r\n      }\r\n      formData.append('type', type);\r\n      formData.append('fileName', file.name);\r\n      if (batchId) {\r\n        formData.append('batchId', batchId);\r\n      }\r\n\r\n      let folderNameStr = '';\r\n      if (isGroup) {\r\n        folderNameStr = `Group__${sanitizeName((selectedChat as GroupConversation).name)}`;\r\n      } else {\r\n        const myName = sanitizeName(currentUser.name || 'Me');\r\n        const partnerBaseName = '_id' in selectedChat && 'name' in selectedChat ? selectedChat.name || 'User' : 'User';\r\n        const partnerName = sanitizeName(partnerBaseName);\r\n        const names = [myName, partnerName].sort();\r\n        folderNameStr = `${names[0]}__${names[1]}`;\r\n      }\r\n      formData.append('folderName', folderNameStr);\r\n\r\n      const tempMsg: Message & { isSending?: boolean } = {\r\n        _id: tempId,\r\n        roomId,\r\n        sender: currentUser._id,\r\n        senderModel: currentUser,\r\n        batchId,\r\n        fileUrl: URL.createObjectURL(file),\r\n        fileName: file.name,\r\n        type,\r\n        timestamp: Date.now(),\r\n        content: caption,\r\n        isSending: true,\r\n      };\r\n\r\n      setMessages((prev) => sortMessagesAsc([...prev, tempMsg]));\r\n      setUploadingFiles((prev) => ({ ...prev, [tempId]: 0 }));\r\n      setProgress(tempId, 0);\r\n      addPending({\r\n        tempId,\r\n        uploadId,\r\n        type,\r\n        fileName: file.name,\r\n        caption,\r\n        fileUrl: tempMsg.fileUrl || '',\r\n        percent: 0,\r\n      });\r\n      try {\r\n        onScrollBottom?.();\r\n      } catch {}\r\n\r\n      let success = false;\r\n      let lastMessage = '';\r\n      const useSW = !!(await ensureServiceWorker());\r\n      if (useSW) {\r\n        const es =\r\n          typeof window !== 'undefined'\r\n            ? new EventSource(`/api/upload/progress?id=${encodeURIComponent(uploadId)}`)\r\n            : null;\r\n        const updatePercent = (p: number) => {\r\n          const displayed = Math.min(p, 95);\r\n          setUploadingFiles((prev) => ({ ...prev, [tempId]: displayed }));\r\n          setProgress(tempId, displayed);\r\n          setPendingPercent(tempId, displayed);\r\n        };\r\n        if (es) {\r\n          activeSourcesRef.current[uploadId] = es;\r\n          es.onmessage = (ev) => {\r\n            try {\r\n              const payload = JSON.parse((ev as MessageEvent).data) as { percent?: number; done?: boolean };\r\n              const percent = typeof payload.percent === 'number' ? payload.percent : 0;\r\n              updatePercent(percent);\r\n              const done = !!payload.done;\r\n              if (done) {\r\n                es.close();\r\n                delete activeSourcesRef.current[uploadId];\r\n              }\r\n            } catch {}\r\n          };\r\n          es.onerror = () => {\r\n            try {\r\n              es.close();\r\n              delete activeSourcesRef.current[uploadId];\r\n            } catch {}\r\n          };\r\n        }\r\n        for (let attempt = 0; attempt < 2 && !success; attempt++) {\r\n          try {\r\n            const res = await new Promise<UploadResponse>((resolve, reject) => {\r\n              pendingUploads.set(uploadId, { resolve, reject });\r\n              const controller = navigator.serviceWorker.controller;\r\n              const fields: Record<string, unknown> = {\r\n                file,\r\n                roomId,\r\n                sender: currentUser._id,\r\n                receiver: !isGroup && '_id' in selectedChat ? selectedChat._id : '',\r\n                type,\r\n                fileName: file.name,\r\n                folderName: folderNameStr,\r\n                batchId,\r\n              };\r\n              controller?.postMessage({ type: 'UPLOAD', uploadId, fields });\r\n            });\r\n            if (res.success) {\r\n              success = true;\r\n              const finalMsg = res.data;\r\n              setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n              const socketData: MessageCreate = {\r\n                ...finalMsg,\r\n                _id: res._id || res.data._id || Date.now().toString(),\r\n                roomId,\r\n                sender: currentUser._id,\r\n                senderName: senderName || currentUser.name,\r\n                isGroup,\r\n                receiver: isGroup ? null : '_id' in selectedChat ? selectedChat._id : '',\r\n                members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n                type,\r\n                timestamp: Date.now(),\r\n                content: caption,\r\n                replyToMessageId,\r\n                mentions,\r\n                batchId,\r\n                videoCropConfig: type === 'video' ? (videoCropConfig ?? null) : null,\r\n              } as unknown as MessageCreate;\r\n              await sendMessageProcess(socketData);\r\n            } else {\r\n              lastMessage = res.message || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n            }\r\n          } catch (e) {\r\n            lastMessage = (e as Error)?.message || String(e) || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n          }\r\n        }\r\n        try {\r\n          es?.close();\r\n          if (es) delete activeSourcesRef.current[uploadId];\r\n        } catch {}\r\n      } else {\r\n        for (let attempt = 0; attempt < 2 && !success; attempt++) {\r\n          try {\r\n            const res = (await uploadFileWithProgress(\r\n              `/api/upload?uploadId=${uploadId}`,\r\n              formData,\r\n              (clientRawPercent) => {\r\n                const displayed = Math.min(clientRawPercent, 95);\r\n                setUploadingFiles((prev) => ({ ...prev, [tempId]: displayed }));\r\n                setProgress(tempId, displayed);\r\n                setPendingPercent(tempId, displayed);\r\n              },\r\n            )) as UploadResponse;\r\n            if (res.success) {\r\n              success = true;\r\n              const finalMsg = res.data;\r\n              setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n              const socketData: MessageCreate = {\r\n                ...finalMsg,\r\n                _id: res._id || res.data._id || Date.now().toString(),\r\n                roomId,\r\n                sender: currentUser._id,\r\n                senderName: senderName || currentUser.name,\r\n                isGroup,\r\n                receiver: isGroup ? null : '_id' in selectedChat ? selectedChat._id : '',\r\n                members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n                type,\r\n                timestamp: Date.now(),\r\n                content: caption,\r\n                replyToMessageId,\r\n                mentions,\r\n                batchId,\r\n                videoCropConfig: type === 'video' ? (videoCropConfig ?? null) : null,\r\n              } as unknown as MessageCreate;\r\n              await sendMessageProcess(socketData);\r\n            } else {\r\n              lastMessage = res.message || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n            }\r\n          } catch (e) {\r\n            lastMessage = (e as Error)?.message || String(e) || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!success) {\r\n        setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n        try {\r\n          alert(`T·∫£i l√™n th·∫•t b·∫°i: ${file.name}. L√Ω do: ${lastMessage}`);\r\n        } catch {}\r\n      }\r\n\r\n      setUploadingFiles((prev) => {\r\n        const newState = { ...prev };\r\n        delete newState[tempId];\r\n        return newState;\r\n      });\r\n      clearProgress(tempId);\r\n      removePending(tempId);\r\n    },\r\n    [roomId, currentUser, isGroup, selectedChat, sendMessageProcess, setMessages, onScrollBottom],\r\n  );\r\n\r\n  useEffect(() => {\r\n    const pending = readPending();\r\n    if (pending.length === 0) return;\r\n    pending.forEach((item) => {\r\n      setMessages((prev) => {\r\n        const exists = prev.some((m) => m._id === item.tempId);\r\n        if (exists) return prev;\r\n        const msg: Message & { isSending?: boolean } = {\r\n          _id: item.tempId,\r\n          roomId,\r\n          sender: currentUser._id,\r\n          senderModel: currentUser,\r\n          type: item.type,\r\n          fileUrl: item.fileUrl,\r\n          fileName: item.fileName,\r\n          timestamp: Date.now(),\r\n          content: item.caption,\r\n          isSending: true,\r\n        };\r\n        return sortMessagesAsc([...prev, msg]);\r\n      });\r\n      const p = getProgress(item.tempId);\r\n      const percent = p >= 0 ? p : item.percent || 0;\r\n      setUploadingFiles((prev) => ({ ...prev, [item.tempId]: Math.min(percent, 95) }));\r\n      if (!activeSourcesRef.current[item.uploadId]) {\r\n        try {\r\n          const es = new EventSource(`/api/upload/progress?id=${encodeURIComponent(item.uploadId)}`);\r\n          activeSourcesRef.current[item.uploadId] = es;\r\n          es.onmessage = (ev) => {\r\n            try {\r\n              const payload = JSON.parse((ev as MessageEvent).data) as { percent?: number; done?: boolean };\r\n              const percentN = typeof payload.percent === 'number' ? payload.percent : 0;\r\n              const displayed = Math.min(percentN, 95);\r\n              setUploadingFiles((prev) => ({ ...prev, [item.tempId]: displayed }));\r\n              setProgress(item.tempId, displayed);\r\n              setPendingPercent(item.tempId, displayed);\r\n              const done = !!payload.done;\r\n              if (done) {\r\n                es.close();\r\n                delete activeSourcesRef.current[item.uploadId];\r\n                setUploadingFiles((prev) => {\r\n                  const next = { ...prev };\r\n                  delete next[item.tempId];\r\n                  return next;\r\n                });\r\n                setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n                clearProgress(item.tempId);\r\n                removePending(item.tempId);\r\n                (async () => {\r\n                  try {\r\n                    const resp = await readMessagesApi(roomId, {\r\n                      limit: 1,\r\n                      sortOrder: 'desc',\r\n                      extraFilters: { uploadId: item.uploadId },\r\n                    });\r\n                    const list = (resp?.data as Message[]) || [];\r\n                    const match = list[0];\r\n                    if (match) {\r\n                      setMessages((prev) => {\r\n                        const exists = prev.some((mm) => String(mm._id) === String(match._id));\r\n                        return exists ? prev : [...prev, match];\r\n                      });\r\n                    }\r\n                  } catch {}\r\n                })();\r\n              }\r\n            } catch {}\r\n          };\r\n          es.onerror = () => {\r\n            try {\r\n              es.close();\r\n              delete activeSourcesRef.current[item.uploadId];\r\n            } catch {}\r\n          };\r\n        } catch {}\r\n      }\r\n    });\r\n    setTimeout(() => {\r\n      const again = readPending();\r\n      again.forEach((item) => {\r\n        setMessages((prev) => {\r\n          const exists = prev.some((m) => m._id === item.tempId);\r\n          if (exists) return prev;\r\n          const msg: Message & { isSending?: boolean } = {\r\n            _id: item.tempId,\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderModel: currentUser,\r\n            type: item.type,\r\n            fileUrl: item.fileUrl,\r\n            fileName: item.fileName,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            isSending: true,\r\n          };\r\n          return sortMessagesAsc([...prev, msg]);\r\n        });\r\n      });\r\n    }, 600);\r\n    setTimeout(() => {\r\n      const again = readPending();\r\n      again.forEach((item) => {\r\n        setMessages((prev) => {\r\n          const exists = prev.some((m) => m._id === item.tempId);\r\n          if (exists) return prev;\r\n          const msg: Message & { isSending?: boolean } = {\r\n            _id: item.tempId,\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderModel: currentUser,\r\n            type: item.type,\r\n            fileUrl: item.fileUrl,\r\n            fileName: item.fileName,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            isSending: true,\r\n          };\r\n          return sortMessagesAsc([...prev, msg]);\r\n        });\r\n      });\r\n    }, 1500);\r\n    return () => {\r\n      Object.values(activeSourcesRef.current).forEach((es) => {\r\n        try {\r\n          es.close();\r\n        } catch {}\r\n      });\r\n      activeSourcesRef.current = {};\r\n    };\r\n  }, [roomId, currentUser, setMessages]);\r\n\r\n  useEffect(() => {\r\n    const onSwMessage = async (e: MessageEvent) => {\r\n      const data = e.data as { type?: string; uploadId?: string; response?: UploadResponse; message?: string };\r\n      if (!data || !data.type) return;\r\n      const id = String(data.uploadId || '');\r\n      if (!id) return;\r\n      const arr = readPending();\r\n      const item = arr.find((x) => x.uploadId === id);\r\n      if (!item) return;\r\n      if (data.type === 'UPLOAD_COMPLETE' && data.response) {\r\n        const res = data.response as UploadResponse;\r\n        if (res.success) {\r\n          setUploadingFiles((prev) => {\r\n            const next = { ...prev };\r\n            delete next[item.tempId];\r\n            return next;\r\n          });\r\n          setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n          clearProgress(item.tempId);\r\n          removePending(item.tempId);\r\n          const finalMsg = res.data;\r\n          const socketData: MessageCreate = {\r\n            ...finalMsg,\r\n            _id: finalMsg._id || Date.now().toString(),\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderName: currentUser.name,\r\n            isGroup,\r\n            receiver: isGroup ? null : '_id' in selectedChat ? (selectedChat as User)._id : '',\r\n            members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n            type: item.type,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            batchId: (finalMsg as unknown as { batchId?: string }).batchId,\r\n          } as unknown as MessageCreate;\r\n          try {\r\n            await sendMessageProcess(socketData);\r\n          } catch {}\r\n        } else {\r\n          setUploadingFiles((prev) => {\r\n            const next = { ...prev };\r\n            delete next[item.tempId];\r\n            return next;\r\n          });\r\n          setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n          clearProgress(item.tempId);\r\n          removePending(item.tempId);\r\n        }\r\n      } else if (data.type === 'UPLOAD_FAILED') {\r\n        setUploadingFiles((prev) => {\r\n          const next = { ...prev };\r\n          delete next[item.tempId];\r\n          return next;\r\n        });\r\n        setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n        clearProgress(item.tempId);\r\n        removePending(item.tempId);\r\n      }\r\n    };\r\n    if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {\r\n      navigator.serviceWorker.addEventListener('message', onSwMessage);\r\n    }\r\n    return () => {\r\n      if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {\r\n        navigator.serviceWorker.removeEventListener('message', onSwMessage);\r\n      }\r\n    };\r\n  }, [roomId, currentUser, selectedChat, isGroup, sendMessageProcess, setMessages]);\r\n\r\n  return {\r\n    uploadingFiles,\r\n    handleUploadAndSend,\r\n  };\r\n}\r\n"],"names":[],"mappings":"AAAA,8CAA8C;;;;AAG9C;AAIA;AACA;AACA;AARA;;;;;AAUA,IAAI,iBAA4D;AAChE,IAAI,qBAAqB;AACzB,MAAM,iBAAiB,IAAI;AAQ3B,eAAe;IACb,wCAAmC,OAAO;;;IAO1C,MAAM;AAmBR;AAYO,SAAS,cAAc,EAC5B,MAAM,EACN,WAAW,EACX,YAAY,EACZ,OAAO,EACP,kBAAkB,EAClB,WAAW,EACX,cAAc,EACM;IACpB,MAAM,kBAAkB,CAAC;QACvB,MAAM,UAAU,CAAC;YACf,MAAM,IAAI,OAAO;YACjB,OAAO,OAAO,QAAQ,CAAC,KAAK,IAAI;QAClC;QACA,MAAM,MAAM,CAAC,GAAY;YACvB,MAAM,KAAK,QAAQ,EAAE,SAAS;YAC9B,MAAM,KAAK,QAAQ,EAAE,SAAS;YAC9B,IAAI,OAAO,IAAI,OAAO,KAAK;YAC3B,MAAM,KAAK,OAAO,EAAE,GAAG,IAAI;YAC3B,MAAM,KAAK,OAAO,EAAE,GAAG,IAAI;YAC3B,IAAI,GAAG,UAAU,CAAC,YAAY,CAAC,GAAG,UAAU,CAAC,UAAU,OAAO;YAC9D,IAAI,CAAC,GAAG,UAAU,CAAC,YAAY,GAAG,UAAU,CAAC,UAAU,OAAO,CAAC;YAC/D,OAAO,GAAG,aAAa,CAAC;QAC1B;QACA,OAAO,KAAK,KAAK,GAAG,IAAI,CAAC;IAC3B;IACA,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAyB,CAAC;IAC9E,MAAM,mBAAmB,IAAA,+MAAM,EAA8B,CAAC;IAW9D,MAAM,aAAa,CAAC,eAAe,EAAE,QAAQ;IAC7C,MAAM,cAAc;QAClB,IAAI;YACF,MAAM,MAAM,aAAa,OAAO,CAAC;YACjC,OAAO,MAAO,KAAK,KAAK,CAAC,OAAyB,EAAE;QACtD,EAAE,OAAM;YACN,OAAO,EAAE;QACX;IACF;IACA,MAAM,eAAe,CAAC;QACpB,IAAI;YACF,aAAa,OAAO,CAAC,YAAY,KAAK,SAAS,CAAC;QAClD,EAAE,OAAM,CAAC;IACX;IACA,MAAM,aAAa,CAAC;QAClB,MAAM,MAAM;QACZ,MAAM,SAAS,IAAI,IAAI,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK,KAAK,MAAM;QACvD,MAAM,OAAO,SAAS,IAAI,GAAG,CAAC,CAAC,IAAO,EAAE,MAAM,KAAK,KAAK,MAAM,GAAG,OAAO,KAAM;eAAI;YAAK;SAAK;QAC5F,aAAa;IACf;IACA,MAAM,oBAAoB,CAAC,QAAgB;QACzC,MAAM,MAAM;QACZ,MAAM,OAAO,IAAI,GAAG,CAAC,CAAC,IAAO,EAAE,MAAM,KAAK,SAAS;gBAAE,GAAG,CAAC;gBAAE;YAAQ,IAAI;QACvE,aAAa;IACf;IACA,MAAM,gBAAgB,CAAC;QACrB,MAAM,MAAM;QACZ,MAAM,OAAO,IAAI,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QAC5C,aAAa;IACf;IAEA,MAAM,sBAAsB,IAAA,oNAAW,EACrC,OACE,MACA,MACA,SACA,kBACA,UACA,YACA,SACA;QAEA,MAAM,eAAe,CAAC;YACpB,OAAO,KACJ,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAC5B,OAAO,CAAC,QAAQ,KAChB,OAAO,CAAC,kBAAkB;QAC/B;QAEA,MAAM,WAAW,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;QAC3E,MAAM,SAAS,CAAC,KAAK,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;QAE9E,MAAM,WAAW,IAAI;QACrB,SAAS,MAAM,CAAC,QAAQ;QACxB,SAAS,MAAM,CAAC,UAAU;QAC1B,SAAS,MAAM,CAAC,UAAU,YAAY,GAAG;QACzC,IAAI,CAAC,WAAW,SAAS,cAAc;YACrC,SAAS,MAAM,CAAC,YAAY,aAAa,GAAG;QAC9C;QACA,SAAS,MAAM,CAAC,QAAQ;QACxB,SAAS,MAAM,CAAC,YAAY,KAAK,IAAI;QACrC,IAAI,SAAS;YACX,SAAS,MAAM,CAAC,WAAW;QAC7B;QAEA,IAAI,gBAAgB;QACpB,IAAI,SAAS;YACX,gBAAgB,CAAC,OAAO,EAAE,aAAa,AAAC,aAAmC,IAAI,GAAG;QACpF,OAAO;YACL,MAAM,SAAS,aAAa,YAAY,IAAI,IAAI;YAChD,MAAM,kBAAkB,SAAS,gBAAgB,UAAU,eAAe,aAAa,IAAI,IAAI,SAAS;YACxG,MAAM,cAAc,aAAa;YACjC,MAAM,QAAQ;gBAAC;gBAAQ;aAAY,CAAC,IAAI;YACxC,gBAAgB,GAAG,KAAK,CAAC,EAAE,CAAC,EAAE,EAAE,KAAK,CAAC,EAAE,EAAE;QAC5C;QACA,SAAS,MAAM,CAAC,cAAc;QAE9B,MAAM,UAA6C;YACjD,KAAK;YACL;YACA,QAAQ,YAAY,GAAG;YACvB,aAAa;YACb;YACA,SAAS,IAAI,eAAe,CAAC;YAC7B,UAAU,KAAK,IAAI;YACnB;YACA,WAAW,KAAK,GAAG;YACnB,SAAS;YACT,WAAW;QACb;QAEA,YAAY,CAAC,OAAS,gBAAgB;mBAAI;gBAAM;aAAQ;QACxD,kBAAkB,CAAC,OAAS,CAAC;gBAAE,GAAG,IAAI;gBAAE,CAAC,OAAO,EAAE;YAAE,CAAC;QACrD,IAAA,wIAAW,EAAC,QAAQ;QACpB,WAAW;YACT;YACA;YACA;YACA,UAAU,KAAK,IAAI;YACnB;YACA,SAAS,QAAQ,OAAO,IAAI;YAC5B,SAAS;QACX;QACA,IAAI;YACF;QACF,EAAE,OAAM,CAAC;QAET,IAAI,UAAU;QACd,IAAI,cAAc;QAClB,MAAM,QAAQ,CAAC,CAAE,MAAM;QACvB,IAAI,OAAO;YACT,MAAM,KACJ,sCACI,0BACA;YACN,MAAM,gBAAgB,CAAC;gBACrB,MAAM,YAAY,KAAK,GAAG,CAAC,GAAG;gBAC9B,kBAAkB,CAAC,OAAS,CAAC;wBAAE,GAAG,IAAI;wBAAE,CAAC,OAAO,EAAE;oBAAU,CAAC;gBAC7D,IAAA,wIAAW,EAAC,QAAQ;gBACpB,kBAAkB,QAAQ;YAC5B;YACA;;YAqBA,IAAK,IAAI,UAAU,GAAG,UAAU,KAAK,CAAC,SAAS,UAAW;gBACxD,IAAI;oBACF,MAAM,MAAM,MAAM,IAAI,QAAwB,CAAC,SAAS;wBACtD,eAAe,GAAG,CAAC,UAAU;4BAAE;4BAAS;wBAAO;wBAC/C,MAAM,aAAa,UAAU,aAAa,CAAC,UAAU;wBACrD,MAAM,SAAkC;4BACtC;4BACA;4BACA,QAAQ,YAAY,GAAG;4BACvB,UAAU,CAAC,WAAW,SAAS,eAAe,aAAa,GAAG,GAAG;4BACjE;4BACA,UAAU,KAAK,IAAI;4BACnB,YAAY;4BACZ;wBACF;wBACA,YAAY,YAAY;4BAAE,MAAM;4BAAU;4BAAU;wBAAO;oBAC7D;oBACA,IAAI,IAAI,OAAO,EAAE;wBACf,UAAU;wBACV,MAAM,WAAW,IAAI,IAAI;wBACzB,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK;wBACnD,MAAM,aAA4B;4BAChC,GAAG,QAAQ;4BACX,KAAK,IAAI,GAAG,IAAI,IAAI,IAAI,CAAC,GAAG,IAAI,KAAK,GAAG,GAAG,QAAQ;4BACnD;4BACA,QAAQ,YAAY,GAAG;4BACvB,YAAY,cAAc,YAAY,IAAI;4BAC1C;4BACA,UAAU,UAAU,OAAO,SAAS,eAAe,aAAa,GAAG,GAAG;4BACtE,SAAS,UAAU,AAAC,aAAmC,OAAO,GAAG,EAAE;4BACnE;4BACA,WAAW,KAAK,GAAG;4BACnB,SAAS;4BACT;4BACA;4BACA;4BACA,iBAAiB,SAAS,UAAW,mBAAmB,OAAQ;wBAClE;wBACA,MAAM,mBAAmB;oBAC3B,OAAO;wBACL,cAAc,IAAI,OAAO,IAAI;oBAC/B;gBACF,EAAE,OAAO,GAAG;oBACV,cAAc,AAAC,GAAa,WAAW,OAAO,MAAM;gBACtD;YACF;YACA,IAAI;gBACF,IAAI;gBACJ;;YACF,EAAE,OAAM,CAAC;QACX,OAAO;YACL,IAAK,IAAI,UAAU,GAAG,UAAU,KAAK,CAAC,SAAS,UAAW;gBACxD,IAAI;oBACF,MAAM,MAAO,MAAM,IAAA,sJAAsB,EACvC,CAAC,qBAAqB,EAAE,UAAU,EAClC,UACA,CAAC;wBACC,MAAM,YAAY,KAAK,GAAG,CAAC,kBAAkB;wBAC7C,kBAAkB,CAAC,OAAS,CAAC;gCAAE,GAAG,IAAI;gCAAE,CAAC,OAAO,EAAE;4BAAU,CAAC;wBAC7D,IAAA,wIAAW,EAAC,QAAQ;wBACpB,kBAAkB,QAAQ;oBAC5B;oBAEF,IAAI,IAAI,OAAO,EAAE;wBACf,UAAU;wBACV,MAAM,WAAW,IAAI,IAAI;wBACzB,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK;wBACnD,MAAM,aAA4B;4BAChC,GAAG,QAAQ;4BACX,KAAK,IAAI,GAAG,IAAI,IAAI,IAAI,CAAC,GAAG,IAAI,KAAK,GAAG,GAAG,QAAQ;4BACnD;4BACA,QAAQ,YAAY,GAAG;4BACvB,YAAY,cAAc,YAAY,IAAI;4BAC1C;4BACA,UAAU,UAAU,OAAO,SAAS,eAAe,aAAa,GAAG,GAAG;4BACtE,SAAS,UAAU,AAAC,aAAmC,OAAO,GAAG,EAAE;4BACnE;4BACA,WAAW,KAAK,GAAG;4BACnB,SAAS;4BACT;4BACA;4BACA;4BACA,iBAAiB,SAAS,UAAW,mBAAmB,OAAQ;wBAClE;wBACA,MAAM,mBAAmB;oBAC3B,OAAO;wBACL,cAAc,IAAI,OAAO,IAAI;oBAC/B;gBACF,EAAE,OAAO,GAAG;oBACV,cAAc,AAAC,GAAa,WAAW,OAAO,MAAM;gBACtD;YACF;QACF;QAEA,IAAI,CAAC,SAAS;YACZ,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK;YACnD,IAAI;gBACF,MAAM,CAAC,kBAAkB,EAAE,KAAK,IAAI,CAAC,SAAS,EAAE,aAAa;YAC/D,EAAE,OAAM,CAAC;QACX;QAEA,kBAAkB,CAAC;YACjB,MAAM,WAAW;gBAAE,GAAG,IAAI;YAAC;YAC3B,OAAO,QAAQ,CAAC,OAAO;YACvB,OAAO;QACT;QACA,IAAA,0IAAa,EAAC;QACd,cAAc;IAChB,GACA;QAAC;QAAQ;QAAa;QAAS;QAAc;QAAoB;QAAa;KAAe;IAG/F,IAAA,kNAAS,EAAC;QACR,MAAM,UAAU;QAChB,IAAI,QAAQ,MAAM,KAAK,GAAG;QAC1B,QAAQ,OAAO,CAAC,CAAC;YACf,YAAY,CAAC;gBACX,MAAM,SAAS,KAAK,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;gBACrD,IAAI,QAAQ,OAAO;gBACnB,MAAM,MAAyC;oBAC7C,KAAK,KAAK,MAAM;oBAChB;oBACA,QAAQ,YAAY,GAAG;oBACvB,aAAa;oBACb,MAAM,KAAK,IAAI;oBACf,SAAS,KAAK,OAAO;oBACrB,UAAU,KAAK,QAAQ;oBACvB,WAAW,KAAK,GAAG;oBACnB,SAAS,KAAK,OAAO;oBACrB,WAAW;gBACb;gBACA,OAAO,gBAAgB;uBAAI;oBAAM;iBAAI;YACvC;YACA,MAAM,IAAI,8IAAY,KAAK,MAAM;YACjC,MAAM,UAAU,KAAK,IAAI,IAAI,KAAK,OAAO,IAAI;YAC7C,kBAAkB,CAAC,OAAS,CAAC;oBAAE,GAAG,IAAI;oBAAE,CAAC,KAAK,MAAM,CAAC,EAAE,KAAK,GAAG,CAAC,SAAS;gBAAI,CAAC;YAC9E,IAAI,CAAC,iBAAiB,OAAO,CAAC,KAAK,QAAQ,CAAC,EAAE;gBAC5C,IAAI;oBACF,MAAM,KAAK,IAAI,YAAY,CAAC,wBAAwB,EAAE,mBAAmB,KAAK,QAAQ,GAAG;oBACzF,iBAAiB,OAAO,CAAC,KAAK,QAAQ,CAAC,GAAG;oBAC1C,GAAG,SAAS,GAAG,CAAC;wBACd,IAAI;4BACF,MAAM,UAAU,KAAK,KAAK,CAAC,AAAC,GAAoB,IAAI;4BACpD,MAAM,WAAW,OAAO,QAAQ,OAAO,KAAK,WAAW,QAAQ,OAAO,GAAG;4BACzE,MAAM,YAAY,KAAK,GAAG,CAAC,UAAU;4BACrC,kBAAkB,CAAC,OAAS,CAAC;oCAAE,GAAG,IAAI;oCAAE,CAAC,KAAK,MAAM,CAAC,EAAE;gCAAU,CAAC;4BAClE,8IAAY,KAAK,MAAM,EAAE;4BACzB,kBAAkB,KAAK,MAAM,EAAE;4BAC/B,MAAM,OAAO,CAAC,CAAC,QAAQ,IAAI;4BAC3B,IAAI,MAAM;gCACR,GAAG,KAAK;gCACR,OAAO,iBAAiB,OAAO,CAAC,KAAK,QAAQ,CAAC;gCAC9C,kBAAkB,CAAC;oCACjB,MAAM,OAAO;wCAAE,GAAG,IAAI;oCAAC;oCACvB,OAAO,IAAI,CAAC,KAAK,MAAM,CAAC;oCACxB,OAAO;gCACT;gCACA,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;gCAC9D,gJAAc,KAAK,MAAM;gCACzB,cAAc,KAAK,MAAM;gCACzB,CAAC;oCACC,IAAI;wCACF,MAAM,OAAO,MAAM,iJAAgB,QAAQ;4CACzC,OAAO;4CACP,WAAW;4CACX,cAAc;gDAAE,UAAU,KAAK,QAAQ;4CAAC;wCAC1C;wCACA,MAAM,OAAO,AAAC,MAAM,QAAsB,EAAE;wCAC5C,MAAM,QAAQ,IAAI,CAAC,EAAE;wCACrB,IAAI,OAAO;4CACT,YAAY,CAAC;gDACX,MAAM,SAAS,KAAK,IAAI,CAAC,CAAC,KAAO,OAAO,GAAG,GAAG,MAAM,OAAO,MAAM,GAAG;gDACpE,OAAO,SAAS,OAAO;uDAAI;oDAAM;iDAAM;4CACzC;wCACF;oCACF,EAAE,OAAM,CAAC;gCACX,CAAC;4BACH;wBACF,EAAE,OAAM,CAAC;oBACX;oBACA,GAAG,OAAO,GAAG;wBACX,IAAI;4BACF,GAAG,KAAK;4BACR,OAAO,iBAAiB,OAAO,CAAC,KAAK,QAAQ,CAAC;wBAChD,EAAE,OAAM,CAAC;oBACX;gBACF,EAAE,OAAM,CAAC;YACX;QACF;QACA,WAAW;YACT,MAAM,QAAQ;YACd,MAAM,OAAO,CAAC,CAAC;gBACb,YAAY,CAAC;oBACX,MAAM,SAAS,KAAK,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;oBACrD,IAAI,QAAQ,OAAO;oBACnB,MAAM,MAAyC;wBAC7C,KAAK,KAAK,MAAM;wBAChB;wBACA,QAAQ,YAAY,GAAG;wBACvB,aAAa;wBACb,MAAM,KAAK,IAAI;wBACf,SAAS,KAAK,OAAO;wBACrB,UAAU,KAAK,QAAQ;wBACvB,WAAW,KAAK,GAAG;wBACnB,SAAS,KAAK,OAAO;wBACrB,WAAW;oBACb;oBACA,OAAO,gBAAgB;2BAAI;wBAAM;qBAAI;gBACvC;YACF;QACF,GAAG;QACH,WAAW;YACT,MAAM,QAAQ;YACd,MAAM,OAAO,CAAC,CAAC;gBACb,YAAY,CAAC;oBACX,MAAM,SAAS,KAAK,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;oBACrD,IAAI,QAAQ,OAAO;oBACnB,MAAM,MAAyC;wBAC7C,KAAK,KAAK,MAAM;wBAChB;wBACA,QAAQ,YAAY,GAAG;wBACvB,aAAa;wBACb,MAAM,KAAK,IAAI;wBACf,SAAS,KAAK,OAAO;wBACrB,UAAU,KAAK,QAAQ;wBACvB,WAAW,KAAK,GAAG;wBACnB,SAAS,KAAK,OAAO;wBACrB,WAAW;oBACb;oBACA,OAAO,gBAAgB;2BAAI;wBAAM;qBAAI;gBACvC;YACF;QACF,GAAG;QACH,OAAO;YACL,OAAO,MAAM,CAAC,iBAAiB,OAAO,EAAE,OAAO,CAAC,CAAC;gBAC/C,IAAI;oBACF,GAAG,KAAK;gBACV,EAAE,OAAM,CAAC;YACX;YACA,iBAAiB,OAAO,GAAG,CAAC;QAC9B;IACF,GAAG;QAAC;QAAQ;QAAa;KAAY;IAErC,IAAA,kNAAS,EAAC;QACR,MAAM,cAAc,OAAO;YACzB,MAAM,OAAO,EAAE,IAAI;YACnB,IAAI,CAAC,QAAQ,CAAC,KAAK,IAAI,EAAE;YACzB,MAAM,KAAK,OAAO,KAAK,QAAQ,IAAI;YACnC,IAAI,CAAC,IAAI;YACT,MAAM,MAAM;YACZ,MAAM,OAAO,IAAI,IAAI,CAAC,CAAC,IAAM,EAAE,QAAQ,KAAK;YAC5C,IAAI,CAAC,MAAM;YACX,IAAI,KAAK,IAAI,KAAK,qBAAqB,KAAK,QAAQ,EAAE;gBACpD,MAAM,MAAM,KAAK,QAAQ;gBACzB,IAAI,IAAI,OAAO,EAAE;oBACf,kBAAkB,CAAC;wBACjB,MAAM,OAAO;4BAAE,GAAG,IAAI;wBAAC;wBACvB,OAAO,IAAI,CAAC,KAAK,MAAM,CAAC;wBACxB,OAAO;oBACT;oBACA,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;oBAC9D,IAAA,0IAAa,EAAC,KAAK,MAAM;oBACzB,cAAc,KAAK,MAAM;oBACzB,MAAM,WAAW,IAAI,IAAI;oBACzB,MAAM,aAA4B;wBAChC,GAAG,QAAQ;wBACX,KAAK,SAAS,GAAG,IAAI,KAAK,GAAG,GAAG,QAAQ;wBACxC;wBACA,QAAQ,YAAY,GAAG;wBACvB,YAAY,YAAY,IAAI;wBAC5B;wBACA,UAAU,UAAU,OAAO,SAAS,eAAe,AAAC,aAAsB,GAAG,GAAG;wBAChF,SAAS,UAAU,AAAC,aAAmC,OAAO,GAAG,EAAE;wBACnE,MAAM,KAAK,IAAI;wBACf,WAAW,KAAK,GAAG;wBACnB,SAAS,KAAK,OAAO;wBACrB,SAAS,AAAC,SAA6C,OAAO;oBAChE;oBACA,IAAI;wBACF,MAAM,mBAAmB;oBAC3B,EAAE,OAAM,CAAC;gBACX,OAAO;oBACL,kBAAkB,CAAC;wBACjB,MAAM,OAAO;4BAAE,GAAG,IAAI;wBAAC;wBACvB,OAAO,IAAI,CAAC,KAAK,MAAM,CAAC;wBACxB,OAAO;oBACT;oBACA,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;oBAC9D,IAAA,0IAAa,EAAC,KAAK,MAAM;oBACzB,cAAc,KAAK,MAAM;gBAC3B;YACF,OAAO,IAAI,KAAK,IAAI,KAAK,iBAAiB;gBACxC,kBAAkB,CAAC;oBACjB,MAAM,OAAO;wBAAE,GAAG,IAAI;oBAAC;oBACvB,OAAO,IAAI,CAAC,KAAK,MAAM,CAAC;oBACxB,OAAO;gBACT;gBACA,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;gBAC9D,IAAA,0IAAa,EAAC,KAAK,MAAM;gBACzB,cAAc,KAAK,MAAM;YAC3B;QACF;QACA,IAAI,kDAAkB,eAAe,mBAAmB;;QAGxD,OAAO;YACL,IAAI,kDAAkB,eAAe,mBAAmB;;QAG1D;IACF,GAAG;QAAC;QAAQ;QAAa;QAAc;QAAS;QAAoB;KAAY;IAEhF,OAAO;QACL;QACA;IACF;AACF"}},
    {"offset": {"line": 1462, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatVoiceInput.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useRef, useState } from 'react';\r\nimport { insertTextAtCursor } from '@/utils/chatInput';\r\n\r\ninterface UseChatVoiceInputParams {\r\n  editableRef: React.RefObject<HTMLDivElement | null>;\r\n  handleInputChangeEditable: () => void;\r\n}\r\n\r\nexport function useChatVoiceInput({ editableRef, handleInputChangeEditable }: UseChatVoiceInputParams) {\r\n  const [isListening, setIsListening] = useState(false);\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n\r\n  const handleVoiceInput = useCallback(async () => {\r\n    const SpeechRecognition =\r\n      typeof window !== 'undefined' ? window.SpeechRecognition || window.webkitSpeechRecognition : null;\r\n\r\n    if (!SpeechRecognition) {\r\n      alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng n√†y. Vui l√≤ng d√πng Chrome ho·∫∑c Edge.');\r\n      return;\r\n    }\r\n\r\n    if (isListening) {\r\n      if (recognitionRef.current) {\r\n        recognitionRef.current.stop();\r\n      }\r\n      setIsListening(false);\r\n      return;\r\n    }\r\n\r\n    const isLocal =\r\n      typeof window !== 'undefined' &&\r\n      (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\r\n    const isSecure =\r\n      typeof window !== 'undefined' && (window.isSecureContext || window.location.protocol === 'https:');\r\n    if (!isSecure && !isLocal) {\r\n      alert('Vui l√≤ng truy c·∫≠p qua HTTPS ho·∫∑c localhost ƒë·ªÉ s·ª≠ d·ª•ng nh·∫≠p b·∫±ng gi·ªçng n√≥i.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (typeof navigator !== 'undefined' && navigator.mediaDevices?.getUserMedia) {\r\n        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n        stream.getTracks().forEach((t) => t.stop());\r\n      }\r\n    } catch {\r\n      alert('Vui l√≤ng c·∫•p quy·ªÅn microphone cho tr√¨nh duy·ªát ƒë·ªÉ s·ª≠ d·ª•ng nh·∫≠p b·∫±ng gi·ªçng n√≥i.');\r\n      return;\r\n    }\r\n\r\n    const recognition = new SpeechRecognition();\r\n    recognition.lang = 'vi-VN';\r\n    recognition.continuous = false;\r\n    recognition.interimResults = false;\r\n\r\n    recognition.onstart = () => {\r\n      setIsListening(true);\r\n    };\r\n\r\n    recognition.onend = () => {\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognition.onresult = (event: SpeechRecognitionEventLike) => {\r\n      const transcript = event.results[0][0].transcript;\r\n      const el = editableRef.current;\r\n      if (el) {\r\n        el.focus();\r\n        insertTextAtCursor(el, transcript);\r\n        handleInputChangeEditable();\r\n      }\r\n    };\r\n\r\n    recognition.onerror = (event: SpeechRecognitionEventLike) => {\r\n      if ((event.error || '').toLowerCase() === 'not-allowed') {\r\n        alert('Truy c·∫≠p microphone b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.');\r\n      }\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    recognition.start();\r\n  }, [isListening, editableRef, handleInputChangeEditable]);\r\n\r\n  return {\r\n    isListening,\r\n    handleVoiceInput,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;AAHA;;;AAUO,SAAS,kBAAkB,EAAE,WAAW,EAAE,yBAAyB,EAA2B;IACnG,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAC;IAC/C,MAAM,iBAAiB,IAAA,+MAAM,EAAmC;IAEhE,MAAM,mBAAmB,IAAA,oNAAW,EAAC;QACnC,MAAM,oBACJ,sCAAgC,0BAA6D;QAE/F,wCAAwB;YACtB,MAAM;YACN;QACF;;;QAUA,MAAM;QAGN,MAAM;QAiBN,MAAM;IAgCR,GAAG;QAAC;QAAa;QAAa;KAA0B;IAExD,OAAO;QACL;QACA;IACF;AACF"}},
    {"offset": {"line": 1499, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatMembers.ts"],"sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\r\n'use client';\r\n\r\nimport { useCallback, useEffect, useState } from 'react';\r\nimport type { User } from '@/types/User';\r\nimport type { ChatItem, GroupConversation, MemberInfo } from '@/types/Group';\r\n\r\ninterface UseChatMembersParams {\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  currentUser: User;\r\n  sendNotifyMessage: (text: string) => Promise<void>;\r\n}\r\n\r\nexport function useChatMembers({ selectedChat, isGroup, currentUser, sendNotifyMessage }: UseChatMembersParams) {\r\n  const [memberCount, setMemberCount] = useState(0);\r\n  const [activeMembers, setActiveMembers] = useState<MemberInfo[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (isGroup && (selectedChat as GroupConversation).members) {\r\n      const m = (selectedChat as GroupConversation).members as MemberInfo[];\r\n      setActiveMembers(m);\r\n      setMemberCount(m.length);\r\n    } else {\r\n      setActiveMembers([]);\r\n      setMemberCount(0);\r\n    }\r\n  }, [selectedChat, isGroup]);\r\n\r\n  const handleMemberRemoved = useCallback(\r\n    async (removedMemberId: string, removedMemberName: string) => {\r\n      setActiveMembers((prev) => prev.filter((m) => String(m._id) !== String(removedMemberId)));\r\n      setMemberCount((prev) => Math.max(0, prev - 1));\r\n\r\n      const myName = currentUser.name || 'Qu·∫£n tr·ªã vi√™n';\r\n      await sendNotifyMessage(`${myName} ƒë√£ m·ªùi ${removedMemberName} ra kh·ªèi nh√≥m.`);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  const handleRoleChange = useCallback(\r\n    async (memberId: string, memberName: string, newRole: 'ADMIN' | 'MEMBER') => {\r\n      setActiveMembers((prev) =>\r\n        prev.map((m) => {\r\n          if (String(m._id) === String(memberId)) {\r\n            return { ...m, role: newRole };\r\n          }\r\n          return m;\r\n        }),\r\n      );\r\n\r\n      const myName = currentUser.name || 'Qu·∫£n tr·ªã vi√™n';\r\n      let actionText = '';\r\n\r\n      if (newRole === 'ADMIN') {\r\n        actionText = `ƒë√£ b·ªï nhi·ªám ${memberName} l√†m ph√≥ nh√≥m.`;\r\n      } else {\r\n        actionText = `ƒë√£ h·ªßy quy·ªÅn ph√≥ nh√≥m c·ªßa ${memberName}.`;\r\n      }\r\n\r\n      await sendNotifyMessage(`${myName} ${actionText}`);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  const handleMembersAdded = useCallback(\r\n    async (newUsers: User[]) => {\r\n      if (!newUsers || newUsers.length === 0) return;\r\n\r\n      const newMembersFormatted: MemberInfo[] = newUsers.map((u) => ({\r\n        _id: u._id,\r\n        name: u.name || 'Th√†nh vi√™n',\r\n        avatar: u.avatar,\r\n        role: 'MEMBER',\r\n        joinedAt: Date.now(),\r\n      }));\r\n\r\n      setActiveMembers((prev) => [...prev, ...newMembersFormatted]);\r\n      setMemberCount((prev) => prev + newUsers.length);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  return {\r\n    memberCount,\r\n    activeMembers,\r\n    handleMemberRemoved,\r\n    handleRoleChange,\r\n    handleMembersAdded,\r\n  };\r\n}\r\n"],"names":[],"mappings":"AAAA,8CAA8C;;;;AAG9C;AAFA;;AAaO,SAAS,eAAe,EAAE,YAAY,EAAE,OAAO,EAAE,WAAW,EAAE,iBAAiB,EAAwB;IAC5G,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAC;IAC/C,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAe,EAAE;IAEnE,IAAA,kNAAS,EAAC;QACR,IAAI,WAAW,AAAC,aAAmC,OAAO,EAAE;YAC1D,MAAM,IAAI,AAAC,aAAmC,OAAO;YACrD,iBAAiB;YACjB,eAAe,EAAE,MAAM;QACzB,OAAO;YACL,iBAAiB,EAAE;YACnB,eAAe;QACjB;IACF,GAAG;QAAC;QAAc;KAAQ;IAE1B,MAAM,sBAAsB,IAAA,oNAAW,EACrC,OAAO,iBAAyB;QAC9B,iBAAiB,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO;QACvE,eAAe,CAAC,OAAS,KAAK,GAAG,CAAC,GAAG,OAAO;QAE5C,MAAM,SAAS,YAAY,IAAI,IAAI;QACnC,MAAM,kBAAkB,GAAG,OAAO,QAAQ,EAAE,kBAAkB,cAAc,CAAC;IAC/E,GACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,MAAM,mBAAmB,IAAA,oNAAW,EAClC,OAAO,UAAkB,YAAoB;QAC3C,iBAAiB,CAAC,OAChB,KAAK,GAAG,CAAC,CAAC;gBACR,IAAI,OAAO,EAAE,GAAG,MAAM,OAAO,WAAW;oBACtC,OAAO;wBAAE,GAAG,CAAC;wBAAE,MAAM;oBAAQ;gBAC/B;gBACA,OAAO;YACT;QAGF,MAAM,SAAS,YAAY,IAAI,IAAI;QACnC,IAAI,aAAa;QAEjB,IAAI,YAAY,SAAS;YACvB,aAAa,CAAC,YAAY,EAAE,WAAW,cAAc,CAAC;QACxD,OAAO;YACL,aAAa,CAAC,0BAA0B,EAAE,WAAW,CAAC,CAAC;QACzD;QAEA,MAAM,kBAAkB,GAAG,OAAO,CAAC,EAAE,YAAY;IACnD,GACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,MAAM,qBAAqB,IAAA,oNAAW,EACpC,OAAO;QACL,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;QAExC,MAAM,sBAAoC,SAAS,GAAG,CAAC,CAAC,IAAM,CAAC;gBAC7D,KAAK,EAAE,GAAG;gBACV,MAAM,EAAE,IAAI,IAAI;gBAChB,QAAQ,EAAE,MAAM;gBAChB,MAAM;gBACN,UAAU,KAAK,GAAG;YACpB,CAAC;QAED,iBAAiB,CAAC,OAAS;mBAAI;mBAAS;aAAoB;QAC5D,eAAe,CAAC,OAAS,OAAO,SAAS,MAAM;IACjD,GACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,OAAO;QACL;QACA;QACA;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 1583, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useHomePage.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport io, { type Socket } from 'socket.io-client';\r\n\r\nimport { User } from '@/types/User';\r\nimport { ChatItem, GroupConversation } from '@/types/Group';\r\nimport type { Message } from '@/types/Message';\r\n\r\ndeclare global {\r\n  interface Window {\r\n    __globalReminderSchedulerActive?: boolean;\r\n  }\r\n}\r\nimport type { GlobalSearchMessage, GlobalSearchContact } from '@/components/(home)/HomeOverlays'; // C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n n·∫øu c·∫ßn // C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n n·∫øu c·∫ßn\r\n\r\n// Ki·ªÉu d·ªØ li·ªáu cho b·∫£n ghi tin nh·∫Øn tr·∫£ v·ªÅ t·ª´ API globalSearch\r\ninterface GlobalSearchMessageApi {\r\n  _id: string;\r\n  content: string;\r\n  type: string;\r\n  fileName?: string;\r\n  timestamp: number;\r\n  sender: string;\r\n  senderName?: string;\r\n  roomId: string;\r\n  roomName?: string;\r\n  isGroupChat?: boolean;\r\n  partnerId?: string;\r\n  partnerName?: string;\r\n  fileUrl?: string;\r\n  receiver?: string;\r\n  displayRoomName?: string;\r\n}\r\n\r\nimport { resolveSocketUrl, normalizeNoAccent } from '@/utils/utils';\r\nimport { useChatNotifications } from '@/hooks/useChatNotifications';\r\n\r\nexport function useHomePage(config?: { onlyGroups?: boolean; onlyPersonal?: boolean }) {\r\n  const router = useRouter();\r\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { playMessageSound } = useChatNotifications({});\r\n\r\n  // State qu·∫£n l√Ω d·ªØ li·ªáu\r\n  const [allUsers, setAllUsers] = useState<User[]>([]);\r\n  const allUsersRef = useRef<User[]>([]);\r\n  const [groups, setGroups] = useState<GroupConversation[]>([]);\r\n  const [selectedChat, setSelectedChat] = useState<ChatItem | null>(null);\r\n  const selectedChatRef = useRef<ChatItem | null>(null);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [showCreateGroupModal, setShowCreateGroupModal] = useState(false);\r\n  const socketRef = useRef<Socket | null>(null);\r\n\r\n  const [showGlobalSearchModal, setShowGlobalSearchModal] = useState(false);\r\n  const [globalSearchTerm, setGlobalSearchTerm] = useState('');\r\n  const [globalSearchResults, setGlobalSearchResults] = useState<{\r\n    contacts: GlobalSearchContact[];\r\n    messages: GlobalSearchMessage[];\r\n  }>({\r\n    contacts: [],\r\n    messages: [],\r\n  });\r\n\r\n  const [scrollToMessageId, setScrollToMessageId] = useState<string | null>(null);\r\n  const [roomSearchKeyword, setRoomSearchKeyword] = useState<string | null>(null);\r\n  const reminderTimersRef = useRef<Map<string, number>>(new Map());\r\n  const scheduledReminderIdsRef = useRef<Set<string>>(new Set());\r\n\r\n  // üî• ƒê·ªìng b·ªô searchTerm t·ª´ sidebar sang globalSearchTerm\r\n  useEffect(() => {\r\n    setGlobalSearchTerm(searchTerm);\r\n  }, [searchTerm]);\r\n\r\n  useEffect(() => {\r\n    allUsersRef.current = allUsers;\r\n  }, [allUsers]);\r\n\r\n  // 1. H√†m Fetch Data (User & Group)\r\n  const fetchAllData = useCallback(async () => {\r\n    if (!currentUser) return;\r\n\r\n    // Fetch Users\r\n    try {\r\n      const res = await fetch('/api/users', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: 'read', currentUserId: currentUser._id }),\r\n      });\r\n      const data = await res.json();\r\n      const list = Array.isArray(data) ? data : data.data || [];\r\n      setAllUsers(list.filter((u: User) => u._id !== currentUser._id));\r\n    } catch (e) {\r\n      console.error('Fetch users error:', e);\r\n    }\r\n\r\n    // Fetch Groups\r\n    try {\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: 'readGroups', _id: currentUser._id }),\r\n      });\r\n      const data = await res.json();\r\n\r\n      if (data.data) {\r\n        setGroups(data.data);\r\n\r\n        // ƒê·ªìng b·ªô l·∫°i selectedChat (n·∫øu ƒëang m·ªü 1 group) v·ªõi d·ªØ li·ªáu m·ªõi nh·∫•t\r\n        setSelectedChat((prev) => {\r\n          if (!prev) return prev;\r\n\r\n          // Ch·ªâ √°p d·ª•ng cho nh√≥m, chat 1-1 s·∫Ω kh√¥ng c√≥ trong danh s√°ch groups\r\n          const maybeGroup = prev as GroupConversation;\r\n          const isGroupChat = maybeGroup.isGroup === true || Array.isArray(maybeGroup.members);\r\n          if (!isGroupChat) return prev;\r\n\r\n          const updated = data.data.find((g: GroupConversation) => g._id === maybeGroup._id);\r\n          // N·∫øu kh√¥ng t√¨m th·∫•y nh√≥m trong danh s√°ch m·ªõi (c√≥ th·ªÉ ƒë√£ b·ªã gi·∫£i t√°n), x√≥a selectedChat\r\n          if (!updated) {\r\n            return null;\r\n          }\r\n          return updated;\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Fetch groups error:', e);\r\n    }\r\n  }, [currentUser]);\r\n\r\n  // H√†m x·ª≠ l√Ω ch·ªçn Chat (Optimistic Update - X√≥a badge)\n  const handleSelectChat = useCallback((item: ChatItem) => {\n    setSelectedChat(item);\n    selectedChatRef.current = item;\n\n    if ((item as GroupConversation).isGroup || (item as GroupConversation).members) {\n      setGroups((prev) => prev.map((g) => (g._id === item._id ? { ...g, unreadCount: 0 } : g)));\n    } else {\n      setAllUsers((prev) => prev.map((u) => (u._id === item._id ? { ...u, unreadCount: 0 } : u)));\n    }\n  }, []);\n\n  useEffect(() => {\n    const handler = (e: Event) => {\n      const d = (e as CustomEvent).detail || {};\n      const userId = String(d.userId || d._id || '');\n      if (!userId) return;\n\n      const found = allUsersRef.current.find((u) => String(u._id) === userId) || null;\n      const name = typeof d.name === 'string' ? d.name : found?.name || found?.username || 'Ng∆∞·ªùi d√πng';\n      const username = typeof d.username === 'string' ? d.username : found?.username || '';\n      const avatar = typeof d.avatar === 'string' ? d.avatar : found?.avatar;\n\n      if (found) {\n        handleSelectChat(found);\n        return;\n      }\n\n      const fallbackUser: User = {\n        _id: userId,\n        name: String(name || 'Ng∆∞·ªùi d√πng'),\n        username: String(username || userId),\n      };\n      if (avatar) fallbackUser.avatar = String(avatar);\n      handleSelectChat(fallbackUser);\n    };\n\n    window.addEventListener('openDirectChat', handler as EventListener);\n    return () => window.removeEventListener('openDirectChat', handler as EventListener);\n  }, [handleSelectChat]);\n\n  const handleSelectContact = useCallback(\n    (contact: GlobalSearchContact) => {\n      setShowGlobalSearchModal(false);\n      setScrollToMessageId(null);\n\r\n      // T√¨m contact ƒë·∫ßy ƒë·ªß t·ª´ allUsers ho·∫∑c groups\r\n      let fullContact: ChatItem | null = null;\r\n      if (contact.isGroup) {\r\n        fullContact = groups.find((g) => g._id === contact._id) ?? null;\r\n      } else {\r\n        fullContact = allUsers.find((u) => u._id === contact._id) ?? null;\r\n      }\r\n\r\n      if (fullContact) {\r\n        // Ch·ªçn chat b·∫±ng h√†m ƒë√£ t·ªëi ∆∞u\r\n        handleSelectChat(fullContact);\r\n      } else {\r\n        console.warn('Contact not found:', contact._id);\r\n      }\r\n    },\r\n    [groups, allUsers, handleSelectChat],\r\n  );\r\n\r\n  const handleGlobalSearch = useCallback(\r\n    async (term: string) => {\r\n      setGlobalSearchTerm(term);\r\n\r\n      if (!term.trim() || !currentUser) {\r\n        setGlobalSearchResults({ contacts: [], messages: [] });\r\n        return;\r\n      }\r\n\r\n      const lowerCaseTerm = normalizeNoAccent(term);\r\n\r\n      // 1. L·ªçc li√™n h·ªá/nh√≥m (Local - Instant)\r\n      let allChats = [...groups, ...allUsers];\r\n      if (config?.onlyGroups) {\r\n        allChats = [...groups];\r\n      } else if (config?.onlyPersonal) {\r\n        allChats = [...allUsers];\r\n      }\r\n\r\n      const myId = String(currentUser._id);\r\n      const contactResults: GlobalSearchContact[] = allChats\r\n        .map((c) => {\r\n          const isGroup = (c as GroupConversation).isGroup || !!(c as GroupConversation).members;\r\n          let displayName = String(c.name || '').trim();\r\n          if (!isGroup) {\r\n            const u = c as User;\r\n            if (u.nicknames?.[myId]) {\r\n              displayName = String(u.nicknames[myId]).trim() || displayName || String(u.username || 'Ng∆∞·ªùi d√πng');\r\n            } else {\r\n              displayName = String(u.name || u.username || 'Ng∆∞·ªùi d√πng').trim();\r\n            }\r\n          }\r\n          return { contact: c, isGroup, displayName };\r\n        })\r\n        .filter(({ contact, displayName }) => {\r\n          if (contact.isHidden) return false;\r\n          return normalizeNoAccent(displayName).includes(lowerCaseTerm);\r\n        })\r\n        .map(({ contact, isGroup, displayName }) => ({\r\n          _id: contact._id,\r\n          name: displayName,\r\n          avatar: contact.avatar,\r\n          isGroup,\r\n        }))\r\n        .slice(0, 10); // Gi·ªõi h·∫°n 10 k·∫øt qu·∫£\r\n\r\n      // 2. G·ªçi API t√¨m ki·∫øm tin nh·∫Øn (Backend)\r\n      try {\r\n        const res = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            action: 'globalSearch',\r\n            data: {\r\n              userId: currentUser._id,\r\n              searchTerm: term,\r\n              limit: 50,\r\n            },\r\n          }),\r\n        });\r\n\r\n        const messageData = await res.json();\r\n        const allMessages = (messageData.data || []) as GlobalSearchMessageApi[];\r\n\r\n        const messages: GlobalSearchMessage[] = allMessages\r\n          .filter((msg: GlobalSearchMessageApi) =>\r\n            ['text', 'image', 'file', 'sticker', 'video', 'reminder'].includes(msg.type),\r\n          )\r\n          .filter((msg) => !config?.onlyGroups || msg.isGroupChat)\r\n          .map((msg: GlobalSearchMessageApi) => ({\r\n            _id: msg._id,\r\n            content: msg.content,\r\n            type: msg.type as 'text' | 'image' | 'file' | 'sticker' | 'video' | 'reminder',\r\n            fileName: msg.fileName,\r\n            timestamp: msg.timestamp,\r\n            sender: msg.sender,\r\n            senderName: msg.senderName || '',\r\n            roomId: msg.roomId,\r\n            roomName: msg.roomName || '',\r\n            isGroupChat: msg.isGroupChat || false,\r\n            partnerId: msg.partnerId,\r\n            partnerName: msg.partnerName,\r\n            fileUrl: msg.fileUrl,\r\n            receiver: msg.receiver,\r\n            displayRoomName: msg.displayRoomName,\r\n          }));\r\n\r\n        setGlobalSearchResults({\r\n          contacts: contactResults,\r\n          messages,\r\n        });\r\n      } catch (e) {\r\n        console.error('Global search API error:', e);\r\n        setGlobalSearchResults({ contacts: contactResults, messages: [] });\r\n      }\r\n    },\r\n    [currentUser, groups, allUsers, config?.onlyGroups, config?.onlyPersonal],\r\n  );\r\n\r\n  const getSocketBaseForRoom = useCallback(\r\n    (roomId: string) => {\r\n      const isGroupChat = groups.some((g) => String(g._id) === String(roomId));\r\n      if (isGroupChat) {\r\n        const g = groups.find((x) => String(x._id) === String(roomId)) as GroupConversation | undefined;\r\n        const members = g ? g.members : [];\r\n        return {\r\n          roomId,\r\n          sender: String(currentUser?._id || ''),\r\n          senderName: currentUser?.name || '',\r\n          isGroup: true,\r\n          receiver: null,\r\n          members,\r\n        };\r\n      }\r\n      let receiver: string | null = null;\r\n      if (roomId.includes('_')) {\r\n        const parts = roomId.split('_');\r\n        receiver = parts[0] === String(currentUser?._id || '') ? parts[1] : parts[0];\r\n      }\r\n      return {\r\n        roomId,\r\n        sender: String(currentUser?._id || ''),\r\n        senderName: currentUser?.name || '',\r\n        isGroup: false,\r\n        receiver,\r\n        members: [],\r\n      };\r\n    },\r\n    [groups, currentUser],\r\n  );\r\n\r\n  const scheduleReminder = useCallback(\r\n    (msg: Message) => {\r\n      const idStr = String(msg._id);\r\n      if (scheduledReminderIdsRef.current.has(idStr)) return;\r\n      const at = (msg as Message & { reminderAt?: number }).reminderAt || msg.timestamp;\r\n      const now = Date.now();\r\n      const delay = Math.max(0, at - now);\r\n      scheduledReminderIdsRef.current.add(idStr);\r\n      const timerId = window.setTimeout(async () => {\r\n        try {\r\n          const res = await fetch('/api/messages', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              action: 'fireReminder',\r\n              messageId: msg._id,\r\n              userId: String(currentUser?._id || ''),\r\n            }),\r\n          });\r\n          const json = await res.json();\r\n          const sockBase = getSocketBaseForRoom(String(msg.roomId));\r\n          if (json?.success && json?.updated && typeof json?.notifyId === 'string') {\r\n            socketRef.current?.emit('send_message', {\r\n              ...sockBase,\r\n              _id: json.notifyId,\r\n              type: 'notify',\r\n              content: `ƒê·∫øn gi·ªù l·ªãch h·∫πn: \"${msg.content || ''}\"`,\r\n              timestamp: Date.now(),\r\n              replyToMessageId: String(msg._id),\r\n            });\r\n          }\r\n          if (json?.nextAt) {\r\n            socketRef.current?.emit('edit_message', {\r\n              _id: msg._id,\r\n              roomId: msg.roomId,\r\n              content: msg.content,\r\n              newContent: msg.content,\r\n              editedAt: Date.now(),\r\n              originalContent: msg.originalContent || msg.content,\r\n              reminderAt: json.nextAt,\r\n              reminderNote: (msg as Message & { reminderNote?: string }).reminderNote,\r\n            });\r\n          }\r\n        } catch {}\r\n        scheduledReminderIdsRef.current.delete(idStr);\r\n        const t = reminderTimersRef.current.get(idStr);\r\n        if (t) reminderTimersRef.current.delete(idStr);\r\n      }, delay);\r\n      reminderTimersRef.current.set(idStr, timerId);\r\n    },\r\n    [currentUser, getSocketBaseForRoom],\r\n  );\r\n\r\n  const fetchAndScheduleReminders = useCallback(async () => {\r\n    if (!currentUser) return;\r\n    try {\r\n      const res = await fetch('/api/messages', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'readReminders',\r\n          data: { userId: currentUser._id, limit: 5000, untilTs: Date.now() + 30 * 24 * 60 * 60 * 1000 },\r\n        }),\r\n      });\r\n      const json = await res.json();\r\n      const items: Message[] = Array.isArray(json?.data) ? (json.data as Message[]) : [];\r\n      items.forEach((m) => scheduleReminder(m));\r\n    } catch {}\r\n  }, [currentUser, scheduleReminder]);\r\n\r\n  useEffect(() => {\r\n    if (!currentUser) return;\r\n    if (typeof window !== 'undefined') {\r\n      window.__globalReminderSchedulerActive = true;\r\n    }\r\n    void fetchAndScheduleReminders();\r\n    const iv = setInterval(() => void fetchAndScheduleReminders(), 60000);\r\n    return () => {\r\n      clearInterval(iv);\r\n      if (typeof window !== 'undefined') {\r\n        window.__globalReminderSchedulerActive = false;\r\n      }\r\n    };\r\n  }, [currentUser, fetchAndScheduleReminders]);\r\n\r\n  // üî• H√ÄM M·ªû / ƒê√ìNG MODAL T√åM KI·∫æM TO√ÄN C·ª§C (TOGGLE)\r\n  const handleOpenGlobalSearch = useCallback(() => {\r\n    setShowGlobalSearchModal((prev) => {\r\n      const next = !prev;\r\n      if (next) {\r\n        // Khi m·ªü modal, sync searchTerm t·ª´ sidebar sang globalSearchTerm n·∫øu c√≥\r\n        // Ch·ªâ reset n·∫øu kh√¥ng c√≥ searchTerm t·ª´ sidebar\r\n        if (!searchTerm.trim()) {\r\n          setGlobalSearchTerm('');\r\n          setGlobalSearchResults({ contacts: [], messages: [] });\r\n        } else {\r\n          // N·∫øu c√≥ searchTerm t·ª´ sidebar, sync v√† trigger search\r\n          setGlobalSearchTerm(searchTerm);\r\n          handleGlobalSearch(searchTerm);\r\n        }\r\n      }\r\n      return next;\r\n    });\r\n  }, [searchTerm, handleGlobalSearch]);\r\n\r\n  // Thay th·∫ø h√†m handleNavigateToMessage trong useHomePage.ts\r\n  const handleNavigateToMessage = useCallback(\r\n    (message: GlobalSearchMessage, searchKeyword?: string) => {\r\n      let targetChat: ChatItem | null = null;\r\n      const myId = String(currentUser?._id);\r\n\r\n      // 1. T√¨m chat target\r\n      if (message.isGroupChat === true && message.roomId) {\r\n        targetChat = groups.find((g) => String(g._id) === String(message.roomId)) ?? null;\r\n      } else if (message.isGroupChat === false) {\r\n        let partnerId: string | null = null;\r\n        if (message.partnerId) {\r\n          partnerId = String(message.partnerId);\r\n        } else if (message.roomId && message.roomId.includes('_')) {\r\n          const parts = message.roomId.split('_');\r\n          partnerId = parts[0] === myId ? parts[1] : parts[0];\r\n        } else {\r\n          const senderId = String(message.sender);\r\n          const receiverId = message.receiver ? String(message.receiver) : null;\r\n          partnerId = senderId === myId ? receiverId : senderId;\r\n        }\r\n\r\n        if (partnerId) {\r\n          targetChat = allUsers.find((u) => String(u._id) === partnerId) ?? null;\r\n        }\r\n      }\r\n\r\n      // 2. N·∫øu t√¨m th·∫•y chat, m·ªü v√† cu·ªôn ƒë·∫øn ƒë√∫ng tin nh·∫Øn v·ª´a ch·ªçn\r\n      if (targetChat) {\r\n        setShowGlobalSearchModal(false);\r\n        handleSelectChat(targetChat);\r\n\r\n        if (searchKeyword && searchKeyword.trim()) {\r\n          setRoomSearchKeyword(searchKeyword);\r\n        }\r\n        setTimeout(() => {\r\n          setScrollToMessageId(String(message._id));\r\n        }, 200);\r\n      } else {\r\n        // Fallback: Refetch data v√† th·ª≠ l·∫°i\r\n        console.warn('‚ùå Chat not found locally. Refetching data...');\r\n        fetchAllData().then(() => {\r\n          alert('Kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán. ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu, vui l√≤ng th·ª≠ l·∫°i.');\r\n        });\r\n      }\r\n    },\r\n    [groups, allUsers, currentUser, fetchAllData, handleSelectChat],\r\n  );\r\n\r\n  useEffect(() => {\r\n    const fetchCurrentUser = async () => {\r\n      setIsLoading(true);\r\n      try {\r\n        const user = JSON.parse(localStorage.getItem('info_user') || '{}');\r\n        if (user && user._id) {\r\n          setCurrentUser(user);\r\n        } else {\r\n          router.push('/');\r\n        }\r\n      } catch {\r\n        router.push('/');\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n    fetchCurrentUser();\r\n\r\n    const onStorage = (e: StorageEvent) => {\r\n      if (e.key === 'info_user') {\r\n        try {\r\n          const next = e.newValue ? JSON.parse(e.newValue) : null;\r\n          if (next && next._id) {\r\n            setCurrentUser(next);\r\n          }\r\n        } catch {}\r\n      }\r\n    };\r\n    window.addEventListener('storage', onStorage);\r\n    return () => {\r\n      window.removeEventListener('storage', onStorage);\r\n    };\r\n  }, [router]);\r\n\r\n  // 3. G·ªçi Fetch Data l·∫ßn ƒë·∫ßu\r\n  useEffect(() => {\r\n    if (currentUser) fetchAllData();\r\n  }, [currentUser, fetchAllData]);\r\n\r\n  // 4. K·∫øt n·ªëi Socket & X·ª≠ l√Ω Realtime Sidebar\r\n  useEffect(() => {\r\n    selectedChatRef.current = selectedChat;\r\n  }, [selectedChat]);\r\n\r\n  // 4. K·∫øt n·ªëi Socket & X·ª≠ l√Ω Realtime Sidebar\r\n  useEffect(() => {\r\n    if (!currentUser) return;\r\n    const endpoint = resolveSocketUrl();\r\n    socketRef.current = io(endpoint, { transports: ['websocket'], withCredentials: false });\r\n    socketRef.current.emit('join_room', currentUser._id);\r\n    socketRef.current.emit('user_online', { userId: currentUser._id });\r\n    const HEARTBEAT_MS = 60000; // 1 ph√∫t\r\n    const hb = setInterval(() => {\r\n      try {\r\n        socketRef.current?.emit('heartbeat', { userId: currentUser._id });\r\n      } catch {}\r\n    }, HEARTBEAT_MS);\r\n\r\n    socketRef.current.on(\r\n      'presence_update',\r\n      (payload: { userId: string; online: boolean; lastSeen?: number | null }) => {\r\n        setAllUsers((prev) =>\r\n          prev.map((u) =>\r\n            String(u._id) === String(payload.userId)\r\n              ? { ...u, online: payload.online, lastSeen: payload.lastSeen ?? u.lastSeen }\r\n              : u,\r\n          ),\r\n        );\r\n      },\r\n    );\r\n\r\n    const handleBeforeUnload = () => {\r\n      try {\r\n        socketRef.current?.emit('heartbeat', { userId: currentUser._id });\r\n      } catch {}\r\n    };\r\n    window.addEventListener('beforeunload', handleBeforeUnload);\r\n\r\n    socketRef.current.on(\r\n      'update_sidebar',\r\n      (data: {\r\n        sender: string;\r\n        receiver?: string;\r\n        roomId: string;\r\n        type: string;\r\n        content?: string;\r\n        isRecalled?: boolean;\r\n        lastMessage?: string;\r\n        timestamp?: number;\r\n        senderName?: string;\r\n        isGroup: boolean;\r\n        members?: (string | { _id: string })[];\r\n        groupName?: string;\r\n      }) => {\r\n        const isMyMsg = data.sender === currentUser._id;\r\n        const activeChatId = selectedChatRef.current?._id || null;\r\n\r\n        // 1. X√°c ƒë·ªãnh t√™n ng∆∞·ªùi g·ª≠i\r\n        let senderName = 'Ng∆∞·ªùi l·∫°';\r\n        if (isMyMsg) {\r\n          senderName = 'B·∫°n';\r\n        } else {\r\n          const foundUser = allUsersRef.current.find((u) => u._id === data.sender);\r\n          if (foundUser) senderName = foundUser.name || 'Ng∆∞·ªùi l·∫°';\r\n          if (data.senderName) senderName = data.senderName;\r\n        }\r\n\r\n        // 2. üî• Format n·ªôi dung tin nh·∫Øn - ∆Øu ti√™n lastMessage n·∫øu c√≥\r\n        let contentDisplay = '';\r\n\r\n        // N·∫øu server ƒë√£ g·ª≠i k√®m lastMessage (ƒë√£ format s·∫µn), d√πng lu√¥n, tr·ª´ khi l√† recall ƒë·ªÉ t·ª± ch√®n prefix\r\n        if (data.lastMessage && !data.isRecalled && data.type !== 'recall') {\r\n          contentDisplay = data.lastMessage;\r\n        }\r\n        // Thu h·ªìi: hi·ªÉn th·ªã k√®m ng∆∞·ªùi thu h·ªìi (1-1 v√† nh√≥m), \"B·∫°n\" n·∫øu l√† m√¨nh\r\n        else if (data.isRecalled || data.type === 'recall') {\r\n          contentDisplay = data.isGroup\r\n            ? isMyMsg\r\n              ? 'B·∫°n: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi'\r\n              : `${senderName}: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi`\r\n            : 'Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi';\r\n        }\r\n        // N·∫øu l√† tin nh·∫Øn text b√¨nh th∆∞·ªùng\r\n        else {\r\n          const isTextLike = data.type === 'text' || data.type === 'notify';\r\n          const rawContent = isTextLike ? data.content || '' : `[${data.type || 'Unknown'}]`;\r\n          contentDisplay = `${senderName}: ${rawContent}`;\r\n        }\r\n        const isMsgType =\r\n          data.type === 'text' ||\r\n          data.type === 'image' ||\r\n          data.type === 'file' ||\r\n          data.type === 'sticker' ||\r\n          data.type === 'video' ||\r\n          data.type === 'notify';\r\n        const soundEnabled =\r\n          (currentUser as unknown as { notifications?: { soundEnabled?: boolean } })?.notifications?.soundEnabled !==\r\n          false;\r\n        if (!isMyMsg && isMsgType && soundEnabled) {\r\n          playMessageSound();\r\n        }\r\n        // 3. C·∫¨P NH·∫¨T STATE\r\n        if (data.isGroup) {\r\n          setGroups((prev) => {\r\n            const index = prev.findIndex((g) => g._id === data.roomId);\r\n            if (index === -1) {\r\n              const myId = String(currentUser._id);\r\n              const memberIds = Array.isArray(data.members)\r\n                ? data.members.map((m) => (typeof m === 'object' && m?._id ? String(m._id) : String(m))).filter(Boolean)\r\n                : [];\r\n              const iAmMember = memberIds.includes(myId);\r\n              if (iAmMember) {\r\n                const stubMembers = Array.isArray(data.members)\r\n                  ? data.members.map((m) =>\r\n                      typeof m === 'object' && m?._id\r\n                        ? { _id: String(m._id), role: 'MEMBER', joinedAt: Date.now() }\r\n                        : { _id: String(m), role: 'MEMBER', joinedAt: Date.now() },\r\n                    )\r\n                  : [];\r\n                const stubGroup: GroupConversation = {\r\n                  _id: String(data.roomId),\r\n                  name: (data.groupName || data.senderName || 'Nh√≥m').trim() || 'Nh√≥m',\r\n                  isGroup: true,\r\n                  members: stubMembers,\r\n                  createdBy: String(data.sender || ''),\r\n                  unreadCount: 0,\r\n                  lastMessage: contentDisplay,\r\n                  lastMessageAt: data.timestamp || Date.now(),\r\n                } as GroupConversation;\r\n                const next = [stubGroup, ...prev];\r\n                setTimeout(() => fetchAllData(), 200);\r\n                return next;\r\n              }\r\n              fetchAllData();\r\n              return prev;\r\n            }\r\n            const isActiveChat = activeChatId === data.roomId;\r\n\r\n            // --- X·ª¨ L√ù BI·ªÜT DANH (GROUP NICKNAME) ---\r\n            let displaySenderName = senderName;\r\n            if (!isMyMsg) {\r\n              const currentGroup = prev[index];\r\n              const senderMember = currentGroup.members?.find((m: import('@/types/Group').GroupMemberSchema | import('@/types/Group').MemberInfo | string) => {\r\n                const mId =\r\n                  typeof m === 'object' && m && '_id' in m ? String((m as import('@/types/Group').GroupMemberSchema)._id) : String(m);\r\n                return mId === String(data.sender);\r\n              });\r\n              // Ki·ªÉm tra nickname trong member\r\n              if (senderMember && typeof senderMember === 'object') {\r\n                const sm = senderMember as { _id: string; nickname?: string };\r\n                if (sm.nickname) {\r\n                  displaySenderName = sm.nickname;\r\n                }\r\n              }\r\n            }\r\n\r\n            // --- RE-FORMAT LAST MESSAGE N·∫æU C√ì BI·ªÜT DANH ---\r\n            let finalContentDisplay = contentDisplay;\r\n            // Ch·ªâ re-format n·∫øu kh√¥ng ph·∫£i l√† tin nh·∫Øn h·ªá th·ªëng (notify kh√¥ng ng∆∞·ªùi g·ª≠i) v√† kh√¥ng ph·∫£i tin nh·∫Øn c·ªßa m√¨nh\r\n            // N·∫øu l√† recall, c≈©ng c·∫ßn x·ª≠ l√Ω\r\n            if (!isMyMsg) {\r\n              const isTextLike = data.type === 'text' || data.type === 'notify';\r\n              const rawContent = data.content || '';\r\n\r\n              if (data.isRecalled || data.type === 'recall') {\r\n                finalContentDisplay = `${displaySenderName}: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi`;\r\n              } else if (isTextLike) {\r\n                finalContentDisplay = `${displaySenderName}: ${rawContent}`;\r\n              } else {\r\n                // Image, file, sticker, etc.\r\n                const typeLabel = data.type ? `[${data.type}]` : '[Tin nh·∫Øn]';\r\n                finalContentDisplay = `${displaySenderName}: ${typeLabel}`;\r\n              }\r\n            }\r\n\r\n            const updatedGroup = {\r\n              ...prev[index],\r\n              lastMessage: finalContentDisplay,\r\n              lastMessageAt: data.timestamp || Date.now(),\r\n              isRecall: data.isRecalled || false,\r\n              unreadCount: isMyMsg || isActiveChat ? 0 : (prev[index].unreadCount || 0) + 1,\r\n            };\r\n            const newGroups = [...prev];\r\n            newGroups.splice(index, 1);\r\n            return [updatedGroup, ...newGroups];\r\n          });\r\n        } else {\r\n          // --- X·ª≠ l√Ω 1-1 (User List) ---\r\n          const partnerId = isMyMsg ? data.receiver : data.sender;\r\n          setAllUsers((prev) => {\r\n            const index = prev.findIndex((u) => u._id === partnerId);\r\n            if (index === -1) {\r\n              fetchAllData();\r\n              return prev;\r\n            }\r\n            const isActiveChat = activeChatId === partnerId;\r\n            const updatedUser = {\r\n              ...prev[index],\r\n              lastMessage: contentDisplay,\r\n              lastMessageAt: data.timestamp || Date.now(),\r\n              isRecall: data.isRecalled || false,\r\n              unreadCount: isMyMsg || isActiveChat ? 0 : (prev[index].unreadCount || 0) + 1,\r\n            };\r\n            const newUsers = [...prev];\r\n            newUsers.splice(index, 1);\r\n            return [updatedUser, ...newUsers];\r\n          });\r\n        }\r\n      },\r\n    );\r\n\r\n    socketRef.current.on('group_members_updated', (payload: { roomId: string; members: { _id: string }[] }) => {\r\n      const myId = String(currentUser._id);\r\n      const nextMemberIds = Array.isArray(payload.members)\r\n        ? payload.members.map((m) => String((m as { _id: string })._id))\r\n        : [];\r\n      const stillInGroup = nextMemberIds.includes(myId);\r\n      if (!stillInGroup) {\r\n        setGroups((prev) => prev.filter((g) => String(g._id) !== String(payload.roomId)));\r\n        if (selectedChatRef.current && String(selectedChatRef.current._id) === String(payload.roomId)) {\r\n          setSelectedChat(null);\r\n        }\r\n      }\r\n    });\r\n    socketRef.current.on('group_renamed', (payload: { roomId: string; groupName: string }) => {\r\n      setGroups((prev) =>\r\n        prev.map((g) => (String(g._id) === String(payload.roomId) ? { ...g, name: payload.groupName } : g)),\r\n      );\r\n      if (selectedChatRef.current && String(selectedChatRef.current._id) === String(payload.roomId)) {\r\n        setSelectedChat((prev) => (prev ? { ...prev, name: payload.groupName } : prev));\r\n      }\r\n    });\r\n    return () => {\r\n      try {\r\n        clearInterval(hb);\r\n      } catch {}\r\n      window.removeEventListener('beforeunload', handleBeforeUnload);\r\n      socketRef.current?.disconnect();\r\n    };\r\n  }, [currentUser, fetchAllData, playMessageSound]);\r\n\r\n  // 5. X·ª≠ l√Ω Chat Action (Pin/Hide)\r\n  const handleChatAction = useCallback(\r\n    async (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroupChat: boolean) => {\r\n      if (!currentUser?._id) return;\r\n\r\n      const apiRoute = isGroupChat ? '/api/groups' : '/api/users';\r\n\r\n      try {\r\n        const payload: {\r\n          action: 'toggleChatStatus';\r\n          _id: string;\r\n          currentUserId: string;\r\n          roomId: string;\r\n          conversationId: string;\r\n          data: { isPinned?: boolean; isHidden?: boolean };\r\n        } = {\r\n          action: 'toggleChatStatus',\r\n          _id: currentUser._id,\r\n          currentUserId: currentUser._id,\r\n          roomId,\r\n          conversationId: roomId,\r\n          data: actionType === 'pin' ? { isPinned: isChecked } : { isHidden: isChecked },\r\n        };\r\n\r\n        const res = await fetch(apiRoute, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(payload),\r\n        });\r\n\r\n        if (res.ok) {\r\n          if (isGroupChat) {\r\n            setGroups((prev) =>\r\n              prev.map((chat) => {\r\n                if (chat._id === roomId) {\r\n                  const updateField = actionType === 'pin' ? 'isPinned' : 'isHidden';\r\n                  return { ...chat, [updateField]: isChecked };\r\n                }\r\n                return chat;\r\n              }),\r\n            );\r\n          } else {\r\n            setAllUsers((prev) =>\r\n              prev.map((chat) => {\r\n                if (chat._id === roomId) {\r\n                  const updateField = actionType === 'pin' ? 'isPinned' : 'isHidden';\r\n                  return { ...chat, [updateField]: isChecked };\r\n                }\r\n                return chat;\r\n              }),\r\n            );\r\n          }\r\n\r\n          setTimeout(() => {\r\n            fetchAllData();\r\n          }, 500);\r\n        }\r\n      } catch (error) {\r\n        console.error(`L·ªói ${actionType} chat:`, error);\r\n      }\r\n    },\r\n    [currentUser, fetchAllData],\r\n  );\r\n\r\n  return {\r\n    currentUser,\r\n    isLoading,\r\n    allUsers,\r\n    groups,\r\n    selectedChat,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    showCreateGroupModal,\r\n    setShowCreateGroupModal,\r\n    showGlobalSearchModal,\r\n    globalSearchTerm,\r\n    globalSearchResults,\r\n    scrollToMessageId,\r\n    setScrollToMessageId,\r\n    roomSearchKeyword,\r\n    setRoomSearchKeyword,\r\n    handleOpenGlobalSearch,\r\n    handleGlobalSearch,\r\n    handleSelectContact,\r\n    handleNavigateToMessage,\r\n    fetchAllData,\r\n    handleChatAction,\r\n    handleSelectChat,\r\n    setSelectedChat,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AAgCA;AACA;AArCA;;;;;;AAuCO,SAAS,YAAY,MAAyD;IACnF,MAAM,SAAS,IAAA,+IAAS;IACxB,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAc;IAC5D,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,EAAE,gBAAgB,EAAE,GAAG,IAAA,4JAAoB,EAAC,CAAC;IAEnD,wBAAwB;IACxB,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAS,EAAE;IACnD,MAAM,cAAc,IAAA,+MAAM,EAAS,EAAE;IACrC,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAsB,EAAE;IAC5D,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,iNAAQ,EAAkB;IAClE,MAAM,kBAAkB,IAAA,+MAAM,EAAkB;IAChD,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAC7C,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,iNAAQ,EAAC;IACjE,MAAM,YAAY,IAAA,+MAAM,EAAgB;IAExC,MAAM,CAAC,uBAAuB,yBAAyB,GAAG,IAAA,iNAAQ,EAAC;IACnE,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,IAAA,iNAAQ,EAAC;IACzD,MAAM,CAAC,qBAAqB,uBAAuB,GAAG,IAAA,iNAAQ,EAG3D;QACD,UAAU,EAAE;QACZ,UAAU,EAAE;IACd;IAEA,MAAM,CAAC,mBAAmB,qBAAqB,GAAG,IAAA,iNAAQ,EAAgB;IAC1E,MAAM,CAAC,mBAAmB,qBAAqB,GAAG,IAAA,iNAAQ,EAAgB;IAC1E,MAAM,oBAAoB,IAAA,+MAAM,EAAsB,IAAI;IAC1D,MAAM,0BAA0B,IAAA,+MAAM,EAAc,IAAI;IAExD,yDAAyD;IACzD,IAAA,kNAAS,EAAC;QACR,oBAAoB;IACtB,GAAG;QAAC;KAAW;IAEf,IAAA,kNAAS,EAAC;QACR,YAAY,OAAO,GAAG;IACxB,GAAG;QAAC;KAAS;IAEb,mCAAmC;IACnC,MAAM,eAAe,IAAA,oNAAW,EAAC;QAC/B,IAAI,CAAC,aAAa;QAElB,cAAc;QACd,IAAI;YACF,MAAM,MAAM,MAAM,MAAM,cAAc;gBACpC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE,QAAQ;oBAAQ,eAAe,YAAY,GAAG;gBAAC;YACxE;YACA,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,MAAM,OAAO,MAAM,OAAO,CAAC,QAAQ,OAAO,KAAK,IAAI,IAAI,EAAE;YACzD,YAAY,KAAK,MAAM,CAAC,CAAC,IAAY,EAAE,GAAG,KAAK,YAAY,GAAG;QAChE,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC,sBAAsB;QACtC;QAEA,eAAe;QACf,IAAI;YACF,MAAM,MAAM,MAAM,MAAM,eAAe;gBACrC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE,QAAQ;oBAAc,KAAK,YAAY,GAAG;gBAAC;YACpE;YACA,MAAM,OAAO,MAAM,IAAI,IAAI;YAE3B,IAAI,KAAK,IAAI,EAAE;gBACb,UAAU,KAAK,IAAI;gBAEnB,sEAAsE;gBACtE,gBAAgB,CAAC;oBACf,IAAI,CAAC,MAAM,OAAO;oBAElB,oEAAoE;oBACpE,MAAM,aAAa;oBACnB,MAAM,cAAc,WAAW,OAAO,KAAK,QAAQ,MAAM,OAAO,CAAC,WAAW,OAAO;oBACnF,IAAI,CAAC,aAAa,OAAO;oBAEzB,MAAM,UAAU,KAAK,IAAI,CAAC,IAAI,CAAC,CAAC,IAAyB,EAAE,GAAG,KAAK,WAAW,GAAG;oBACjF,wFAAwF;oBACxF,IAAI,CAAC,SAAS;wBACZ,OAAO;oBACT;oBACA,OAAO;gBACT;YACF;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC,uBAAuB;QACvC;IACF,GAAG;QAAC;KAAY;IAEhB,sDAAsD;IACtD,MAAM,mBAAmB,IAAA,oNAAW,EAAC,CAAC;QACpC,gBAAgB;QAChB,gBAAgB,OAAO,GAAG;QAE1B,IAAI,AAAC,KAA2B,OAAO,IAAI,AAAC,KAA2B,OAAO,EAAE;YAC9E,UAAU,CAAC,OAAS,KAAK,GAAG,CAAC,CAAC,IAAO,EAAE,GAAG,KAAK,KAAK,GAAG,GAAG;wBAAE,GAAG,CAAC;wBAAE,aAAa;oBAAE,IAAI;QACvF,OAAO;YACL,YAAY,CAAC,OAAS,KAAK,GAAG,CAAC,CAAC,IAAO,EAAE,GAAG,KAAK,KAAK,GAAG,GAAG;wBAAE,GAAG,CAAC;wBAAE,aAAa;oBAAE,IAAI;QACzF;IACF,GAAG,EAAE;IAEL,IAAA,kNAAS,EAAC;QACR,MAAM,UAAU,CAAC;YACf,MAAM,IAAI,AAAC,EAAkB,MAAM,IAAI,CAAC;YACxC,MAAM,SAAS,OAAO,EAAE,MAAM,IAAI,EAAE,GAAG,IAAI;YAC3C,IAAI,CAAC,QAAQ;YAEb,MAAM,QAAQ,YAAY,OAAO,CAAC,IAAI,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,WAAW;YAC3E,MAAM,OAAO,OAAO,EAAE,IAAI,KAAK,WAAW,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,YAAY;YACrF,MAAM,WAAW,OAAO,EAAE,QAAQ,KAAK,WAAW,EAAE,QAAQ,GAAG,OAAO,YAAY;YAClF,MAAM,SAAS,OAAO,EAAE,MAAM,KAAK,WAAW,EAAE,MAAM,GAAG,OAAO;YAEhE,IAAI,OAAO;gBACT,iBAAiB;gBACjB;YACF;YAEA,MAAM,eAAqB;gBACzB,KAAK;gBACL,MAAM,OAAO,QAAQ;gBACrB,UAAU,OAAO,YAAY;YAC/B;YACA,IAAI,QAAQ,aAAa,MAAM,GAAG,OAAO;YACzC,iBAAiB;QACnB;QAEA,OAAO,gBAAgB,CAAC,kBAAkB;QAC1C,OAAO,IAAM,OAAO,mBAAmB,CAAC,kBAAkB;IAC5D,GAAG;QAAC;KAAiB;IAErB,MAAM,sBAAsB,IAAA,oNAAW,EACrC,CAAC;QACC,yBAAyB;QACzB,qBAAqB;QAErB,6CAA6C;QAC7C,IAAI,cAA+B;QACnC,IAAI,QAAQ,OAAO,EAAE;YACnB,cAAc,OAAO,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,QAAQ,GAAG,KAAK;QAC7D,OAAO;YACL,cAAc,SAAS,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,QAAQ,GAAG,KAAK;QAC/D;QAEA,IAAI,aAAa;YACf,+BAA+B;YAC/B,iBAAiB;QACnB,OAAO;YACL,QAAQ,IAAI,CAAC,sBAAsB,QAAQ,GAAG;QAChD;IACF,GACA;QAAC;QAAQ;QAAU;KAAiB;IAGtC,MAAM,qBAAqB,IAAA,oNAAW,EACpC,OAAO;QACL,oBAAoB;QAEpB,IAAI,CAAC,KAAK,IAAI,MAAM,CAAC,aAAa;YAChC,uBAAuB;gBAAE,UAAU,EAAE;gBAAE,UAAU,EAAE;YAAC;YACpD;QACF;QAEA,MAAM,gBAAgB,IAAA,0IAAiB,EAAC;QAExC,wCAAwC;QACxC,IAAI,WAAW;eAAI;eAAW;SAAS;QACvC,IAAI,QAAQ,YAAY;YACtB,WAAW;mBAAI;aAAO;QACxB,OAAO,IAAI,QAAQ,cAAc;YAC/B,WAAW;mBAAI;aAAS;QAC1B;QAEA,MAAM,OAAO,OAAO,YAAY,GAAG;QACnC,MAAM,iBAAwC,SAC3C,GAAG,CAAC,CAAC;YACJ,MAAM,UAAU,AAAC,EAAwB,OAAO,IAAI,CAAC,CAAC,AAAC,EAAwB,OAAO;YACtF,IAAI,cAAc,OAAO,EAAE,IAAI,IAAI,IAAI,IAAI;YAC3C,IAAI,CAAC,SAAS;gBACZ,MAAM,IAAI;gBACV,IAAI,EAAE,SAAS,EAAE,CAAC,KAAK,EAAE;oBACvB,cAAc,OAAO,EAAE,SAAS,CAAC,KAAK,EAAE,IAAI,MAAM,eAAe,OAAO,EAAE,QAAQ,IAAI;gBACxF,OAAO;oBACL,cAAc,OAAO,EAAE,IAAI,IAAI,EAAE,QAAQ,IAAI,cAAc,IAAI;gBACjE;YACF;YACA,OAAO;gBAAE,SAAS;gBAAG;gBAAS;YAAY;QAC5C,GACC,MAAM,CAAC,CAAC,EAAE,OAAO,EAAE,WAAW,EAAE;YAC/B,IAAI,QAAQ,QAAQ,EAAE,OAAO;YAC7B,OAAO,IAAA,0IAAiB,EAAC,aAAa,QAAQ,CAAC;QACjD,GACC,GAAG,CAAC,CAAC,EAAE,OAAO,EAAE,OAAO,EAAE,WAAW,EAAE,GAAK,CAAC;gBAC3C,KAAK,QAAQ,GAAG;gBAChB,MAAM;gBACN,QAAQ,QAAQ,MAAM;gBACtB;YACF,CAAC,GACA,KAAK,CAAC,GAAG,KAAK,sBAAsB;QAEvC,yCAAyC;QACzC,IAAI;YACF,MAAM,MAAM,MAAM,MAAM,iBAAiB;gBACvC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBACnB,QAAQ;oBACR,MAAM;wBACJ,QAAQ,YAAY,GAAG;wBACvB,YAAY;wBACZ,OAAO;oBACT;gBACF;YACF;YAEA,MAAM,cAAc,MAAM,IAAI,IAAI;YAClC,MAAM,cAAe,YAAY,IAAI,IAAI,EAAE;YAE3C,MAAM,WAAkC,YACrC,MAAM,CAAC,CAAC,MACP;oBAAC;oBAAQ;oBAAS;oBAAQ;oBAAW;oBAAS;iBAAW,CAAC,QAAQ,CAAC,IAAI,IAAI,GAE5E,MAAM,CAAC,CAAC,MAAQ,CAAC,QAAQ,cAAc,IAAI,WAAW,EACtD,GAAG,CAAC,CAAC,MAAgC,CAAC;oBACrC,KAAK,IAAI,GAAG;oBACZ,SAAS,IAAI,OAAO;oBACpB,MAAM,IAAI,IAAI;oBACd,UAAU,IAAI,QAAQ;oBACtB,WAAW,IAAI,SAAS;oBACxB,QAAQ,IAAI,MAAM;oBAClB,YAAY,IAAI,UAAU,IAAI;oBAC9B,QAAQ,IAAI,MAAM;oBAClB,UAAU,IAAI,QAAQ,IAAI;oBAC1B,aAAa,IAAI,WAAW,IAAI;oBAChC,WAAW,IAAI,SAAS;oBACxB,aAAa,IAAI,WAAW;oBAC5B,SAAS,IAAI,OAAO;oBACpB,UAAU,IAAI,QAAQ;oBACtB,iBAAiB,IAAI,eAAe;gBACtC,CAAC;YAEH,uBAAuB;gBACrB,UAAU;gBACV;YACF;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,uBAAuB;gBAAE,UAAU;gBAAgB,UAAU,EAAE;YAAC;QAClE;IACF,GACA;QAAC;QAAa;QAAQ;QAAU,QAAQ;QAAY,QAAQ;KAAa;IAG3E,MAAM,uBAAuB,IAAA,oNAAW,EACtC,CAAC;QACC,MAAM,cAAc,OAAO,IAAI,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO;QAChE,IAAI,aAAa;YACf,MAAM,IAAI,OAAO,IAAI,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO;YACtD,MAAM,UAAU,IAAI,EAAE,OAAO,GAAG,EAAE;YAClC,OAAO;gBACL;gBACA,QAAQ,OAAO,aAAa,OAAO;gBACnC,YAAY,aAAa,QAAQ;gBACjC,SAAS;gBACT,UAAU;gBACV;YACF;QACF;QACA,IAAI,WAA0B;QAC9B,IAAI,OAAO,QAAQ,CAAC,MAAM;YACxB,MAAM,QAAQ,OAAO,KAAK,CAAC;YAC3B,WAAW,KAAK,CAAC,EAAE,KAAK,OAAO,aAAa,OAAO,MAAM,KAAK,CAAC,EAAE,GAAG,KAAK,CAAC,EAAE;QAC9E;QACA,OAAO;YACL;YACA,QAAQ,OAAO,aAAa,OAAO;YACnC,YAAY,aAAa,QAAQ;YACjC,SAAS;YACT;YACA,SAAS,EAAE;QACb;IACF,GACA;QAAC;QAAQ;KAAY;IAGvB,MAAM,mBAAmB,IAAA,oNAAW,EAClC,CAAC;QACC,MAAM,QAAQ,OAAO,IAAI,GAAG;QAC5B,IAAI,wBAAwB,OAAO,CAAC,GAAG,CAAC,QAAQ;QAChD,MAAM,KAAK,AAAC,IAA0C,UAAU,IAAI,IAAI,SAAS;QACjF,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,QAAQ,KAAK,GAAG,CAAC,GAAG,KAAK;QAC/B,wBAAwB,OAAO,CAAC,GAAG,CAAC;QACpC,MAAM,UAAU,OAAO,UAAU,CAAC;YAChC,IAAI;gBACF,MAAM,MAAM,MAAM,MAAM,iBAAiB;oBACvC,QAAQ;oBACR,SAAS;wBAAE,gBAAgB;oBAAmB;oBAC9C,MAAM,KAAK,SAAS,CAAC;wBACnB,QAAQ;wBACR,WAAW,IAAI,GAAG;wBAClB,QAAQ,OAAO,aAAa,OAAO;oBACrC;gBACF;gBACA,MAAM,OAAO,MAAM,IAAI,IAAI;gBAC3B,MAAM,WAAW,qBAAqB,OAAO,IAAI,MAAM;gBACvD,IAAI,MAAM,WAAW,MAAM,WAAW,OAAO,MAAM,aAAa,UAAU;oBACxE,UAAU,OAAO,EAAE,KAAK,gBAAgB;wBACtC,GAAG,QAAQ;wBACX,KAAK,KAAK,QAAQ;wBAClB,MAAM;wBACN,SAAS,CAAC,mBAAmB,EAAE,IAAI,OAAO,IAAI,GAAG,CAAC,CAAC;wBACnD,WAAW,KAAK,GAAG;wBACnB,kBAAkB,OAAO,IAAI,GAAG;oBAClC;gBACF;gBACA,IAAI,MAAM,QAAQ;oBAChB,UAAU,OAAO,EAAE,KAAK,gBAAgB;wBACtC,KAAK,IAAI,GAAG;wBACZ,QAAQ,IAAI,MAAM;wBAClB,SAAS,IAAI,OAAO;wBACpB,YAAY,IAAI,OAAO;wBACvB,UAAU,KAAK,GAAG;wBAClB,iBAAiB,IAAI,eAAe,IAAI,IAAI,OAAO;wBACnD,YAAY,KAAK,MAAM;wBACvB,cAAc,AAAC,IAA4C,YAAY;oBACzE;gBACF;YACF,EAAE,OAAM,CAAC;YACT,wBAAwB,OAAO,CAAC,MAAM,CAAC;YACvC,MAAM,IAAI,kBAAkB,OAAO,CAAC,GAAG,CAAC;YACxC,IAAI,GAAG,kBAAkB,OAAO,CAAC,MAAM,CAAC;QAC1C,GAAG;QACH,kBAAkB,OAAO,CAAC,GAAG,CAAC,OAAO;IACvC,GACA;QAAC;QAAa;KAAqB;IAGrC,MAAM,4BAA4B,IAAA,oNAAW,EAAC;QAC5C,IAAI,CAAC,aAAa;QAClB,IAAI;YACF,MAAM,MAAM,MAAM,MAAM,iBAAiB;gBACvC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBACnB,QAAQ;oBACR,MAAM;wBAAE,QAAQ,YAAY,GAAG;wBAAE,OAAO;wBAAM,SAAS,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,KAAK;oBAAK;gBAC/F;YACF;YACA,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,MAAM,QAAmB,MAAM,OAAO,CAAC,MAAM,QAAS,KAAK,IAAI,GAAiB,EAAE;YAClF,MAAM,OAAO,CAAC,CAAC,IAAM,iBAAiB;QACxC,EAAE,OAAM,CAAC;IACX,GAAG;QAAC;QAAa;KAAiB;IAElC,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,aAAa;QAClB;;QAGA,KAAK;QACL,MAAM,KAAK,YAAY,IAAM,KAAK,6BAA6B;QAC/D,OAAO;YACL,cAAc;YACd;;QAGF;IACF,GAAG;QAAC;QAAa;KAA0B;IAE3C,oDAAoD;IACpD,MAAM,yBAAyB,IAAA,oNAAW,EAAC;QACzC,yBAAyB,CAAC;YACxB,MAAM,OAAO,CAAC;YACd,IAAI,MAAM;gBACR,wEAAwE;gBACxE,+CAA+C;gBAC/C,IAAI,CAAC,WAAW,IAAI,IAAI;oBACtB,oBAAoB;oBACpB,uBAAuB;wBAAE,UAAU,EAAE;wBAAE,UAAU,EAAE;oBAAC;gBACtD,OAAO;oBACL,uDAAuD;oBACvD,oBAAoB;oBACpB,mBAAmB;gBACrB;YACF;YACA,OAAO;QACT;IACF,GAAG;QAAC;QAAY;KAAmB;IAEnC,4DAA4D;IAC5D,MAAM,0BAA0B,IAAA,oNAAW,EACzC,CAAC,SAA8B;QAC7B,IAAI,aAA8B;QAClC,MAAM,OAAO,OAAO,aAAa;QAEjC,qBAAqB;QACrB,IAAI,QAAQ,WAAW,KAAK,QAAQ,QAAQ,MAAM,EAAE;YAClD,aAAa,OAAO,IAAI,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO,QAAQ,MAAM,MAAM;QAC/E,OAAO,IAAI,QAAQ,WAAW,KAAK,OAAO;YACxC,IAAI,YAA2B;YAC/B,IAAI,QAAQ,SAAS,EAAE;gBACrB,YAAY,OAAO,QAAQ,SAAS;YACtC,OAAO,IAAI,QAAQ,MAAM,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,MAAM;gBACzD,MAAM,QAAQ,QAAQ,MAAM,CAAC,KAAK,CAAC;gBACnC,YAAY,KAAK,CAAC,EAAE,KAAK,OAAO,KAAK,CAAC,EAAE,GAAG,KAAK,CAAC,EAAE;YACrD,OAAO;gBACL,MAAM,WAAW,OAAO,QAAQ,MAAM;gBACtC,MAAM,aAAa,QAAQ,QAAQ,GAAG,OAAO,QAAQ,QAAQ,IAAI;gBACjE,YAAY,aAAa,OAAO,aAAa;YAC/C;YAEA,IAAI,WAAW;gBACb,aAAa,SAAS,IAAI,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,cAAc;YACpE;QACF;QAEA,8DAA8D;QAC9D,IAAI,YAAY;YACd,yBAAyB;YACzB,iBAAiB;YAEjB,IAAI,iBAAiB,cAAc,IAAI,IAAI;gBACzC,qBAAqB;YACvB;YACA,WAAW;gBACT,qBAAqB,OAAO,QAAQ,GAAG;YACzC,GAAG;QACL,OAAO;YACL,oCAAoC;YACpC,QAAQ,IAAI,CAAC;YACb,eAAe,IAAI,CAAC;gBAClB,MAAM;YACR;QACF;IACF,GACA;QAAC;QAAQ;QAAU;QAAa;QAAc;KAAiB;IAGjE,IAAA,kNAAS,EAAC;QACR,MAAM,mBAAmB;YACvB,aAAa;YACb,IAAI;gBACF,MAAM,OAAO,KAAK,KAAK,CAAC,aAAa,OAAO,CAAC,gBAAgB;gBAC7D,IAAI,QAAQ,KAAK,GAAG,EAAE;oBACpB,eAAe;gBACjB,OAAO;oBACL,OAAO,IAAI,CAAC;gBACd;YACF,EAAE,OAAM;gBACN,OAAO,IAAI,CAAC;YACd,SAAU;gBACR,aAAa;YACf;QACF;QACA;QAEA,MAAM,YAAY,CAAC;YACjB,IAAI,EAAE,GAAG,KAAK,aAAa;gBACzB,IAAI;oBACF,MAAM,OAAO,EAAE,QAAQ,GAAG,KAAK,KAAK,CAAC,EAAE,QAAQ,IAAI;oBACnD,IAAI,QAAQ,KAAK,GAAG,EAAE;wBACpB,eAAe;oBACjB;gBACF,EAAE,OAAM,CAAC;YACX;QACF;QACA,OAAO,gBAAgB,CAAC,WAAW;QACnC,OAAO;YACL,OAAO,mBAAmB,CAAC,WAAW;QACxC;IACF,GAAG;QAAC;KAAO;IAEX,4BAA4B;IAC5B,IAAA,kNAAS,EAAC;QACR,IAAI,aAAa;IACnB,GAAG;QAAC;QAAa;KAAa;IAE9B,6CAA6C;IAC7C,IAAA,kNAAS,EAAC;QACR,gBAAgB,OAAO,GAAG;IAC5B,GAAG;QAAC;KAAa;IAEjB,6CAA6C;IAC7C,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,aAAa;QAClB,MAAM,WAAW,IAAA,yIAAgB;QACjC,UAAU,OAAO,GAAG,IAAA,mMAAE,EAAC,UAAU;YAAE,YAAY;gBAAC;aAAY;YAAE,iBAAiB;QAAM;QACrF,UAAU,OAAO,CAAC,IAAI,CAAC,aAAa,YAAY,GAAG;QACnD,UAAU,OAAO,CAAC,IAAI,CAAC,eAAe;YAAE,QAAQ,YAAY,GAAG;QAAC;QAChE,MAAM,eAAe,OAAO,SAAS;QACrC,MAAM,KAAK,YAAY;YACrB,IAAI;gBACF,UAAU,OAAO,EAAE,KAAK,aAAa;oBAAE,QAAQ,YAAY,GAAG;gBAAC;YACjE,EAAE,OAAM,CAAC;QACX,GAAG;QAEH,UAAU,OAAO,CAAC,EAAE,CAClB,mBACA,CAAC;YACC,YAAY,CAAC,OACX,KAAK,GAAG,CAAC,CAAC,IACR,OAAO,EAAE,GAAG,MAAM,OAAO,QAAQ,MAAM,IACnC;wBAAE,GAAG,CAAC;wBAAE,QAAQ,QAAQ,MAAM;wBAAE,UAAU,QAAQ,QAAQ,IAAI,EAAE,QAAQ;oBAAC,IACzE;QAGV;QAGF,MAAM,qBAAqB;YACzB,IAAI;gBACF,UAAU,OAAO,EAAE,KAAK,aAAa;oBAAE,QAAQ,YAAY,GAAG;gBAAC;YACjE,EAAE,OAAM,CAAC;QACX;QACA,OAAO,gBAAgB,CAAC,gBAAgB;QAExC,UAAU,OAAO,CAAC,EAAE,CAClB,kBACA,CAAC;YAcC,MAAM,UAAU,KAAK,MAAM,KAAK,YAAY,GAAG;YAC/C,MAAM,eAAe,gBAAgB,OAAO,EAAE,OAAO;YAErD,4BAA4B;YAC5B,IAAI,aAAa;YACjB,IAAI,SAAS;gBACX,aAAa;YACf,OAAO;gBACL,MAAM,YAAY,YAAY,OAAO,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;gBACvE,IAAI,WAAW,aAAa,UAAU,IAAI,IAAI;gBAC9C,IAAI,KAAK,UAAU,EAAE,aAAa,KAAK,UAAU;YACnD;YAEA,8DAA8D;YAC9D,IAAI,iBAAiB;YAErB,oGAAoG;YACpG,IAAI,KAAK,WAAW,IAAI,CAAC,KAAK,UAAU,IAAI,KAAK,IAAI,KAAK,UAAU;gBAClE,iBAAiB,KAAK,WAAW;YACnC,OAEK,IAAI,KAAK,UAAU,IAAI,KAAK,IAAI,KAAK,UAAU;gBAClD,iBAAiB,KAAK,OAAO,GACzB,UACE,kCACA,GAAG,WAAW,0BAA0B,CAAC,GAC3C;YACN,OAEK;gBACH,MAAM,aAAa,KAAK,IAAI,KAAK,UAAU,KAAK,IAAI,KAAK;gBACzD,MAAM,aAAa,aAAa,KAAK,OAAO,IAAI,KAAK,CAAC,CAAC,EAAE,KAAK,IAAI,IAAI,UAAU,CAAC,CAAC;gBAClF,iBAAiB,GAAG,WAAW,EAAE,EAAE,YAAY;YACjD;YACA,MAAM,YACJ,KAAK,IAAI,KAAK,UACd,KAAK,IAAI,KAAK,WACd,KAAK,IAAI,KAAK,UACd,KAAK,IAAI,KAAK,aACd,KAAK,IAAI,KAAK,WACd,KAAK,IAAI,KAAK;YAChB,MAAM,eACJ,AAAC,aAA2E,eAAe,iBAC3F;YACF,IAAI,CAAC,WAAW,aAAa,cAAc;gBACzC;YACF;YACA,oBAAoB;YACpB,IAAI,KAAK,OAAO,EAAE;gBAChB,UAAU,CAAC;oBACT,MAAM,QAAQ,KAAK,SAAS,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK,KAAK,MAAM;oBACzD,IAAI,UAAU,CAAC,GAAG;wBAChB,MAAM,OAAO,OAAO,YAAY,GAAG;wBACnC,MAAM,YAAY,MAAM,OAAO,CAAC,KAAK,OAAO,IACxC,KAAK,OAAO,CAAC,GAAG,CAAC,CAAC,IAAO,OAAO,MAAM,YAAY,GAAG,MAAM,OAAO,EAAE,GAAG,IAAI,OAAO,IAAK,MAAM,CAAC,WAC9F,EAAE;wBACN,MAAM,YAAY,UAAU,QAAQ,CAAC;wBACrC,IAAI,WAAW;4BACb,MAAM,cAAc,MAAM,OAAO,CAAC,KAAK,OAAO,IAC1C,KAAK,OAAO,CAAC,GAAG,CAAC,CAAC,IAChB,OAAO,MAAM,YAAY,GAAG,MACxB;oCAAE,KAAK,OAAO,EAAE,GAAG;oCAAG,MAAM;oCAAU,UAAU,KAAK,GAAG;gCAAG,IAC3D;oCAAE,KAAK,OAAO;oCAAI,MAAM;oCAAU,UAAU,KAAK,GAAG;gCAAG,KAE7D,EAAE;4BACN,MAAM,YAA+B;gCACnC,KAAK,OAAO,KAAK,MAAM;gCACvB,MAAM,CAAC,KAAK,SAAS,IAAI,KAAK,UAAU,IAAI,MAAM,EAAE,IAAI,MAAM;gCAC9D,SAAS;gCACT,SAAS;gCACT,WAAW,OAAO,KAAK,MAAM,IAAI;gCACjC,aAAa;gCACb,aAAa;gCACb,eAAe,KAAK,SAAS,IAAI,KAAK,GAAG;4BAC3C;4BACA,MAAM,OAAO;gCAAC;mCAAc;6BAAK;4BACjC,WAAW,IAAM,gBAAgB;4BACjC,OAAO;wBACT;wBACA;wBACA,OAAO;oBACT;oBACA,MAAM,eAAe,iBAAiB,KAAK,MAAM;oBAEjD,2CAA2C;oBAC3C,IAAI,oBAAoB;oBACxB,IAAI,CAAC,SAAS;wBACZ,MAAM,eAAe,IAAI,CAAC,MAAM;wBAChC,MAAM,eAAe,aAAa,OAAO,EAAE,KAAK,CAAC;4BAC/C,MAAM,MACJ,OAAO,MAAM,YAAY,KAAK,SAAS,IAAI,OAAO,AAAC,EAAgD,GAAG,IAAI,OAAO;4BACnH,OAAO,QAAQ,OAAO,KAAK,MAAM;wBACnC;wBACA,iCAAiC;wBACjC,IAAI,gBAAgB,OAAO,iBAAiB,UAAU;4BACpD,MAAM,KAAK;4BACX,IAAI,GAAG,QAAQ,EAAE;gCACf,oBAAoB,GAAG,QAAQ;4BACjC;wBACF;oBACF;oBAEA,kDAAkD;oBAClD,IAAI,sBAAsB;oBAC1B,6GAA6G;oBAC7G,gCAAgC;oBAChC,IAAI,CAAC,SAAS;wBACZ,MAAM,aAAa,KAAK,IAAI,KAAK,UAAU,KAAK,IAAI,KAAK;wBACzD,MAAM,aAAa,KAAK,OAAO,IAAI;wBAEnC,IAAI,KAAK,UAAU,IAAI,KAAK,IAAI,KAAK,UAAU;4BAC7C,sBAAsB,GAAG,kBAAkB,0BAA0B,CAAC;wBACxE,OAAO,IAAI,YAAY;4BACrB,sBAAsB,GAAG,kBAAkB,EAAE,EAAE,YAAY;wBAC7D,OAAO;4BACL,6BAA6B;4BAC7B,MAAM,YAAY,KAAK,IAAI,GAAG,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,CAAC,GAAG;4BACjD,sBAAsB,GAAG,kBAAkB,EAAE,EAAE,WAAW;wBAC5D;oBACF;oBAEA,MAAM,eAAe;wBACnB,GAAG,IAAI,CAAC,MAAM;wBACd,aAAa;wBACb,eAAe,KAAK,SAAS,IAAI,KAAK,GAAG;wBACzC,UAAU,KAAK,UAAU,IAAI;wBAC7B,aAAa,WAAW,eAAe,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,IAAI,CAAC,IAAI;oBAC9E;oBACA,MAAM,YAAY;2BAAI;qBAAK;oBAC3B,UAAU,MAAM,CAAC,OAAO;oBACxB,OAAO;wBAAC;2BAAiB;qBAAU;gBACrC;YACF,OAAO;gBACL,gCAAgC;gBAChC,MAAM,YAAY,UAAU,KAAK,QAAQ,GAAG,KAAK,MAAM;gBACvD,YAAY,CAAC;oBACX,MAAM,QAAQ,KAAK,SAAS,CAAC,CAAC,IAAM,EAAE,GAAG,KAAK;oBAC9C,IAAI,UAAU,CAAC,GAAG;wBAChB;wBACA,OAAO;oBACT;oBACA,MAAM,eAAe,iBAAiB;oBACtC,MAAM,cAAc;wBAClB,GAAG,IAAI,CAAC,MAAM;wBACd,aAAa;wBACb,eAAe,KAAK,SAAS,IAAI,KAAK,GAAG;wBACzC,UAAU,KAAK,UAAU,IAAI;wBAC7B,aAAa,WAAW,eAAe,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,IAAI,CAAC,IAAI;oBAC9E;oBACA,MAAM,WAAW;2BAAI;qBAAK;oBAC1B,SAAS,MAAM,CAAC,OAAO;oBACvB,OAAO;wBAAC;2BAAgB;qBAAS;gBACnC;YACF;QACF;QAGF,UAAU,OAAO,CAAC,EAAE,CAAC,yBAAyB,CAAC;YAC7C,MAAM,OAAO,OAAO,YAAY,GAAG;YACnC,MAAM,gBAAgB,MAAM,OAAO,CAAC,QAAQ,OAAO,IAC/C,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,IAAM,OAAO,AAAC,EAAsB,GAAG,KAC5D,EAAE;YACN,MAAM,eAAe,cAAc,QAAQ,CAAC;YAC5C,IAAI,CAAC,cAAc;gBACjB,UAAU,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO,QAAQ,MAAM;gBAC9E,IAAI,gBAAgB,OAAO,IAAI,OAAO,gBAAgB,OAAO,CAAC,GAAG,MAAM,OAAO,QAAQ,MAAM,GAAG;oBAC7F,gBAAgB;gBAClB;YACF;QACF;QACA,UAAU,OAAO,CAAC,EAAE,CAAC,iBAAiB,CAAC;YACrC,UAAU,CAAC,OACT,KAAK,GAAG,CAAC,CAAC,IAAO,OAAO,EAAE,GAAG,MAAM,OAAO,QAAQ,MAAM,IAAI;wBAAE,GAAG,CAAC;wBAAE,MAAM,QAAQ,SAAS;oBAAC,IAAI;YAElG,IAAI,gBAAgB,OAAO,IAAI,OAAO,gBAAgB,OAAO,CAAC,GAAG,MAAM,OAAO,QAAQ,MAAM,GAAG;gBAC7F,gBAAgB,CAAC,OAAU,OAAO;wBAAE,GAAG,IAAI;wBAAE,MAAM,QAAQ,SAAS;oBAAC,IAAI;YAC3E;QACF;QACA,OAAO;YACL,IAAI;gBACF,cAAc;YAChB,EAAE,OAAM,CAAC;YACT,OAAO,mBAAmB,CAAC,gBAAgB;YAC3C,UAAU,OAAO,EAAE;QACrB;IACF,GAAG;QAAC;QAAa;QAAc;KAAiB;IAEhD,kCAAkC;IAClC,MAAM,mBAAmB,IAAA,oNAAW,EAClC,OAAO,QAAgB,YAA4B,WAAoB;QACrE,IAAI,CAAC,aAAa,KAAK;QAEvB,MAAM,WAAW,cAAc,gBAAgB;QAE/C,IAAI;YACF,MAAM,UAOF;gBACF,QAAQ;gBACR,KAAK,YAAY,GAAG;gBACpB,eAAe,YAAY,GAAG;gBAC9B;gBACA,gBAAgB;gBAChB,MAAM,eAAe,QAAQ;oBAAE,UAAU;gBAAU,IAAI;oBAAE,UAAU;gBAAU;YAC/E;YAEA,MAAM,MAAM,MAAM,MAAM,UAAU;gBAChC,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YAEA,IAAI,IAAI,EAAE,EAAE;gBACV,IAAI,aAAa;oBACf,UAAU,CAAC,OACT,KAAK,GAAG,CAAC,CAAC;4BACR,IAAI,KAAK,GAAG,KAAK,QAAQ;gCACvB,MAAM,cAAc,eAAe,QAAQ,aAAa;gCACxD,OAAO;oCAAE,GAAG,IAAI;oCAAE,CAAC,YAAY,EAAE;gCAAU;4BAC7C;4BACA,OAAO;wBACT;gBAEJ,OAAO;oBACL,YAAY,CAAC,OACX,KAAK,GAAG,CAAC,CAAC;4BACR,IAAI,KAAK,GAAG,KAAK,QAAQ;gCACvB,MAAM,cAAc,eAAe,QAAQ,aAAa;gCACxD,OAAO;oCAAE,GAAG,IAAI;oCAAE,CAAC,YAAY,EAAE;gCAAU;4BAC7C;4BACA,OAAO;wBACT;gBAEJ;gBAEA,WAAW;oBACT;gBACF,GAAG;YACL;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,IAAI,EAAE,WAAW,MAAM,CAAC,EAAE;QAC3C;IACF,GACA;QAAC;QAAa;KAAa;IAG7B,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 2414, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/context/ChatContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { createContext, useContext } from 'react';\r\n\r\nimport type { User } from '../types/User';\r\nimport type { ChatItem } from '../types/Group';\r\nimport type { Message } from '../types/Message';\r\n\r\nexport interface ChatContextValue {\r\n  currentUser: User;\r\n  allUsers: User[];\r\n  selectedChat: ChatItem;\r\n  messages: Message[];\r\n  isGroup: boolean;\r\n  chatName: string;\r\n}\r\n\r\nconst ChatContext = createContext<ChatContextValue | undefined>(undefined);\r\n\r\ninterface ChatProviderProps {\r\n  value: ChatContextValue;\r\n  children: React.ReactNode;\r\n}\r\n\r\nexport const ChatProvider: React.FC<ChatProviderProps> = ({ value, children }) => {\r\n  return <ChatContext.Provider value={value}>{children}</ChatContext.Provider>;\r\n};\r\n\r\nexport const useChatContext = (): ChatContextValue => {\r\n  const context = useContext(ChatContext);\r\n\r\n  if (!context) {\r\n    throw new Error('useChatContext must be used within a ChatProvider');\r\n  }\r\n\r\n  return context;\r\n};\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;AAEA;AAFA;;;AAiBA,MAAM,4BAAc,IAAA,sNAAa,EAA+B;AAOzD,MAAM,eAA4C,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE;IAC3E,qBAAO,8OAAC,YAAY,QAAQ;QAAC,OAAO;kBAAQ;;;;;;AAC9C;AAEO,MAAM,iBAAiB;IAC5B,MAAM,UAAU,IAAA,mNAAU,EAAC;IAE3B,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;AACT"}},
    {"offset": {"line": 2447, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/data/fbEmojis.ts"],"sourcesContent":["export const FB_EMOJIS = [\r\n  '1f600',\r\n  '1f601',\r\n  '1f602',\r\n  '1f603',\r\n  '1f604',\r\n  '1f606',\r\n  '1f607',\r\n  '1f609',\r\n  '1f60a',\r\n  '1f60b',\r\n  '1f60d',\r\n  '1f60e',\r\n  '1f60f',\r\n  '1f612',\r\n  '1f613',\r\n  '1f614',\r\n  '1f616',\r\n  '1f618',\r\n  '1f61a',\r\n  '1f61c',\r\n  '1f61d',\r\n  '1f61e',\r\n  '1f620',\r\n  '1f621',\r\n  '1f622',\r\n  '1f623',\r\n  '1f624',\r\n  '1f625',\r\n  '1f626',\r\n  '1f627',\r\n  '1f628',\r\n  '1f629',\r\n  '1f62a',\r\n  '1f62b',\r\n  '1f62d',\r\n  '1f630',\r\n  '1f631',\r\n  '1f632',\r\n  '1f633',\r\n  '1f634',\r\n  '1f635',\r\n  '1f636',\r\n  '1f637',\r\n  '1f641',\r\n  '1f642',\r\n  '1f643',\r\n  '1f644',\r\n  '1f910',\r\n  '1f911',\r\n  '1f912',\r\n  '1f914',\r\n  '1f917',\r\n  '1f920',\r\n  '1f921',\r\n  '1f922',\r\n  '1f923',\r\n  '1f924',\r\n  '1f925',\r\n  '1f927',\r\n  '1f928',\r\n  '1f929',\r\n  '1f92a',\r\n  '1f92b',\r\n  '1f92c',\r\n  '1f92d',\r\n  '1f92e',\r\n  '1f92f',\r\n  '1f970',\r\n  '1f973',\r\n  '1f974',\r\n  '1f975',\r\n  '1f976',\r\n  '1f978',\r\n  '1f979',\r\n  '1f97a',\r\n  '1f9d0',\r\n  '2764',\r\n  '1f49b',\r\n  '1f49a',\r\n  '1f499',\r\n  '1f49c',\r\n  '1f90e',\r\n  '1f5a4',\r\n  '1f44d',\r\n  '1f44f',\r\n  '1f64f',\r\n  '1f44e',\r\n  '1f448',\r\n  '1f449',\r\n  '1f64c',\r\n  '270a',\r\n  '270c',\r\n  '1f64b',\r\n  '1f91d',\r\n  '1f44a',\r\n  '1f680',\r\n];\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,YAAY;IACvB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD"}},
    {"offset": {"line": 2553, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/data/dataBanner.tsx"],"sourcesContent":["export interface Banner {\r\n  image: string; // ƒê∆∞·ªùng d·∫´n h√¨nh ·∫£nh\r\n  title: string; // Ti√™u ƒë·ªÅ banner\r\n  description: string; // M√¥ t·∫£ banner\r\n  buttonText?: string; // Text n√∫t b·∫•m, c√≥ th·ªÉ kh√¥ng c√≥\r\n}\r\nexport const banners: Banner[] = [\r\n  {\r\n    image: '/imgs/banner1.png',\r\n    title: 'Giao di·ªán Dark Mode',\r\n    description: 'Th∆∞ gi√£n v√† b·∫£o v·ªá m·∫Øt v·ªõi ch·∫ø ƒë·ªô giao di·ªán t·ªëi m·ªõi tr√™n Zalo',\r\n    buttonText: 'Th·ª≠ ngay',\r\n  },\r\n  {\r\n    image: '/imgs/banner2.png',\r\n    title: 'Kinh doanh hi·ªáu qu·∫£ v·ªõi zBusiness Pro',\r\n    description:\r\n      'B√°n h√†ng chuy√™n nghi·ªáp v·ªõi Nh√¢n Business v√† B·ªô c√¥ng c·ª• kinh doanh, m·ªü kho√° t·∫ßm nƒÉng ti·∫øp c·∫≠n kh√°ch h√†ng tr√™n Zalo',\r\n    buttonText: 'T√¨m hi·ªÉu ngay',\r\n  },\r\n  {\r\n    image: '/imgs/banner3.png',\r\n    title: 'Nh·∫Øn tin nhi·ªÅu h∆°n ,so·∫°n th·∫£o √≠t h∆°n',\r\n    description: 'S·ª≠ d·ª•ng Tin Nh·∫Øn Nhanh ƒë·ªÉ l∆∞u s·∫µn c√°c tin nh·∫Øn th∆∞·ªùng d√πng v√† g·ª≠i nhanh trong h·ªôi tho·∫°i b·∫•t k·ª≥',\r\n  },\r\n  {\r\n    image: '/imgs/banner4.png',\r\n    title: 'Tr·∫£i nghi·ªám xuy√™n su·ªët',\r\n    description: 'K·∫øt n·ªëi v√† gi·∫£i quy·∫øt c√¥ng vi·ªác tr√™n m·ªçi thi·∫øt b·ªã d·ªØ li·ªáu lu√¥n ƒë∆∞·ª£c ƒë·ªìng b·ªô',\r\n  },\r\n  { image: '/imgs/banner5.png', title: 'G·ª≠i File n·∫∑ng?', description: 'ƒê√£ c√≥ Zalo \"x·ª≠\" h·∫øt ' },\r\n];\r\n"],"names":[],"mappings":";;;;AAMO,MAAM,UAAoB;IAC/B;QACE,OAAO;QACP,OAAO;QACP,aAAa;QACb,YAAY;IACd;IACA;QACE,OAAO;QACP,OAAO;QACP,aACE;QACF,YAAY;IACd;IACA;QACE,OAAO;QACP,OAAO;QACP,aAAa;IACf;IACA;QACE,OAAO;QACP,OAAO;QACP,aAAa;IACf;IACA;QAAE,OAAO;QAAqB,OAAO;QAAkB,aAAa;IAAuB;CAC5F"}},
    {"offset": {"line": 2590, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/uploadStore.ts"],"sourcesContent":["// lib/uploadStore.ts\r\n\r\n// üëá KHAI B√ÅO KI·ªÇU CHO GLOBAL\r\ndeclare global {\r\n  var uploadProgressMap: Map<string, number> | undefined;\r\n}\r\n\r\n// Kh·ªüi t·∫°o n·∫øu ch∆∞a c√≥\r\nglobalThis.uploadProgressMap = globalThis.uploadProgressMap || new Map<string, number>();\r\n\r\nexport const setProgress = (id: string, percent: number) => {\r\n  if (globalThis.uploadProgressMap) {\r\n    globalThis.uploadProgressMap.set(id, percent);\r\n  }\r\n};\r\n\r\nexport const getProgress = (id: string) => {\r\n  const map = globalThis.uploadProgressMap;\r\n  if (!map) return -1;\r\n  return map.has(id) ? (map.get(id) ?? 0) : -1;\r\n};\r\n\r\nexport const clearProgress = (id: string) => {\r\n  globalThis.uploadProgressMap?.delete(id);\r\n};\r\n"],"names":[],"mappings":"AAAA,qBAAqB;AAErB,8BAA8B;;;;;;;;;AAK9B,uBAAuB;AACvB,WAAW,iBAAiB,GAAG,WAAW,iBAAiB,IAAI,IAAI;AAE5D,MAAM,cAAc,CAAC,IAAY;IACtC,IAAI,WAAW,iBAAiB,EAAE;QAChC,WAAW,iBAAiB,CAAC,GAAG,CAAC,IAAI;IACvC;AACF;AAEO,MAAM,cAAc,CAAC;IAC1B,MAAM,MAAM,WAAW,iBAAiB;IACxC,IAAI,CAAC,KAAK,OAAO,CAAC;IAClB,OAAO,IAAI,GAAG,CAAC,MAAO,IAAI,GAAG,CAAC,OAAO,IAAK,CAAC;AAC7C;AAEO,MAAM,gBAAgB,CAAC;IAC5B,WAAW,iBAAiB,EAAE,OAAO;AACvC"}},
    {"offset": {"line": 2619, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/onesignal.ts"],"sourcesContent":["import OneSignal from 'react-onesignal';\r\nlet __inited = false;\r\n\r\nexport async function initOneSignal() {\r\n  if (__inited) return;\r\n  await OneSignal.init({\r\n    appId: String(process.env.NEXT_PUBLIC_ONESIGNAL_APP_ID || process.env.ONESIGNAL_APP_ID || '').trim(),\r\n    allowLocalhostAsSecureOrigin: true, // cho ph√©p test localhost\r\n    notifyButton: {\r\n      enable: true,\r\n      prenotify: false,\r\n      showCredit: false,\r\n      text: {\r\n        'tip.state.unsubscribed': 'Subscribe to notifications',\r\n        'tip.state.subscribed': \"You're subscribed to notifications\",\r\n        'tip.state.blocked': 'You have blocked notifications',\r\n        'message.prenotify': 'Click to subscribe to notifications',\r\n        'message.action.subscribing': 'Subscribing...',\r\n        'message.action.subscribed': 'Thanks for subscribing!',\r\n        'message.action.resubscribed': 'You are subscribed to notifications',\r\n        'message.action.unsubscribed': 'You will not receive notifications',\r\n        'dialog.main.title': 'Manage Site Notifications',\r\n        'dialog.main.button.subscribe': 'SUBSCRIBE',\r\n        'dialog.main.button.unsubscribe': 'UNSUBSCRIBE',\r\n        'dialog.blocked.title': 'Unblock Notifications',\r\n        'dialog.blocked.message': 'Follow these instructions to allow notifications:',\r\n      },\r\n    },\r\n    enable: true, // hi·ªán n√∫t bell ƒë·ªÉ subscribe\r\n    serviceWorkerPath: '/OneSignalSDKWorker.js',\r\n    serviceWorkerUpdaterPath: '/OneSignalSDKUpdaterWorker.js',\r\n  });\r\n  __inited = true;\r\n}\r\n\r\n// H√†m ƒëƒÉng k√Ω nh·∫≠n th√¥ng b√°o\r\nexport async function subscribeNotification() {\r\n  const permission = await OneSignal.Notifications.requestPermission();\r\n  return permission;\r\n}\r\n\r\n// L·∫•y user ID (player ID)\r\nexport async function getUserId() {\r\n  const userId = await OneSignal.User.PushSubscription.id;\r\n  return userId;\r\n}\r\n\r\n// Th√™m tag cho user (ƒë·ªÉ g·ª≠i targeted notification)\r\nexport async function addUserTags(tags: Record<string, string>) {\r\n  await OneSignal.User.addTags(tags);\r\n}\r\n\r\nexport async function loginOneSignal(externalId: string) {\r\n  try {\r\n    await OneSignal.login(externalId);\r\n  } catch {}\r\n}\r\n\r\nexport async function ensureSubscribed() {\r\n  try {\r\n    const id = await OneSignal.User.PushSubscription.id;\r\n    if (id) return id;\r\n    await OneSignal.Notifications.requestPermission();\r\n    for (let i = 0; i < 5; i++) {\r\n      const cur = await OneSignal.User.PushSubscription.id;\r\n      if (cur) return cur;\r\n      await new Promise((r) => setTimeout(r, 800));\r\n    }\r\n    return await OneSignal.User.PushSubscription.id;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function waitForOneSignalReady() {\r\n  const max = 30;\r\n  for (let i = 0; i < max; i++) {\r\n    if (typeof window !== 'undefined' && (window as { OneSignal?: unknown }).OneSignal) return;\r\n    await new Promise((r) => setTimeout(r, 200));\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AACA,IAAI,WAAW;AAER,eAAe;IACpB,IAAI,UAAU;IACd,MAAM,8JAAS,CAAC,IAAI,CAAC;QACnB,OAAO,OAAO,4EAA4C,QAAQ,GAAG,CAAC,gBAAgB,IAAI,IAAI,IAAI;QAClG,8BAA8B;QAC9B,cAAc;YACZ,QAAQ;YACR,WAAW;YACX,YAAY;YACZ,MAAM;gBACJ,0BAA0B;gBAC1B,wBAAwB;gBACxB,qBAAqB;gBACrB,qBAAqB;gBACrB,8BAA8B;gBAC9B,6BAA6B;gBAC7B,+BAA+B;gBAC/B,+BAA+B;gBAC/B,qBAAqB;gBACrB,gCAAgC;gBAChC,kCAAkC;gBAClC,wBAAwB;gBACxB,0BAA0B;YAC5B;QACF;QACA,QAAQ;QACR,mBAAmB;QACnB,0BAA0B;IAC5B;IACA,WAAW;AACb;AAGO,eAAe;IACpB,MAAM,aAAa,MAAM,8JAAS,CAAC,aAAa,CAAC,iBAAiB;IAClE,OAAO;AACT;AAGO,eAAe;IACpB,MAAM,SAAS,MAAM,8JAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;IACvD,OAAO;AACT;AAGO,eAAe,YAAY,IAA4B;IAC5D,MAAM,8JAAS,CAAC,IAAI,CAAC,OAAO,CAAC;AAC/B;AAEO,eAAe,eAAe,UAAkB;IACrD,IAAI;QACF,MAAM,8JAAS,CAAC,KAAK,CAAC;IACxB,EAAE,OAAM,CAAC;AACX;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,MAAM,8JAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;QACnD,IAAI,IAAI,OAAO;QACf,MAAM,8JAAS,CAAC,aAAa,CAAC,iBAAiB;QAC/C,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;YAC1B,MAAM,MAAM,MAAM,8JAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;YACpD,IAAI,KAAK,OAAO;YAChB,MAAM,IAAI,QAAQ,CAAC,IAAM,WAAW,GAAG;QACzC;QACA,OAAO,MAAM,8JAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;IACjD,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe;IACpB,MAAM,MAAM;IACZ,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,IAAK;QAC5B;;QACA,MAAM,IAAI,QAAQ,CAAC,IAAM,WAAW,GAAG;IACzC;AACF"}}]
}