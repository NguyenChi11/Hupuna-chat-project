{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/%28zalo%29/home/CreateGroupModal.tsx"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\n'use client';\r\n\r\nimport React from 'react';\r\nimport { HiX, HiSearch, HiUserGroup, HiXCircle } from 'react-icons/hi';\r\nimport { FaCheck } from 'react-icons/fa';\r\nimport Image from 'next/image';\r\nimport { User } from '../../../types/User';\r\nimport { formatTimeAgo } from '@/utils/dateUtils';\r\nimport { GroupConversation } from '@/types/Group';\r\nimport { useCreateGroupModal } from '@/hooks/useCreateGroupModal';\r\nimport { getProxyUrl } from '@/utils/utils';\r\nimport { HiMagnifyingGlass, HiOutlineUserPlus, HiCamera, HiFaceSmile, HiChevronLeft } from 'react-icons/hi2';\r\n\r\ninterface Props {\r\n  currentUser: User;\r\n  allUsers: User[];\r\n  onClose: () => void;\r\n  onGroupCreated: (group?: GroupConversation) => void;\r\n  mode?: 'create' | 'add';\r\n  conversationId?: string;\r\n  existingMemberIds?: string[];\r\n  reLoad?: () => void;\r\n  onMembersAdded?: (users: User[]) => void;\r\n}\r\n\r\nexport default function CreateGroupModal({\r\n  currentUser,\r\n  allUsers,\r\n  onClose,\r\n  onGroupCreated,\r\n  mode = 'create',\r\n  conversationId,\r\n  existingMemberIds = [],\r\n  reLoad,\r\n  onMembersAdded,\r\n}: Props) {\r\n  const inheritedExistingIds = React.useMemo(() => {\r\n    if (existingMemberIds && existingMemberIds.length > 0) {\r\n      return existingMemberIds.map(String);\r\n    }\r\n    try {\r\n      const w = window as Window & { __createGroupInitialMemberIds?: string[] };\r\n      const arr = w.__createGroupInitialMemberIds;\r\n      if (Array.isArray(arr) && arr.length > 0) {\r\n        return arr.map(String);\r\n      }\r\n    } catch {}\r\n    return [];\r\n  }, [existingMemberIds]);\r\n\r\n  const {\r\n    groupName,\r\n    setGroupName,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    selectedMembers,\r\n    loading,\r\n    error,\r\n    groupedUsers,\r\n    sortedGroupKeys,\r\n    handleMemberToggle,\r\n    handleSubmit,\r\n    avatarPreview,\r\n    handleAvatarChange,\r\n  } = useCreateGroupModal({\r\n    currentUser,\r\n    allUsers,\r\n    mode,\r\n    conversationId,\r\n    existingMemberIds: inheritedExistingIds,\r\n    reLoad,\r\n    onMembersAdded,\r\n    onGroupCreated,\r\n    onClose,\r\n  });\r\n\r\n  const [imgError, setImgError] = React.useState(false);\r\n\r\n  React.useEffect(() => {\r\n    setImgError(false);\r\n  }, [avatarPreview]);\r\n  React.useEffect(() => {\r\n    return () => {\r\n      try {\r\n        const w = window as Window & { __createGroupInitialMemberIds?: string[] | null };\r\n        w.__createGroupInitialMemberIds = null;\r\n      } catch {}\r\n    };\r\n  }, []);\r\n\r\n  const selectedUsers = React.useMemo(\r\n    () => allUsers.filter((u) => selectedMembers.includes(String(u._id))),\r\n    [allUsers, selectedMembers],\r\n  );\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm sm:px-0\">\r\n      <div className=\"sm:mx-[0.5rem] bg-white w-full h-full sm:w-full sm:max-w-2xl  sm:max-h-[90vh] sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between px-4 py-3 bg-white  border-b border-gray-100 sm:border-none\">\r\n          <div className=\"flex items-center gap-3 w-full\">\r\n            {/* Mobile Back Button */}\r\n            <button\r\n              onClick={onClose}\r\n              className=\"sm:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors text-gray-800\"\r\n            >\r\n              <HiChevronLeft className=\"w-6 h-6\" />\r\n            </button>\r\n\r\n            {/* Desktop Icon (hidden on mobile) */}\r\n            {/* <HiOutlineUserPlus className=\"w-5 h-5 hidden sm:block\" /> */}\r\n\r\n            <div className=\"flex flex-col items-start justify-center flex-1 sm:flex-none\">\r\n              <h2 className=\"text-lg font-bold leading-tight\">{mode === 'create' ? 'Nhóm mới' : 'Thêm thành viên'}</h2>\r\n              <p className=\"text-sm text-gray-500 font-medium sm:hidden\">Đã chọn: {selectedMembers.length}</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Desktop Close Button */}\r\n          <button\r\n            onClick={onClose}\r\n            className=\"hidden sm:block p-2.5 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200 active:scale-90\"\r\n          >\r\n            <HiX className=\"w-4 h-4\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Body */}\r\n        <div className=\"flex-1 flex flex-col min-h-0 bg-gray-50\">\r\n          {/* Input Section */}\r\n          <div className=\"p-4 bg-white border-b border-gray-100\">\r\n            {/* Tên nhóm - chỉ hiện khi tạo mới */}\r\n            {mode === 'create' && (\r\n              <div className=\"flex items-center gap-4 mb-2\">\r\n                <div className=\"relative w-12 h-12 flex-shrink-0\">\r\n                  <label\r\n                    className=\"w-full h-full rounded-full bg-gray-100 flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors overflow-hidden border border-gray-200\"\r\n                    title=\"Đổi ảnh nhóm\"\r\n                  >\r\n                    {avatarPreview && !imgError ? (\r\n                      <Image\r\n                        src={avatarPreview}\r\n                        alt=\"Group Avatar\"\r\n                        width={48}\r\n                        height={48}\r\n                        className=\"w-full h-full object-cover\"\r\n                        onError={() => setImgError(true)}\r\n                      />\r\n                    ) : (\r\n                      <HiCamera className=\"w-6 h-6 text-gray-500\" />\r\n                    )}\r\n                    <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={handleAvatarChange} />\r\n                  </label>\r\n                </div>\r\n                <div className=\"flex-1 relative border-b-2 focus-within:border-[#0068ff] border-gray-200 transition-colors pb-1\">\r\n                  <input\r\n                    type=\"text\"\r\n                    value={groupName}\r\n                    onChange={(e) => setGroupName(e.target.value)}\r\n                    placeholder=\"Đặt tên nhóm\"\r\n                    className=\"w-full py-2 bg-transparent focus:outline-none text-lg font-medium placeholder:text-gray-400 pr-8\"\r\n                  />\r\n                  <button className=\"absolute right-0 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\">\r\n                    <HiFaceSmile className=\"w-6 h-6\" />\r\n                  </button>\r\n                </div>\r\n                {selectedMembers.length >= 3 && (\r\n                  <button\r\n                    onClick={handleSubmit}\r\n                    disabled={loading}\r\n                    className=\"p-1 rounded-full hover:bg-blue-50 transition-colors\"\r\n                  >\r\n                    <FaCheck className=\"w-6 h-6 text-[#0068ff]\" />\r\n                  </button>\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {/* Thanh tìm kiếm */}\r\n            <div className=\"relative\">\r\n              <HiMagnifyingGlass className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 pointer-events-none\" />\r\n              <input\r\n                type=\"text\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                placeholder=\"Tìm tên...\"\r\n                className=\"w-full pl-12 pr-4 py-2.5 bg-gray-100 rounded-xl focus:outline-none focus:bg-white focus:ring-1 focus:ring-[#0068ff] text-base placeholder:text-gray-500 transition-all duration-200\"\r\n              />\r\n            </div>\r\n\r\n            {/* Lỗi */}\r\n            {error && (\r\n              <div className=\"mt-4 p-4 bg-red-50 border border-red-200 rounded-2xl flex items-center gap-3\">\r\n                <HiXCircle className=\"w-6 h-6 text-red-600 flex-shrink-0\" />\r\n                <span className=\"text-sm font-medium text-red-700\">{error}</span>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Danh sách User (Scrollable) */}\r\n          <div className=\"flex-1 overflow-y-auto p-4 custom-scrollbar\">\r\n            <h4 className=\"hidden  font-semibold text-sm text-gray-600 mb-3 md:flex items-center\">\r\n              {mode === 'create' ? 'Danh sách bạn bè' : 'Thành viên có thể thêm'}\r\n              <span className=\"ml-2 bg-blue-100 text-blue-700 py-0.5 px-2 rounded-full text-xs\">\r\n                {selectedMembers.length}\r\n              </span>\r\n            </h4>\r\n\r\n            {sortedGroupKeys.map((letter) => (\r\n              <div key={letter} className=\"mb-2\">\r\n                {groupedUsers[letter].map((user) => {\r\n                  const userIdStr = String(user._id);\r\n                  const isAlreadyMember = existingMemberIds.includes(userIdStr);\r\n                  const isSelected = selectedMembers.includes(userIdStr);\r\n                  const isMe = userIdStr === String(currentUser._id);\r\n                  const displayName =\r\n                    String(user.nicknames?.[String(currentUser._id)] || '').trim() ||\r\n                    String(user.name || user.username || 'Người dùng').trim();\r\n\r\n                  return (\r\n                    <label\r\n                      key={user._id}\r\n                      className={`flex items-center p-3 mb-1 cursor-pointer transition-colors justify-between rounded-2xl\r\n                          ${isSelected ? 'bg-blue-50' : 'hover:bg-gray-50'} ${\r\n                            (mode === 'add' && isAlreadyMember) || isMe\r\n                              ? 'bg-gray-50 opacity-60 cursor-not-allowed'\r\n                              : ''\r\n                          }\r\n                                                `}\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        <div className=\"sm:w-10 sm:h-10 w-10 h-10 mr-3 rounded-full overflow-hidden sm:ring-4 ring-2 ring-white shadow-md\">\r\n                          {user.avatar ? (\r\n                            <Image\r\n                              src={getProxyUrl(user.avatar)}\r\n                              alt=\"\"\r\n                              width={48}\r\n                              height={48}\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <Image\r\n                              src=\"/logo/avata.webp\"\r\n                              alt=\"\"\r\n                              width={48}\r\n                              height={48}\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          )}\r\n                        </div>\r\n\r\n                        <div>\r\n                          <div className=\"flex-1\">\r\n                            <p className=\"sm:text-sm font-semibold text-gray-900 px-1\">{displayName}</p>\r\n                          </div>\r\n                          <span\r\n                            className={`text-xs px-1 font-medium ${user.online ? 'text-green-600' : 'text-gray-500'}`}\r\n                          >\r\n                            {user.online\r\n                              ? 'Đang hoạt động'\r\n                              : user.lastSeen\r\n                                ? `Hoạt động ${formatTimeAgo(user.lastSeen)} trước`\r\n                                : 'Hoạt động gần đây'}\r\n                          </span>\r\n                          {isAlreadyMember && mode === 'add' && (\r\n                            <span className=\"text-xs text-gray-400 font-medium\">Đã tham gia</span>\r\n                          )}\r\n                        </div>\r\n                        {isMe && <span className=\"text-xs text-gray-400 font-medium px-1\">Bạn</span>}\r\n                      </div>\r\n                      <div className=\"relative flex items-center justify-center w-6 h-6 mr-3\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          checked={isSelected}\r\n                          disabled={(mode === 'add' && isAlreadyMember) || isMe}\r\n                          onChange={() => handleMemberToggle(userIdStr)}\r\n                          className=\"peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-full checked:bg-[#0573ff] checked:border-[#0573ff] transition-all\"\r\n                        />\r\n                        {/* Custom Checkmark Icon */}\r\n                        <svg\r\n                          className=\"absolute w-3.5 h-3.5 text-white hidden peer-checked:block pointer-events-none\"\r\n                          fill=\"none\"\r\n                          viewBox=\"0 0 24 24\"\r\n                          stroke=\"currentColor\"\r\n                          strokeWidth=\"3\"\r\n                        >\r\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M5 13l4 4L19 7\" />\r\n                        </svg>\r\n                      </div>\r\n                    </label>\r\n                  );\r\n                })}\r\n              </div>\r\n            ))}\r\n\r\n            {sortedGroupKeys.length === 0 && (\r\n              <div className=\"text-center py-10 opacity-50\">\r\n                <p>Không tìm thấy kết quả</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Selected Users Horizontal Scroll */}\r\n        {(selectedUsers.length > 0 || mode === 'create') && (\r\n          <div className=\"px-3 py-2 bg-white border-t border-gray-100\">\r\n            <div className=\"flex gap-2 overflow-x-auto custom-scrollbar pb-1 pt-2\">\r\n              {/* Creator (Fixed) */}\r\n              {mode === 'create' && (\r\n                <div className=\"relative flex-shrink-0 cursor-default opacity-100\">\r\n                  <div className=\"w-10 h-10 rounded-full overflow-hidden border-2 border-blue-500 shadow-sm\">\r\n                    {currentUser.avatar ? (\r\n                      <Image\r\n                        src={getProxyUrl(currentUser.avatar)}\r\n                        alt={currentUser.name}\r\n                        width={40}\r\n                        height={40}\r\n                        className=\"w-full h-full object-cover\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"w-full h-full bg-gradient-to-br from-[#0068ff] to-[#00a0e9] text-white font-bold flex items-center justify-center text-lg\">\r\n                        {currentUser.name?.charAt(0).toUpperCase()}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {selectedUsers\r\n                .filter((u) => mode !== 'create' || String(u._id) !== String(currentUser._id))\r\n                .map((user) => (\r\n                  <div\r\n                    key={user._id}\r\n                    className=\"relative flex-shrink-0 cursor-pointer group\"\r\n                    onClick={() => handleMemberToggle(String(user._id))}\r\n                  >\r\n                    <div className=\"w-10 h-10 rounded-full overflow-hidden border border-gray-200 shadow-sm transition-opacity\">\r\n                      {user.avatar ? (\r\n                        <Image\r\n                          src={getProxyUrl(user.avatar)}\r\n                          alt={\r\n                            String(user.nicknames?.[String(currentUser._id)] || '').trim() ||\r\n                            String(user.name || user.username || 'Người dùng').trim()\r\n                          }\r\n                          width={40}\r\n                          height={40}\r\n                          className=\"w-full h-full object-cover\"\r\n                        />\r\n                      ) : (\r\n                        <Image\r\n                          src=\"/logo/avata.webp\"\r\n                          alt=\"\"\r\n                          width={48}\r\n                          height={48}\r\n                          className=\"w-full h-full object-cover\"\r\n                        />\r\n                      )}\r\n                    </div>\r\n                    <div className=\"absolute -top-1 -right-1 bg-gray-100 rounded-full text-gray-500 \">\r\n                      <HiXCircle className=\"w-4 h-4\" />\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Footer - Nút cố định dưới cùng */}\r\n        <div className=\"p-3 bg-white border-t border-gray-200 flex gap-3\">\r\n          {/* Nút Hủy */}\r\n          <button\r\n            onClick={onClose}\r\n            className=\"flex-1 py-3 cursor-pointer text-base font-medium text-gray-600 bg-transparent hover:bg-gray-100 rounded-2xl transition-all duration-200 active:scale-95\"\r\n          >\r\n            Hủy\r\n          </button>\r\n\r\n          {/* Nút Tạo / Thêm */}\r\n          <button\r\n            onClick={handleSubmit}\r\n            disabled={loading || selectedMembers.length === 0}\r\n            className={`flex-1 py-3 text-base font-bold text-white rounded-2xl cursor-pointer transition-all duration-300 active:scale-95 flex items-center justify-center gap-1.5 shadow-md\r\n      ${\r\n        loading || selectedMembers.length === 0\r\n          ? 'bg-gray-400 cursor-not-allowed'\r\n          : 'bg-[#0068ff] hover:bg-[#005edc] shadow-[#0068ff]/50'\r\n      }`}\r\n          >\r\n            {loading ? (\r\n              <>Đang xử lý...</>\r\n            ) : mode === 'create' ? (\r\n              <>\r\n                Tạo nhóm\r\n                {selectedMembers.length > 0 && (\r\n                  <span className=\"ml-1 text-sm font-normal opacity-90\">({selectedMembers.length})</span>\r\n                )}\r\n              </>\r\n            ) : (\r\n              <>\r\n                Thêm\r\n                {selectedMembers.filter((id) => !existingMemberIds.includes(id)).length > 0 && (\r\n                  <span className=\"ml-1 text-sm font-normal opacity-90\">\r\n                    ({selectedMembers.filter((id) => !existingMemberIds.includes(id)).length})\r\n                  </span>\r\n                )}\r\n              </>\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 695, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/%28zalo%29/home/ChatInfoPopup.tsx"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\n'use client';\r\n\r\nimport React, { useRef, useState, useEffect, useCallback, useMemo } from 'react';\r\n\r\nimport { HiX, HiChevronLeft, HiBan, HiTrash } from 'react-icons/hi';\r\nimport ModalMembers from '@/components/base/ModalMembers';\r\nimport { GroupConversation, MemberInfo, GroupRole } from '@/types/Group';\r\nimport { User } from '@/types/User';\r\nimport { useChatInfoPopup } from '@/hooks/useChatInfoPopup';\r\nimport MediaPreviewModal from '@/components/(chatPopup)/MediaPreviewModal';\r\nimport UserAvatarSection from '@/components/(chatPopup)/components/UserAvatarSection';\r\nimport ChatQuickActions from '@/components/(chatPopup)/components/ChatQuickActions';\r\nimport GroupDangerZone from '@/components/(chatPopup)/components/GroupDangerZone';\r\nimport GroupMembersSection from '@/components/(chatPopup)/components/GroupMembersSection';\r\nimport ReminderSection from '@/components/(chatPopup)/components/ReminderSection';\r\nimport PollSection from '@/components/(chatPopup)/components/PollSection';\r\nimport ItemDropdownMenu from '@/components/(chatPopup)/components/ItemDropdownMenu';\r\nimport RenameGroupModal from '@/components/(chatPopup)/components/RenameGroupModal';\r\nimport ConfirmGroupActionModal from '@/components/(chatPopup)/components/ConfirmGroupActionModal';\r\nimport { useChatContext } from '@/context/ChatContext';\r\nimport ReminderList from '@/components/(chatPopup)/components/ReminderList';\r\nimport PinnedMessagesList from '@/components/(chatPopup)/components/PinnedMessagesList';\r\nimport PollList from '@/components/(chatPopup)/components/PollList';\r\nimport io from 'socket.io-client';\r\nimport { getProxyUrl, resolveSocketUrl } from '@/utils/utils';\r\nimport GroupInviteLinkSection from '@/components/(chatPopup)/components/GroupInviteLinkSection';\r\nimport PinnedMessagesSection from '@/components/(chatPopup)/components/PinnedMessagesSection';\r\n\r\nimport { HiPencil } from 'react-icons/hi';\r\nimport {\r\n  CiBellOn,\r\n  CiCirclePlus,\r\n  CiMapPin,\r\n  CiPlay1,\r\n  CiSettings,\r\n  CiUnread,\r\n  CiUser,\r\n  CiAlarmOn,\r\n  CiCircleInfo,\r\n  CiTrash,\r\n  CiNoWaitingSign,\r\n} from 'react-icons/ci';\r\nimport Image from 'next/image';\r\n\r\nimport ImageIconZalo from '@/components/svg/ICIconImageZalo';\r\nimport { HiEyeSlash, HiChevronRight, HiPlay } from 'react-icons/hi2';\r\nimport ICPin from '@/components/svg/ICPin';\r\nimport PopupProfile from '@/components/base/PopupProfile';\r\nimport { useRouter } from 'next/navigation';\r\nimport SuccessModal from '@/components/modal/SuccessModal';\r\nimport { confirmAlert } from '@/components/base/alert';\r\nimport { ConfirmModal } from '@/components/ui/ConfirmModal';\r\nimport { useToast } from '@/components/base/toast';\r\n\r\nimport AddToGroupModal from '@/components/(chatPopup)/components/AddToGroupModal';\r\nimport CommonGroupsModal from '@/components/(chatPopup)/components/CommonGroupsModal';\r\nimport { CiBookmarkCheck, CiEdit, CiImageOn, CiStar } from 'react-icons/ci';\r\nimport { AiOutlineUsergroupAdd } from 'react-icons/ai';\r\nimport { PiEyeSlashLight } from 'react-icons/pi';\r\nimport GroupAvatarSection from '@/components/(chatPopup)/components/GroupAvatarSection';\r\nimport CropImageModal from '@/components/base/CropImageModal';\r\n\r\ninterface ChatInfoPopupProps {\r\n  onClose: () => void;\r\n  onShowCreateGroup: () => void;\r\n  onMembersAdded: (users: User[]) => void;\r\n  members?: MemberInfo[];\r\n  onJumpToMessage: (messageId: string) => void;\r\n  onMemberRemoved?: (memberId: string, memberName: string) => void;\r\n  onRoleChange?: (memberId: string, memberName: string, newRole: 'ADMIN' | 'MEMBER') => void;\r\n  onChatAction: (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroup: boolean) => void;\r\n  reLoad?: () => void;\r\n  onLeftGroup?: () => void;\r\n  onRefresh?: () => void;\r\n  sendNotifyMessage?: (text: string, membersOverride?: string[]) => Promise<void> | void;\r\n  lastUpdated?: number;\r\n  initialSection?: 'reminder' | 'poll' | 'members' | null;\r\n  groups?: GroupConversation[];\r\n}\r\n\r\nexport default function ChatInfoPopup({\r\n  onClose,\r\n  onShowCreateGroup,\r\n  onMembersAdded,\r\n  members,\r\n  onJumpToMessage,\r\n  onMemberRemoved,\r\n  onRoleChange,\r\n  onChatAction,\r\n  reLoad,\r\n  onLeftGroup,\r\n  onRefresh,\r\n  sendNotifyMessage,\r\n  lastUpdated,\r\n  initialSection,\r\n  groups = [],\r\n}: ChatInfoPopupProps) {\r\n  const { messages, currentUser, allUsers, chatName, isGroup, selectedChat } = useChatContext();\r\n  const showToast = useToast();\r\n  const [openMember, setOpenMember] = useState(false);\r\n  const [groupAvatar, setGroupAvatar] = useState<string | undefined>(\r\n    isGroup ? (selectedChat as GroupConversation).avatar : undefined,\r\n  );\r\n  const [isGroupAvatarUploading, setIsGroupAvatarUploading] = useState(false);\r\n  const [groupName, setGroupName] = useState(chatName || '');\r\n  const [isRenameModalOpen, setIsRenameModalOpen] = useState(false);\r\n  const [renameInput, setRenameInput] = useState('');\r\n  const [previewMedia, setPreviewMedia] = useState<{ url: string; type: 'image' | 'video' } | null>(null);\r\n  const [confirmAction, setConfirmAction] = useState<'leave' | 'disband' | null>(null);\r\n  const [isReminderOpen, setIsReminderOpen] = useState(false);\r\n  const [isPinnedMessagesOpen, setIsPinnedMessagesOpen] = useState(false);\r\n  const [isPollOpen, setIsPollOpen] = useState(false);\r\n  const avatarInputRef = useRef<HTMLInputElement>(null);\r\n  const [isMuted, setIsMuted] = useState(false);\r\n  const [isAssetsModalOpen, setIsAssetsModalOpen] = useState(false);\r\n  const [assetsTab, setAssetsTab] = useState<'media' | 'file' | 'link'>('media');\r\n  const [isProfileOpen, setIsProfileOpen] = useState(false);\r\n  const [isBestFriend, setIsBestFriend] = useState(false);\r\n  const [callAlertEnabled, setCallAlertEnabled] = useState(true);\r\n  const [autoDeletePolicy, setAutoDeletePolicy] = useState<'off' | '24h' | '7d'>('off');\r\n  const [cropOpen, setCropOpen] = useState(false);\r\n  const [cropSrc, setCropSrc] = useState<string | null>(null);\r\n  const [cropFileName, setCropFileName] = useState<string>('group-avatar.jpg');\r\n  const [pendingReset, setPendingReset] = useState<(() => void) | null>(null);\r\n  const [showAutoDeleteModal, setShowAutoDeleteModal] = useState(false);\r\n  const [showConfirmClear, setShowConfirmClear] = useState(false);\r\n  const [showReportConfirm, setShowReportConfirm] = useState(false);\r\n  const router = useRouter();\r\n  const [showAddToGroupModal, setShowAddToGroupModal] = useState(false);\r\n  const [showCommonGroupsModal, setShowCommonGroupsModal] = useState(false);\r\n  const [showSuccessModal, setShowSuccessModal] = useState(false);\r\n\r\n  const commonGroups = useMemo(() => {\r\n    if (isGroup || !selectedChat || !groups) return [];\r\n    const partnerId = String((selectedChat as User)._id);\r\n    return groups.filter((g) => {\r\n      if (!Array.isArray(g.members)) return false;\r\n      return g.members.some((m) => {\r\n        const mId = typeof m === 'string' ? m : m._id || (m as { id?: string }).id;\r\n        return String(mId) === partnerId;\r\n      });\r\n    });\r\n  }, [groups, selectedChat, isGroup]);\r\n\r\n  const myId = String(currentUser._id || (currentUser as { id?: string })?.id || '');\r\n  const myRole = useMemo(() => {\r\n    if (!isGroup || !members) return 'MEMBER';\r\n    const member = members.find((m) => String(m._id || (m as { id?: string }).id) === myId);\r\n    return (member?.role || 'MEMBER') as GroupRole;\r\n  }, [members, myId, isGroup]);\r\n  const [editingPersonalNickname, setEditingPersonalNickname] = useState<{\r\n    id: string;\r\n    name: string;\r\n    currentVal: string;\r\n  } | null>(null);\r\n  const [editingSelfNickname, setEditingSelfNickname] = useState<{\r\n    id: string;\r\n    name: string;\r\n    currentVal: string;\r\n  } | null>(null);\r\n\r\n  const canLeaveGroup = isGroup;\r\n  const canDisbandGroup = isGroup && myRole === 'OWNER';\r\n\r\n  useEffect(() => {\r\n    setGroupName(chatName || '');\r\n  }, [chatName]);\r\n\r\n  useEffect(() => {\r\n    if (initialSection === 'reminder') {\r\n      setIsReminderOpen(true);\r\n      setIsPollOpen(false);\r\n      setOpenMember(false);\r\n    } else if (initialSection === 'poll') {\r\n      setIsPollOpen(true);\r\n      setIsReminderOpen(false);\r\n      setOpenMember(false);\r\n    } else if (initialSection === 'members') {\r\n      setIsReminderOpen(false);\r\n      setIsPollOpen(false);\r\n      if (isGroup) setOpenMember(true);\r\n      else setOpenMember(false);\r\n    }\r\n  }, [initialSection, isGroup]);\r\n\r\n  const {\r\n    localIsPinned,\r\n    localIsHidden,\r\n    openItems,\r\n    activeMenuId,\r\n    setActiveMenuId,\r\n    handleChatActionClick,\r\n    toggleItem,\r\n    closeMenu,\r\n    mediaList,\r\n    mediaGroups,\r\n    fileList,\r\n    fileGroups,\r\n    linkList,\r\n    linkGroups,\r\n    mediaTotal,\r\n    fileTotal,\r\n    linkTotal,\r\n    isMediaExpanded,\r\n    isFileExpanded,\r\n    isLinkExpanded,\r\n    fetchAssets,\r\n  } = useChatInfoPopup({\r\n    selectedChat,\r\n    isGroup,\r\n    messages,\r\n    currentUser,\r\n    onChatAction,\r\n  });\r\n  const openAddToGroupModal = useCallback(() => {\r\n    setShowAddToGroupModal(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (mediaList.length === 0) {\r\n      void fetchAssets('media', false);\r\n    }\r\n  }, [mediaList.length, fetchAssets]);\r\n  const latestImages = useMemo(\r\n    () =>\r\n      [...mediaList]\r\n        .filter((m) => m.type === 'image')\r\n        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))\r\n        .slice(0, 4),\r\n    [mediaList],\r\n  );\r\n\r\n  const getOneToOneRoomId = (user1Id: string | number, user2Id: string | number) => {\r\n    return [user1Id, user2Id].sort().join('_');\r\n  };\r\n  const roomId = isGroup\r\n    ? String((selectedChat as GroupConversation)._id)\r\n    : getOneToOneRoomId(String(currentUser._id), String((selectedChat as User)._id));\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const k = `roomMuted:${roomId}:${String(currentUser._id)}`;\r\n      const v = localStorage.getItem(k) === 'true';\r\n      setIsMuted(v);\r\n    } catch {}\r\n  }, [roomId, currentUser._id]);\r\n\r\n  const [partnerNicknameOverride, setPartnerNicknameOverride] = useState<string>(\r\n    isGroup ? '' : String((selectedChat as User).nicknames?.[myId] || ''),\r\n  );\r\n  const [selfNicknameOverride, setSelfNicknameOverride] = useState<string>(() => {\r\n    const partnerId = String((selectedChat as User)._id);\r\n    return String(currentUser.nicknames?.[partnerId] || '');\r\n  });\r\n  useEffect(() => {\r\n    if (isGroup) return;\r\n    setPartnerNicknameOverride(String((selectedChat as User).nicknames?.[myId] || ''));\r\n  }, [isGroup, selectedChat, myId]);\r\n  useEffect(() => {\r\n    if (isGroup) return;\r\n    const partnerId = String((selectedChat as User)._id);\r\n    (async () => {\r\n      try {\r\n        const res = await fetch('/api/users', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ action: 'getById', _id: String(currentUser._id) }),\r\n        });\r\n        const data = await res.json();\r\n        const doc = data?.row ?? data;\r\n        const nn = doc?.nicknames?.[partnerId] ?? '';\r\n        setSelfNicknameOverride(String(nn || ''));\r\n      } catch {}\r\n    })();\r\n  }, [isGroup, selectedChat, currentUser._id]);\r\n\r\n  const handleToggleMediaExpanded = useCallback(() => {\r\n    void fetchAssets('media', !isMediaExpanded);\r\n  }, [fetchAssets, isMediaExpanded]);\r\n\r\n  const handleToggleFileExpanded = useCallback(() => {\r\n    void fetchAssets('file', !isFileExpanded);\r\n  }, [fetchAssets, isFileExpanded]);\r\n\r\n  const handleToggleLinkExpanded = useCallback(() => {\r\n    void fetchAssets('link', !isLinkExpanded);\r\n  }, [fetchAssets, isLinkExpanded]);\r\n\r\n  useEffect(() => {\r\n    if (isGroup) return;\r\n    try {\r\n      const partnerId = String((selectedChat as User)._id);\r\n      const bfRaw = localStorage.getItem(`best_friend_${partnerId}`);\r\n      setIsBestFriend(bfRaw ? bfRaw === '1' : false);\r\n      const callRaw = localStorage.getItem(`call_alert_${roomId}`);\r\n      setCallAlertEnabled(callRaw ? callRaw === '1' : true);\r\n      const adRaw = localStorage.getItem(`auto_delete_${roomId}`);\r\n      const val = adRaw === '24h' ? '24h' : adRaw === '7d' ? '7d' : 'off';\r\n      setAutoDeletePolicy(val);\r\n    } catch {}\r\n  }, [isGroup, selectedChat, roomId]);\r\n\r\n  const handleChangeGroupAvatar = useCallback(\r\n    async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      const file = e.target.files?.[0];\r\n      if (!file || !isGroup) return;\r\n      try {\r\n        const inputEl = e.target;\r\n        const reader = new FileReader();\r\n        reader.onload = () => {\r\n          setCropSrc(String(reader.result || ''));\r\n          setCropFileName(file.name || 'group-avatar.jpg');\r\n          setPendingReset(() => () => {\r\n            inputEl.value = '';\r\n          });\r\n          setCropOpen(true);\r\n        };\r\n        reader.readAsDataURL(file);\r\n      } catch {}\r\n    },\r\n    [isGroup, selectedChat, currentUser._id, currentUser.name, reLoad, sendNotifyMessage],\r\n  );\r\n\r\n  const handleRenameGroup = () => {\r\n    setRenameInput(groupName);\r\n    setIsRenameModalOpen(true);\r\n  };\r\n\r\n  const handleSubmitRenameGroup = async () => {\r\n    if (!isGroup || renameInput.trim() === groupName) {\r\n      setIsRenameModalOpen(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'renameGroup',\r\n          conversationId: (selectedChat as GroupConversation)._id,\r\n          data: { name: renameInput.trim() },\r\n        }),\r\n      });\r\n\r\n      if (!res.ok) throw new Error();\r\n\r\n      setGroupName(renameInput.trim());\r\n      setIsRenameModalOpen(false);\r\n      try {\r\n        const actorName = currentUser.name || 'Một thành viên';\r\n        const text = `${actorName} đã đổi tên nhóm thành \"${renameInput.trim()}\".`;\r\n        await sendNotifyMessage?.(text);\r\n      } catch {}\r\n      try {\r\n        const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n        const roomIdStr = String((selectedChat as GroupConversation)._id);\r\n        const membersArr = (members || []).map((m) => ({\r\n          _id: String((m as MemberInfo)._id ?? (m as { id?: string }).id ?? ''),\r\n        }));\r\n        sock.emit('group_renamed', {\r\n          roomId: roomIdStr,\r\n          groupName: renameInput.trim(),\r\n          members: membersArr,\r\n          sender: String(currentUser._id),\r\n          senderName: currentUser.name,\r\n        });\r\n        setTimeout(() => sock.disconnect(), 500);\r\n      } catch {}\r\n      reLoad?.();\r\n    } catch {\r\n      alert('Đổi tên nhóm thất bại.');\r\n    }\r\n  };\r\n\r\n  const handleLeaveGroup = async () => {\r\n    // Logic giống cũ, rút gọn\r\n    try {\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'leaveGroup',\r\n          conversationId: (selectedChat as GroupConversation)._id,\r\n          _id: currentUser._id,\r\n        }),\r\n      });\r\n      if (!res.ok) throw new Error();\r\n      const name = currentUser.name || 'Một thành viên';\r\n      const text = `${name} đã rời nhóm`;\r\n      await sendNotifyMessage?.(text);\r\n      try {\r\n        const roomIdStr = String((selectedChat as GroupConversation)._id);\r\n        const myIdStr = String(currentUser._id);\r\n        const nextMembers = (members || []).filter((m) => {\r\n          const id = String((m as MemberInfo)._id ?? (m as { id?: string }).id ?? '');\r\n          return id !== myIdStr;\r\n        });\r\n        const payloadMembers = nextMembers.map((m) => ({\r\n          _id: String((m as MemberInfo)._id ?? (m as { id?: string }).id ?? ''),\r\n          role: (m as MemberInfo).role,\r\n          name: (m as MemberInfo).name,\r\n          avatar: (m as MemberInfo).avatar,\r\n        }));\r\n        const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n        sock.emit('group_members_updated', {\r\n          roomId: roomIdStr,\r\n          members: payloadMembers,\r\n          sender: myIdStr,\r\n          senderName: currentUser.name,\r\n        });\r\n        setTimeout(() => sock.disconnect(), 500);\r\n      } catch {}\r\n      reLoad?.();\r\n      onLeftGroup?.();\r\n      onClose();\r\n    } catch {\r\n      alert('Rời nhóm thất bại.');\r\n    }\r\n  };\r\n\r\n  const handleDisbandGroup = async () => {\r\n    try {\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'disbandGroup',\r\n          conversationId: (selectedChat as GroupConversation)._id,\r\n          _id: currentUser._id,\r\n        }),\r\n      });\r\n      if (!res.ok) throw new Error();\r\n      onClose();\r\n      onLeftGroup?.();\r\n      reLoad?.();\r\n    } catch {\r\n      alert('Giải tán nhóm thất bại.');\r\n    }\r\n  };\r\n\r\n  const handleGenerateInviteLink = useCallback(async (): Promise<string> => {\r\n    if (!isGroup) throw new Error('Not a group');\r\n\r\n    const groupId = (selectedChat as GroupConversation)._id;\r\n\r\n    const res = await fetch('/api/groups/invite', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        action: 'generate',\r\n        groupId,\r\n      }),\r\n    });\r\n\r\n    const data = await res.json();\r\n\r\n    if (!res.ok || !data.success) {\r\n      throw new Error(data.message || 'Tạo link thất bại');\r\n    }\r\n\r\n    return data.inviteCode;\r\n  }, [isGroup, selectedChat]);\r\n\r\n  const handleRegenerateInviteLink = useCallback(async (): Promise<string> => {\r\n    if (!isGroup) throw new Error('Not a group');\r\n\r\n    const groupId = (selectedChat as GroupConversation)._id;\r\n\r\n    const res = await fetch('/api/groups/invite', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        action: 'regenerate',\r\n        groupId,\r\n      }),\r\n    });\r\n\r\n    const data = await res.json();\r\n\r\n    if (!res.ok || !data.success) {\r\n      throw new Error(data.message || 'Tạo link mới thất bại');\r\n    }\r\n\r\n    reLoad?.();\r\n    return data.inviteCode;\r\n  }, [isGroup, selectedChat, reLoad]);\r\n\r\n  const handleUpdateNicknameForPartner = useCallback(\r\n    async (nickname: string, options?: { silent?: boolean }) => {\r\n      if (!selectedChat?._id || !currentUser?._id) return;\r\n      try {\r\n        const v = String(nickname || '').trim();\r\n        setPartnerNicknameOverride(v);\r\n        const res = await fetch('/api/users', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            action: 'updateNickname',\r\n            roomId: (selectedChat as User)._id,\r\n            currentUserId: currentUser._id,\r\n            data: { nickname: v },\r\n          }),\r\n        });\r\n        const ok = res.ok;\r\n        if (!ok) throw new Error();\r\n        try {\r\n          const room = getOneToOneRoomId(String(currentUser._id), String((selectedChat as User)._id));\r\n          window.dispatchEvent(\r\n            new CustomEvent('roomNicknamesUpdated', {\r\n              detail: { roomId: room, targetUserId: String((selectedChat as User)._id), nickname: v },\r\n            }),\r\n          );\r\n        } catch {}\r\n        if (sendNotifyMessage && !options?.silent) {\r\n          const actorName = currentUser.name || 'Bạn';\r\n          const targetName = (selectedChat as User).name || (selectedChat as User).username || 'Người dùng';\r\n          const msg = v\r\n            ? `${actorName} đã đặt biệt danh cho ${targetName} là \"${v}\".`\r\n            : `${actorName} đã xóa biệt danh của ${targetName}.`;\r\n          void sendNotifyMessage(msg);\r\n        }\r\n      } catch {\r\n        setPartnerNicknameOverride(\r\n          String((selectedChat as User).nicknames?.[myId] || (selectedChat as User).name || ''),\r\n        );\r\n        alert('Cập nhật biệt danh thất bại');\r\n      }\r\n    },\r\n    [selectedChat, currentUser, sendNotifyMessage, myId],\r\n  );\r\n\r\n  const handleUpdateNicknameForMe = useCallback(\r\n    async (nickname: string) => {\r\n      if (!selectedChat?._id || !currentUser?._id) return;\r\n      try {\r\n        const partnerId = String((selectedChat as User)._id);\r\n        const v = String(nickname || '').trim();\r\n        setSelfNicknameOverride(v);\r\n        const res = await fetch('/api/users', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            action: 'updateNickname',\r\n            roomId: currentUser._id,\r\n            currentUserId: (selectedChat as User)._id,\r\n            data: { nickname: v },\r\n          }),\r\n        });\r\n        const ok = res.ok;\r\n        if (!ok) throw new Error();\r\n        try {\r\n          const room = getOneToOneRoomId(String(currentUser._id), String(partnerId));\r\n          window.dispatchEvent(\r\n            new CustomEvent('roomNicknamesUpdated', {\r\n              detail: { roomId: room, targetUserId: String(currentUser._id), nickname: v },\r\n            }),\r\n          );\r\n        } catch {}\r\n        if (sendNotifyMessage) {\r\n          const actorName = currentUser.name || 'Bạn';\r\n          const msg = v\r\n            ? `${actorName} đã đặt biệt danh của chính mình là \"${v}\".`\r\n            : `${actorName} đã xóa biệt danh của chính mình.`;\r\n          void sendNotifyMessage(msg);\r\n        }\r\n      } catch {\r\n        const partnerId = String((selectedChat as User)._id);\r\n        setSelfNicknameOverride(String(currentUser.nicknames?.[partnerId] || currentUser.name || ''));\r\n        alert('Cập nhật biệt danh thất bại');\r\n      }\r\n    },\r\n    [selectedChat, currentUser, sendNotifyMessage],\r\n  );\r\n\r\n  return (\r\n    <>\r\n      {isReminderOpen ? (\r\n        <ReminderList onClose={() => setIsReminderOpen(false)} />\r\n      ) : isPinnedMessagesOpen ? (\r\n        <PinnedMessagesList onClose={() => setIsPinnedMessagesOpen(false)} onJumpToMessage={onJumpToMessage} />\r\n      ) : isPollOpen ? (\r\n        <PollList onClose={() => setIsPollOpen(false)} onRefresh={onRefresh} />\r\n      ) : (\r\n        <div className=\"flex flex-col h-full bg-gray-50 overflow-hidden\">\r\n          {/* Header cố định */}\r\n          <div className=\"bg-blue-400 to-indigo-700 text-white p-3 flex items-center justify-between shadow-lg\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                onClick={onClose}\r\n                className=\"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200 block sm:hidden\"\r\n                aria-label=\"Quay lại\"\r\n              >\r\n                <HiChevronLeft className=\"w-5 h-5\" />\r\n              </button>\r\n              <h2 className=\"text-lg font-semibold\">Tùy chọn</h2>\r\n            </div>\r\n            <div className=\"hidden sm:block\">\r\n              <button\r\n                onClick={onClose}\r\n                className=\"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200\"\r\n                aria-label=\"Đóng\"\r\n              >\r\n                <HiX className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Nội dung cuộn */}\r\n          <div className=\"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300\">\r\n            <div className=\"space-y-3  bg-gray-200\">\r\n              <div className=\"bg-white p-5\">\r\n                {/* Avatar + Tên */}\r\n                {isGroup ? (\r\n                  <GroupAvatarSection\r\n                    isGroup={isGroup}\r\n                    groupAvatar={groupAvatar}\r\n                    groupName={groupName}\r\n                    chatName={chatName}\r\n                    isGroupAvatarUploading={isGroupAvatarUploading}\r\n                    avatarInputRef={avatarInputRef}\r\n                    onChangeGroupAvatar={handleChangeGroupAvatar}\r\n                    onRenameGroup={handleRenameGroup}\r\n                    myRole={myRole}\r\n                  />\r\n                ) : (\r\n                  <UserAvatarSection\r\n                    userName={\r\n                      partnerNicknameOverride ||\r\n                      (selectedChat as User).nicknames?.[myId] ||\r\n                      (selectedChat as User).name ||\r\n                      (selectedChat as User).username ||\r\n                      'Người dùng'\r\n                    }\r\n                    userAvatar={(selectedChat as User).avatar}\r\n                    onUpdateNickname={handleUpdateNicknameForPartner}\r\n                  />\r\n                )}\r\n\r\n                <ChatQuickActions\r\n                  isGroup={isGroup}\r\n                  localIsPinned={localIsPinned}\r\n                  localIsHidden={localIsHidden}\r\n                  onPinToggle={() => handleChatActionClick('pin')}\r\n                  onHideToggle={() => handleChatActionClick('hide')}\r\n                  onCreateGroup={() => {\r\n                    onShowCreateGroup();\r\n                    onClose();\r\n                  }}\r\n                  onOpenMembers={() => setOpenMember(true)}\r\n                  onSearchMessages={() => {\r\n                    try {\r\n                      const ev = new CustomEvent('openRoomSearch', { detail: { roomId } });\r\n                      window.dispatchEvent(ev);\r\n                    } catch {}\r\n                  }}\r\n                  onChangeWallpaper={() => {\r\n                    alert('Tính năng đổi hình nền sẽ sớm có mặt.');\r\n                  }}\r\n                  isMuted={isMuted}\r\n                  onToggleMute={() => {\r\n                    const next = !isMuted;\r\n                    setIsMuted(next);\r\n                    try {\r\n                      const k = `roomMuted:${roomId}:${String(currentUser._id)}`;\r\n                      localStorage.setItem(k, String(next));\r\n                      const evt = new CustomEvent('roomMutedChanged', {\r\n                        detail: { roomId, muted: next },\r\n                      });\r\n                      window.dispatchEvent(evt);\r\n                    } catch {}\r\n                  }}\r\n                  onOpenProfile={() => {\r\n                    if (!isGroup) {\r\n                      const partnerId = String((selectedChat as User)._id);\r\n                      if (partnerId) router.push(`/profile/${partnerId}`);\r\n                    }\r\n                  }}\r\n                />\r\n              </div>\r\n\r\n              {isGroup && (\r\n                <div className=\"bg-white  border border-gray-200\">\r\n                  <button\r\n                    className=\"cursor-pointer w-full p-2 flex items-center justify-between hover:bg-gray-50 transition-all\"\r\n                    title=\"Thêm mô tả nhóm\"\r\n                  >\r\n                    <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Thêm mô tả nhóm</span>\r\n                    <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              {!isGroup && (\r\n                <div className=\"bg-white shadow-sm border border-gray-100 overflow-hidden mt-2\">\r\n                  <div className=\"divide-y divide-gray-100\">\r\n                    <button\r\n                      onClick={() => {\r\n                        const partnerId = String((selectedChat as User)._id);\r\n                        const name = (selectedChat as User).name || (selectedChat as User).username || 'Người dùng';\r\n                        setEditingPersonalNickname({\r\n                          id: partnerId,\r\n                          name,\r\n                          currentVal: partnerNicknameOverride,\r\n                        });\r\n                      }}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <CiEdit className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Đổi tên gọi nhớ</span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n\r\n                    <div className=\"px-5 py-4 flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <CiStar className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Đánh dấu bạn thân</span>\r\n                      </div>\r\n                      <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          className=\"sr-only peer\"\r\n                          checked={isBestFriend}\r\n                          onChange={() => {\r\n                            alert('Chức năng đang được hoàn thiện');\r\n                          }}\r\n                        />\r\n                        <div className=\"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors\"></div>\r\n                        <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow\"></div>\r\n                      </label>\r\n                    </div>\r\n\r\n                    <button\r\n                      onClick={() => alert('Chức năng đang được hoàn thiện')}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiBookmarkCheck className=\"w-6 h-6 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Nhật ký chung</span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"bg-white  shadow-sm border border-gray-200 mt-2\">\r\n                <button\r\n                  onClick={() => {\r\n                    setIsAssetsModalOpen(true);\r\n                    void fetchAssets('media', true);\r\n                    void fetchAssets('file', true);\r\n                    void fetchAssets('link', true);\r\n                  }}\r\n                  className=\"cursor-pointer w-full py-4 px-5 flex items-center justify-between hover:bg-gray-50 transition-all duration-200 group\"\r\n                >\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <CiImageOn className=\"w-5 h-5\" />\r\n                    <span className=\"text-[1.125rem] md:text-[1rem] text-gray-900\">Ảnh, file, link</span>\r\n                  </div>\r\n\r\n                  <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                </button>\r\n                <div className=\"pl-5 pr-1 pb-2 border-t border-gray-100\">\r\n                  {latestImages.length > 0 ? (\r\n                    <div className=\"grid grid-cols-5 gap-[0.125rem] mt-2\">\r\n                      {latestImages.map((img) => (\r\n                        <div\r\n                          key={img.id}\r\n                          className=\"relative aspect-square rounded-[0.25rem] overflow-hidden bg-gray-100 cursor-pointer group\"\r\n                          onClick={() => {\r\n                            setAssetsTab('media');\r\n                            setIsAssetsModalOpen(true);\r\n                          }}\r\n                        >\r\n                          <Image\r\n                            width={200}\r\n                            height={200}\r\n                            src={getProxyUrl(img.url)}\r\n                            alt=\"Ảnh\"\r\n                            className=\"w-full h-full object-cover\"\r\n                          />\r\n\r\n                          <ItemDropdownMenu\r\n                            itemUrl={img.url}\r\n                            itemId={img.id}\r\n                            fileName={img.fileName}\r\n                            activeMenuId={activeMenuId}\r\n                            onClose={closeMenu}\r\n                            onJumpToMessage={onJumpToMessage}\r\n                            onShareById={(mid) => {\r\n                              try {\r\n                                const evt = new CustomEvent('shareMessage', { detail: { messageId: mid } });\r\n                                window.dispatchEvent(evt);\r\n                              } catch {}\r\n                            }}\r\n                          />\r\n                        </div>\r\n                      ))}\r\n                      <div\r\n                        className=\"relative aspect-square rounded-[0.25rem] overflow-hidden bg-gray-100 cursor-pointer group flex items-center justify-center\"\r\n                        onClick={() => {\r\n                          setAssetsTab('media');\r\n                          setIsAssetsModalOpen(true);\r\n                          void fetchAssets('media', true);\r\n                          void fetchAssets('file', true);\r\n                          void fetchAssets('link', true);\r\n                        }}\r\n                        title=\"Xem tất cả ảnh, file, link\"\r\n                      >\r\n                        <CiPlay1 className=\"w-4 h-4 text-gray-400\" />\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"text-xs text-gray-500\">Chưa có ảnh nào</div>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"pt-2\">\r\n                  <ReminderSection onOpen={() => setIsReminderOpen(true)} />\r\n                  <PinnedMessagesSection onOpen={() => setIsPinnedMessagesOpen(true)} />\r\n                  {isGroup && <PollSection onOpen={() => setIsPollOpen(true)} />}\r\n                </div>\r\n              </div>\r\n\r\n              {!isGroup && (\r\n                <div className=\"bg-white shadow-sm border border-gray-100 overflow-hidden\">\r\n                  <div className=\"divide-y divide-gray-100\">\r\n                    <button\r\n                      onClick={() => {\r\n                        try {\r\n                          const w = window as Window & { __createGroupInitialMemberIds?: string[] };\r\n                          w.__createGroupInitialMemberIds = [String((selectedChat as User)._id)];\r\n                        } catch {}\r\n                        onShowCreateGroup();\r\n                      }}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiCirclePlus className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">\r\n                          Tạo nhóm với {(selectedChat as User).name || (selectedChat as User).username || 'Người dùng'}\r\n                        </span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => {\r\n                        openAddToGroupModal();\r\n                      }}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between   hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <AiOutlineUsergroupAdd className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800 \">\r\n                          Thêm {(selectedChat as User).name || (selectedChat as User).username || 'Người dùng'} vào nhóm\r\n                        </span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => setShowCommonGroupsModal(true)}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiUser className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Xem nhóm chung</span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"bg-white space-y-2\">\r\n                {isGroup && (\r\n                  <GroupMembersSection\r\n                    isGroup={isGroup}\r\n                    groupName={groupName}\r\n                    membersCount={(selectedChat as GroupConversation).members.length}\r\n                    onOpenMembers={() => setOpenMember(true)}\r\n                  />\r\n                )}\r\n                {isGroup && (\r\n                  <GroupInviteLinkSection\r\n                    groupId={(selectedChat as GroupConversation)._id}\r\n                    inviteCode={(selectedChat as GroupConversation).inviteCode}\r\n                    onGenerateLink={handleGenerateInviteLink}\r\n                    onRegenerateLink={handleRegenerateInviteLink}\r\n                  />\r\n                )}\r\n              </div>\r\n              <div className=\"bg-white  shadow-sm border border-gray-100 overflow-hidden\">\r\n                <div className=\"divide-y divide-gray-100\">\r\n                  <div className=\"px-5 py-4 flex items-center justify-between\">\r\n                    <div className=\"flex gap-4 items-center\">\r\n                      <CiMapPin className=\"w-5 h-5 text-gray-600\" />\r\n                      <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Ghim trò chuyện</span>\r\n                    </div>\r\n\r\n                    <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"sr-only peer\"\r\n                        checked={localIsPinned}\r\n                        onChange={() => handleChatActionClick('pin')}\r\n                      />\r\n                      <div className=\"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors\"></div>\r\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow\"></div>\r\n                    </label>\r\n                  </div>\r\n                  <div className=\"px-5 py-4 flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                      <CiUnread className=\"w-5 h-5 text-gray-500\" />\r\n                      <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Ẩn trò chuyện</span>\r\n                    </div>\r\n\r\n                    <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"sr-only peer\"\r\n                        checked={localIsHidden}\r\n                        onChange={() => handleChatActionClick('hide')}\r\n                      />\r\n                      <div className=\"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors\"></div>\r\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow\"></div>\r\n                    </label>\r\n                  </div>\r\n                  {!isGroup && (\r\n                    <div className=\"px-5 py-4 flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiBellOn className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Báo cuộc gọi đến</span>\r\n                      </div>\r\n                      <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          className=\"sr-only peer\"\r\n                          checked={callAlertEnabled}\r\n                          onChange={() => {\r\n                            alert('Chức năng đang được hoàn thiện');\r\n                          }}\r\n                        />\r\n                        <div className=\"w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 transition-colors\"></div>\r\n                        <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow\"></div>\r\n                      </label>\r\n                    </div>\r\n                  )}\r\n                  {!isGroup && (\r\n                    <button\r\n                      onClick={() => alert('Chức năng đang được hoàn thiện')}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiSettings className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Cài đặt cá nhân</span>\r\n                      </div>\r\n                      <HiChevronRight className=\"w-4 h-4 text-gray-400\" />\r\n                    </button>\r\n                  )}\r\n                  {!isGroup && (\r\n                    <button\r\n                      onClick={() => alert('Chức năng đang được hoàn thiện')}\r\n                      // onClick={() => setShowAutoDeleteModal(true)}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiAlarmOn className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Tin nhắn tự xóa</span>\r\n                      </div>\r\n                      <span className=\"text-sm font-semibold text-gray-600\">\r\n                        {autoDeletePolicy === 'off' ? 'Không tự xóa' : autoDeletePolicy === '24h' ? '24 giờ' : '7 ngày'}\r\n                      </span>\r\n                    </button>\r\n                  )}\r\n                  {!isGroup && (\r\n                    <button\r\n                      onClick={() => setShowReportConfirm(true)}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiCircleInfo className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Báo xấu</span>\r\n                      </div>\r\n                    </button>\r\n                  )}\r\n                  {(!isGroup || (isGroup && myRole === 'OWNER')) && (\r\n                    <button\r\n                      // onClick={() => setShowConfirmClear(true)}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiTrash className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Xóa lịch sử</span>\r\n                      </div>\r\n                    </button>\r\n                  )}\r\n                  {!isGroup && (\r\n                    <button\r\n                      onClick={() => alert('Chức năng đang được hoàn thiện')}\r\n                      className=\"cursor-pointer w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-all duration-200\"\r\n                    >\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <CiNoWaitingSign className=\"w-5 h-5 text-gray-600\" />\r\n                        <span className=\"text-[1.125rem] md:text-[1rem] text-gray-800\">Quản lý chặn</span>\r\n                      </div>\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {isGroup && (\r\n                <GroupDangerZone\r\n                  canLeaveGroup={canLeaveGroup}\r\n                  canDisbandGroup={canDisbandGroup}\r\n                  onLeaveClick={() => setConfirmAction('leave')}\r\n                  onDisbandClick={() => setConfirmAction('disband')}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {isProfileOpen && !isGroup && (\r\n        <PopupProfile isOpen={isProfileOpen} onClose={() => setIsProfileOpen(false)} user={selectedChat as User} />\r\n      )}\r\n      {showAutoDeleteModal && !isGroup && (\r\n        <div\r\n          className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-md px-4\"\r\n          onClick={() => setShowAutoDeleteModal(false)}\r\n        >\r\n          <div\r\n            className=\"w-full max-w-[25rem] bg-white rounded-lg shadow-2xl h-auto max-h-[90vh] overflow-hidden no-scrollbar relative flex flex-col\"\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <div className=\"flex items-center justify-between px-4 py-3 border-b border-gray-100\">\r\n              <h3 className=\"text-base font-bold text-gray-900\">Tin nhắn tự xóa</h3>\r\n              <button\r\n                onClick={() => setShowAutoDeleteModal(false)}\r\n                className=\"text-gray-500 hover:text-gray-700 cursor-pointer\"\r\n              >\r\n                <HiX className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-4 space-y-2\">\r\n              <button\r\n                onClick={() => {\r\n                  setAutoDeletePolicy('off');\r\n                  try {\r\n                    localStorage.setItem(`auto_delete_${roomId}`, 'off');\r\n                  } catch {}\r\n                  setShowAutoDeleteModal(false);\r\n                }}\r\n                className={`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${autoDeletePolicy === 'off' ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-100'}`}\r\n              >\r\n                Không tự xóa\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setAutoDeletePolicy('24h');\r\n                  try {\r\n                    localStorage.setItem(`auto_delete_${roomId}`, '24h');\r\n                  } catch {}\r\n                  setShowAutoDeleteModal(false);\r\n                }}\r\n                className={`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${autoDeletePolicy === '24h' ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-100'}`}\r\n              >\r\n                24 giờ\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setAutoDeletePolicy('7d');\r\n                  try {\r\n                    localStorage.setItem(`auto_delete_${roomId}`, '7d');\r\n                  } catch {}\r\n                  setShowAutoDeleteModal(false);\r\n                }}\r\n                className={`w-full cursor-pointer px-4 py-3 rounded-xl text-left ${autoDeletePolicy === '7d' ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-100'}`}\r\n              >\r\n                7 ngày\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {/* Modals */}\r\n      {openMember && isGroup && (\r\n        <ModalMembers\r\n          allUsers={allUsers}\r\n          currentUser={currentUser}\r\n          isOpen={openMember}\r\n          onClose={() => setOpenMember(false)}\r\n          members={members || []}\r\n          groupName={chatName}\r\n          onMembersAdded={onMembersAdded}\r\n          conversationId={selectedChat._id}\r\n          onMemberRemoved={onMemberRemoved}\r\n          onRoleChange={onRoleChange}\r\n          sendNotifyMessage={sendNotifyMessage}\r\n          lastUpdated={lastUpdated}\r\n        />\r\n      )}\r\n\r\n      {editingPersonalNickname && !isGroup && (\r\n        <div\r\n          className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/20 backdrop-blur-md px-4\"\r\n          onClick={() => setEditingPersonalNickname(null)}\r\n        >\r\n          <div\r\n            className=\"w-full max-w-[400px] bg-white rounded-lg shadow-2xl h-auto max-h-[90vh] overflow-hidden no-scrollbar relative flex flex-col\"\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <div className=\"flex items-center justify-between px-4 py-3 border-b border-gray-100\">\r\n              <h3 className=\"text-base font-bold text-gray-900\">Đặt biệt danh</h3>\r\n              <button\r\n                onClick={() => setEditingPersonalNickname(null)}\r\n                className=\"text-gray-500 hover:text-gray-700 cursor-pointer\"\r\n              >\r\n                <HiX className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-4 space-y-4\">\r\n              <p className=\"text-sm text-gray-600\">\r\n                Đặt biệt danh cho <b>{editingPersonalNickname.name}</b> trong cuộc trò chuyện này.\r\n              </p>\r\n              <input\r\n                type=\"text\"\r\n                autoFocus\r\n                defaultValue={editingPersonalNickname.currentVal || editingPersonalNickname.name}\r\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-[0.5rem] focus:outline-none\"\r\n                placeholder=\"Nhập biệt danh...\"\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    const v = (e.currentTarget.value || '').trim();\r\n                    void handleUpdateNicknameForPartner(v);\r\n                    setEditingPersonalNickname(null);\r\n                  }\r\n                }}\r\n                id=\"personal-nickname-input\"\r\n              />\r\n              <div className=\"flex gap-2 justify-end pt-2\">\r\n                <button\r\n                  onClick={() => setEditingPersonalNickname(null)}\r\n                  className=\"px-4 py-2 cursor-pointer text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-colors\"\r\n                >\r\n                  Hủy\r\n                </button>\r\n                <button\r\n                  onClick={() => {\r\n                    const val = (document.getElementById('personal-nickname-input') as HTMLInputElement)?.value;\r\n                    const v = String(val || '').trim();\r\n                    void handleUpdateNicknameForPartner(v);\r\n                    setEditingPersonalNickname(null);\r\n                  }}\r\n                  className=\"px-4 py-2 cursor-pointer bg-blue-500 text-white font-bold rounded-[0.5rem] hover:bg-blue-600 transition-all shadow-lg shadow-blue-200\"\r\n                >\r\n                  Lưu\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {showAddToGroupModal && !isGroup && (\r\n        <AddToGroupModal\r\n          isOpen={showAddToGroupModal}\r\n          onClose={() => setShowAddToGroupModal(false)}\r\n          currentUser={currentUser}\r\n          selectedChat={selectedChat as User}\r\n          onShowCreateGroup={() => {\r\n            if (window.innerWidth < 768) {\r\n              setShowAddToGroupModal(false);\r\n              setTimeout(() => onShowCreateGroup(), 300);\r\n            } else {\r\n              onShowCreateGroup();\r\n            }\r\n          }}\r\n          reLoad={reLoad}\r\n        />\r\n      )}\r\n      {showCommonGroupsModal && !isGroup && (\r\n        <CommonGroupsModal\r\n          isOpen={showCommonGroupsModal}\r\n          onClose={() => setShowCommonGroupsModal(false)}\r\n          groups={commonGroups}\r\n          partner={selectedChat as User}\r\n          onShowCreateGroup={() => {\r\n            if (window.innerWidth < 768) {\r\n              setShowCommonGroupsModal(false);\r\n              setTimeout(() => {\r\n                try {\r\n                  const w = window as Window & { __createGroupInitialMemberIds?: string[] };\r\n                  w.__createGroupInitialMemberIds = [String((selectedChat as User)._id)];\r\n                } catch {}\r\n                onShowCreateGroup();\r\n              }, 300);\r\n            } else {\r\n              try {\r\n                const w = window as Window & { __createGroupInitialMemberIds?: string[] };\r\n                w.__createGroupInitialMemberIds = [String((selectedChat as User)._id)];\r\n              } catch {}\r\n              onShowCreateGroup();\r\n            }\r\n          }}\r\n          onShowAddToGroup={() => {\r\n            setShowCommonGroupsModal(false);\r\n            setTimeout(() => setShowAddToGroupModal(true), 300);\r\n          }}\r\n        />\r\n      )}\r\n      <SuccessModal\r\n        isOpen={showSuccessModal}\r\n        onClose={() => setShowSuccessModal(false)}\r\n        title=\"Thành công\"\r\n        description=\"Đã thêm thành viên vào nhóm thành công.\"\r\n      />\r\n      {showConfirmClear && (\r\n        <ConfirmModal\r\n          title=\"Xóa lịch sử\"\r\n          message=\"Bạn có chắc muốn xóa toàn bộ lịch sử trò chuyện?\"\r\n          onCancel={() => setShowConfirmClear(false)}\r\n          onConfirm={async () => {\r\n            setShowConfirmClear(false);\r\n            try {\r\n              const res = await fetch('/api/messages', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ action: 'clearHistory', roomId }),\r\n              });\r\n              if (res.ok) {\r\n                showToast({ type: 'success', message: 'Đã xóa lịch sử trò chuyện' });\r\n                try {\r\n                  window.dispatchEvent(new CustomEvent('chatHistoryCleared', { detail: { roomId } }));\r\n                } catch {}\r\n                try {\r\n                  onRefresh?.();\r\n                } catch {}\r\n              } else {\r\n                showToast({ type: 'error', message: 'Xóa lịch sử thất bại' });\r\n              }\r\n            } catch {\r\n              showToast({ type: 'error', message: 'Lỗi khi xóa lịch sử' });\r\n            }\r\n          }}\r\n          confirmText=\"Xóa\"\r\n          variant=\"danger\"\r\n        />\r\n      )}\r\n      {showReportConfirm && (\r\n        <ConfirmModal\r\n          title=\"Báo xấu\"\r\n          message=\"Bạn có muốn báo cáo cuộc trò chuyện này?\"\r\n          onCancel={() => setShowReportConfirm(false)}\r\n          onConfirm={async () => {\r\n            setShowReportConfirm(false);\r\n            try {\r\n              await fetch('/api/messages', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  action: 'create',\r\n                  data: {\r\n                    roomId,\r\n                    sender: currentUser._id,\r\n                    type: 'notify',\r\n                    content: 'Bạn đã báo xấu cuộc trò chuyện này',\r\n                  },\r\n                }),\r\n              });\r\n              showToast({ type: 'success', message: 'Đã gửi báo xấu' });\r\n            } catch {\r\n              showToast({ type: 'error', message: 'Gửi báo xấu thất bại' });\r\n            }\r\n          }}\r\n          confirmText=\"Báo xấu\"\r\n          variant=\"warning\"\r\n        />\r\n      )}\r\n      {editingSelfNickname && !isGroup && (\r\n        <div className=\"absolute inset-0 z-40 flex items-center justify-center bg-black/50 p-4\">\r\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden\">\r\n            <div className=\"p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50\">\r\n              <h3 className=\"font-bold text-gray-800\">Đặt biệt danh của bạn</h3>\r\n              <button\r\n                onClick={() => setEditingSelfNickname(null)}\r\n                className=\"p-2 hover:bg-gray-200 rounded-full cursor-pointer transition-colors\"\r\n              >\r\n                <HiX className=\"w-5 h-5 text-gray-500\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-4 space-y-4\">\r\n              <p className=\"text-sm text-gray-600\">\r\n                Biệt danh của bạn sẽ hiển thị với <b>{(selectedChat as User).name || 'đối phương'}</b>.\r\n              </p>\r\n              <input\r\n                type=\"text\"\r\n                autoFocus\r\n                defaultValue={editingSelfNickname.currentVal || editingSelfNickname.name}\r\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                placeholder=\"Nhập biệt danh...\"\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    const v = (e.currentTarget.value || '').trim();\r\n                    void handleUpdateNicknameForMe(v);\r\n                    setEditingSelfNickname(null);\r\n                  }\r\n                }}\r\n                id=\"self-nickname-input\"\r\n              />\r\n              <div className=\"flex gap-2 justify-end pt-2\">\r\n                <button\r\n                  onClick={() => setEditingSelfNickname(null)}\r\n                  className=\"px-4 py-2 text-gray-600 cursor-pointer font-medium hover:bg-gray-100 rounded-xl transition-colors\"\r\n                >\r\n                  Hủy\r\n                </button>\r\n                <button\r\n                  onClick={() => {\r\n                    const val = (document.getElementById('self-nickname-input') as HTMLInputElement)?.value;\r\n                    const v = String(val || '').trim();\r\n                    void handleUpdateNicknameForMe(v);\r\n                    setEditingSelfNickname(null);\r\n                  }}\r\n                  className=\"px-4 py-2 cursor-pointer  bg-blue-500 text-white font-bold rounded-[0.5rem] hover:bg-blue-600 transition-all shadow-lg shadow-blue-200\"\r\n                >\r\n                  Lưu\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {isRenameModalOpen && isGroup && (\r\n        <RenameGroupModal\r\n          isOpen={isRenameModalOpen}\r\n          renameInput={renameInput}\r\n          onChangeInput={setRenameInput}\r\n          onClose={() => setIsRenameModalOpen(false)}\r\n          onSubmit={handleSubmitRenameGroup}\r\n        />\r\n      )}\r\n\r\n      {confirmAction && isGroup && (\r\n        <ConfirmGroupActionModal\r\n          confirmAction={confirmAction}\r\n          onCancel={() => setConfirmAction(null)}\r\n          onConfirmLeave={handleLeaveGroup}\r\n          onConfirmDisband={handleDisbandGroup}\r\n        />\r\n      )}\r\n\r\n      <MediaPreviewModal\r\n        media={previewMedia}\r\n        chatName={chatName}\r\n        isGroup={isGroup}\r\n        roomId={roomId}\r\n        onClose={() => setPreviewMedia(null)}\r\n      />\r\n\r\n      {isAssetsModalOpen && (\r\n        <div\r\n          className={`${typeof window !== 'undefined' && window.innerWidth >= 1024 ? 'absolute inset-0' : 'fixed inset-0'} z-50 flex flex-col bg-white`}\r\n        >\r\n          <div className=\"bg-blue-400 text-white p-3 flex items-center justify-between shadow-lg\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                onClick={() => setIsAssetsModalOpen(false)}\r\n                className=\"p-2 cursor-pointer rounded-full hover:bg-white/20 transition-all duration-200\"\r\n              >\r\n                <HiChevronLeft className=\"w-5 h-5\" />\r\n              </button>\r\n              <h2 className=\"text-lg font-semibold\">Ảnh, file, link</h2>\r\n            </div>\r\n          </div>\r\n          <div className=\"p-3 bg-white border-b border-gray-200 flex items-center gap-2\">\r\n            <button\r\n              onClick={() => setAssetsTab('media')}\r\n              className={`cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${\r\n                assetsTab === 'media' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'\r\n              }`}\r\n            >\r\n              Ảnh\r\n            </button>\r\n            <button\r\n              onClick={() => setAssetsTab('file')}\r\n              className={` cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${\r\n                assetsTab === 'file' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'\r\n              }`}\r\n            >\r\n              File\r\n            </button>\r\n            <button\r\n              onClick={() => setAssetsTab('link')}\r\n              className={`cursor-pointer px-3 py-1.5 rounded-full text-sm font-semibold ${\r\n                assetsTab === 'link' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'\r\n              }`}\r\n            >\r\n              Link\r\n            </button>\r\n          </div>\r\n          <div className=\"flex-1 overflow-y-auto\">\r\n            {assetsTab === 'media' && (\r\n              <div className=\"px-5 py-4\">\r\n                {(mediaGroups && mediaGroups.length > 0\r\n                  ? mediaGroups\r\n                  : [\r\n                      {\r\n                        dateLabel: '',\r\n                        items: mediaList as { id: string; type: 'image' | 'video'; url: string; fileName?: string }[],\r\n                      },\r\n                    ]\r\n                ).map((group, gi) => (\r\n                  <div key={`${group.dateLabel}-${gi}`} className=\"mt-4\">\r\n                    {group.dateLabel && (\r\n                      <div className=\"text-xs font-semibold text-gray-500 mb-2\">{group.dateLabel}</div>\r\n                    )}\r\n                    <div className=\"grid grid-cols-3 sm:grid-cols-4 gap-3\">\r\n                      {group.items.map((item) => (\r\n                        <div\r\n                          key={item.id}\r\n                          className={`relative aspect-square rounded-xl cursor-pointer ${\r\n                            item.type === 'video' ? ' w-full h-full flex gap-2' : ''\r\n                          }  group bg-gray-100 ${activeMenuId === item.id ? 'z-50' : 'z-0'}`}\r\n                          onClick={() => {\r\n                            const mediaType = item.type === 'video' ? 'video' : 'image';\r\n                            setPreviewMedia({ url: item.url, type: mediaType });\r\n                          }}\r\n                        >\r\n                          {item.type === 'video' ? (\r\n                            <div className=\"relative\">\r\n                              <video\r\n                                src={getProxyUrl(item.url)}\r\n                                className=\"w-full h-full object-cover pointer-events-none\"\r\n                                preload=\"metadata\"\r\n                              />\r\n                              <div className=\"absolute inset-0 flex items-center justify-center opacity-100\">\r\n                                <div className=\"w-8 h-8 bg-white/80 rounded-full flex items-center justify-center shadow\">\r\n                                  <HiPlay className=\"w-5 h-5 text-blue-600 ml-0.5\" />\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          ) : (\r\n                            <Image\r\n                              width={200}\r\n                              height={200}\r\n                              src={getProxyUrl(item.url)}\r\n                              alt=\"Media\"\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          )}\r\n                          <button\r\n                            className={`cursor-pointer absolute top-2 right-2 p-1.5 bg-white/90 backdrop-blur-sm rounded-full shadow-lg transition-all duration-200 z-10 ${\r\n                              activeMenuId === item.id\r\n                                ? 'opacity-100 ring-2 ring-blue-500'\r\n                                : 'opacity-0 group-hover:opacity-100'\r\n                            } hover:bg-white hover:scale-110`}\r\n                            onClick={(e) => {\r\n                              e.stopPropagation();\r\n                              setActiveMenuId(activeMenuId === item.id ? null : item.id);\r\n                            }}\r\n                          >\r\n                            <svg className=\"w-4 h-4 text-gray-700\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                              <circle cx=\"5\" cy=\"12\" r=\"2\" />\r\n                              <circle cx=\"12\" cy=\"12\" r=\"2\" />\r\n                              <circle cx=\"19\" cy=\"12\" r=\"2\" />\r\n                            </svg>\r\n                          </button>\r\n                          <ItemDropdownMenu\r\n                            itemUrl={item.url}\r\n                            itemId={item.id}\r\n                            fileName={item.fileName}\r\n                            activeMenuId={activeMenuId}\r\n                            onClose={closeMenu}\r\n                            onJumpToMessage={onJumpToMessage}\r\n                            onShareById={(mid) => {\r\n                              try {\r\n                                const evt = new CustomEvent('shareMessage', { detail: { messageId: mid } });\r\n                                window.dispatchEvent(evt);\r\n                              } catch {}\r\n                            }}\r\n                          />\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n            {assetsTab === 'file' && (\r\n              <div className=\"px-5 py-4\">\r\n                {(fileGroups && fileGroups.length > 0 ? fileGroups : [{ dateLabel: '', items: fileList }]).map(\r\n                  (g, gi) => (\r\n                    <div key={`${g.dateLabel}-${gi}`} className=\"mt-4\">\r\n                      {g.dateLabel && <div className=\"text-xs font-semibold text-gray-500 mb-2\">{g.dateLabel}</div>}\r\n                      <div className=\"space-y-3\">\r\n                        {g.items.map((file) => (\r\n                          <div\r\n                            key={file.id}\r\n                            className=\"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 transition-all duration-200 group cursor-pointer border border-gray-200 hover:border-blue-300\"\r\n                            onClick={() => window.open(file.url, '_blank')}\r\n                          >\r\n                            <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 text-white shadow-lg\">\r\n                              <svg className=\"w-6 h-6\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                                <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\" />\r\n                              </svg>\r\n                            </div>\r\n                            <div className=\"flex-1 min-w-0\">\r\n                              <p className=\"text-sm font-semibold text-gray-800 truncate group-hover:text-blue-600 transition-colors\">\r\n                                {file.fileName}\r\n                              </p>\r\n                            </div>\r\n                            <button\r\n                              className={`cursor-pointer p-2 rounded-full  bg-white/90 backdrop-blur-sm shadow-md transition-all duration-200 z-10 ${\r\n                                activeMenuId === file.id\r\n                                  ? 'opacity-100 ring-2 ring-blue-500'\r\n                                  : 'opacity-0 group-hover:opacity-100'\r\n                              } hover:bg-white hover:scale-110`}\r\n                              onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                setActiveMenuId(activeMenuId === file.id ? null : file.id);\r\n                              }}\r\n                            >\r\n                              <svg className=\"w-4 h-4 text-gray-700\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                                <circle cx=\"5\" cy=\"12\" r=\"2\" />\r\n                                <circle cx=\"12\" cy=\"12\" r=\"2\" />\r\n                                <circle cx=\"19\" cy=\"12\" r=\"2\" />\r\n                              </svg>\r\n                            </button>\r\n                            <ItemDropdownMenu\r\n                              itemUrl={file.url}\r\n                              itemId={file.id}\r\n                              fileName={file.fileName}\r\n                              activeMenuId={activeMenuId}\r\n                              onClose={closeMenu}\r\n                              onJumpToMessage={onJumpToMessage}\r\n                              onShareById={(mid) => {\r\n                                try {\r\n                                  const evt = new CustomEvent('shareMessage', { detail: { messageId: mid } });\r\n                                  window.dispatchEvent(evt);\r\n                                } catch {}\r\n                              }}\r\n                            />\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  ),\r\n                )}\r\n              </div>\r\n            )}\r\n            {assetsTab === 'link' && (\r\n              <div className=\"px-5 py-4\">\r\n                {(linkGroups && linkGroups.length > 0 ? linkGroups : [{ dateLabel: '', items: linkList }]).map(\r\n                  (g, gi) => (\r\n                    <div key={`${g.dateLabel}-${gi}`} className=\"mt-4\">\r\n                      {g.dateLabel && <div className=\"text-xs font-semibold text-gray-500 mb-2\">{g.dateLabel}</div>}\r\n                      <div className=\"space-y-3\">\r\n                        {g.items.map((link) => {\r\n                          const href = link.url.startsWith('http') ? link.url : `https://${link.url}`;\r\n                          return (\r\n                            <div\r\n                              key={link.id}\r\n                              className=\"relative flex items-center gap-4 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 transition-all duration-200 group cursor-pointer border border-gray-200 hover:border-purple-300\"\r\n                              onClick={() => window.open(href, '_blank')}\r\n                            >\r\n                              <div className=\"p-3 rounded-xl bg-gradient-to-br from-sky-500 via-blue-500 to-blue-500 text-white shadow-lg\">\r\n                                <svg className=\"w-6 h-6\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                                  <path d=\"M3.9 12a5 5 0 0 1 5-5h4a5 5 0 0 1 0 10h-4a5 5 0 0 1-5-5zm7-3h2a3 3 0 0 1 0 6h-2a3 3 0 0 1 0-6z\" />\r\n                                </svg>\r\n                              </div>\r\n                              <div className=\"flex-1 min-w-0\">\r\n                                <p className=\"text-sm font-semibold text-purple-600 truncate group-hover:underline transition-all\">\r\n                                  {link.url}\r\n                                </p>\r\n                              </div>\r\n                              <button\r\n                                className={`cursor-pointer p-2 rounded-full bg-white/90 backdrop-blur-sm shadow-md transition-all duration-200 z-10 ${\r\n                                  activeMenuId === link.id\r\n                                    ? 'opacity-100 ring-2 ring-purple-500'\r\n                                    : 'opacity-0 group-hover:opacity-100'\r\n                                } hover:bg-white hover:scale-110`}\r\n                                onClick={(e) => {\r\n                                  e.stopPropagation();\r\n                                  setActiveMenuId(activeMenuId === link.id ? null : link.id);\r\n                                }}\r\n                              >\r\n                                <svg className=\"w-4 h-4 text-gray-700\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                                  <circle cx=\"5\" cy=\"12\" r=\"2\" />\r\n                                  <circle cx=\"12\" cy=\"12\" r=\"2\" />\r\n                                  <circle cx=\"19\" cy=\"12\" r=\"2\" />\r\n                                </svg>\r\n                              </button>\r\n                              <ItemDropdownMenu\r\n                                itemUrl={link.url}\r\n                                itemId={link.id}\r\n                                activeMenuId={activeMenuId}\r\n                                onClose={closeMenu}\r\n                                onJumpToMessage={onJumpToMessage}\r\n                                onShareById={(mid) => {\r\n                                  try {\r\n                                    const evt = new CustomEvent('shareMessage', { detail: { messageId: mid } });\r\n                                    window.dispatchEvent(evt);\r\n                                  } catch {}\r\n                                }}\r\n                              />\r\n                            </div>\r\n                          );\r\n                        })}\r\n                      </div>\r\n                    </div>\r\n                  ),\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n      <CropImageModal\r\n        open={cropOpen}\r\n        src={cropSrc}\r\n        onClose={() => setCropOpen(false)}\r\n        onConfirm={async (file: File) => {\r\n          if (!isGroup) return;\r\n          setIsGroupAvatarUploading(true);\r\n          try {\r\n            const groupId = (selectedChat as GroupConversation)._id;\r\n            const formData = new FormData();\r\n            formData.append('file', file);\r\n            formData.append('roomId', String(groupId));\r\n            formData.append('sender', String(currentUser._id));\r\n            formData.append('type', 'image');\r\n            formData.append('folderName', `GroupAvatar_${groupId}`);\r\n            formData.append('skipSaveMessage', 'true');\r\n\r\n            const uploadRes = await fetch(`/api/upload?uploadId=group-avatar-${groupId}-${Date.now()}`, {\r\n              method: 'POST',\r\n              body: formData,\r\n            });\r\n            const uploadJson = await uploadRes.json();\r\n\r\n            if (!uploadRes.ok || !uploadJson?.success || !uploadJson?.link) throw new Error('Upload failed');\r\n\r\n            const updateRes = await fetch('/api/groups', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                action: 'updateAvatar',\r\n                conversationId: groupId,\r\n                data: { avatar: uploadJson.link },\r\n              }),\r\n            });\r\n\r\n            if (!updateRes.ok) throw new Error('Update failed');\r\n\r\n            setGroupAvatar(uploadJson.link);\r\n            try {\r\n              const actorName = currentUser.name || 'Một thành viên';\r\n              const text = `${actorName} đã đổi ảnh đại diện nhóm.`;\r\n              await sendNotifyMessage?.(text);\r\n            } catch {}\r\n            reLoad?.();\r\n          } catch {\r\n            alert('Cập nhật ảnh nhóm thất bại. Vui lòng thử lại.');\r\n          } finally {\r\n            setIsGroupAvatarUploading(false);\r\n            pendingReset?.();\r\n            setCropOpen(false);\r\n            setCropSrc(null);\r\n          }\r\n        }}\r\n        aspectRatio={1}\r\n        circle\r\n        fileName={cropFileName}\r\n        outputType=\"image/jpeg\"\r\n        quality={0.92}\r\n      />\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3654, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/%28zalo%29/home/ChatPopup.tsx"],"sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\r\n/* eslint-disable @typescript-eslint/no-unused-vars */\r\n'use client';\r\n\r\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { formatTimeAgo } from '@/utils/dateUtils';\r\nconst PRESENCE_THRESHOLD_MS = 5 * 60 * 1000;\r\nimport io, { Socket } from 'socket.io-client';\r\nimport ChatInfoPopup from './ChatInfoPopup';\r\n\r\nimport ModalMembers from '../../../components/base/ModalMembers';\r\nimport PinMessageTitleModal from '@/components/base/PinMessageTitleModal';\r\nimport { User } from '../../../types/User';\r\nimport { Message, MessageCreate, MessageType } from '../../../types/Message';\r\nimport { ChatItem, GroupConversation, MemberInfo } from '../../../types/Group';\r\n\r\nimport { EmojiClickData } from 'emoji-picker-react';\r\nimport ChatHeader from '@/components/(chatPopup)/ChatHeader';\r\nimport PinnedMessagesSection from '@/components/(chatPopup)/PinnedMessagesSection';\r\nimport EmojiStickerPicker from '@/components/(chatPopup)/EmojiStickerPicker';\r\nimport ReplyBanner from '@/components/(chatPopup)/ReplyBanner';\r\nimport MentionMenu from '@/components/(chatPopup)/MentionMenu';\r\nimport ChatInput from '@/components/(chatPopup)/ChatInput';\r\nimport MessageList from '@/components/(chatPopup)/MessageList';\r\nimport MediaPreviewModal from '@/components/(chatPopup)/MediaPreviewModal';\r\nimport UploadProgressBar from '@/components/(chatPopup)/UploadProgressBar';\r\nimport MessageContextMenu, { type ContextMenuState } from '@/components/(chatPopup)/MessageContextMenu';\r\nimport { useChatMentions } from '@/hooks/useChatMentions';\r\nimport { useChatUpload } from '@/hooks/useChatUpload';\r\nimport { useChatVoiceInput } from '@/hooks/useChatVoiceInput';\r\nimport { useChatMembers } from '@/hooks/useChatMembers';\r\nimport { useChatNotifications } from '@/hooks/useChatNotifications';\r\nimport {\r\n  createMessageApi,\r\n  readMessagesApi,\r\n  readPinnedMessagesApi,\r\n  recallMessageApi,\r\n  markAsReadApi,\r\n  updateMessageApi,\r\n  tryLockPollApi,\r\n} from '@/fetch/messages';\r\nimport SearchSidebar from '@/components/(chatPopup)/SearchMessageModal';\r\nimport {\r\n  isVideoFile,\r\n  resolveSocketUrl,\r\n  getProxyUrl,\r\n  buildAccentInsensitiveRegex,\r\n  accentAwareIncludes,\r\n} from '@/utils/utils';\r\nimport { insertTextAtCursor } from '@/utils/chatInput';\r\nimport { groupMessagesByDate } from '@/utils/chatMessages';\r\nimport { ChatProvider } from '@/context/ChatContext';\r\nimport { useRouter } from 'next/navigation';\r\nimport ShareMessageModal from '@/components/(chatPopup)/ShareMessageModal';\r\nimport { HiChevronDoubleDown, HiChevronDoubleUp } from 'react-icons/hi2';\r\nimport MessageMobileContextMenu from '@/components/(chatPopup)/MessageMobileContextMenu';\r\n\r\nconst STICKERS = [\r\n  'https://cdn-icons-png.flaticon.com/512/9408/9408176.png',\r\n  'https://cdn-icons-png.flaticon.com/512/9408/9408201.png',\r\n];\r\n\r\nconst SCROLL_BUMP_PX = 80;\r\nconst BUTTON_SHOW_THRESHOLD_PX = 60;\r\n\r\ninterface ChatWindowProps {\r\n  selectedChat: ChatItem;\r\n  currentUser: User;\r\n  allUsers: User[];\r\n  onShowCreateGroup: () => void;\r\n  reLoad?: () => void;\r\n  onChatAction: (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroupChat: boolean) => void;\r\n  scrollToMessageId?: string | null; // 🔥 MỚI: ID tin nhắn cần scroll đến\r\n  onScrollComplete?: () => void;\r\n  roomSearchKeyword?: string | null; // 🔥 MỚI: Keyword từ global search\r\n  setRoomSearchKeyword?: (keyword: string | null) => void;\r\n  onBackFromChat?: () => void;\r\n  groups: GroupConversation[];\r\n  socket?: Socket | null;\r\n}\r\n\r\ndeclare global {\r\n  interface SpeechRecognitionResultAlternative {\r\n    transcript: string;\r\n  }\r\n\r\n  interface SpeechRecognitionResultList {\r\n    [index: number]: SpeechRecognitionResultAlternative;\r\n    0: SpeechRecognitionResultAlternative;\r\n  }\r\n\r\n  interface SpeechRecognitionEventLike extends Event {\r\n    results: SpeechRecognitionResultList[];\r\n    error?: string;\r\n  }\r\n\r\n  interface SpeechRecognitionInstance {\r\n    lang: string;\r\n    continuous: boolean;\r\n    interimResults: boolean;\r\n    start: () => void;\r\n    stop: () => void;\r\n    abort: () => void;\r\n    onstart: ((event: Event) => void) | null;\r\n    onend: ((event: Event) => void) | null;\r\n    onaudioend: ((event: Event) => void) | null;\r\n    onerror: ((event: SpeechRecognitionEventLike) => void) | null;\r\n    onresult: ((event: SpeechRecognitionEventLike) => void) | null;\r\n  }\r\n\r\n  type SpeechRecognitionConstructor = new () => SpeechRecognitionInstance;\r\n\r\n  interface Window {\r\n    SpeechRecognition: SpeechRecognitionConstructor;\r\n    webkitSpeechRecognition: SpeechRecognitionConstructor;\r\n  }\r\n}\r\nconst getId = (u: User | ChatItem | string | undefined | null): string => {\r\n  if (!u) return '';\r\n  if (typeof u === 'string') return u;\r\n  if ('_id' in u && u._id != null) return String(u._id);\r\n  if ('id' in u && u.id != null) return String(u.id);\r\n  return '';\r\n};\r\n\r\nexport default function ChatWindow({\r\n  selectedChat,\r\n  currentUser,\r\n  allUsers,\r\n  onShowCreateGroup,\r\n  reLoad,\r\n  onChatAction,\r\n  scrollToMessageId, // 🔥 Thêm\r\n  onScrollComplete,\r\n  roomSearchKeyword, // 🔥 Thêm\r\n  setRoomSearchKeyword,\r\n  onBackFromChat,\r\n  groups,\r\n  socket,\r\n}: ChatWindowProps) {\r\n  const router = useRouter();\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [showPopup, setShowPopup] = useState(false);\r\n  const [chatInfoInitialSection, setChatInfoInitialSection] = useState<'reminder' | 'poll' | 'members' | null>(null);\r\n  const [openMember, setOpenMember] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement | null>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement | null>(null);\r\n  const footerRef = useRef<HTMLDivElement | null>(null);\r\n  const socketRef = useRef<Socket | null>(null);\r\n  const [socketInstance, setSocketInstance] = useState<Socket | null>(null);\r\n  const markedReadRef = useRef<string | null>(null);\r\n  const initialScrolledRef = useRef(false);\r\n  const jumpLoadingRef = useRef(false);\r\n  const isAtBottomRef = useRef(true);\r\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\r\n  const [pickerTab, setPickerTab] = useState<'emoji' | 'sticker'>('emoji');\r\n  const [highlightedMsgId, setHighlightedMsgId] = useState<string | null>(null);\r\n  const [contextMenu, setContextMenu] = useState<ContextMenuState | null>(null);\r\n  const [showScrollDown, setShowScrollDown] = useState(false);\r\n  const [pendingNewCount, setPendingNewCount] = useState(0);\r\n  const pendingNewCountRef = useRef(0);\r\n  const hasScrolledUpRef = useRef(false);\r\n  const syncLocalReadBy = useCallback(() => {\r\n    const myId = String(currentUser._id || '');\r\n    if (!myId) return;\r\n    setMessages((prev) =>\r\n      prev.map((m) => {\r\n        const arr = Array.isArray(m.readBy) ? (m.readBy as string[]) : [];\r\n        if (arr.some((id) => String(id) === myId)) return m;\r\n        return { ...m, readBy: [...arr, myId] };\r\n      }),\r\n    );\r\n  }, [currentUser._id]);\r\n  const isGroup = 'isGroup' in selectedChat && selectedChat.isGroup === true;\r\n  const [replyingTo, setReplyingTo] = useState<Message | null>(null);\r\n  const [, setPinnedMessage] = useState<Message | null>(null);\r\n  const [allPinnedMessages, setAllPinnedMessages] = useState<Message[]>([]);\r\n  const [showPinnedList, setShowPinnedList] = useState(false);\r\n  const PINNED_PAGE_SIZE = 10;\r\n  const [pinnedSkip, setPinnedSkip] = useState(0);\r\n  const [pinnedTotal, setPinnedTotal] = useState<number | null>(null);\r\n  const [pinnedLoading, setPinnedLoading] = useState(false);\r\n  const [previewMedia, setPreviewMedia] = useState<{ url: string; type: 'image' | 'video' } | null>(null);\r\n  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);\r\n  const [editContent, setEditContent] = useState(''); // Lưu nội dung đang chỉnh sửa\r\n  const [hasMore, setHasMore] = useState(true);\r\n  const [loadingMore, setLoadingMore] = useState(false);\r\n  const [oldestTs, setOldestTs] = useState<number | null>(null);\r\n  const [initialLoading, setInitialLoading] = useState(false);\r\n  const [attachments, setAttachments] = useState<\r\n    {\r\n      file: File;\r\n      type: 'image' | 'video' | 'file';\r\n      previewUrl: string;\r\n      fileName?: string;\r\n      videoCropConfig?: {\r\n        crop: { x: number; y: number };\r\n        zoom: number;\r\n        rotation: number;\r\n        croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n        baseWidth?: number;\r\n        baseHeight?: number;\r\n      } | null;\r\n    }[]\r\n  >([]);\r\n  const reminderScheduledIdsRef = useRef<Set<string>>(new Set());\r\n  const reminderTimersByIdRef = useRef<Map<string, number>>(new Map());\r\n  const pollScheduledIdsRef = useRef<Set<string>>(new Set());\r\n  const pollTimersByIdRef = useRef<Map<string, number>>(new Map());\r\n  const messagesRef = useRef<Message[]>([]);\r\n  const [showShareModal, setShowShareModal] = useState(false);\r\n  const [messageToShare, setMessageToShare] = useState<Message | null>(null);\r\n  // call ticker được xử lý ở HomePage\r\n\r\n  const getOneToOneRoomId = (user1Id: string | number, user2Id: string | number) => {\r\n    return [user1Id, user2Id].sort().join('_');\r\n  };\r\n  const roomId = isGroup ? getId(selectedChat) : getOneToOneRoomId(getId(currentUser), getId(selectedChat));\r\n  const [roomMuted, setRoomMuted] = useState(false);\r\n  const [roomCallActiveLocal, setRoomCallActiveLocal] = useState(false);\r\n  const [roomCallTypeLocal, setRoomCallTypeLocal] = useState<'voice' | 'video'>('voice');\r\n  const [roomParticipantsLocal, setRoomParticipantsLocal] = useState<string[]>([]);\r\n\r\n  // Trạng thái cuộc gọi toàn cục (đọc từ layout thông qua localStorage + event)\r\n  // Chỉ dùng để ẩn banner khi ĐANG có popup cuộc gọi nổi hoặc đang đổ chuông,\r\n  // tránh hiển thị \"Tham gia lại\" đè lên UI cuộc gọi chính.\r\n  const [globalCallActive, setGlobalCallActive] = useState(false);\r\n  const [globalCallConnecting, setGlobalCallConnecting] = useState(false);\r\n  const [globalIncoming, setGlobalIncoming] = useState(false);\r\n  useEffect(() => {\r\n    try {\r\n      const k = `roomMuted:${roomId}:${String(currentUser._id)}`;\r\n      const v = localStorage.getItem(k) === 'true';\r\n      setRoomMuted(v);\r\n    } catch {}\r\n  }, [roomId, currentUser._id]);\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem('CURRENT_ROOM_ID', String(roomId));\r\n      const ev = new CustomEvent('currentRoomChanged', { detail: { roomId: String(roomId) } });\r\n      window.dispatchEvent(ev as unknown as Event);\r\n    } catch {}\r\n  }, [roomId]);\r\n  useEffect(() => {\r\n    try {\r\n      const a = localStorage.getItem(`livekit_room_${roomId}_active`) === 'true';\r\n      const tRaw = localStorage.getItem(`livekit_room_${roomId}_type`);\r\n      const t = (tRaw === 'video' ? 'video' : 'voice') as 'voice' | 'video';\r\n      const pRaw = localStorage.getItem(`livekit_room_${roomId}_participants`);\r\n      const p = pRaw ? (JSON.parse(pRaw) as string[]) : [];\r\n      setRoomCallActiveLocal(!!a);\r\n      setRoomCallTypeLocal(t);\r\n      setRoomParticipantsLocal(Array.isArray(p) ? p.map((x) => String(x)) : []);\r\n    } catch {}\r\n  }, [roomId]);\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const d =\r\n        (\r\n          e as unknown as {\r\n            detail?: { roomId?: string; active?: boolean; type?: 'voice' | 'video'; participants?: string[] };\r\n          }\r\n        ).detail || {};\r\n      if (String(d.roomId) !== String(roomId)) return;\r\n      setRoomCallActiveLocal(!!d.active);\r\n      setRoomCallTypeLocal((d.type === 'video' ? 'video' : 'voice') as 'voice' | 'video');\r\n      setRoomParticipantsLocal(Array.isArray(d.participants) ? d.participants.map((x) => String(x)) : []);\r\n    };\r\n    window.addEventListener('roomCallStateChanged', handler as EventListener);\r\n    return () => window.removeEventListener('roomCallStateChanged', handler as EventListener);\r\n  }, [roomId]);\r\n  useEffect(() => {\r\n    try {\r\n      setGlobalIncoming(localStorage.getItem('GLOBAL_INCOMING_CALL') === '1');\r\n      setGlobalCallActive(localStorage.getItem('GLOBAL_CALL_ACTIVE') === '1');\r\n      setGlobalCallConnecting(localStorage.getItem('GLOBAL_CALL_CONNECTING') === '1');\r\n    } catch {}\r\n\r\n    const handler = (e: Event) => {\r\n      const d =\r\n        (\r\n          e as unknown as {\r\n            detail?: { active?: boolean; connecting?: boolean; incoming?: boolean };\r\n          }\r\n        ).detail || {};\r\n\r\n      setGlobalCallActive(!!d.active);\r\n      setGlobalCallConnecting(!!d.connecting);\r\n      setGlobalIncoming(!!d.incoming);\r\n    };\r\n\r\n    window.addEventListener('globalCallStatusChanged', handler as EventListener);\r\n    return () => window.removeEventListener('globalCallStatusChanged', handler as EventListener);\r\n  }, []);\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const d = (e as unknown as { detail?: { roomId?: string; muted?: boolean } }).detail;\r\n      if (!d) return;\r\n      if (String(d.roomId) !== String(roomId)) return;\r\n      setRoomMuted(!!d.muted);\r\n    };\r\n    window.addEventListener('roomMutedChanged', handler as EventListener);\r\n    return () => window.removeEventListener('roomMutedChanged', handler as EventListener);\r\n  }, [roomId]);\r\n  // useCallSession được xử lý toàn cục ở HomePage\r\n\r\n  useEffect(() => {\r\n    messagesRef.current = messages;\r\n  }, [messages]);\r\n\r\n  const chatName = useMemo(() => {\r\n    if (isGroup) return selectedChat.name;\r\n    const user = selectedChat as User;\r\n    const myId = String(currentUser._id || (currentUser as { id?: string })?.id || '');\r\n    return user.nicknames?.[myId] || user.name || user.username || 'Người dùng';\r\n  }, [selectedChat, isGroup, currentUser]);\r\n\r\n  const [showSearchSidebar, setShowSearchSidebar] = useState(false);\r\n  const chatAvatar = (selectedChat as { avatar?: string }).avatar;\r\n\r\n  const handleJumpToMessage = useCallback(\r\n    async (messageId: string) => {\r\n      jumpLoadingRef.current = true;\r\n      scrollLockUntilRef.current = Date.now() + 1800;\r\n      const container = messagesContainerRef.current;\r\n\r\n      if (!container) {\r\n        console.error('❌ [JUMP] Container not found');\r\n        jumpLoadingRef.current = false;\r\n        return;\r\n      }\r\n\r\n      isAtBottomRef.current = false;\r\n\r\n      const computeTopInContainer = (el: HTMLElement, parent: HTMLElement) => {\r\n        const elRect = el.getBoundingClientRect();\r\n        const parentRect = parent.getBoundingClientRect();\r\n        return parent.scrollTop + (elRect.top - parentRect.top);\r\n      };\r\n\r\n      const isFullyVisible = (el: HTMLElement, parent: HTMLElement) => {\r\n        const cTop = parent.scrollTop;\r\n        const cBottom = cTop + parent.clientHeight;\r\n        const eTop = computeTopInContainer(el, parent);\r\n        const eBottom = eTop + el.clientHeight;\r\n        return eTop >= cTop && eBottom <= cBottom;\r\n      };\r\n\r\n      const centerElement = (el: HTMLElement) => {\r\n        try {\r\n          const elTopInContainer = computeTopInContainer(el, container);\r\n          const rawTarget = elTopInContainer - container.clientHeight / 2 + el.clientHeight / 2;\r\n          const maxScroll = Math.max(0, container.scrollHeight - container.clientHeight);\r\n          const targetTop = Math.max(0, Math.min(rawTarget, maxScroll));\r\n          container.scrollTo({ top: targetTop, behavior: 'smooth' });\r\n        } catch {}\r\n      };\r\n\r\n      const scrollToElement = (elementId: string, attempt = 0): boolean => {\r\n        const element =\r\n          (messagesContainerRef.current?.querySelector(`[id=\"${elementId}\"]`) as HTMLElement | null) ||\r\n          (document.getElementById(elementId) as HTMLElement | null);\r\n\r\n        if (element) {\r\n          try {\r\n            (element as HTMLElement).scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });\r\n          } catch {}\r\n          centerElement(element);\r\n\r\n          setHighlightedMsgId(messageId);\r\n          setTimeout(() => setHighlightedMsgId(null), 2500);\r\n\r\n          setTimeout(() => {\r\n            const e =\r\n              (messagesContainerRef.current?.querySelector(`[id=\"${elementId}\"]`) as HTMLElement | null) ||\r\n              (document.getElementById(elementId) as HTMLElement | null);\r\n            if (e && !isFullyVisible(e, container)) {\r\n              centerElement(e);\r\n            }\r\n            jumpLoadingRef.current = false;\r\n            scrollLockUntilRef.current = 0;\r\n          }, 320);\r\n\r\n          return true;\r\n        }\r\n\r\n        if (attempt < 15) {\r\n          setTimeout(() => scrollToElement(elementId, attempt + 1), 200);\r\n          return false;\r\n        }\r\n\r\n        console.warn('❌ [JUMP] Element not found after 10 attempts');\r\n        jumpLoadingRef.current = false;\r\n        return false;\r\n      };\r\n\r\n      const existingElement = document.getElementById(`msg-${messageId}`);\r\n      if (existingElement) {\r\n        scrollToElement(`msg-${messageId}`);\r\n        return;\r\n      }\r\n\r\n      const messageInState = messages.find((m) => String(m._id) === String(messageId));\r\n      if (messageInState) {\r\n        setTimeout(() => scrollToElement(`msg-${messageId}`), 100);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const response = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ action: 'getById', _id: messageId }),\r\n        });\r\n\r\n        const result = await response.json();\r\n        const targetMessage = (result?.row?.row || result?.row) as Message | null;\r\n\r\n        if (!targetMessage || String(targetMessage.roomId) !== String(roomId)) {\r\n          console.error('❌ [JUMP] Message not found or wrong room');\r\n          alert('Không tìm thấy tin nhắn này trong cuộc trò chuyện.');\r\n          jumpLoadingRef.current = false;\r\n          return;\r\n        }\r\n\r\n        const targetTs = Number(targetMessage.timestamp);\r\n\r\n        const [olderRes, newerRes] = await Promise.all([\r\n          readMessagesApi(roomId, {\r\n            limit: 100,\r\n            sortOrder: 'desc',\r\n            extraFilters: { timestamp: { $lte: targetTs } },\r\n          }),\r\n          readMessagesApi(roomId, {\r\n            limit: 50,\r\n            sortOrder: 'asc',\r\n            extraFilters: { timestamp: { $gt: targetTs } },\r\n          }),\r\n        ]);\r\n\r\n        const olderMessages = Array.isArray(olderRes.data) ? (olderRes.data as Message[]) : [];\r\n        const newerMessages = Array.isArray(newerRes.data) ? (newerRes.data as Message[]) : [];\r\n\r\n        const olderAsc = olderMessages.reverse();\r\n        const allNewMessages = [...olderAsc, ...newerMessages];\r\n\r\n        const existingIds = new Set(messages.map((m) => String(m._id)));\r\n        const messagesToAdd = allNewMessages.filter((m) => !existingIds.has(String(m._id)));\r\n\r\n        if (messagesToAdd.length > 0) {\r\n          setMessages((prev) => {\r\n            const combined = [...prev, ...messagesToAdd];\r\n            combined.sort((a, b) => {\r\n              const ta = Number(a.timestamp) || 0;\r\n              const tb = Number(b.timestamp) || 0;\r\n              return ta - tb;\r\n            });\r\n            return combined;\r\n          });\r\n\r\n          const minTimestamp = Math.min(...messagesToAdd.map((m) => Number(m.timestamp)));\r\n          setOldestTs((prev) => Math.min(minTimestamp, prev ?? Infinity));\r\n          setHasMore(olderMessages.length === 100);\r\n        }\r\n\r\n        setTimeout(() => {\r\n          scrollToElement(`msg-${messageId}`);\r\n        }, 300);\r\n      } catch (error) {\r\n        console.error('❌ [JUMP] Error:', error);\r\n        alert('Có lỗi xảy ra khi tải tin nhắn.');\r\n        jumpLoadingRef.current = false;\r\n        scrollLockUntilRef.current = 0;\r\n      }\r\n    },\r\n    [roomId, messages, oldestTs],\r\n  );\r\n\r\n  // Mobile inline search state\r\n  const [mobileSearchTerm, setMobileSearchTerm] = useState('');\r\n  const [mobileSearchResults, setMobileSearchResults] = useState<Message[]>([]);\r\n  const [isMobileSearching, setIsMobileSearching] = useState(false);\r\n  const [mobileCurrentResultIndex, setMobileCurrentResultIndex] = useState<number>(-1);\r\n  const mobileSearchInputRef = useRef<HTMLInputElement | null>(null);\r\n\r\n  const handleRejoinCall = useCallback(() => {\r\n    try {\r\n      const ev = new CustomEvent('startCall', {\r\n        detail: {\r\n          type: roomCallTypeLocal,\r\n          roomId,\r\n          isGroup: isGroup,\r\n          selectedChat: selectedChat,\r\n        },\r\n      });\r\n      window.dispatchEvent(ev as unknown as Event);\r\n    } catch {}\r\n  }, [roomCallTypeLocal, roomId, isGroup, selectedChat]);\r\n  const hasAutoSearchedRef = useRef(false);\r\n  const isMobile = typeof window !== 'undefined' ? window.innerWidth < 1024 : false;\r\n  const isLgOnly = typeof window !== 'undefined' ? window.innerWidth >= 1024 && window.innerWidth < 1280 : false;\r\n  const scrollLockUntilRef = useRef<number>(0);\r\n  const mobileSelectingRef = useRef(false);\r\n  const mobileSelectedMsgIdRef = useRef<string | null>(null);\r\n  const mobileCurrentIndexRef = useRef<number>(-1);\r\n  const closingSearchRef = useRef(false);\r\n  const [mobileSearchHasMore, setMobileSearchHasMore] = useState(false);\r\n  const MOBILE_SEARCH_LIMIT = 200;\r\n  const mobileSearchResultsRef = useRef<Message[]>([]);\r\n  useEffect(() => {\r\n    mobileCurrentIndexRef.current = mobileCurrentResultIndex;\r\n  }, [mobileCurrentResultIndex]);\r\n  useEffect(() => {\r\n    mobileSearchResultsRef.current = mobileSearchResults;\r\n  }, [mobileSearchResults]);\r\n\r\n  useEffect(() => {\r\n    if (isMobile) return;\r\n    if (closingSearchRef.current) return;\r\n    if (roomSearchKeyword && roomSearchKeyword.trim() && scrollToMessageId && !showSearchSidebar) {\r\n      setShowSearchSidebar(true);\r\n    }\r\n  }, [roomSearchKeyword, scrollToMessageId, isMobile, showSearchSidebar]);\r\n\r\n  const fetchMobileSearchResults = useCallback(\r\n    async (query: string, append: boolean = false) => {\r\n      if (!query.trim() || !roomId) {\r\n        setMobileSearchResults([]);\r\n        setMobileCurrentResultIndex(-1);\r\n        setMobileSearchHasMore(false);\r\n        return;\r\n      }\r\n      setIsMobileSearching(true);\r\n\r\n      try {\r\n        const res = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            action: 'read',\r\n            filters: {\r\n              roomId,\r\n              searchQuery: query.trim(),\r\n              isRecalled: { $ne: true },\r\n              isDeleted: { $ne: true },\r\n              type: { $ne: 'notify' },\r\n            },\r\n            skip: append ? mobileSearchResultsRef.current.length : 0,\r\n            limit: MOBILE_SEARCH_LIMIT,\r\n            sort: { field: 'timestamp', order: 'desc' },\r\n          }),\r\n        });\r\n        const data = await res.json();\r\n        const raw: Message[] = Array.isArray(data?.data) ? (data.data as Message[]) : [];\r\n        const filtered: Message[] = raw.filter((m) => {\r\n          const text =\r\n            m.type === 'file' ? String(m.fileName || '') : m.type === 'sticker' ? '' : String(m.content || '');\r\n          return accentAwareIncludes(text, query);\r\n        });\r\n        const sorted: Message[] = filtered.slice().sort((a, b) => Number(a.timestamp) - Number(b.timestamp));\r\n        const merged: Message[] = append ? [...mobileSearchResultsRef.current, ...sorted] : sorted;\r\n        setMobileSearchResults(merged);\r\n        setMobileSearchHasMore(raw.length === MOBILE_SEARCH_LIMIT);\r\n        if (merged.length > 0) {\r\n          const selectedId = mobileSelectedMsgIdRef.current;\r\n          if (mobileSelectingRef.current && selectedId) {\r\n            const idx = merged.findIndex((m) => String(m._id) === String(selectedId));\r\n            if (idx >= 0) {\r\n              setMobileCurrentResultIndex(idx);\r\n            } else {\r\n              const prevIdx = mobileCurrentIndexRef.current;\r\n              const safeIdx = Math.max(0, Math.min(merged.length - 1, prevIdx));\r\n              setMobileCurrentResultIndex(safeIdx);\r\n            }\r\n            mobileSelectingRef.current = false;\r\n            mobileSelectedMsgIdRef.current = null;\r\n          } else if (mobileCurrentIndexRef.current === -1) {\r\n            const lastIdx = merged.length - 1;\r\n            setMobileCurrentResultIndex(lastIdx);\r\n          } else {\r\n            const prevIdx = mobileCurrentIndexRef.current;\r\n            const safeIdx = Math.max(0, Math.min(merged.length - 1, prevIdx));\r\n            setMobileCurrentResultIndex(safeIdx);\r\n          }\r\n        } else {\r\n          setMobileCurrentResultIndex(-1);\r\n        }\r\n      } catch (error) {\r\n        console.error('Fetch search results error:', error);\r\n        setMobileSearchResults([]);\r\n        setMobileCurrentResultIndex(-1);\r\n        setMobileSearchHasMore(false);\r\n      } finally {\r\n        setIsMobileSearching(false);\r\n      }\r\n    },\r\n    [roomId, handleJumpToMessage],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (closingSearchRef.current) return;\r\n    if (\r\n      isMobile &&\r\n      roomSearchKeyword &&\r\n      roomSearchKeyword.trim() &&\r\n      !hasAutoSearchedRef.current &&\r\n      !showSearchSidebar\r\n    ) {\r\n      setMobileSearchTerm(roomSearchKeyword);\r\n      hasAutoSearchedRef.current = true;\r\n      setShowSearchSidebar(true);\r\n      fetchMobileSearchResults(roomSearchKeyword);\r\n      setTimeout(() => {\r\n        mobileSearchInputRef.current?.focus();\r\n      }, 100);\r\n    }\r\n  }, [roomSearchKeyword, isMobile, fetchMobileSearchResults, showSearchSidebar]);\r\n\r\n  // Mobile: Debounced search\r\n  useEffect(() => {\r\n    if (!isMobile) return;\r\n\r\n    if (roomSearchKeyword && mobileSearchTerm === roomSearchKeyword && hasAutoSearchedRef.current) {\r\n      // Initial search already done\r\n      return;\r\n    }\r\n\r\n    if (!mobileSearchTerm.trim()) {\r\n      setMobileSearchResults([]);\r\n      setMobileCurrentResultIndex(-1);\r\n      return;\r\n    }\r\n\r\n    const handler = setTimeout(() => {\r\n      fetchMobileSearchResults(mobileSearchTerm, false);\r\n    }, 500);\r\n\r\n    return () => {\r\n      clearTimeout(handler);\r\n    };\r\n  }, [mobileSearchTerm, isMobile, roomSearchKeyword, fetchMobileSearchResults]);\r\n\r\n  // Mobile: Navigation handlers\r\n  const handlePreviousResult = useCallback(() => {\r\n    if (mobileSearchResults.length === 0) return;\r\n    const newIndex = mobileCurrentResultIndex <= 0 ? mobileSearchResults.length - 1 : mobileCurrentResultIndex - 1;\r\n    setMobileCurrentResultIndex(newIndex);\r\n    mobileSelectingRef.current = true;\r\n    mobileSelectedMsgIdRef.current = mobileSearchResults[newIndex]._id;\r\n    handleJumpToMessage(mobileSearchResults[newIndex]._id);\r\n    setTimeout(() => {\r\n      mobileSelectingRef.current = false;\r\n      mobileSelectedMsgIdRef.current = null;\r\n    }, 1200);\r\n  }, [mobileSearchResults, mobileCurrentResultIndex]);\r\n\r\n  const handleNextResult = useCallback(async () => {\r\n    if (mobileSearchResultsRef.current.length === 0) return;\r\n    if (mobileCurrentResultIndex >= mobileSearchResultsRef.current.length - 1) {\r\n      if (mobileSearchHasMore) {\r\n        await fetchMobileSearchResults(mobileSearchTerm, true);\r\n        const len = mobileSearchResultsRef.current.length;\r\n        const idx = Math.min(mobileCurrentResultIndex + 1, len - 1);\r\n        setMobileCurrentResultIndex(idx);\r\n        mobileSelectingRef.current = true;\r\n        mobileSelectedMsgIdRef.current = mobileSearchResultsRef.current[idx]._id;\r\n        handleJumpToMessage(mobileSearchResultsRef.current[idx]._id);\r\n        setTimeout(() => {\r\n          mobileSelectingRef.current = false;\r\n          mobileSelectedMsgIdRef.current = null;\r\n        }, 1200);\r\n      } else {\r\n        const idx = 0;\r\n        setMobileCurrentResultIndex(idx);\r\n        mobileSelectingRef.current = true;\r\n        mobileSelectedMsgIdRef.current = mobileSearchResultsRef.current[idx]._id;\r\n        handleJumpToMessage(mobileSearchResultsRef.current[idx]._id);\r\n        setTimeout(() => {\r\n          mobileSelectingRef.current = false;\r\n          mobileSelectedMsgIdRef.current = null;\r\n        }, 1200);\r\n      }\r\n      return;\r\n    }\r\n    const idx = mobileCurrentResultIndex + 1;\r\n    setMobileCurrentResultIndex(idx);\r\n    mobileSelectingRef.current = true;\r\n    mobileSelectedMsgIdRef.current = mobileSearchResultsRef.current[idx]._id;\r\n    handleJumpToMessage(mobileSearchResultsRef.current[idx]._id);\r\n    setTimeout(() => {\r\n      mobileSelectingRef.current = false;\r\n      mobileSelectedMsgIdRef.current = null;\r\n    }, 1200);\r\n  }, [mobileSearchHasMore, mobileCurrentResultIndex, mobileSearchTerm, fetchMobileSearchResults]);\r\n\r\n  // Reset mobile search when sidebar closes\r\n  useEffect(() => {\r\n    if (!showSearchSidebar && isMobile) {\r\n      closingSearchRef.current = true;\r\n      setMobileSearchTerm('');\r\n      setMobileSearchResults([]);\r\n      setMobileCurrentResultIndex(-1);\r\n      hasAutoSearchedRef.current = false;\r\n      // if (setRoomSearchKeyword) setRoomSearchKeyword(null);\r\n      setTimeout(() => {\r\n        closingSearchRef.current = false;\r\n      }, 300);\r\n    }\r\n  }, [showSearchSidebar, isMobile, setRoomSearchKeyword]);\r\n\r\n  const presenceInfo = useMemo(() => {\r\n    if (isGroup) return { online: undefined as boolean | undefined, text: '' };\r\n    const partnerId = getId(selectedChat);\r\n    const partner = allUsers.find((u) => String(u._id) === String(partnerId));\r\n    const lastSeen = partner?.lastSeen ?? null;\r\n    const now = Date.now();\r\n    const online = lastSeen != null ? now - lastSeen <= PRESENCE_THRESHOLD_MS : !!partner?.online;\r\n    const text = online\r\n      ? 'Đang hoạt động'\r\n      : lastSeen\r\n        ? `Hoạt động ${formatTimeAgo(lastSeen)} trước`\r\n        : 'Hoạt động gần đây';\r\n    return { online, text };\r\n  }, [isGroup, selectedChat, allUsers]);\r\n\r\n  const scrollToBottom = useCallback(\r\n    (force = false) => {\r\n      if (!force && (showSearchSidebar || (scrollLockUntilRef.current && Date.now() < scrollLockUntilRef.current))) {\r\n        return;\r\n      }\r\n      if (jumpLoadingRef.current) return;\r\n      const el = messagesContainerRef.current;\r\n      if (!el) return;\r\n      el.scrollTop = el.scrollHeight;\r\n      const end = messagesEndRef.current;\r\n      if (end && typeof end.scrollIntoView === 'function') {\r\n        end.scrollIntoView({ block: 'end' });\r\n      }\r\n      setPendingNewCount(0);\r\n      pendingNewCountRef.current = 0;\r\n      hasScrolledUpRef.current = false;\r\n      setShowScrollDown(false);\r\n    },\r\n    [showSearchSidebar],\r\n  );\r\n\r\n  const ensureBottom = useCallback(() => {\r\n    scrollToBottom();\r\n    setTimeout(scrollToBottom, 0);\r\n    setTimeout(scrollToBottom, 100);\r\n    setTimeout(scrollToBottom, 300);\r\n  }, [scrollToBottom]);\r\n\r\n  const sendMessageProcess = useCallback(\r\n    async (msgData: MessageCreate) => {\r\n      try {\r\n        if (msgData._id) {\r\n          const newId = String(msgData._id);\r\n          setMessages((prev) => {\r\n            const next = [...prev, { ...msgData, _id: newId } as Message];\r\n            return sortMessagesAsc(next);\r\n          });\r\n          ensureBottom();\r\n          const socketData = {\r\n            ...msgData,\r\n            _id: newId,\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderName: currentUser.name,\r\n            isGroup: isGroup,\r\n            receiver: isGroup ? null : getId(selectedChat),\r\n            members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n          };\r\n          socketRef.current?.emit('send_message', socketData);\r\n          setReplyingTo(null);\r\n        } else {\r\n          const json = await createMessageApi({ ...msgData, roomId });\r\n          if (json.success && typeof json._id === 'string') {\r\n            const newId = json._id;\r\n            setMessages((prev) => {\r\n              const next = [...prev, { ...msgData, _id: newId } as Message];\r\n              return sortMessagesAsc(next);\r\n            });\r\n            ensureBottom();\r\n            const socketData = {\r\n              ...msgData,\r\n              _id: newId,\r\n              roomId,\r\n              sender: currentUser._id,\r\n              senderName: currentUser.name,\r\n              isGroup: isGroup,\r\n              receiver: isGroup ? null : getId(selectedChat),\r\n              members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n            };\r\n            socketRef.current?.emit('send_message', socketData);\r\n            setReplyingTo(null);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Save message error:', error);\r\n      }\r\n    },\r\n    [roomId, currentUser, isGroup, selectedChat, ensureBottom],\r\n  );\r\n\r\n  // điều khiển mic/camera/cuộc gọi xử lý ở HomePage\r\n\r\n  const handleVoiceCall = useCallback(() => {\r\n    try {\r\n      window.dispatchEvent(\r\n        new CustomEvent('startCall', {\r\n          detail: { type: 'voice', roomId, isGroup, selectedChat },\r\n        }),\r\n      );\r\n    } catch {}\r\n  }, [roomId, isGroup, selectedChat]);\r\n\r\n  const handleVideoCall = useCallback(() => {\r\n    try {\r\n      window.dispatchEvent(\r\n        new CustomEvent('startCall', {\r\n          detail: { type: 'video', roomId, isGroup, selectedChat },\r\n        }),\r\n      );\r\n    } catch {}\r\n  }, [roomId, isGroup, selectedChat]);\r\n\r\n  // Removed local startCall listener. Calls are handled globally in HomePage.\r\n\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      try {\r\n        const d = (e as CustomEvent).detail || {};\r\n        if (d && d.roomId) {\r\n          // optional: verify roomId matches current room if needed\r\n        }\r\n      } catch {}\r\n      setShowPopup(false);\r\n      setShowSearchSidebar(true);\r\n      if (isMobile) {\r\n        setTimeout(() => {\r\n          try {\r\n            mobileSearchInputRef.current?.focus();\r\n          } catch {}\r\n        }, 100);\r\n      }\r\n    };\r\n    window.addEventListener('openRoomSearch', handler as EventListener);\r\n    return () => window.removeEventListener('openRoomSearch', handler as EventListener);\r\n  }, [isMobile, setShowPopup, setShowSearchSidebar]);\r\n\r\n  // timer cuộc gọi xử lý ở HomePage\r\n\r\n  // Ring tone handled inside useCallSession\r\n\r\n  const sortMessagesAsc = useCallback((list: Message[]) => {\r\n    const safeNum = (t: unknown) => {\r\n      const n = Number(t);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n    const cmp = (a: Message, b: Message) => {\r\n      const ta = safeNum(a.serverTimestamp ?? a.timestamp);\r\n      const tb = safeNum(b.serverTimestamp ?? b.timestamp);\r\n      if (ta !== tb) return ta - tb;\r\n      const ia = String(a._id || '');\r\n      const ib = String(b._id || '');\r\n      if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n      if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n      return ia.localeCompare(ib);\r\n    };\r\n    return list.slice().sort(cmp);\r\n  }, []);\r\n\r\n  const sendNotifyMessage = useCallback(\r\n    async (text: string, replyToMessageId?: string) => {\r\n      const newMsg: MessageCreate = {\r\n        roomId: roomId,\r\n        sender: currentUser._id,\r\n        content: text,\r\n        type: 'notify',\r\n        timestamp: Date.now(),\r\n        replyToMessageId,\r\n      };\r\n      await sendMessageProcess(newMsg);\r\n    },\r\n    [roomId, currentUser._id, sendMessageProcess],\r\n  );\r\n\r\n  const schedulePollAutoLock = useCallback(\r\n    (msg: Message) => {\r\n      // Chỉ người tạo poll mới được set timer auto-lock để tránh duplicate notification\r\n      if (!compareIds(msg.sender, currentUser._id)) return;\r\n\r\n      const idStr = String(msg._id);\r\n      const existing = pollTimersByIdRef.current.get(idStr);\r\n      if (existing) {\r\n        clearTimeout(existing);\r\n        pollTimersByIdRef.current.delete(idStr);\r\n        pollScheduledIdsRef.current.delete(idStr);\r\n      }\r\n      const endAt = msg.pollEndAt;\r\n      const locked = !!msg.isPollLocked;\r\n      if (typeof endAt !== 'number' || locked) return;\r\n      const now = Date.now();\r\n      const delay = Math.max(0, endAt - now);\r\n      const timerId = window.setTimeout(async () => {\r\n        const latest = messagesRef.current.find((x) => String(x._id) === idStr);\r\n        if (!latest || latest.isRecalled || latest.isPollLocked) {\r\n          pollScheduledIdsRef.current.delete(idStr);\r\n          const t = pollTimersByIdRef.current.get(idStr);\r\n          if (t) {\r\n            clearTimeout(t);\r\n            pollTimersByIdRef.current.delete(idStr);\r\n          }\r\n          return;\r\n        }\r\n        let latestEndAt = latest.pollEndAt;\r\n        try {\r\n          const r = await fetch('/api/messages', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ action: 'getById', _id: (latest as Message)._id }),\r\n          });\r\n          const j = await r.json();\r\n          const srv = (j && (j.row?.row || j.row)) as Message | undefined;\r\n          const srvEndAt = srv && (srv as unknown as { pollEndAt?: number | null }).pollEndAt;\r\n          if (typeof srvEndAt === 'number' || srvEndAt === null) {\r\n            latestEndAt = srvEndAt;\r\n          }\r\n        } catch {}\r\n        const now2 = Date.now();\r\n        if (typeof latestEndAt === 'number' && latestEndAt > now2) {\r\n          const newDelay = Math.max(0, latestEndAt - now2);\r\n          const newTimer = window.setTimeout(async () => {\r\n            const latest2 = messagesRef.current.find((x) => String(x._id) === idStr);\r\n            if (!latest2 || (latest2 as Message).isRecalled || (latest2 as Message).isPollLocked) {\r\n              pollScheduledIdsRef.current.delete(idStr);\r\n              const t2 = pollTimersByIdRef.current.get(idStr);\r\n              if (t2) {\r\n                clearTimeout(t2);\r\n                pollTimersByIdRef.current.delete(idStr);\r\n              }\r\n              return;\r\n            }\r\n            const timeStr2 = new Date(latestEndAt as number).toLocaleString('vi-VN');\r\n            const now3 = Date.now();\r\n            const updateData = {\r\n              isPollLocked: true as const,\r\n              pollLockedAt: now3,\r\n              editedAt: now3,\r\n              timestamp: now3,\r\n            };\r\n            try {\r\n              const result = await tryLockPollApi(String((latest2 as Message)._id), updateData);\r\n              if (result.success && result.modifiedCount && result.modifiedCount > 0) {\r\n                socketRef.current?.emit('edit_message', { _id: (latest2 as Message)._id, roomId, ...updateData });\r\n                await sendNotifyMessage(\r\n                  `Bình chọn đã tự động khóa: \"${String(\r\n                    (latest2 as Message).content || (latest2 as Message).pollQuestion || '',\r\n                  )}\" (kết thúc lúc ${timeStr2})`,\r\n                  String((latest2 as Message)._id),\r\n                );\r\n              }\r\n            } catch {}\r\n            pollScheduledIdsRef.current.delete(idStr);\r\n            pollTimersByIdRef.current.delete(idStr);\r\n          }, newDelay);\r\n          pollTimersByIdRef.current.set(idStr, newTimer);\r\n          return;\r\n        }\r\n        const timeStr = new Date((latestEndAt as number) || now2).toLocaleString('vi-VN');\r\n        const updateData = {\r\n          isPollLocked: true as const,\r\n          pollLockedAt: now2,\r\n          editedAt: now2,\r\n          timestamp: now2,\r\n        };\r\n        try {\r\n          const result = await tryLockPollApi(String((latest as Message)._id), updateData);\r\n          if (result.success && result.modifiedCount && result.modifiedCount > 0) {\r\n            socketRef.current?.emit('edit_message', { _id: (latest as Message)._id, roomId, ...updateData });\r\n            await sendNotifyMessage(\r\n              `Bình chọn đã tự động khóa: \"${String(\r\n                (latest as Message).content || (latest as Message).pollQuestion || '',\r\n              )}\" (kết thúc lúc ${timeStr})`,\r\n              String((latest as Message)._id),\r\n            );\r\n          }\r\n        } catch {}\r\n        pollScheduledIdsRef.current.delete(idStr);\r\n        pollTimersByIdRef.current.delete(idStr);\r\n      }, delay);\r\n      pollTimersByIdRef.current.set(idStr, timerId);\r\n      pollScheduledIdsRef.current.add(idStr);\r\n    },\r\n    [roomId, sendNotifyMessage, currentUser._id],\r\n  );\r\n\r\n  const { uploadingFiles, handleUploadAndSend } = useChatUpload({\r\n    roomId,\r\n    currentUser,\r\n    selectedChat,\r\n    isGroup,\r\n    sendMessageProcess,\r\n    setMessages,\r\n    onScrollBottom: scrollToBottom,\r\n  });\r\n  const uploadingValues = Object.values(uploadingFiles);\r\n  const hasUploading = uploadingValues.length > 0;\r\n  const overallUploadPercent = hasUploading\r\n    ? uploadingValues.reduce((sum, v) => sum + v, 0) / uploadingValues.length\r\n    : 0;\r\n  const uploadingCount = uploadingValues.length;\r\n\r\n  useEffect(() => {\r\n    const el = messagesContainerRef.current;\r\n    if (!el) return;\r\n    const latest = messages[messages.length - 1];\r\n    const mine = latest && String(latest.sender) === String(currentUser._id);\r\n    const should = mine || uploadingCount > 0;\r\n    if (initialLoading) return;\r\n    if (jumpLoadingRef.current) return;\r\n    // Nếu người dùng đã cuộn lên (không ở cuối) hoặc đang tải thêm tin cũ, không auto-scroll\r\n    const userScrolledUp = hasScrolledUpRef.current && !isAtBottomRef.current;\r\n    if (!should || userScrolledUp || loadingMore) return;\r\n    scrollToBottom();\r\n    setTimeout(scrollToBottom, 0);\r\n    setTimeout(scrollToBottom, 250);\r\n  }, [messages.length, uploadingCount, currentUser._id, scrollToBottom, loadingMore]);\r\n\r\n  useEffect(() => {\r\n    const el = messagesContainerRef.current;\r\n    if (!el) return;\r\n    const imgs = Array.from(el.querySelectorAll('img'));\r\n    const handler = () => {\r\n      const locked = !!scrollLockUntilRef.current && Date.now() < scrollLockUntilRef.current;\r\n      if (isAtBottomRef.current && !locked && !showSearchSidebar && !initialLoading) {\r\n        scrollToBottom();\r\n      }\r\n    };\r\n    imgs.forEach((img) => img.addEventListener('load', handler, { once: true }));\r\n    return () => {\r\n      imgs.forEach((img) => img.removeEventListener('load', handler));\r\n    };\r\n  }, [messages.length, scrollToBottom, showSearchSidebar]);\r\n\r\n  const { memberCount, activeMembers, handleMemberRemoved, handleRoleChange, handleMembersAdded } = useChatMembers({\r\n    selectedChat,\r\n    isGroup,\r\n    currentUser,\r\n    sendNotifyMessage,\r\n  });\r\n\r\n  const {\r\n    showMentionMenu,\r\n    mentionSuggestions,\r\n    selectedMentionIndex,\r\n    mentionMenuRef,\r\n    editableRef,\r\n    getPlainTextFromEditable,\r\n    parseMentions,\r\n    handleInputChangeEditable,\r\n    handleKeyDownEditable,\r\n    selectMention,\r\n    setShowMentionMenu,\r\n  } = useChatMentions({\r\n    allUsers,\r\n    activeMembers,\r\n    currentUser,\r\n  });\r\n\r\n  const dismissKeyboardAndScroll = useCallback(() => {\r\n    try {\r\n      (document.activeElement as HTMLElement | null)?.blur?.();\r\n    } catch {}\r\n    try {\r\n      editableRef.current?.blur?.();\r\n    } catch {}\r\n    scrollToBottom();\r\n    setTimeout(scrollToBottom, 0);\r\n    setTimeout(scrollToBottom, 150);\r\n  }, [editableRef, scrollToBottom]);\r\n\r\n  // Thêm option @all khi là nhóm\r\n  const ALL_MENTION_ID = '__ALL__';\r\n  const mentionSuggestionsWithAll = useMemo(() => {\r\n    if (!isGroup) return mentionSuggestions;\r\n\r\n    const allOption = {\r\n      _id: ALL_MENTION_ID,\r\n      name: 'All',\r\n      avatar: undefined,\r\n    } as User;\r\n\r\n    // Tránh trùng nếu đã có trong list\r\n    if (mentionSuggestions.some((u) => (u as User)._id === ALL_MENTION_ID)) return mentionSuggestions;\r\n\r\n    return [...mentionSuggestions, allOption];\r\n  }, [isGroup, mentionSuggestions]);\r\n\r\n  // Kết hợp keydown: vừa xử lý mention menu, vừa gửi tin nhắn với Enter\r\n  const handleKeyDownCombined = (e: React.KeyboardEvent<HTMLDivElement>) => {\r\n    // Đầu tiên cho hook xử lý (ArrowUp/Down, Enter để chọn mention, Escape...)\r\n    handleKeyDownEditable(e);\r\n\r\n    // Nếu mention menu đang mở, không xử lý gửi tin nhắn\r\n    if (showMentionMenu) return;\r\n\r\n    const el = editableRef.current;\r\n    if (!el) return;\r\n    const plain = String(el.innerText || '');\r\n    const trimmed = plain.trim();\r\n\r\n    // Toggle Chat nhanh theo '/key'\r\n    if (e.key === 'Enter' && !e.shiftKey && trimmed === '/key') {\r\n      e.preventDefault();\r\n      try {\r\n        localStorage.setItem(`chatFlashEnabled:${roomId}`, 'true');\r\n      } catch {}\r\n      el.innerText = '';\r\n      handleInputChangeEditable();\r\n      return;\r\n    }\r\n    if (e.key === ' ' && trimmed === '/key') {\r\n      try {\r\n        localStorage.setItem(`chatFlashEnabled:${roomId}`, 'false');\r\n      } catch {}\r\n    }\r\n\r\n    // Enter (không Shift) để gửi tin nhắn\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      let expanded = plain;\r\n      try {\r\n        const activeRaw = localStorage.getItem(`chatFlashActiveFolder:${roomId}`);\r\n        const active = activeRaw ? JSON.parse(activeRaw) : null;\r\n        const fid = active?.id;\r\n        const enabled = localStorage.getItem(`chatFlashEnabled:${roomId}`) === 'true';\r\n        if (fid && enabled) {\r\n          const kvRaw = localStorage.getItem(`chatFlashKV:${roomId}:${fid}`);\r\n          const arr = kvRaw ? JSON.parse(kvRaw) : [];\r\n          const map = new Map<string, string>(\r\n            (Array.isArray(arr) ? arr : []).map((x: { key: string; value: string }) => [\r\n              String(x.key),\r\n              String(x.value),\r\n            ]),\r\n          );\r\n          expanded = String(expanded).replace(/(^|\\s)\\/\\s*([\\w-]+)/g, (m: string, p1: string, k: string) => {\r\n            const v = map.get(k);\r\n            return v != null ? p1 + v : m;\r\n          });\r\n        }\r\n      } catch {}\r\n\r\n      if (expanded !== plain) {\r\n        el.innerText = expanded;\r\n        try {\r\n          const range = document.createRange();\r\n          range.selectNodeContents(el);\r\n          range.collapse(false);\r\n          const sel = window.getSelection();\r\n          sel?.removeAllRanges();\r\n          sel?.addRange(range);\r\n        } catch {}\r\n        handleInputChangeEditable();\r\n        return;\r\n      }\r\n      void handleSendMessage();\r\n    }\r\n  };\r\n\r\n  // ✅ FIXED VERSION - Đặt trong ChatWindow.tsx\r\n\r\n  const handleToggleReaction = useCallback(\r\n    async (msg: Message, emoji: string) => {\r\n      const myId = String(currentUser._id);\r\n      const old = (msg.reactions || {}) as Record<string, string[]>;\r\n\r\n      // Clean up và toggle reaction\r\n      const cleaned: Record<string, string[]> = Object.fromEntries(\r\n        Object.entries(old).map(([k, arr]) => [k, (Array.isArray(arr) ? arr : []).filter((id) => String(id) !== myId)]),\r\n      );\r\n\r\n      const had = Array.isArray(old[emoji]) && old[emoji].includes(myId);\r\n      const next: Record<string, string[]> = { ...cleaned };\r\n      const arr = Array.isArray(next[emoji]) ? next[emoji] : [];\r\n      next[emoji] = had ? arr.filter((id) => String(id) !== myId) : [...arr, myId];\r\n\r\n      // 1. ✅ Optimistic Update UI ngay lập tức\r\n      setMessages((prev) => prev.map((m) => (String(m._id) === String(msg._id) ? { ...m, reactions: next } : m)));\r\n\r\n      // 2. ✅ Tạo payload đầy đủ cho socket\r\n      const socketPayload = {\r\n        _id: msg._id,\r\n        roomId,\r\n        reactions: next,\r\n        // Thêm thông tin để server có thể broadcast đầy đủ\r\n        sender: currentUser._id,\r\n        senderName: currentUser.name,\r\n        isGroup: isGroup,\r\n        receiver: isGroup ? null : getId(selectedChat),\r\n        members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n      };\r\n\r\n      // 3. ✅ Emit socket với error handling tốt hơn\r\n      try {\r\n        if (socketRef.current?.connected) {\r\n          socketRef.current.emit('toggle_reaction', socketPayload);\r\n        } else {\r\n          // Fallback: reconnect và emit\r\n          const tempSocket = io(resolveSocketUrl(), {\r\n            transports: ['websocket'],\r\n            withCredentials: false,\r\n          });\r\n\r\n          tempSocket.on('connect', () => {\r\n            tempSocket.emit('toggle_reaction', socketPayload);\r\n            setTimeout(() => tempSocket.disconnect(), 500);\r\n          });\r\n        }\r\n      } catch (error) {\r\n        console.error('❌ Socket emit error:', error);\r\n      }\r\n\r\n      // 4. ✅ Gọi API để persist vào DB\r\n      try {\r\n        await updateMessageApi(String(msg._id), { reactions: next });\r\n      } catch (error) {\r\n        console.error('❌ API update error:', error);\r\n\r\n        // Rollback nếu API fail\r\n        setMessages((prev) => prev.map((m) => (String(m._id) === String(msg._id) ? { ...m, reactions: old } : m)));\r\n      }\r\n    },\r\n    [currentUser._id, currentUser.name, roomId, isGroup, selectedChat],\r\n  );\r\n\r\n  const handleContextMenu = useCallback(\r\n    (e: React.MouseEvent, msg: Message) => {\r\n      e.preventDefault();\r\n      const target = e.currentTarget as HTMLElement;\r\n      const rect = target.getBoundingClientRect();\r\n      const menuWidth = 200;\r\n      const senderId = (() => {\r\n        const idA = (msg.sender as unknown as { _id?: unknown })?._id;\r\n        const idB = (msg.sender as unknown as { id?: unknown })?.id;\r\n        return String(idA ?? idB ?? msg.sender ?? '');\r\n      })();\r\n      const isMe = senderId === String(currentUser._id);\r\n      const isText = msg.type === 'text';\r\n      const isRecalled = !!msg.isRecalled;\r\n      const canShare = !isRecalled;\r\n      const canPin = !isRecalled;\r\n      const canReply = !isRecalled;\r\n      const canEdit = isMe && isText && !isRecalled;\r\n      const canCopy = isText && !isRecalled;\r\n      const canDownload = !!msg.fileUrl && (msg.type === 'image' || msg.type === 'file' || msg.type === 'sticker');\r\n      const canRecall = isMe && !isRecalled;\r\n      const itemCount = [canShare, canPin, canReply, canEdit, canCopy, canDownload, canRecall].filter(Boolean).length;\r\n      const ITEM_H = 36;\r\n      const PADDING = 8;\r\n      const menuHeight = Math.max(ITEM_H + PADDING, itemCount * (ITEM_H + 4) + PADDING);\r\n\r\n      const viewportW = window.innerWidth;\r\n      const viewportH = window.innerHeight;\r\n      let placement: 'above' | 'below' = 'below';\r\n\r\n      let x: number;\r\n      let y: number;\r\n      if (isText) {\r\n        x = e.clientX - menuWidth / 2;\r\n        y = e.clientY - menuHeight / 2;\r\n      } else {\r\n        x = rect.left + rect.width / 2 - menuWidth / 2;\r\n        y = rect.top + rect.height / 2 - menuHeight / 2;\r\n      }\r\n      if (x + menuWidth > viewportW) x = viewportW - menuWidth - 8;\r\n      if (x < 8) x = 8;\r\n      if (y + menuHeight > viewportH) {\r\n        y = Math.max(8, viewportH - menuHeight - 8);\r\n        placement = 'above';\r\n      }\r\n      if (y < 8) y = 8;\r\n      setContextMenu({\r\n        visible: true,\r\n        x,\r\n        y,\r\n        placement,\r\n        message: msg,\r\n      });\r\n    },\r\n    [currentUser._id],\r\n  );\r\n\r\n  const handleMobileLongPress = useCallback(\r\n    (msg: Message, el: HTMLElement, startX: number, startY: number) => {\r\n      try {\r\n        const rect = el.getBoundingClientRect();\r\n        const menuHeight = 260;\r\n        const viewportH = typeof window !== 'undefined' ? window.innerHeight : 800;\r\n        const viewportW = typeof window !== 'undefined' ? window.innerWidth : 600;\r\n        const kind = String(msg.type || '');\r\n        const isVisual = kind === 'image';\r\n        const collapsedHeight = Math.floor(viewportH * (isVisual ? 0.5 : 0.34));\r\n        const effectiveHeight = isVisual ? collapsedHeight : Math.min(rect.height, collapsedHeight);\r\n        try {\r\n          el.scrollIntoView({ behavior: 'auto', block: 'center' });\r\n        } catch {}\r\n        const heavy = effectiveHeight > viewportH * 0.3;\r\n        const medium = effectiveHeight > viewportH * 0.22;\r\n        const baseTopRatio = heavy ? 0.12 : medium ? 0.16 : 0.2;\r\n        const baseTop = Math.floor(viewportH * baseTopRatio);\r\n        const safeBottomGap = 20;\r\n        const clamp = (v: number, minV: number, maxV: number) => Math.max(minV, Math.min(v, maxV));\r\n        const maxTop = viewportH - effectiveHeight - menuHeight - safeBottomGap;\r\n        const focusTop = clamp(baseTop, 8, maxTop);\r\n        const placement: 'above' | 'below' = 'below';\r\n        const yBelow = focusTop + effectiveHeight + 16;\r\n\r\n        let patchedMsg = msg;\r\n        try {\r\n          const idx = messages.findIndex((m) => String(m._id) === String(msg._id));\r\n          const kind = String(msg.type || '');\r\n          const isMedia = kind === 'image' || kind === 'video';\r\n          const isFileNonVideo = kind === 'file' && !(msg.fileUrl && isVideoFile(String(msg.fileUrl)));\r\n          if (idx >= 0 && (isMedia || isFileNonVideo)) {\r\n            const senderId = (() => {\r\n              const idA = (msg.sender as unknown as { _id?: unknown })?._id;\r\n              const idB = (msg.sender as unknown as { id?: unknown })?.id;\r\n              return String(idA ?? idB ?? msg.sender ?? '');\r\n            })();\r\n            const group: Message[] = [messages[idx]];\r\n            for (let k = idx + 1; k < messages.length; k += 1) {\r\n              const next = messages[k];\r\n              if (next.isRecalled) break;\r\n              const nextKind = String(next.type || '');\r\n              const nextIsMedia = nextKind === 'image' || nextKind === 'video';\r\n              const nextIsFileNonVideo = nextKind === 'file' && !(next.fileUrl && isVideoFile(String(next.fileUrl)));\r\n              if (isMedia ? !nextIsMedia : !nextIsFileNonVideo) break;\r\n              const nextSenderId = (() => {\r\n                const idA = (next.sender as unknown as { _id?: unknown })?._id;\r\n                const idB = (next.sender as unknown as { id?: unknown })?.id;\r\n                return String(idA ?? idB ?? next.sender ?? '');\r\n              })();\r\n              const dt = Math.abs(Number(next.timestamp) - Number(group[group.length - 1].timestamp));\r\n              if (nextSenderId !== senderId || dt > 120000) break;\r\n              group.push(next);\r\n            }\r\n            if (group.length > 1) {\r\n              const items = group.map((m) => ({\r\n                id: String(m._id),\r\n                content: m.content || '',\r\n                type: m.type === 'video' ? 'video' : m.type === 'image' ? 'image' : 'file',\r\n                fileUrl: String(m.fileUrl || m.previewUrl || ''),\r\n                fileName: m.fileName,\r\n              }));\r\n              patchedMsg = { ...msg, batchItems: items } as unknown as Message;\r\n            }\r\n          }\r\n        } catch {}\r\n\r\n        setContextMenu({\r\n          visible: true,\r\n          x: Math.floor(viewportW / 2),\r\n          y: Math.max(8, yBelow),\r\n          placement,\r\n          message: patchedMsg,\r\n          focusTop,\r\n          focusHeight: effectiveHeight,\r\n        });\r\n      } catch {}\r\n    },\r\n    [messages],\r\n  );\r\n\r\n  const closeContextMenu = useCallback(() => {\r\n    setContextMenu(null);\r\n  }, []);\r\n\r\n  const { playMessageSound, showMessageNotification, flashTabTitle } = useChatNotifications({ chatName });\r\n\r\n  useEffect(() => {\r\n    if (!contextMenu?.visible) return;\r\n\r\n    const handleClickOutside = (e: MouseEvent) => {\r\n      const target = e.target as HTMLElement;\r\n\r\n      const contextMenuElement = document.querySelector('[data-context-menu=\"true\"]');\r\n      if (contextMenuElement && contextMenuElement.contains(target)) {\r\n        return;\r\n      }\r\n      closeContextMenu();\r\n    };\r\n\r\n    setTimeout(() => {\r\n      document.addEventListener('mousedown', handleClickOutside);\r\n    }, 0);\r\n\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, [contextMenu, closeContextMenu]);\r\n\r\n  useEffect(() => {\r\n    if (!contextMenu?.visible) return;\r\n    const el = document.querySelector('[data-context-menu=\"true\"]') as HTMLElement | null;\r\n    if (!el) return;\r\n    const rect = el.getBoundingClientRect();\r\n    const pad = 8;\r\n    let x = contextMenu.x;\r\n    let y = contextMenu.y;\r\n    let placement: 'above' | 'below' = contextMenu.placement ?? 'below';\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n    if (x + rect.width + pad > vw) {\r\n      x = vw - rect.width - pad;\r\n    }\r\n    if (x < pad) {\r\n      x = pad;\r\n    }\r\n    if (y + rect.height + pad > vh) {\r\n      y = Math.max(pad, y - rect.height);\r\n      placement = 'above';\r\n    }\r\n    if (y < pad) {\r\n      y = pad;\r\n    }\r\n    if (x !== contextMenu.x || y !== contextMenu.y || placement !== contextMenu.placement) {\r\n      setContextMenu({ ...contextMenu, x, y, placement });\r\n    }\r\n  }, [contextMenu]);\r\n\r\n  useEffect(() => {\r\n    if (!contextMenu?.visible) return;\r\n    const container = messagesContainerRef.current;\r\n    if (!container) return;\r\n    const closeOnScroll = () => {\r\n      closeContextMenu();\r\n    };\r\n    container.addEventListener('scroll', closeOnScroll, { passive: true });\r\n    return () => container.removeEventListener('scroll', closeOnScroll);\r\n  }, [contextMenu, closeContextMenu]);\r\n\r\n  useEffect(() => {\r\n    if (!scrollToMessageId) return;\r\n    initialScrolledRef.current = true;\r\n    setTimeout(() => {\r\n      handleJumpToMessage(scrollToMessageId);\r\n      if (typeof onScrollComplete === 'function') onScrollComplete();\r\n    }, 50);\r\n  }, [scrollToMessageId, handleJumpToMessage, onScrollComplete]);\r\n\r\n  useEffect(() => {\r\n    const container = messagesContainerRef.current;\r\n    if (!container) return;\r\n    if (isMobile && showSearchSidebar) return;\r\n    if (!initialScrolledRef.current && messages.length > 0 && !jumpLoadingRef.current && !scrollToMessageId) {\r\n      container.scrollTop = container.scrollHeight;\r\n      initialScrolledRef.current = true;\r\n    }\r\n  }, [messages.length, roomId, scrollToMessageId, isMobile, showSearchSidebar]);\r\n  // 🔥 USEMEMO: Phân loại tin nhắn\r\n  const messagesGrouped = useMemo(() => groupMessagesByDate(messages), [messages]);\r\n\r\n  const [messageToPin, setMessageToPin] = useState<Message | null>(null);\r\n  const [showPinTitleModal, setShowPinTitleModal] = useState(false);\r\n\r\n  const executePinMessage = async (message: Message, newPinnedStatus: boolean, pinnedTitle?: string) => {\r\n    const cleanTitle = pinnedTitle?.trim();\r\n    // 1. Cập nhật trạng thái local trước (Optimistic update)\r\n    const updatedMessage = {\r\n      ...message,\r\n      isPinned: newPinnedStatus,\r\n      pinnedTitle: cleanTitle,\r\n      pinnedAt: newPinnedStatus ? Date.now() : null,\r\n    };\r\n    setPinnedMessage(newPinnedStatus ? updatedMessage : null);\r\n\r\n    try {\r\n      const res = await fetch('/api/messages', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'togglePin',\r\n          messageId: message._id,\r\n          data: { isPinned: newPinnedStatus, pinnedTitle: cleanTitle },\r\n        }),\r\n      });\r\n\r\n      if (res.ok) {\r\n        // 2. Cập nhật danh sách messages và pinnedMessage\r\n        setMessages((prev) =>\r\n          prev.map((m) =>\r\n            m._id === message._id\r\n              ? {\r\n                  ...m,\r\n                  isPinned: newPinnedStatus,\r\n                  pinnedTitle: cleanTitle,\r\n                  pinnedAt: newPinnedStatus ? Date.now() : null,\r\n                }\r\n              : m,\r\n          ),\r\n        );\r\n        setAllPinnedMessages((prev) => {\r\n          const updatedMsg = {\r\n            ...message,\r\n            isPinned: newPinnedStatus,\r\n            pinnedTitle: cleanTitle,\r\n            editedAt: Date.now(),\r\n            pinnedAt: newPinnedStatus ? Date.now() : null,\r\n          } as Message;\r\n          const withoutDup = prev.filter((m) => String(m._id) !== String(message._id));\r\n          const next = newPinnedStatus ? [updatedMsg, ...withoutDup] : withoutDup;\r\n          return next.sort((a, b) => Number(b.pinnedAt ?? 0) - Number(a.pinnedAt ?? 0));\r\n        });\r\n\r\n        // 2.2. Bắn socket ngay để cập nhật realtime cho tất cả client\r\n        socketRef.current?.emit('edit_message', {\r\n          _id: message._id,\r\n          roomId,\r\n          isPinned: newPinnedStatus,\r\n          pinnedTitle: cleanTitle,\r\n          pinnedAt: newPinnedStatus ? Date.now() : null,\r\n        });\r\n\r\n        // 🔥 BƯỚC MỚI: GỬI THÔNG BÁO VÀO NHÓM\r\n        const action = newPinnedStatus ? 'đã ghim' : 'đã bỏ ghim';\r\n        const senderName = currentUser.name || 'Một thành viên';\r\n        let notificationText = '';\r\n\r\n        // Tạo nội dung thông báo dựa trên loại tin nhắn\r\n        if (message.type === 'text') {\r\n          notificationText = `${senderName} ${action} một tin nhắn văn bản.`;\r\n        } else if (message.type === 'image') {\r\n          notificationText = `${senderName} ${action} một hình ảnh.`;\r\n        } else if (message.type === 'file') {\r\n          notificationText = `${senderName} ${action} tệp tin \"${message.fileName || 'file'}\".`;\r\n        } else if (message.type === 'poll') {\r\n          notificationText = `${senderName} ${action} một bình chọn.`;\r\n        } else {\r\n          notificationText = `${senderName} ${action} một tin nhắn.`;\r\n        }\r\n\r\n        if (newPinnedStatus && cleanTitle) {\r\n          notificationText += ` Tiêu đề: \"${cleanTitle}\"`;\r\n        }\r\n\r\n        await sendNotifyMessage(notificationText);\r\n        // 🔥 END BƯỚC MỚI\r\n      } else {\r\n        // Nếu API fail, roll back local state\r\n        setPinnedMessage(message.isPinned ? message : null);\r\n        console.error('API togglePin failed');\r\n      }\r\n    } catch (error) {\r\n      console.error('Ghim tin nhắn thất bại', error);\r\n\r\n      // 3. Roll back trạng thái local nếu có lỗi mạng/server\r\n      setPinnedMessage(message.isPinned ? message : null);\r\n    }\r\n  };\r\n\r\n  const handlePinMessage = async (message: Message) => {\r\n    if (message.isPinned) {\r\n      executePinMessage(message, false);\r\n    } else {\r\n      setMessageToPin(message);\r\n      setShowPinTitleModal(true);\r\n    }\r\n  };\r\n\r\n  //useEffect ghim tin nhắn\r\n  useEffect(() => {\r\n    if (messages.length > 0) {\r\n      const currentlyPinned = messages.find((m) => m.isPinned);\r\n\r\n      setPinnedMessage(currentlyPinned || null);\r\n    } else {\r\n      setPinnedMessage(null);\r\n    }\r\n  }, [messages]);\r\n\r\n  const loadMoreMessages = useCallback(async () => {\r\n    if (!roomId || loadingMore || !hasMore || oldestTs == null) return;\r\n    const container = messagesContainerRef.current;\r\n    setLoadingMore(true);\r\n    setShowScrollDown(true);\r\n    const prevHeight = container ? container.scrollHeight : 0;\r\n    let added = false;\r\n    try {\r\n      const LIMIT = 20;\r\n      const data = await readMessagesApi(roomId, { limit: LIMIT, before: oldestTs, sortOrder: 'desc' });\r\n      const raw = Array.isArray(data.data) ? (data.data as Message[]) : [];\r\n      const existing = new Set(messages.map((m) => String(m._id)));\r\n      const toAddDesc = raw.filter((m) => !existing.has(String(m._id)));\r\n      const toAddAsc = toAddDesc.slice().reverse();\r\n      if (toAddAsc.length > 0) {\r\n        setMessages((prev) => [...toAddAsc, ...prev]);\r\n        const newOldest = toAddAsc[0]?.timestamp ?? oldestTs;\r\n        setOldestTs(newOldest ?? oldestTs);\r\n        added = true;\r\n      }\r\n      setHasMore(raw.length === LIMIT);\r\n      if (container && !jumpLoadingRef.current) {\r\n        setTimeout(() => {\r\n          const newHeight = container.scrollHeight;\r\n          const delta = newHeight - prevHeight;\r\n          container.scrollTop = delta + SCROLL_BUMP_PX;\r\n        }, 0);\r\n      }\r\n    } catch (e) {\r\n      console.error('Load more messages error:', e);\r\n      setHasMore(false);\r\n    } finally {\r\n      setLoadingMore(false);\r\n    }\r\n    return added;\r\n  }, [roomId, loadingMore, hasMore, oldestTs, messages]);\r\n\r\n  useEffect(() => {\r\n    const el = messagesContainerRef.current;\r\n    if (!el) return;\r\n    const handler = () => {\r\n      if (\r\n        el.scrollTop <= 50 &&\r\n        !jumpLoadingRef.current &&\r\n        !showSearchSidebar &&\r\n        initialScrolledRef.current &&\r\n        !initialLoading\r\n      ) {\r\n        void loadMoreMessages();\r\n      }\r\n      const bottomGap = el.scrollHeight - el.scrollTop - el.clientHeight;\r\n      const atBottom = bottomGap <= SCROLL_BUMP_PX;\r\n      isAtBottomRef.current = atBottom;\r\n      if (!atBottom && bottomGap > BUTTON_SHOW_THRESHOLD_PX) {\r\n        hasScrolledUpRef.current = true;\r\n      }\r\n      if (atBottom && !loadingMore) {\r\n        hasScrolledUpRef.current = false;\r\n        setPendingNewCount(0);\r\n        pendingNewCountRef.current = 0;\r\n      }\r\n      setShowScrollDown(hasScrolledUpRef.current || pendingNewCountRef.current > 0 || loadingMore);\r\n    };\r\n    el.addEventListener('scroll', handler);\r\n    return () => el.removeEventListener('scroll', handler);\r\n  }, [loadMoreMessages, loadingMore]);\r\n\r\n  const handleReplyTo = useCallback((message: Message) => {\r\n    setReplyingTo(message);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!scrollToMessageId) return;\r\n    const timer = setTimeout(() => {\r\n      void handleJumpToMessage(scrollToMessageId);\r\n      onScrollComplete?.();\r\n    }, 0);\r\n    return () => clearTimeout(timer);\r\n  }, [scrollToMessageId, initialLoading, oldestTs, messages.length, handleJumpToMessage, onScrollComplete]);\r\n\r\n  // Khi giao diện footer thay đổi (mở emoji, reply, mention...), cuộn xuống để tránh bị che\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n    // Thêm delay nhỏ để đảm bảo DOM đã cập nhật height của footer\r\n    setTimeout(scrollToBottom, 50);\r\n    setTimeout(scrollToBottom, 150);\r\n  }, [showEmojiPicker, pickerTab, replyingTo, showMentionMenu, attachments.length, scrollToBottom]);\r\n\r\n  useEffect(() => {\r\n    const handler = () => {\r\n      scrollToBottom();\r\n      setTimeout(scrollToBottom, 50);\r\n      setTimeout(scrollToBottom, 150);\r\n    };\r\n    window.addEventListener('mobileActionsToggle', handler);\r\n    return () => window.removeEventListener('mobileActionsToggle', handler);\r\n  }, [scrollToBottom]);\r\n\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const anyE = e as unknown as { detail?: { roomId?: string } };\r\n      const d = anyE.detail || {};\r\n      if (String(d.roomId) !== String(roomId)) return;\r\n      setMessages([]);\r\n      setAllPinnedMessages([]);\r\n      setHasMore(false);\r\n      setOldestTs(null);\r\n    };\r\n    window.addEventListener('chatHistoryCleared', handler as EventListener);\r\n    return () => window.removeEventListener('chatHistoryCleared', handler as EventListener);\r\n  }, [roomId]);\r\n\r\n  const { isListening, handleVoiceInput } = useChatVoiceInput({\r\n    editableRef,\r\n    handleInputChangeEditable,\r\n  });\r\n\r\n  const onEmojiClick = useCallback(\r\n    (emoji: EmojiClickData | string) => {\r\n      if (!editableRef.current) return;\r\n\r\n      const toString = (input: EmojiClickData | string): string => {\r\n        const raw = typeof input === 'string' ? input : input.emoji;\r\n        const hexLike = /^[0-9a-fA-F-]+$/;\r\n        if (hexLike.test(raw)) {\r\n          const codePoints = raw\r\n            .split('-')\r\n            .map((h) => parseInt(h, 16))\r\n            .filter((n) => !Number.isNaN(n));\r\n          if (codePoints.length > 0) return String.fromCodePoint(...codePoints);\r\n        }\r\n        return raw;\r\n      };\r\n\r\n      const editable = editableRef.current;\r\n      const value = toString(emoji);\r\n      editable.focus();\r\n      insertTextAtCursor(editable, value);\r\n      handleInputChangeEditable();\r\n    },\r\n    [editableRef, handleInputChangeEditable],\r\n  );\r\n\r\n  const handleSendSticker = useCallback(\r\n    async (url: string) => {\r\n      ensureBottom();\r\n      const newMsg: MessageCreate = {\r\n        roomId,\r\n        sender: currentUser._id,\r\n        fileUrl: url,\r\n        type: 'sticker',\r\n        timestamp: Date.now(),\r\n      };\r\n      await sendMessageProcess(newMsg);\r\n      setShowEmojiPicker(false);\r\n    },\r\n    [roomId, currentUser._id, sendMessageProcess, ensureBottom],\r\n  );\r\n\r\n  const fetchPinnedMessages = useCallback(async () => {\r\n    try {\r\n      setPinnedLoading(true);\r\n      const json = await readPinnedMessagesApi(roomId, { limit: PINNED_PAGE_SIZE, skip: 0 });\r\n      const arr = (json.data as Message[]) || [];\r\n      setAllPinnedMessages(arr);\r\n      const totalRaw = (json as { total?: number }).total;\r\n      const total: number | null = typeof totalRaw === 'number' ? totalRaw : null;\r\n      setPinnedTotal(total);\r\n      setPinnedSkip(arr.length);\r\n    } catch (error) {\r\n      console.error('Fetch Pinned messages error:', error);\r\n      setAllPinnedMessages([]);\r\n      setPinnedTotal(null);\r\n      setPinnedSkip(0);\r\n    } finally {\r\n      setPinnedLoading(false);\r\n    }\r\n  }, [roomId, PINNED_PAGE_SIZE]);\r\n\r\n  const fetchMessages = useCallback(async () => {\r\n    try {\r\n      setInitialLoading(true);\r\n      const targetCount = 20;\r\n      const batchSize = 50;\r\n      let beforeTs: number | undefined = undefined;\r\n      let lastBatchLen = 0;\r\n      const map = new Map<string, Message>();\r\n      const isContent = (t: unknown) => {\r\n        const s = String(t || '');\r\n        return s === 'text' || s === 'image' || s === 'video';\r\n      };\r\n      while (true) {\r\n        const resp = await readMessagesApi(roomId, { limit: batchSize, sortOrder: 'desc', before: beforeTs });\r\n        const raw = Array.isArray(resp.data) ? (resp.data as Message[]) : [];\r\n        lastBatchLen = raw.length;\r\n        if (raw.length === 0) break;\r\n        raw.forEach((m) => {\r\n          const id = String(m._id);\r\n          if (!map.has(id)) map.set(id, m);\r\n        });\r\n        const descProbe = Array.from(map.values()).sort((a: Message, b: Message) => {\r\n          const ta = Number(a.serverTimestamp ?? a.timestamp) || 0;\r\n          const tb = Number(b.serverTimestamp ?? b.timestamp) || 0;\r\n          if (tb !== ta) return tb - ta;\r\n          const ia = String(a._id || '');\r\n          const ib = String(b._id || '');\r\n          return ib.localeCompare(ia);\r\n        });\r\n        const contentCount = descProbe.reduce((acc, m) => acc + (isContent(m.type) ? 1 : 0), 0);\r\n        const minBatchTs = raw.reduce(\r\n          (min, m) => {\r\n            const ts = Number(m.serverTimestamp ?? m.timestamp) || 0;\r\n            return min === null || ts < (min as number) ? ts : (min as number);\r\n          },\r\n          null as number | null,\r\n        );\r\n        beforeTs = typeof minBatchTs === 'number' ? minBatchTs : undefined;\r\n        if (contentCount >= targetCount) break;\r\n        if (raw.length < batchSize) break;\r\n      }\r\n      const desc = Array.from(map.values()).sort((a: Message, b: Message) => {\r\n        const ta = Number(a.serverTimestamp ?? a.timestamp) || 0;\r\n        const tb = Number(b.serverTimestamp ?? b.timestamp) || 0;\r\n        if (tb !== ta) return tb - ta;\r\n        const ia = String(a._id || '');\r\n        const ib = String(b._id || '');\r\n        return ib.localeCompare(ia);\r\n      });\r\n      const asc = desc.slice().reverse();\r\n      setMessages(asc);\r\n      try {\r\n        const rawPending = localStorage.getItem(`pendingUploads:${roomId}`);\r\n        const arr = rawPending\r\n          ? (JSON.parse(rawPending) as Array<{\r\n              tempId: string;\r\n              type: MessageType;\r\n              fileName: string;\r\n              caption?: string;\r\n              fileUrl: string;\r\n            }>)\r\n          : [];\r\n        if (Array.isArray(arr) && arr.length > 0) {\r\n          setMessages((prev) => {\r\n            const existing = new Set(prev.map((m) => String(m._id)));\r\n            const toAdd = arr\r\n              .filter((x) => !existing.has(String(x.tempId)))\r\n              .map((x) => ({\r\n                _id: x.tempId,\r\n                roomId,\r\n                sender: currentUser._id,\r\n                senderModel: currentUser,\r\n                type: x.type,\r\n                fileUrl: x.fileUrl,\r\n                fileName: x.fileName,\r\n                timestamp: Date.now(),\r\n                content: x.caption,\r\n                isSending: true,\r\n              })) as Message[];\r\n            const combined = [...prev, ...toAdd];\r\n            combined.sort((a, b) => {\r\n              const ta = Number(a.timestamp) || 0;\r\n              const tb = Number(b.timestamp) || 0;\r\n              return ta - tb;\r\n            });\r\n            return combined;\r\n          });\r\n        }\r\n      } catch {}\r\n      const first = asc[0]?.timestamp ?? null;\r\n      setOldestTs(first ?? null);\r\n      setHasMore(lastBatchLen >= batchSize || asc.length > 0);\r\n      setInitialLoading(false);\r\n    } catch (error) {\r\n      console.error('Fetch messages error:', error);\r\n      setMessages([]);\r\n      setHasMore(false);\r\n      setOldestTs(null);\r\n      setInitialLoading(false);\r\n    }\r\n  }, [roomId]);\r\n\r\n  const loadMorePinnedMessages = useCallback(async () => {\r\n    if (pinnedLoading) return;\r\n    const total = pinnedTotal ?? 0;\r\n    if (total > 0 && allPinnedMessages.length >= total) return;\r\n    try {\r\n      setPinnedLoading(true);\r\n      const json = await readPinnedMessagesApi(roomId, { limit: PINNED_PAGE_SIZE, skip: pinnedSkip });\r\n      const arr = (json.data as Message[]) || [];\r\n      if (arr.length > 0) {\r\n        setAllPinnedMessages((prev) => {\r\n          const existing = new Set(prev.map((m) => String(m._id)));\r\n          const merged = [...prev, ...arr.filter((m) => !existing.has(String(m._id)))];\r\n          return merged.sort((a, b) => Number(b.pinnedAt ?? 0) - Number(a.pinnedAt ?? 0));\r\n        });\r\n        setPinnedSkip((s) => s + arr.length);\r\n      }\r\n      const totalRaw = (json as { total?: number }).total;\r\n      const totalNext: number | null = typeof totalRaw === 'number' ? totalRaw : pinnedTotal;\r\n      setPinnedTotal(totalNext);\r\n    } catch (e) {\r\n      console.error('Load more pinned messages error:', e);\r\n    } finally {\r\n      setPinnedLoading(false);\r\n    }\r\n  }, [pinnedLoading, pinnedTotal, allPinnedMessages.length, roomId, PINNED_PAGE_SIZE, pinnedSkip]);\r\n\r\n  // Chỉ load lại dữ liệu khi roomId thay đổi (tránh gọi API lại khi click cùng một group nhiều lần)\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n    setMessages([]);\r\n    void fetchMessages();\r\n    setAllPinnedMessages([]);\r\n    setPinnedSkip(0);\r\n    setPinnedTotal(null);\r\n    void fetchPinnedMessages();\r\n    initialScrolledRef.current = false;\r\n  }, [roomId, fetchMessages, fetchPinnedMessages]);\r\n\r\n  // Đồng bộ tin nhắn khi mở lại cùng phòng (selectedChat thay đổi nhưng roomId giữ nguyên)\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n    void fetchMessages();\r\n  }, [selectedChat, roomId, fetchMessages]);\r\n\r\n  const [nicknamesStamp, setNicknamesStamp] = useState(0);\r\n  const allUsersMap = useMemo(() => {\r\n    const map = new Map<string, string>();\r\n    const myId = String(currentUser?._id || '');\r\n    let roomNickMap: Record<string, string> = {};\r\n    try {\r\n      const raw = roomId && myId ? localStorage.getItem(`roomNicknames:${roomId}:${myId}`) : null;\r\n      roomNickMap = raw ? (JSON.parse(raw) as Record<string, string>) : {};\r\n    } catch {}\r\n\r\n    if (currentUser) {\r\n      const myRoomNick = roomNickMap[String(currentUser._id)];\r\n      const name = myRoomNick || currentUser.name || 'Bạn';\r\n      if (currentUser._id) map.set(String(currentUser._id), name);\r\n    }\r\n    if (Array.isArray(allUsers)) {\r\n      allUsers.forEach((user) => {\r\n        const nickname = roomNickMap[String(user._id)] || user.nicknames?.[myId];\r\n        const displayName = nickname || user.name;\r\n        if (displayName) {\r\n          if (user._id) map.set(String(user._id), displayName);\r\n        }\r\n      });\r\n    }\r\n\r\n    if (isGroup && Array.isArray(activeMembers)) {\r\n      activeMembers.forEach((mem) => {\r\n        const memUser = mem as unknown as User;\r\n        // 🔥 Use nickname from Group Member Data (Global) or Personal Nickname (Local)\r\n        const nickname = (mem as MemberInfo).nickname || memUser.nicknames?.[myId];\r\n        const displayName = nickname || memUser.name || 'Thành viên';\r\n        if (mem._id) map.set(String(mem._id), displayName);\r\n      });\r\n    }\r\n    return map;\r\n  }, [currentUser, allUsers, isGroup, activeMembers, roomId, nicknamesStamp]);\r\n\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const d = (e as CustomEvent).detail || {};\r\n      const type: 'image' | 'video' = d.type === 'video' ? 'video' : 'image';\r\n      const myId = String(currentUser._id);\r\n      const senderNick = allUsersMap.get(myId) || currentUser.name;\r\n      if (type === 'image' && typeof d.imageDataUrl === 'string') {\r\n        try {\r\n          const dataUrl: string = d.imageDataUrl;\r\n          const arr = dataUrl.split(',');\r\n          const mime = arr[0].match(/:(.*?);/)?.[1] || 'image/jpeg';\r\n          const bstr = atob(arr[1]);\r\n          let n = bstr.length;\r\n          const u8arr = new Uint8Array(n);\r\n          while (n--) u8arr[n] = bstr.charCodeAt(n);\r\n          const blob = new Blob([u8arr], { type: mime });\r\n          const file = new File([blob], 'edited.jpg', { type: mime });\r\n          const previewUrl = URL.createObjectURL(blob);\r\n          setAttachments((prev) => [...prev, { file, type: 'image', previewUrl, fileName: 'edited.jpg' }]);\r\n          dismissKeyboardAndScroll();\r\n        } catch {}\r\n      } else if (type === 'video' && typeof d.originalUrl === 'string') {\r\n        (async () => {\r\n          try {\r\n            const res = await fetch(getProxyUrl(d.originalUrl));\r\n            const blob = await res.blob();\r\n            const mime = blob.type || 'video/mp4';\r\n            const file = new File([blob], 'edited.mp4', { type: mime });\r\n            const previewUrl = URL.createObjectURL(blob);\r\n            setAttachments((prev) => [\r\n              ...prev,\r\n              {\r\n                file,\r\n                type: 'video',\r\n                previewUrl,\r\n                fileName: 'edited.mp4',\r\n                videoCropConfig: d.videoCropConfig || null,\r\n              },\r\n            ]);\r\n            dismissKeyboardAndScroll();\r\n          } catch {}\r\n        })();\r\n      }\r\n    };\r\n    window.addEventListener('sendEditedMedia', handler as EventListener);\r\n    return () => window.removeEventListener('sendEditedMedia', handler as EventListener);\r\n  }, [currentUser._id, allUsersMap, handleUploadAndSend, dismissKeyboardAndScroll]);\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const anyE = e as unknown as {\r\n        detail?: { roomId?: string; userId?: string; targetUserId?: string; nickname?: string };\r\n      };\r\n      const d = anyE.detail || {};\r\n      if (String(d.roomId) !== String(roomId)) return;\r\n      setNicknamesStamp((s) => s + 1);\r\n      if (isGroup && d.targetUserId) {\r\n        try {\r\n          const nick = typeof d.nickname === 'string' ? d.nickname : '';\r\n          socketRef.current?.emit('room_nickname_updated', {\r\n            roomId,\r\n            targetUserId: String(d.targetUserId),\r\n            nickname: nick,\r\n          });\r\n        } catch {}\r\n      }\r\n    };\r\n    window.addEventListener('roomNicknamesUpdated', handler as EventListener);\r\n    return () => window.removeEventListener('roomNicknamesUpdated', handler as EventListener);\r\n  }, [roomId]);\r\n\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n    if (!socketRef.current || !socketRef.current.connected) {\r\n      socketRef.current = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n      setSocketInstance(socketRef.current);\r\n    }\r\n\r\n    socketRef.current.on('receive_message', (data: Message) => {\r\n      if (String(data.roomId) !== String(roomId)) return;\r\n      setMessages((prev) => {\r\n        const id = String(data._id);\r\n        const exists = prev.some((m) => String(m._id) === id);\r\n        if (exists) {\r\n          const next = prev.map((m) => (String(m._id) === id ? { ...m, ...data } : m));\r\n          return sortMessagesAsc(next);\r\n        }\r\n        const map = new Map<string, Message>();\r\n        [...prev, data].forEach((m) => map.set(String(m._id), m));\r\n        const unique = Array.from(map.values()).sort((a: Message, b: Message) => {\r\n          const ta = Number(a.serverTimestamp ?? a.timestamp) || 0;\r\n          const tb = Number(b.serverTimestamp ?? b.timestamp) || 0;\r\n          if (ta !== tb) return ta - tb;\r\n          const ia = String(a._id || '');\r\n          const ib = String(b._id || '');\r\n          if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n          if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n          return ia.localeCompare(ib);\r\n        });\r\n        return unique;\r\n      });\r\n      if (data.type === 'poll') {\r\n        const endAt = data.pollEndAt;\r\n        const locked = !!data.isPollLocked;\r\n        if (typeof endAt === 'number' && !locked) {\r\n          schedulePollAutoLock(data);\r\n        }\r\n      }\r\n\r\n      if (data.sender !== currentUser._id && !roomMuted) {\r\n        playMessageSound();\r\n        showMessageNotification(data);\r\n        flashTabTitle();\r\n      }\r\n      const locked = !!scrollLockUntilRef.current && Date.now() < scrollLockUntilRef.current;\r\n      const elMeasure = messagesContainerRef.current;\r\n      const gap = elMeasure ? elMeasure.scrollHeight - elMeasure.scrollTop - elMeasure.clientHeight : 0;\r\n      const atBottomNow = gap <= SCROLL_BUMP_PX;\r\n      const iconShowingNow = !atBottomNow && gap > BUTTON_SHOW_THRESHOLD_PX;\r\n      const shouldScroll = !locked && (data.sender === currentUser._id || !iconShowingNow);\r\n      if (shouldScroll) {\r\n        scrollToBottom();\r\n        setTimeout(scrollToBottom, 0);\r\n        setTimeout(scrollToBottom, 150);\r\n        setTimeout(scrollToBottom, 300);\r\n        setPendingNewCount(0);\r\n        pendingNewCountRef.current = 0;\r\n        hasScrolledUpRef.current = false;\r\n        setShowScrollDown(false);\r\n        if (data.sender !== currentUser._id) {\r\n          void markAsReadApi(roomId, String(currentUser._id));\r\n          syncLocalReadBy();\r\n          try {\r\n            socketRef.current?.emit('messages_read', { roomId, userId: String(currentUser._id) });\r\n          } catch {}\r\n        }\r\n      } else {\r\n        if (data.sender !== currentUser._id) {\r\n          setPendingNewCount((c) => {\r\n            const next = c + 1;\r\n            pendingNewCountRef.current = next;\r\n            return next;\r\n          });\r\n          setShowScrollDown(hasScrolledUpRef.current || pendingNewCountRef.current > 0);\r\n          if (atBottomNow) {\r\n            void markAsReadApi(roomId, String(currentUser._id));\r\n            syncLocalReadBy();\r\n            try {\r\n              socketRef.current?.emit('messages_read', { roomId, userId: String(currentUser._id) });\r\n            } catch {}\r\n          }\r\n        }\r\n      }\r\n    });\r\n    socketRef.current.on(\r\n      'room_nickname_updated',\r\n      (payload: { roomId: string; targetUserId: string; nickname: string }) => {\r\n        if (String(payload.roomId) !== String(roomId)) return;\r\n        // 🔥 Reload data to get updated nicknames\r\n        reLoad?.();\r\n      },\r\n    );\r\n    socketRef.current.on('room_nicknames_state', (payload: { roomId: string; map: Record<string, string> }) => {\r\n      if (String(payload.roomId) !== String(roomId)) return;\r\n      try {\r\n        const myId = String(currentUser._id || '');\r\n        const key = `roomNicknames:${roomId}:${myId}`;\r\n        const incoming = payload.map || {};\r\n        localStorage.setItem(key, JSON.stringify(incoming));\r\n      } catch {}\r\n      setNicknamesStamp((s) => s + 1);\r\n    });\r\n\r\n    socketRef.current.on(\r\n      'reaction_updated',\r\n      (data: { _id: string; roomId: string; reactions: Record<string, string[]> }) => {\r\n        if (String(data.roomId) === String(roomId)) {\r\n          setMessages((prevMessages) =>\r\n            prevMessages.map((msg) =>\r\n              String(msg._id) === String(data._id)\r\n                ? {\r\n                    ...msg,\r\n                    reactions: data.reactions, // ✅ Update reactions\r\n                  }\r\n                : msg,\r\n            ),\r\n          );\r\n        }\r\n      },\r\n    );\r\n    socketRef.current.on('messages_read', (payload: { roomId: string; userId: string }) => {\r\n      if (String(payload.roomId) !== String(roomId)) return;\r\n      const viewerId = String(payload.userId || '');\r\n      const myId = String(currentUser._id || '');\r\n      if (!viewerId || compareIds(viewerId, myId)) return;\r\n      const lastMine = [...messagesRef.current]\r\n        .slice()\r\n        .reverse()\r\n        .find((m) => compareIds((m as Message).sender, myId) && !(m as Message).isRecalled);\r\n      if (!lastMine) return;\r\n      setMessages((prev) =>\r\n        prev.map((m) => {\r\n          if (String(m._id) !== String(lastMine._id)) return m;\r\n          const existing = new Set(((m.readBy || []) as string[]).map((x) => String(x)));\r\n          if (!existing.has(viewerId)) {\r\n            return { ...m, readBy: [...existing, viewerId] as unknown as string[] };\r\n          }\r\n          return m;\r\n        }),\r\n      );\r\n    });\r\n\r\n    // 🔥 Listener cho room_nickname_updated\r\n    socketRef.current.on(\r\n      'room_nickname_updated',\r\n      (data: { roomId: string; targetUserId: string; nickname: string }) => {\r\n        if (String(data.roomId) === String(roomId)) {\r\n          reLoad?.();\r\n          setNicknamesStamp(Date.now());\r\n        }\r\n      },\r\n    );\r\n\r\n    // 🔥 LISTENER CHO edit_message\r\n    socketRef.current.on(\r\n      'edit_message',\r\n      (data: {\r\n        _id: string;\r\n        roomId: string;\r\n        content?: string;\r\n        editedAt: number;\r\n        originalContent?: string;\r\n        reminderAt?: number;\r\n        reminderNote?: string;\r\n        pollQuestion?: string;\r\n        pollOptions?: string[];\r\n        pollVotes?: Record<string, string[]>;\r\n        isPollLocked?: boolean;\r\n        pollLockedAt?: number;\r\n        timestamp?: number;\r\n        isPinned?: boolean;\r\n        pinnedTitle?: string;\r\n        pinnedAt?: number | null;\r\n        reactions?: Record<string, string[]>;\r\n        pollAllowMultiple?: boolean;\r\n        pollAllowAddOptions?: boolean;\r\n        pollHideVoters?: boolean;\r\n        pollHideResultsUntilVote?: boolean;\r\n        pollEndAt?: number | null;\r\n      }) => {\r\n        if (String(data.roomId) === String(roomId)) {\r\n          setMessages((prevMessages) => {\r\n            const updated = prevMessages.map((msg) =>\r\n              String(msg._id) === String(data._id)\r\n                ? {\r\n                    ...msg,\r\n                    content: data.content ?? msg.content,\r\n                    editedAt: data.editedAt,\r\n                    originalContent: data.originalContent || msg.originalContent || msg.content,\r\n                    reminderAt: data.reminderAt ?? msg.reminderAt,\r\n                    reminderNote: data.reminderNote ?? msg.reminderNote,\r\n                    pollQuestion: data.pollQuestion ?? msg.pollQuestion,\r\n                    pollOptions: data.pollOptions ?? msg.pollOptions,\r\n                    pollVotes: data.pollVotes ?? msg.pollVotes,\r\n                    isPollLocked: data.isPollLocked ?? msg.isPollLocked,\r\n                    pollLockedAt: data.pollLockedAt ?? msg.pollLockedAt,\r\n                    pollAllowMultiple: data.pollAllowMultiple ?? msg.pollAllowMultiple,\r\n                    pollAllowAddOptions: data.pollAllowAddOptions ?? msg.pollAllowAddOptions,\r\n                    pollHideVoters: data.pollHideVoters ?? msg.pollHideVoters,\r\n                    pollHideResultsUntilVote: data.pollHideResultsUntilVote ?? msg.pollHideResultsUntilVote,\r\n                    pollEndAt: data.pollEndAt !== undefined ? data.pollEndAt : msg.pollEndAt,\r\n                    timestamp: data.timestamp ?? msg.timestamp,\r\n                    isPinned: typeof data.isPinned === 'boolean' ? data.isPinned : msg.isPinned,\r\n                    pinnedAt: typeof data.pinnedAt !== 'undefined' ? data.pinnedAt : msg.pinnedAt,\r\n                    reactions: data.reactions ?? msg.reactions,\r\n                  }\r\n                : msg,\r\n            );\r\n            const sorted = [...updated].sort((a: Message, b: Message) => {\r\n              const ta = Number(a.serverTimestamp ?? a.timestamp) || 0;\r\n              const tb = Number(b.serverTimestamp ?? b.timestamp) || 0;\r\n              if (ta !== tb) return ta - tb;\r\n              const ia = String(a._id || '');\r\n              const ib = String(b._id || '');\r\n              if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n              if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n              return ia.localeCompare(ib);\r\n            });\r\n            return sorted;\r\n          });\r\n          if (typeof data.isPinned === 'boolean') {\r\n            setAllPinnedMessages((prev) => {\r\n              const latest = messagesRef.current.find((m) => String(m._id) === String(data._id));\r\n              const updatedMsg = latest\r\n                ? ({\r\n                    ...latest,\r\n                    content: data.content ?? latest.content,\r\n                    pollQuestion: data.pollQuestion ?? latest.pollQuestion,\r\n                    pollOptions: data.pollOptions ?? latest.pollOptions,\r\n                    pollVotes: data.pollVotes ?? latest.pollVotes,\r\n                    isPollLocked: data.isPollLocked ?? latest.isPollLocked,\r\n                    pollLockedAt: data.pollLockedAt ?? latest.pollLockedAt,\r\n                    timestamp: data.timestamp ?? latest.timestamp,\r\n                    editedAt: data.editedAt ?? latest.editedAt,\r\n                    isPinned: data.isPinned,\r\n                    pinnedTitle: data.pinnedTitle ?? latest.pinnedTitle,\r\n                    pinnedAt: typeof data.pinnedAt !== 'undefined' ? data.pinnedAt : latest.pinnedAt,\r\n                  } as Message)\r\n                : ({\r\n                    _id: data._id as unknown as string,\r\n                    roomId,\r\n                    sender: currentUser._id as unknown as string,\r\n                    content: data.content || '',\r\n                    type: 'text',\r\n                    timestamp: data.timestamp || Date.now(),\r\n                    editedAt: data.editedAt || Date.now(),\r\n                    isPinned: data.isPinned,\r\n                    pinnedTitle: data.pinnedTitle,\r\n                    pinnedAt: typeof data.pinnedAt !== 'undefined' ? data.pinnedAt : Date.now(),\r\n                  } as Message);\r\n              const withoutDup = prev.filter((m) => String(m._id) !== String(data._id));\r\n              const next = data.isPinned ? [updatedMsg, ...withoutDup] : withoutDup;\r\n              return next.sort((a, b) => Number(b.pinnedAt ?? 0) - Number(a.pinnedAt ?? 0));\r\n            });\r\n          }\r\n          const idStr = String(data._id);\r\n          const t = reminderTimersByIdRef.current.get(idStr);\r\n          if (t) {\r\n            clearTimeout(t);\r\n            reminderTimersByIdRef.current.delete(idStr);\r\n            reminderScheduledIdsRef.current.delete(idStr);\r\n          }\r\n          const now = Date.now();\r\n          const at = typeof data.reminderAt === 'number' ? (data.reminderAt as number) : undefined;\r\n          if (typeof at === 'number') {\r\n            const delay = Math.max(0, at - now);\r\n            const timerId = window.setTimeout(async () => {\r\n              const latest = messagesRef.current.find((x) => String(x._id) === idStr);\r\n              if (!latest || latest.isRecalled) {\r\n                reminderScheduledIdsRef.current.delete(idStr);\r\n                const old = reminderTimersByIdRef.current.get(idStr);\r\n                if (old) {\r\n                  clearTimeout(old);\r\n                  reminderTimersByIdRef.current.delete(idStr);\r\n                }\r\n                return;\r\n              }\r\n              let latestAt = (latest as Message & { reminderAt?: number }).reminderAt || latest.timestamp;\r\n              try {\r\n                const r = await fetch('/api/messages', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({ action: 'getById', _id: latest._id }),\r\n                });\r\n                const j = await r.json();\r\n                const srv = (j && (j.row?.row || j.row)) as Message | undefined;\r\n                const srvAt = srv && (srv as Message & { reminderAt?: number }).reminderAt;\r\n                if (typeof srvAt === 'number') {\r\n                  latestAt = srvAt;\r\n                }\r\n              } catch {}\r\n              const now3 = Date.now();\r\n              if (latestAt > now3) {\r\n                const newDelay = Math.max(0, latestAt - now3);\r\n                const newTimer = window.setTimeout(async () => {\r\n                  const latest2 = messagesRef.current.find((x) => String(x._id) === idStr);\r\n                  if (!latest2 || latest2.isRecalled) {\r\n                    reminderScheduledIdsRef.current.delete(idStr);\r\n                    const t2 = reminderTimersByIdRef.current.get(idStr);\r\n                    if (t2) {\r\n                      clearTimeout(t2);\r\n                      reminderTimersByIdRef.current.delete(idStr);\r\n                    }\r\n                    return;\r\n                  }\r\n                  const latestAt2 = (latest2 as Message & { reminderAt?: number }).reminderAt || latest2.timestamp;\r\n                  const timeStr2 = new Date(latestAt2).toLocaleString('vi-VN');\r\n                  try {\r\n                    const res2 = await fetch('/api/messages', {\r\n                      method: 'POST',\r\n                      headers: { 'Content-Type': 'application/json' },\r\n                      body: JSON.stringify({\r\n                        action: 'update',\r\n                        field: '_id',\r\n                        value: latest2._id,\r\n                        data: { reminderFired: true },\r\n                      }),\r\n                    });\r\n                    const json2 = await res2.json();\r\n                    if (json2?.success) {\r\n                      await sendNotifyMessage(\r\n                        `Đến giờ lịch hẹn: \"${latest2.content || ''}\" lúc ${timeStr2}`,\r\n                        String(latest2._id),\r\n                      );\r\n                    }\r\n                  } catch {}\r\n                  reminderScheduledIdsRef.current.delete(idStr);\r\n                  reminderTimersByIdRef.current.delete(idStr);\r\n                }, newDelay);\r\n                reminderTimersByIdRef.current.set(idStr, newTimer);\r\n                return;\r\n              }\r\n              const timeStr = new Date(latestAt).toLocaleString('vi-VN');\r\n              try {\r\n                const res = await fetch('/api/messages', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    action: 'update',\r\n                    field: '_id',\r\n                    value: latest._id,\r\n                    data: { reminderFired: true },\r\n                  }),\r\n                });\r\n                const json = await res.json();\r\n                if (json?.success) {\r\n                  await sendNotifyMessage(\r\n                    `Đến giờ lịch hẹn: \"${latest.content || ''}\" lúc ${timeStr}`,\r\n                    String(latest._id),\r\n                  );\r\n                }\r\n              } catch {}\r\n              reminderScheduledIdsRef.current.delete(idStr);\r\n              reminderTimersByIdRef.current.delete(idStr);\r\n            }, delay);\r\n            reminderTimersByIdRef.current.set(idStr, timerId);\r\n            reminderScheduledIdsRef.current.add(idStr);\r\n          }\r\n          const tPoll = pollTimersByIdRef.current.get(idStr);\r\n          if (tPoll) {\r\n            clearTimeout(tPoll);\r\n            pollTimersByIdRef.current.delete(idStr);\r\n            pollScheduledIdsRef.current.delete(idStr);\r\n          }\r\n          const endAt = data.pollEndAt;\r\n          const shouldSchedule = typeof endAt === 'number' && !data.isPollLocked;\r\n          if (shouldSchedule) {\r\n            const existingMsg = messagesRef.current.find((m) => String(m._id) === idStr);\r\n            const composed = existingMsg\r\n              ? { ...existingMsg, pollEndAt: endAt, isPollLocked: data.isPollLocked }\r\n              : ({\r\n                  _id: data._id,\r\n                  roomId: data.roomId,\r\n                  pollEndAt: endAt,\r\n                  isPollLocked: data.isPollLocked,\r\n                } as unknown as Message);\r\n            schedulePollAutoLock(composed);\r\n          }\r\n          // Không re-fetch để tránh reload, cập nhật cục bộ qua socket\r\n        }\r\n      },\r\n    );\r\n\r\n    socketRef.current.on(\r\n      'edit_message',\r\n      (data: {\r\n        _id: string;\r\n        roomId: string;\r\n        newContent?: string;\r\n        content?: string;\r\n        editedAt: number;\r\n        originalContent?: string;\r\n        timestamp?: number;\r\n      }) => {\r\n        if (String(data.roomId) === String(roomId)) {\r\n          setMessages((prevMessages) => {\r\n            const updated = prevMessages.map((msg) =>\r\n              String(msg._id) === String(data._id)\r\n                ? {\r\n                    ...msg,\r\n                    content: data.newContent ?? data.content ?? msg.content,\r\n                    editedAt: data.editedAt,\r\n                    originalContent: data.originalContent || msg.originalContent || msg.content,\r\n                    timestamp: typeof data.timestamp === 'number' ? data.timestamp : msg.timestamp,\r\n                  }\r\n                : msg,\r\n            );\r\n            return updated;\r\n          });\r\n          const idStr = String(data._id);\r\n          const t = reminderTimersByIdRef.current.get(idStr);\r\n          if (t) {\r\n            clearTimeout(t);\r\n            reminderTimersByIdRef.current.delete(idStr);\r\n            reminderScheduledIdsRef.current.delete(idStr);\r\n          }\r\n          // Không re-fetch để tránh reload, cập nhật cục bộ qua socket\r\n        }\r\n      },\r\n    );\r\n\r\n    socketRef.current.on('message_recalled', (data: { _id: string; roomId: string }) => {\r\n      if (data.roomId === roomId) {\r\n        setMessages((prevMessages) =>\r\n          prevMessages.map((msg) => (msg._id === data._id ? { ...msg, isRecalled: true } : msg)),\r\n        );\r\n        const idStr = String(data._id);\r\n        const t = reminderTimersByIdRef.current.get(idStr);\r\n        if (t) {\r\n          clearTimeout(t);\r\n          reminderTimersByIdRef.current.delete(idStr);\r\n          reminderScheduledIdsRef.current.delete(idStr);\r\n        }\r\n        const tp = pollTimersByIdRef.current.get(idStr);\r\n        if (tp) {\r\n          clearTimeout(tp);\r\n          pollTimersByIdRef.current.delete(idStr);\r\n        }\r\n        pollScheduledIdsRef.current.delete(idStr);\r\n        // Không re-fetch để tránh reload, cập nhật cục bộ qua socket\r\n      }\r\n    });\r\n\r\n    socketRef.current.on('message_deleted', (data: { _id: string; roomId: string }) => {\r\n      if (data.roomId === roomId) {\r\n        setMessages((prevMessages) => prevMessages.filter((msg) => msg._id !== data._id));\r\n        const idStr = String(data._id);\r\n        const t = reminderTimersByIdRef.current.get(idStr);\r\n        if (t) {\r\n          clearTimeout(t);\r\n          reminderTimersByIdRef.current.delete(idStr);\r\n        }\r\n        reminderScheduledIdsRef.current.delete(idStr);\r\n        const tp = pollTimersByIdRef.current.get(idStr);\r\n        if (tp) {\r\n          clearTimeout(tp);\r\n          pollTimersByIdRef.current.delete(idStr);\r\n        }\r\n        pollScheduledIdsRef.current.delete(idStr);\r\n        void fetchMessages();\r\n      }\r\n    });\r\n\r\n    socketRef.current.emit('join_room', roomId);\r\n    socketRef.current.emit('join_user', { userId: String(currentUser._id) });\r\n\r\n    return () => {\r\n      try {\r\n        socketRef.current?.off('receive_message');\r\n        socketRef.current?.off('room_nickname_updated');\r\n        socketRef.current?.off('room_nicknames_state');\r\n        socketRef.current?.off('reaction_updated');\r\n        socketRef.current?.off('messages_read');\r\n        socketRef.current?.off('edit_message');\r\n        socketRef.current?.off('message_recalled');\r\n        socketRef.current?.off('message_deleted');\r\n      } catch {}\r\n      setSocketInstance(null);\r\n    };\r\n  }, [roomId, currentUser._id, playMessageSound, showMessageNotification, fetchMessages, sendNotifyMessage, socket]);\r\n\r\n  // Socket call events và ring tone được xử lý ở HomePage\r\n\r\n  // pendingIncomingCall được xử lý ở HomePage\r\n\r\n  useEffect(() => {\r\n    messages.forEach((m) => {\r\n      const idStr = String(m._id);\r\n      const scheduled = pollScheduledIdsRef.current.has(idStr);\r\n      const endAt = m.pollEndAt;\r\n      const locked = !!m.isPollLocked;\r\n      if (typeof endAt === 'number' && !locked && !scheduled) {\r\n        schedulePollAutoLock(m);\r\n      }\r\n      if ((endAt == null || locked) && scheduled) {\r\n        const tp = pollTimersByIdRef.current.get(idStr);\r\n        if (tp) {\r\n          clearTimeout(tp);\r\n          pollTimersByIdRef.current.delete(idStr);\r\n        }\r\n        pollScheduledIdsRef.current.delete(idStr);\r\n      }\r\n    });\r\n  }, [messages, schedulePollAutoLock]);\r\n\r\n  useEffect(() => {\r\n    const el = footerRef.current;\r\n    if (!el) return;\r\n    const allowDefault = (target: EventTarget | null) => {\r\n      const t = target as HTMLElement | null;\r\n      if (!t) return false;\r\n      return !!(t.closest('[contenteditable=\"true\"]') || t.closest('.overflow-y-auto'));\r\n    };\r\n    const onTouchMove = (e: TouchEvent) => {\r\n      if (allowDefault(e.target)) return;\r\n      e.preventDefault();\r\n    };\r\n    const onWheel = (e: WheelEvent) => {\r\n      if (allowDefault(e.target)) return;\r\n      e.preventDefault();\r\n    };\r\n    el.addEventListener('touchmove', onTouchMove, { passive: false });\r\n    el.addEventListener('wheel', onWheel, { passive: false });\r\n    return () => {\r\n      el.removeEventListener('touchmove', onTouchMove);\r\n      el.removeEventListener('wheel', onWheel);\r\n    };\r\n  }, []);\r\n  const handleRecallMessage = async (messageId: string) => {\r\n    if (!confirm('Bạn có chắc chắn muốn thu hồi tin nhắn này?')) return;\r\n\r\n    try {\r\n      const data = await recallMessageApi(roomId, messageId);\r\n\r\n      if (data.success) {\r\n        setMessages((prev) => prev.map((m) => (m._id === messageId ? { ...m, isRecalled: true } : m)));\r\n\r\n        const socketData = {\r\n          _id: messageId,\r\n          roomId,\r\n          sender: currentUser._id,\r\n          isGroup: isGroup,\r\n          receiver: isGroup ? null : getId(selectedChat),\r\n          members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n          type: 'recall',\r\n          content: 'đã thu hồi tin nhắn',\r\n          timestamp: Date.now(),\r\n        };\r\n\r\n        socketRef.current?.emit('recall_message', socketData);\r\n      } else if (data.message) {\r\n        alert('Không thể thu hồi: ' + data.message);\r\n      }\r\n    } catch (error) {\r\n      console.error('Recall error:', error);\r\n    }\r\n  };\r\n\r\n  const markAsRead = useCallback(async () => {\r\n    if (!roomId || !currentUser) return;\r\n    try {\r\n      await markAsReadApi(roomId, getId(currentUser));\r\n      markedReadRef.current = roomId;\r\n      try {\r\n        socketRef.current?.emit('messages_read', { roomId, userId: getId(currentUser) });\r\n      } catch {}\r\n    } catch (error) {\r\n      console.error('Mark as read failed:', error);\r\n    }\r\n  }, [roomId, currentUser, reLoad]);\r\n\r\n  useEffect(() => {\r\n    if (!roomId || !currentUser) return;\r\n    if (markedReadRef.current === roomId) return;\r\n    void markAsRead();\r\n    syncLocalReadBy();\r\n  }, [roomId, currentUser, markAsRead]);\r\n\r\n  // Removed polling for read status - using socket 'messages_read' instead\r\n\r\n  // Đóng mention menu khi click bên ngoài\r\n  useEffect(() => {\r\n    const handleClickOutside = (e: MouseEvent) => {\r\n      if (mentionMenuRef.current && !mentionMenuRef.current.contains(e.target as Node)) {\r\n        setShowMentionMenu(false);\r\n      }\r\n    };\r\n\r\n    if (showMentionMenu) {\r\n      document.addEventListener('mousedown', handleClickOutside);\r\n    }\r\n\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, [showMentionMenu, mentionMenuRef, setShowMentionMenu]);\r\n\r\n  useEffect(() => {\r\n    const handler = (e: Event) => {\r\n      const target = e.target as Node | null;\r\n      const footerEl = footerRef.current;\r\n      const inputEl = editableRef.current;\r\n      if (!inputEl) return;\r\n      const active = document.activeElement === inputEl;\r\n      if (!active) return;\r\n      if (footerEl && target && footerEl.contains(target)) return;\r\n      try {\r\n        inputEl.blur();\r\n      } catch {}\r\n      setShowEmojiPicker(false);\r\n    };\r\n    document.addEventListener('mousedown', handler, true);\r\n    document.addEventListener('touchstart', handler, true);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handler, true);\r\n      document.removeEventListener('touchstart', handler, true);\r\n    };\r\n  }, [editableRef, footerRef, setShowEmojiPicker]);\r\n\r\n  const handleToggleEmojiPicker = useCallback(() => {\r\n    try {\r\n      editableRef.current?.blur?.();\r\n    } catch {}\r\n    setTimeout(() => setShowEmojiPicker((prev) => !prev), 120);\r\n  }, [editableRef, setShowEmojiPicker]);\r\n\r\n  const getSenderName = (sender: User | string): string => {\r\n    const id = normalizeId(sender);\r\n\r\n    // 1. Ưu tiên tìm trong map (đã có nickname)\r\n    const direct = allUsersMap.get(id);\r\n    if (direct) return direct;\r\n\r\n    const asNumber = Number(id);\r\n    if (!Number.isNaN(asNumber)) {\r\n      const numericKey = String(asNumber);\r\n      const val = allUsersMap.get(numericKey);\r\n      if (val) return val;\r\n    }\r\n\r\n    // 2. Fallback nếu là object (user lạ chưa có trong list?)\r\n    if (typeof sender === 'object' && sender && 'name' in sender && (sender as User).name) {\r\n      return (sender as User).name as string;\r\n    }\r\n\r\n    return 'Người dùng';\r\n  };\r\n\r\n  const handleSendMessage = async () => {\r\n    if (!editableRef.current) return;\r\n\r\n    const plainText = getPlainTextFromEditable().trim();\r\n    const hasAtt = attachments.length > 0;\r\n    if (!plainText && !hasAtt) return;\r\n\r\n    const { mentions, displayText } = parseMentions(plainText);\r\n    let expandedText = displayText;\r\n    try {\r\n      const activeRaw = localStorage.getItem(`chatFlashActiveFolder:${roomId}`);\r\n      const active = activeRaw ? JSON.parse(activeRaw) : null;\r\n      const fid = active?.id;\r\n      const enabled = localStorage.getItem(`chatFlashEnabled:${roomId}`) === 'true';\r\n      if (fid && enabled) {\r\n        const kvRaw = localStorage.getItem(`chatFlashKV:${roomId}:${fid}`);\r\n        const arr = kvRaw ? JSON.parse(kvRaw) : [];\r\n        const map = new Map<string, string>(\r\n          (Array.isArray(arr) ? arr : []).map((x: { key: string; value: string }) => [String(x.key), String(x.value)]),\r\n        );\r\n        expandedText = String(expandedText).replace(/(^|\\s)\\/([\\w-]+)/g, (m: string, p1: string, k: string) => {\r\n          const v = map.get(k);\r\n          return v != null ? p1 + v : m;\r\n        });\r\n      }\r\n    } catch {}\r\n\r\n    const repliedUserName = replyingTo ? getSenderName(replyingTo.sender) : undefined;\r\n    const ALL_MENTION_ID = '__ALL__';\r\n\r\n    // Expand mentions: nếu có @all thì thêm toàn bộ member IDs\r\n    const expandedMentionIds = new Set<string>();\r\n    mentions.forEach((id) => {\r\n      if (id === ALL_MENTION_ID) {\r\n        activeMembers.forEach((mem) => {\r\n          const memId = String(mem._id || mem.id || '');\r\n          if (memId) expandedMentionIds.add(memId);\r\n        });\r\n      } else {\r\n        expandedMentionIds.add(id);\r\n      }\r\n    });\r\n\r\n    const finalMentions = Array.from(expandedMentionIds);\r\n\r\n    if (editableRef.current) {\r\n      editableRef.current.innerHTML = '';\r\n    }\r\n\r\n    // 🔥 Clear attachments ngay lập tức để tránh upload trùng nếu user ấn gửi tiếp\r\n    let currentAttachments: typeof attachments = [];\r\n    if (hasAtt) {\r\n      currentAttachments = [...attachments];\r\n      setAttachments([]);\r\n    }\r\n\r\n    if (plainText) {\r\n      // Lấy nickname hiện tại của người gửi\r\n      const myId = String(currentUser._id);\r\n      const senderNick = allUsersMap.get(myId) || currentUser.name;\r\n\r\n      const textMsg: MessageCreate = {\r\n        roomId,\r\n        sender: currentUser._id,\r\n        senderName: senderNick, // Sử dụng nickname\r\n        content: expandedText,\r\n        type: 'text',\r\n        timestamp: Date.now(),\r\n        replyToMessageId: replyingTo?._id,\r\n        replyToMessageName: repliedUserName,\r\n        mentions: finalMentions.length > 0 ? finalMentions : undefined,\r\n      };\r\n      await sendMessageProcess(textMsg);\r\n    }\r\n\r\n    if (hasAtt) {\r\n      const myId = String(currentUser._id);\r\n      const senderNick = allUsersMap.get(myId) || currentUser.name;\r\n      const batchId = `batch_${Date.now()}_${Math.random().toString(36).slice(2)}`;\r\n      currentAttachments.forEach((att) => {\r\n        handleUploadAndSend(\r\n          att.file,\r\n          att.type,\r\n          undefined,\r\n          replyingTo?._id,\r\n          undefined,\r\n          senderNick,\r\n          batchId,\r\n          att.videoCropConfig || null,\r\n        ).then(() => {\r\n          try {\r\n            URL.revokeObjectURL(att.previewUrl);\r\n          } catch {}\r\n        });\r\n      });\r\n    }\r\n    try {\r\n      const el = editableRef.current;\r\n      if (el) {\r\n        // 🔥 Fix: Nếu có attachment (hasAtt), blur để đóng keyboard trên mobile/tablet\r\n        if (hasAtt) {\r\n          dismissKeyboardAndScroll();\r\n        } else {\r\n          // Nếu chỉ gửi text, focus lại input để user gõ tiếp\r\n          el.focus();\r\n          const range = document.createRange();\r\n          range.selectNodeContents(el);\r\n          range.collapse(false);\r\n          const sel = window.getSelection();\r\n          sel?.removeAllRanges();\r\n          sel?.addRange(range);\r\n        }\r\n      }\r\n    } catch {}\r\n  };\r\n  // 🔥 Helper function để normalize ID\r\n  function normalizeId(value: unknown): string {\r\n    if (!value) return '';\r\n    if (typeof value === 'string') return value;\r\n    if (typeof value === 'number') return String(value);\r\n    if (typeof value === 'object' && value !== null) {\r\n      if ('_id' in value) return normalizeId(value._id);\r\n      if ('id' in value) return normalizeId(value.id);\r\n    }\r\n    return String(value);\r\n  }\r\n\r\n  // 🔥 Helper function để so sánh ID\r\n  function compareIds(id1: unknown, id2: unknown): boolean {\r\n    const normalized1 = normalizeId(id1);\r\n    const normalized2 = normalizeId(id2);\r\n\r\n    if (normalized1 === normalized2) return true;\r\n\r\n    // So sánh cả dạng number\r\n    const num1 = Number(normalized1);\r\n    const num2 = Number(normalized2);\r\n    if (!isNaN(num1) && !isNaN(num2) && num1 === num2) return true;\r\n\r\n    return false;\r\n  }\r\n  const getSenderInfo = (sender: User | string) => {\r\n    const senderId = normalizeId(sender);\r\n\r\n    // 1. Check currentUser trước\r\n    if (compareIds(currentUser._id, senderId)) {\r\n      return {\r\n        _id: senderId,\r\n        name: currentUser.name || 'Bạn',\r\n        avatar: currentUser.avatar ?? null,\r\n      };\r\n    }\r\n\r\n    // 2. Ưu tiên lấy tên từ map (đã xử lý nickname)\r\n    const mapName = allUsersMap.get(senderId) || allUsersMap.get(String(Number(senderId)));\r\n\r\n    // 3. Tìm user object để lấy avatar\r\n    const foundUser = allUsers.find((u) => compareIds(u._id || u.id, senderId));\r\n    const foundMember =\r\n      isGroup && Array.isArray(activeMembers) ? activeMembers.find((m) => compareIds(m._id || m.id, senderId)) : null;\r\n\r\n    const userObj = foundUser || foundMember;\r\n    const senderObj = typeof sender === 'object' && sender !== null ? sender : null;\r\n\r\n    const finalName = mapName || userObj?.name || senderObj?.name || 'Người dùng';\r\n    const finalAvatar = userObj?.avatar || senderObj?.avatar || null;\r\n\r\n    return {\r\n      _id: senderId,\r\n      name: finalName,\r\n      avatar: finalAvatar,\r\n    };\r\n  };\r\n  // Render tin nhắn với highlight mentions + link clickable + search keyword\r\n  const renderMessageContent = (\r\n    content: string,\r\n    mentionedUserIds?: string[],\r\n    isMe?: boolean,\r\n    searchKeyword?: string | null,\r\n  ) => {\r\n    if (!content) return null;\r\n\r\n    const highlightKeyword = (text: string, keyword: string | null | undefined) => {\r\n      if (!keyword || !keyword.trim() || !text) return text;\r\n      const regex = buildAccentInsensitiveRegex(keyword);\r\n      const parts = text.split(regex);\r\n      return (\r\n        <>\r\n          {parts.map((part, i) =>\r\n            regex.test(part) ? (\r\n              <mark key={i} className=\"bg-yellow-200 text-yellow-900 px-0.5 rounded font-medium\">\r\n                {part}\r\n              </mark>\r\n            ) : (\r\n              <span key={i}>{part}</span>\r\n            ),\r\n          )}\r\n        </>\r\n      );\r\n    };\r\n\r\n    const parts = content.split(/(@\\[[^\\]]+\\]\\([^)]+\\))/g);\r\n\r\n    return parts.map((part, index) => {\r\n      const mentionMatch = part.match(/@\\[([^\\]]+)\\]\\(([^)]+)\\)/);\r\n      if (mentionMatch) {\r\n        const [, displayName, userId] = mentionMatch;\r\n        const isMentioningMe = userId === String(currentUser._id);\r\n\r\n        return (\r\n          <span\r\n            key={`m-${index}`}\r\n            className={`font-semibold px-1 rounded ${\r\n              isMentioningMe\r\n                ? 'bg-yellow-300 text-yellow-900'\r\n                : isMe\r\n                  ? 'bg-blue-300 text-blue-900'\r\n                  : 'bg-gray-300 text-gray-900'\r\n            }`}\r\n          >\r\n            @{displayName}\r\n          </span>\r\n        );\r\n      }\r\n\r\n      const linkRegex = /(https?:\\/\\/|www\\.)\\S+/gi;\r\n      const nodes: React.ReactNode[] = [];\r\n      let lastIndex = 0;\r\n      let match: RegExpExecArray | null;\r\n      const text = part;\r\n      while ((match = linkRegex.exec(text)) !== null) {\r\n        const start = match.index;\r\n        const end = start + match[0].length;\r\n        if (start > lastIndex) {\r\n          const beforeLink = text.slice(lastIndex, start);\r\n          nodes.push(<span key={`t-${index}-${lastIndex}`}>{highlightKeyword(beforeLink, searchKeyword)}</span>);\r\n        }\r\n        const url = match[0];\r\n        const href = url.startsWith('http') ? url : `https://${url}`;\r\n        nodes.push(\r\n          <a\r\n            key={`a-${index}-${start}`}\r\n            href={href}\r\n            target=\"_blank\"\r\n            rel=\"noreferrer\"\r\n            className=\"text-blue-600 hover:underline break-all\"\r\n          >\r\n            {highlightKeyword(url, searchKeyword)}\r\n          </a>,\r\n        );\r\n        lastIndex = end;\r\n      }\r\n      if (lastIndex < text.length) {\r\n        const remaining = text.slice(lastIndex);\r\n        nodes.push(<span key={`t-${index}-${lastIndex}-end`}>{highlightKeyword(remaining, searchKeyword)}</span>);\r\n      }\r\n      return <React.Fragment key={`p-${index}`}>{nodes}</React.Fragment>;\r\n    });\r\n  };\r\n\r\n  const chatContextValue = useMemo(\r\n    () => ({\r\n      currentUser,\r\n      allUsers,\r\n      selectedChat,\r\n      messages,\r\n      isGroup,\r\n      chatName,\r\n    }),\r\n    [currentUser, allUsers, selectedChat, messages, isGroup, chatName],\r\n  );\r\n\r\n  const handleSaveEdit = async (messageId: string, newContent: string) => {\r\n    if (!newContent.trim()) return;\r\n\r\n    const originalMessage = messages.find((m) => m._id === messageId);\r\n    if (!originalMessage) return;\r\n\r\n    const editedAtTimestamp = Date.now();\r\n    const originalContentText = originalMessage.originalContent || originalMessage.content || '';\r\n\r\n    // 1. Optimistic Update\r\n    setMessages((prev) =>\r\n      prev.map((m) =>\r\n        m._id === messageId\r\n          ? { ...m, content: newContent, editedAt: editedAtTimestamp, originalContent: originalContentText }\r\n          : m,\r\n      ),\r\n    );\r\n    setEditingMessageId(null);\r\n\r\n    // 2. Gọi API Backend\r\n    try {\r\n      await fetch('/api/messages', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'editMessage',\r\n          data: { messageId, newContent },\r\n        }),\r\n      });\r\n\r\n      // 3. EMIT SOCKET EVENT\r\n      const myId = String(currentUser._id);\r\n      const senderNick = allUsersMap.get(myId) || currentUser.name;\r\n\r\n      const socketData = {\r\n        _id: messageId,\r\n        roomId: roomId,\r\n        newContent: newContent,\r\n        editedAt: editedAtTimestamp,\r\n        originalContent: originalContentText,\r\n        sender: currentUser._id,\r\n        senderName: senderNick, // Dùng nickname\r\n        isGroup: isGroup,\r\n        receiver: isGroup ? null : getId(selectedChat),\r\n        members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n      };\r\n\r\n      socketRef.current?.emit('edit_message', socketData);\r\n    } catch (e) {\r\n      console.error('❌ [CLIENT] Chỉnh sửa thất bại:', e);\r\n      alert('Lỗi khi lưu chỉnh sửa.');\r\n      setMessages((prev) => prev.map((m) => (m._id === messageId ? originalMessage : m)));\r\n    }\r\n  };\r\n\r\n  const handleShareMessage = useCallback((message: Message) => {\r\n    setMessageToShare(message);\r\n    setShowShareModal(true);\r\n  }, []);\r\n\r\n  const handleShareToRooms = useCallback(\r\n    async (targetRoomIds: string[], message: Message, attachedText?: string) => {\r\n      try {\r\n        let shareContent = '';\r\n        const originalSenderName = getSenderName(message.sender);\r\n        if (message.type === 'text') shareContent = message.content || '';\r\n\r\n        const batchItems =\r\n          (\r\n            message as unknown as {\r\n              batchItems?: Array<{\r\n                id: string;\r\n                type: MessageCreate['type'];\r\n                fileUrl?: string;\r\n                fileName?: string;\r\n                content?: string;\r\n              }>;\r\n            }\r\n          ).batchItems || [];\r\n\r\n        const safeGroups = Array.isArray(groups) ? groups : [];\r\n        for (const targetRoomId of targetRoomIds) {\r\n          const isGroupChat = safeGroups.some((g) => String(g._id) === String(targetRoomId));\r\n          const myId = String(currentUser._id);\r\n          const senderNick = allUsersMap.get(myId) || currentUser.name;\r\n\r\n          const newMsg: MessageCreate = {\r\n            roomId: targetRoomId,\r\n            sender: currentUser._id,\r\n            type: message.type,\r\n            content: message.type === 'text' ? shareContent : message.content,\r\n            fileUrl: message.fileUrl,\r\n            fileName: message.fileName,\r\n            timestamp: Date.now(),\r\n            // Thêm metadata về shared message\r\n            sharedFrom: {\r\n              messageId: String(message._id),\r\n              originalSender: originalSenderName,\r\n              originalRoomId: String(message.roomId),\r\n            },\r\n          };\r\n\r\n          if (attachedText && attachedText.trim()) {\r\n            const textMsg: MessageCreate = {\r\n              roomId: targetRoomId,\r\n              sender: currentUser._id,\r\n              senderName: senderNick,\r\n              content: attachedText.trim(),\r\n              type: 'text',\r\n              timestamp: Date.now(),\r\n            };\r\n            const resText = await fetch('/api/messages', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                action: 'create',\r\n                data: textMsg,\r\n              }),\r\n            });\r\n            const jsonText = await resText.json();\r\n            if (jsonText.success && typeof jsonText._id === 'string') {\r\n              const sockBaseText = isGroupChat\r\n                ? {\r\n                    roomId: targetRoomId,\r\n                    sender: currentUser._id,\r\n                    senderName: senderNick,\r\n                    isGroup: true,\r\n                    receiver: null,\r\n                    members: safeGroups.find((g) => String(g._id) === String(targetRoomId))?.members || [],\r\n                  }\r\n                : {\r\n                    roomId: targetRoomId,\r\n                    sender: currentUser._id,\r\n                    senderName: senderNick,\r\n                    isGroup: false,\r\n                    receiver: targetRoomId.split('_').find((id) => id !== String(currentUser._id)),\r\n                    members: [],\r\n                  };\r\n              socketRef.current?.emit('send_message', { ...sockBaseText, ...textMsg, _id: jsonText._id });\r\n            }\r\n          }\r\n\r\n          if (batchItems.length > 0) {\r\n            const batchId = `${String(message._id)}-${Date.now()}`;\r\n            for (const item of batchItems) {\r\n              const itemMsg: MessageCreate = {\r\n                roomId: targetRoomId,\r\n                sender: currentUser._id,\r\n                type: item.type,\r\n                content: item.type === 'text' ? item.content : undefined,\r\n                fileUrl: item.fileUrl,\r\n                fileName: item.fileName,\r\n                timestamp: Date.now(),\r\n                batchId,\r\n                sharedFrom: {\r\n                  messageId: String(item.id || message._id),\r\n                  originalSender: originalSenderName,\r\n                  originalRoomId: String(message.roomId),\r\n                },\r\n              };\r\n              const resItem = await fetch('/api/messages', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  action: 'create',\r\n                  data: itemMsg,\r\n                }),\r\n              });\r\n              const jsonItem = await resItem.json();\r\n              if (jsonItem.success && typeof jsonItem._id === 'string') {\r\n                const sockBase = isGroupChat\r\n                  ? {\r\n                      roomId: targetRoomId,\r\n                      sender: currentUser._id,\r\n                      senderName: senderNick,\r\n                      isGroup: true,\r\n                      receiver: null,\r\n                      members: safeGroups.find((g) => String(g._id) === String(targetRoomId))?.members || [],\r\n                    }\r\n                  : {\r\n                      roomId: targetRoomId,\r\n                      sender: currentUser._id,\r\n                      senderName: senderNick,\r\n                      isGroup: false,\r\n                      receiver: targetRoomId.split('_').find((id) => id !== String(currentUser._id)),\r\n                      members: [],\r\n                    };\r\n                socketRef.current?.emit('send_message', { ...sockBase, ...itemMsg, _id: jsonItem._id });\r\n              }\r\n            }\r\n          } else {\r\n            const res = await fetch('/api/messages', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                action: 'create',\r\n                data: newMsg,\r\n              }),\r\n            });\r\n            const json = await res.json();\r\n            if (json.success && typeof json._id === 'string') {\r\n              const sockBase = isGroupChat\r\n                ? {\r\n                    roomId: targetRoomId,\r\n                    sender: currentUser._id,\r\n                    senderName: senderNick,\r\n                    isGroup: true,\r\n                    receiver: null,\r\n                    members: safeGroups.find((g) => String(g._id) === String(targetRoomId))?.members || [],\r\n                  }\r\n                : {\r\n                    roomId: targetRoomId,\r\n                    sender: currentUser._id,\r\n                    senderName: senderNick,\r\n                    isGroup: false,\r\n                    receiver: targetRoomId.split('_').find((id) => id !== String(currentUser._id)),\r\n                    members: [],\r\n                  };\r\n              socketRef.current?.emit('send_message', { ...sockBase, ...newMsg, _id: json._id });\r\n            }\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Share message error:', error);\r\n        throw error;\r\n      }\r\n    },\r\n\r\n    [currentUser, groups, getSenderName],\r\n  );\r\n  useEffect(() => {\r\n    const handler = async (e: Event) => {\r\n      try {\r\n        const d = (e as CustomEvent).detail || {};\r\n        const mid = String(d.messageId || '');\r\n        if (!mid) return;\r\n        const local = messages.find((mm) => String(mm._id) === mid);\r\n        if (local) {\r\n          handleShareMessage(local);\r\n          return;\r\n        }\r\n        try {\r\n          const r = await fetch('/api/messages', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ action: 'getById', _id: mid }),\r\n          });\r\n          const j = await r.json();\r\n          const row = (j && (j.row?.row || j.row)) as Message | undefined;\r\n          if (row && String(row.roomId) === roomId) {\r\n            handleShareMessage(row);\r\n          }\r\n        } catch {}\r\n      } catch {}\r\n    };\r\n    window.addEventListener('shareMessage', handler as EventListener);\r\n    return () => window.removeEventListener('shareMessage', handler as EventListener);\r\n  }, [messages, handleShareMessage, roomId]);\r\n\r\n  // 🔥 Listen for local nickname updates and emit to socket\r\n  useEffect(() => {\r\n    const handleLocalNicknameUpdate = (e: Event) => {\r\n      const detail = (e as CustomEvent).detail;\r\n      if (detail && String(detail.roomId) === String(roomId)) {\r\n        socketRef.current?.emit('room_nickname_updated', detail);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('roomNicknamesUpdated', handleLocalNicknameUpdate);\r\n    return () => window.removeEventListener('roomNicknamesUpdated', handleLocalNicknameUpdate);\r\n  }, [roomId]);\r\n\r\n  const viewportRef = useRef<HTMLElement>(null);\r\n  const applyViewport = useCallback(() => {\r\n    const vv = window.visualViewport;\r\n    if (!vv) return;\r\n    const root = document.documentElement;\r\n    root.style.setProperty('--vvh', `${vv.height}px`);\r\n    root.style.setProperty('--vvw', `${vv.width}px`);\r\n    root.style.setProperty('--vvTop', `${vv.offsetTop || 0}px`);\r\n    root.style.setProperty('--vvLeft', `${vv.offsetLeft || 0}px`);\r\n  }, []);\r\n\r\n  // Fix keyboard overlapping on mobile using VisualViewport API\r\n  useEffect(() => {\r\n    const handleVisualViewport = () => {\r\n      if (!viewportRef.current || !window.visualViewport) return;\r\n      const vv = window.visualViewport;\r\n      window.scrollTo(0, 0);\r\n      viewportRef.current.style.height = `${vv.height}px`;\r\n      scrollToBottom();\r\n    };\r\n\r\n    const vv = window.visualViewport;\r\n    if (vv) {\r\n      vv.addEventListener('resize', handleVisualViewport);\r\n      vv.addEventListener('scroll', handleVisualViewport);\r\n      handleVisualViewport();\r\n    }\r\n\r\n    return () => {\r\n      if (vv) {\r\n        vv.removeEventListener('resize', handleVisualViewport);\r\n        vv.removeEventListener('scroll', handleVisualViewport);\r\n      }\r\n    };\r\n  }, [scrollToBottom]);\r\n\r\n  useEffect(() => {\r\n    if (!isMobile) return;\r\n    applyViewport();\r\n    const vv = window.visualViewport;\r\n    const onResize = () => applyViewport();\r\n    const onScrollVV = () => applyViewport();\r\n    const onWindowResize = () => applyViewport();\r\n    const onFocusIn = () => applyViewport();\r\n    const onFocusOut = () => applyViewport();\r\n    const onMobileActionsToggle = () => applyViewport();\r\n    if (vv) {\r\n      vv.addEventListener('resize', onResize);\r\n      vv.addEventListener('scroll', onScrollVV);\r\n    }\r\n    window.addEventListener('resize', onWindowResize);\r\n    window.addEventListener('orientationchange', onWindowResize);\r\n    window.addEventListener('focusin', onFocusIn);\r\n    window.addEventListener('focusout', onFocusOut);\r\n    window.addEventListener('mobileActionsToggle', onMobileActionsToggle as EventListener);\r\n    document.body.classList.add('vv-body-lock');\r\n    return () => {\r\n      if (vv) {\r\n        vv.removeEventListener('resize', onResize);\r\n        vv.removeEventListener('scroll', onScrollVV);\r\n      }\r\n      window.removeEventListener('resize', onWindowResize);\r\n      window.removeEventListener('orientationchange', onWindowResize);\r\n      window.removeEventListener('focusin', onFocusIn);\r\n      window.removeEventListener('focusout', onFocusOut);\r\n      window.removeEventListener('mobileActionsToggle', onMobileActionsToggle as EventListener);\r\n      document.body.classList.remove('vv-body-lock');\r\n      const root = document.documentElement;\r\n      root.style.removeProperty('--vvh');\r\n      root.style.removeProperty('--vvw');\r\n      root.style.removeProperty('--vvTop');\r\n      root.style.removeProperty('--vvLeft');\r\n    };\r\n  }, [isMobile, applyViewport]);\r\n\r\n  return (\r\n    <ChatProvider value={chatContextValue}>\r\n      <main\r\n        ref={viewportRef}\r\n        className={`flex ${isMobile ? 'vv-fixed' : 'h-full'} bg-gray-700 overflow-hidden no-scrollbar`}\r\n      >\r\n        <div\r\n          className={`flex flex-col h-full relative bg-gray-100 transition-all duration-300 ${\r\n            showPopup ? 'md:w-[calc(100%-21.875rem)] lg:w-full xl:w-[calc(100%-21.875rem)]' : 'w-full'\r\n          } border-r border-gray-200`}\r\n        >\r\n          <ChatHeader\r\n            chatName={chatName}\r\n            isGroup={isGroup}\r\n            memberCount={memberCount}\r\n            showPopup={showPopup}\r\n            onTogglePopup={() => setShowPopup((prev) => !prev)}\r\n            onOpenMembers={() => {\r\n              if (isGroup) {\r\n                setChatInfoInitialSection('members');\r\n                setShowPopup(true);\r\n              } else {\r\n                const partnerId = getId(selectedChat);\r\n                if (partnerId) router.push(`/profile/${partnerId}`);\r\n              }\r\n            }}\r\n            showSearchSidebar={showSearchSidebar}\r\n            onToggleSearchSidebar={() =>\r\n              setShowSearchSidebar((prev) => {\r\n                const next = !prev;\r\n                if (!next && isMobile) {\r\n                  closingSearchRef.current = true;\r\n                  setMobileSearchTerm('');\r\n                  setMobileSearchResults([]);\r\n                  setMobileCurrentResultIndex(-1);\r\n                  hasAutoSearchedRef.current = false;\r\n                  if (setRoomSearchKeyword) setRoomSearchKeyword(null);\r\n                  setTimeout(() => {\r\n                    closingSearchRef.current = false;\r\n                  }, 300);\r\n                }\r\n                return next;\r\n              })\r\n            }\r\n            avatar={chatAvatar}\r\n            onBackFromChat={onBackFromChat}\r\n            presenceText={!isGroup ? presenceInfo.text : undefined}\r\n            presenceOnline={!isGroup ? presenceInfo.online : undefined}\r\n            onVoiceCall={handleVoiceCall}\r\n            onVideoCall={handleVideoCall}\r\n            isMobile={isMobile}\r\n            isSearchActive={isMobile && showSearchSidebar}\r\n            initialKeyword={roomSearchKeyword || null}\r\n            onSearchTermChange={setMobileSearchTerm}\r\n            searchInputRef={mobileSearchInputRef as React.RefObject<HTMLInputElement | null>}\r\n            onCloseSearch={() => {\r\n              closingSearchRef.current = true;\r\n              setShowSearchSidebar(false);\r\n              setMobileSearchTerm('');\r\n              setMobileSearchResults([]);\r\n              setMobileCurrentResultIndex(-1);\r\n              hasAutoSearchedRef.current = false;\r\n              if (setRoomSearchKeyword) setRoomSearchKeyword(null);\r\n              setTimeout(() => {\r\n                closingSearchRef.current = false;\r\n              }, 300);\r\n            }}\r\n          />\r\n          <PinnedMessagesSection\r\n            allPinnedMessages={allPinnedMessages}\r\n            showPinnedList={showPinnedList}\r\n            onOpenPinnedList={() => setShowPinnedList(true)}\r\n            onClosePinnedList={() => setShowPinnedList(false)}\r\n            onJumpToMessage={handleJumpToMessage}\r\n            getSenderName={getSenderName}\r\n            onUnpinMessage={handlePinMessage}\r\n            onLoadMorePinned={loadMorePinnedMessages}\r\n            pinnedHasMore={(pinnedTotal ?? 0) > allPinnedMessages.length}\r\n            pinnedLoading={pinnedLoading}\r\n            isSidebarOpen={showPopup || (!isMobile && showSearchSidebar)}\r\n          />\r\n\r\n          {/* \r\n            Banner \"Cuộc gọi nhóm đang diễn ra\" + nút \"Tham gia lại\"\r\n            Hiển thị khi:\r\n            - Đây là phòng nhóm\r\n            - Theo trạng thái LiveKit (roomCallActiveLocal) phòng này đang có call\r\n            - Và hiện tại user KHÔNG ở trong popup cuộc gọi nổi (globalCallActive / connecting / incoming đều false)\r\n          */}\r\n          {isGroup && roomCallActiveLocal && !globalIncoming && !globalCallConnecting && !globalCallActive && (\r\n            <div className=\"fixed z-[2000] left-6 top-6 w-[90vw] max-w-[560px]\">\r\n              <div className=\"rounded-xl p-0 shadow-2xl ring-1 ring-black/10 bg-white/5 backdrop-blur\">\r\n                <div className=\"flex items-center justify-between px-3 py-2 bg-black/70 text-white rounded-t-xl select-none\">\r\n                  <span className=\"text-sm\">Cuộc gọi nhóm đang diễn ra</span>\r\n                  <span className=\"text-xs\">{roomCallTypeLocal === 'video' ? 'Video' : 'Thoại'}</span>\r\n                </div>\r\n                <div className=\"rounded-b-xl pt-2 p-2 relative bg-black/20\">\r\n                  <div className=\"rounded-lg overflow-hidden bg-black/30 text-white px-3 py-3\">\r\n                    <div className=\"text-sm mb-2\">Cuộc gọi nhóm đang diễn ra</div>\r\n                    <button\r\n                      className=\"cursor-pointer px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition\"\r\n                      onClick={handleRejoinCall}\r\n                    >\r\n                      Tham gia lại\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Messages Area */}\r\n          <div\r\n            ref={messagesContainerRef}\r\n            className=\"relative flex-1 overflow-y-auto overflow-x-hidden p-4 pb-0 bg-gray-100 flex flex-col custom-scrollbar overscroll-y-contain\"\r\n          >\r\n            {(initialLoading || loadingMore) && (\r\n              <div className=\"sticky top-0 z-20 flex items-center justify-center py-2\">\r\n                <div className=\"h-4 w-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin mr-2\" />\r\n                <span className=\"text-xs text-gray-500\">\r\n                  {initialLoading ? 'Đang tải tin nhắn...' : 'Đang tải thêm...'}\r\n                </span>\r\n              </div>\r\n            )}\r\n            <MessageList\r\n              onShareMessage={handleShareMessage}\r\n              messagesGrouped={messagesGrouped}\r\n              messages={messages}\r\n              currentUser={currentUser}\r\n              allUsersMap={allUsersMap}\r\n              uploadingFiles={uploadingFiles}\r\n              highlightedMsgId={highlightedMsgId}\r\n              isGroup={isGroup}\r\n              onContextMenu={handleContextMenu}\r\n              onMobileLongPress={handleMobileLongPress}\r\n              isMobile={isMobile}\r\n              onReplyMessage={handleReplyTo}\r\n              onJumpToMessage={handleJumpToMessage}\r\n              getSenderInfo={getSenderInfo}\r\n              renderMessageContent={(content, mentionedUserIds, isMe) =>\r\n                renderMessageContent(content, mentionedUserIds, isMe, isMobile ? mobileSearchTerm : roomSearchKeyword)\r\n              }\r\n              onOpenMedia={(url, type) => setPreviewMedia({ url, type })}\r\n              editingMessageId={editingMessageId}\r\n              setEditingMessageId={setEditingMessageId}\r\n              editContent={editContent}\r\n              setEditContent={setEditContent}\r\n              onSaveEdit={handleSaveEdit}\r\n              onRefresh={fetchMessages}\r\n              onPinMessage={handlePinMessage}\r\n              onToggleReaction={handleToggleReaction}\r\n              contextMenu={contextMenu}\r\n              isSidebarOpen={!isMobile && (showPopup || showSearchSidebar)}\r\n              onOpenChatInfoSection={(section) => {\r\n                if (!isMobile) {\r\n                  setChatInfoInitialSection(section);\r\n                  setShowPopup(true);\r\n                }\r\n              }}\r\n            />\r\n            <div ref={messagesEndRef} className=\"h-8 sm:h-10\" />\r\n          </div>\r\n\r\n          <button\r\n            onClick={() => scrollToBottom(true)}\r\n            aria-label=\"Cuộn xuống cuối\"\r\n            className={`absolute cursor-pointer hover:bg-gray-100 md:bottom-35 bottom-45   right-4 z-5 rounded-full bg-white border border-gray-200 shadow-lg p-3 transition-all ${\r\n              showScrollDown ? 'opacity-100' : 'opacity-0 pointer-events-none'\r\n            }`}\r\n          >\r\n            <div className=\"relative\">\r\n              <HiChevronDoubleDown className=\"w-6 h-6 text-gray-700\" />\r\n              {pendingNewCount > 0 && (\r\n                <span className=\"absolute -top-6  w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center\">\r\n                  {pendingNewCount}\r\n                </span>\r\n              )}\r\n            </div>\r\n          </button>\r\n\r\n          {/* Phần Footer (Input Chat) */}\r\n          <div ref={footerRef} className=\"bg-white p-0  border-t rounded-t-xl border-gray-200 relative space-y-1\">\r\n            {/* ... Popup Picker & Inputs ... */}\r\n            <EmojiStickerPicker\r\n              showEmojiPicker={showEmojiPicker}\r\n              pickerTab={pickerTab}\r\n              setPickerTab={setPickerTab}\r\n              onEmojiClick={(unicode: string) => onEmojiClick({ emoji: unicode } as EmojiClickData)}\r\n              stickers={STICKERS}\r\n              onSelectSticker={handleSendSticker}\r\n            />\r\n\r\n            <ReplyBanner replyingTo={replyingTo} getSenderName={getSenderName} onCancel={() => setReplyingTo(null)} />\r\n\r\n            {/* Chỉ cho phép mention (@) trong nhóm, không áp dụng cho chat 1-1 */}\r\n            {isGroup && (\r\n              <MentionMenu\r\n                showMentionMenu={showMentionMenu}\r\n                mentionSuggestions={mentionSuggestionsWithAll}\r\n                selectedMentionIndex={selectedMentionIndex}\r\n                mentionMenuRef={mentionMenuRef}\r\n                onSelectMention={selectMention}\r\n              />\r\n            )}\r\n            {/* Mobile Search Navigation Bar - chỉ hiển thị khi có kết quả tìm kiếm */}\r\n            {isMobile && mobileSearchResults.length > 0 && mobileSearchTerm.trim() && (\r\n              <div className=\"flex items-center justify-between px-4 py-2 bg-gray-100 border-t border-gray-200\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <svg className=\"w-4 h-4 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path\r\n                      strokeLinecap=\"round\"\r\n                      strokeLinejoin=\"round\"\r\n                      strokeWidth={2}\r\n                      d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"\r\n                    />\r\n                  </svg>\r\n                  <span className=\"text-xs text-gray-600 font-medium\">\r\n                    Kết quả thứ {mobileCurrentResultIndex >= 0 ? mobileCurrentResultIndex + 1 : 0}/\r\n                    {mobileSearchResults.length}\r\n                  </span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <button\r\n                    onClick={handlePreviousResult}\r\n                    className=\"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                    title=\"Kết quả trước\"\r\n                  >\r\n                    <svg className=\"w-5 h-5 text-gray-700\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>\r\n                  </button>\r\n                  <button\r\n                    onClick={handleNextResult}\r\n                    className=\"p-1.5 rounded cursor-pointer hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n                    title=\"Kết quả tiếp theo\"\r\n                  >\r\n                    <svg className=\"w-5 h-5 text-gray-700\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                    </svg>\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            )}\r\n            <ChatInput\r\n              socket={socketInstance}\r\n              showEmojiPicker={showEmojiPicker}\r\n              onToggleEmojiPicker={handleToggleEmojiPicker}\r\n              isListening={isListening}\r\n              onVoiceInput={handleVoiceInput}\r\n              editableRef={editableRef}\r\n              onInputEditable={handleInputChangeEditable}\r\n              onKeyDownEditable={handleKeyDownCombined}\r\n              onSendMessageData={sendMessageProcess}\r\n              onPasteEditable={(e) => {\r\n                const items = Array.from(e.clipboardData?.items || []);\r\n                const fileItems = items.filter(\r\n                  (it) => it.kind === 'file' && (it.type.startsWith('image/') || it.type.startsWith('video/')),\r\n                );\r\n                if (fileItems.length > 0) {\r\n                  e.preventDefault();\r\n                  fileItems.forEach((it) => {\r\n                    const f = it.getAsFile();\r\n                    if (f) {\r\n                      const isVid = f.type.startsWith('video/') || isVideoFile(f.name);\r\n                      const isImg = f.type.startsWith('image/');\r\n                      const t = isVid ? 'video' : isImg ? 'image' : 'file';\r\n                      const url = URL.createObjectURL(f);\r\n                      setAttachments((prev) => [...prev, { file: f, type: t, previewUrl: url, fileName: f.name }]);\r\n                    }\r\n                  });\r\n                  dismissKeyboardAndScroll();\r\n                  return;\r\n                }\r\n                e.preventDefault();\r\n                const text = e.clipboardData.getData('text/plain');\r\n                document.execCommand('insertText', false, text);\r\n                handleInputChangeEditable();\r\n              }}\r\n              onSendMessage={handleSendMessage}\r\n              onSelectImage={(file) => {\r\n                const isVideo = file.type.startsWith('video/') || isVideoFile(file.name);\r\n                const msgType = isVideo ? 'video' : 'image';\r\n                const url = URL.createObjectURL(file);\r\n                setAttachments((prev) => [...prev, { file, type: msgType, previewUrl: url, fileName: file.name }]);\r\n                dismissKeyboardAndScroll();\r\n              }}\r\n              onSelectFile={(file) => {\r\n                const isVideo = file.type.startsWith('video/') || isVideoFile(file.name);\r\n                const msgType = isVideo ? 'video' : 'file';\r\n                const url = URL.createObjectURL(file);\r\n                setAttachments((prev) => [...prev, { file, type: msgType, previewUrl: url, fileName: file.name }]);\r\n                dismissKeyboardAndScroll();\r\n              }}\r\n              onAttachFromFolder={async (att) => {\r\n                const remoteUrl = getProxyUrl(att.url);\r\n                const name =\r\n                  att.fileName || (att.type === 'image' ? 'image.jpg' : att.type === 'video' ? 'video.mp4' : 'file');\r\n                const placeholder = new File([new Blob([])], name, { type: 'application/octet-stream' });\r\n                const placeholderItem = { file: placeholder, type: att.type, previewUrl: remoteUrl, fileName: name };\r\n                setAttachments((prev) => [...prev, placeholderItem]);\r\n                dismissKeyboardAndScroll();\r\n                try {\r\n                  const res = await fetch(remoteUrl);\r\n                  const blob = await res.blob();\r\n                  const mime =\r\n                    blob.type ||\r\n                    (att.type === 'image'\r\n                      ? 'image/jpeg'\r\n                      : att.type === 'video'\r\n                        ? 'video/mp4'\r\n                        : 'application/octet-stream');\r\n                  const realFile = new File([blob], name, { type: mime });\r\n                  const previewUrl = URL.createObjectURL(blob);\r\n                  setAttachments((prev) =>\r\n                    prev.map((item) =>\r\n                      item.previewUrl === remoteUrl\r\n                        ? { file: realFile, type: att.type, previewUrl, fileName: name }\r\n                        : item,\r\n                    ),\r\n                  );\r\n                } catch {}\r\n              }}\r\n              onFocusEditable={() => {\r\n                setShowEmojiPicker(false);\r\n                scrollToBottom();\r\n                setTimeout(scrollToBottom, 0);\r\n                setTimeout(scrollToBottom, 200);\r\n                try {\r\n                  editableRef.current?.scrollIntoView({ block: 'end' });\r\n                } catch {}\r\n              }}\r\n              attachments={attachments.map((a) => ({ previewUrl: a.previewUrl, type: a.type, fileName: a.fileName }))}\r\n              onRemoveAttachment={(index) => {\r\n                setAttachments((prev) => {\r\n                  const next = [...prev];\r\n                  const [removed] = next.splice(index, 1);\r\n                  if (removed) {\r\n                    try {\r\n                      URL.revokeObjectURL(removed.previewUrl);\r\n                    } catch {}\r\n                  }\r\n                  return next;\r\n                });\r\n              }}\r\n              onClearAttachments={() => {\r\n                setAttachments((prev) => {\r\n                  prev.forEach((a) => {\r\n                    try {\r\n                      URL.revokeObjectURL(a.previewUrl);\r\n                    } catch {}\r\n                  });\r\n                  return [];\r\n                });\r\n              }}\r\n              isUploading={hasUploading}\r\n              uploadingCount={uploadingCount}\r\n              overallUploadPercent={overallUploadPercent}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {showPopup && isLgOnly && (\r\n          <div\r\n            aria-hidden=\"true\"\r\n            className=\"hidden lg:block lg:fixed lg:inset-0 lg:bg-transparent z-10\"\r\n            onClick={() => {\r\n              setShowPopup(false);\r\n              setChatInfoInitialSection(null);\r\n            }}\r\n          />\r\n        )}\r\n        {showPopup && (\r\n          <div\r\n            id=\"right-sidebar-container\"\r\n            className=\"fixed inset-0 md:relative md:inset-auto md:w-[21.875rem] lg:fixed lg:inset-y-0 lg:right-0 lg:w-[21.875rem] lg:z-20 xl:relative xl:inset-auto xl:w-[21.875rem] h-full z-10 \"\r\n          >\r\n            <ChatInfoPopup\r\n              onClose={() => {\r\n                setShowPopup(false);\r\n                setChatInfoInitialSection(null);\r\n              }}\r\n              onShowCreateGroup={onShowCreateGroup}\r\n              onMembersAdded={handleMembersAdded}\r\n              members={activeMembers}\r\n              onMemberRemoved={handleMemberRemoved}\r\n              onRoleChange={handleRoleChange}\r\n              onJumpToMessage={handleJumpToMessage}\r\n              onChatAction={onChatAction}\r\n              reLoad={reLoad}\r\n              onLeftGroup={onBackFromChat}\r\n              onRefresh={fetchMessages}\r\n              sendNotifyMessage={(text) => sendNotifyMessage(text)}\r\n              lastUpdated={nicknamesStamp}\r\n              initialSection={chatInfoInitialSection}\r\n              groups={groups}\r\n            />\r\n          </div>\r\n        )}\r\n        {/* Desktop: Search Sidebar */}\r\n        {showSearchSidebar && !isMobile && (\r\n          <div className=\"fixed inset-0 sm:static sm:inset-auto sm:w-[21.875rem] h-full z-10 \">\r\n            <SearchSidebar\r\n              isOpen={showSearchSidebar}\r\n              onClose={() => {\r\n                setShowSearchSidebar(false);\r\n                if (setRoomSearchKeyword) setRoomSearchKeyword(null);\r\n              }}\r\n              roomId={roomId}\r\n              onJumpToMessage={handleJumpToMessage}\r\n              getSenderName={getSenderName}\r\n              initialKeyword={roomSearchKeyword || null}\r\n              onKeywordClear={() => {\r\n                if (setRoomSearchKeyword) setRoomSearchKeyword(null);\r\n              }}\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        {showPinTitleModal && messageToPin && (\r\n          <PinMessageTitleModal\r\n            onClose={() => {\r\n              setShowPinTitleModal(false);\r\n              setMessageToPin(null);\r\n            }}\r\n            onConfirm={(title) => {\r\n              executePinMessage(messageToPin, true, title);\r\n              setShowPinTitleModal(false);\r\n              setMessageToPin(null);\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {showShareModal && messageToShare && (\r\n          <ShareMessageModal\r\n            isOpen={showShareModal}\r\n            onClose={() => {\r\n              setShowShareModal(false);\r\n              setMessageToShare(null);\r\n            }}\r\n            message={messageToShare}\r\n            currentUser={currentUser}\r\n            allUsers={allUsers}\r\n            groups={groups}\r\n            onShare={handleShareToRooms}\r\n          />\r\n        )}\r\n\r\n        {openMember && isGroup && (\r\n          <ModalMembers\r\n            conversationId={selectedChat._id}\r\n            currentUser={currentUser}\r\n            reLoad={reLoad}\r\n            isOpen={openMember}\r\n            onClose={() => setOpenMember(false)}\r\n            members={activeMembers}\r\n            groupName={chatName}\r\n            allUsers={allUsers}\r\n            onMembersAdded={handleMembersAdded}\r\n            onMemberRemoved={handleMemberRemoved}\r\n            onRoleChange={handleRoleChange}\r\n            sendNotifyMessage={(text) => sendNotifyMessage(text)}\r\n            lastUpdated={nicknamesStamp}\r\n          />\r\n        )}\r\n\r\n        {contextMenu && contextMenu.visible && (\r\n          <>\r\n            {!isMobile ? (\r\n              <MessageContextMenu\r\n                contextMenu={contextMenu}\r\n                currentUserId={String(currentUser._id)}\r\n                onClose={closeContextMenu}\r\n                onPinMessage={handlePinMessage}\r\n                onRecallMessage={handleRecallMessage}\r\n                setEditingMessageId={setEditingMessageId}\r\n                setEditContent={setEditContent}\r\n                closeContextMenu={closeContextMenu}\r\n                onReplyMessage={handleReplyTo}\r\n                onShareMessage={handleShareMessage}\r\n              />\r\n            ) : (\r\n              <MessageMobileContextMenu\r\n                contextMenu={contextMenu}\r\n                currentUserId={String(currentUser._id)}\r\n                onClose={closeContextMenu}\r\n                onPinMessage={handlePinMessage}\r\n                onRecallMessage={handleRecallMessage}\r\n                onReplyMessage={handleReplyTo}\r\n                onShareMessage={handleShareMessage}\r\n                onToggleReaction={handleToggleReaction}\r\n                setEditingMessageId={setEditingMessageId}\r\n                setEditContent={setEditContent}\r\n                closeContextMenu={closeContextMenu}\r\n              />\r\n            )}\r\n          </>\r\n        )}\r\n\r\n        <MediaPreviewModal\r\n          media={previewMedia}\r\n          chatName={chatName}\r\n          isGroup={isGroup}\r\n          roomId={roomId}\r\n          onClose={() => setPreviewMedia(null)}\r\n          onShareMessage={handleShareMessage}\r\n        />\r\n\r\n        {/* UI cuộc gọi được hiển thị toàn cục ở HomePage */}\r\n      </main>\r\n    </ChatProvider>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7669, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/%28zalo%29/home/GlobalSearchModal.tsx"],"sourcesContent":["import React, { useState, useEffect, useMemo } from 'react';\r\nimport SearchHeader from '@/components/(search)/SearchHeader';\r\nimport SearchTabs from '@/components/(search)/SearchTabs';\r\nimport ContactResults from '@/components/(search)/ContactResults';\r\nimport MessageResults from '@/components/(search)/MessageResults';\r\nimport FileResults from '@/components/(search)/FileResults';\r\nimport SearchEmptyState from '@/components/(search)/SearchEmptyState';\r\n\r\n// Types (keep all existing types)\r\ninterface User {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n}\r\n\r\ninterface Message {\r\n  _id: string;\r\n  content?: string;\r\n  type: 'text' | 'image' | 'file' | 'sticker' | 'video' | 'reminder';\r\n  fileName?: string;\r\n  timestamp: number;\r\n  sender: string;\r\n  senderName: string;\r\n  roomId: string;\r\n  roomName: string;\r\n  isGroupChat: boolean;\r\n  partnerId?: string;\r\n  partnerName?: string;\r\n  fileUrl?: string;\r\n}\r\n\r\ninterface PhonebookContact {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n  isGroup?: boolean;\r\n}\r\n\r\ninterface SearchResult {\r\n  contacts: PhonebookContact[];\r\n  messages: Message[];\r\n}\r\n\r\ninterface Props {\r\n  results: SearchResult;\r\n  searchTerm: string;\r\n  onClose: () => void;\r\n  onSearch: (term: string) => void;\r\n  allUsers: User[];\r\n  onNavigateToMessage: (message: Message, searchKeyword: string) => void;\r\n  onSelectContact: (phonebook: PhonebookContact) => void;\r\n}\r\n\r\nexport default function GlobalSearchModal({\r\n  results,\r\n  searchTerm,\r\n  onClose,\r\n  onSearch,\r\n  allUsers,\r\n  onNavigateToMessage,\r\n  onSelectContact,\r\n}: Props) {\r\n  const [activeTab, setActiveTab] = useState<'all' | 'contacts' | 'messages' | 'files'>('all');\r\n  const [localSearchTerm, setLocalSearchTerm] = useState(searchTerm);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n\r\n  // Keep the useMemo for processing messages\r\n  const { regularMessages, fileMessages } = useMemo(() => {\r\n    if (!results?.messages || !Array.isArray(results.messages)) {\r\n      return { regularMessages: [], fileMessages: [] };\r\n    }\r\n\r\n    const regular: Message[] = [];\r\n    const files: Message[] = [];\r\n\r\n    results.messages.forEach((msg) => {\r\n      if (msg.type === 'file' || msg.type === 'image' || msg.type === 'video') {\r\n        files.push(msg);\r\n      } else {\r\n        regular.push(msg);\r\n      }\r\n    });\r\n\r\n    return { regularMessages: regular, fileMessages: files };\r\n  }, [results?.messages]);\r\n\r\n  const groupedMessages = useMemo(() => {\r\n    if (!regularMessages || regularMessages.length === 0) return [];\r\n\r\n    const groups = new Map<\r\n      string,\r\n      {\r\n        roomId: string;\r\n        roomName: string;\r\n        roomAvatar?: string;\r\n        isGroupChat: boolean;\r\n        partnerId?: string;\r\n        messages: Message[];\r\n        latestTimestamp: number;\r\n      }\r\n    >();\r\n\r\n    regularMessages.forEach((msg) => {\r\n      if (!msg || !msg.roomId) return;\r\n\r\n      const key = msg.roomId;\r\n\r\n      if (!groups.has(key)) {\r\n        groups.set(key, {\r\n          roomId: msg.roomId,\r\n          roomName: msg.roomName || 'Cuộc trò chuyện',\r\n          roomAvatar: msg.isGroupChat ? undefined : allUsers?.find((u) => u._id === msg.partnerId)?.avatar,\r\n          isGroupChat: msg.isGroupChat || false,\r\n          partnerId: msg.partnerId,\r\n          messages: [],\r\n          latestTimestamp: msg.timestamp || Date.now(),\r\n        });\r\n      }\r\n\r\n      const group = groups.get(key)!;\r\n      group.messages.push(msg);\r\n      if (msg.timestamp && msg.timestamp > group.latestTimestamp) {\r\n        group.latestTimestamp = msg.timestamp;\r\n      }\r\n    });\r\n\r\n    return Array.from(groups.values()).sort((a, b) => b.latestTimestamp - a.latestTimestamp);\r\n  }, [regularMessages, allUsers]);\r\n\r\n  const groupedFiles = useMemo(() => {\r\n    if (!fileMessages || fileMessages.length === 0) return [];\r\n\r\n    const groups = new Map<\r\n      string,\r\n      {\r\n        roomId: string;\r\n        roomName: string;\r\n        roomAvatar?: string;\r\n        isGroupChat: boolean;\r\n        files: Message[];\r\n        latestTimestamp: number;\r\n      }\r\n    >();\r\n\r\n    fileMessages.forEach((msg) => {\r\n      if (!msg || !msg.roomId) return;\r\n\r\n      const key = msg.roomId;\r\n\r\n      if (!groups.has(key)) {\r\n        groups.set(key, {\r\n          roomId: msg.roomId,\r\n          roomName: msg.roomName || 'Cuộc trò chuyện',\r\n          roomAvatar: msg.isGroupChat ? undefined : allUsers?.find((u) => u._id === msg.partnerId)?.avatar,\r\n          isGroupChat: msg.isGroupChat || false,\r\n          files: [],\r\n          latestTimestamp: msg.timestamp || Date.now(),\r\n        });\r\n      }\r\n\r\n      const group = groups.get(key)!;\r\n      group.files.push(msg);\r\n      if (msg.timestamp && msg.timestamp > group.latestTimestamp) {\r\n        group.latestTimestamp = msg.timestamp;\r\n      }\r\n    });\r\n\r\n    return Array.from(groups.values()).sort((a, b) => b.latestTimestamp - a.latestTimestamp);\r\n  }, [fileMessages, allUsers]);\r\n\r\n  const tabs = [\r\n    {\r\n      key: 'all' as const,\r\n      label: 'Tất cả',\r\n      count: (results?.contacts?.length || 0) + groupedMessages.length + groupedFiles.length,\r\n    },\r\n    { key: 'contacts' as const, label: 'Liên hệ', count: results?.contacts?.length || 0 },\r\n    { key: 'messages' as const, label: 'Tin nhắn', count: groupedMessages.length },\r\n    { key: 'files' as const, label: 'File', count: groupedFiles.length },\r\n  ];\r\n\r\n  const hasResults = (results?.contacts?.length || 0) > 0 || (results?.messages?.length || 0) > 0;\r\n\r\n  // Update localSearchTerm when prop changes\r\n  useEffect(() => {\r\n    setLocalSearchTerm(searchTerm);\r\n  }, [searchTerm]);\r\n\r\n  return (\r\n    <div\r\n      className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm px-4 py-6 sm:p-4\"\r\n      onClick={(e) => e.target === e.currentTarget && onClose()}\r\n    >\r\n      <div className=\"bg-white rounded-2xl shadow-xl w-full max-w-2xl h-full sm:h-[40rem] max-h-[calc(100vh-3rem)] sm:max-h-[40rem] flex flex-col overflow-hidden border border-gray-200\">\r\n        <SearchHeader\r\n          searchTerm={localSearchTerm}\r\n          onSearch={onSearch}\r\n          onClose={onClose}\r\n          isSearching={isSearching}\r\n          onSearchingChange={setIsSearching}\r\n        />\r\n\r\n        <SearchTabs activeTab={activeTab} tabs={tabs} onTabChange={setActiveTab} searchTerm={localSearchTerm} />\r\n\r\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar\">\r\n          <SearchEmptyState isSearching={isSearching} searchTerm={localSearchTerm} hasResults={hasResults} />\r\n\r\n          {hasResults && !isSearching && (\r\n            <>\r\n              {(activeTab === 'all' || activeTab === 'contacts') && (\r\n                <ContactResults\r\n                  contacts={results.contacts || []}\r\n                  searchTerm={localSearchTerm}\r\n                  onSelectContact={onSelectContact}\r\n                />\r\n              )}\r\n\r\n              {(activeTab === 'all' || activeTab === 'messages') && (\r\n                <MessageResults\r\n                  groupedMessages={groupedMessages}\r\n                  searchTerm={localSearchTerm}\r\n                  allUsers={allUsers}\r\n                  onNavigateToMessage={(msg) => onNavigateToMessage(msg, localSearchTerm)}\r\n                />\r\n              )}\r\n\r\n              {(activeTab === 'all' || activeTab === 'files') && (\r\n                <FileResults\r\n                  groupedFiles={groupedFiles}\r\n                  searchTerm={localSearchTerm}\r\n                  onNavigateToMessage={(msg) => onNavigateToMessage(msg, localSearchTerm)}\r\n                />\r\n              )}\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"flex-none px-4 py-3 bg-[#f7f9fc] border-t text-[0.6875rem] text-gray-500 flex items-center justify-between\">\r\n          <span>\r\n            Nhấn{' '}\r\n            <kbd className=\"px-1.5 py-0.5 bg-white border border-gray-300 rounded shadow-sm font-mono text-[0.625rem]\">\r\n              ESC\r\n            </kbd>{' '}\r\n            để đóng cửa sổ\r\n          </span>\r\n          <span className=\"text-gray-400\">Tìm kiếm nhanh trong Zalo</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7931, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/%28zalo%29/home/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useEffect } from 'react';\r\n\r\nimport HomeDesktop from '@/components/(home)/HomeDesktop';\r\nimport HomeMobile from '@/components/(home)/HomeMobile';\r\nimport HomeOverlays from '@/components/(home)/HomeOverlays';\r\nimport { useHomePage } from '@/hooks/useHomePage';\r\nimport type { GroupConversation } from '@/types/Group';\r\nimport {\r\n  subscribeNotification,\r\n  addUserTags,\r\n  loginOneSignal,\r\n  ensureSubscribed,\r\n  waitForOneSignalReady,\r\n} from '@/lib/onesignal';\r\n\r\nexport default function HomePage() {\r\n  const {\r\n    currentUser,\r\n    isLoading,\r\n    allUsers,\r\n    groups,\r\n    selectedChat,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    showCreateGroupModal,\r\n    setShowCreateGroupModal,\r\n    showGlobalSearchModal,\r\n    globalSearchTerm,\r\n    globalSearchResults,\r\n    scrollToMessageId,\r\n    setScrollToMessageId,\r\n    roomSearchKeyword,\r\n    setRoomSearchKeyword,\r\n    handleOpenGlobalSearch,\r\n    handleGlobalSearch,\r\n    handleSelectContact,\r\n    handleNavigateToMessage,\r\n    fetchAllData,\r\n    handleChatAction,\r\n    handleSelectChat,\r\n    setSelectedChat,\r\n  } = useHomePage();\r\n\r\n\r\n\r\n  useEffect(() => {\r\n    const run = async () => {\r\n      if (!currentUser || !currentUser._id) return;\r\n      await waitForOneSignalReady();\r\n      await subscribeNotification();\r\n      const subId = await ensureSubscribed();\r\n      await loginOneSignal(String(currentUser._id));\r\n      await addUserTags({ userId: String(currentUser._id) });\r\n      if (typeof window !== 'undefined') {\r\n        try {\r\n          console.log('OneSignal subscription id', subId);\r\n        } catch {}\r\n      }\r\n      if (subId) {\r\n        try {\r\n          await fetch('/api/users', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              action: 'addOneSignalSub',\r\n              currentUserId: String(currentUser._id),\r\n              data: { subId: String(subId) },\r\n            }),\r\n          });\r\n        } catch {}\r\n      }\r\n    };\r\n    void run();\r\n  }, [currentUser]);\r\n\r\n  useEffect(() => {\r\n    // no-op\r\n  }, [currentUser]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedChat) {\r\n      try {\r\n        const raw = localStorage.getItem('__return_room_results__');\r\n        if (raw) {\r\n          const data = JSON.parse(raw);\r\n          if (data && data.origin === 'global') {\r\n            if (!showGlobalSearchModal) {\r\n              handleOpenGlobalSearch();\r\n            }\r\n          }\r\n        }\r\n      } catch {}\r\n    }\r\n  }, [selectedChat, showGlobalSearchModal, handleOpenGlobalSearch]);\r\n\r\n  if (isLoading || !currentUser) {\r\n    return <div className=\"flex h-screen items-center justify-center bg-white\">Loading...</div>;\r\n  }\r\n  \r\n  return (\r\n    <div className=\"flex h-screen w-full font-sans\">\r\n      <HomeDesktop\r\n        onNavigateToMessage={handleNavigateToMessage}\r\n        currentUser={currentUser}\r\n        groups={groups}\r\n        allUsers={allUsers}\r\n        searchTerm={searchTerm}\r\n        setSearchTerm={setSearchTerm}\r\n        setShowCreateGroupModal={setShowCreateGroupModal}\r\n        selectedChat={selectedChat}\r\n        onSelectChat={handleSelectChat}\r\n        onBackFromChat={() => setSelectedChat(null)}\r\n        onChatAction={handleChatAction}\r\n        scrollToMessageId={scrollToMessageId}\r\n        onScrollComplete={() => setScrollToMessageId(null)}\r\n        roomSearchKeyword={roomSearchKeyword}\r\n        setRoomSearchKeyword={setRoomSearchKeyword}\r\n        fetchAllData={fetchAllData}\r\n        onShowGlobalSearch={handleOpenGlobalSearch}\r\n      />\r\n\r\n      <HomeMobile\r\n        currentUser={currentUser}\r\n        groups={groups}\r\n        allUsers={allUsers}\r\n        searchTerm={searchTerm}\r\n        setSearchTerm={setSearchTerm}\r\n        setShowCreateGroupModal={setShowCreateGroupModal}\r\n        selectedChat={selectedChat}\r\n        onSelectChat={handleSelectChat}\r\n        onBackFromChat={() => setSelectedChat(null)}\r\n        onChatAction={handleChatAction}\r\n        scrollToMessageId={scrollToMessageId}\r\n        onScrollComplete={() => {\r\n          setScrollToMessageId(null);\r\n          setRoomSearchKeyword(null);\r\n        }}\r\n        roomSearchKeyword={roomSearchKeyword}\r\n        setRoomSearchKeyword={setRoomSearchKeyword}\r\n        fetchAllData={fetchAllData}\r\n        onShowGlobalSearch={handleOpenGlobalSearch}\r\n        onNavigateToMessage={handleNavigateToMessage}\r\n      />\r\n\r\n      <HomeOverlays\r\n        currentUser={currentUser}\r\n        allUsers={allUsers}\r\n        showGlobalSearchModal={showGlobalSearchModal}\r\n        globalSearchTerm={globalSearchTerm}\r\n        globalSearchResults={globalSearchResults}\r\n        onCloseGlobalSearch={handleOpenGlobalSearch}\r\n        onSearch={handleGlobalSearch}\r\n        onNavigateToMessage={handleNavigateToMessage}\r\n        onSelectContact={handleSelectContact}\r\n        showCreateGroupModal={showCreateGroupModal}\r\n        onCloseCreateGroup={() => setShowCreateGroupModal(false)}\r\n        // Sau khi tạo nhóm:\r\n        // - Đóng modal\r\n        // - Nếu có group mới trả về -> auto chọn group đó để mở giao diện chat\r\n        onGroupCreated={(group?: GroupConversation) => {\r\n          if (group) {\r\n            setSelectedChat(group);\r\n          }\r\n          setShowCreateGroupModal(false);\r\n        }}\r\n        reLoad={fetchAllData}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}