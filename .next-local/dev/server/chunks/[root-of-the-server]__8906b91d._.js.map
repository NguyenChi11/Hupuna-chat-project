{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/components/%28mongodb%29/connectToDatabase.tsx"],"sourcesContent":["// app\\lib\\monggodb\\connectToDatabase.tsx\r\n\r\nimport { MongoClient, Db } from 'mongodb';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/';\r\nconst MONGODB_DB = process.env.MONGODB_DB || 'hupuna-price';\r\n\r\n// Cache client khi hot-reload (Next.js dev mode)\r\nlet cachedClient: MongoClient | null = null;\r\nlet cachedDb: Db | null = null;\r\n\r\nexport async function connectToDatabase(): Promise<{ client: MongoClient; db: Db }> {\r\n  if (cachedClient && cachedDb) {\r\n    return { client: cachedClient, db: cachedDb };\r\n  }\r\n\r\n  if (process.env.NODE_ENV === 'production' && (MONGODB_URI.includes('localhost') || MONGODB_URI.includes('127.0.0.1'))) {\r\n    console.error('‚ùå ERROR: You are using a localhost MongoDB URI in production. Please set MONGODB_URI in your Vercel project settings to a remote database (e.g., MongoDB Atlas).');\r\n  }\r\n\r\n  const client = new MongoClient(MONGODB_URI);\r\n  await client.connect();\r\n\r\n  const db = client.db(MONGODB_DB);\r\n\r\n  cachedClient = client;\r\n  cachedDb = db;\r\n\r\n  return { client, db };\r\n}\r\n"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AAEzC;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAC/C,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,iDAAiD;AACjD,IAAI,eAAmC;AACvC,IAAI,WAAsB;AAEnB,eAAe;IACpB,IAAI,gBAAgB,UAAU;QAC5B,OAAO;YAAE,QAAQ;YAAc,IAAI;QAAS;IAC9C;IAEA,IAAI,oDAAyB,gBAAgB,CAAC,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,YAAY;;IAIpH,MAAM,SAAS,IAAI,sHAAW,CAAC;IAC/B,MAAM,OAAO,OAAO;IAEpB,MAAM,KAAK,OAAO,EAAE,CAAC;IAErB,eAAe;IACf,WAAW;IAEX,OAAO;QAAE;QAAQ;IAAG;AACtB"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/mongoDBCRUD.ts"],"sourcesContent":["// app\\lib\\monggodb\\mongoDBCRUD.ts\r\n\r\nimport { Collection, Filter, ObjectId, OptionalUnlessRequiredId, UpdateFilter, type CollationOptions } from 'mongodb';\r\nimport { connectToDatabase } from '../components/(mongodb)/connectToDatabase';\r\n\r\n// ========== Helper ====================\r\nexport function safeParse(value: unknown): unknown {\r\n  if (typeof value !== 'string') return value;\r\n  const firstChar = value.trim().charAt(0);\r\n  if (firstChar !== '[' && firstChar !== '{') return value;\r\n  try {\r\n    return JSON.parse(value);\r\n  } catch {\r\n    return value;\r\n  }\r\n}\r\n\r\n// ========== READ HEADERS (Mongo ko c√≥ headers n√™n tr·∫£ key t·ª´ document) ==========\r\nexport const getHeaders = async (collectionName: string): Promise<string[]> => {\r\n  const { db } = await connectToDatabase();\r\n  const doc = await db.collection(collectionName).findOne({});\r\n  return doc ? Object.keys(doc) : [];\r\n};\r\n\r\n// ========== FIND BY FIELD ==========\r\nexport const findByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<{ data: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const item = await db\r\n    .collection(collectionName)\r\n    .find({ [field]: value })\r\n    .toArray();\r\n  if (!item) return null;\r\n\r\n  return { data: item as unknown as T };\r\n};\r\n\r\n// ========== GET BY ID OR CODE ==========\r\nexport const getRowByIdOrCode = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  { id, code, _id }: { id?: string | number; code?: string; _id?: string },\r\n): Promise<{ rowIndex: number; row: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const filter: Record<string, unknown> = {};\r\n\r\n  if (_id) {\r\n    if (ObjectId.isValid(_id)) {\r\n      filter['_id'] = new ObjectId(_id);\r\n    } else if (!isNaN(Number(_id))) {\r\n      filter['_id'] = Number(_id);\r\n    }\r\n\r\n  }\r\n\r\n  if (id) filter['id'] = id;\r\n  if (code) filter['code'] = code;\r\n\r\n  const row = await db.collection(collectionName).findOne(filter);\r\n  return row ? { rowIndex: 0, row: row as unknown as T } : null;\r\n};\r\n\r\n// ========== GET ALL (search, filter, sort, pagination) ==========\r\nexport const getAllRows = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  {\r\n    search,\r\n    skip = 0,\r\n    limit,\r\n    field,\r\n    value,\r\n    filters,\r\n    sort,\r\n    collation,\r\n  }: {\r\n    search?: string;\r\n    skip?: number;\r\n    limit?: number;\r\n    field?: keyof T;\r\n    value?: unknown;\r\n    filters?: Record<string, unknown>;\r\n    sort?: { field: keyof T; order?: 'asc' | 'desc' } | Array<{ field: keyof T; order?: 'asc' | 'desc' }>;\r\n    collation?: CollationOptions;\r\n  } = {},\r\n): Promise<{ total: number; data: T[] }> => {\r\n  const { db } = await connectToDatabase();\r\n  const collection = db.collection(collectionName);\r\n\r\n  const query: Record<string, unknown> = {};\r\n\r\n  // Filter field=value\r\n  if (field && value !== undefined) {\r\n    query[field as string] = value;\r\n  }\r\n\r\n  // ====== 2. Filter n√¢ng cao ======\r\n  if (filters && Object.keys(filters).length > 0) {\r\n    for (const [key, rawVal] of Object.entries(filters)) {\r\n      if (rawVal === undefined || rawVal === null) continue;\r\n\r\n      // --- N·∫øu l√† m·ªánh ƒë·ªÅ $or ho·∫∑c $and ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán k·∫øt h·ª£p\r\n      if (key === '$or' || key === '$and') {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† object c√≥ $gte / $lte (l·ªçc kho·∫£ng th·ªùi gian ho·∫∑c kho·∫£ng s·ªë) ---\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        ('$gte' in (rawVal as Record<string, unknown>) || '$lte' in (rawVal as Record<string, unknown>))\r\n      ) {\r\n        (query as Record<string, unknown>)[key] = rawVal;\r\n        continue;\r\n      }\r\n      // --- N·∫øu l√† object c√≥ to√°n t·ª≠ MongoDB ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán\r\n      // $in ‚Äì ch·ª©a trong danh s√°ch gi√° tr·ªã (gi·ªëng WHERE field IN (...))\r\n      // $nin ‚Äì kh√¥ng ch·ª©a trong danh s√°ch gi√° tr·ªã\r\n      // $gte ‚Äì l·ªõn h∆°n ho·∫∑c b·∫±ng (>=)\r\n      // $lte ‚Äì nh·ªè h∆°n ho·∫∑c b·∫±ng (<=)\r\n      // $gt ‚Äì l·ªõn h∆°n (>)\r\n      // $lt ‚Äì nh·ªè h∆°n (<)\r\n      // $ne ‚Äì kh√°c (!=)\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        Object.keys(rawVal as Record<string, unknown>).some((k) =>\r\n          ['$in', '$nin', '$gte', '$lte', '$gt', '$lt', '$ne'].includes(k),\r\n        )\r\n      ) {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† chu·ªói b·∫Øt ƒë·∫ßu b·∫±ng \"#\" => regex ---\r\n      if (typeof rawVal === 'string' && rawVal.trim().startsWith('#')) {\r\n        // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm g·∫ßn ƒë√∫ng (regex)\r\n        query[key] = {\r\n          $regex: rawVal.trim().slice(1),\r\n          $options: 'i',\r\n        };\r\n        continue;\r\n      }\r\n\r\n      // Tr∆∞·ªùng h·ª£p so s√°nh ch√≠nh x√°c (exact match)\r\n      query[key] = rawVal;\r\n    }\r\n  }\r\n\r\n  // Search to√†n b·ªô text - c√°ch c≈© - ch·ªâ l·∫•y key 1 c·∫•p\r\n  // if (search) {\r\n  //     const sampleDoc = await collection.findOne();\r\n  //     if (sampleDoc) {\r\n  //         const textFields = Object.keys(sampleDoc).filter(\r\n  //             (k) => typeof sampleDoc[k] === \"string\"\r\n  //         );\r\n\r\n  //         if (textFields.length > 0) {\r\n  //             query[\"$or\"] = textFields.map((key) => ({\r\n  //                 [key]: { $regex: search, $options: \"i\" },\r\n  //             }));\r\n  //         }\r\n  //     }\r\n  // }\r\n\r\n  // Search to√†n b·ªô text - c·∫£i ti·∫øn ƒë·ªÉ l·∫•y c·∫£ c√°c key trong object con - nhi·ªÅu c·∫•p\r\n  if (search) {\r\n    const sampleDoc = await collection.findOne();\r\n    if (sampleDoc) {\r\n      // üëâ H√†m ƒë·ªá quy l·∫•y t·∫•t c·∫£ key string (k·ªÉ c·∫£ nested)\r\n      const getStringPaths = (obj: unknown, prefix = ''): string[] => {\r\n        let keys: string[] = [];\r\n        for (const [k, v] of Object.entries(obj as Record<string, unknown>)) {\r\n          const path = prefix ? `${prefix}.${k}` : k;\r\n          if (typeof v === 'string') keys.push(path);\r\n          else if (v && typeof v === 'object' && !Array.isArray(v)) keys = keys.concat(getStringPaths(v, path));\r\n        }\r\n        return keys;\r\n      };\r\n\r\n      const textFields = getStringPaths(sampleDoc);\r\n\r\n      if (textFields.length > 0) {\r\n        query['$or'] = textFields.map((path) => ({\r\n          [path]: { $regex: search, $options: 'i' },\r\n        }));\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sort\r\n  let sortOption: Record<string, 1 | -1> = {};\r\n  if (sort) {\r\n    const sortArr = Array.isArray(sort) ? sort : [sort];\r\n    sortOption = sortArr.reduce(\r\n      (acc, s) => {\r\n        acc[s.field as string] = s.order === 'desc' ? -1 : 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, 1 | -1>,\r\n    );\r\n  }\r\n\r\n  const total = await collection.countDocuments(query, collation ? { collation } : undefined);\r\n\r\n  let cursor = collection.find(query);\r\n  if (collation) {\r\n    cursor = cursor.collation(collation);\r\n  }\r\n  const data = await cursor.sort(sortOption).skip(skip).limit(limit ?? 0).toArray();\r\n\r\n  return { total, data: data as unknown as T[] };\r\n};\r\n\r\n// ========== CREATE ==========\r\nexport const addRow = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  newData: T,\r\n): Promise<string> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).insertOne(newData);\r\n  return result.insertedId.toString();\r\n};\r\nexport async function getCollection<T extends Record<string, unknown>>(name: string): Promise<Collection<T>> {\r\n  const { db } = await connectToDatabase();\r\n  return db.collection<T>(name);\r\n}\r\n// CREATE MANY\r\nexport async function createMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  docs: OptionalUnlessRequiredId<T>[],\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.insertMany(docs);\r\n}\r\n\r\n\r\n// UPDATE BY FIELD\r\nexport const updateByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n  updateData: Partial<T>,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  if ('_id' in updateData) delete updateData._id;\r\n\r\n  let queryValue: string | number | ObjectId = value;\r\n\r\n  if (field === '_id' && typeof value === 'string') {\r\n    if (ObjectId.isValid(value)) {\r\n      // N·∫øu l√† ObjectId h·ª£p l·ªá\r\n      queryValue = new ObjectId(value);\r\n    } else if (!isNaN(Number(value))) {\r\n      // N·∫øu l√† s·ªë\r\n      queryValue = Number(value);\r\n    }\r\n    // N·∫øu l√† string kh√¥ng ph·∫£i ObjectId v√† kh√¥ng ph·∫£i s·ªë, queryValue v·∫´n l√† string\r\n  }\r\n  const result = await db.collection(collectionName).updateOne({ [field]: queryValue }, { $set: updateData });\r\n\r\n  return result.modifiedCount > 0;\r\n};\r\n\r\n// UPDATE MANY\r\nexport async function updateMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  filter: Filter<T>, // ch√≠nh l√† Filter<T>, kh√¥ng ph·∫£i Filter<Document>\r\n  update: UpdateFilter<T> | Partial<T>,\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  const isOperatorUpdate =\r\n    typeof update === 'object' &&\r\n    update !== null &&\r\n    Object.keys(update as Record<string, unknown>).some((key) => key.startsWith('$'));\r\n\r\n  const updateDoc: UpdateFilter<T> = isOperatorUpdate\r\n    ? (update as UpdateFilter<T>) // n·∫øu ƒë√£ c√≥ $set, $inc,... th√¨ gi·ªØ nguy√™n\r\n    : ({ $set: update as Partial<T> } as UpdateFilter<T>);\r\n\r\n  return collection.updateMany(filter, updateDoc);\r\n}\r\n\r\n// ========== DELETE BY FIELD ==========\r\nexport const deleteByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ [field]: value });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// ========== DELETE BY ID ==========\r\nexport const deleteById = async (collectionName: string, id: string): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ _id: new ObjectId(id) });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// DELETE MANY\r\nexport async function deleteManyRows<T extends Record<string, unknown>>(collectionName: string, filter: Filter<T>) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.deleteMany(filter);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 347, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/Message.ts"],"sourcesContent":["import { User } from '@/types/User';\r\n\r\nexport const MESSAGES_COLLECTION_NAME = 'Messages';\r\n\r\nexport type MessageType = 'text' | 'image' | 'file' | 'notify' | 'sticker' | 'video' | 'reminder' | 'poll' | 'contact';\r\n\r\nexport interface Message {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  roomId: string;\r\n  sender: string | User;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  pinnedAt?: number | null;\r\n  readBy?: (string | number)[];\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  mentions?: string[];\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\nexport interface MessageCreate {\r\n  [key: string]: unknown;\r\n  roomId: string;\r\n  sender: string;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEO,MAAM,2BAA2B"}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/User.ts"],"sourcesContent":["export const USERS_COLLECTION_NAME = 'Users';\r\n\r\nexport interface User {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  name: string;\r\n  username: string;\r\n  password?: string;\r\n  unreadCount?: number;\r\n  lastMessage?: string;\r\n  lastMessageAt?: number;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n  online?: boolean;\r\n  lastSeen?: number | null;\r\n  // C√°c field tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c t√≠nh s·∫µn t·ª´ server (ti·ªán cho FE s·ª≠ d·ª•ng)\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n  isPinnedBy?: Record<string, boolean>;\r\n  isHiddenBy?: Record<string, boolean>;\r\n  isRecall?: boolean;\r\n  onesignalSubs?: string[];\r\n  nicknames?: Record<string, string>;\r\n  categoryTags?: { id: string; label: string; color: string }[];\r\n  userTags?: { id: string; label: string; color: string }[];\r\n  categoriesBy?: Record<string, string[]>;\r\n  tagsBy?: Record<string, string[]>;\r\n}\r\nexport interface UserCreate {\r\n  [key: string]: unknown;\r\n  name: string;\r\n  username: string;\r\n  password: string;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,wBAAwB"}},
    {"offset": {"line": 365, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/socketInstance.ts"],"sourcesContent":["import { Server } from 'socket.io';\r\n\r\nlet ioInstance: Server | null = null;\r\n\r\nexport function setSocketInstance(io: Server) {\r\n  ioInstance = io;\r\n}\r\n\r\nexport function getSocketInstance(): Server {\r\n  if (!ioInstance) {\r\n    throw new Error('Socket.IO instance not initialized');\r\n  }\r\n  return ioInstance;\r\n}"],"names":[],"mappings":";;;;;;AAEA,IAAI,aAA4B;AAEzB,SAAS,kBAAkB,EAAU;IAC1C,aAAa;AACf;AAEO,SAAS;IACd,IAAI,CAAC,YAAY;QACf,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT"}},
    {"offset": {"line": 385, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/utils/utils.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\nexport const getProxyUrl = (url?: string, download?: boolean) => {\r\n  if (!url) return '';\r\n\r\n  // C√°c link kh√°c (S3, Firebase, External, PocketBase...) -> Gi·ªØ nguy√™n\r\n  return url;\r\n};\r\n\r\n// 2. Helper check video (ƒë·∫∑t ngo√†i component)\r\nexport const isVideoFile = (fileName?: string) => {\r\n  if (!fileName) return false;\r\n  const videoExtensions = ['mp4', 'mov', 'avi', 'mkv', 'webm', 'flv'];\r\n  const ext = fileName.split('.').pop()?.toLowerCase();\r\n  return videoExtensions.includes(ext || '');\r\n};\r\n\r\nexport const isLink = (str: string | undefined): boolean => {\r\n  const pattern = new RegExp(\r\n    '^(https?:\\\\/\\\\/)?' + // protocol\r\n      '(' + // B·∫Øt ƒë·∫ßu nh√≥m Hostname\r\n      'localhost|' + // ‚úÖ TH√äM D√íNG N√ÄY: Ch·∫•p nh·∫≠n localhost\r\n      '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,})|' + // domain name (google.com)\r\n      '((\\\\d{1,3}\\\\.){3}\\\\d{1,3})' + // OR ip (127.0.0.1)\r\n      ')' + // K·∫øt th√∫c nh√≥m Hostname\r\n      '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*' + // port and path\r\n      '(\\\\?[;&a-z\\\\d%_.~+=-]*)?' + // query string\r\n      '(\\\\#[-a-z\\\\d_]*)?$', // fragment locator\r\n    'i',\r\n  );\r\n  return !!pattern.test(str || '');\r\n};\r\n\r\nexport const resolveSocketUrl = (): string => {\r\n  const envUrl = (process.env.NEXT_PUBLIC_SOCKET_URL || '').trim();\r\n  const envPort = (process.env.NEXT_PUBLIC_SOCKET_PORT || '').trim();\r\n\r\n  if (typeof window === 'undefined') return envUrl || '';\r\n\r\n  const host = window.location.hostname;\r\n  const protocol = window.location.protocol;\r\n  const isSecure = protocol === 'https:';\r\n\r\n  // 1. ∆Øu ti√™n URL t·ª´ bi·∫øn m√¥i tr∆∞·ªùng\r\n  if (envUrl) {\r\n    let finalUrl = envUrl;\r\n    // N·∫øu URL ch·ª©a localhost/127.0.0.1 -> thay b·∫±ng hostname hi·ªán t·∫°i\r\n    if (finalUrl.includes('localhost') || finalUrl.includes('127.0.0.1')) {\r\n      finalUrl = finalUrl.replace('localhost', host).replace('127.0.0.1', host);\r\n    }\r\n\r\n    // N·∫øu ƒë√£ c√≥ protocol\r\n    if (finalUrl.match(/^(ws|wss|http|https):\\/\\//)) {\r\n      // N·∫øu ƒëang ·ªü HTTPS, b·∫Øt bu·ªôc d√πng WSS/HTTPS ƒë·ªÉ tr√°nh Mixed Content\r\n      if (isSecure) {\r\n        return finalUrl.replace(/^http:/, 'https:').replace(/^ws:/, 'wss:');\r\n      }\r\n      return finalUrl;\r\n    }\r\n\r\n    // N·∫øu ch∆∞a c√≥ protocol\r\n    const proto = isSecure ? 'https:' : 'http:';\r\n    return `${proto}//${finalUrl}`;\r\n  } else if (process.env.NODE_ENV === 'production') {\r\n    console.warn(\r\n      '‚ö†Ô∏è WARNING: NEXT_PUBLIC_SOCKET_URL is not defined. Socket connection may fail if the fallback logic is incorrect for your deployment.',\r\n    );\r\n  }\r\n\r\n  // 2. Logic fallback (t·ª± ƒë·ªông ƒëo√°n)\r\n  const port = envPort || '3002';\r\n\r\n  // Localhost / Dev -> Lu√¥n d√πng http + port\r\n  if (host === 'localhost' || host === '127.0.0.1') {\r\n    return `http://${host}:${port}`;\r\n  }\r\n\r\n  // Production (HTTPS)\r\n  if (isSecure) {\r\n    // N·∫øu kh√¥ng set port c·ª• th·ªÉ trong ENV, ta gi·∫£ ƒë·ªãnh d√πng port 443 (qua Nginx proxy)\r\n    // ƒë·ªÉ tr√°nh l·ªói Mixed Content (wss://...:3002 y√™u c·∫ßu SSL tr√™n port 3002)\r\n    if (!envPort) {\r\n      return `https://${host}`;\r\n    }\r\n    // N·∫øu c√≥ set port, d√πng port ƒë√≥ v·ªõi https (wss)\r\n    return `https://${host}:${port}`;\r\n  }\r\n\r\n  // Production (HTTP) ho·∫∑c IP LAN\r\n  return `${protocol}//${host}:${port}`;\r\n};\r\n\r\nexport const normalizeNoAccent = (str: string): string => {\r\n  return str\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .replace(/ƒë/g, 'd')\r\n    .replace(/ƒê/g, 'D')\r\n    .toLowerCase();\r\n};\r\n\r\nconst normalizeNoAccentKeepDHook = (str: string): string => {\r\n  return String(str || '')\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .normalize('NFC')\r\n    .toLowerCase();\r\n};\r\n\r\nexport const buildAccentInsensitiveRegex = (term: string): RegExp => {\r\n  const escape = (ch: string) => ch.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  const parts: string[] = [];\r\n  for (const ch of term) {\r\n    if (/\\s/.test(ch)) {\r\n      parts.push('\\\\s+');\r\n    } else if (/[A-Za-z]/.test(ch)) {\r\n      if (ch.toLowerCase() === 'd') {\r\n        parts.push('(?:[dƒë][\\\\u0300-\\\\u036f]*)');\r\n      } else {\r\n        parts.push(`(?:${escape(ch)}[\\\\u0300-\\\\u036f]*)`);\r\n      }\r\n    } else {\r\n      parts.push(escape(ch));\r\n    }\r\n  }\r\n  const pattern = parts.join('');\r\n  return new RegExp(`(${pattern})`, 'giu');\r\n};\r\n\r\nexport const hasDiacritics = (str: string): boolean => {\r\n  const s = String(str || '');\r\n  const sNFD = s.normalize('NFD');\r\n  if (/[\\u0300-\\u036f]/.test(sNFD)) return true;\r\n  return /[ƒëƒê]/.test(s);\r\n};\r\n\r\nexport const computeMatchScore = (text: string, term: string): number => {\r\n  const escape = (v: string) => v.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  const txt = String(text || '').toLowerCase();\r\n  const q = String(term || '').toLowerCase();\r\n  const nTxt = normalizeNoAccent(txt);\r\n  const nQ = normalizeNoAccent(q);\r\n  if (!nTxt.includes(nQ)) return -Infinity;\r\n\r\n  const qHasDia = hasDiacritics(q);\r\n  const exactIdx = txt.indexOf(q);\r\n  const normIdx = nTxt.indexOf(nQ);\r\n  const wordExact = new RegExp(`(^|\\\\b)${escape(q)}`, 'i').test(txt);\r\n  const wordNorm = new RegExp(`(^|\\\\b)${escape(nQ)}`, 'i').test(nTxt);\r\n\r\n  let score = 0;\r\n  if (exactIdx >= 0) {\r\n    score += 50;\r\n    if (qHasDia) score += 30;\r\n    if (exactIdx === 0) score += 20;\r\n    if (wordExact) score += 10;\r\n    score += Math.max(0, 10 - exactIdx);\r\n  } else {\r\n    score += 20;\r\n    if (normIdx === 0) score += 10;\r\n    if (wordNorm) score += 5;\r\n    score += Math.max(0, 5 - normIdx);\r\n  }\r\n  const lengthBoost = Math.min(10, Math.floor((nQ.length / Math.max(1, nTxt.length)) * 10));\r\n  score += lengthBoost;\r\n  return score;\r\n};\r\n\r\nconst hasToneMarks = (str: string): boolean => {\r\n  const s = String(str || '').normalize('NFD');\r\n  return /[\\u0300\\u0301\\u0303\\u0309\\u0323]/.test(s);\r\n};\r\n\r\nconst stripToneMarks = (str: string): string => {\r\n  return String(str || '')\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300\\u0301\\u0303\\u0309\\u0323]/g, '')\r\n    .normalize('NFC')\r\n    .toLowerCase();\r\n};\r\n\r\nconst stripBaseMarks = (str: string): string => {\r\n  return String(str || '')\r\n    .normalize('NFD')\r\n    .replace(/[\\u0302\\u0306\\u031B]/g, '')\r\n    .normalize('NFC')\r\n    .toLowerCase();\r\n};\r\n\r\nexport const accentAwareIncludes = (text: string, keyword: string): boolean => {\r\n  const t = String(text || '');\r\n  const k = String(keyword || '');\r\n  if (!k.trim()) return true;\r\n  const tNFC = t.normalize('NFC');\r\n  const kNFC = k.normalize('NFC');\r\n  const kHasDia = hasDiacritics(kNFC);\r\n  if (kHasDia) {\r\n    if (hasToneMarks(kNFC)) {\r\n      const tBase = stripBaseMarks(tNFC);\r\n      const kBase = stripBaseMarks(kNFC);\r\n      return tBase.includes(kBase);\r\n    }\r\n    const tNoTone = stripToneMarks(tNFC);\r\n    const kNoTone = stripToneMarks(kNFC);\r\n    const tNoAccent = normalizeNoAccentKeepDHook(tNoTone);\r\n    const kNoAccent = normalizeNoAccentKeepDHook(kNoTone);\r\n    return tNoAccent.includes(kNoAccent);\r\n  }\r\n  const tNo = normalizeNoAccentKeepDHook(tNFC);\r\n  const kNo = normalizeNoAccentKeepDHook(kNFC);\r\n  return tNo.includes(kNo);\r\n};\r\n\r\nexport const stripHtml = (html: string) => {\r\n  if (!html) return '';\r\n  // Check if it's HTML-like\r\n  if (!/<[a-z][\\s\\S]*>/i.test(html)) return html;\r\n  // Strip tags\r\n  return html\r\n    .replace(/<[^>]+>/g, ' ')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim();\r\n};\r\n"],"names":[],"mappings":"AAAA,oDAAoD;;;;;;;;;;;;;;;;;;;;;;AAC7C,MAAM,cAAc,CAAC,KAAc;IACxC,IAAI,CAAC,KAAK,OAAO;IAEjB,sEAAsE;IACtE,OAAO;AACT;AAGO,MAAM,cAAc,CAAC;IAC1B,IAAI,CAAC,UAAU,OAAO;IACtB,MAAM,kBAAkB;QAAC;QAAO;QAAO;QAAO;QAAO;QAAQ;KAAM;IACnE,MAAM,MAAM,SAAS,KAAK,CAAC,KAAK,GAAG,IAAI;IACvC,OAAO,gBAAgB,QAAQ,CAAC,OAAO;AACzC;AAEO,MAAM,SAAS,CAAC;IACrB,MAAM,UAAU,IAAI,OAClB,sBAAsB,WAAW;IAC/B,MAAM,wBAAwB;IAC9B,eAAe,uCAAuC;IACtD,sDAAsD,2BAA2B;IACjF,+BAA+B,oBAAoB;IACnD,MAAM,yBAAyB;IAC/B,oCAAoC,gBAAgB;IACpD,6BAA6B,eAAe;IAC5C,sBACF;IAEF,OAAO,CAAC,CAAC,QAAQ,IAAI,CAAC,OAAO;AAC/B;AAEO,MAAM,mBAAmB;IAC9B,MAAM,SAAS,CAAC,6DAAsC,EAAE,EAAE,IAAI;IAC9D,MAAM,UAAU,CAAC,4CAAuC,EAAE,EAAE,IAAI;IAEhE,wCAAmC,OAAO,UAAU;;;IAEpD,MAAM;IACN,MAAM;IACN,MAAM;IA4BN,mCAAmC;IACnC,MAAM;AAoBR;AAEO,MAAM,oBAAoB,CAAC;IAChC,OAAO,IACJ,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAC5B,OAAO,CAAC,MAAM,KACd,OAAO,CAAC,MAAM,KACd,WAAW;AAChB;AAEA,MAAM,6BAA6B,CAAC;IAClC,OAAO,OAAO,OAAO,IAClB,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAC5B,SAAS,CAAC,OACV,WAAW;AAChB;AAEO,MAAM,8BAA8B,CAAC;IAC1C,MAAM,SAAS,CAAC,KAAe,GAAG,OAAO,CAAC,uBAAuB;IACjE,MAAM,QAAkB,EAAE;IAC1B,KAAK,MAAM,MAAM,KAAM;QACrB,IAAI,KAAK,IAAI,CAAC,KAAK;YACjB,MAAM,IAAI,CAAC;QACb,OAAO,IAAI,WAAW,IAAI,CAAC,KAAK;YAC9B,IAAI,GAAG,WAAW,OAAO,KAAK;gBAC5B,MAAM,IAAI,CAAC;YACb,OAAO;gBACL,MAAM,IAAI,CAAC,CAAC,GAAG,EAAE,OAAO,IAAI,mBAAmB,CAAC;YAClD;QACF,OAAO;YACL,MAAM,IAAI,CAAC,OAAO;QACpB;IACF;IACA,MAAM,UAAU,MAAM,IAAI,CAAC;IAC3B,OAAO,IAAI,OAAO,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,EAAE;AACpC;AAEO,MAAM,gBAAgB,CAAC;IAC5B,MAAM,IAAI,OAAO,OAAO;IACxB,MAAM,OAAO,EAAE,SAAS,CAAC;IACzB,IAAI,kBAAkB,IAAI,CAAC,OAAO,OAAO;IACzC,OAAO,OAAO,IAAI,CAAC;AACrB;AAEO,MAAM,oBAAoB,CAAC,MAAc;IAC9C,MAAM,SAAS,CAAC,IAAc,EAAE,OAAO,CAAC,uBAAuB;IAC/D,MAAM,MAAM,OAAO,QAAQ,IAAI,WAAW;IAC1C,MAAM,IAAI,OAAO,QAAQ,IAAI,WAAW;IACxC,MAAM,OAAO,kBAAkB;IAC/B,MAAM,KAAK,kBAAkB;IAC7B,IAAI,CAAC,KAAK,QAAQ,CAAC,KAAK,OAAO,CAAC;IAEhC,MAAM,UAAU,cAAc;IAC9B,MAAM,WAAW,IAAI,OAAO,CAAC;IAC7B,MAAM,UAAU,KAAK,OAAO,CAAC;IAC7B,MAAM,YAAY,IAAI,OAAO,CAAC,OAAO,EAAE,OAAO,IAAI,EAAE,KAAK,IAAI,CAAC;IAC9D,MAAM,WAAW,IAAI,OAAO,CAAC,OAAO,EAAE,OAAO,KAAK,EAAE,KAAK,IAAI,CAAC;IAE9D,IAAI,QAAQ;IACZ,IAAI,YAAY,GAAG;QACjB,SAAS;QACT,IAAI,SAAS,SAAS;QACtB,IAAI,aAAa,GAAG,SAAS;QAC7B,IAAI,WAAW,SAAS;QACxB,SAAS,KAAK,GAAG,CAAC,GAAG,KAAK;IAC5B,OAAO;QACL,SAAS;QACT,IAAI,YAAY,GAAG,SAAS;QAC5B,IAAI,UAAU,SAAS;QACvB,SAAS,KAAK,GAAG,CAAC,GAAG,IAAI;IAC3B;IACA,MAAM,cAAc,KAAK,GAAG,CAAC,IAAI,KAAK,KAAK,CAAC,AAAC,GAAG,MAAM,GAAG,KAAK,GAAG,CAAC,GAAG,KAAK,MAAM,IAAK;IACrF,SAAS;IACT,OAAO;AACT;AAEA,MAAM,eAAe,CAAC;IACpB,MAAM,IAAI,OAAO,OAAO,IAAI,SAAS,CAAC;IACtC,OAAO,mCAAmC,IAAI,CAAC;AACjD;AAEA,MAAM,iBAAiB,CAAC;IACtB,OAAO,OAAO,OAAO,IAClB,SAAS,CAAC,OACV,OAAO,CAAC,qCAAqC,IAC7C,SAAS,CAAC,OACV,WAAW;AAChB;AAEA,MAAM,iBAAiB,CAAC;IACtB,OAAO,OAAO,OAAO,IAClB,SAAS,CAAC,OACV,OAAO,CAAC,yBAAyB,IACjC,SAAS,CAAC,OACV,WAAW;AAChB;AAEO,MAAM,sBAAsB,CAAC,MAAc;IAChD,MAAM,IAAI,OAAO,QAAQ;IACzB,MAAM,IAAI,OAAO,WAAW;IAC5B,IAAI,CAAC,EAAE,IAAI,IAAI,OAAO;IACtB,MAAM,OAAO,EAAE,SAAS,CAAC;IACzB,MAAM,OAAO,EAAE,SAAS,CAAC;IACzB,MAAM,UAAU,cAAc;IAC9B,IAAI,SAAS;QACX,IAAI,aAAa,OAAO;YACtB,MAAM,QAAQ,eAAe;YAC7B,MAAM,QAAQ,eAAe;YAC7B,OAAO,MAAM,QAAQ,CAAC;QACxB;QACA,MAAM,UAAU,eAAe;QAC/B,MAAM,UAAU,eAAe;QAC/B,MAAM,YAAY,2BAA2B;QAC7C,MAAM,YAAY,2BAA2B;QAC7C,OAAO,UAAU,QAAQ,CAAC;IAC5B;IACA,MAAM,MAAM,2BAA2B;IACvC,MAAM,MAAM,2BAA2B;IACvC,OAAO,IAAI,QAAQ,CAAC;AACtB;AAEO,MAAM,YAAY,CAAC;IACxB,IAAI,CAAC,MAAM,OAAO;IAClB,0BAA0B;IAC1B,IAAI,CAAC,kBAAkB,IAAI,CAAC,OAAO,OAAO;IAC1C,aAAa;IACb,OAAO,KACJ,OAAO,CAAC,YAAY,KACpB,OAAO,CAAC,QAAQ,KAChB,IAAI;AACT"}},
    {"offset": {"line": 553, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/api/messages/route.ts"],"sourcesContent":["// src/app/api/messages/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport {\r\n  addRow,\r\n  deleteByField,\r\n  deleteById,\r\n  getAllRows,\r\n  getRowByIdOrCode,\r\n  updateByField,\r\n  updateMany,\r\n  deleteManyRows,\r\n} from '@/lib/mongoDBCRUD';\r\nimport { Message, MESSAGES_COLLECTION_NAME } from '@/types/Message';\r\nimport { User, USERS_COLLECTION_NAME } from '@/types/User';\r\nimport { GroupConversation, GroupMemberSchema, MemberInfo } from '@/types/Group';\r\nimport { Filter, ObjectId } from 'mongodb';\r\nimport { getSocketInstance } from '@/lib/socketInstance';\r\nimport { normalizeNoAccent } from '@/utils/utils';\r\n\r\ntype MongoFilters = Record<string, unknown>;\r\ntype MemberInput = string | GroupMemberSchema | MemberInfo | { id?: string; _id?: string };\r\ntype GroupSummary = { _id: string; name: string; avatar?: string; isGroup: boolean; members: string[] };\r\n\r\nasync function sendPushOnMessage(data: { roomId: string; senderId: string; content?: string }) {\r\n  const appId = process.env.NEXT_PUBLIC_ONESIGNAL_APP_ID || process.env.ONESIGNAL_APP_ID || '';\r\n  const apiKey = process.env.ONESIGNAL_REST_API_KEY || '';\r\n  if (!appId || !apiKey) return;\r\n\r\n  const roomId = String(data.roomId);\r\n  const senderId = String(data.senderId);\r\n  let recipients: string[] = [];\r\n  let heading = 'Tin nh·∫Øn m·ªõi';\r\n  const body = data.content || 'B·∫°n c√≥ tin nh·∫Øn m·ªõi';\r\n\r\n  try {\r\n    const senderRes = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n      filters: { _id: ObjectId.isValid(senderId) ? new ObjectId(senderId) : senderId },\r\n      limit: 1,\r\n    });\r\n    const sender = senderRes.data?.[0];\r\n    if (sender && sender.name) heading = sender.name;\r\n  } catch (error) {\r\n    console.warn('sendPushOnMessage:getSender', error);\r\n  }\r\n\r\n  if (roomId.includes('_')) {\r\n    const parts = roomId.split('_');\r\n    const other = parts.find((p) => String(p) !== senderId) || parts[0];\r\n    recipients = [String(other)];\r\n  } else {\r\n    try {\r\n      const groupRes = await getAllRows<GroupConversation>('Groups', {\r\n        filters: { _id: ObjectId.isValid(roomId) ? new ObjectId(roomId) : roomId },\r\n        limit: 1,\r\n      });\r\n      const group = groupRes.data?.[0];\r\n      if (group) {\r\n        heading = group.name || heading;\r\n        const members: (GroupMemberSchema | MemberInfo | string)[] = Array.isArray(group.members) ? group.members : [];\r\n        const ids = members\r\n          .map((m) => {\r\n            if (typeof m === 'string') return String(m);\r\n            const obj = m as GroupMemberSchema | MemberInfo;\r\n            return obj._id ? String(obj._id) : (obj as MemberInfo).id ? String((obj as MemberInfo).id) : '';\r\n          })\r\n          .filter((id) => id && id !== senderId);\r\n        recipients = Array.from(new Set(ids));\r\n      }\r\n    } catch (error) {\r\n      console.warn('sendPushOnMessage:getGroup', error);\r\n    }\r\n  }\r\n\r\n  const targets = Array.from(new Set([...recipients, senderId])).filter(Boolean);\r\n  if (targets.length === 0) return;\r\n\r\n  const url = 'https://api.onesignal.com/notifications';\r\n  let subscriptionIds: string[] = [];\r\n  try {\r\n    const usersRes = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n      filters: { _id: { $in: targets.map((t) => (ObjectId.isValid(t) ? new ObjectId(t) : t)) } },\r\n      limit: 9999,\r\n    });\r\n    subscriptionIds = Array.from(\r\n      new Set(\r\n        (usersRes.data || [])\r\n          .map((u) =>\r\n            Array.isArray((u as Record<string, unknown>)['onesignalSubs'])\r\n              ? ((u as Record<string, unknown>)['onesignalSubs'] as string[])\r\n              : [],\r\n          )\r\n          .flat()\r\n          .filter((x) => typeof x === 'string' && x.trim().length > 0),\r\n      ),\r\n    );\r\n  } catch (error) {\r\n    console.warn('sendPushOnMessage:getSubscriptions', error);\r\n  }\r\n\r\n  const useSubs = subscriptionIds.length > 0;\r\n  const payload = useSubs\r\n    ? {\r\n        app_id: appId,\r\n        include_subscription_ids: subscriptionIds,\r\n        target_channel: 'push',\r\n        contents: { en: body, vi: body },\r\n        headings: { en: heading, vi: heading },\r\n        isAnyWeb: true,\r\n      }\r\n    : {\r\n        app_id: appId,\r\n        include_aliases: { external_id: targets },\r\n        target_channel: 'push',\r\n        contents: { en: body, vi: body },\r\n        headings: { en: heading, vi: heading },\r\n        isAnyWeb: true,\r\n      };\r\n\r\n  try {\r\n    const postWithRetry = async (p: Record<string, unknown>) => {\r\n      const max = 3;\r\n      let i = 0;\r\n      let last: Response | null = null;\r\n      while (i < max) {\r\n        last = await fetch(url, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            Authorization: `key ${apiKey}`,\r\n          },\r\n          body: JSON.stringify(p),\r\n        });\r\n        if (last.ok) return last;\r\n        i++;\r\n        if (i < max) {\r\n          await new Promise((r) => setTimeout(r, 300 * Math.pow(2, i - 1)));\r\n        }\r\n      }\r\n      return last as Response;\r\n    };\r\n\r\n    const res = await postWithRetry(payload);\r\n    if (!res.ok) {\r\n      const filtersPayload = {\r\n        app_id: appId,\r\n        target_channel: 'push',\r\n        isAnyWeb: true,\r\n        filters: targets\r\n          .map((rid) => ({ field: 'tag', relation: '=', key: 'userId', value: rid }))\r\n          .flatMap((f, i) => (i === 0 ? [f] : [{ operator: 'OR' }, f])),\r\n        contents: { en: body, vi: body },\r\n        headings: { en: heading, vi: heading },\r\n      };\r\n      const fallbackRes = await postWithRetry(filtersPayload);\r\n      if (!fallbackRes.ok) {\r\n        const txt = await fallbackRes.text().catch(() => '');\r\n        console.error('sendPushOnMessage:onesignal', fallbackRes.status, txt);\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('sendPushOnMessage:send', error);\r\n  }\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const {\r\n    action,\r\n    collectionName = MESSAGES_COLLECTION_NAME,\r\n    data,\r\n    filters,\r\n    field,\r\n    value,\r\n    skip,\r\n    limit,\r\n    _id: requestId,\r\n    code,\r\n    sort,\r\n    roomId,\r\n    userId,\r\n    messageId,\r\n    assetType,\r\n    beforeTs,\r\n  } = await req.json();\r\n\r\n  try {\r\n    switch (action) {\r\n      case 'create': {\r\n        const t = String(data?.type || '').toLowerCase();\r\n        let newData = {\r\n          ...data,\r\n          timestamp: Date.now(),\r\n          readBy: [String(data.sender)],\r\n        } as Record<string, unknown>;\r\n\r\n        if (t === 'poll') {\r\n          const qRaw = String(data?.['pollQuestion'] ?? data?.['content'] ?? '').trim();\r\n          const arrRaw = Array.isArray((data as Record<string, unknown>)['pollOptions'])\r\n            ? ((data as Record<string, unknown>)['pollOptions'] as unknown[])\r\n            : [];\r\n          const cleaned = arrRaw.map((o) => String(o || '').trim()).filter((o) => o);\r\n          const lowers = Array.from(new Set(cleaned.map((o) => o.toLowerCase())));\r\n          const unique = lowers.map((lo) => cleaned.find((x) => x.toLowerCase() === lo) as string);\r\n          if (!qRaw || unique.length < 2) {\r\n            return NextResponse.json({ error: 'Invalid poll' }, { status: 400 });\r\n          }\r\n          newData = {\r\n            ...newData,\r\n            type: 'poll',\r\n            content: qRaw,\r\n            pollQuestion: qRaw,\r\n            pollOptions: unique,\r\n            pollVotes: {},\r\n            isPollLocked: !!(data as Record<string, unknown>)['isPollLocked'] ? true : false,\r\n          };\r\n        }\r\n\r\n        // X√≥a _id (n·∫øu c√≥) ƒë·ªÉ MongoDB t·ª± sinh ObjectId m·ªõi\r\n        if ((newData as Record<string, unknown>)['_id']) delete (newData as Record<string, unknown>)['_id'];\r\n        if ((newData as Record<string, unknown>)['id']) delete (newData as Record<string, unknown>)['id'];\r\n\r\n        const newId = await addRow<Record<string, unknown>>(collectionName, newData);\r\n        Promise.resolve()\r\n          .then(() =>\r\n            sendPushOnMessage({\r\n              roomId: String(newData.roomId),\r\n              senderId: String(newData.sender),\r\n              content: String(newData.content || ''),\r\n            }),\r\n          )\r\n          .catch((error) => {\r\n            console.error('messages.create:push', error);\r\n          });\r\n        return NextResponse.json({ success: true, _id: newId });\r\n      }\r\n\r\n      case 'read': {\r\n        const { roomId, isPinned, searchQuery, ...otherFilters } = filters || {};\r\n\r\n        const baseFilters: MongoFilters = {};\r\n        if (roomId) {\r\n          const variants: unknown[] = [roomId];\r\n          const num = Number(roomId);\r\n          if (!Number.isNaN(num)) variants.push(num);\r\n          if (ObjectId.isValid(String(roomId))) variants.push(new ObjectId(String(roomId)));\r\n          (baseFilters as Record<string, unknown>).roomId = { $in: variants };\r\n        }\r\n\r\n        if (isPinned !== undefined) {\r\n          (baseFilters as Record<string, unknown>).isPinned = isPinned;\r\n        }\r\n\r\n        const finalFilters: MongoFilters = { ...baseFilters };\r\n        for (const [k, v] of Object.entries(otherFilters || {})) {\r\n          if (k === 'timestamp') continue;\r\n          (finalFilters as Record<string, unknown>)[k] = v;\r\n        }\r\n\r\n        const searchOr: Array<Record<string, unknown>> | null = null;\r\n        if (searchQuery && typeof searchQuery === 'string' && searchQuery.trim()) {\r\n          // Kh√¥ng th√™m $regex ·ªü Mongo ƒë·ªÉ tr√°nh ph·∫£i ƒëi·ªÅn ƒë·ªß d·∫•u\r\n          // Ch·ªâ ƒë·∫£m b·∫£o lo·∫°i b·ªè notify ƒë·ªÉ gi·∫£m d·ªØ li·ªáu\r\n          if (!otherFilters || !Object.keys(otherFilters).includes('type')) {\r\n            (finalFilters as Record<string, unknown>).type = { $ne: 'notify' };\r\n          }\r\n        }\r\n\r\n        const tsCondRaw = (otherFilters || {})['timestamp'] as Record<string, unknown> | undefined;\r\n        if (tsCondRaw && typeof tsCondRaw === 'object') {\r\n          const op = (['$lt', '$lte', '$gt', '$gte'] as const).find((k) => k in tsCondRaw);\r\n          if (op) {\r\n            const val = (tsCondRaw as Record<string, unknown>)[op] as number;\r\n            const expr = { [op]: [{ $toDouble: '$timestamp' }, val] } as Record<string, unknown>;\r\n            const tsOr = [{ timestamp: tsCondRaw }, { $expr: expr }];\r\n            if (searchOr) {\r\n              (finalFilters as Record<string, unknown>).$and = [{ $or: tsOr }, { $or: searchOr }];\r\n            } else {\r\n              (finalFilters as Record<string, unknown>).$or = tsOr;\r\n            }\r\n          } else if (searchOr) {\r\n            (finalFilters as Record<string, unknown>).$or = searchOr;\r\n          }\r\n        }\r\n\r\n        const result = await getAllRows<Message>(collectionName, {\r\n          search: undefined,\r\n          skip,\r\n          limit,\r\n          filters: finalFilters,\r\n          sort,\r\n          collation: { locale: 'vi', strength: 1, normalization: true },\r\n        });\r\n\r\n        let messages: Message[] = result.data || [];\r\n        if (searchQuery && typeof searchQuery === 'string' && searchQuery.trim()) {\r\n          const term = normalizeNoAccent(searchQuery);\r\n          messages = messages.filter((m) => {\r\n            const text =\r\n              m.type === 'file'\r\n                ? String(m.fileName || '')\r\n                : m.type === 'sticker'\r\n                  ? ''\r\n                  : String(m.content || '');\r\n            return normalizeNoAccent(text).includes(term);\r\n          });\r\n        }\r\n\r\n        // ... (ph·∫ßn c√≤n l·∫°i c·ªßa case 'read' ƒë·ªÉ l·∫•y th√¥ng tin sender v√† tr·∫£ v·ªÅ)\r\n        // ... (ph·∫ßn l·∫•y danh s√°ch senderIds, query users, enrichedMessages)\r\n\r\n        // L·∫•y danh s√°ch senderId (h·ªó tr·ª£ c·∫£ ObjectId, number, string)\r\n        const rawSenderIds = [\r\n          ...new Set(\r\n            messages.map((m) => {\r\n              const s = (m as Message).sender as unknown;\r\n              if (s && typeof s === 'object' && s !== null && '_id' in (s as Record<string, unknown>)) {\r\n                return String((s as Record<string, unknown>)._id);\r\n              }\r\n              return String((m as Message).sender);\r\n            }),\r\n          ),\r\n        ];\r\n\r\n        const senderIdValues = rawSenderIds.map((idStr) => {\r\n          if (ObjectId.isValid(idStr)) return new ObjectId(idStr);\r\n          const num = Number(idStr);\r\n          return Number.isNaN(num) ? idStr : num;\r\n        });\r\n\r\n        // ... (c√°c b∆∞·ªõc l·∫•y userMap v√† enrichedMessages)\r\n\r\n        const usersResult = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n          filters: { _id: { $in: senderIdValues } },\r\n          limit: 999999,\r\n        });\r\n        const userMap = new Map<string, User>();\r\n        (usersResult.data || []).forEach((u) => userMap.set(String(u._id), u));\r\n\r\n        // Map info v√†o message\r\n        const enrichedMessages = messages.map((msg) => {\r\n          const user = userMap.get(String(msg.sender));\r\n          return {\r\n            ...msg,\r\n            sender: user\r\n              ? { _id: String(user._id), name: user.name, avatar: user.avatar }\r\n              : { _id: String(msg.sender), name: 'Unknown', avatar: null },\r\n          };\r\n        });\r\n\r\n        const uniqueMessages = Array.from(new Map(enrichedMessages.map((m) => [String(m._id), m])).values());\r\n        return NextResponse.json({\r\n          total: result.total,\r\n          data: uniqueMessages,\r\n        });\r\n      }\r\n\r\n      case 'readAssets': {\r\n        if (!roomId) return NextResponse.json({ error: 'Missing roomId' }, { status: 400 });\r\n        const type = String(assetType || '').toLowerCase();\r\n        const max = typeof limit === 'number' && limit > 0 ? Math.min(limit, 5000) : 6;\r\n\r\n        const videoRegex = /\\.(mp4|mov|mkv|webm|avi|m4v)$/i;\r\n        const linkRegex = /(https?:\\/\\/|www\\.)\\S+/i;\r\n\r\n        const baseFilters: MongoFilters = {\r\n          roomId,\r\n          isRecalled: { $ne: true },\r\n        };\r\n        if (typeof beforeTs === 'number' && beforeTs > 0) {\r\n          (baseFilters as MongoFilters).timestamp = { $lte: beforeTs };\r\n        }\r\n\r\n        let mongoFilters: MongoFilters = { ...baseFilters };\r\n\r\n        if (type === 'media') {\r\n          mongoFilters = {\r\n            ...baseFilters,\r\n            $or: [\r\n              { type: 'image' },\r\n              { type: 'video' },\r\n              {\r\n                $and: [\r\n                  { type: 'file' },\r\n                  { $or: [{ fileUrl: { $regex: videoRegex } }, { fileName: { $regex: videoRegex } }] },\r\n                ],\r\n              },\r\n            ],\r\n          };\r\n        } else if (type === 'file') {\r\n          mongoFilters = {\r\n            ...baseFilters,\r\n            type: 'file',\r\n            $nor: [{ fileUrl: { $regex: videoRegex } }, { fileName: { $regex: videoRegex } }],\r\n          };\r\n        } else if (type === 'link') {\r\n          mongoFilters = {\r\n            ...baseFilters,\r\n            type: 'text',\r\n            content: { $regex: linkRegex },\r\n          };\r\n        } else {\r\n          return NextResponse.json({ error: 'Invalid assetType' }, { status: 400 });\r\n        }\r\n\r\n        const result = await getAllRows<Message>(collectionName, {\r\n          filters: mongoFilters,\r\n          limit: max,\r\n          sort: { field: 'timestamp', order: 'desc' },\r\n        });\r\n\r\n        const items: { id: string; url?: string; fileName?: string; type?: string; timestamp: number }[] = (\r\n          result.data || []\r\n        ).map((msg) => {\r\n          if (type === 'media') {\r\n            const isVid = msg.type === 'video' || videoRegex.test(String(msg.fileUrl || msg.fileName || ''));\r\n            return {\r\n              id: String(msg._id),\r\n              url: String(msg.fileUrl || ''),\r\n              fileName: msg.fileName,\r\n              type: isVid ? 'video' : 'image',\r\n              timestamp: Number(msg.timestamp) || Date.now(),\r\n            };\r\n          }\r\n          if (type === 'file') {\r\n            return {\r\n              id: String(msg._id),\r\n              url: String(msg.fileUrl || msg.content || ''),\r\n              fileName: msg.fileName || 'T√†i li·ªáu',\r\n              timestamp: Number(msg.timestamp) || Date.now(),\r\n            };\r\n          }\r\n          // link\r\n          {\r\n            const raw = String(msg.content || '');\r\n            const firstMatch = raw.match(linkRegex);\r\n            const onlyUrl = firstMatch ? String(firstMatch[0]) : '';\r\n            return {\r\n              id: String(msg._id),\r\n              url: onlyUrl,\r\n              timestamp: Number(msg.timestamp) || Date.now(),\r\n            };\r\n          }\r\n        });\r\n\r\n        const toDateKey = (ts: number) => {\r\n          const d = new Date(ts);\r\n          const y = d.getFullYear();\r\n          const m = String(d.getMonth() + 1).padStart(2, '0');\r\n          const day = String(d.getDate()).padStart(2, '0');\r\n          return `${y}-${m}-${day}`;\r\n        };\r\n\r\n        const toDateLabel = (ts: number) => {\r\n          const d = new Date(ts);\r\n          const today = new Date();\r\n          const yday = new Date();\r\n          yday.setDate(yday.getDate() - 1);\r\n          const sameDate = (a: Date, b: Date) =>\r\n            a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();\r\n          if (sameDate(d, today)) return 'H√¥m nay';\r\n          if (sameDate(d, yday)) return 'H√¥m qua';\r\n          return d.toLocaleDateString('vi-VN');\r\n        };\r\n\r\n        const map = new Map<string, { dateKey: string; dateLabel: string; items: typeof items }>();\r\n        items.forEach((it) => {\r\n          const key = toDateKey(it.timestamp);\r\n          if (!map.has(key)) map.set(key, { dateKey: key, dateLabel: toDateLabel(it.timestamp), items: [] });\r\n          map.get(key)!.items.push(it);\r\n        });\r\n        const groups = Array.from(map.values());\r\n        groups.sort((a, b) => (a.dateKey < b.dateKey ? 1 : a.dateKey > b.dateKey ? -1 : 0));\r\n        groups.forEach((g) => g.items.sort((a, b) => b.timestamp - a.timestamp));\r\n\r\n        const nextCursor =\r\n          (result.data || []).length > 0 ? Math.min(...(result.data || []).map((m) => m.timestamp)) : null;\r\n\r\n        return NextResponse.json({ success: true, total: result.total || items.length, groups, nextCursor });\r\n      }\r\n\r\n      case 'recall': {\r\n        if (!messageId) return NextResponse.json({ error: 'Missing messageId' }, { status: 400 });\r\n        const result = await updateByField<Message>(collectionName, '_id', messageId, { isRecalled: true });\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'markAsRead': {\r\n        if (!roomId || !userId) {\r\n          return NextResponse.json({ error: 'Missing roomId or userId' }, { status: 400 });\r\n        }\r\n\r\n        const userIdStr = String(userId);\r\n        const variants: (string | number)[] = [\r\n          userIdStr,\r\n          Number.isNaN(Number(userIdStr)) ? undefined : Number(userIdStr),\r\n        ].filter((v): v is string | number => v !== undefined);\r\n\r\n        // 1. Filter: T√¨m c√°c tin nh·∫Øn trong roomId c√≥ userId CH∆ØA ƒë·ªçc\r\n        const filter: Filter<Message> = {\r\n          roomId: String(roomId),\r\n          readBy: { $nin: variants },\r\n        };\r\n\r\n        // 2. Update: Th√™m userId v√†o m·∫£ng readBy c·ªßa c√°c tin nh·∫Øn t√¨m ƒë∆∞·ª£c ($addToSet)\r\n        const updateData = {\r\n          $addToSet: { readBy: userIdStr },\r\n        };\r\n\r\n        const result = await updateMany<Message>(collectionName, filter, updateData);\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'togglePin': {\r\n        // messageId: ID tin nh·∫Øn c·∫ßn ghim/b·ªè ghim\r\n        // isPinned: Tr·∫°ng th√°i m·ªõi (true/false) ƒë∆∞·ª£c g·ª≠i t·ª´ frontend\r\n        if (!messageId || !data || typeof data.isPinned !== 'boolean') {\r\n          return NextResponse.json({ error: 'Missing messageId or invalid data/isPinned status' }, { status: 400 });\r\n        }\r\n\r\n        const newPinnedStatus = data.isPinned;\r\n        const pinnedTitle = data.pinnedTitle;\r\n\r\n        // T√¨m tin nh·∫Øn theo ID v√† c·∫≠p nh·∫≠t tr∆∞·ªùng isPinned\r\n        const updatePayload: Partial<Message> = {\r\n          isPinned: newPinnedStatus,\r\n          pinnedAt: newPinnedStatus ? Date.now() : null,\r\n        };\r\n        if (pinnedTitle !== undefined && pinnedTitle !== null) {\r\n          updatePayload.pinnedTitle = String(pinnedTitle);\r\n        }\r\n\r\n        const result = await updateByField<Message>(\r\n          collectionName,\r\n          '_id', // T√¨m theo ID\r\n          messageId,\r\n          updatePayload,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'getById':\r\n        return NextResponse.json(await getRowByIdOrCode<Message>(collectionName, { _id: requestId, code }));\r\n\r\n      case 'update': {\r\n        if (!field || value === undefined)\r\n          return NextResponse.json({ error: 'Missing field or value' }, { status: 400 });\r\n        const key = String(field) as keyof Message;\r\n        const val: string | number =\r\n          typeof value === 'string' || typeof value === 'number' ? (value as string | number) : String(value);\r\n        const ok = await updateByField<Message>(collectionName, key, val, data as Partial<Message>);\r\n        return NextResponse.json({ success: ok });\r\n      }\r\n\r\n      case 'updateMany': {\r\n        if (!filters || !data) return NextResponse.json({ error: 'Missing filters or data' }, { status: 400 });\r\n        const safeFilters = { ...filters };\r\n        if (safeFilters._id && typeof safeFilters._id === 'string') {\r\n          if (ObjectId.isValid(safeFilters._id)) {\r\n            safeFilters._id = new ObjectId(safeFilters._id);\r\n          } else if (!isNaN(Number(safeFilters._id))) {\r\n            safeFilters._id = Number(safeFilters._id);\r\n          }\r\n        }\r\n        const result = await updateMany<Message>(collectionName, safeFilters, { $set: data });\r\n        return NextResponse.json({\r\n          success: true,\r\n          matchedCount: result.matchedCount,\r\n          modifiedCount: result.modifiedCount,\r\n        });\r\n      }\r\n\r\n      case 'delete': {\r\n        if (!field || value === undefined)\r\n          return NextResponse.json({ error: 'Missing field or value' }, { status: 400 });\r\n        const isIdField = String(field) === '_id';\r\n        let ok = false;\r\n        if (isIdField) {\r\n          ok = await deleteById(collectionName, String(value));\r\n        } else {\r\n          const key = String(field) as keyof Message;\r\n          const val: string | number =\r\n            typeof value === 'string' || typeof value === 'number' ? (value as string | number) : String(value);\r\n          ok = await deleteByField<Message>(collectionName, key, val);\r\n        }\r\n        return NextResponse.json({ success: ok });\r\n      }\r\n\r\n      case 'clearHistory': {\r\n        if (!roomId) {\r\n          return NextResponse.json({ error: 'Missing roomId' }, { status: 400 });\r\n        }\r\n        const result = await deleteManyRows<Message>(collectionName, { roomId: String(roomId) } as Filter<Message>);\r\n        return NextResponse.json({\r\n          success: true,\r\n          deletedCount: (result as unknown as { deletedCount?: number })?.deletedCount ?? undefined,\r\n        });\r\n      }\r\n\r\n      // Thay th·∫ø case 'globalSearch' trong /api/messages/route.ts\r\n\r\n      case 'globalSearch': {\r\n        const searchTerm = data?.searchTerm;\r\n        const searchUserId = data?.userId;\r\n\r\n        if (!searchTerm || !searchUserId) {\r\n          return NextResponse.json({ error: 'Missing userId or searchTerm' }, { status: 400 });\r\n        }\r\n\r\n        // ========== B∆Ø·ªöC 1: L·∫§Y DANH S√ÅCH GROUP M√Ä USER L√Ä TH√ÄNH VI√äN ==========\r\n        const groupRoomIds: string[] = [];\r\n        const groupMap = new Map<string, GroupSummary>();\r\n\r\n        try {\r\n          const allGroupsResult = await getAllRows<GroupConversation>('Groups', {\r\n            filters: {},\r\n            limit: 9999,\r\n          });\r\n\r\n          const getMemberId = (m: MemberInput): string | null => {\r\n            if (!m) return null;\r\n            if (typeof m === 'string') return m;\r\n            if (typeof m === 'object') {\r\n              if ('_id' in m && m._id) return String(m._id);\r\n              if ('id' in m && m.id) return String(m.id);\r\n            }\r\n            return null;\r\n          };\r\n\r\n          const userGroups = (allGroupsResult.data || []).filter((g) => {\r\n            if (g.members && Array.isArray(g.members)) {\r\n              const isMemberInArray = (g.members as MemberInput[]).some((m) => {\r\n                const memberId = getMemberId(m);\r\n                return String(memberId) === String(searchUserId);\r\n              });\r\n              if (isMemberInArray) return true;\r\n            }\r\n            return false;\r\n          });\r\n\r\n          userGroups.forEach((g) => {\r\n            const gId = String(g._id);\r\n            groupRoomIds.push(gId);\r\n\r\n            let membersList: string[] = [];\r\n            if (g.members && Array.isArray(g.members)) {\r\n              membersList = (g.members as MemberInput[]).map((m) => getMemberId(m) || String(m));\r\n            }\r\n\r\n            groupMap.set(gId, {\r\n              _id: gId,\r\n              name: g.name || 'Nh√≥m',\r\n              avatar: g.avatar,\r\n              isGroup: true,\r\n              members: membersList,\r\n            });\r\n          });\r\n        } catch (e) {\r\n          console.error('‚ùå [API] Error fetching groups:', e);\r\n        }\r\n\r\n        // ========== B∆Ø·ªöC 2: T·∫†O REGEX T√åM KI·∫æM ==========\r\n        const termNorm = normalizeNoAccent(String(searchTerm || ''));\r\n\r\n        // ========== B∆Ø·ªöC 3: L·∫§Y DANH S√ÅCH ROOMID CHAT 1-1 ==========\r\n        const oneToOneRoomIds: string[] = [];\r\n        const userMap = new Map<string, User>();\r\n\r\n        try {\r\n          const allUsersResult = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n            filters: {},\r\n            limit: 9999,\r\n          });\r\n\r\n          (allUsersResult.data || []).forEach((u) => {\r\n            userMap.set(String(u._id), u);\r\n          });\r\n\r\n          const otherUsers = allUsersResult.data?.filter((u) => String(u._id) !== String(searchUserId)) || [];\r\n\r\n          otherUsers.forEach((otherUser) => {\r\n            const ids = [searchUserId, String(otherUser._id)].sort();\r\n            const roomId = `${ids[0]}_${ids[1]}`;\r\n            oneToOneRoomIds.push(roomId);\r\n          });\r\n        } catch (e) {\r\n          console.error('‚ùå [API] Error generating 1-1 rooms:', e);\r\n        }\r\n\r\n        const allAccessibleRoomIds = [...groupRoomIds, ...oneToOneRoomIds];\r\n\r\n        // ========== B∆Ø·ªöC 4: T√åM KI·∫æM TIN NH·∫ÆN ==========\r\n        const searchFilters = {\r\n          $and: [\r\n            {\r\n              roomId: { $in: allAccessibleRoomIds },\r\n            },\r\n            { isDeleted: { $ne: true } },\r\n            { isRecalled: { $ne: true } },\r\n            { type: { $ne: 'notify' } },\r\n          ],\r\n        };\r\n\r\n        const searchResults = await getAllRows<Message>(collectionName, {\r\n          filters: searchFilters,\r\n          limit: data.limit || 100,\r\n          sort: { field: 'timestamp', order: 'desc' },\r\n          collation: { locale: 'vi', strength: 1, normalization: true },\r\n        });\r\n\r\n        let foundMessages: Message[] = searchResults.data || [];\r\n        if (termNorm) {\r\n          foundMessages = foundMessages.filter((msg) => {\r\n            const base =\r\n              msg.type === 'file'\r\n                ? String(msg.fileName || '')\r\n                : msg.type === 'sticker'\r\n                  ? ''\r\n                  : String(msg.content || '');\r\n            return normalizeNoAccent(base).includes(termNorm);\r\n          });\r\n        }\r\n\r\n        if (!foundMessages.length) {\r\n          return NextResponse.json({ success: true, data: [], total: 0 });\r\n        }\r\n\r\n        // ========== B∆Ø·ªöC 5: L√ÄM GI√ÄU D·ªÆ LI·ªÜU TIN NH·∫ÆN ==========\r\n        const enrichedMessages = foundMessages.map((msg) => {\r\n          const senderId = String(msg.sender);\r\n          const senderUser = userMap.get(senderId);\r\n          const isMyMessage = senderId === searchUserId;\r\n\r\n          const chatInfo: {\r\n            roomId: string;\r\n            roomName: string;\r\n            roomAvatar: string | null | undefined;\r\n            isGroupChat: boolean;\r\n            partnerId: string | null;\r\n            partnerName: string;\r\n            partnerAvatar: string | null | undefined;\r\n          } = {\r\n            roomId: msg.roomId,\r\n            roomName: 'Cu·ªôc tr√≤ chuy·ªán',\r\n            roomAvatar: null,\r\n            isGroupChat: false,\r\n            partnerId: null,\r\n            partnerName: 'Ng∆∞·ªùi d√πng',\r\n            partnerAvatar: null,\r\n          };\r\n\r\n          // Check GROUP TR∆Ø·ªöC\r\n          const isInGroup = groupMap.has(msg.roomId);\r\n\r\n          if (isInGroup) {\r\n            const group = groupMap.get(msg.roomId);\r\n            chatInfo.isGroupChat = true;\r\n            chatInfo.roomId = msg.roomId;\r\n            chatInfo.roomName = group?.name || 'Nh√≥m';\r\n            chatInfo.roomAvatar = group?.avatar || null;\r\n            chatInfo.partnerId = null;\r\n          } else {\r\n            // Chat 1-1\r\n            chatInfo.isGroupChat = false;\r\n\r\n            let partnerId: string | null = null;\r\n\r\n            // ‚úÖ FIX: C·∫£i thi·ªán logic x√°c ƒë·ªãnh partnerId\r\n            if (msg.roomId && msg.roomId.includes('_')) {\r\n              const parts = msg.roomId.split('_');\r\n              partnerId = parts[0] === searchUserId ? parts[1] : parts[0];\r\n            } else if (isMyMessage && msg.receiver) {\r\n              partnerId = String(msg.receiver);\r\n            } else if (!isMyMessage) {\r\n              partnerId = senderId;\r\n            }\r\n\r\n            if (partnerId) {\r\n              const partnerUser = userMap.get(partnerId);\r\n\r\n              chatInfo.partnerId = partnerId;\r\n              chatInfo.partnerName = partnerUser?.name || 'Ng∆∞·ªùi d√πng';\r\n              chatInfo.partnerAvatar = partnerUser?.avatar || null;\r\n              chatInfo.roomName = chatInfo.partnerName;\r\n              chatInfo.roomAvatar = chatInfo.partnerAvatar;\r\n\r\n              // ‚úÖ CRITICAL: T·∫°o roomId chu·∫©n cho 1-1 chat\r\n              const ids = [searchUserId, partnerId].sort();\r\n              chatInfo.roomId = `${ids[0]}_${ids[1]}`;\r\n            }\r\n          }\r\n\r\n          // Format content preview\r\n          let contentPreview = '';\r\n          if (msg.type === 'file' && msg.fileName) {\r\n            contentPreview = `üìé ${msg.fileName}`;\r\n          } else if (msg.type === 'image') {\r\n            contentPreview = 'üñºÔ∏è H√¨nh ·∫£nh';\r\n          } else if (msg.type === 'sticker') {\r\n            contentPreview = 'üòä Sticker';\r\n          } else if (msg.type === 'video') {\r\n            contentPreview = 'üé• Video';\r\n          } else {\r\n            contentPreview = msg.content || 'Tin nh·∫Øn';\r\n          }\r\n\r\n          const displaySenderName = isMyMessage ? 'B·∫°n' : senderUser?.name || `User ${senderId.slice(0, 8)}`;\r\n          const displayRoomName = chatInfo.isGroupChat ? chatInfo.roomName : chatInfo.partnerName;\r\n\r\n          return {\r\n            _id: String(msg._id),\r\n            type: msg.type,\r\n            content: msg.content,\r\n            fileName: msg.fileName,\r\n            fileUrl: msg.fileUrl,\r\n            timestamp: msg.timestamp,\r\n\r\n            sender: senderId,\r\n            senderName: displaySenderName,\r\n            senderAvatar: senderUser?.avatar || null,\r\n            isMyMessage,\r\n\r\n            receiver: msg.receiver ? String(msg.receiver) : null,\r\n\r\n            ...chatInfo,\r\n\r\n            displaySenderName,\r\n            displayRoomName,\r\n            contentPreview,\r\n\r\n            replyToMessageId: msg.replyToMessageId,\r\n            replyToMessageName: msg.replyToMessageName,\r\n          };\r\n        });\r\n\r\n        // ========== B∆Ø·ªöC 6: PH√ÇN LO·∫†I K·∫æT QU·∫¢ ==========\r\n        const messagesByType = {\r\n          text: enrichedMessages.filter((m) => m.type === 'text'),\r\n          file: enrichedMessages.filter((m) => m.type === 'file'),\r\n          image: enrichedMessages.filter((m) => m.type === 'image'),\r\n          video: enrichedMessages.filter((m) => m.type === 'video'),\r\n          sticker: enrichedMessages.filter((m) => m.type === 'sticker'),\r\n          reminder: enrichedMessages.filter((m) => m.type === 'reminder'),\r\n          all: enrichedMessages,\r\n        };\r\n\r\n        const messagesBySource = {\r\n          group: enrichedMessages.filter((m) => m.isGroupChat),\r\n          oneToOne: enrichedMessages.filter((m) => !m.isGroupChat),\r\n          all: enrichedMessages,\r\n        };\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          data: enrichedMessages,\r\n          total: searchResults.total || enrichedMessages.length,\r\n          metadata: {\r\n            searchTerm,\r\n            totalResults: enrichedMessages.length,\r\n            byType: {\r\n              text: messagesByType.text.length,\r\n              file: messagesByType.file.length,\r\n              image: messagesByType.image.length,\r\n              video: messagesByType.video.length,\r\n              sticker: messagesByType.sticker.length,\r\n              reminder: messagesByType.reminder.length,\r\n            },\r\n            bySource: {\r\n              group: messagesBySource.group.length,\r\n              oneToOne: messagesBySource.oneToOne.length,\r\n            },\r\n          },\r\n        });\r\n      }\r\n\r\n      case 'readReminders': {\r\n        const searchUserId = data?.userId;\r\n        const untilTs = typeof data?.untilTs === 'number' ? data.untilTs : undefined;\r\n        const fromTs = typeof data?.fromTs === 'number' ? data.fromTs : undefined;\r\n\r\n        if (!searchUserId) {\r\n          return NextResponse.json({ error: 'Missing userId' }, { status: 400 });\r\n        }\r\n\r\n        const groupRoomIds: string[] = [];\r\n        try {\r\n          const allGroupsResult = await getAllRows<GroupConversation>('Groups', {\r\n            filters: {},\r\n            limit: 9999,\r\n          });\r\n\r\n          const getMemberId = (m: MemberInput): string | null => {\r\n            if (!m) return null;\r\n            if (typeof m === 'string') return m;\r\n            if (typeof m === 'object') {\r\n              if ('_id' in m && m._id) return String(m._id);\r\n              if ('id' in m && m.id) return String(m.id);\r\n            }\r\n            return null;\r\n          };\r\n\r\n          const userGroups = (allGroupsResult.data || []).filter((g) => {\r\n            if (g.members && Array.isArray(g.members)) {\r\n              return (g.members as MemberInput[]).some((m) => String(getMemberId(m)) === String(searchUserId));\r\n            }\r\n            return false;\r\n          });\r\n\r\n          userGroups.forEach((g) => groupRoomIds.push(String(g._id)));\r\n        } catch (error) {\r\n          console.error('messages.searchReminders:getGroups', error);\r\n        }\r\n\r\n        const oneToOneRoomIds: string[] = [];\r\n        try {\r\n          const allUsersResult = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n            filters: {},\r\n            limit: 9999,\r\n          });\r\n          const otherUsers = (allUsersResult.data || []).filter((u) => String(u._id) !== String(searchUserId));\r\n          otherUsers.forEach((otherUser) => {\r\n            const ids = [searchUserId, String(otherUser._id)].sort();\r\n            const roomId = `${ids[0]}_${ids[1]}`;\r\n            oneToOneRoomIds.push(roomId);\r\n          });\r\n        } catch (error) {\r\n          console.error('messages.searchReminders:getUsers', error);\r\n        }\r\n\r\n        const allAccessibleRoomIds = [...groupRoomIds, ...oneToOneRoomIds];\r\n\r\n        const reminderFilters: MongoFilters = {\r\n          type: 'reminder',\r\n          isDeleted: { $ne: true },\r\n          isRecalled: { $ne: true },\r\n          reminderFired: { $ne: true },\r\n          $or: [{ roomId: { $in: allAccessibleRoomIds } }, { sender: String(searchUserId) }],\r\n        };\r\n        if (typeof fromTs === 'number' || typeof untilTs === 'number') {\r\n          (reminderFilters as MongoFilters).reminderAt = {\r\n            ...(typeof fromTs === 'number' ? { $gte: fromTs } : {}),\r\n            ...(typeof untilTs === 'number' ? { $lte: untilTs } : {}),\r\n          };\r\n        }\r\n\r\n        const searchResults = await getAllRows<Message>(collectionName, {\r\n          filters: reminderFilters,\r\n          limit: data?.limit || 5000,\r\n          sort: { field: 'reminderAt', order: 'asc' },\r\n        });\r\n\r\n        return NextResponse.json({ success: true, data: searchResults.data || [], total: searchResults.total || 0 });\r\n      }\r\n\r\n      case 'fireReminder': {\r\n        if (!messageId || !userId) {\r\n          return NextResponse.json({ error: 'Missing messageId or userId' }, { status: 400 });\r\n        }\r\n\r\n        const rowRes = await getRowByIdOrCode<Message>(collectionName, { _id: messageId });\r\n        const row = (rowRes?.row ?? null) as Message | null;\r\n\r\n        if (!row || row.type !== 'reminder') {\r\n          return NextResponse.json({ success: false, updated: false });\r\n        }\r\n\r\n        const latestAt = row.reminderAt || row.timestamp || Date.now();\r\n\r\n        // üî• Prevent firing if the reminder is in the future (with 1 min buffer)\r\n        if (latestAt > Date.now() + 60 * 1000) {\r\n          return NextResponse.json({ success: true, updated: false, message: 'Reminder is in the future' });\r\n        }\r\n\r\n        const repeat = row.reminderRepeat || 'none';\r\n\r\n        // T√≠nh nextAt cho recurring reminder\r\n        let nextAt: number | null = null;\r\n        if (repeat === 'daily') nextAt = latestAt + 24 * 60 * 60 * 1000;\r\n        else if (repeat === 'weekly') nextAt = latestAt + 7 * 24 * 60 * 60 * 1000;\r\n        else if (repeat === 'monthly') {\r\n          const d = new Date(latestAt);\r\n          d.setMonth(d.getMonth() + 1);\r\n          nextAt = d.getTime();\r\n        }\r\n\r\n        // Update message\r\n        const updateData = nextAt\r\n          ? { reminderAt: nextAt, reminderFired: false, editedAt: Date.now() }\r\n          : { reminderFired: true };\r\n\r\n        const filter: Filter<Message> = {\r\n          _id: ObjectId.isValid(String(messageId)) ? new ObjectId(String(messageId)) : String(messageId),\r\n          type: 'reminder' as const, // ‚úÖ Th√™m 'as const'\r\n          reminderFired: { $ne: true },\r\n          reminderAt: latestAt,\r\n        } as Filter<Message>; // ‚úÖ Th√™m type assertion\r\n\r\n        const upd = await updateMany<Message>(collectionName, filter, { $set: updateData });\r\n        const modified = upd?.modifiedCount ?? 0;\r\n\r\n        if (!modified) {\r\n          return NextResponse.json({ success: true, updated: false });\r\n        }\r\n\r\n        // ‚úÖ T·∫†O TH√îNG B√ÅO\r\n        const timeStr = new Date(latestAt).toLocaleString('vi-VN');\r\n        const notifyContent = `ƒê·∫øn gi·ªù l·ªãch h·∫πn: \"${String(row.content || '')}\" l√∫c ${timeStr}`;\r\n\r\n        const notifyId = await addRow<Partial<Message>>(collectionName, {\r\n          roomId: String(row.roomId),\r\n          sender: String(userId),\r\n          type: 'notify',\r\n          content: notifyContent,\r\n          timestamp: Date.now(),\r\n          replyToMessageId: String(row._id),\r\n        });\r\n\r\n        // ‚úÖ EMIT SOCKET - CH·ªà 1 L·∫¶N DUY NH·∫§T\r\n        try {\r\n          const io = getSocketInstance(); // C·∫ßn implement h√†m n√†y\r\n\r\n          const roomId = String(row.roomId);\r\n\r\n          // Emit th√¥ng b√°o\r\n          io.in(roomId).emit('receive_message', {\r\n            _id: notifyId,\r\n            roomId: roomId,\r\n            sender: String(userId),\r\n            type: 'notify',\r\n            content: notifyContent,\r\n            timestamp: Date.now(),\r\n            replyToMessageId: String(row._id),\r\n          });\r\n\r\n          // N·∫øu c√≥ nextAt, emit update reminder\r\n          if (nextAt) {\r\n            io.in(roomId).emit('edit_message', {\r\n              _id: String(row._id),\r\n              roomId: roomId,\r\n              reminderAt: nextAt,\r\n              editedAt: Date.now(),\r\n            });\r\n          }\r\n        } catch (err) {\r\n          console.error('‚ùå Socket emit error:', err);\r\n        }\r\n\r\n        // Push notification\r\n        Promise.resolve()\r\n          .then(() =>\r\n            sendPushOnMessage({\r\n              roomId: String(row.roomId),\r\n              senderId: String(userId),\r\n              content: notifyContent,\r\n            }),\r\n          )\r\n          .catch((error) => {\r\n            console.error('messages.fireReminder:push', error);\r\n          });\r\n\r\n        return NextResponse.json({ success: true, updated: true, notifyId, nextAt });\r\n      }\r\n\r\n      case 'editMessage': {\r\n        const { messageId, newContent } = data;\r\n\r\n        // 1. üî• L·∫§Y TIN NH·∫ÆN HI·ªÜN T·∫†I ƒê·ªÇ L∆ØU N·ªòI DUNG G·ªêC\r\n        const existingMsg = await getRowByIdOrCode<Message>(collectionName, { _id: messageId });\r\n\r\n        // 2. X√°c ƒë·ªãnh n·ªôi dung g·ªëc (n·∫øu originalContent ch∆∞a t·ªìn t·∫°i)\r\n        const originalContentToSave = existingMsg?.row.originalContent || existingMsg?.row.content;\r\n\r\n        if (!messageId || !newContent || typeof newContent !== 'string' || !existingMsg) {\r\n          return NextResponse.json({ error: 'Invalid data or message not found' }, { status: 400 });\r\n        }\r\n\r\n        // 3. C·∫≠p nh·∫≠t data\r\n        const updateData = {\r\n          content: newContent,\r\n          editedAt: Date.now(),\r\n          originalContent: originalContentToSave,\r\n        };\r\n\r\n        const result = await updateByField<Message>(collectionName, '_id', messageId, updateData);\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n      default:\r\n        return NextResponse.json({ error: 'Invalid action' }, { status: 400 });\r\n    }\r\n  } catch (error) {\r\n    console.error('MongoDB API Error:', error);\r\n    return NextResponse.json({ error: 'Server error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}