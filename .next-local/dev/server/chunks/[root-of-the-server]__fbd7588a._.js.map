{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/components/%28mongodb%29/connectToDatabase.tsx"],"sourcesContent":["// app\\lib\\monggodb\\connectToDatabase.tsx\r\n\r\nimport { MongoClient, Db } from 'mongodb';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/';\r\nconst MONGODB_DB = process.env.MONGODB_DB || 'hupuna-price';\r\n\r\n// Cache client khi hot-reload (Next.js dev mode)\r\nlet cachedClient: MongoClient | null = null;\r\nlet cachedDb: Db | null = null;\r\n\r\nexport async function connectToDatabase(): Promise<{ client: MongoClient; db: Db }> {\r\n  if (cachedClient && cachedDb) {\r\n    return { client: cachedClient, db: cachedDb };\r\n  }\r\n\r\n  if (process.env.NODE_ENV === 'production' && (MONGODB_URI.includes('localhost') || MONGODB_URI.includes('127.0.0.1'))) {\r\n    console.error('‚ùå ERROR: You are using a localhost MongoDB URI in production. Please set MONGODB_URI in your Vercel project settings to a remote database (e.g., MongoDB Atlas).');\r\n  }\r\n\r\n  const client = new MongoClient(MONGODB_URI);\r\n  await client.connect();\r\n\r\n  const db = client.db(MONGODB_DB);\r\n\r\n  cachedClient = client;\r\n  cachedDb = db;\r\n\r\n  return { client, db };\r\n}\r\n"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AAEzC;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAC/C,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,iDAAiD;AACjD,IAAI,eAAmC;AACvC,IAAI,WAAsB;AAEnB,eAAe;IACpB,IAAI,gBAAgB,UAAU;QAC5B,OAAO;YAAE,QAAQ;YAAc,IAAI;QAAS;IAC9C;IAEA,IAAI,oDAAyB,gBAAgB,CAAC,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,YAAY;;IAIpH,MAAM,SAAS,IAAI,sHAAW,CAAC;IAC/B,MAAM,OAAO,OAAO;IAEpB,MAAM,KAAK,OAAO,EAAE,CAAC;IAErB,eAAe;IACf,WAAW;IAEX,OAAO;QAAE;QAAQ;IAAG;AACtB"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/mongoDBCRUD.ts"],"sourcesContent":["// app\\lib\\monggodb\\mongoDBCRUD.ts\r\n\r\nimport { Collection, Filter, ObjectId, OptionalUnlessRequiredId, UpdateFilter, type CollationOptions } from 'mongodb';\r\nimport { connectToDatabase } from '../components/(mongodb)/connectToDatabase';\r\n\r\n// ========== Helper ====================\r\nexport function safeParse(value: unknown): unknown {\r\n  if (typeof value !== 'string') return value;\r\n  const firstChar = value.trim().charAt(0);\r\n  if (firstChar !== '[' && firstChar !== '{') return value;\r\n  try {\r\n    return JSON.parse(value);\r\n  } catch {\r\n    return value;\r\n  }\r\n}\r\n\r\n// ========== READ HEADERS (Mongo ko c√≥ headers n√™n tr·∫£ key t·ª´ document) ==========\r\nexport const getHeaders = async (collectionName: string): Promise<string[]> => {\r\n  const { db } = await connectToDatabase();\r\n  const doc = await db.collection(collectionName).findOne({});\r\n  return doc ? Object.keys(doc) : [];\r\n};\r\n\r\n// ========== FIND BY FIELD ==========\r\nexport const findByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<{ data: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const item = await db\r\n    .collection(collectionName)\r\n    .find({ [field]: value })\r\n    .toArray();\r\n  if (!item) return null;\r\n\r\n  return { data: item as unknown as T };\r\n};\r\n\r\n// ========== GET BY ID OR CODE ==========\r\nexport const getRowByIdOrCode = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  { id, code, _id }: { id?: string | number; code?: string; _id?: string },\r\n): Promise<{ rowIndex: number; row: T } | null> => {\r\n  const { db } = await connectToDatabase();\r\n  const filter: Record<string, unknown> = {};\r\n\r\n  if (_id) {\r\n    if (ObjectId.isValid(_id)) {\r\n      filter['_id'] = new ObjectId(_id);\r\n    } else if (!isNaN(Number(_id))) {\r\n      filter['_id'] = Number(_id);\r\n    }\r\n\r\n  }\r\n\r\n  if (id) filter['id'] = id;\r\n  if (code) filter['code'] = code;\r\n\r\n  const row = await db.collection(collectionName).findOne(filter);\r\n  return row ? { rowIndex: 0, row: row as unknown as T } : null;\r\n};\r\n\r\n// ========== GET ALL (search, filter, sort, pagination) ==========\r\nexport const getAllRows = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  {\r\n    search,\r\n    skip = 0,\r\n    limit,\r\n    field,\r\n    value,\r\n    filters,\r\n    sort,\r\n    collation,\r\n  }: {\r\n    search?: string;\r\n    skip?: number;\r\n    limit?: number;\r\n    field?: keyof T;\r\n    value?: unknown;\r\n    filters?: Record<string, unknown>;\r\n    sort?: { field: keyof T; order?: 'asc' | 'desc' } | Array<{ field: keyof T; order?: 'asc' | 'desc' }>;\r\n    collation?: CollationOptions;\r\n  } = {},\r\n): Promise<{ total: number; data: T[] }> => {\r\n  const { db } = await connectToDatabase();\r\n  const collection = db.collection(collectionName);\r\n\r\n  const query: Record<string, unknown> = {};\r\n\r\n  // Filter field=value\r\n  if (field && value !== undefined) {\r\n    query[field as string] = value;\r\n  }\r\n\r\n  // ====== 2. Filter n√¢ng cao ======\r\n  if (filters && Object.keys(filters).length > 0) {\r\n    for (const [key, rawVal] of Object.entries(filters)) {\r\n      if (rawVal === undefined || rawVal === null) continue;\r\n\r\n      // --- N·∫øu l√† m·ªánh ƒë·ªÅ $or ho·∫∑c $and ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán k·∫øt h·ª£p\r\n      if (key === '$or' || key === '$and') {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† object c√≥ $gte / $lte (l·ªçc kho·∫£ng th·ªùi gian ho·∫∑c kho·∫£ng s·ªë) ---\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        ('$gte' in (rawVal as Record<string, unknown>) || '$lte' in (rawVal as Record<string, unknown>))\r\n      ) {\r\n        (query as Record<string, unknown>)[key] = rawVal;\r\n        continue;\r\n      }\r\n      // --- N·∫øu l√† object c√≥ to√°n t·ª≠ MongoDB ---\r\n      // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm c√≥ ƒëi·ªÅu ki·ªán\r\n      // $in ‚Äì ch·ª©a trong danh s√°ch gi√° tr·ªã (gi·ªëng WHERE field IN (...))\r\n      // $nin ‚Äì kh√¥ng ch·ª©a trong danh s√°ch gi√° tr·ªã\r\n      // $gte ‚Äì l·ªõn h∆°n ho·∫∑c b·∫±ng (>=)\r\n      // $lte ‚Äì nh·ªè h∆°n ho·∫∑c b·∫±ng (<=)\r\n      // $gt ‚Äì l·ªõn h∆°n (>)\r\n      // $lt ‚Äì nh·ªè h∆°n (<)\r\n      // $ne ‚Äì kh√°c (!=)\r\n      if (\r\n        typeof rawVal === 'object' &&\r\n        rawVal !== null &&\r\n        Object.keys(rawVal as Record<string, unknown>).some((k) =>\r\n          ['$in', '$nin', '$gte', '$lte', '$gt', '$lt', '$ne'].includes(k),\r\n        )\r\n      ) {\r\n        query[key] = rawVal;\r\n        continue;\r\n      }\r\n\r\n      // --- N·∫øu l√† chu·ªói b·∫Øt ƒë·∫ßu b·∫±ng \"#\" => regex ---\r\n      if (typeof rawVal === 'string' && rawVal.trim().startsWith('#')) {\r\n        // Tr∆∞·ªùng h·ª£p t√¨m ki·∫øm g·∫ßn ƒë√∫ng (regex)\r\n        query[key] = {\r\n          $regex: rawVal.trim().slice(1),\r\n          $options: 'i',\r\n        };\r\n        continue;\r\n      }\r\n\r\n      // Tr∆∞·ªùng h·ª£p so s√°nh ch√≠nh x√°c (exact match)\r\n      query[key] = rawVal;\r\n    }\r\n  }\r\n\r\n  // Search to√†n b·ªô text - c√°ch c≈© - ch·ªâ l·∫•y key 1 c·∫•p\r\n  // if (search) {\r\n  //     const sampleDoc = await collection.findOne();\r\n  //     if (sampleDoc) {\r\n  //         const textFields = Object.keys(sampleDoc).filter(\r\n  //             (k) => typeof sampleDoc[k] === \"string\"\r\n  //         );\r\n\r\n  //         if (textFields.length > 0) {\r\n  //             query[\"$or\"] = textFields.map((key) => ({\r\n  //                 [key]: { $regex: search, $options: \"i\" },\r\n  //             }));\r\n  //         }\r\n  //     }\r\n  // }\r\n\r\n  // Search to√†n b·ªô text - c·∫£i ti·∫øn ƒë·ªÉ l·∫•y c·∫£ c√°c key trong object con - nhi·ªÅu c·∫•p\r\n  if (search) {\r\n    const sampleDoc = await collection.findOne();\r\n    if (sampleDoc) {\r\n      // üëâ H√†m ƒë·ªá quy l·∫•y t·∫•t c·∫£ key string (k·ªÉ c·∫£ nested)\r\n      const getStringPaths = (obj: unknown, prefix = ''): string[] => {\r\n        let keys: string[] = [];\r\n        for (const [k, v] of Object.entries(obj as Record<string, unknown>)) {\r\n          const path = prefix ? `${prefix}.${k}` : k;\r\n          if (typeof v === 'string') keys.push(path);\r\n          else if (v && typeof v === 'object' && !Array.isArray(v)) keys = keys.concat(getStringPaths(v, path));\r\n        }\r\n        return keys;\r\n      };\r\n\r\n      const textFields = getStringPaths(sampleDoc);\r\n\r\n      if (textFields.length > 0) {\r\n        query['$or'] = textFields.map((path) => ({\r\n          [path]: { $regex: search, $options: 'i' },\r\n        }));\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sort\r\n  let sortOption: Record<string, 1 | -1> = {};\r\n  if (sort) {\r\n    const sortArr = Array.isArray(sort) ? sort : [sort];\r\n    sortOption = sortArr.reduce(\r\n      (acc, s) => {\r\n        acc[s.field as string] = s.order === 'desc' ? -1 : 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, 1 | -1>,\r\n    );\r\n  }\r\n\r\n  const total = await collection.countDocuments(query, collation ? { collation } : undefined);\r\n\r\n  let cursor = collection.find(query);\r\n  if (collation) {\r\n    cursor = cursor.collation(collation);\r\n  }\r\n  const data = await cursor.sort(sortOption).skip(skip).limit(limit ?? 0).toArray();\r\n\r\n  return { total, data: data as unknown as T[] };\r\n};\r\n\r\n// ========== CREATE ==========\r\nexport const addRow = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  newData: T,\r\n): Promise<string> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).insertOne(newData);\r\n  return result.insertedId.toString();\r\n};\r\nexport async function getCollection<T extends Record<string, unknown>>(name: string): Promise<Collection<T>> {\r\n  const { db } = await connectToDatabase();\r\n  return db.collection<T>(name);\r\n}\r\n// CREATE MANY\r\nexport async function createMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  docs: OptionalUnlessRequiredId<T>[],\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.insertMany(docs);\r\n}\r\n\r\n\r\n// UPDATE BY FIELD\r\nexport const updateByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n  updateData: Partial<T>,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  if ('_id' in updateData) delete updateData._id;\r\n\r\n  let queryValue: string | number | ObjectId = value;\r\n\r\n  if (field === '_id' && typeof value === 'string') {\r\n    if (ObjectId.isValid(value)) {\r\n      // N·∫øu l√† ObjectId h·ª£p l·ªá\r\n      queryValue = new ObjectId(value);\r\n    } else if (!isNaN(Number(value))) {\r\n      // N·∫øu l√† s·ªë\r\n      queryValue = Number(value);\r\n    }\r\n    // N·∫øu l√† string kh√¥ng ph·∫£i ObjectId v√† kh√¥ng ph·∫£i s·ªë, queryValue v·∫´n l√† string\r\n  }\r\n  const result = await db.collection(collectionName).updateOne({ [field]: queryValue }, { $set: updateData });\r\n\r\n  return result.modifiedCount > 0;\r\n};\r\n\r\n// UPDATE MANY\r\nexport async function updateMany<T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  filter: Filter<T>, // ch√≠nh l√† Filter<T>, kh√¥ng ph·∫£i Filter<Document>\r\n  update: UpdateFilter<T> | Partial<T>,\r\n) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  const isOperatorUpdate =\r\n    typeof update === 'object' &&\r\n    update !== null &&\r\n    Object.keys(update as Record<string, unknown>).some((key) => key.startsWith('$'));\r\n\r\n  const updateDoc: UpdateFilter<T> = isOperatorUpdate\r\n    ? (update as UpdateFilter<T>) // n·∫øu ƒë√£ c√≥ $set, $inc,... th√¨ gi·ªØ nguy√™n\r\n    : ({ $set: update as Partial<T> } as UpdateFilter<T>);\r\n\r\n  return collection.updateMany(filter, updateDoc);\r\n}\r\n\r\n// ========== DELETE BY FIELD ==========\r\nexport const deleteByField = async <T extends Record<string, unknown>>(\r\n  collectionName: string,\r\n  field: keyof T,\r\n  value: string | number,\r\n): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ [field]: value });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// ========== DELETE BY ID ==========\r\nexport const deleteById = async (collectionName: string, id: string): Promise<boolean> => {\r\n  const { db } = await connectToDatabase();\r\n  const result = await db.collection(collectionName).deleteOne({ _id: new ObjectId(id) });\r\n  return result.deletedCount > 0;\r\n};\r\n\r\n// DELETE MANY\r\nexport async function deleteManyRows<T extends Record<string, unknown>>(collectionName: string, filter: Filter<T>) {\r\n  const collection = await getCollection<T>(collectionName);\r\n  return collection.deleteMany(filter);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 347, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/Group.ts"],"sourcesContent":["import { User } from './User';\r\n\r\nexport const GROUP_COLLECTION_NAME = 'Groups';\r\n\r\nexport type GroupRole = 'OWNER' | 'ADMIN' | 'MEMBER';\r\n\r\nexport interface GroupMemberSchema {\r\n  _id: string; // User ID\r\n  role: GroupRole;\r\n  joinedAt: number;\r\n  nickname?: string; // ‚úÖ Nickname in group\r\n  addedBy?: string; // ‚úÖ Who added this member\r\n}\r\n\r\nexport interface MemberInfo extends GroupMemberSchema {\r\n  name: string;\r\n  avatar?: string;\r\n  id?: string;\r\n}\r\n\r\nexport interface GroupConversation {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  name: string;\r\n  isGroup: boolean;\r\n  members: GroupMemberSchema[] | MemberInfo[];\r\n\r\n  createdBy: string;\r\n  unreadCount?: number;\r\n  lastMessage?: string;\r\n  lastMessageAt?: number;\r\n  avatar?: string;\r\n  createdAt?: string;\r\n  isRecall?: boolean;\r\n\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n  isPinnedBy?: Record<string, boolean>;\r\n  isHiddenBy?: Record<string, boolean>;\r\n\r\n  inviteCode?: string; // ‚úÖ TH√äM\r\n  description?: string; // ‚úÖ TH√äM (optional)\r\n  categoriesBy?: Record<string, string[]>;\r\n  tagsBy?: Record<string, string[]>;\r\n}\r\n\r\nexport interface GroupConversationCreate {\r\n  [key: string]: unknown;\r\n  name: string;\r\n  isGroup: boolean;\r\n\r\n  // Khi t·∫°o, ta l∆∞u m·∫£ng object c√≥ role\r\n  members: GroupMemberSchema[];\r\n  createdBy: string;\r\n  createdAt?: number;\r\n}\r\n\r\nexport type ChatItem = User | GroupConversation;\r\n"],"names":[],"mappings":";;;;AAEO,MAAM,wBAAwB"}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/User.ts"],"sourcesContent":["export const USERS_COLLECTION_NAME = 'Users';\r\n\r\nexport interface User {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  name: string;\r\n  username: string;\r\n  password?: string;\r\n  unreadCount?: number;\r\n  lastMessage?: string;\r\n  lastMessageAt?: number;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n  online?: boolean;\r\n  lastSeen?: number | null;\r\n  // C√°c field tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c t√≠nh s·∫µn t·ª´ server (ti·ªán cho FE s·ª≠ d·ª•ng)\r\n  isPinned?: boolean;\r\n  isHidden?: boolean;\r\n  isPinnedBy?: Record<string, boolean>;\r\n  isHiddenBy?: Record<string, boolean>;\r\n  isRecall?: boolean;\r\n  onesignalSubs?: string[];\r\n  nicknames?: Record<string, string>;\r\n  categoryTags?: { id: string; label: string; color: string }[];\r\n  userTags?: { id: string; label: string; color: string }[];\r\n  categoriesBy?: Record<string, string[]>;\r\n  tagsBy?: Record<string, string[]>;\r\n}\r\nexport interface UserCreate {\r\n  [key: string]: unknown;\r\n  name: string;\r\n  username: string;\r\n  password: string;\r\n\r\n  avatar?: string;\r\n  role?: string;\r\n  department?: string;\r\n  status?: string;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,wBAAwB"}},
    {"offset": {"line": 365, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/types/Message.ts"],"sourcesContent":["import { User } from '@/types/User';\r\n\r\nexport const MESSAGES_COLLECTION_NAME = 'Messages';\r\n\r\nexport type MessageType = 'text' | 'image' | 'file' | 'notify' | 'sticker' | 'video' | 'reminder' | 'poll' | 'contact';\r\n\r\nexport interface Message {\r\n  [key: string]: unknown;\r\n  _id: string;\r\n  roomId: string;\r\n  sender: string | User;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  pinnedAt?: number | null;\r\n  readBy?: (string | number)[];\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  mentions?: string[];\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\nexport interface MessageCreate {\r\n  [key: string]: unknown;\r\n  roomId: string;\r\n  sender: string;\r\n  batchId?: string;\r\n  content?: string;\r\n  fileUrl?: string;\r\n  fileName?: string;\r\n  previewUrl?: string;\r\n  videoCropConfig?: {\r\n    crop: { x: number; y: number };\r\n    zoom: number;\r\n    rotation: number;\r\n    croppedAreaPixels: { x: number; y: number; width: number; height: number } | null;\r\n    baseWidth?: number;\r\n    baseHeight?: number;\r\n  } | null;\r\n  type: MessageType;\r\n  timestamp: number;\r\n  serverTimestamp?: number;\r\n  isRecalled?: boolean;\r\n  replyToMessageId?: string;\r\n  replyToMessageName?: string;\r\n  isPinned?: boolean;\r\n  pinnedTitle?: string;\r\n  originalContent?: string;\r\n  editedAt?: number;\r\n  reminderAt?: number;\r\n  reminderNote?: string;\r\n  reminderFired?: boolean;\r\n  reminderRepeat?: 'none' | 'daily' | 'weekly' | 'monthly';\r\n  pollQuestion?: string;\r\n  pollOptions?: string[];\r\n  pollVotes?: Record<string, string[]>;\r\n  isPollLocked?: boolean;\r\n  pollLockedAt?: number;\r\n  pollAllowMultiple?: boolean;\r\n  pollAllowAddOptions?: boolean;\r\n  pollHideVoters?: boolean;\r\n  pollHideResultsUntilVote?: boolean;\r\n  pollEndAt?: number | null;\r\n  sharedFrom?: {\r\n    messageId: string;\r\n    originalSender: string;\r\n    originalRoomId: string;\r\n  };\r\n  callerId?: string;\r\n  calleeId?: string;\r\n  callType?: 'voice' | 'video';\r\n  callStatus?: 'answered' | 'rejected' | 'timeout';\r\n  callDurationSec?: number;\r\n  callStartedAt?: number;\r\n  callEndedAt?: number;\r\n  contactCard?: {\r\n    _id: string;\r\n    name: string;\r\n    username?: string;\r\n    avatar?: string;\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEO,MAAM,2BAA2B"}},
    {"offset": {"line": 374, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/lib/chatUpdateFields.ts"],"sourcesContent":["export interface ToggleChatStatusPayload {\r\n  isPinned?: boolean\r\n  isHidden?: boolean\r\n}\r\n\r\nexport function buildToggleChatStatusFields(\r\n  currentUserId: string,\r\n  payload: ToggleChatStatusPayload,\r\n): Record<string, boolean> | null {\r\n  const fields: Record<string, boolean> = {}\r\n  if (typeof payload.isPinned === 'boolean') {\r\n    fields[`isPinnedBy.${currentUserId}`] = payload.isPinned\r\n  }\r\n  if (typeof payload.isHidden === 'boolean') {\r\n    fields[`isHiddenBy.${currentUserId}`] = payload.isHidden\r\n  }\r\n  if (Object.keys(fields).length === 0) return null\r\n  return fields\r\n}\r\n\r\nexport function normalizeStringArray(input: unknown): string[] {\r\n  if (!Array.isArray(input)) return []\r\n  return (input as unknown[]).filter((x): x is string => typeof x === 'string')\r\n}\r\n\r\nexport function buildUpdateCategoriesFields(currentUserId: string, categories: unknown): Record<string, string[]> {\r\n  const arr = normalizeStringArray(categories)\r\n  return { [`categoriesBy.${currentUserId}`]: arr }\r\n}\r\n\r\nexport function buildUpdateTagsFields(currentUserId: string, tags: unknown): Record<string, string[]> {\r\n  const arr = normalizeStringArray(tags)\r\n  return { [`tagsBy.${currentUserId}`]: arr }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;;;;;AAKO,SAAS,4BACd,aAAqB,EACrB,OAAgC;IAEhC,MAAM,SAAkC,CAAC;IACzC,IAAI,OAAO,QAAQ,QAAQ,KAAK,WAAW;QACzC,MAAM,CAAC,CAAC,WAAW,EAAE,eAAe,CAAC,GAAG,QAAQ,QAAQ;IAC1D;IACA,IAAI,OAAO,QAAQ,QAAQ,KAAK,WAAW;QACzC,MAAM,CAAC,CAAC,WAAW,EAAE,eAAe,CAAC,GAAG,QAAQ,QAAQ;IAC1D;IACA,IAAI,OAAO,IAAI,CAAC,QAAQ,MAAM,KAAK,GAAG,OAAO;IAC7C,OAAO;AACT;AAEO,SAAS,qBAAqB,KAAc;IACjD,IAAI,CAAC,MAAM,OAAO,CAAC,QAAQ,OAAO,EAAE;IACpC,OAAO,AAAC,MAAoB,MAAM,CAAC,CAAC,IAAmB,OAAO,MAAM;AACtE;AAEO,SAAS,4BAA4B,aAAqB,EAAE,UAAmB;IACpF,MAAM,MAAM,qBAAqB;IACjC,OAAO;QAAE,CAAC,CAAC,aAAa,EAAE,eAAe,CAAC,EAAE;IAAI;AAClD;AAEO,SAAS,sBAAsB,aAAqB,EAAE,IAAa;IACxE,MAAM,MAAM,qBAAqB;IACjC,OAAO;QAAE,CAAC,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE;IAAI;AAC5C"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/app/api/groups/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { addRow, getAllRows, getCollection } from '@/lib/mongoDBCRUD';\r\nimport { GROUP_COLLECTION_NAME, GroupConversation, GroupConversationCreate, GroupMemberSchema } from '@/types/Group';\r\nimport { ObjectId, Filter, UpdateFilter } from 'mongodb';\r\nimport { User, USERS_COLLECTION_NAME } from '@/types/User';\r\nimport { Message, MESSAGES_COLLECTION_NAME } from '@/types/Message';\r\nimport { MemberInfo, GroupRole } from '@/types/Group';\r\nimport {\r\n  buildToggleChatStatusFields,\r\n  buildUpdateCategoriesFields,\r\n  buildUpdateTagsFields,\r\n} from '@/lib/chatUpdateFields';\r\n\r\ntype MemberInput =\r\n  | string\r\n  | GroupMemberSchema\r\n  | MemberInfo\r\n  | { id?: string; _id?: string; role?: GroupRole; name?: string; avatar?: string };\r\n\r\ninterface GroupApiRequestBody {\r\n  action: string;\r\n  data?: Record<string, unknown>;\r\n  _id?: string;\r\n  conversationId?: string;\r\n  newMembers?: string[];\r\n  targetUserId?: string;\r\n  roomId?: string;\r\n}\r\n\r\n// üî• Helper function ƒë·ªÉ normalize member ID\r\nfunction normalizeMemberId(member: MemberInput): string | null {\r\n  if (!member) return null;\r\n  if (typeof member === 'string') return member;\r\n  if (typeof member === 'object') {\r\n    if ('_id' in member && member._id) return String(member._id);\r\n    if ('id' in member && member.id) return String(member.id);\r\n  }\r\n  return null;\r\n}\r\n\r\n// üî• Helper function ƒë·ªÉ t·∫°o filter cho member ID (h·ªó tr·ª£ c·∫£ string v√† number)\r\nfunction createMemberIdFilter(memberId: string): Array<Record<string, unknown>> {\r\n  const filters: Array<Record<string, unknown>> = [{ _id: memberId }];\r\n\r\n  // N·∫øu l√† s·ªë, th√™m filter cho number\r\n  if (!isNaN(Number(memberId))) {\r\n    filters.push({ _id: Number(memberId) });\r\n  }\r\n\r\n  // N·∫øu l√† ObjectId h·ª£p l·ªá, th√™m filter cho ObjectId\r\n  if (ObjectId.isValid(memberId)) {\r\n    filters.push({ _id: new ObjectId(memberId) });\r\n  }\r\n\r\n  return filters;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const body = (await req.json()) as GroupApiRequestBody;\r\n  const { action, data, _id, conversationId, newMembers, targetUserId, roomId } = body;\r\n  const currentUserId = _id;\r\n\r\n  try {\r\n    const collection = await getCollection<GroupConversation>(GROUP_COLLECTION_NAME);\r\n\r\n    switch (action) {\r\n      case 'createGroup': {\r\n        if (!data || !data.name || !Array.isArray(data.members) || data.members.length < 2) {\r\n          return NextResponse.json({ error: 'Missing data or not enough members' }, { status: 400 });\r\n        }\r\n\r\n        const membersWithRole: GroupMemberSchema[] = data.members.map((memberId: string) => ({\r\n          _id: memberId,\r\n          role: memberId === data.createdBy ? 'OWNER' : 'MEMBER',\r\n          joinedAt: Date.now(),\r\n          addedBy: data.createdBy as string, // ‚úÖ Set addedBy to creator\r\n        }));\r\n\r\n        const finalData: GroupConversationCreate = {\r\n          name: data.name as string,\r\n          members: membersWithRole,\r\n          isGroup: true,\r\n          createdBy: data.createdBy as string,\r\n          createdAt: Date.now(),\r\n          avatar: data.avatar,\r\n        };\r\n\r\n        const newId = await addRow<GroupConversationCreate>(GROUP_COLLECTION_NAME, finalData);\r\n        return NextResponse.json({ success: true, group: { ...finalData, _id: newId } });\r\n      }\r\n\r\n      case 'readGroups': {\r\n        if (!_id) {\r\n          return NextResponse.json({ error: 'Missing _id' }, { status: 400 });\r\n        }\r\n\r\n        const userIdStr = String(_id);\r\n        const variants: (string | number)[] = [userIdStr];\r\n        if (!isNaN(Number(userIdStr))) {\r\n          variants.push(Number(userIdStr));\r\n        }\r\n\r\n        // üî• T·∫°o filter h·ªó tr·ª£ nhi·ªÅu ki·ªÉu d·ªØ li·ªáu\r\n        const memberFilters = createMemberIdFilter(userIdStr).map((filter) => ({\r\n          'members._id': filter._id,\r\n        }));\r\n\r\n        const filters = {\r\n          isGroup: true,\r\n          $or: memberFilters,\r\n        };\r\n\r\n        const result = await getAllRows<GroupConversation>(GROUP_COLLECTION_NAME, { filters });\r\n        const conversations = result.data || [];\r\n        if (!conversations.length) return NextResponse.json(result);\r\n\r\n        // üî• Thu th·∫≠p t·∫•t c·∫£ member IDs\r\n        const allMemberIds = Array.from(\r\n          new Set(\r\n            conversations.flatMap((conv) =>\r\n              ((conv.members || []) as MemberInput[]).map(normalizeMemberId).filter((id): id is string => !!id),\r\n            ),\r\n          ),\r\n        );\r\n\r\n        // üî• T·∫°o filters ƒë·ªÉ query users (h·ªó tr·ª£ c·∫£ string, number v√† ObjectId)\r\n        const userFilters: Array<Record<string, unknown>> = [];\r\n\r\n        allMemberIds.forEach((id) => {\r\n          // Th√™m filter cho string\r\n          userFilters.push({ _id: id });\r\n\r\n          // N·∫øu l√† s·ªë, th√™m filter cho number\r\n          if (!isNaN(Number(id))) {\r\n            userFilters.push({ _id: Number(id) });\r\n          }\r\n\r\n          // N·∫øu l√† ObjectId h·ª£p l·ªá, th√™m filter cho ObjectId\r\n          if (ObjectId.isValid(id)) {\r\n            userFilters.push({ _id: new ObjectId(id) });\r\n          }\r\n        });\r\n\r\n        // Query users v·ªõi $or filter\r\n        const usersResult = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n          filters: userFilters.length > 0 ? { $or: userFilters } : {},\r\n        });\r\n\r\n        // üî• T·∫°o userMap v·ªõi nhi·ªÅu key formats\r\n        const userMap = new Map<string, User>();\r\n        (usersResult.data || []).forEach((u) => {\r\n          if (u._id) {\r\n            const id = String(u._id);\r\n            userMap.set(id, u);\r\n\r\n            // Th√™m c·∫£ key d·∫°ng number n·∫øu c√≥ th·ªÉ\r\n            if (!isNaN(Number(id))) {\r\n              userMap.set(String(Number(id)), u);\r\n            }\r\n          }\r\n        });\r\n\r\n        // Chu·∫©n h√≥a conversations\r\n        const enrichedConversations = conversations.map((conv) => {\r\n          const rawMembers: MemberInput[] = Array.isArray(conv.members) ? (conv.members as MemberInput[]) : [];\r\n          const hasOwner = rawMembers.some((m) => m && typeof m === 'object' && m.role === 'OWNER');\r\n\r\n          let ownerIdToAssign: string | null = null;\r\n          const createdByStr = conv.createdBy ? String(conv.createdBy) : null;\r\n\r\n          if (!hasOwner && rawMembers.length > 0) {\r\n            if (createdByStr && rawMembers.some((m) => normalizeMemberId(m) === createdByStr)) {\r\n              ownerIdToAssign = createdByStr;\r\n            } else {\r\n              const firstId = normalizeMemberId(rawMembers[0]);\r\n              ownerIdToAssign = firstId;\r\n            }\r\n          }\r\n\r\n          const normalizedMembers: MemberInfo[] = rawMembers.map((mem) => {\r\n            const memId = normalizeMemberId(mem);\r\n            const base: Partial<MemberInfo> = typeof mem === 'object' ? { ...mem } : { _id: memId ?? '' };\r\n\r\n            if (!base.role || !['OWNER', 'ADMIN', 'MEMBER'].includes(base.role)) {\r\n              if (ownerIdToAssign && memId === ownerIdToAssign) {\r\n                base.role = 'OWNER';\r\n              } else {\r\n                base.role = 'MEMBER';\r\n              }\r\n            }\r\n\r\n            // üî• T√¨m user info v·ªõi nhi·ªÅu c√°ch\r\n            let memberInfo: User | undefined;\r\n            if (memId) {\r\n              memberInfo = userMap.get(memId);\r\n\r\n              // Th·ª≠ t√¨m v·ªõi number format n·∫øu ch∆∞a c√≥\r\n              if (!memberInfo && !isNaN(Number(memId))) {\r\n                memberInfo = userMap.get(String(Number(memId)));\r\n              }\r\n            }\r\n\r\n            if (memberInfo) {\r\n              return {\r\n                ...(base as MemberInfo),\r\n                _id: memId ?? '',\r\n                name: memberInfo.name,\r\n                avatar: memberInfo.avatar,\r\n              };\r\n            }\r\n\r\n            return {\r\n              ...(base as MemberInfo),\r\n              _id: memId ?? '',\r\n              name: base.name ?? 'Unknown User',\r\n            };\r\n          });\r\n\r\n          return {\r\n            ...conv,\r\n            _id: conv._id.toString(),\r\n            members: normalizedMembers,\r\n          };\r\n        });\r\n\r\n        const msgCollection = await getCollection<Message>(MESSAGES_COLLECTION_NAME);\r\n\r\n        const settled = await Promise.allSettled(\r\n          enrichedConversations.map(async (group) => {\r\n            const unreadCount = await msgCollection.countDocuments({\r\n              roomId: group._id,\r\n              readBy: { $nin: variants as unknown as string[] },\r\n            });\r\n\r\n            const lastMsgs = await msgCollection.find({ roomId: group._id }).sort({ timestamp: -1 }).limit(1).toArray();\r\n            const lastMsgObj = lastMsgs[0];\r\n            const isPinned = group.isPinnedBy?.[userIdStr] === true;\r\n            const isHidden = group.isHiddenBy?.[userIdStr] === true;\r\n\r\n            let lastMessagePreview = '';\r\n\r\n            if (lastMsgObj) {\r\n              let senderName = '';\r\n              const senderIdStr = String(lastMsgObj.sender);\r\n\r\n              if (senderIdStr === userIdStr) {\r\n                senderName = 'B·∫°n';\r\n              } else {\r\n                const membersArr = Array.isArray(group.members) ? (group.members as MemberInfo[]) : [];\r\n                const matchedMember =\r\n                  membersArr.find((m) => String(m._id) === senderIdStr) ||\r\n                  membersArr.find(\r\n                    (m) =>\r\n                      !isNaN(Number(String(m._id))) &&\r\n                      !isNaN(Number(senderIdStr)) &&\r\n                      Number(String(m._id)) === Number(senderIdStr),\r\n                  );\r\n                const roomNick = matchedMember && (matchedMember.nickname || '').trim();\r\n                if (roomNick) {\r\n                  senderName = roomNick;\r\n                } else {\r\n                  const senderInfo = userMap.get(senderIdStr) || userMap.get(String(Number(senderIdStr)));\r\n                  senderName = senderInfo ? senderInfo.name : 'Ng∆∞·ªùi l·∫°';\r\n                }\r\n              }\r\n\r\n              if (lastMsgObj.isRecalled) {\r\n                lastMessagePreview = `${senderName}: ƒë√£ thu h·ªìi tin nh·∫Øn`;\r\n              } else {\r\n                const content =\r\n                  lastMsgObj.type === 'text' || lastMsgObj.type === 'notify'\r\n                    ? lastMsgObj.content\r\n                    : `[${lastMsgObj.type}]`;\r\n                lastMessagePreview = `${senderName}: ${content}`;\r\n              }\r\n            }\r\n\r\n            const fallbackTime = typeof group.createdAt === 'number' ? group.createdAt : Date.now();\r\n\r\n            return {\r\n              ...group,\r\n              unreadCount,\r\n              lastMessage: lastMessagePreview,\r\n              lastMessageAt: lastMsgObj ? lastMsgObj.timestamp : fallbackTime,\r\n              isRecall: lastMsgObj ? lastMsgObj.isRecalled || false : false,\r\n              isPinned,\r\n              isHidden,\r\n              categories: Array.isArray(\r\n                (group as unknown as { categoriesBy?: Record<string, string[]> }).categoriesBy?.[userIdStr],\r\n              )\r\n                ? ((group as unknown as { categoriesBy?: Record<string, string[]> }).categoriesBy?.[\r\n                    userIdStr\r\n                  ] as string[])\r\n                : [],\r\n            } as Record<string, unknown>;\r\n          }),\r\n        );\r\n\r\n        const finalConversations = settled\r\n          .filter((r) => r.status === 'fulfilled')\r\n          .map((r) => (r as PromiseFulfilledResult<Record<string, unknown>>).value);\r\n\r\n        return NextResponse.json({\r\n          total: finalConversations.length,\r\n          data: finalConversations,\r\n        });\r\n      }\r\n\r\n      case 'addMembers': {\r\n        if (!conversationId || !newMembers || !Array.isArray(newMembers)) {\r\n          return NextResponse.json({ error: 'Missing conversationId or newMembers' }, { status: 400 });\r\n        }\r\n\r\n        const filter = { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>;\r\n        const membersToAdd: GroupMemberSchema[] = newMembers.map((memberId: string) => ({\r\n          _id: memberId,\r\n          role: 'MEMBER',\r\n          joinedAt: Date.now(),\r\n          addedBy: currentUserId, // ‚úÖ Set addedBy to current user\r\n        }));\r\n\r\n        const result = await collection.updateOne(filter, {\r\n          $push: {\r\n            members: { $each: membersToAdd },\r\n          },\r\n        } as unknown as UpdateFilter<GroupConversation>);\r\n\r\n        // ========== T·∫†O TH√îNG B√ÅO H·ªÜ TH·ªêNG ==========\r\n        try {\r\n          // 1. L·∫•y t√™n ng∆∞·ªùi th√™m (currentUserId)\r\n          let actorName = 'Ai ƒë√≥';\r\n          if (currentUserId) {\r\n            const actorRes = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n              filters:\r\n                createMemberIdFilter(String(currentUserId)).length > 0\r\n                  ? { $or: createMemberIdFilter(String(currentUserId)) }\r\n                  : {},\r\n              limit: 1,\r\n            });\r\n            const actor = actorRes.data?.[0];\r\n            if (actor) {\r\n              actorName = actor.name || actor.username || 'Ng∆∞·ªùi d√πng';\r\n            }\r\n          }\r\n\r\n          // 2. L·∫•y t√™n nh·ªØng ng∆∞·ªùi ƒë∆∞·ª£c th√™m\r\n          const newMemberNames: string[] = [];\r\n          for (const mid of newMembers) {\r\n            const mRes = await getAllRows<User>(USERS_COLLECTION_NAME, {\r\n              filters: createMemberIdFilter(String(mid)).length > 0 ? { $or: createMemberIdFilter(String(mid)) } : {},\r\n              limit: 1,\r\n            });\r\n            const mUser = mRes.data?.[0];\r\n            if (mUser) {\r\n              newMemberNames.push(mUser.name || mUser.username || 'Ng∆∞·ªùi d√πng');\r\n            } else {\r\n              newMemberNames.push('Ng∆∞·ªùi d√πng');\r\n            }\r\n          }\r\n\r\n          if (newMemberNames.length > 0) {\r\n            const namesStr = newMemberNames.join(', ');\r\n            const notifyContent = `${actorName} ƒë√£ th√™m ${namesStr} v√†o nh√≥m.`;\r\n\r\n            await addRow<Partial<Message>>(MESSAGES_COLLECTION_NAME, {\r\n              roomId: String(conversationId),\r\n              sender: String(currentUserId || 'system'),\r\n              type: 'notify',\r\n              content: notifyContent,\r\n              timestamp: Date.now(),\r\n            });\r\n          }\r\n        } catch (e) {\r\n          console.error('Failed to create notify message:', e);\r\n        }\r\n        // ============================================\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateAvatar': {\r\n        if (!conversationId || !data?.avatar) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          { $set: { avatar: data.avatar as string } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'renameGroup': {\r\n        if (!conversationId || !data?.name) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          { $set: { name: data.name as string } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'changeRole': {\r\n        if (!conversationId || !targetUserId || !data?.role || !currentUserId) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const group = await collection.findOne({\r\n          _id: new ObjectId(conversationId),\r\n        } as unknown as Filter<GroupConversation>);\r\n\r\n        if (!group) {\r\n          return NextResponse.json({ error: 'Group not found' }, { status: 404 });\r\n        }\r\n\r\n        const members: MemberInput[] = Array.isArray(group.members) ? (group.members as MemberInput[]) : [];\r\n        const ownerMember = members.find(\r\n          (m) => m && typeof m === 'object' && m.role === 'OWNER' && '_id' in m && m._id,\r\n        ) as GroupMemberSchema | undefined;\r\n\r\n        const ownerId = ownerMember ? String(ownerMember._id) : null;\r\n        const userIdStr = String(currentUserId);\r\n\r\n        if (!ownerId || ownerId !== userIdStr) {\r\n          return NextResponse.json({ error: 'Only owner can change roles' }, { status: 403 });\r\n        }\r\n\r\n        const requestedRole = String(data.role);\r\n        if (!['ADMIN', 'MEMBER'].includes(requestedRole)) {\r\n          return NextResponse.json({ error: 'Invalid role' }, { status: 400 });\r\n        }\r\n\r\n        const targetStr = String(targetUserId);\r\n\r\n        // üî• THAY ƒê·ªîI: T√¨m index c·ªßa member trong array, sau ƒë√≥ update tr·ª±c ti·∫øp\r\n        let memberIndex = -1;\r\n\r\n        // T√¨m index c·ªßa member c·∫ßn update\r\n        for (let i = 0; i < members.length; i++) {\r\n          const m = members[i];\r\n          const mId = normalizeMemberId(m);\r\n\r\n          // So s√°nh v·ªõi nhi·ªÅu format\r\n          if (mId === targetStr) {\r\n            memberIndex = i;\r\n            break;\r\n          }\r\n          if (!isNaN(Number(mId)) && !isNaN(Number(targetStr)) && Number(mId) === Number(targetStr)) {\r\n            memberIndex = i;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (memberIndex === -1) {\r\n          return NextResponse.json({ error: 'Member not found in group' }, { status: 404 });\r\n        }\r\n\r\n        // üî• Update tr·ª±c ti·∫øp b·∫±ng c√°ch ch·ªâ ƒë·ªãnh index c·ª• th·ªÉ\r\n        const updateField = `members.${memberIndex}.role`;\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          { $set: { [updateField]: requestedRole as GroupRole } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        if (result.modifiedCount === 0) {\r\n          return NextResponse.json({ error: 'Failed to update role' }, { status: 500 });\r\n        }\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateMemberNickname': {\r\n        if (!conversationId || !targetUserId || data?.nickname === undefined) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const group = await collection.findOne({\r\n          _id: new ObjectId(conversationId),\r\n        } as unknown as Filter<GroupConversation>);\r\n\r\n        if (!group) {\r\n          return NextResponse.json({ error: 'Group not found' }, { status: 404 });\r\n        }\r\n\r\n        const members: MemberInput[] = Array.isArray(group.members) ? (group.members as MemberInput[]) : [];\r\n        const targetStr = String(targetUserId);\r\n\r\n        let memberIndex = -1;\r\n        for (let i = 0; i < members.length; i++) {\r\n          const m = members[i];\r\n          const mId = normalizeMemberId(m);\r\n          if (mId === targetStr) {\r\n            memberIndex = i;\r\n            break;\r\n          }\r\n          if (!isNaN(Number(mId)) && !isNaN(Number(targetStr)) && Number(mId) === Number(targetStr)) {\r\n            memberIndex = i;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (memberIndex === -1) {\r\n          return NextResponse.json({ error: 'Member not found in group' }, { status: 404 });\r\n        }\r\n\r\n        const nickname = String(data.nickname).trim();\r\n        const updateField = `members.${memberIndex}.nickname`;\r\n        const updateOp = nickname ? { $set: { [updateField]: nickname } } : { $unset: { [updateField]: '' } };\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          updateOp as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'kickMember': {\r\n        if (!conversationId || !targetUserId) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const targetStr = String(targetUserId);\r\n\r\n        // üî• T·∫°o pull condition cho nhi·ªÅu ƒë·ªãnh d·∫°ng ID\r\n        const pullConditions: Array<Record<string, unknown>> = [{ _id: targetStr }];\r\n\r\n        if (!isNaN(Number(targetStr))) {\r\n          pullConditions.push({ _id: Number(targetStr) });\r\n        }\r\n\r\n        if (ObjectId.isValid(targetStr)) {\r\n          pullConditions.push({ _id: new ObjectId(targetStr) });\r\n        }\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          { $pull: { members: { $or: pullConditions } } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'leaveGroup': {\r\n        if (!conversationId || !currentUserId) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const userIdStr = String(currentUserId);\r\n        const group = await collection.findOne({\r\n          _id: new ObjectId(conversationId),\r\n        } as unknown as Filter<GroupConversation>);\r\n\r\n        if (!group) {\r\n          return NextResponse.json({ error: 'Group not found' }, { status: 404 });\r\n        }\r\n\r\n        const members: MemberInput[] = Array.isArray(group.members) ? (group.members as MemberInput[]) : [];\r\n        const ownerMember = members.find((m) => {\r\n          if (!m || typeof m === 'string') return false;\r\n          const id = normalizeMemberId(m);\r\n          return id === userIdStr && m.role === 'OWNER';\r\n        });\r\n\r\n        if (!ownerMember) {\r\n          // üî• Pull v·ªõi nhi·ªÅu format\r\n          const pullConditions: Array<Record<string, unknown>> = [{ _id: userIdStr }];\r\n\r\n          if (!isNaN(Number(userIdStr))) {\r\n            pullConditions.push({ _id: Number(userIdStr) });\r\n          }\r\n\r\n          if (ObjectId.isValid(userIdStr)) {\r\n            pullConditions.push({ _id: new ObjectId(userIdStr) });\r\n          }\r\n\r\n          const result = await collection.updateOne(\r\n            { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n            { $pull: { members: { $or: pullConditions } } } as unknown as UpdateFilter<GroupConversation>,\r\n          );\r\n          return NextResponse.json({ success: true, result });\r\n        }\r\n\r\n        const otherMembers = members.filter(\r\n          (m) => m && typeof m === 'object' && '_id' in m && normalizeMemberId(m) !== userIdStr,\r\n        );\r\n\r\n        if (otherMembers.length === 0) {\r\n          await collection.deleteOne({ _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>);\r\n          const msgCollection = await getCollection<Message>(MESSAGES_COLLECTION_NAME);\r\n          await msgCollection.deleteMany({ roomId: String(conversationId) } as unknown as Filter<Message>);\r\n          return NextResponse.json({ success: true });\r\n        }\r\n\r\n        const adminCandidate = otherMembers.find((m) => typeof m === 'object' && m.role === 'ADMIN');\r\n        const nextOwnerCandidate = adminCandidate || otherMembers[Math.floor(Math.random() * otherMembers.length)];\r\n        const nextOwnerId = normalizeMemberId(nextOwnerCandidate) || '';\r\n\r\n        // üî• Update owner v·ªõi filter ph·ª©c t·∫°p\r\n        const ownerFilters: Array<Record<string, unknown>> = [{ 'members._id': nextOwnerId }];\r\n\r\n        if (!isNaN(Number(nextOwnerId))) {\r\n          ownerFilters.push({ 'members._id': Number(nextOwnerId) });\r\n        }\r\n\r\n        if (ObjectId.isValid(nextOwnerId)) {\r\n          ownerFilters.push({ 'members._id': new ObjectId(nextOwnerId) });\r\n        }\r\n\r\n        await collection.updateOne(\r\n          {\r\n            _id: new ObjectId(conversationId),\r\n            $or: ownerFilters,\r\n          } as unknown as Filter<GroupConversation>,\r\n          { $set: { 'members.$.role': 'OWNER' } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        const pullConditions: Array<Record<string, unknown>> = [{ _id: userIdStr }];\r\n\r\n        if (!isNaN(Number(userIdStr))) {\r\n          pullConditions.push({ _id: Number(userIdStr) });\r\n        }\r\n\r\n        if (ObjectId.isValid(userIdStr)) {\r\n          pullConditions.push({ _id: new ObjectId(userIdStr) });\r\n        }\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>,\r\n          { $pull: { members: { $or: pullConditions } } } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'disbandGroup': {\r\n        if (!conversationId || !currentUserId) {\r\n          return NextResponse.json({ error: 'Missing info' }, { status: 400 });\r\n        }\r\n\r\n        const group = await collection.findOne({\r\n          _id: new ObjectId(conversationId),\r\n        } as unknown as Filter<GroupConversation>);\r\n\r\n        if (!group) {\r\n          return NextResponse.json({ error: 'Group not found' }, { status: 404 });\r\n        }\r\n\r\n        const userIdStr = String(currentUserId);\r\n        const ownerMember = Array.isArray(group.members)\r\n          ? (group.members as MemberInput[]).find((m) => m && typeof m === 'object' && m.role === 'OWNER' && '_id' in m)\r\n          : null;\r\n        const ownerId = ownerMember ? normalizeMemberId(ownerMember) : null;\r\n\r\n        if (!ownerId || ownerId !== userIdStr) {\r\n          return NextResponse.json({ error: 'Only owner can disband group' }, { status: 403 });\r\n        }\r\n\r\n        await collection.deleteOne({ _id: new ObjectId(conversationId) } as unknown as Filter<GroupConversation>);\r\n        const msgCollection = await getCollection<Message>(MESSAGES_COLLECTION_NAME);\r\n        await msgCollection.deleteMany({ roomId: String(conversationId) } as unknown as Filter<Message>);\r\n\r\n        return NextResponse.json({ success: true });\r\n      }\r\n\r\n      case 'toggleChatStatus': {\r\n        const targetId = conversationId || roomId;\r\n        if (!targetId || !currentUserId || !data) {\r\n          return NextResponse.json({ error: 'Missing ID/Data' }, { status: 400 });\r\n        }\r\n\r\n        const updateFields = buildToggleChatStatusFields(String(currentUserId), {\r\n          isPinned: typeof data.isPinned === 'boolean' ? (data.isPinned as boolean) : undefined,\r\n          isHidden: typeof data.isHidden === 'boolean' ? (data.isHidden as boolean) : undefined,\r\n        });\r\n        if (!updateFields) {\r\n          return NextResponse.json({ error: 'No status provided' }, { status: 400 });\r\n        }\r\n\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(targetId) } as unknown as Filter<GroupConversation>,\r\n          { $set: updateFields } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n      case 'updateCategories': {\r\n        const targetId = conversationId || roomId;\r\n        if (!targetId || !currentUserId || !data) {\r\n          return NextResponse.json({ error: 'Missing ID/Data' }, { status: 400 });\r\n        }\r\n        const updateFields = buildUpdateCategoriesFields(\r\n          String(currentUserId),\r\n          (data as Record<string, unknown>).categories,\r\n        );\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(targetId) } as unknown as Filter<GroupConversation>,\r\n          { $set: updateFields } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      case 'updateTags': {\r\n        const targetId = conversationId || roomId;\r\n        if (!targetId || !currentUserId || !data) {\r\n          return NextResponse.json({ error: 'Missing ID/Data' }, { status: 400 });\r\n        }\r\n        const updateFields = buildUpdateTagsFields(String(currentUserId), (data as Record<string, unknown>).tags);\r\n        const result = await collection.updateOne(\r\n          { _id: new ObjectId(targetId) } as unknown as Filter<GroupConversation>,\r\n          { $set: updateFields } as unknown as UpdateFilter<GroupConversation>,\r\n        );\r\n        return NextResponse.json({ success: true, result });\r\n      }\r\n\r\n      default:\r\n        return NextResponse.json({ error: 'Invalid action' }, { status: 400 });\r\n    }\r\n  } catch (error) {\r\n    console.error('Conversations API Error:', error);\r\n    return NextResponse.json({ error: 'Server error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}