{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useCreateGroupModal.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useMemo, useState } from 'react';\r\nimport io from 'socket.io-client';\r\nimport { resolveSocketUrl, normalizeNoAccent } from '@/utils/utils';\r\nimport type { User } from '@/types/User';\r\nimport type { GroupConversation } from '@/types/Group';\r\n\r\ninterface UseCreateGroupModalParams {\r\n  currentUser: User;\r\n  allUsers: User[];\r\n  mode: 'create' | 'add';\r\n  conversationId?: string;\r\n  existingMemberIds?: string[];\r\n  reLoad?: () => void;\r\n  onMembersAdded?: (users: User[]) => void;\r\n  /**\r\n   * ƒê∆∞·ª£c g·ªçi sau khi t·∫°o nh√≥m / th√™m th√†nh vi√™n th√†nh c√¥ng.\r\n   * - V·ªõi mode \"create\": nh·∫≠n v·ªÅ group v·ª´a t·∫°o ƒë·ªÉ FE c√≥ th·ªÉ auto m·ªü khung chat.\r\n   * - V·ªõi mode \"add\": kh√¥ng c·∫ßn tham s·ªë.\r\n   */\r\n  onGroupCreated: (group?: GroupConversation) => void;\r\n  onClose: () => void;\r\n}\r\n\r\nexport function useCreateGroupModal({\r\n  currentUser,\r\n  allUsers,\r\n  mode,\r\n  conversationId,\r\n  existingMemberIds = [],\r\n  reLoad,\r\n  onMembersAdded,\r\n  onGroupCreated,\r\n  onClose,\r\n}: UseCreateGroupModalParams) {\r\n  const [groupName, setGroupName] = useState('');\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [avatarFile, setAvatarFile] = useState<File | null>(null);\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);\r\n\r\n  const [selectedMembers, setSelectedMembers] = useState<string[]>(() => {\r\n    const currentUserId = String(currentUser._id);\r\n    const initialSet = new Set<string>([...existingMemberIds.map(String), currentUserId]);\r\n    return Array.from(initialSet);\r\n  });\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n\r\n  const handleMemberToggle = (_id: string) => {\r\n    if (mode === 'add' && existingMemberIds.includes(_id)) return;\r\n    setSelectedMembers((prev) => (prev.includes(_id) ? prev.filter((id) => id !== _id) : [...prev, _id]));\r\n  };\r\n\r\n  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    if (!file.type.startsWith('image/')) {\r\n      setError('Vui l√≤ng ch·ªçn file ·∫£nh');\r\n      return;\r\n    }\r\n\r\n    // Remove size limit\r\n    // const MAX = 5 * 1024 * 1024; // 5MB\r\n    // if (file.size > MAX) { ... }\r\n\r\n    setAvatarFile(file);\r\n    setAvatarPreview(URL.createObjectURL(file));\r\n    setError('');\r\n  };\r\n\r\n  const groupedUsers = useMemo(() => {\r\n    let filtered = allUsers;\r\n    if (searchTerm.trim()) {\r\n      const norm = normalizeNoAccent(searchTerm);\r\n      filtered = allUsers.filter((u) => normalizeNoAccent(u.name || '').includes(norm));\r\n    }\r\n\r\n    const sortedUsers = [...filtered].sort((a, b) => (a.name || '').localeCompare(b.name || ''));\r\n\r\n    const groups: Record<string, User[]> = {};\r\n    sortedUsers.forEach((user) => {\r\n      const firstLetter = (user.name?.charAt(0) || '#').toUpperCase();\r\n      const key = /^[A-Z]$/.test(firstLetter) ? firstLetter : '#';\r\n      if (!groups[key]) groups[key] = [];\r\n      groups[key].push(user);\r\n    });\r\n\r\n    return groups;\r\n  }, [allUsers, searchTerm]);\r\n\r\n  const sortedGroupKeys = useMemo(() => {\r\n    return Object.keys(groupedUsers).sort((a, b) => {\r\n      if (a === '#') return 1;\r\n      if (b === '#') return -1;\r\n      return a.localeCompare(b);\r\n    });\r\n  }, [groupedUsers]);\r\n\r\n  const handleSubmit = async () => {\r\n    if (mode === 'create' && !groupName.trim()) {\r\n      setError('Vui l√≤ng nh·∫≠p t√™n nh√≥m');\r\n      return;\r\n    }\r\n\r\n    const newMembersOnly = selectedMembers.filter((_id) => !existingMemberIds.includes(_id));\r\n\r\n    if (mode === 'add' && newMembersOnly.length === 0) {\r\n      setError('B·∫°n ch∆∞a ch·ªçn th√™m th√†nh vi√™n m·ªõi n√†o');\r\n      return;\r\n    }\r\n    if (mode === 'create' && selectedMembers.length < 3) {\r\n      setError('Nh√≥m ph·∫£i c√≥ √≠t nh·∫•t 3 th√†nh vi√™n (bao g·ªìm b·∫°n)');\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError('');\r\n\r\n    try {\r\n      let avatarUrl = '';\r\n      if (mode === 'create' && avatarFile) {\r\n        const uploadId = `group_avatar_${Date.now()}`;\r\n        const formData = new FormData();\r\n        formData.append('file', avatarFile);\r\n        formData.append('roomId', 'new_group');\r\n        formData.append('sender', String(currentUser._id));\r\n        formData.append('type', 'image');\r\n        formData.append('folderName', 'GroupAvatars');\r\n\r\n        const uploadRes = await fetch(`/api/upload?uploadId=${uploadId}`, {\r\n          method: 'POST',\r\n          body: formData,\r\n        });\r\n        const uploadJson = await uploadRes.json();\r\n        if (uploadJson.success && uploadJson.link) {\r\n          avatarUrl = uploadJson.link;\r\n        }\r\n      }\r\n\r\n      type CreateGroupBody = {\r\n        action: 'createGroup';\r\n        data: {\r\n          name: string;\r\n          members: string[];\r\n          createdBy: string;\r\n          avatar?: string;\r\n        };\r\n      };\r\n\r\n      type AddMembersBody = {\r\n        action: 'addMembers';\r\n        conversationId: string | undefined;\r\n        newMembers: string[];\r\n        _id: string;\r\n      };\r\n\r\n      let bodyData: CreateGroupBody | AddMembersBody;\r\n\r\n      if (mode === 'create') {\r\n        bodyData = {\r\n          action: 'createGroup',\r\n          data: {\r\n            name: groupName,\r\n            members: selectedMembers,\r\n            createdBy: currentUser._id,\r\n            avatar: avatarUrl || undefined,\r\n          },\r\n        };\r\n      } else {\r\n        bodyData = {\r\n          action: 'addMembers',\r\n          conversationId,\r\n          newMembers: newMembersOnly,\r\n          _id: String(currentUser._id),\r\n        };\r\n      }\r\n\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(bodyData),\r\n      });\r\n\r\n      const result = await res.json();\r\n\r\n      if (result.success) {\r\n        // Ch·ªâ reload l·∫°i d·ªØ li·ªáu khi thao t√°c th√†nh c√¥ng\r\n        reLoad?.();\r\n\r\n        if (mode === 'add' && onMembersAdded) {\r\n          const addedUsersFullInfo = allUsers.filter((u) => newMembersOnly.includes(String(u._id)));\r\n          onMembersAdded(addedUsersFullInfo);\r\n          try {\r\n            const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n            const prevMembersPayload = (existingMemberIds || []).map((id) => ({ _id: String(id) }));\r\n            const nextMembersPayload = newMembersOnly.map((id) => ({\r\n              _id: id,\r\n              role: 'MEMBER',\r\n              joinedAt: Date.now(),\r\n              addedBy: String(currentUser._id),\r\n            }));\r\n            sock.emit('group_members_updated', {\r\n              conversationId,\r\n              members: [...prevMembersPayload, ...nextMembersPayload],\r\n              action: 'add',\r\n            });\r\n            setTimeout(() => sock.disconnect(), 500);\r\n          } catch {}\r\n          onGroupCreated();\r\n        } else if (mode === 'create') {\r\n          const createdGroup = result.group as GroupConversation | undefined;\r\n          onGroupCreated(createdGroup);\r\n\r\n          // üî• Emit socket ƒë·ªÉ t·∫•t c·∫£ th√†nh vi√™n th·∫•y nh√≥m m·ªõi ngay tr√™n sidebar\r\n          try {\r\n            const sock = io(resolveSocketUrl(), { transports: ['websocket'], withCredentials: false });\r\n            const roomIdStr = String(createdGroup?._id || result?.groupId || '');\r\n            const membersRaw = createdGroup?.members || selectedMembers;\r\n            const membersPayload = Array.isArray(membersRaw)\r\n              ? membersRaw.map((m) => (typeof m === 'object' && m?._id ? { _id: String(m._id) } : String(m)))\r\n              : [];\r\n\r\n            sock.emit('group_created', {\r\n              roomId: roomIdStr,\r\n              members: membersPayload,\r\n              sender: currentUser._id,\r\n              senderName: currentUser.name,\r\n              groupName: createdGroup?.name || groupName,\r\n            });\r\n            setTimeout(() => sock.disconnect(), 500);\r\n          } catch {}\r\n        }\r\n\r\n        onClose();\r\n      } else {\r\n        setError(result.error || 'Th·ª±c hi·ªán th·∫•t b·∫°i');\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError('L·ªói k·∫øt n·ªëi server');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return {\r\n    groupName,\r\n    setGroupName,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    selectedMembers,\r\n    loading,\r\n    error,\r\n    groupedUsers,\r\n    sortedGroupKeys,\r\n    handleMemberToggle,\r\n    handleSubmit,\r\n    avatarFile,\r\n    avatarPreview,\r\n    handleAvatarChange,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 254, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatInfoPopup.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState, useCallback, useRef } from 'react';\r\nimport type { ChatItem } from '@/types/Group';\r\nimport type { User } from '@/types/User';\r\nimport type { Message } from '@/types/Message';\r\n\r\ninterface UseChatInfoPopupParams {\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  messages: Message[];\r\n  currentUser: User;\r\n  onChatAction: (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroup: boolean) => void;\r\n}\r\n\r\nexport function useChatInfoPopup({ selectedChat, isGroup, messages, currentUser, onChatAction }: UseChatInfoPopupParams) {\r\n  const getId = (u: unknown): string => {\r\n    if (!u) return '';\r\n    if (typeof u === 'string') return u;\r\n    if (typeof u === 'number') return String(u);\r\n    if (typeof u === 'object' && u !== null) {\r\n      if ('_id' in (u as Record<string, unknown>) && (u as Record<string, unknown>)._id != null)\r\n        return String((u as Record<string, unknown>)._id);\r\n      if ('id' in (u as Record<string, unknown>) && (u as Record<string, unknown>).id != null)\r\n        return String((u as Record<string, unknown>).id);\r\n    }\r\n    return '';\r\n  };\r\n  const getOneToOneRoomId = (user1Id: string | number, user2Id: string | number) => {\r\n    return [user1Id, user2Id].sort().join('_');\r\n  };\r\n  const currentRoomId = isGroup ? getId(selectedChat) : getOneToOneRoomId(getId(currentUser), getId(selectedChat));\r\n  const { isPinned: initialIsPinned, isHidden: initialIsHidden } = selectedChat;\r\n\r\n  // Tr·∫°ng th√°i ghim / ·∫©n c·ª•c b·ªô (optimistic UI)\r\n  const [localIsPinned, setLocalIsPinned] = useState(initialIsPinned === true);\r\n  const [localIsHidden, setLocalIsHidden] = useState(initialIsHidden === true);\r\n\r\n  // Accordion tr·∫°ng th√°i m·ªü/ƒë√≥ng cho t·ª´ng m·ª•c\r\n  const [openItems, setOpenItems] = useState<Record<string, boolean>>({});\r\n\r\n  // Id c·ªßa item ƒëang m·ªü menu \"...\"\r\n  const [activeMenuId, setActiveMenuId] = useState<string | null>(null);\r\n\r\n  // C·∫≠p nh·∫≠t state c·ª•c b·ªô khi props thay ƒë·ªïi (theo ph√≤ng hi·ªán t·∫°i)\r\n  useEffect(() => {\r\n    setLocalIsPinned(initialIsPinned === true);\r\n    setLocalIsHidden(initialIsHidden === true);\r\n  }, [currentRoomId, initialIsPinned, initialIsHidden]);\r\n\r\n  const handleChatActionClick = (actionType: 'pin' | 'hide') => {\r\n    const targetId = isGroup ? currentRoomId : getId(selectedChat);\r\n    if (actionType === 'pin') {\r\n      const newState = !localIsPinned;\r\n      setLocalIsPinned(newState);\r\n      onChatAction(targetId, 'pin', newState, isGroup);\r\n    } else if (actionType === 'hide') {\r\n      const newState = !localIsHidden;\r\n      setLocalIsHidden(newState);\r\n      onChatAction(targetId, 'hide', newState, isGroup);\r\n    }\r\n  };\r\n\r\n  const toggleItem = (item: string) => {\r\n    setOpenItems((prev) => ({\r\n      ...prev,\r\n      [item]: !prev[item],\r\n    }));\r\n  };\r\n\r\n  const closeMenu = () => setActiveMenuId(null);\r\n\r\n  const [mediaList, setMediaList] = useState<{\r\n    id: string;\r\n    type: 'image' | 'video' | 'file';\r\n    url: string;\r\n    fileName?: string;\r\n    timestamp?: number;\r\n  }[]>([]);\r\n  const [mediaGroups, setMediaGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; fileName?: string; type: 'image' | 'video'; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [fileList, setFileList] = useState<{ id: string; url: string; fileName: string; timestamp?: number }[]>([]);\r\n  const [fileGroups, setFileGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; fileName: string; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [linkList, setLinkList] = useState<{ id: string; url: string; timestamp?: number }[]>([]);\r\n  const [linkGroups, setLinkGroups] = useState<\r\n    { dateLabel: string; items: { id: string; url: string; timestamp?: number }[] }[]\r\n  >([]);\r\n  const [mediaTotal, setMediaTotal] = useState(0);\r\n  const [fileTotal, setFileTotal] = useState(0);\r\n  const [linkTotal, setLinkTotal] = useState(0);\r\n  const [isMediaExpanded, setIsMediaExpanded] = useState(false);\r\n  const [isFileExpanded, setIsFileExpanded] = useState(false);\r\n  const [isLinkExpanded, setIsLinkExpanded] = useState(false);\r\n  const assetsReqKeyRef = useRef(0);\r\n\r\n  const flattenGroups = useCallback(<T,>(groups: { items: T[] }[]) => groups.flatMap((g) => g.items ?? []), []);\r\n\r\n  const fetchAssets = useCallback(\r\n    async (assetType: 'media' | 'file' | 'link', needAll: boolean) => {\r\n      const reqKey = assetsReqKeyRef.current;\r\n      const postBody = {\r\n        action: 'readAssets',\r\n        roomId: currentRoomId,\r\n        assetType,\r\n        limit: needAll ? 5000 : 6,\r\n      };\r\n      try {\r\n        const res = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(postBody),\r\n        });\r\n        const json = await res.json();\r\n        if (assetsReqKeyRef.current !== reqKey) return;\r\n        const groups = Array.isArray(json.groups) ? json.groups : [];\r\n        if (assetType === 'media') {\r\n          const items = flattenGroups<{ id: string; url: string; fileName?: string; type: 'image' | 'video'; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setMediaList(items.map((it) => ({ id: it.id, url: it.url, fileName: it.fileName, type: it.type, timestamp: it.timestamp })));\r\n          setMediaGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, fileName: it.fileName, type: it.type, timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setMediaTotal(total);\r\n          setIsMediaExpanded(needAll);\r\n        } else if (assetType === 'file') {\r\n          const items = flattenGroups<{ id: string; url: string; fileName?: string; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setFileList(items.map((it) => ({ id: it.id, url: it.url, fileName: it.fileName || 'T√†i li·ªáu', timestamp: it.timestamp })));\r\n          setFileGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, fileName: it.fileName || 'T√†i li·ªáu', timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setFileTotal(total);\r\n          setIsFileExpanded(needAll);\r\n        } else {\r\n          const items = flattenGroups<{ id: string; url: string; timestamp?: number }>(groups);\r\n          const total = typeof json.total === 'number' ? json.total : items.length;\r\n          setLinkList(items);\r\n          setLinkGroups(\r\n            groups.map((g: { dateLabel?: string; items: typeof items }) => ({\r\n              dateLabel: String(g.dateLabel || ''),\r\n              items: (g.items || []).map((it) => ({ id: it.id, url: it.url, timestamp: it.timestamp })),\r\n            })),\r\n          );\r\n          setLinkTotal(total);\r\n          setIsLinkExpanded(needAll);\r\n        }\r\n      } catch {}\r\n    },\r\n    [currentRoomId, flattenGroups],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!Array.isArray(messages) || messages.length === 0) return;\r\n    const latest = messages[messages.length - 1];\r\n    const videoRegex = /(\\.mp4|\\.mov|\\.mkv|\\.webm|\\.avi|\\.m4v)$/i;\r\n    const linkRegex = /(https?:\\/\\/|www\\.)\\S+/i;\r\n\r\n    const isMediaMsg =\r\n      latest.type === 'image' ||\r\n      latest.type === 'video' ||\r\n      (latest.type === 'file' && (videoRegex.test(String(latest.fileUrl || '')) || videoRegex.test(String(latest.fileName || ''))));\r\n    const isFileMsg = latest.type === 'file' && !(videoRegex.test(String(latest.fileUrl || '')) || videoRegex.test(String(latest.fileName || '')));\r\n    const isLinkMsg = latest.type === 'text' && linkRegex.test(String(latest.content || ''));\r\n\r\n    if (isMediaMsg && openItems['·∫¢nh/Video']) void fetchAssets('media', isMediaExpanded);\r\n    if (isFileMsg && openItems['File']) void fetchAssets('file', isFileExpanded);\r\n    if (isLinkMsg && openItems['Link']) void fetchAssets('link', isLinkExpanded);\r\n  }, [messages, openItems, isMediaExpanded, isFileExpanded, isLinkExpanded, fetchAssets]);\r\n\r\n  useEffect(() => {\r\n    if (openItems['·∫¢nh/Video'] && mediaList.length === 0) void fetchAssets('media', false);\r\n  }, [openItems, mediaList.length, fetchAssets]);\r\n  useEffect(() => {\r\n    if (openItems['File'] && fileList.length === 0) void fetchAssets('file', false);\r\n  }, [openItems, fileList.length, fetchAssets]);\r\n  useEffect(() => {\r\n    if (openItems['Link'] && linkList.length === 0) void fetchAssets('link', false);\r\n  }, [openItems, linkList.length, fetchAssets]);\r\n\r\n  useEffect(() => {\r\n    assetsReqKeyRef.current += 1;\r\n    setOpenItems({});\r\n    setActiveMenuId(null);\r\n    setMediaList([]);\r\n    setMediaGroups([]);\r\n    setFileList([]);\r\n    setFileGroups([]);\r\n    setLinkList([]);\r\n    setLinkGroups([]);\r\n    setMediaTotal(0);\r\n    setFileTotal(0);\r\n    setLinkTotal(0);\r\n    setIsMediaExpanded(false);\r\n    setIsFileExpanded(false);\r\n    setIsLinkExpanded(false);\r\n  }, [currentRoomId]);\r\n\r\n  return {\r\n    currentRoomId,\r\n    localIsPinned,\r\n    localIsHidden,\r\n    openItems,\r\n    activeMenuId,\r\n    setActiveMenuId,\r\n    handleChatActionClick,\r\n    toggleItem,\r\n    closeMenu,\r\n    mediaList,\r\n    mediaGroups,\r\n    fileList,\r\n    fileGroups,\r\n    linkList,\r\n    linkGroups,\r\n    mediaTotal,\r\n    fileTotal,\r\n    linkTotal,\r\n    isMediaExpanded,\r\n    isFileExpanded,\r\n    isLinkExpanded,\r\n    fetchAssets,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 538, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatMentions.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useMemo, useRef, useState } from 'react';\r\nimport { normalizeNoAccent, hasDiacritics, accentAwareIncludes } from '@/utils/utils';\r\n\r\nimport type { User } from '@/types/User';\r\nimport type { MemberInfo } from '@/types/Group';\r\n\r\ninterface UseChatMentionsParams {\r\n  allUsers: User[];\r\n  activeMembers: MemberInfo[];\r\n  currentUser: User;\r\n  allUsersMap?: Map<string, string>;\r\n}\r\n\r\nexport function useChatMentions({ allUsers, activeMembers, currentUser, allUsersMap }: UseChatMentionsParams) {\r\n  const [showMentionMenu, setShowMentionMenu] = useState(false);\r\n  const [mentionQuery, setMentionQuery] = useState('');\r\n  const [mentionStartPos, setMentionStartPos] = useState<number | null>(null);\r\n  const [selectedMentionIndex, setSelectedMentionIndex] = useState(0);\r\n  const mentionMenuRef = useRef<HTMLDivElement | null>(null);\r\n  const editableRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  const getPlainTextFromEditable = useCallback((): string => {\r\n    if (!editableRef.current) return '';\r\n\r\n    const BLOCK_TAGS = new Set(['DIV', 'P', 'LI', 'UL', 'OL', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6']);\r\n\r\n    const traverse = (node: Node): string => {\r\n      if (node.nodeType === Node.TEXT_NODE) {\r\n        return node.textContent || '';\r\n      }\r\n\r\n      if (node.nodeType === Node.ELEMENT_NODE) {\r\n        const el = node as HTMLElement;\r\n\r\n        if (el.dataset && el.dataset.mention) {\r\n          const userId = el.dataset.userId as string;\r\n          const userName = el.dataset.userName as string;\r\n          return `@[${userName}](${userId})`;\r\n        }\r\n\r\n        if (el.tagName === 'BR') {\r\n          return '\\n';\r\n        }\r\n\r\n        let out = '';\r\n        el.childNodes.forEach((child) => {\r\n          out += traverse(child);\r\n        });\r\n\r\n        if (BLOCK_TAGS.has(el.tagName)) {\r\n          if (out && !out.endsWith('\\n')) out += '\\n';\r\n        }\r\n\r\n        return out;\r\n      }\r\n\r\n      return '';\r\n    };\r\n\r\n    const text = traverse(editableRef.current);\r\n    return text;\r\n  }, []);\r\n\r\n  const getCursorPosition = (): number => {\r\n    const selection = window.getSelection();\r\n    if (!selection || !editableRef.current || selection.rangeCount === 0) return 0;\r\n\r\n    const range = selection.getRangeAt(0);\r\n\r\n    // Ensure the selection is actually inside our editable element\r\n    if (!editableRef.current.contains(range.commonAncestorContainer)) {\r\n      return 0;\r\n    }\r\n\r\n    try {\r\n      const preCaretRange = range.cloneRange();\r\n      preCaretRange.selectNodeContents(editableRef.current);\r\n      preCaretRange.setEnd(range.endContainer, range.endOffset);\r\n\r\n      return preCaretRange.toString().length;\r\n    } catch (error) {\r\n      console.error('Error getting cursor position:', error);\r\n      return 0;\r\n    }\r\n  };\r\n\r\n  const parseMentions = (text: string): { mentions: string[]; displayText: string } => {\r\n    const mentionRegex = /@\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\r\n    const mentions: string[] = [];\r\n    let match;\r\n\r\n    while ((match = mentionRegex.exec(text)) !== null) {\r\n      mentions.push(match[2]); // userId\r\n    }\r\n\r\n    return { mentions, displayText: text };\r\n  };\r\n\r\n  const mentionSuggestions = useMemo(() => {\r\n    const getName = (u: User | MemberInfo) => {\r\n      if (allUsersMap) {\r\n        const id = u._id || (u as unknown as { id: string }).id;\r\n        const name = allUsersMap.get(String(id));\r\n        if (name) return name;\r\n      }\r\n      return (u as unknown as User).name || (u as unknown as MemberInfo).name;\r\n    };\r\n\r\n    const usersList = activeMembers.length > 0 ? (activeMembers as unknown as User[]) : allUsers;\r\n\r\n    // Ensure current user is in the list\r\n    const currentUserId = currentUser._id;\r\n    const hasCurrentUser = usersList.some((u) => {\r\n      const id = u._id || (u as unknown as { id: string }).id;\r\n      return String(id) === String(currentUserId);\r\n    });\r\n\r\n    const finalUsersList = hasCurrentUser ? usersList : [...usersList, currentUser];\r\n\r\n    if (!mentionQuery) return finalUsersList;\r\n\r\n    const query = normalizeNoAccent(mentionQuery);\r\n    const hasDia = hasDiacritics(mentionQuery);\r\n    return finalUsersList.filter((user) => accentAwareIncludes(getName(user) || '', mentionQuery));\r\n  }, [mentionQuery, activeMembers, allUsers, currentUser, allUsersMap]);\r\n\r\n  const handleInputChangeEditable = () => {\r\n    if (!editableRef.current) return;\r\n\r\n    const text = editableRef.current.textContent || '';\r\n    const cursorPos = getCursorPosition();\r\n\r\n    const textBeforeCursor = text.slice(0, cursorPos);\r\n    const lastAtIndex = textBeforeCursor.lastIndexOf('@');\r\n\r\n    if (lastAtIndex !== -1) {\r\n      const textAfterAt = textBeforeCursor.slice(lastAtIndex + 1);\r\n\r\n      if (textAfterAt.includes(' ') || textAfterAt.includes('\\n')) {\r\n        setShowMentionMenu(false);\r\n        setMentionStartPos(null);\r\n      } else {\r\n        setShowMentionMenu(true);\r\n        setMentionQuery(textAfterAt);\r\n        setMentionStartPos(lastAtIndex);\r\n        setSelectedMentionIndex(0);\r\n      }\r\n    } else {\r\n      setShowMentionMenu(false);\r\n      setMentionStartPos(null);\r\n    }\r\n  };\r\n\r\n  const selectMention = (user: User | MemberInfo) => {\r\n    if (mentionStartPos === null || !editableRef.current) return;\r\n\r\n    const editable = editableRef.current;\r\n    const userId = user._id;\r\n    const userName = allUsersMap?.get(String(userId)) || user.name || 'User';\r\n\r\n    const cursorPos = getCursorPosition();\r\n\r\n    // T·∫°o span mention m·ªõi\r\n    const mentionSpan = document.createElement('span');\r\n    mentionSpan.contentEditable = 'false';\r\n    mentionSpan.className =\r\n      'inline-flex items-center bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-sm font-medium mx-0.5';\r\n    mentionSpan.dataset.mention = 'true';\r\n    mentionSpan.dataset.userId = userId;\r\n    mentionSpan.dataset.userName = userName;\r\n    mentionSpan.textContent = `@${userName}`;\r\n\r\n    // Helper: T·∫°o range theo v·ªã tr√≠ text (d·ª±a tr√™n textContent)\r\n    const createRangeFromOffsets = (start: number, end: number): Range | null => {\r\n      const range = document.createRange();\r\n      let current = 0;\r\n      let startNode: Node | null = null;\r\n      let startOffset = 0;\r\n      let endNode: Node | null = null;\r\n      let endOffset = 0;\r\n\r\n      const walker = (node: Node): boolean => {\r\n        if (node.nodeType === Node.TEXT_NODE) {\r\n          const text = node.textContent || '';\r\n          const next = current + text.length;\r\n\r\n          if (!startNode && start >= current && start <= next) {\r\n            startNode = node;\r\n            startOffset = start - current;\r\n          }\r\n          if (!endNode && end >= current && end <= next) {\r\n            endNode = node;\r\n            endOffset = end - current;\r\n          }\r\n\r\n          current = next;\r\n        } else {\r\n          node.childNodes.forEach((child) => {\r\n            if (!endNode) {\r\n              const done = walker(child);\r\n              if (done) return;\r\n            }\r\n          });\r\n        }\r\n\r\n        return !!endNode;\r\n      };\r\n\r\n      walker(editable);\r\n\r\n      if (!startNode || !endNode) return null;\r\n\r\n      range.setStart(startNode, startOffset);\r\n      range.setEnd(endNode, endOffset);\r\n      return range;\r\n    };\r\n\r\n    const range = createRangeFromOffsets(mentionStartPos, cursorPos);\r\n    if (!range) {\r\n      // Fallback: ch√®n mention ·ªü cu·ªëi n·∫øu kh√¥ng t√≠nh ƒë∆∞·ª£c range\r\n      editable.appendChild(mentionSpan);\r\n      const spaceNode = document.createTextNode(' ');\r\n      editable.appendChild(spaceNode);\r\n\r\n      const sel = window.getSelection();\r\n      if (sel) {\r\n        const caretRange = document.createRange();\r\n        caretRange.setStartAfter(spaceNode);\r\n        caretRange.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(caretRange);\r\n      }\r\n    } else {\r\n      // Xo√° ƒëo·∫°n @typing hi·ªán t·∫°i v√† thay b·∫±ng span mention\r\n      range.deleteContents();\r\n\r\n      const spaceNode = document.createTextNode(' ');\r\n      range.insertNode(mentionSpan);\r\n      mentionSpan.after(spaceNode);\r\n\r\n      const sel = window.getSelection();\r\n      if (sel) {\r\n        const caretRange = document.createRange();\r\n        caretRange.setStartAfter(spaceNode);\r\n        caretRange.collapse(true);\r\n        sel.removeAllRanges();\r\n        sel.addRange(caretRange);\r\n      }\r\n    }\r\n\r\n    setShowMentionMenu(false);\r\n    setMentionStartPos(null);\r\n    setMentionQuery('');\r\n\r\n    // ƒê·∫£m b·∫£o focus l·∫°i v√†o √¥ nh·∫≠p\r\n    setTimeout(() => {\r\n      editable.focus();\r\n    }, 0);\r\n  };\r\n\r\n  const handleKeyDownEditable = (e: React.KeyboardEvent<HTMLDivElement>) => {\r\n    if (showMentionMenu) {\r\n      if (e.key === 'ArrowDown') {\r\n        e.preventDefault();\r\n        setSelectedMentionIndex((prev) => Math.min(prev + 1, mentionSuggestions.length - 1));\r\n      } else if (e.key === 'ArrowUp') {\r\n        e.preventDefault();\r\n        setSelectedMentionIndex((prev) => Math.max(prev - 1, 0));\r\n      } else if (e.key === 'Enter') {\r\n        e.preventDefault();\r\n        if (mentionSuggestions[selectedMentionIndex]) {\r\n          selectMention(mentionSuggestions[selectedMentionIndex] as User | MemberInfo);\r\n        }\r\n      } else if (e.key === 'Escape') {\r\n        setShowMentionMenu(false);\r\n        setMentionStartPos(null);\r\n      }\r\n    }\r\n  };\r\n\r\n  return {\r\n    showMentionMenu,\r\n    mentionSuggestions,\r\n    selectedMentionIndex,\r\n    mentionMenuRef,\r\n    editableRef,\r\n    getPlainTextFromEditable,\r\n    parseMentions,\r\n    handleInputChangeEditable,\r\n    handleKeyDownEditable,\r\n    selectMention,\r\n    setShowMentionMenu,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 825, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatUpload.ts"],"sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\r\n'use client';\r\n\r\nimport { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { Message, MessageCreate, MessageType } from '@/types/Message';\r\nimport { ChatItem, GroupConversation } from '@/types/Group';\r\nimport { User } from '@/types/User';\r\nimport { uploadFileWithProgress, type UploadResponse } from '@/utils/uploadHelper';\r\nimport { readMessagesApi } from '@/fetch/messages';\r\nimport { setProgress, getProgress, clearProgress } from '@/lib/uploadStore';\r\n\r\nlet swReadyPromise: Promise<ServiceWorkerRegistration> | null = null;\r\nlet swListenerAttached = false;\r\nconst pendingUploads = new Map<\r\n  string,\r\n  {\r\n    resolve: (res: UploadResponse) => void;\r\n    reject: (err: unknown) => void;\r\n  }\r\n>();\r\n\r\nasync function ensureServiceWorker() {\r\n  if (typeof window === 'undefined') return null;\r\n  if (!('serviceWorker' in navigator)) return null;\r\n  if (!swReadyPromise) {\r\n    swReadyPromise = navigator.serviceWorker\r\n      .register('/sw-upload.js', { scope: '/' })\r\n      .then(() => navigator.serviceWorker.ready);\r\n  }\r\n  const reg = await swReadyPromise.catch(() => null);\r\n  if (reg && !swListenerAttached) {\r\n    swListenerAttached = true;\r\n    navigator.serviceWorker.addEventListener('message', (e: MessageEvent) => {\r\n      const data = e.data as { type?: string; uploadId?: string; response?: UploadResponse; message?: string };\r\n      if (!data || !data.type) return;\r\n      const id = String(data.uploadId || '');\r\n      const entry = pendingUploads.get(id);\r\n      if (!entry) return;\r\n      if (data.type === 'UPLOAD_COMPLETE' && data.response) {\r\n        entry.resolve(data.response);\r\n        pendingUploads.delete(id);\r\n      } else if (data.type === 'UPLOAD_FAILED') {\r\n        entry.reject(new Error(data.message || 'Upload failed'));\r\n        pendingUploads.delete(id);\r\n      }\r\n    });\r\n  }\r\n  return reg;\r\n}\r\n\r\ninterface UseChatUploadParams {\r\n  roomId: string;\r\n  currentUser: User;\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  sendMessageProcess: (msgData: MessageCreate) => Promise<void>;\r\n  setMessages: React.Dispatch<React.SetStateAction<Message[]>>;\r\n  onScrollBottom?: () => void;\r\n}\r\n\r\nexport function useChatUpload({\r\n  roomId,\r\n  currentUser,\r\n  selectedChat,\r\n  isGroup,\r\n  sendMessageProcess,\r\n  setMessages,\r\n  onScrollBottom,\r\n}: UseChatUploadParams) {\r\n  const sortMessagesAsc = (list: Message[]) => {\r\n    const safeNum = (t: unknown) => {\r\n      const n = Number(t);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n    const cmp = (a: Message, b: Message) => {\r\n      const ta = safeNum(a.timestamp);\r\n      const tb = safeNum(b.timestamp);\r\n      if (ta !== tb) return ta - tb;\r\n      const ia = String(a._id || '');\r\n      const ib = String(b._id || '');\r\n      if (ia.startsWith('temp_') && !ib.startsWith('temp_')) return 1;\r\n      if (!ia.startsWith('temp_') && ib.startsWith('temp_')) return -1;\r\n      return ia.localeCompare(ib);\r\n    };\r\n    return list.slice().sort(cmp);\r\n  };\r\n  const [uploadingFiles, setUploadingFiles] = useState<Record<string, number>>({});\r\n  const activeSourcesRef = useRef<Record<string, EventSource>>({});\r\n\r\n  type PendingItem = {\r\n    tempId: string;\r\n    uploadId: string;\r\n    type: MessageType;\r\n    fileName: string;\r\n    caption?: string;\r\n    fileUrl: string;\r\n    percent?: number;\r\n  };\r\n  const pendingKey = `pendingUploads:${roomId}`;\r\n  const readPending = (): PendingItem[] => {\r\n    try {\r\n      const raw = localStorage.getItem(pendingKey);\r\n      return raw ? (JSON.parse(raw) as PendingItem[]) : [];\r\n    } catch {\r\n      return [];\r\n    }\r\n  };\r\n  const writePending = (arr: PendingItem[]) => {\r\n    try {\r\n      localStorage.setItem(pendingKey, JSON.stringify(arr));\r\n    } catch {}\r\n  };\r\n  const addPending = (item: PendingItem) => {\r\n    const arr = readPending();\r\n    const exists = arr.some((x) => x.tempId === item.tempId);\r\n    const next = exists ? arr.map((x) => (x.tempId === item.tempId ? item : x)) : [...arr, item];\r\n    writePending(next);\r\n  };\r\n  const setPendingPercent = (tempId: string, percent: number) => {\r\n    const arr = readPending();\r\n    const next = arr.map((x) => (x.tempId === tempId ? { ...x, percent } : x));\r\n    writePending(next);\r\n  };\r\n  const removePending = (tempId: string) => {\r\n    const arr = readPending();\r\n    const next = arr.filter((x) => x.tempId !== tempId);\r\n    writePending(next);\r\n  };\r\n\r\n  const handleUploadAndSend = useCallback(\r\n    async (\r\n      file: File,\r\n      type: MessageType,\r\n      caption?: string,\r\n      replyToMessageId?: string,\r\n      mentions?: string[],\r\n      senderName?: string,\r\n      batchId?: string,\r\n      videoCropConfig?: Message['videoCropConfig'] | null,\r\n    ) => {\r\n      const sanitizeName = (name: string) => {\r\n        return name\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n          .replace(/\\s+/g, '_')\r\n          .replace(/[^a-zA-Z0-9_]/g, '');\r\n      };\r\n\r\n      const uploadId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n      const tempId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\r\n\r\n      const formData = new FormData();\r\n      formData.append('file', file);\r\n      formData.append('roomId', roomId);\r\n      formData.append('sender', currentUser._id);\r\n      if (!isGroup && '_id' in selectedChat) {\r\n        formData.append('receiver', selectedChat._id);\r\n      }\r\n      formData.append('type', type);\r\n      formData.append('fileName', file.name);\r\n      if (batchId) {\r\n        formData.append('batchId', batchId);\r\n      }\r\n\r\n      let folderNameStr = '';\r\n      if (isGroup) {\r\n        folderNameStr = `Group__${sanitizeName((selectedChat as GroupConversation).name)}`;\r\n      } else {\r\n        const myName = sanitizeName(currentUser.name || 'Me');\r\n        const partnerBaseName = '_id' in selectedChat && 'name' in selectedChat ? selectedChat.name || 'User' : 'User';\r\n        const partnerName = sanitizeName(partnerBaseName);\r\n        const names = [myName, partnerName].sort();\r\n        folderNameStr = `${names[0]}__${names[1]}`;\r\n      }\r\n      formData.append('folderName', folderNameStr);\r\n\r\n      const tempMsg: Message & { isSending?: boolean } = {\r\n        _id: tempId,\r\n        roomId,\r\n        sender: currentUser._id,\r\n        senderModel: currentUser,\r\n        batchId,\r\n        fileUrl: URL.createObjectURL(file),\r\n        fileName: file.name,\r\n        type,\r\n        timestamp: Date.now(),\r\n        content: caption,\r\n        isSending: true,\r\n      };\r\n\r\n      setMessages((prev) => sortMessagesAsc([...prev, tempMsg]));\r\n      setUploadingFiles((prev) => ({ ...prev, [tempId]: 0 }));\r\n      setProgress(tempId, 0);\r\n      addPending({\r\n        tempId,\r\n        uploadId,\r\n        type,\r\n        fileName: file.name,\r\n        caption,\r\n        fileUrl: tempMsg.fileUrl || '',\r\n        percent: 0,\r\n      });\r\n      try {\r\n        onScrollBottom?.();\r\n      } catch {}\r\n\r\n      let success = false;\r\n      let lastMessage = '';\r\n      const useSW = !!(await ensureServiceWorker());\r\n      if (useSW) {\r\n        const es =\r\n          typeof window !== 'undefined'\r\n            ? new EventSource(`/api/upload/progress?id=${encodeURIComponent(uploadId)}`)\r\n            : null;\r\n        const updatePercent = (p: number) => {\r\n          const displayed = Math.min(p, 95);\r\n          setUploadingFiles((prev) => ({ ...prev, [tempId]: displayed }));\r\n          setProgress(tempId, displayed);\r\n          setPendingPercent(tempId, displayed);\r\n        };\r\n        if (es) {\r\n          activeSourcesRef.current[uploadId] = es;\r\n          es.onmessage = (ev) => {\r\n            try {\r\n              const payload = JSON.parse((ev as MessageEvent).data) as { percent?: number; done?: boolean };\r\n              const percent = typeof payload.percent === 'number' ? payload.percent : 0;\r\n              updatePercent(percent);\r\n              const done = !!payload.done;\r\n              if (done) {\r\n                es.close();\r\n                delete activeSourcesRef.current[uploadId];\r\n              }\r\n            } catch {}\r\n          };\r\n          es.onerror = () => {\r\n            try {\r\n              es.close();\r\n              delete activeSourcesRef.current[uploadId];\r\n            } catch {}\r\n          };\r\n        }\r\n        for (let attempt = 0; attempt < 2 && !success; attempt++) {\r\n          try {\r\n            const res = await new Promise<UploadResponse>((resolve, reject) => {\r\n              pendingUploads.set(uploadId, { resolve, reject });\r\n              const controller = navigator.serviceWorker.controller;\r\n              const fields: Record<string, unknown> = {\r\n                file,\r\n                roomId,\r\n                sender: currentUser._id,\r\n                receiver: !isGroup && '_id' in selectedChat ? selectedChat._id : '',\r\n                type,\r\n                fileName: file.name,\r\n                folderName: folderNameStr,\r\n                batchId,\r\n              };\r\n              controller?.postMessage({ type: 'UPLOAD', uploadId, fields });\r\n            });\r\n            if (res.success) {\r\n              success = true;\r\n              const finalMsg = res.data;\r\n              setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n              const socketData: MessageCreate = {\r\n                ...finalMsg,\r\n                _id: res._id || res.data._id || Date.now().toString(),\r\n                roomId,\r\n                sender: currentUser._id,\r\n                senderName: senderName || currentUser.name,\r\n                isGroup,\r\n                receiver: isGroup ? null : '_id' in selectedChat ? selectedChat._id : '',\r\n                members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n                type,\r\n                timestamp: Date.now(),\r\n                content: caption,\r\n                replyToMessageId,\r\n                mentions,\r\n                batchId,\r\n                videoCropConfig: type === 'video' ? (videoCropConfig ?? null) : null,\r\n              } as unknown as MessageCreate;\r\n              await sendMessageProcess(socketData);\r\n            } else {\r\n              lastMessage = res.message || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n            }\r\n          } catch (e) {\r\n            lastMessage = (e as Error)?.message || String(e) || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n          }\r\n        }\r\n        try {\r\n          es?.close();\r\n          if (es) delete activeSourcesRef.current[uploadId];\r\n        } catch {}\r\n      } else {\r\n        for (let attempt = 0; attempt < 2 && !success; attempt++) {\r\n          try {\r\n            const res = (await uploadFileWithProgress(\r\n              `/api/upload?uploadId=${uploadId}`,\r\n              formData,\r\n              (clientRawPercent) => {\r\n                const displayed = Math.min(clientRawPercent, 95);\r\n                setUploadingFiles((prev) => ({ ...prev, [tempId]: displayed }));\r\n                setProgress(tempId, displayed);\r\n                setPendingPercent(tempId, displayed);\r\n              },\r\n            )) as UploadResponse;\r\n            if (res.success) {\r\n              success = true;\r\n              const finalMsg = res.data;\r\n              setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n              const socketData: MessageCreate = {\r\n                ...finalMsg,\r\n                _id: res._id || res.data._id || Date.now().toString(),\r\n                roomId,\r\n                sender: currentUser._id,\r\n                senderName: senderName || currentUser.name,\r\n                isGroup,\r\n                receiver: isGroup ? null : '_id' in selectedChat ? selectedChat._id : '',\r\n                members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n                type,\r\n                timestamp: Date.now(),\r\n                content: caption,\r\n                replyToMessageId,\r\n                mentions,\r\n                batchId,\r\n                videoCropConfig: type === 'video' ? (videoCropConfig ?? null) : null,\r\n              } as unknown as MessageCreate;\r\n              await sendMessageProcess(socketData);\r\n            } else {\r\n              lastMessage = res.message || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n            }\r\n          } catch (e) {\r\n            lastMessage = (e as Error)?.message || String(e) || 'Kh√¥ng x√°c ƒë·ªãnh';\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!success) {\r\n        setMessages((prev) => prev.filter((m) => m._id !== tempId));\r\n        try {\r\n          alert(`T·∫£i l√™n th·∫•t b·∫°i: ${file.name}. L√Ω do: ${lastMessage}`);\r\n        } catch {}\r\n      }\r\n\r\n      setUploadingFiles((prev) => {\r\n        const newState = { ...prev };\r\n        delete newState[tempId];\r\n        return newState;\r\n      });\r\n      clearProgress(tempId);\r\n      removePending(tempId);\r\n    },\r\n    [roomId, currentUser, isGroup, selectedChat, sendMessageProcess, setMessages, onScrollBottom],\r\n  );\r\n\r\n  useEffect(() => {\r\n    const pending = readPending();\r\n    if (pending.length === 0) return;\r\n    pending.forEach((item) => {\r\n      setMessages((prev) => {\r\n        const exists = prev.some((m) => m._id === item.tempId);\r\n        if (exists) return prev;\r\n        const msg: Message & { isSending?: boolean } = {\r\n          _id: item.tempId,\r\n          roomId,\r\n          sender: currentUser._id,\r\n          senderModel: currentUser,\r\n          type: item.type,\r\n          fileUrl: item.fileUrl,\r\n          fileName: item.fileName,\r\n          timestamp: Date.now(),\r\n          content: item.caption,\r\n          isSending: true,\r\n        };\r\n        return sortMessagesAsc([...prev, msg]);\r\n      });\r\n      const p = getProgress(item.tempId);\r\n      const percent = p >= 0 ? p : item.percent || 0;\r\n      setUploadingFiles((prev) => ({ ...prev, [item.tempId]: Math.min(percent, 95) }));\r\n      if (!activeSourcesRef.current[item.uploadId]) {\r\n        try {\r\n          const es = new EventSource(`/api/upload/progress?id=${encodeURIComponent(item.uploadId)}`);\r\n          activeSourcesRef.current[item.uploadId] = es;\r\n          es.onmessage = (ev) => {\r\n            try {\r\n              const payload = JSON.parse((ev as MessageEvent).data) as { percent?: number; done?: boolean };\r\n              const percentN = typeof payload.percent === 'number' ? payload.percent : 0;\r\n              const displayed = Math.min(percentN, 95);\r\n              setUploadingFiles((prev) => ({ ...prev, [item.tempId]: displayed }));\r\n              setProgress(item.tempId, displayed);\r\n              setPendingPercent(item.tempId, displayed);\r\n              const done = !!payload.done;\r\n              if (done) {\r\n                es.close();\r\n                delete activeSourcesRef.current[item.uploadId];\r\n                setUploadingFiles((prev) => {\r\n                  const next = { ...prev };\r\n                  delete next[item.tempId];\r\n                  return next;\r\n                });\r\n                setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n                clearProgress(item.tempId);\r\n                removePending(item.tempId);\r\n                (async () => {\r\n                  try {\r\n                    const resp = await readMessagesApi(roomId, {\r\n                      limit: 1,\r\n                      sortOrder: 'desc',\r\n                      extraFilters: { uploadId: item.uploadId },\r\n                    });\r\n                    const list = (resp?.data as Message[]) || [];\r\n                    const match = list[0];\r\n                    if (match) {\r\n                      setMessages((prev) => {\r\n                        const exists = prev.some((mm) => String(mm._id) === String(match._id));\r\n                        return exists ? prev : [...prev, match];\r\n                      });\r\n                    }\r\n                  } catch {}\r\n                })();\r\n              }\r\n            } catch {}\r\n          };\r\n          es.onerror = () => {\r\n            try {\r\n              es.close();\r\n              delete activeSourcesRef.current[item.uploadId];\r\n            } catch {}\r\n          };\r\n        } catch {}\r\n      }\r\n    });\r\n    setTimeout(() => {\r\n      const again = readPending();\r\n      again.forEach((item) => {\r\n        setMessages((prev) => {\r\n          const exists = prev.some((m) => m._id === item.tempId);\r\n          if (exists) return prev;\r\n          const msg: Message & { isSending?: boolean } = {\r\n            _id: item.tempId,\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderModel: currentUser,\r\n            type: item.type,\r\n            fileUrl: item.fileUrl,\r\n            fileName: item.fileName,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            isSending: true,\r\n          };\r\n          return sortMessagesAsc([...prev, msg]);\r\n        });\r\n      });\r\n    }, 600);\r\n    setTimeout(() => {\r\n      const again = readPending();\r\n      again.forEach((item) => {\r\n        setMessages((prev) => {\r\n          const exists = prev.some((m) => m._id === item.tempId);\r\n          if (exists) return prev;\r\n          const msg: Message & { isSending?: boolean } = {\r\n            _id: item.tempId,\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderModel: currentUser,\r\n            type: item.type,\r\n            fileUrl: item.fileUrl,\r\n            fileName: item.fileName,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            isSending: true,\r\n          };\r\n          return sortMessagesAsc([...prev, msg]);\r\n        });\r\n      });\r\n    }, 1500);\r\n    return () => {\r\n      Object.values(activeSourcesRef.current).forEach((es) => {\r\n        try {\r\n          es.close();\r\n        } catch {}\r\n      });\r\n      activeSourcesRef.current = {};\r\n    };\r\n  }, [roomId, currentUser, setMessages]);\r\n\r\n  useEffect(() => {\r\n    const onSwMessage = async (e: MessageEvent) => {\r\n      const data = e.data as { type?: string; uploadId?: string; response?: UploadResponse; message?: string };\r\n      if (!data || !data.type) return;\r\n      const id = String(data.uploadId || '');\r\n      if (!id) return;\r\n      const arr = readPending();\r\n      const item = arr.find((x) => x.uploadId === id);\r\n      if (!item) return;\r\n      if (data.type === 'UPLOAD_COMPLETE' && data.response) {\r\n        const res = data.response as UploadResponse;\r\n        if (res.success) {\r\n          setUploadingFiles((prev) => {\r\n            const next = { ...prev };\r\n            delete next[item.tempId];\r\n            return next;\r\n          });\r\n          setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n          clearProgress(item.tempId);\r\n          removePending(item.tempId);\r\n          const finalMsg = res.data;\r\n          const socketData: MessageCreate = {\r\n            ...finalMsg,\r\n            _id: finalMsg._id || Date.now().toString(),\r\n            roomId,\r\n            sender: currentUser._id,\r\n            senderName: currentUser.name,\r\n            isGroup,\r\n            receiver: isGroup ? null : '_id' in selectedChat ? (selectedChat as User)._id : '',\r\n            members: isGroup ? (selectedChat as GroupConversation).members : [],\r\n            type: item.type,\r\n            timestamp: Date.now(),\r\n            content: item.caption,\r\n            batchId: (finalMsg as unknown as { batchId?: string }).batchId,\r\n          } as unknown as MessageCreate;\r\n          try {\r\n            await sendMessageProcess(socketData);\r\n          } catch {}\r\n        } else {\r\n          setUploadingFiles((prev) => {\r\n            const next = { ...prev };\r\n            delete next[item.tempId];\r\n            return next;\r\n          });\r\n          setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n          clearProgress(item.tempId);\r\n          removePending(item.tempId);\r\n        }\r\n      } else if (data.type === 'UPLOAD_FAILED') {\r\n        setUploadingFiles((prev) => {\r\n          const next = { ...prev };\r\n          delete next[item.tempId];\r\n          return next;\r\n        });\r\n        setMessages((prev) => prev.filter((m) => m._id !== item.tempId));\r\n        clearProgress(item.tempId);\r\n        removePending(item.tempId);\r\n      }\r\n    };\r\n    if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {\r\n      navigator.serviceWorker.addEventListener('message', onSwMessage);\r\n    }\r\n    return () => {\r\n      if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {\r\n        navigator.serviceWorker.removeEventListener('message', onSwMessage);\r\n      }\r\n    };\r\n  }, [roomId, currentUser, selectedChat, isGroup, sendMessageProcess, setMessages]);\r\n\r\n  return {\r\n    uploadingFiles,\r\n    handleUploadAndSend,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1512, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatVoiceInput.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useRef, useState } from 'react';\r\nimport { insertTextAtCursor } from '@/utils/chatInput';\r\n\r\ninterface UseChatVoiceInputParams {\r\n  editableRef: React.RefObject<HTMLDivElement | null>;\r\n  handleInputChangeEditable: () => void;\r\n}\r\n\r\nexport function useChatVoiceInput({ editableRef, handleInputChangeEditable }: UseChatVoiceInputParams) {\r\n  const [isListening, setIsListening] = useState(false);\r\n  const recognitionRef = useRef<SpeechRecognitionInstance | null>(null);\r\n\r\n  const handleVoiceInput = useCallback(async () => {\r\n    const SpeechRecognition =\r\n      typeof window !== 'undefined' ? window.SpeechRecognition || window.webkitSpeechRecognition : null;\r\n\r\n    if (!SpeechRecognition) {\r\n      alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng n√†y. Vui l√≤ng d√πng Chrome ho·∫∑c Edge.');\r\n      return;\r\n    }\r\n\r\n    if (isListening) {\r\n      if (recognitionRef.current) {\r\n        recognitionRef.current.stop();\r\n      }\r\n      setIsListening(false);\r\n      return;\r\n    }\r\n\r\n    const isLocal =\r\n      typeof window !== 'undefined' &&\r\n      (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\r\n    const isSecure =\r\n      typeof window !== 'undefined' && (window.isSecureContext || window.location.protocol === 'https:');\r\n    if (!isSecure && !isLocal) {\r\n      alert('Vui l√≤ng truy c·∫≠p qua HTTPS ho·∫∑c localhost ƒë·ªÉ s·ª≠ d·ª•ng nh·∫≠p b·∫±ng gi·ªçng n√≥i.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (typeof navigator !== 'undefined' && navigator.mediaDevices?.getUserMedia) {\r\n        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n        stream.getTracks().forEach((t) => t.stop());\r\n      }\r\n    } catch {\r\n      alert('Vui l√≤ng c·∫•p quy·ªÅn microphone cho tr√¨nh duy·ªát ƒë·ªÉ s·ª≠ d·ª•ng nh·∫≠p b·∫±ng gi·ªçng n√≥i.');\r\n      return;\r\n    }\r\n\r\n    const recognition = new SpeechRecognition();\r\n    recognition.lang = 'vi-VN';\r\n    recognition.continuous = false;\r\n    recognition.interimResults = false;\r\n\r\n    recognition.onstart = () => {\r\n      setIsListening(true);\r\n    };\r\n\r\n    recognition.onend = () => {\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognition.onresult = (event: SpeechRecognitionEventLike) => {\r\n      const transcript = event.results[0][0].transcript;\r\n      const el = editableRef.current;\r\n      if (el) {\r\n        el.focus();\r\n        insertTextAtCursor(el, transcript);\r\n        handleInputChangeEditable();\r\n      }\r\n    };\r\n\r\n    recognition.onerror = (event: SpeechRecognitionEventLike) => {\r\n      if ((event.error || '').toLowerCase() === 'not-allowed') {\r\n        alert('Truy c·∫≠p microphone b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.');\r\n      }\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognitionRef.current = recognition;\r\n    recognition.start();\r\n  }, [isListening, editableRef, handleInputChangeEditable]);\r\n\r\n  return {\r\n    isListening,\r\n    handleVoiceInput,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;;AAHA;;;AAUO,SAAS,kBAAkB,EAAE,WAAW,EAAE,yBAAyB,EAA2B;;IACnG,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAC/C,MAAM,iBAAiB,IAAA,uKAAM,EAAmC;IAEhE,MAAM,mBAAmB,IAAA,4KAAW;2DAAC;YACnC,MAAM,oBACJ,uCAAgC,OAAO,iBAAiB,IAAI,OAAO,uBAAuB,GAAG;YAE/F,IAAI,CAAC,mBAAmB;gBACtB,MAAM;gBACN;YACF;YAEA,IAAI,aAAa;gBACf,IAAI,eAAe,OAAO,EAAE;oBAC1B,eAAe,OAAO,CAAC,IAAI;gBAC7B;gBACA,eAAe;gBACf;YACF;YAEA,MAAM,UACJ,+CAAkB,eAClB,CAAC,OAAO,QAAQ,CAAC,QAAQ,KAAK,eAAe,OAAO,QAAQ,CAAC,QAAQ,KAAK,WAAW;YACvF,MAAM,WACJ,+CAAkB,eAAe,CAAC,OAAO,eAAe,IAAI,OAAO,QAAQ,CAAC,QAAQ,KAAK,QAAQ;YACnG,IAAI,CAAC,YAAY,CAAC,SAAS;gBACzB,MAAM;gBACN;YACF;YAEA,IAAI;gBACF,IAAI,OAAO,cAAc,eAAe,UAAU,YAAY,EAAE,cAAc;oBAC5E,MAAM,SAAS,MAAM,UAAU,YAAY,CAAC,YAAY,CAAC;wBAAE,OAAO;oBAAK;oBACvE,OAAO,SAAS,GAAG,OAAO;2EAAC,CAAC,IAAM,EAAE,IAAI;;gBAC1C;YACF,EAAE,OAAM;gBACN,MAAM;gBACN;YACF;YAEA,MAAM,cAAc,IAAI;YACxB,YAAY,IAAI,GAAG;YACnB,YAAY,UAAU,GAAG;YACzB,YAAY,cAAc,GAAG;YAE7B,YAAY,OAAO;mEAAG;oBACpB,eAAe;gBACjB;;YAEA,YAAY,KAAK;mEAAG;oBAClB,eAAe;gBACjB;;YAEA,YAAY,QAAQ;mEAAG,CAAC;oBACtB,MAAM,aAAa,MAAM,OAAO,CAAC,EAAE,CAAC,EAAE,CAAC,UAAU;oBACjD,MAAM,KAAK,YAAY,OAAO;oBAC9B,IAAI,IAAI;wBACN,GAAG,KAAK;wBACR,IAAA,kJAAkB,EAAC,IAAI;wBACvB;oBACF;gBACF;;YAEA,YAAY,OAAO;mEAAG,CAAC;oBACrB,IAAI,CAAC,MAAM,KAAK,IAAI,EAAE,EAAE,WAAW,OAAO,eAAe;wBACvD,MAAM;oBACR;oBACA,eAAe;gBACjB;;YAEA,eAAe,OAAO,GAAG;YACzB,YAAY,KAAK;QACnB;0DAAG;QAAC;QAAa;QAAa;KAA0B;IAExD,OAAO;QACL;QACA;IACF;AACF;GA/EgB"}},
    {"offset": {"line": 1613, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useChatMembers.ts"],"sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\r\n'use client';\r\n\r\nimport { useCallback, useEffect, useState } from 'react';\r\nimport type { User } from '@/types/User';\r\nimport type { ChatItem, GroupConversation, MemberInfo } from '@/types/Group';\r\n\r\ninterface UseChatMembersParams {\r\n  selectedChat: ChatItem;\r\n  isGroup: boolean;\r\n  currentUser: User;\r\n  sendNotifyMessage: (text: string) => Promise<void>;\r\n}\r\n\r\nexport function useChatMembers({ selectedChat, isGroup, currentUser, sendNotifyMessage }: UseChatMembersParams) {\r\n  const [memberCount, setMemberCount] = useState(0);\r\n  const [activeMembers, setActiveMembers] = useState<MemberInfo[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (isGroup && (selectedChat as GroupConversation).members) {\r\n      const m = (selectedChat as GroupConversation).members as MemberInfo[];\r\n      setActiveMembers(m);\r\n      setMemberCount(m.length);\r\n    } else {\r\n      setActiveMembers([]);\r\n      setMemberCount(0);\r\n    }\r\n  }, [selectedChat, isGroup]);\r\n\r\n  const handleMemberRemoved = useCallback(\r\n    async (removedMemberId: string, removedMemberName: string) => {\r\n      setActiveMembers((prev) => prev.filter((m) => String(m._id) !== String(removedMemberId)));\r\n      setMemberCount((prev) => Math.max(0, prev - 1));\r\n\r\n      const myName = currentUser.name || 'Qu·∫£n tr·ªã vi√™n';\r\n      await sendNotifyMessage(`${myName} ƒë√£ m·ªùi ${removedMemberName} ra kh·ªèi nh√≥m.`);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  const handleRoleChange = useCallback(\r\n    async (memberId: string, memberName: string, newRole: 'ADMIN' | 'MEMBER') => {\r\n      setActiveMembers((prev) =>\r\n        prev.map((m) => {\r\n          if (String(m._id) === String(memberId)) {\r\n            return { ...m, role: newRole };\r\n          }\r\n          return m;\r\n        }),\r\n      );\r\n\r\n      const myName = currentUser.name || 'Qu·∫£n tr·ªã vi√™n';\r\n      let actionText = '';\r\n\r\n      if (newRole === 'ADMIN') {\r\n        actionText = `ƒë√£ b·ªï nhi·ªám ${memberName} l√†m ph√≥ nh√≥m.`;\r\n      } else {\r\n        actionText = `ƒë√£ h·ªßy quy·ªÅn ph√≥ nh√≥m c·ªßa ${memberName}.`;\r\n      }\r\n\r\n      await sendNotifyMessage(`${myName} ${actionText}`);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  const handleMembersAdded = useCallback(\r\n    async (newUsers: User[]) => {\r\n      if (!newUsers || newUsers.length === 0) return;\r\n\r\n      const newMembersFormatted: MemberInfo[] = newUsers.map((u) => ({\r\n        _id: u._id,\r\n        name: u.name || 'Th√†nh vi√™n',\r\n        avatar: u.avatar,\r\n        role: 'MEMBER',\r\n        joinedAt: Date.now(),\r\n      }));\r\n\r\n      setActiveMembers((prev) => [...prev, ...newMembersFormatted]);\r\n      setMemberCount((prev) => prev + newUsers.length);\r\n    },\r\n    [currentUser.name, sendNotifyMessage],\r\n  );\r\n\r\n  return {\r\n    memberCount,\r\n    activeMembers,\r\n    handleMemberRemoved,\r\n    handleRoleChange,\r\n    handleMembersAdded,\r\n  };\r\n}\r\n"],"names":[],"mappings":"AAAA,8CAA8C;;;;AAG9C;;AAFA;;AAaO,SAAS,eAAe,EAAE,YAAY,EAAE,OAAO,EAAE,WAAW,EAAE,iBAAiB,EAAwB;;IAC5G,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAC/C,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAe,EAAE;IAEnE,IAAA,0KAAS;oCAAC;YACR,IAAI,WAAW,AAAC,aAAmC,OAAO,EAAE;gBAC1D,MAAM,IAAI,AAAC,aAAmC,OAAO;gBACrD,iBAAiB;gBACjB,eAAe,EAAE,MAAM;YACzB,OAAO;gBACL,iBAAiB,EAAE;gBACnB,eAAe;YACjB;QACF;mCAAG;QAAC;QAAc;KAAQ;IAE1B,MAAM,sBAAsB,IAAA,4KAAW;2DACrC,OAAO,iBAAyB;YAC9B;mEAAiB,CAAC,OAAS,KAAK,MAAM;2EAAC,CAAC,IAAM,OAAO,EAAE,GAAG,MAAM,OAAO;;;YACvE;mEAAe,CAAC,OAAS,KAAK,GAAG,CAAC,GAAG,OAAO;;YAE5C,MAAM,SAAS,YAAY,IAAI,IAAI;YACnC,MAAM,kBAAkB,GAAG,OAAO,QAAQ,EAAE,kBAAkB,cAAc,CAAC;QAC/E;0DACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,MAAM,mBAAmB,IAAA,4KAAW;wDAClC,OAAO,UAAkB,YAAoB;YAC3C;gEAAiB,CAAC,OAChB,KAAK,GAAG;wEAAC,CAAC;4BACR,IAAI,OAAO,EAAE,GAAG,MAAM,OAAO,WAAW;gCACtC,OAAO;oCAAE,GAAG,CAAC;oCAAE,MAAM;gCAAQ;4BAC/B;4BACA,OAAO;wBACT;;;YAGF,MAAM,SAAS,YAAY,IAAI,IAAI;YACnC,IAAI,aAAa;YAEjB,IAAI,YAAY,SAAS;gBACvB,aAAa,CAAC,YAAY,EAAE,WAAW,cAAc,CAAC;YACxD,OAAO;gBACL,aAAa,CAAC,0BAA0B,EAAE,WAAW,CAAC,CAAC;YACzD;YAEA,MAAM,kBAAkB,GAAG,OAAO,CAAC,EAAE,YAAY;QACnD;uDACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,MAAM,qBAAqB,IAAA,4KAAW;0DACpC,OAAO;YACL,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;YAExC,MAAM,sBAAoC,SAAS,GAAG;sFAAC,CAAC,IAAM,CAAC;wBAC7D,KAAK,EAAE,GAAG;wBACV,MAAM,EAAE,IAAI,IAAI;wBAChB,QAAQ,EAAE,MAAM;wBAChB,MAAM;wBACN,UAAU,KAAK,GAAG;oBACpB,CAAC;;YAED;kEAAiB,CAAC,OAAS;2BAAI;2BAAS;qBAAoB;;YAC5D;kEAAe,CAAC,OAAS,OAAO,SAAS,MAAM;;QACjD;yDACA;QAAC,YAAY,IAAI;QAAE;KAAkB;IAGvC,OAAO;QACL;QACA;QACA;QACA;QACA;IACF;AACF;GA5EgB"}},
    {"offset": {"line": 1727, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ching/OneDrive/Desktop/Chat-Hupuna/hupuna-chat/src/hooks/useHomePage.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport io, { type Socket } from 'socket.io-client';\r\n\r\nimport { User } from '@/types/User';\r\nimport { ChatItem, GroupConversation } from '@/types/Group';\r\nimport type { Message } from '@/types/Message';\r\n\r\ndeclare global {\r\n  interface Window {\r\n    __globalReminderSchedulerActive?: boolean;\r\n  }\r\n}\r\nimport type { GlobalSearchMessage, GlobalSearchContact } from '@/components/(home)/HomeOverlays'; // C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n n·∫øu c·∫ßn // C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n n·∫øu c·∫ßn\r\n\r\n// Ki·ªÉu d·ªØ li·ªáu cho b·∫£n ghi tin nh·∫Øn tr·∫£ v·ªÅ t·ª´ API globalSearch\r\ninterface GlobalSearchMessageApi {\r\n  _id: string;\r\n  content: string;\r\n  type: string;\r\n  fileName?: string;\r\n  timestamp: number;\r\n  sender: string;\r\n  senderName?: string;\r\n  roomId: string;\r\n  roomName?: string;\r\n  isGroupChat?: boolean;\r\n  partnerId?: string;\r\n  partnerName?: string;\r\n  fileUrl?: string;\r\n  receiver?: string;\r\n  displayRoomName?: string;\r\n}\r\n\r\nimport { resolveSocketUrl, normalizeNoAccent } from '@/utils/utils';\r\nimport { useChatNotifications } from '@/hooks/useChatNotifications';\r\n\r\nexport function useHomePage(config?: { onlyGroups?: boolean; onlyPersonal?: boolean }) {\r\n  const router = useRouter();\r\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { playMessageSound } = useChatNotifications({});\r\n\r\n  // State qu·∫£n l√Ω d·ªØ li·ªáu\r\n  const [allUsers, setAllUsers] = useState<User[]>([]);\r\n  const allUsersRef = useRef<User[]>([]);\r\n  const [groups, setGroups] = useState<GroupConversation[]>([]);\r\n  const [selectedChat, setSelectedChat] = useState<ChatItem | null>(null);\r\n  const selectedChatRef = useRef<ChatItem | null>(null);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [showCreateGroupModal, setShowCreateGroupModal] = useState(false);\r\n  const socketRef = useRef<Socket | null>(null);\r\n\r\n  const [showGlobalSearchModal, setShowGlobalSearchModal] = useState(false);\r\n  const [globalSearchTerm, setGlobalSearchTerm] = useState('');\r\n  const [globalSearchResults, setGlobalSearchResults] = useState<{\r\n    contacts: GlobalSearchContact[];\r\n    messages: GlobalSearchMessage[];\r\n  }>({\r\n    contacts: [],\r\n    messages: [],\r\n  });\r\n\r\n  const [scrollToMessageId, setScrollToMessageId] = useState<string | null>(null);\r\n  const [roomSearchKeyword, setRoomSearchKeyword] = useState<string | null>(null);\r\n  const reminderTimersRef = useRef<Map<string, number>>(new Map());\r\n  const scheduledReminderIdsRef = useRef<Set<string>>(new Set());\r\n\r\n  // üî• ƒê·ªìng b·ªô searchTerm t·ª´ sidebar sang globalSearchTerm\r\n  useEffect(() => {\r\n    setGlobalSearchTerm(searchTerm);\r\n  }, [searchTerm]);\r\n\r\n  useEffect(() => {\r\n    allUsersRef.current = allUsers;\r\n  }, [allUsers]);\r\n\r\n  // 1. H√†m Fetch Data (User & Group)\r\n  const fetchAllData = useCallback(async () => {\r\n    if (!currentUser) return;\r\n\r\n    // Fetch Users\r\n    try {\r\n      const res = await fetch('/api/users', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: 'read', currentUserId: currentUser._id }),\r\n      });\r\n      const data = await res.json();\r\n      const list = Array.isArray(data) ? data : data.data || [];\r\n      setAllUsers(list.filter((u: User) => u._id !== currentUser._id));\r\n    } catch (e) {\r\n      console.error('Fetch users error:', e);\r\n    }\r\n\r\n    // Fetch Groups\r\n    try {\r\n      const res = await fetch('/api/groups', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: 'readGroups', _id: currentUser._id }),\r\n      });\r\n      const data = await res.json();\r\n\r\n      if (data.data) {\r\n        setGroups(data.data);\r\n\r\n        // ƒê·ªìng b·ªô l·∫°i selectedChat (n·∫øu ƒëang m·ªü 1 group) v·ªõi d·ªØ li·ªáu m·ªõi nh·∫•t\r\n        setSelectedChat((prev) => {\r\n          if (!prev) return prev;\r\n\r\n          // Ch·ªâ √°p d·ª•ng cho nh√≥m, chat 1-1 s·∫Ω kh√¥ng c√≥ trong danh s√°ch groups\r\n          const maybeGroup = prev as GroupConversation;\r\n          const isGroupChat = maybeGroup.isGroup === true || Array.isArray(maybeGroup.members);\r\n          if (!isGroupChat) return prev;\r\n\r\n          const updated = data.data.find((g: GroupConversation) => g._id === maybeGroup._id);\r\n          // N·∫øu kh√¥ng t√¨m th·∫•y nh√≥m trong danh s√°ch m·ªõi (c√≥ th·ªÉ ƒë√£ b·ªã gi·∫£i t√°n), x√≥a selectedChat\r\n          if (!updated) {\r\n            return null;\r\n          }\r\n          return updated;\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Fetch groups error:', e);\r\n    }\r\n  }, [currentUser]);\r\n\r\n  // H√†m x·ª≠ l√Ω ch·ªçn Chat (Optimistic Update - X√≥a badge)\r\n  const handleSelectChat = useCallback((item: ChatItem) => {\r\n    setSelectedChat(item);\r\n    selectedChatRef.current = item;\r\n\r\n    if ((item as GroupConversation).isGroup || (item as GroupConversation).members) {\r\n      setGroups((prev) => prev.map((g) => (g._id === item._id ? { ...g, unreadCount: 0 } : g)));\r\n    } else {\r\n      setAllUsers((prev) => prev.map((u) => (u._id === item._id ? { ...u, unreadCount: 0 } : u)));\r\n    }\r\n  }, []);\r\n\r\n  const handleSelectContact = useCallback(\r\n    (contact: GlobalSearchContact) => {\r\n      setShowGlobalSearchModal(false);\r\n      setScrollToMessageId(null);\r\n\r\n      // T√¨m contact ƒë·∫ßy ƒë·ªß t·ª´ allUsers ho·∫∑c groups\r\n      let fullContact: ChatItem | null = null;\r\n      if (contact.isGroup) {\r\n        fullContact = groups.find((g) => g._id === contact._id) ?? null;\r\n      } else {\r\n        fullContact = allUsers.find((u) => u._id === contact._id) ?? null;\r\n      }\r\n\r\n      if (fullContact) {\r\n        // Ch·ªçn chat b·∫±ng h√†m ƒë√£ t·ªëi ∆∞u\r\n        handleSelectChat(fullContact);\r\n      } else {\r\n        console.warn('Contact not found:', contact._id);\r\n      }\r\n    },\r\n    [groups, allUsers, handleSelectChat],\r\n  );\r\n\r\n  const handleGlobalSearch = useCallback(\r\n    async (term: string) => {\r\n      setGlobalSearchTerm(term);\r\n\r\n      if (!term.trim() || !currentUser) {\r\n        setGlobalSearchResults({ contacts: [], messages: [] });\r\n        return;\r\n      }\r\n\r\n      const lowerCaseTerm = normalizeNoAccent(term);\r\n\r\n      // 1. L·ªçc li√™n h·ªá/nh√≥m (Local - Instant)\r\n      let allChats = [...groups, ...allUsers];\r\n      if (config?.onlyGroups) {\r\n        allChats = [...groups];\r\n      } else if (config?.onlyPersonal) {\r\n        allChats = [...allUsers];\r\n      }\r\n\r\n      const myId = String(currentUser._id);\r\n      const contactResults: GlobalSearchContact[] = allChats\r\n        .map((c) => {\r\n          const isGroup = (c as GroupConversation).isGroup || !!(c as GroupConversation).members;\r\n          let displayName = String(c.name || '').trim();\r\n          if (!isGroup) {\r\n            const u = c as User;\r\n            if (u.nicknames?.[myId]) {\r\n              displayName = String(u.nicknames[myId]).trim() || displayName || String(u.username || 'Ng∆∞·ªùi d√πng');\r\n            } else {\r\n              displayName = String(u.name || u.username || 'Ng∆∞·ªùi d√πng').trim();\r\n            }\r\n          }\r\n          return { contact: c, isGroup, displayName };\r\n        })\r\n        .filter(({ contact, displayName }) => {\r\n          if (contact.isHidden) return false;\r\n          return normalizeNoAccent(displayName).includes(lowerCaseTerm);\r\n        })\r\n        .map(({ contact, isGroup, displayName }) => ({\r\n          _id: contact._id,\r\n          name: displayName,\r\n          avatar: contact.avatar,\r\n          isGroup,\r\n        }))\r\n        .slice(0, 10); // Gi·ªõi h·∫°n 10 k·∫øt qu·∫£\r\n\r\n      // 2. G·ªçi API t√¨m ki·∫øm tin nh·∫Øn (Backend)\r\n      try {\r\n        const res = await fetch('/api/messages', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            action: 'globalSearch',\r\n            data: {\r\n              userId: currentUser._id,\r\n              searchTerm: term,\r\n              limit: 50,\r\n            },\r\n          }),\r\n        });\r\n\r\n        const messageData = await res.json();\r\n        const allMessages = (messageData.data || []) as GlobalSearchMessageApi[];\r\n\r\n        const messages: GlobalSearchMessage[] = allMessages\r\n          .filter((msg: GlobalSearchMessageApi) =>\r\n            ['text', 'image', 'file', 'sticker', 'video', 'reminder'].includes(msg.type),\r\n          )\r\n          .filter((msg) => !config?.onlyGroups || msg.isGroupChat)\r\n          .map((msg: GlobalSearchMessageApi) => ({\r\n            _id: msg._id,\r\n            content: msg.content,\r\n            type: msg.type as 'text' | 'image' | 'file' | 'sticker' | 'video' | 'reminder',\r\n            fileName: msg.fileName,\r\n            timestamp: msg.timestamp,\r\n            sender: msg.sender,\r\n            senderName: msg.senderName || '',\r\n            roomId: msg.roomId,\r\n            roomName: msg.roomName || '',\r\n            isGroupChat: msg.isGroupChat || false,\r\n            partnerId: msg.partnerId,\r\n            partnerName: msg.partnerName,\r\n            fileUrl: msg.fileUrl,\r\n            receiver: msg.receiver,\r\n            displayRoomName: msg.displayRoomName,\r\n          }));\r\n\r\n        setGlobalSearchResults({\r\n          contacts: contactResults,\r\n          messages,\r\n        });\r\n      } catch (e) {\r\n        console.error('Global search API error:', e);\r\n        setGlobalSearchResults({ contacts: contactResults, messages: [] });\r\n      }\r\n    },\r\n    [currentUser, groups, allUsers, config?.onlyGroups, config?.onlyPersonal],\r\n  );\r\n\r\n  const getSocketBaseForRoom = useCallback(\r\n    (roomId: string) => {\r\n      const isGroupChat = groups.some((g) => String(g._id) === String(roomId));\r\n      if (isGroupChat) {\r\n        const g = groups.find((x) => String(x._id) === String(roomId)) as GroupConversation | undefined;\r\n        const members = g ? g.members : [];\r\n        return {\r\n          roomId,\r\n          sender: String(currentUser?._id || ''),\r\n          senderName: currentUser?.name || '',\r\n          isGroup: true,\r\n          receiver: null,\r\n          members,\r\n        };\r\n      }\r\n      let receiver: string | null = null;\r\n      if (roomId.includes('_')) {\r\n        const parts = roomId.split('_');\r\n        receiver = parts[0] === String(currentUser?._id || '') ? parts[1] : parts[0];\r\n      }\r\n      return {\r\n        roomId,\r\n        sender: String(currentUser?._id || ''),\r\n        senderName: currentUser?.name || '',\r\n        isGroup: false,\r\n        receiver,\r\n        members: [],\r\n      };\r\n    },\r\n    [groups, currentUser],\r\n  );\r\n\r\n  const scheduleReminder = useCallback(\r\n    (msg: Message) => {\r\n      const idStr = String(msg._id);\r\n      if (scheduledReminderIdsRef.current.has(idStr)) return;\r\n      const at = (msg as Message & { reminderAt?: number }).reminderAt || msg.timestamp;\r\n      const now = Date.now();\r\n      const delay = Math.max(0, at - now);\r\n      scheduledReminderIdsRef.current.add(idStr);\r\n      const timerId = window.setTimeout(async () => {\r\n        try {\r\n          const res = await fetch('/api/messages', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              action: 'fireReminder',\r\n              messageId: msg._id,\r\n              userId: String(currentUser?._id || ''),\r\n            }),\r\n          });\r\n          const json = await res.json();\r\n          const sockBase = getSocketBaseForRoom(String(msg.roomId));\r\n          if (json?.success && json?.updated && typeof json?.notifyId === 'string') {\r\n            socketRef.current?.emit('send_message', {\r\n              ...sockBase,\r\n              _id: json.notifyId,\r\n              type: 'notify',\r\n              content: `ƒê·∫øn gi·ªù l·ªãch h·∫πn: \"${msg.content || ''}\"`,\r\n              timestamp: Date.now(),\r\n              replyToMessageId: String(msg._id),\r\n            });\r\n          }\r\n          if (json?.nextAt) {\r\n            socketRef.current?.emit('edit_message', {\r\n              _id: msg._id,\r\n              roomId: msg.roomId,\r\n              content: msg.content,\r\n              newContent: msg.content,\r\n              editedAt: Date.now(),\r\n              originalContent: msg.originalContent || msg.content,\r\n              reminderAt: json.nextAt,\r\n              reminderNote: (msg as Message & { reminderNote?: string }).reminderNote,\r\n            });\r\n          }\r\n        } catch {}\r\n        scheduledReminderIdsRef.current.delete(idStr);\r\n        const t = reminderTimersRef.current.get(idStr);\r\n        if (t) reminderTimersRef.current.delete(idStr);\r\n      }, delay);\r\n      reminderTimersRef.current.set(idStr, timerId);\r\n    },\r\n    [currentUser, getSocketBaseForRoom],\r\n  );\r\n\r\n  const fetchAndScheduleReminders = useCallback(async () => {\r\n    if (!currentUser) return;\r\n    try {\r\n      const res = await fetch('/api/messages', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          action: 'readReminders',\r\n          data: { userId: currentUser._id, limit: 5000, untilTs: Date.now() + 30 * 24 * 60 * 60 * 1000 },\r\n        }),\r\n      });\r\n      const json = await res.json();\r\n      const items: Message[] = Array.isArray(json?.data) ? (json.data as Message[]) : [];\r\n      items.forEach((m) => scheduleReminder(m));\r\n    } catch {}\r\n  }, [currentUser, scheduleReminder]);\r\n\r\n  useEffect(() => {\r\n    if (!currentUser) return;\r\n    if (typeof window !== 'undefined') {\r\n      window.__globalReminderSchedulerActive = true;\r\n    }\r\n    void fetchAndScheduleReminders();\r\n    const iv = setInterval(() => void fetchAndScheduleReminders(), 60000);\r\n    return () => {\r\n      clearInterval(iv);\r\n      if (typeof window !== 'undefined') {\r\n        window.__globalReminderSchedulerActive = false;\r\n      }\r\n    };\r\n  }, [currentUser, fetchAndScheduleReminders]);\r\n\r\n  // üî• H√ÄM M·ªû / ƒê√ìNG MODAL T√åM KI·∫æM TO√ÄN C·ª§C (TOGGLE)\r\n  const handleOpenGlobalSearch = useCallback(() => {\r\n    setShowGlobalSearchModal((prev) => {\r\n      const next = !prev;\r\n      if (next) {\r\n        // Khi m·ªü modal, sync searchTerm t·ª´ sidebar sang globalSearchTerm n·∫øu c√≥\r\n        // Ch·ªâ reset n·∫øu kh√¥ng c√≥ searchTerm t·ª´ sidebar\r\n        if (!searchTerm.trim()) {\r\n          setGlobalSearchTerm('');\r\n          setGlobalSearchResults({ contacts: [], messages: [] });\r\n        } else {\r\n          // N·∫øu c√≥ searchTerm t·ª´ sidebar, sync v√† trigger search\r\n          setGlobalSearchTerm(searchTerm);\r\n          handleGlobalSearch(searchTerm);\r\n        }\r\n      }\r\n      return next;\r\n    });\r\n  }, [searchTerm, handleGlobalSearch]);\r\n\r\n  // Thay th·∫ø h√†m handleNavigateToMessage trong useHomePage.ts\r\n  const handleNavigateToMessage = useCallback(\r\n    (message: GlobalSearchMessage, searchKeyword?: string) => {\r\n      let targetChat: ChatItem | null = null;\r\n      const myId = String(currentUser?._id);\r\n\r\n      // 1. T√¨m chat target\r\n      if (message.isGroupChat === true && message.roomId) {\r\n        targetChat = groups.find((g) => String(g._id) === String(message.roomId)) ?? null;\r\n      } else if (message.isGroupChat === false) {\r\n        let partnerId: string | null = null;\r\n        if (message.partnerId) {\r\n          partnerId = String(message.partnerId);\r\n        } else if (message.roomId && message.roomId.includes('_')) {\r\n          const parts = message.roomId.split('_');\r\n          partnerId = parts[0] === myId ? parts[1] : parts[0];\r\n        } else {\r\n          const senderId = String(message.sender);\r\n          const receiverId = message.receiver ? String(message.receiver) : null;\r\n          partnerId = senderId === myId ? receiverId : senderId;\r\n        }\r\n\r\n        if (partnerId) {\r\n          targetChat = allUsers.find((u) => String(u._id) === partnerId) ?? null;\r\n        }\r\n      }\r\n\r\n      // 2. N·∫øu t√¨m th·∫•y chat, m·ªü v√† cu·ªôn ƒë·∫øn ƒë√∫ng tin nh·∫Øn v·ª´a ch·ªçn\r\n      if (targetChat) {\r\n        setShowGlobalSearchModal(false);\r\n        handleSelectChat(targetChat);\r\n\r\n        if (searchKeyword && searchKeyword.trim()) {\r\n          setRoomSearchKeyword(searchKeyword);\r\n        }\r\n        setTimeout(() => {\r\n          setScrollToMessageId(String(message._id));\r\n        }, 200);\r\n      } else {\r\n        // Fallback: Refetch data v√† th·ª≠ l·∫°i\r\n        console.warn('‚ùå Chat not found locally. Refetching data...');\r\n        fetchAllData().then(() => {\r\n          alert('Kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán. ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu, vui l√≤ng th·ª≠ l·∫°i.');\r\n        });\r\n      }\r\n    },\r\n    [groups, allUsers, currentUser, fetchAllData, handleSelectChat],\r\n  );\r\n\r\n  useEffect(() => {\r\n    const fetchCurrentUser = async () => {\r\n      setIsLoading(true);\r\n      try {\r\n        const user = JSON.parse(localStorage.getItem('info_user') || '{}');\r\n        if (user && user._id) {\r\n          setCurrentUser(user);\r\n        } else {\r\n          router.push('/');\r\n        }\r\n      } catch {\r\n        router.push('/');\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n    fetchCurrentUser();\r\n\r\n    const onStorage = (e: StorageEvent) => {\r\n      if (e.key === 'info_user') {\r\n        try {\r\n          const next = e.newValue ? JSON.parse(e.newValue) : null;\r\n          if (next && next._id) {\r\n            setCurrentUser(next);\r\n          }\r\n        } catch {}\r\n      }\r\n    };\r\n    window.addEventListener('storage', onStorage);\r\n    return () => {\r\n      window.removeEventListener('storage', onStorage);\r\n    };\r\n  }, [router]);\r\n\r\n  // 3. G·ªçi Fetch Data l·∫ßn ƒë·∫ßu\r\n  useEffect(() => {\r\n    if (currentUser) fetchAllData();\r\n  }, [currentUser, fetchAllData]);\r\n\r\n  // 4. K·∫øt n·ªëi Socket & X·ª≠ l√Ω Realtime Sidebar\r\n  useEffect(() => {\r\n    selectedChatRef.current = selectedChat;\r\n  }, [selectedChat]);\r\n\r\n  // 4. K·∫øt n·ªëi Socket & X·ª≠ l√Ω Realtime Sidebar\r\n  useEffect(() => {\r\n    if (!currentUser) return;\r\n    const endpoint = resolveSocketUrl();\r\n    socketRef.current = io(endpoint, { transports: ['websocket'], withCredentials: false });\r\n    socketRef.current.emit('join_room', currentUser._id);\r\n    socketRef.current.emit('user_online', { userId: currentUser._id });\r\n    const HEARTBEAT_MS = 60000; // 1 ph√∫t\r\n    const hb = setInterval(() => {\r\n      try {\r\n        socketRef.current?.emit('heartbeat', { userId: currentUser._id });\r\n      } catch {}\r\n    }, HEARTBEAT_MS);\r\n\r\n    socketRef.current.on(\r\n      'presence_update',\r\n      (payload: { userId: string; online: boolean; lastSeen?: number | null }) => {\r\n        setAllUsers((prev) =>\r\n          prev.map((u) =>\r\n            String(u._id) === String(payload.userId)\r\n              ? { ...u, online: payload.online, lastSeen: payload.lastSeen ?? u.lastSeen }\r\n              : u,\r\n          ),\r\n        );\r\n      },\r\n    );\r\n\r\n    const handleBeforeUnload = () => {\r\n      try {\r\n        socketRef.current?.emit('heartbeat', { userId: currentUser._id });\r\n      } catch {}\r\n    };\r\n    window.addEventListener('beforeunload', handleBeforeUnload);\r\n\r\n    socketRef.current.on(\r\n      'update_sidebar',\r\n      (data: {\r\n        sender: string;\r\n        receiver?: string;\r\n        roomId: string;\r\n        type: string;\r\n        content?: string;\r\n        isRecalled?: boolean;\r\n        lastMessage?: string;\r\n        timestamp?: number;\r\n        senderName?: string;\r\n        isGroup: boolean;\r\n        members?: (string | { _id: string })[];\r\n        groupName?: string;\r\n      }) => {\r\n        const isMyMsg = data.sender === currentUser._id;\r\n        const activeChatId = selectedChatRef.current?._id || null;\r\n\r\n        // 1. X√°c ƒë·ªãnh t√™n ng∆∞·ªùi g·ª≠i\r\n        let senderName = 'Ng∆∞·ªùi l·∫°';\r\n        if (isMyMsg) {\r\n          senderName = 'B·∫°n';\r\n        } else {\r\n          const foundUser = allUsersRef.current.find((u) => u._id === data.sender);\r\n          if (foundUser) senderName = foundUser.name || 'Ng∆∞·ªùi l·∫°';\r\n          if (data.senderName) senderName = data.senderName;\r\n        }\r\n\r\n        // 2. üî• Format n·ªôi dung tin nh·∫Øn - ∆Øu ti√™n lastMessage n·∫øu c√≥\r\n        let contentDisplay = '';\r\n\r\n        // N·∫øu server ƒë√£ g·ª≠i k√®m lastMessage (ƒë√£ format s·∫µn), d√πng lu√¥n, tr·ª´ khi l√† recall ƒë·ªÉ t·ª± ch√®n prefix\r\n        if (data.lastMessage && !data.isRecalled && data.type !== 'recall') {\r\n          contentDisplay = data.lastMessage;\r\n        }\r\n        // Thu h·ªìi: hi·ªÉn th·ªã k√®m ng∆∞·ªùi thu h·ªìi (1-1 v√† nh√≥m), \"B·∫°n\" n·∫øu l√† m√¨nh\r\n        else if (data.isRecalled || data.type === 'recall') {\r\n          contentDisplay = data.isGroup\r\n            ? isMyMsg\r\n              ? 'B·∫°n: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi'\r\n              : `${senderName}: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi`\r\n            : 'Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi';\r\n        }\r\n        // N·∫øu l√† tin nh·∫Øn text b√¨nh th∆∞·ªùng\r\n        else {\r\n          const isTextLike = data.type === 'text' || data.type === 'notify';\r\n          const rawContent = isTextLike ? data.content || '' : `[${data.type || 'Unknown'}]`;\r\n          contentDisplay = `${senderName}: ${rawContent}`;\r\n        }\r\n        const isMsgType =\r\n          data.type === 'text' ||\r\n          data.type === 'image' ||\r\n          data.type === 'file' ||\r\n          data.type === 'sticker' ||\r\n          data.type === 'video' ||\r\n          data.type === 'notify';\r\n        const soundEnabled =\r\n          (currentUser as unknown as { notifications?: { soundEnabled?: boolean } })?.notifications?.soundEnabled !==\r\n          false;\r\n        if (!isMyMsg && isMsgType && soundEnabled) {\r\n          playMessageSound();\r\n        }\r\n        // 3. C·∫¨P NH·∫¨T STATE\r\n        if (data.isGroup) {\r\n          setGroups((prev) => {\r\n            const index = prev.findIndex((g) => g._id === data.roomId);\r\n            if (index === -1) {\r\n              const myId = String(currentUser._id);\r\n              const memberIds = Array.isArray(data.members)\r\n                ? data.members.map((m) => (typeof m === 'object' && m?._id ? String(m._id) : String(m))).filter(Boolean)\r\n                : [];\r\n              const iAmMember = memberIds.includes(myId);\r\n              if (iAmMember) {\r\n                const stubMembers = Array.isArray(data.members)\r\n                  ? data.members.map((m) =>\r\n                      typeof m === 'object' && m?._id\r\n                        ? { _id: String(m._id), role: 'MEMBER', joinedAt: Date.now() }\r\n                        : { _id: String(m), role: 'MEMBER', joinedAt: Date.now() },\r\n                    )\r\n                  : [];\r\n                const stubGroup: GroupConversation = {\r\n                  _id: String(data.roomId),\r\n                  name: (data.groupName || data.senderName || 'Nh√≥m').trim() || 'Nh√≥m',\r\n                  isGroup: true,\r\n                  members: stubMembers,\r\n                  createdBy: String(data.sender || ''),\r\n                  unreadCount: 0,\r\n                  lastMessage: contentDisplay,\r\n                  lastMessageAt: data.timestamp || Date.now(),\r\n                } as GroupConversation;\r\n                const next = [stubGroup, ...prev];\r\n                setTimeout(() => fetchAllData(), 200);\r\n                return next;\r\n              }\r\n              fetchAllData();\r\n              return prev;\r\n            }\r\n            const isActiveChat = activeChatId === data.roomId;\r\n\r\n            // --- X·ª¨ L√ù BI·ªÜT DANH (GROUP NICKNAME) ---\r\n            let displaySenderName = senderName;\r\n            if (!isMyMsg) {\r\n              const currentGroup = prev[index];\r\n              const senderMember = currentGroup.members?.find((m: import('@/types/Group').GroupMemberSchema | import('@/types/Group').MemberInfo | string) => {\r\n                const mId =\r\n                  typeof m === 'object' && m && '_id' in m ? String((m as import('@/types/Group').GroupMemberSchema)._id) : String(m);\r\n                return mId === String(data.sender);\r\n              });\r\n              // Ki·ªÉm tra nickname trong member\r\n              if (senderMember && typeof senderMember === 'object') {\r\n                const sm = senderMember as { _id: string; nickname?: string };\r\n                if (sm.nickname) {\r\n                  displaySenderName = sm.nickname;\r\n                }\r\n              }\r\n            }\r\n\r\n            // --- RE-FORMAT LAST MESSAGE N·∫æU C√ì BI·ªÜT DANH ---\r\n            let finalContentDisplay = contentDisplay;\r\n            // Ch·ªâ re-format n·∫øu kh√¥ng ph·∫£i l√† tin nh·∫Øn h·ªá th·ªëng (notify kh√¥ng ng∆∞·ªùi g·ª≠i) v√† kh√¥ng ph·∫£i tin nh·∫Øn c·ªßa m√¨nh\r\n            // N·∫øu l√† recall, c≈©ng c·∫ßn x·ª≠ l√Ω\r\n            if (!isMyMsg) {\r\n              const isTextLike = data.type === 'text' || data.type === 'notify';\r\n              const rawContent = data.content || '';\r\n\r\n              if (data.isRecalled || data.type === 'recall') {\r\n                finalContentDisplay = `${displaySenderName}: Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi`;\r\n              } else if (isTextLike) {\r\n                finalContentDisplay = `${displaySenderName}: ${rawContent}`;\r\n              } else {\r\n                // Image, file, sticker, etc.\r\n                const typeLabel = data.type ? `[${data.type}]` : '[Tin nh·∫Øn]';\r\n                finalContentDisplay = `${displaySenderName}: ${typeLabel}`;\r\n              }\r\n            }\r\n\r\n            const updatedGroup = {\r\n              ...prev[index],\r\n              lastMessage: finalContentDisplay,\r\n              lastMessageAt: data.timestamp || Date.now(),\r\n              isRecall: data.isRecalled || false,\r\n              unreadCount: isMyMsg || isActiveChat ? 0 : (prev[index].unreadCount || 0) + 1,\r\n            };\r\n            const newGroups = [...prev];\r\n            newGroups.splice(index, 1);\r\n            return [updatedGroup, ...newGroups];\r\n          });\r\n        } else {\r\n          // --- X·ª≠ l√Ω 1-1 (User List) ---\r\n          const partnerId = isMyMsg ? data.receiver : data.sender;\r\n          setAllUsers((prev) => {\r\n            const index = prev.findIndex((u) => u._id === partnerId);\r\n            if (index === -1) {\r\n              fetchAllData();\r\n              return prev;\r\n            }\r\n            const isActiveChat = activeChatId === partnerId;\r\n            const updatedUser = {\r\n              ...prev[index],\r\n              lastMessage: contentDisplay,\r\n              lastMessageAt: data.timestamp || Date.now(),\r\n              isRecall: data.isRecalled || false,\r\n              unreadCount: isMyMsg || isActiveChat ? 0 : (prev[index].unreadCount || 0) + 1,\r\n            };\r\n            const newUsers = [...prev];\r\n            newUsers.splice(index, 1);\r\n            return [updatedUser, ...newUsers];\r\n          });\r\n        }\r\n      },\r\n    );\r\n\r\n    socketRef.current.on('group_members_updated', (payload: { roomId: string; members: { _id: string }[] }) => {\r\n      const myId = String(currentUser._id);\r\n      const nextMemberIds = Array.isArray(payload.members)\r\n        ? payload.members.map((m) => String((m as { _id: string })._id))\r\n        : [];\r\n      const stillInGroup = nextMemberIds.includes(myId);\r\n      if (!stillInGroup) {\r\n        setGroups((prev) => prev.filter((g) => String(g._id) !== String(payload.roomId)));\r\n        if (selectedChatRef.current && String(selectedChatRef.current._id) === String(payload.roomId)) {\r\n          setSelectedChat(null);\r\n        }\r\n      }\r\n    });\r\n    socketRef.current.on('group_renamed', (payload: { roomId: string; groupName: string }) => {\r\n      setGroups((prev) =>\r\n        prev.map((g) => (String(g._id) === String(payload.roomId) ? { ...g, name: payload.groupName } : g)),\r\n      );\r\n      if (selectedChatRef.current && String(selectedChatRef.current._id) === String(payload.roomId)) {\r\n        setSelectedChat((prev) => (prev ? { ...prev, name: payload.groupName } : prev));\r\n      }\r\n    });\r\n    return () => {\r\n      try {\r\n        clearInterval(hb);\r\n      } catch {}\r\n      window.removeEventListener('beforeunload', handleBeforeUnload);\r\n      socketRef.current?.disconnect();\r\n    };\r\n  }, [currentUser, fetchAllData, playMessageSound]);\r\n\r\n  // 5. X·ª≠ l√Ω Chat Action (Pin/Hide)\r\n  const handleChatAction = useCallback(\r\n    async (roomId: string, actionType: 'pin' | 'hide', isChecked: boolean, isGroupChat: boolean) => {\r\n      if (!currentUser?._id) return;\r\n\r\n      const apiRoute = isGroupChat ? '/api/groups' : '/api/users';\r\n\r\n      try {\r\n        const payload: {\r\n          action: 'toggleChatStatus';\r\n          _id: string;\r\n          currentUserId: string;\r\n          roomId: string;\r\n          conversationId: string;\r\n          data: { isPinned?: boolean; isHidden?: boolean };\r\n        } = {\r\n          action: 'toggleChatStatus',\r\n          _id: currentUser._id,\r\n          currentUserId: currentUser._id,\r\n          roomId,\r\n          conversationId: roomId,\r\n          data: actionType === 'pin' ? { isPinned: isChecked } : { isHidden: isChecked },\r\n        };\r\n\r\n        const res = await fetch(apiRoute, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(payload),\r\n        });\r\n\r\n        if (res.ok) {\r\n          if (isGroupChat) {\r\n            setGroups((prev) =>\r\n              prev.map((chat) => {\r\n                if (chat._id === roomId) {\r\n                  const updateField = actionType === 'pin' ? 'isPinned' : 'isHidden';\r\n                  return { ...chat, [updateField]: isChecked };\r\n                }\r\n                return chat;\r\n              }),\r\n            );\r\n          } else {\r\n            setAllUsers((prev) =>\r\n              prev.map((chat) => {\r\n                if (chat._id === roomId) {\r\n                  const updateField = actionType === 'pin' ? 'isPinned' : 'isHidden';\r\n                  return { ...chat, [updateField]: isChecked };\r\n                }\r\n                return chat;\r\n              }),\r\n            );\r\n          }\r\n\r\n          setTimeout(() => {\r\n            fetchAllData();\r\n          }, 500);\r\n        }\r\n      } catch (error) {\r\n        console.error(`L·ªói ${actionType} chat:`, error);\r\n      }\r\n    },\r\n    [currentUser, fetchAllData],\r\n  );\r\n\r\n  return {\r\n    currentUser,\r\n    isLoading,\r\n    allUsers,\r\n    groups,\r\n    selectedChat,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    showCreateGroupModal,\r\n    setShowCreateGroupModal,\r\n    showGlobalSearchModal,\r\n    globalSearchTerm,\r\n    globalSearchResults,\r\n    scrollToMessageId,\r\n    setScrollToMessageId,\r\n    roomSearchKeyword,\r\n    setRoomSearchKeyword,\r\n    handleOpenGlobalSearch,\r\n    handleGlobalSearch,\r\n    handleSelectContact,\r\n    handleNavigateToMessage,\r\n    fetchAllData,\r\n    handleChatAction,\r\n    handleSelectChat,\r\n    setSelectedChat,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}}]
}